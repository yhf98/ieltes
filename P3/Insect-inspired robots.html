<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>P3 ‚Äì Insect-inspired robots</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  * { box-sizing: border-box; margin:0; padding:0; }
  html,body { height:100%; }
  body { font-family: Arial, sans-serif; background:#f5f5f5; }
  
  #timer { position:fixed; top:12px; right:12px; background:#fff; border:1px solid #ddd; border-radius:6px; padding:8px 12px; font-size:16px; font-weight:600; color:#0066cc; z-index:1000; }
  
  .shell { display:flex; height:100vh; width:100%; }
  .pane { background:#fff; overflow:auto; padding:24px; }
  #left { flex: 0 0 50%; border-right:1px solid #ddd; }
  #right { flex: 1 1 auto; background:#fafafa; }
  #divider { flex: 0 0 5px; background:#ddd; cursor: ew-resize; }
  #divider:hover { background:#999; }
  
  h2,h3,h4 { margin:0 0 12px; color:#333; }
  h2 { font-size:20px; }
  h3 { font-size:18px; color:#0066cc; }
  h4 { font-size:15px; font-weight:600; margin-top:20px; }
  
  #left p { margin: 0 0 14px; line-height: 1.7; text-align:justify; }
  #left h4 { color:#0066cc; font-size:16px; margin-top:24px; }
  
  .group { background:#fff; border:1px solid #ddd; border-radius:6px; padding:16px; margin-bottom:16px; }
  .group h4 { margin-top:0; color:#0066cc; }
  .group p { margin:8px 0; font-size:14px; line-height:1.6; }
  
  .flag-btn { 
    position:absolute; 
    left:2px; 
    top:50%;
    transform:translateY(-50%);
    width:8px;
    height:8px;
    border-radius:50%;
    background:#ddd;
    cursor:pointer;
    z-index:10;
  }
  .flag-btn:hover { background:#999; }
  .flag-btn.active { background:#ff5722; }
  
  .match-area { margin:16px 0; }
  .match-options { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:16px; padding:12px; background:#f9f9f9; border-radius:6px; min-height:50px; }
  .match-option { 
    padding:8px 16px; 
    background:#fff; 
    border:1px solid #ddd; 
    border-radius:6px; 
    cursor:move; 
    font-size:14px;
    user-select:none;
  }
  .match-option:hover { background:#f0f0f0; }
  .match-option.dragging { opacity:0.5; }
  
  .match-question { 
    display:flex; 
    align-items:center; 
    margin:8px 0; 
    padding:12px; 
    background:#fff; 
    border:1px solid #ddd; 
    border-radius:6px; 
  }
  .match-question .q-num { 
    font-weight:600; 
    margin-right:12px; 
    min-width:30px; 
  }
  .match-question .q-text { 
    flex:1; 
    font-size:14px; 
  }
  .match-dropzone { 
    min-width:80px; 
    min-height:36px; 
    padding:6px 12px; 
    margin-left:12px; 
    border:2px dashed #ddd; 
    border-radius:6px; 
    display:flex; 
    align-items:center; 
    justify-content:center; 
    font-size:14px; 
    font-weight:600; 
    color:#666;
  }
  .match-dropzone.drag-over { background:#e3f2fd; border-color:#0066cc; }
  .match-dropzone.filled { background:#e8f5e9; border-color:#4caf50; border-style:solid; }
  
  .input-question { 
    display:flex; 
    align-items:center; 
    margin:12px 0; 
    padding:10px; 
    background:#f9f9f9; 
    border-radius:6px; 
  }
  .input-question .q-num { 
    font-weight:600; 
    margin-right:12px; 
    min-width:30px; 
  }
  .input-question .q-text { 
    flex:1; 
    font-size:14px; 
  }
  .input-question input[type="text"] { 
    width:200px; 
    padding:6px 10px; 
    margin-left:12px; 
    border:1px solid #ddd; 
    border-radius:4px; 
    font-size:14px;
  }
  .input-question input[type="text"]:focus { 
    outline:none; 
    border-color:#0066cc; 
  }
  
  .bottom-bar { display:flex; gap:10px; margin-top:16px; }
  button { padding:10px 20px; border:1px solid #999; border-radius:6px; background:#fff; cursor:pointer; font-size:14px; }
  button:hover { background:#f0f0f0; }
  .btn-primary { background:#0066cc; color:#fff; border-color:#0066cc; }
  .btn-primary:hover { background:#0052a3; }
  .btn-danger { background:#dc3545; color:#fff; border-color:#dc3545; }
  .btn-danger:hover { background:#c82333; }
  
  .hl { background:#fff59d; cursor:pointer; }
  .hl:hover { background:#ffeb3b; }
  .note { background:#b3d9ff; cursor:pointer; }
  .note:hover { background:#99ccff; }
  
  #selbar { position:fixed; display:none; z-index:2000; background:#fff; border:1px solid #ddd; border-radius:8px; padding:8px; gap:0; box-shadow:0 2px 8px rgba(0,0,0,0.15); flex-direction:column; min-width:120px; }
  #selbar button { background:#fff; color:#666; border:none; padding:3px 0px; cursor:pointer; font-size:14px; text-align:center; border-radius:4px; }
  #selbar button:hover { background:#f5f5f5; color:#333; }
  
  .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:3000; align-items:center; justify-content:center; }
  .modal.active { display:flex; }
  .modal-content { background:#fff; border-radius:8px; padding:24px; max-width:600px; width:90%; max-height:80vh; overflow-y:auto; }
  
  .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
  .modal-header h2 { font-size: 28px; color: #333; margin: 0; }
  .modal-close { font-size: 32px; cursor: pointer; color: #999; line-height: 1; }
  .modal-close:hover { color: #333; }
  
  .result-summary { text-align:center; padding:20px; background:#f0f0f0; margin-bottom:16px; border-radius:6px; }
  .result-score { font-size:36px; font-weight:600; color:#0066cc; }
  .result-item { padding:10px; margin:8px 0; border-left:3px solid #ddd; background:#f9f9f9; font-size:13px; }
  .result-item.correct { border-left-color:#28a745; background:#e8f5e9; }
  .result-item.incorrect { border-left-color:#dc3545; background:#ffebee; }
  
  .wrong-item { background:#fff3e0; padding:16px; margin:8px 0; border-radius:8px; border-left:4px solid #ff9800; display:flex; justify-content:space-between; align-items:start; }
  .wrong-item-content { flex:1; }
  .btn-delete { background:#dc3545; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-size:13px; margin-left:12px; }
  .btn-delete:hover { background:#c82333; }
  .modal-actions { display:flex; gap:10px; margin-bottom:20px; }
</style>
</head>
<body>
<div id="timer">00:00</div>

<div class="shell">
  <section class="pane" id="left">
    
<h2>READING PASSAGE 3</h2>
<p>You should spend about 20 minutes on Questions 27-40, which are based on Reading Passage 3 below.</p>
<h3>Insect-inspired robots</h3>
<p style="font-style:italic; margin-bottom:20px;">A recent conference reports on developments in biorobotics</p>

<h4>Section A</h4>
<p>A tiny insect navigates its way across featureless salt-pans. A cockroach successfully works out how to scramble over an obstacle. The mantis shrimp scans its aquatic world through hyperspectral eyes. Using the most basic of equipment and brains tinier than a pin-head, insects constantly solve complex problems of movement, vision and navigation ‚Äì processing data that would challenge a super-computer. How they do it is driving one of the most exciting new fields of technology ‚Äì biomimetics and biorobotics, the imitation of insect systems to control man-made machines. Delegates at a recent conference presented some outcomes of their work in this area.</p>

<h4>Section B</h4>
<p>Dr Alex Zelinsky suggested that the method by which wasps use landmarks to find their way back to the nest may one day be part of a system for navigating cars that know where to go. A research team led by Dr Zelinsky has shown that a robot can navigate its way among 50 different landmarks by recognising them individually using a panoramic camera. "The inspiration came from biology, where wasps use a practical method turn back and look to orient themselves as they emerge from their nest. By flying to and fro, they look at the wasp nest from different angles and perspectives so they can recognise it again," he explained. The robot's panoramic camera logs the surrounding area and its key landmarks, which are then stored in its computer according to how reliable they are as navigational aids. The landmarks are then scaled, from small to large, so that the robot can recognise whether it is getting closer to or further away from them. Their location is built into a map in its mind, which operates at different scales and instructs the robot whether to turn left or right at a particular mark. The technology provides a general way for a machine to navigate an unknown landscape.</p>

<h4>Section C</h4>
<p>For three decades, Professor Ruediger Wehner has journeyed from Switzerland to the Sahara Desert where Cataglyphis, a tiny ant with a brain weighing just 0.1 mg, performs acts of navigational genius when it leaves its nest, forages for food and returns successfully. Cataglyphis uses polarised light, caused when air molecules scatter light, to orient and steer itself. Wehner's team found that the ant has a set of specialised photoreceptors along the upper rim of its eyes that detect polarised light, while other receptors perform different navigational tasks. As the sun moves, the ant notes its direction each time it leaves the nest and updates its internal compass. Using other eye receptors it stores a snapshot image of landmarks close to the nest entrance in its eyes and compares this with what it sees as it returns. The ant also has a way of measuring distance travelled, while a path integrator periodically informs the ant of its current position relative to its point of departure. Rather than integrate all the information it receives in its brain, the ant actually performs a number of complex calculations in different organs. Like a super-computer, the ant has many separate sub-routines going on simultaneously.</p>

<p>Using the ant's ability to steer by polarised light and to store and reuse landscape images, Wehner and colleagues have built "Sahabot," a small vehicle that uses polarisers and a CCD camera to store 360¬∞ images of its surroundings. It navigates by using polarised sunlight and comparing the current images of landmarks to the ones in its memory.</p>

<h4>Section D</h4>
<p>Professor Robert Michelson had a different desert challenge ‚Äì to design a flying robot that can not only navigate but also stay aloft and hover in the thin atmosphere of Mars. Drawing inspiration from insect flight, he has gone beyond nature to devise a completely new concept for a flying machine. The "Entomopter" is a sort of double-ended dragonfly whose wings beat reciprocally. Michelson says that the flapping-wing design gives the craft unusually high lift compared with a fixed-wing flyer, enabling it to fly slowly or hover in the thin Martian air ‚Äì whereas a fixed-wing craft would have to move at more than 400 km/h and could not stop to explore.</p>

<h4>Section E</h4>
<p>Engineer Roger Quinn and entomologist Professor Roy Ritzmann are taking their inspiration from cockroaches. According to Quinn and Ritzmann, the ability of cockroaches to run very fast over rough terrain may one day give rise to a completely new all-terrain vehicle with six legs, or maybe even wheel-like legs called "whegs." The key to the cockroach's remarkable cross-country performance lies partly in the fact that its legs do a lot of the thinking without having to consult the brain. Quinn and Ritzmann are drawing on cockroach skills to create robotic walkers and control strategies that capture the remarkable capacity of these insects to traverse complex terrain and navigate safely toward goals while avoiding obstacles. The team has already designed a series of robots that run on six legs or on whegs, enabling them to handle surprisingly rugged terrain.</p>

<h4>Section F</h4>
<p>International experts believe there are tremendous opportunities in biorobotics. However, delegates at the conference had differing visions for the future of the science. While some were concerned that the initial applications of biorobotics may be military, others, such as Dr Barbara Webb, predicted swarms of tiny, cheap, insect-like robots as society's cleaners and collectors. Sonja Kleinlogel hoped the study of the hyperspectral eyes of the mantis shrimp might yield remote sensors that can watch over the environmental health of our oceans. Several delegates were concerned about the ethical implications of biorobotics and urged that close attention be paid to this as the science and technologies develop.</p>

  </section>

  <div id="divider" title="Drag to resize"></div>

  <section class="pane" id="right">
    <h3>Questions</h3>

    <div class="group">
      <h4>Questions 27‚Äì32</h4>
      <p>Reading Passage 3 has six sections, <strong>A‚ÄìF</strong>.</p>
      <p>Which section contains the following information?</p>
      <p>Write the correct letter, <strong>A‚ÄìF</strong>, in boxes <strong>27‚Äì32</strong> on your answer sheet.</p>

      <div class="match-area">
        <div class="match-options" id="sectionOptions">
          <div class="match-option" draggable="true" data-value="A">A</div>
          <div class="match-option" draggable="true" data-value="B">B</div>
          <div class="match-option" draggable="true" data-value="C">C</div>
          <div class="match-option" draggable="true" data-value="D">D</div>
          <div class="match-option" draggable="true" data-value="E">E</div>
          <div class="match-option" draggable="true" data-value="F">F</div>
        </div>

        <div class="match-question">
          <span class="flag-btn" data-q="q27"></span>
          <span class="q-num">27</span>
          <span class="q-text">positive and negative possibilities for the use of insect-inspired robots</span>
          <div class="match-dropzone" data-q="q27"></div>
        </div>

        <div class="match-question">
          <span class="flag-btn" data-q="q28"></span>
          <span class="q-num">28</span>
          <span class="q-text">how perceived size is used as an aid to navigation</span>
          <div class="match-dropzone" data-q="q28"></div>
        </div>

        <div class="match-question">
          <span class="flag-btn" data-q="q29"></span>
          <span class="q-num">29</span>
          <span class="q-text">an example of decision-making taking place in the limbs</span>
          <div class="match-dropzone" data-q="q29"></div>
        </div>

        <div class="match-question">
          <span class="flag-btn" data-q="q30"></span>
          <span class="q-num">30</span>
          <span class="q-text">a description of a potential aid in space exploration</span>
          <div class="match-dropzone" data-q="q30"></div>
        </div>

        <div class="match-question">
          <span class="flag-btn" data-q="q31"></span>
          <span class="q-num">31</span>
          <span class="q-text">the range of skills that have inspired biorobotics</span>
          <div class="match-dropzone" data-q="q31"></div>
        </div>

        <div class="match-question">
          <span class="flag-btn" data-q="q32"></span>
          <span class="q-num">32</span>
          <span class="q-text">how a variety of navigational methods operate at the same time</span>
          <div class="match-dropzone" data-q="q32"></div>
        </div>
      </div>
    </div>

    <div class="group">
      <h4>Questions 33‚Äì36</h4>
      <p>Answer the questions below.</p>
      <p>Choose <strong>NO MORE THAN THREE WORDS</strong> from the passage for each answer.</p>
      <p>Write your answers in boxes <strong>33‚Äì36</strong> on your answer sheet.</p>

      <div class="input-question">
        <span class="flag-btn" data-q="q33"></span>
        <span class="q-num">33</span>
        <span class="q-text">Which creature sees particularly well under water?</span>
        <input type="text" data-q="q33" placeholder="Answer">
      </div>

      <div class="input-question">
        <span class="flag-btn" data-q="q34"></span>
        <span class="q-num">34</span>
        <span class="q-text">In addition to a computer, what technical equipment is fitted in Dr Zelinsky's robot?</span>
        <input type="text" data-q="q34" placeholder="Answer">
      </div>

      <div class="input-question">
        <span class="flag-btn" data-q="q35"></span>
        <span class="q-num">35</span>
        <span class="q-text">Where is the Cataglyphis ant found?</span>
        <input type="text" data-q="q35" placeholder="Answer">
      </div>

      <div class="input-question">
        <span class="flag-btn" data-q="q36"></span>
        <span class="q-num">36</span>
        <span class="q-text">What atmospheric effect helps the Cataglyphis ant to know its direction?</span>
        <input type="text" data-q="q36" placeholder="Answer">
      </div>
    </div>

    <div class="group">
      <h4>Questions 37‚Äì40</h4>
      <p>Look at the following people (Questions 37‚Äì40) and the list of robots below.</p>
      <p>Match each person or people with the correct robot, <strong>A‚ÄìG</strong>.</p>
      <p>Write the correct letter, <strong>A‚ÄìG</strong>, in boxes <strong>37‚Äì40</strong> on your answer sheet.</p>

      <div style="background:#f9f9f9; padding:12px; margin:12px 0; border-radius:6px;">
        <strong>List of Robots</strong><br>
        <strong>A</strong> a robot that makes use of light as well as stored images for navigational purposes<br>
        <strong>B</strong> a robot that can contribute to environmental health<br>
        <strong>C</strong> a robot that can move over difficult surfaces<br>
        <strong>D</strong> a robot that categorises information from the environment according to its usefulness<br>
        <strong>E</strong> a robot that can be used to clean surfaces and collect rubbish<br>
        <strong>F</strong> a robot that has improved on the ability of the insect on which it is based<br>
        <strong>G</strong> a robot that can replace soldiers in war
      </div>

      <div class="match-area">
        <div class="match-options" id="robotOptions">
          <div class="match-option" draggable="true" data-value="A">A</div>
          <div class="match-option" draggable="true" data-value="B">B</div>
          <div class="match-option" draggable="true" data-value="C">C</div>
          <div class="match-option" draggable="true" data-value="D">D</div>
          <div class="match-option" draggable="true" data-value="E">E</div>
          <div class="match-option" draggable="true" data-value="F">F</div>
          <div class="match-option" draggable="true" data-value="G">G</div>
        </div>

        <div class="match-question">
          <span class="flag-btn" data-q="q37"></span>
          <span class="q-num">37</span>
          <span class="q-text">Dr Alex Zelinsky</span>
          <div class="match-dropzone" data-q="q37"></div>
        </div>

        <div class="match-question">
          <span class="flag-btn" data-q="q38"></span>
          <span class="q-num">38</span>
          <span class="q-text">Professor Ruediger Wehner</span>
          <div class="match-dropzone" data-q="q38"></div>
        </div>

        <div class="match-question">
          <span class="flag-btn" data-q="q39"></span>
          <span class="q-num">39</span>
          <span class="q-text">Professor Robert Michelson</span>
          <div class="match-dropzone" data-q="q39"></div>
        </div>

        <div class="match-question">
          <span class="flag-btn" data-q="q40"></span>
          <span class="q-text">Roger Quinn and Professor Roy Ritzmann</span>
          <div class="match-dropzone" data-q="q40"></div>
        </div>
      </div>
    </div>

    <div class="bottom-bar">
      <button class="btn-primary" onclick="submitAnswers()">Êèê‰∫§</button>
      <button onclick="resetForm()">ÈáçÁΩÆ</button>
      <button onclick="openWrongBook()">Êú¨ÁØáÈîôÈ¢ò</button>
    </div>
  </section>
</div>

<div id="selbar">
  <button id="btnNote">Note</button>
  <button id="btnHL">Highlight</button>
  <button id="btnUH" style="display:none;">Clear Highlight</button>
</div>

<div class="modal" id="resultModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ÊàêÁª©</h2>
      <span class="modal-close" onclick="closeModal('resultModal')">√ó</span>
    </div>
    <div id="resultContent"></div>
    <button class="btn-primary" style="width:100%; margin-top:16px;" onclick="addWrongToBook()">Âä†ÂÖ•ÈîôÈ¢òÊú¨</button>
  </div>
</div>

<div class="modal" id="wrongBookModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Êú¨ÁØáÈîôÈ¢ò</h2>
      <span class="modal-close" onclick="closeModal('wrongBookModal')">√ó</span>
    </div>
    <div id="wrongBookContent"></div>
  </div>
</div>

<div class="modal" id="resetModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ÈáçÁΩÆÁªÉ‰π†</h2>
      <span class="modal-close" onclick="closeModal('resetModal')">√ó</span>
    </div>
    <div style="margin:16px 0;">
      <label style="display:block; margin-bottom:10px;">
        <input type="radio" name="resetType" value="answers" checked>
        Âè™Ê∏ÖÁ©∫Á≠îÊ°à
      </label>
      <label style="display:block;">
        <input type="radio" name="resetType" value="all">
        Ê∏ÖÁ©∫Á≠îÊ°àÂíåÊ†áËÆ∞
      </label>
    </div>
    <button class="btn-primary" style="width:100%;" onclick="confirmReset()">Á°ÆÂÆö</button>
  </div>
</div>

<script>
const PAPER_ID='P3_INSECT_ROBOTS';

let t=0;
const timerEl=document.getElementById('timer');
setInterval(()=>{ t++; timerEl.textContent=String(Math.floor(t/60)).padStart(2,'0')+':'+String(t%60).padStart(2,'0'); }, 1000);

const divider=document.getElementById('divider'), left=document.getElementById('left'), right=document.getElementById('right');
let dragging=false;
divider.onmousedown=()=>{ dragging=true; document.body.style.cursor='ew-resize'; };
window.onmousemove=(e)=>{ if(!dragging)return; const c=document.querySelector('.shell').getBoundingClientRect(); let x=e.clientX-c.left; x=Math.max(280,Math.min(c.width-280,x)); left.style.flex='0 0 '+x+'px'; right.style.flex='1 1 auto'; };
window.onmouseup=()=>{ dragging=false; document.body.style.cursor=''; };

const selbar=document.getElementById('selbar'), btnHL=document.getElementById('btnHL'), btnUH=document.getElementById('btnUH'), btnNote=document.getElementById('btnNote');
let lastRange=null, currentHlNode=null;

function posSelbar(r){ selbar.style.display='flex'; const t=window.scrollY+r.top-selbar.offsetHeight-8; const l=window.scrollX+r.left+r.width/2-selbar.offsetWidth/2; selbar.style.top=((t>0)?t:(window.scrollY+r.bottom+8))+'px'; selbar.style.left=Math.max(8,l)+'px'; }

function updSel(){ const s=window.getSelection(); if(!s||s.rangeCount===0||s.isCollapsed){ if(!currentHlNode)selbar.style.display='none'; return; } const r=s.getRangeAt(0); lastRange=r.cloneRange(); currentHlNode=null; btnNote.style.display='block'; btnHL.style.display='block'; btnUH.style.display='none'; posSelbar(r.getBoundingClientRect()); }

left.onmouseup=updSel; right.onmouseup=updSel;
document.onselectionchange=()=>{ const s=window.getSelection(); if((!s||s.rangeCount===0||s.isCollapsed)&&!currentHlNode)selbar.style.display='none'; };
document.addEventListener('click',(e)=>{ if(e.target.classList&&(e.target.classList.contains('hl')||e.target.classList.contains('note'))){ currentHlNode=e.target; lastRange=null; btnNote.style.display='none'; btnHL.style.display='none'; btnUH.style.display='block'; posSelbar(e.target.getBoundingClientRect()); const s=window.getSelection(); if(s)s.removeAllRanges(); }}, true);

btnHL.onclick=()=>{ if(currentHlNode||!lastRange||lastRange.collapsed)return; const s=document.createElement('span'); s.className='hl'; try{ lastRange.surroundContents(s); }catch(e){ const w=document.createElement('span'); w.className='hl'; w.appendChild(lastRange.cloneContents()); lastRange.deleteContents(); lastRange.insertNode(w); } selbar.style.display='none'; saveHighlights(); };

btnNote.onclick=()=>{ if(currentHlNode||!lastRange||lastRange.collapsed)return; const s=document.createElement('span'); s.className='note'; try{ lastRange.surroundContents(s); }catch(e){ const w=document.createElement('span'); w.className='note'; w.appendChild(lastRange.cloneContents()); lastRange.deleteContents(); lastRange.insertNode(w); } selbar.style.display='none'; saveHighlights(); };

btnUH.onclick=()=>{ if(currentHlNode){ const p=currentHlNode.parentNode; while(currentHlNode.firstChild)p.insertBefore(currentHlNode.firstChild,currentHlNode); p.removeChild(currentHlNode); p.normalize(); currentHlNode=null; selbar.style.display='none'; saveHighlights(); }else if(lastRange){ const sR=lastRange.getBoundingClientRect(); const w=document.createTreeWalker(document.body,NodeFilter.SHOW_ELEMENT); const tr=[]; while(w.nextNode()){ const n=w.currentNode; if(n.classList&&(n.classList.contains('hl')||n.classList.contains('note'))){ const r=n.getBoundingClientRect(); if(!(r.right<sR.left||r.left>sR.right||r.bottom<sR.top||r.top>sR.bottom))tr.push(n); }} tr.forEach(el=>{ const p=el.parentNode; while(el.firstChild)p.insertBefore(el.firstChild,el); p.removeChild(el); p.normalize(); }); selbar.style.display='none'; saveHighlights(); }};

document.querySelectorAll('.flag-btn').forEach(btn => {
  btn.onclick = e => {
    e.stopPropagation();
    btn.classList.toggle('active');
    saveFlags();
  };
});

let draggedElement = null;

document.querySelectorAll('.match-option').forEach(opt => {
  opt.addEventListener('dragstart', e => {
    draggedElement = e.target;
    e.target.classList.add('dragging');
  });
  
  opt.addEventListener('dragend', e => {
    e.target.classList.remove('dragging');
  });
});

document.querySelectorAll('.match-dropzone').forEach(zone => {
  zone.addEventListener('dragover', e => {
    e.preventDefault();
    zone.classList.add('drag-over');
  });
  
  zone.addEventListener('dragleave', () => {
    zone.classList.remove('drag-over');
  });
  
  zone.addEventListener('drop', e => {
    e.preventDefault();
    zone.classList.remove('drag-over');
    if(draggedElement) {
      zone.textContent = draggedElement.dataset.value;
      zone.classList.add('filled');
      saveAnswers();
    }
  });
  
  zone.addEventListener('click', () => {
    zone.textContent = '';
    zone.classList.remove('filled');
    saveAnswers();
  });
});

const answerKey={q27:"F",q28:"B",q29:"E",q30:"D",q31:"A",q32:"C",q33:"mantis shrimp",q34:"panoramic camera",q35:"the Sahara Desert",q36:"polarised light",q37:"D",q38:"A",q39:"F",q40:"C"};
let lastResults=[];

function normalizeAnswer(ans) {
  return ans.toLowerCase().trim().replace(/\s+/g, ' ').replace(/^(a|an|the)\s+/i, '');
}

function saveAnswers() {
  const data = {};
  document.querySelectorAll('.match-dropzone').forEach(zone => {
    if(zone.textContent && zone.textContent.trim()) data[zone.dataset.q] = zone.textContent.trim();
  });
  document.querySelectorAll('input[type="text"]').forEach(inp => {
    if(inp.value.trim()) data[inp.dataset.q] = inp.value.trim();
  });
  localStorage.setItem(`${PAPER_ID}_answers`, JSON.stringify(data));
}

function loadAnswers() {
  const data = JSON.parse(localStorage.getItem(`${PAPER_ID}_answers`) || '{}');
  Object.keys(data).forEach(q => {
    const zone = document.querySelector(`.match-dropzone[data-q="${q}"]`);
    if(zone) {
      zone.textContent = data[q];
      zone.classList.add('filled');
    }
    const inp = document.querySelector(`input[type="text"][data-q="${q}"]`);
    if(inp) inp.value = data[q];
  });
}

function saveFlags() {
  const flags = [...document.querySelectorAll('.flag-btn.active')].map(b => b.dataset.q);
  localStorage.setItem(`${PAPER_ID}_flags`, JSON.stringify(flags));
}

function loadFlags() {
  const flags = JSON.parse(localStorage.getItem(`${PAPER_ID}_flags`) || '[]');
  flags.forEach(q => document.querySelector(`[data-q="${q}"]`)?.classList.add('active'));
}

function saveHighlights() {
  const highlights = { left: [], right: [] };
  document.querySelectorAll('#left .hl, #left .note').forEach((el, idx) => {
    highlights.left.push({
      type: el.classList.contains('hl') ? 'hl' : 'note',
      text: el.textContent,
      index: idx
    });
  });
  document.querySelectorAll('#right .hl, #right .note').forEach((el, idx) => {
    highlights.right.push({
      type: el.classList.contains('hl') ? 'hl' : 'note',
      text: el.textContent,
      index: idx
    });
  });
  localStorage.setItem(`${PAPER_ID}_highlights`, JSON.stringify(highlights));
}

function loadHighlights() {
  const data = JSON.parse(localStorage.getItem(`${PAPER_ID}_highlights`) || '{"left":[],"right":[]}');
  
  if(data.left && data.left.length > 0) {
    data.left.forEach(item => {
      const walker = document.createTreeWalker(left, NodeFilter.SHOW_TEXT);
      let node;
      while(node = walker.nextNode()) {
        if(node.textContent.includes(item.text)) {
          const span = document.createElement('span');
          span.className = item.type;
          const parent = node.parentNode;
          const text = node.textContent;
          const idx = text.indexOf(item.text);
          if(idx >= 0) {
            const before = text.substring(0, idx);
            const match = text.substring(idx, idx + item.text.length);
            const after = text.substring(idx + item.text.length);
            
            parent.insertBefore(document.createTextNode(before), node);
            span.textContent = match;
            parent.insertBefore(span, node);
            parent.insertBefore(document.createTextNode(after), node);
            parent.removeChild(node);
            break;
          }
        }
      }
    });
  }
  
  if(data.right && data.right.length > 0) {
    data.right.forEach(item => {
      const walker = document.createTreeWalker(right, NodeFilter.SHOW_TEXT);
      let node;
      while(node = walker.nextNode()) {
        if(node.textContent.includes(item.text)) {
          const span = document.createElement('span');
          span.className = item.type;
          const parent = node.parentNode;
          const text = node.textContent;
          const idx = text.indexOf(item.text);
          if(idx >= 0) {
            const before = text.substring(0, idx);
            const match = text.substring(idx, idx + item.text.length);
            const after = text.substring(idx + item.text.length);
            
            parent.insertBefore(document.createTextNode(before), node);
            span.textContent = match;
            parent.insertBefore(span, node);
            parent.insertBefore(document.createTextNode(after), node);
            parent.removeChild(node);
            break;
          }
        }
      }
    });
  }
}

document.querySelectorAll('input[type="text"]').forEach(inp => {
  inp.addEventListener('input', saveAnswers);
});

document.addEventListener('DOMContentLoaded', () => {
  loadAnswers();
  loadFlags();
  loadHighlights();
});

function submitAnswers(){ 
  const res=[]; 
  let cor=0; 
  Object.keys(answerKey).forEach(q=>{ 
    let uA="";
    const zone = document.querySelector(`.match-dropzone[data-q="${q}"]`);
    if(zone && zone.textContent.trim()) uA = zone.textContent.trim();
    const inp = document.querySelector(`input[type="text"][data-q="${q}"]`);
    if(inp && inp.value.trim()) uA = inp.value.trim();
    
    const cA=answerKey[q]; 
    const iC = normalizeAnswer(uA) === normalizeAnswer(cA);
    if(iC)cor++; 
    res.push({id:q,userAns:uA,correctAns:cA,isCorrect:iC}); 
  }); 
  lastResults=res; 
  const tot=Object.keys(answerKey).length; 
  const pct=((cor/tot)*100).toFixed(1); 
  document.getElementById('resultContent').innerHTML=`<div class="result-summary"><div class="result-score">${cor} / ${tot}</div><div style="margin-top:8px;font-size:18px;">${pct}%</div></div>${res.map(r=>`<div class="result-item ${r.isCorrect?'correct':'incorrect'}"><div><strong>${r.id}</strong> ${r.isCorrect?'‚úì':'‚úó'}</div><div>‰Ω†ÁöÑÁ≠îÊ°à: ${r.userAns||'(Êú™‰ΩúÁ≠î)'}</div>${!r.isCorrect?`<div>Ê≠£Á°ÆÁ≠îÊ°à: ${r.correctAns}</div>`:''}</div>`).join('')}`; 
  document.getElementById('resultModal').classList.add('active'); 
}

function resetForm(){ document.getElementById('resetModal').classList.add('active'); }

function confirmReset(){ 
  const tp=document.querySelector('input[name="resetType"]:checked').value; 
  document.querySelectorAll('.match-dropzone').forEach(z=>{z.textContent='';z.classList.remove('filled');});
  document.querySelectorAll('input[type="text"]').forEach(i=>i.value='');
  localStorage.removeItem(`${PAPER_ID}_answers`);
  
  if(tp==='all'){ 
    document.querySelectorAll('.hl').forEach(el=>{ const p=el.parentNode; while(el.firstChild)p.insertBefore(el.firstChild,el); p.removeChild(el); p.normalize(); }); 
    document.querySelectorAll('.note').forEach(el=>{ const p=el.parentNode; while(el.firstChild)p.insertBefore(el.firstChild,el); p.removeChild(el); p.normalize(); }); 
    document.querySelectorAll('.flag-btn').forEach(b => b.classList.remove('active'));
    localStorage.removeItem(`${PAPER_ID}_highlights`);
    localStorage.removeItem(`${PAPER_ID}_flags`);
  } 
  closeModal('resetModal'); 
}

function addWrongToBook(){ const wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); const wr=lastResults.filter(r=>!r.isCorrect); wr.forEach(r=>{ const en={paperId:PAPER_ID,title:'Insect-inspired robots',questionId:r.id,correctAnswer:r.correctAns,myAnswer:r.userAns||'(Êú™‰ΩúÁ≠î)',date:new Date().toISOString().split('T')[0]}; const ix=wb.findIndex(i=>i.paperId===en.paperId&&i.questionId===en.questionId); if(ix>=0)wb[ix]=en; else wb.push(en); }); localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); alert(`Â∑≤Ê∑ªÂä† ${wr.length} ÈÅìÈîôÈ¢ò`); closeModal('resultModal'); }

function deleteWrongItem(pId,qId){ if(!confirm('Á°ÆÂÆöÂà†Èô§ËøôÈÅìÈîôÈ¢òÔºü'))return; let wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); wb=wb.filter(i=>!(i.paperId===pId&&i.questionId===qId)); localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); openWrongBook(); }

function clearCurrentWrongBook(){ if(!confirm('Á°ÆÂÆöÊ∏ÖÁ©∫Êú¨ÁØáÊâÄÊúâÈîôÈ¢òÔºü'))return; let wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); wb=wb.filter(i=>i.paperId!==PAPER_ID); localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); openWrongBook(); }

function openWrongBook(){ const wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); const cu=wb.filter(i=>i.paperId===PAPER_ID); const ct=document.getElementById('wrongBookContent'); if(cu.length===0)ct.innerHTML='<div style="text-align:center;padding:40px;color:#666;">ÊöÇÊó†ÈîôÈ¢ò</div>'; else ct.innerHTML=`<div class="modal-actions"><button class="btn-danger" onclick="clearCurrentWrongBook()" style="width:100%;">üóëÔ∏è Ê∏ÖÁ©∫Êú¨ÁØáÈîôÈ¢ò</button></div>${cu.map(i=>`<div class="wrong-item"><div class="wrong-item-content"><div style="font-weight:600;margin-bottom:8px;">${i.questionId}</div><div style="font-size:13px;color:#666;"><div>‚úì Ê≠£Á°Æ: ${i.correctAnswer}</div><div style="color:#d32f2f;">‚úó ÊàëÁöÑ: ${i.myAnswer}</div></div></div><button class="btn-delete" onclick="deleteWrongItem('${i.paperId}','${i.questionId}')">Âà†Èô§</button></div>`).join('')}`; document.getElementById('wrongBookModal').classList.add('active'); }

function closeModal(id){ document.getElementById(id).classList.remove('active'); }
</script>
</body>
</html>