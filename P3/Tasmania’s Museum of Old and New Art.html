<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>P3 ‚Äì Tasmania‚Äôs Museum of Old and New Art</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  *{box-sizing:border-box;margin:0;padding:0;}
  html,body{height:100%;}
  body{font-family:Arial,sans-serif;background:#f5f5f5;}
  #timer{position:fixed;top:12px;right:12px;background:#fff;border:1px solid #ddd;border-radius:6px;padding:8px 12px;font-size:16px;font-weight:600;color:#0066cc;z-index:1000;}
  .shell{display:flex;height:100vh;width:100%;}
  .pane{background:#fff;overflow:auto;padding:24px;}
  #left{flex:0 0 50%;border-right:1px solid #ddd;}
  #right{flex:1 1 auto;background:#fafafa;}
  #divider{flex:0 0 5px;background:#ddd;cursor:ew-resize;}
  #divider:hover{background:#999;}
  h2,h3,h4{margin:0 0 12px;color:#333;}
  h2{font-size:20px;}
  h3{font-size:18px;color:#0066cc;}
  h4{font-size:15px;font-weight:600;margin-top:20px;}
  #left p{margin:0 0 14px;line-height:1.7;text-align:justify;}
  .group{background:#fff;border:1px solid #ddd;border-radius:6px;padding:16px;margin-bottom:16px;}
  .group h4{margin-top:0;color:#0066cc;}
  .group p{margin:8px 0;font-size:14px;line-height:1.6;}
  .headings{background:#f9f9f9;padding:12px;margin:12px 0;border-radius:4px;}
  .headings ol{margin-left:20px;}
  .headings li{margin:4px 0;font-size:13px;}
  table{border-collapse:collapse;width:100%;margin:12px 0;}
  th,td{border:1px solid #ddd;padding:6px;text-align:center;font-size:13px;position:relative;}
  th{background:#f5f5f5;font-weight:600;}
  .flag-btn{position:absolute;left:2px;top:50%;transform:translateY(-50%);width:8px;height:8px;border-radius:50%;background:#ddd;cursor:pointer;z-index:10;}
  .flag-btn:hover{background:#999;}
  .flag-btn.active{background:#ff5722;}
  tr td:first-child{padding-left:16px;}
  .group ol{margin-left:20px;}
  .group ol li{margin:12px 0;font-size:14px;line-height:1.6;position:relative;}
  .group ol li label{display:inline-block;margin-right:8px;}
  .bottom-bar{display:flex;gap:10px;margin-top:16px;}
  button{padding:10px 20px;border:1px solid #999;border-radius:6px;background:#fff;cursor:pointer;font-size:14px;}
  button:hover{background:#f0f0f0;}
  .btn-primary{background:#0066cc;color:#fff;border-color:#0066cc;}
  .btn-primary:hover{background:#0052a3;}
  .btn-danger{background:#dc3545;color:#fff;border-color:#dc3545;}
  .btn-danger:hover{background:#c82333;}
  .hl{background:#fff59d;cursor:pointer;}
  .hl:hover{background:#ffeb3b;}
  .note{background:#b3d9ff;cursor:pointer;}
  .note:hover{background:#99ccff;}
  #selbar{position:fixed;display:none;z-index:2000;background:#fff;border:1px solid #ddd;border-radius:8px;padding:8px;gap:0;box-shadow:0 2px 8px rgba(0,0,0,0.15);flex-direction:column;min-width:120px;}
  #selbar button{background:#fff;color:#666;border:none;padding:3px 0;cursor:pointer;font-size:14px;text-align:center;border-radius:4px;}
  #selbar button:hover{background:#f5f5f5;color:#333;}
  .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:3000;align-items:center;justify-content:center;}
  .modal.active{display:flex;}
  .modal-content{background:#fff;border-radius:8px;padding:24px;max-width:600px;width:90%;max-height:80vh;overflow-y:auto;}
  .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;}
  .modal-header h2{font-size:28px;color:#333;margin:0;}
  .modal-close{font-size:32px;cursor:pointer;color:#999;line-height:1;}
  .modal-close:hover{color:#333;}
  .result-summary{text-align:center;padding:20px;background:#f0f0f0;margin-bottom:16px;border-radius:6px;}
  .result-score{font-size:36px;font-weight:600;color:#0066cc;}
  .result-item{padding:10px;margin:8px 0;border-left:3px solid #ddd;background:#f9f9f9;font-size:13px;}
  .result-item.correct{border-left-color:#28a745;background:#e8f5e9;}
  .result-item.incorrect{border-left-color:#dc3545;background:#ffebee;}
  .wrong-item{background:#fff3e0;padding:16px;margin:8px 0;border-radius:8px;border-left:4px solid #ff9800;display:flex;justify-content:space-between;align-items:start;}
  .wrong-item-content{flex:1;}
  .btn-delete{background:#dc3545;color:#fff;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;font-size:13px;margin-left:12px;}
  .btn-delete:hover{background:#c82333;}
  .modal-actions{display:flex;gap:10px;margin-bottom:20px;}
</style>
</head>
<body>
<div id="timer">00:00</div>

<div class="shell">
  <section class="pane" id="left">
    <h2>READING PASSAGE 3</h2>
    <p>You should spend about 20 minutes on Questions 27‚Äì40, which are based on Reading Passage 3 below.</p>
    <h3>Tasmania‚Äôs Museum of Old and New Art</h3>
    <p><em>Katelin Butler, returning to her home city of Hobart, reflects on how a new museum has brought about change.</em></p>

    <p>As an eighteen-year-old living in the small Australian island state of Tasmania, moving to the ‚Äòmainland‚Äô could not happen soon enough. Now, ten years later, I look forward to going home. This is probably because I‚Äôve grown up, but also perhaps because the cultural landscape of Tasmania has matured. The latest addition to Tasmania‚Äôs cultural scene is David Walsh‚Äôs Museum of Old and New Art (MONA), a museum that has established Hobart, the capital city of Tasmania, on the global art circuit.</p>

    <p>This building is an example of how art and architecture can have an instant impact on the social and cultural reputation of a place. Andrew Bain of <em>The Sydney Morning Herald</em> wrote, ‚ÄòIn a virtual blink, Hobart‚Äôs cultural landscape has been transformed, with art, wine, fine food and stylish accommodation becoming integral features of the city ‚Ä¶ If Hobart‚Äôs makeover has an origin, it‚Äôs the opening of MONA ‚Äì the Museum of Old and New Art.‚Äô MONA is said to have been solely instrumental in the reinvention of Hobart as a cultural hub.</p>

    <p>MONA made the national press and international blogs before it opened. After that, Tourism Industry Council of Tasmania‚Äôs chief executive, Luke Martin, claimed that MONA was proving so popular it was underpinning the tourism industry in Tasmania. However, MONA‚Äôs effect on Hobart has broader ramifications for Tasmania‚Äôs tourism industry. As reported in Hobart‚Äôs local paper, <em>The Mercury</em>, there is concern about how long people are staying in Tasmania. Rather than spending a week in the state and hiring a car to experience the beauty of the Tasmanian landscape, people are making short stays in Hobart only to visit the gallery. The next challenge for the state is how to entice holiday-makers to stay longer, and to venture further afield. Tasmania is more than a one-hit wonder.</p>

    <p>According to Martin, possibilities for packaging up MONA with visits to other galleries around Tasmania are being investigated. Although not directly related to these investigations, the 1891 Queen Victoria Museum and Art Gallery at Royal Park in Launceston is currently being restored to its original condition; there are also plans to extensively redevelop the Tasmanian Museum and Art Gallery in Hobart. In addition to this, there are up to twenty other existing quality galleries in the state. So there is more to see than just MONA.</p>

    <p>Although large, the building is rather nondescript, sitting heavily on the edge of the Derwent River. MONA‚Äôs ‚Äòwow factor‚Äô comes from the notoriety of David Walsh, the museum‚Äôs millionaire founder, and his choice of unusual artworks. The architecture has more depth of meaning and does exactly as it should: it supports the vision of the museum, essentially the vision of Walsh. It‚Äôs a new building in the context of a maturing city. The dark, moody labyrinth of gallery spaces could be likened to the mind of the eccentric founder himself. Each artwork appears to be integrated into the dark materiality of the architecture ‚Äì the interiors are far from light, bright and neutral, as might be seen in a more traditional gallery. The dim lighting and rough, rocky surfaces are a reminder that visitors are three levels underground.</p>

    <p>The warped, mirrored surface at the museum‚Äôs entry could be seen as the start of a journey of reflecting on one‚Äôs existence. Much of the art explores the human condition ‚Äì there are uninhibited artistic descriptions of human relationships, death, and even the digestion process. Going to a gallery with such confronting artworks with your parents is an interesting experience; I was pleasantly surprised by my parents‚Äô openness to the exhibitions. My father, who normally whisks through a gallery while my mother likes to take her time, happily spent almost five hours at MONA; the urge to linger is a common feeling here. This is because the gallery engages all of the senses, and visitors often pause to experience the effect each artwork has on them. This raises the question of who is actually visiting MONA ‚Äì and it‚Äôs definitely not just the normal gallery-goers. People from all kinds of socioeconomic backgrounds are curious about what lies within the subterranean maze of MONA. Conservative minds are being opened, which is a good thing anywhere.</p>

    <p>Walsh‚Äôs antiquities collection is superb, but he knew that old coins would compete for attention against new works that are more challenging in scale and subject matter, hence the device of setting antiquities among twentieth- and twenty-first-century works. For me, one of the intriguing outcomes of this strategy was an intensified feeling that the makers of the coins and antiquities were the great contemporary artists of their time.</p>

    <p>The so-called Bilbao Effect has worked its magic on Hobart because, just as Frank Gehry‚Äôs Guggenheim Museum has transformed the city of Bilbao in Spain, MONA has been a magnet for tourists in Hobart. However, the architectural ‚Äòwow‚Äô factor of the Guggenheim was the most famous component of that city‚Äôs transformation, whereas Fender Katsalidis‚Äôs MONA does not have the same spectacular impact as the shimmering metal surfaces of Gehry‚Äôs building. Walsh himself abhors descriptions of MONA as the Bilbao of the south, saying that Fender Katsalidis solved a problem when he designed MONA, in executing a project of this scale in an underground location. Walsh contrasts this with what he describes as the ‚Äúarchitectural self-indulgence of Gehry when designing the Guggenheim in Bilbao.‚Äù Call it the Bilbao Effect, but this phenomenon has been around for thousands of years ‚Äì good public architecture forms the centrepiece of a city. This is probably true, but like the Guggenheim, MONA has initiated something very important for Tasmania, and for Hobart in particular. Now the question is how Tasmania will build on David Walsh‚Äôs input into its cultural setting.</p>
  </section>

  <div id="divider" title="Drag to resize"></div>

  <section class="pane" id="right">
    <h3>Questions</h3>

    <div class="group">
      <h4>Questions 27‚Äì32</h4>
      <p>Do the following statements agree with the claims of the writer in Reading Passage 3?</p>
      <p>In boxes <strong>27‚Äì32</strong> on your answer sheet, write</p>
      <div style="margin-left:20px;margin-top:8px;">
        <div><strong>YES</strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if the statement agrees with the claims of the writer</div>
        <div><strong>NO</strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if the statement contradicts the claims of the writer</div>
        <div><strong>NOT GIVEN</strong>&nbsp;&nbsp;if it is impossible to say what the writer thinks about this</div>
      </div>

      <ol start="27">
        <li><span class="flag-btn" data-q="q27" style="left:-20px;"></span>The writer changed her mind about spending time in Tasmania.<br>
          <label><input type="radio" name="q27" value="YES"> YES</label>
          <label><input type="radio" name="q27" value="NO"> NO</label>
          <label><input type="radio" name="q27" value="NOT GIVEN"> NOT GIVEN</label>
        </li>
        <li><span class="flag-btn" data-q="q28" style="left:-20px;"></span>Andrew Bain believes that the effect MONA had on Hobart was immediate.<br>
          <label><input type="radio" name="q28" value="YES"> YES</label>
          <label><input type="radio" name="q28" value="NO"> NO</label>
          <label><input type="radio" name="q28" value="NOT GIVEN"> NOT GIVEN</label>
        </li>
        <li><span class="flag-btn" data-q="q29" style="left:-20px;"></span>Other factors have contributed as much as MONA to Hobart‚Äôs transformation.<br>
          <label><input type="radio" name="q29" value="YES"> YES</label>
          <label><input type="radio" name="q29" value="NO"> NO</label>
          <label><input type="radio" name="q29" value="NOT GIVEN"> NOT GIVEN</label>
        </li>
        <li><span class="flag-btn" data-q="q30" style="left:-20px;"></span>The Tourism Industry Council of Tasmania works closely with the director of MONA.<br>
          <label><input type="radio" name="q30" value="YES"> YES</label>
          <label><input type="radio" name="q30" value="NO"> NO</label>
          <label><input type="radio" name="q30" value="NOT GIVEN"> NOT GIVEN</label>
        </li>
        <li><span class="flag-btn" data-q="q31" style="left:-20px;"></span>Many local residents are writing to <em>The Mercury</em> expressing concern about the length of tourists‚Äô stays in Hobart.<br>
          <label><input type="radio" name="q31" value="YES"> YES</label>
          <label><input type="radio" name="q31" value="NO"> NO</label>
          <label><input type="radio" name="q31" value="NOT GIVEN"> NOT GIVEN</label>
        </li>
        <li><span class="flag-btn" data-q="q32" style="left:-20px;"></span>Tourists now regard MONA as a starting point for longer trips in Tasmania.<br>
          <label><input type="radio" name="q32" value="YES"> YES</label>
          <label><input type="radio" name="q32" value="NO"> NO</label>
          <label><input type="radio" name="q32" value="NOT GIVEN"> NOT GIVEN</label>
        </li>
      </ol>
    </div>

    <div class="group">
      <h4>Questions 33‚Äì37</h4>
      <p>Choose the correct letter, <strong>A</strong>, <strong>B</strong>, <strong>C</strong> or <strong>D</strong>.</p>
      <p>Write the correct letter in boxes <strong>33‚Äì37</strong> on your answer sheet.</p>

      <ol start="33">
        <li><span class="flag-btn" data-q="q33" style="left:-20px;"></span>Luke Martin plans to promote tourism in Tasmania by<br>
          <label><input type="radio" name="q33" value="A"> A</label> focusing more on MONA as the leading attraction.<br>
          <label><input type="radio" name="q33" value="B"> B</label> combining trips to MONA with visits to other galleries.<br>
          <label><input type="radio" name="q33" value="C"> C</label> encouraging visitors to do activities that are not connected with art galleries.<br>
          <label><input type="radio" name="q33" value="D"> D</label> improving the quality of promotional information about Tasmania‚Äôs galleries.
        </li>

        <li><span class="flag-btn" data-q="q34" style="left:-20px;"></span>According to the writer, what is especially interesting about MONA?<br>
          <label><input type="radio" name="q34" value="A"> A</label> the man who founded the gallery<br>
          <label><input type="radio" name="q34" value="B"> B</label> its location close to a river<br>
          <label><input type="radio" name="q34" value="C"> C</label> visitors‚Äô responses to the gallery spaces<br>
          <label><input type="radio" name="q34" value="D"> D</label> the striking architecture of the building
        </li>

        <li><span class="flag-btn" data-q="q35" style="left:-20px;"></span>Why do visitors spend a long time at the gallery?<br>
          <label><input type="radio" name="q35" value="A"> A</label> There is a great number of exhibits.<br>
          <label><input type="radio" name="q35" value="B"> B</label> Visitors tend to come in family groups.<br>
          <label><input type="radio" name="q35" value="C"> C</label> Many of the works are difficult to understand.<br>
          <label><input type="radio" name="q35" value="D"> D</label> The gallery has a physical effect on visitors.
        </li>

        <li><span class="flag-btn" data-q="q36" style="left:-20px;"></span>What does the writer say about the visitors to MONA?<br>
          <label><input type="radio" name="q36" value="A"> A</label> Older people spend longer there than younger people do.<br>
          <label><input type="radio" name="q36" value="B"> B</label> A wide variety of people are interested in MONA.<br>
          <label><input type="radio" name="q36" value="C"> C</label> The majority of visitors are young people.<br>
          <label><input type="radio" name="q36" value="D"> D</label> The visitors are representative of gallery enthusiasts generally.
        </li>

        <li><span class="flag-btn" data-q="q37" style="left:-20px;"></span>Why does the writer mention the coins at MONA?<br>
          <label><input type="radio" name="q37" value="A"> A</label> to illustrate how interesting they are to visitors to modern galleries<br>
          <label><input type="radio" name="q37" value="B"> B</label> to explain why they are displayed in a separate section of the gallery<br>
          <label><input type="radio" name="q37" value="C"> C</label> to argue that Walsh‚Äôs collection is among the best in the world<br>
          <label><input type="radio" name="q37" value="D"> D</label> to express admiration for the way that the exhibits are presented
        </li>
      </ol>
    </div>

    <div class="group">
      <h4>Questions 38‚Äì40</h4>
      <p>Complete the summary using the list of words, <strong>A‚ÄìH</strong>, below.</p>
      <p>Write the correct letter, <strong>A‚ÄìH</strong>, in boxes <strong>38‚Äì40</strong> on your answer sheet.</p>

      <p><strong>The Bilbao Effect</strong></p>
      <p>MONA has huge appeal for visitors to Hobart, just as Gehry‚Äôs Guggenheim Museum has for Bilbao. While MONA may lack the 38 ________ effect of the Guggenheim, David Walsh explains that MONA‚Äôs architect had a different objective when designing MONA: unlike the architectural showcasing of the Guggenheim, with MONA there was a major 39 ________ that needed to be dealt with; the gallery was set beneath the ground. In any case, both galleries have transformed their cities, just as successful public buildings have for thousands of years. It remains to be seen how the 40 ________ of David Walsh will be expanded upon in Tasmania.</p>

      <p><strong>List of words</strong></p>
      <p>A challenge &nbsp;&nbsp;&nbsp; B pipe &nbsp;&nbsp;&nbsp; C visual &nbsp;&nbsp;&nbsp; D contribution<br>
         E lasting &nbsp;&nbsp;&nbsp; F essential &nbsp;&nbsp;&nbsp; G ambition &nbsp;&nbsp;&nbsp; H attraction</p>

      <ol start="38">
        <li><span class="flag-btn" data-q="q38" style="left:-20px;"></span>38<br>
          <label><input type="radio" name="q38" value="A"> A</label>
          <label><input type="radio" name="q38" value="B"> B</label>
          <label><input type="radio" name="q38" value="C"> C</label>
          <label><input type="radio" name="q38" value="D"> D</label>
          <label><input type="radio" name="q38" value="E"> E</label>
          <label><input type="radio" name="q38" value="F"> F</label>
          <label><input type="radio" name="q38" value="G"> G</label>
          <label><input type="radio" name="q38" value="H"> H</label>
        </li>
        <li><span class="flag-btn" data-q="q39" style="left:-20px;"></span>39<br>
          <label><input type="radio" name="q39" value="A"> A</label>
          <label><input type="radio" name="q39" value="B"> B</label>
          <label><input type="radio" name="q39" value="C"> C</label>
          <label><input type="radio" name="q39" value="D"> D</label>
          <label><input type="radio" name="q39" value="E"> E</label>
          <label><input type="radio" name="q39" value="F"> F</label>
          <label><input type="radio" name="q39" value="G"> G</label>
          <label><input type="radio" name="q39" value="H"> H</label>
        </li>
        <li><span class="flag-btn" data-q="q40" style="left:-20px;"></span>40<br>
          <label><input type="radio" name="q40" value="A"> A</label>
          <label><input type="radio" name="q40" value="B"> B</label>
          <label><input type="radio" name="q40" value="C"> C</label>
          <label><input type="radio" name="q40" value="D"> D</label>
          <label><input type="radio" name="q40" value="E"> E</label>
          <label><input type="radio" name="q40" value="F"> F</label>
          <label><input type="radio" name="q40" value="G"> G</label>
          <label><input type="radio" name="q40" value="H"> H</label>
        </li>
      </ol>
    </div>

    <div class="bottom-bar">
      <button class="btn-primary" onclick="submitAnswers()">Êèê‰∫§</button>
      <button onclick="resetForm()">ÈáçÁΩÆ</button>
      <button onclick="openWrongBook()">Êú¨ÁØáÈîôÈ¢ò</button>
    </div>
  </section>
</div>

<div id="selbar">
  <button id="btnNote">Note</button>
  <button id="btnHL">Highlight</button>
  <button id="btnUH" style="display:none;">Clear Highlight</button>
</div>

<div class="modal" id="resultModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ÊàêÁª©</h2>
      <span class="modal-close" onclick="closeModal('resultModal')">√ó</span>
    </div>
    <div id="resultContent"></div>
    <button class="btn-primary" style="width:100%;margin-top:16px;" onclick="addWrongToBook()">Âä†ÂÖ•ÈîôÈ¢òÊú¨</button>
  </div>
</div>

<div class="modal" id="wrongBookModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Êú¨ÁØáÈîôÈ¢ò</h2>
      <span class="modal-close" onclick="closeModal('wrongBookModal')">√ó</span>
    </div>
    <div id="wrongBookContent"></div>
  </div>
</div>

<div class="modal" id="resetModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ÈáçÁΩÆÁªÉ‰π†</h2>
      <span class="modal-close" onclick="closeModal('resetModal')">√ó</span>
    </div>
    <div style="margin:16px 0;">
      <label style="display:block;margin-bottom:10px;">
        <input type="radio" name="resetType" value="answers" checked> Âè™Ê∏ÖÁ©∫Á≠îÊ°à
      </label>
      <label style="display:block;">
        <input type="radio" name="resetType" value="all"> Ê∏ÖÁ©∫Á≠îÊ°àÂíåÊ†áËÆ∞
      </label>
    </div>
    <button class="btn-primary" style="width:100%;" onclick="confirmReset()">Á°ÆÂÆö</button>
  </div>
</div>

<script>
const PAPER_ID='P3_MONA';

let t=0;
const timerEl=document.getElementById('timer');
setInterval(()=>{t++;timerEl.textContent=String(Math.floor(t/60)).padStart(2,'0')+':'+String(t%60).padStart(2,'0');},1000);

const divider=document.getElementById('divider'),left=document.getElementById('left'),right=document.getElementById('right');
let dragging=false;
divider.onmousedown=()=>{dragging=true;document.body.style.cursor='ew-resize';};
window.onmousemove=e=>{if(!dragging)return;const c=document.querySelector('.shell').getBoundingClientRect();let x=e.clientX-c.left;x=Math.max(280,Math.min(c.width-280,x));left.style.flex='0 0 '+x+'px';right.style.flex='1 1 auto';};
window.onmouseup=()=>{dragging=false;document.body.style.cursor='';};

const selbar=document.getElementById('selbar'),btnHL=document.getElementById('btnHL'),btnUH=document.getElementById('btnUH'),btnNote=document.getElementById('btnNote');
let lastRange=null,currentHlNode=null;

function posSelbar(r){
  selbar.style.display='flex';
  const t=window.scrollY+r.top-selbar.offsetHeight-8;
  const l=window.scrollX+r.left+r.width/2-selbar.offsetWidth/2;
  selbar.style.top=((t>0)?t:(window.scrollY+r.bottom+8))+'px';
  selbar.style.left=Math.max(8,l)+'px';
}

function updSel(){
  const s=window.getSelection();
  if(!s||s.rangeCount===0||s.isCollapsed){
    if(!currentHlNode)selbar.style.display='none';
    return;
  }
  const r=s.getRangeAt(0);
  lastRange=r.cloneRange();
  currentHlNode=null;
  btnNote.style.display='block';
  btnHL.style.display='block';
  btnUH.style.display='none';
  posSelbar(r.getBoundingClientRect());
}

left.onmouseup=updSel;
right.onmouseup=updSel;
document.onselectionchange=()=>{
  const s=window.getSelection();
  if((!s||s.rangeCount===0||s.isCollapsed)&&!currentHlNode)selbar.style.display='none';
};
document.addEventListener('click',e=>{
  if(e.target.classList&&(e.target.classList.contains('hl')||e.target.classList.contains('note'))){
    currentHlNode=e.target;
    lastRange=null;
    btnNote.style.display='none';
    btnHL.style.display='none';
    btnUH.style.display='block';
    posSelbar(e.target.getBoundingClientRect());
    const s=window.getSelection();
    if(s)s.removeAllRanges();
  }
},true);

btnHL.onclick=()=>{
  if(currentHlNode||!lastRange||lastRange.collapsed)return;
  const s=document.createElement('span');
  s.className='hl';
  try{lastRange.surroundContents(s);}
  catch(e){
    const w=document.createElement('span');
    w.className='hl';
    w.appendChild(lastRange.cloneContents());
    lastRange.deleteContents();
    lastRange.insertNode(w);
  }
  selbar.style.display='none';
  saveHighlights();
};

btnNote.onclick=()=>{
  if(currentHlNode||!lastRange||lastRange.collapsed)return;
  const s=document.createElement('span');
  s.className='note';
  try{lastRange.surroundContents(s);}
  catch(e){
    const w=document.createElement('span');
    w.className='note';
    w.appendChild(lastRange.cloneContents());
    lastRange.deleteContents();
    lastRange.insertNode(w);
  }
  selbar.style.display='none';
  saveHighlights();
};

btnUH.onclick=()=>{
  if(currentHlNode){
    const p=currentHlNode.parentNode;
    while(currentHlNode.firstChild)p.insertBefore(currentHlNode.firstChild,currentHlNode);
    p.removeChild(currentHlNode);
    p.normalize();
    currentHlNode=null;
    selbar.style.display='none';
    saveHighlights();
  }else if(lastRange){
    const sR=lastRange.getBoundingClientRect();
    const w=document.createTreeWalker(document.body,NodeFilter.SHOW_ELEMENT);
    const tr=[];
    while(w.nextNode()){
      const n=w.currentNode;
      if(n.classList&&(n.classList.contains('hl')||n.classList.contains('note'))){
        const r=n.getBoundingClientRect();
        if(!(r.right<sR.left||r.left>sR.right||r.bottom<sR.top||r.top>sR.bottom))tr.push(n);
      }
    }
    tr.forEach(el=>{
      const p=el.parentNode;
      while(el.firstChild)p.insertBefore(el.firstChild,el);
      p.removeChild(el);
      p.normalize();
    });
    selbar.style.display='none';
    saveHighlights();
  }
};

document.querySelectorAll('.flag-btn').forEach(btn=>{
  btn.onclick=e=>{
    e.stopPropagation();
    btn.classList.toggle('active');
    saveFlags();
  };
});

const answerKey={
  q27:"YES",
  q28:"YES",
  q29:"NO",
  q30:"NOT GIVEN",
  q31:"NOT GIVEN",
  q32:"NO",
  q33:"B",
  q34:"C",
  q35:"D",
  q36:"B",
  q37:"D",
  q38:"C",
  q39:"A",
  q40:"D"
};
let lastResults=[];

function saveAnswers(){
  const data={};
  Object.keys(answerKey).forEach(q=>{
    const ch=document.querySelector(`input[name="${q}"]:checked`);
    if(ch)data[q]=ch.value;
  });
  localStorage.setItem(`${PAPER_ID}_answers`,JSON.stringify(data));
}

function loadAnswers(){
  const data=JSON.parse(localStorage.getItem(`${PAPER_ID}_answers`)||'{}');
  Object.keys(data).forEach(q=>{
    const radio=document.querySelector(`input[name="${q}"][value="${data[q]}"]`);
    if(radio)radio.checked=true;
  });
}

function saveFlags(){
  const flags=[...document.querySelectorAll('.flag-btn.active')].map(b=>b.dataset.q);
  localStorage.setItem(`${PAPER_ID}_flags`,JSON.stringify(flags));
}

function loadFlags(){
  const flags=JSON.parse(localStorage.getItem(`${PAPER_ID}_flags`)||'[]');
  flags.forEach(q=>document.querySelector(`[data-q="${q}"]`)?.classList.add('active'));
}

function saveHighlights(){
  const highlights={left:[],right:[]};
  document.querySelectorAll('#left .hl,#left .note').forEach((el,idx)=>{
    highlights.left.push({type:el.classList.contains('hl')?'hl':'note',text:el.textContent,index:idx});
  });
  document.querySelectorAll('#right .hl,#right .note').forEach((el,idx)=>{
    highlights.right.push({type:el.classList.contains('hl')?'hl':'note',text:el.textContent,index:idx});
  });
  localStorage.setItem(`${PAPER_ID}_highlights`,JSON.stringify(highlights));
}

function loadHighlights(){
  const data=JSON.parse(localStorage.getItem(`${PAPER_ID}_highlights`)||'{"left":[],"right":[]}');

  if(data.left&&data.left.length>0){
    data.left.forEach(item=>{
      const walker=document.createTreeWalker(left,NodeFilter.SHOW_TEXT);
      let node;
      while(node=walker.nextNode()){
        if(node.textContent.includes(item.text)){
          const span=document.createElement('span');
          span.className=item.type;
          const parent=node.parentNode;
          const text=node.textContent;
          const idx=text.indexOf(item.text);
          if(idx>=0){
            const before=text.substring(0,idx);
            const match=text.substring(idx,idx+item.text.length);
            const after=text.substring(idx+item.text.length);
            parent.insertBefore(document.createTextNode(before),node);
            span.textContent=match;
            parent.insertBefore(span,node);
            parent.insertBefore(document.createTextNode(after),node);
            parent.removeChild(node);
            break;
          }
        }
      }
    });
  }

  if(data.right&&data.right.length>0){
    data.right.forEach(item=>{
      const walker=document.createTreeWalker(right,NodeFilter.SHOW_TEXT);
      let node;
      while(node=walker.nextNode()){
        if(node.textContent.includes(item.text)){
          const span=document.createElement('span');
          span.className=item.type;
          const parent=node.parentNode;
          const text=node.textContent;
          const idx=text.indexOf(item.text);
          if(idx>=0){
            const before=text.substring(0,idx);
            const match=text.substring(idx,idx+item.text.length);
            const after=text.substring(idx+item.text.length);
            parent.insertBefore(document.createTextNode(before),node);
            span.textContent=match;
            parent.insertBefore(span,node);
            parent.insertBefore(document.createTextNode(after),node);
            parent.removeChild(node);
            break;
          }
        }
      }
    });
  }
}

document.querySelectorAll('input[type="radio"]').forEach(radio=>{
  radio.addEventListener('change',saveAnswers);
});

document.addEventListener('DOMContentLoaded',()=>{
  loadAnswers();
  loadFlags();
  loadHighlights();
});

function submitAnswers(){
  const res=[];
  let cor=0;
  Object.keys(answerKey).forEach(q=>{
    const ch=document.querySelector('input[name="'+q+'"]:checked');
    const uA=ch?ch.value:"";
    const cA=answerKey[q];
    const iC=uA===cA;
    if(iC)cor++;
    res.push({id:q,userAns:uA,correctAns:cA,isCorrect:iC});
  });
  lastResults=res;
  const tot=Object.keys(answerKey).length;
  const pct=((cor/tot)*100).toFixed(1);
  localStorage.setItem(`ielts_score_${PAPER_ID}`,`${cor}/${tot}`);
  document.getElementById('resultContent').innerHTML=
    `<div class="result-summary"><div class="result-score">${cor} / ${tot}</div><div style="margin-top:8px;font-size:18px;">${pct}%</div></div>`+
    res.map(r=>`<div class="result-item ${r.isCorrect?'correct':'incorrect'}"><div><strong>${r.id}</strong> ${r.isCorrect?'‚úì':'‚úó'}</div><div>‰Ω†ÁöÑÁ≠îÊ°à: ${r.userAns||'(Êú™‰ΩúÁ≠î)'}</div>${!r.isCorrect?`<div>Ê≠£Á°ÆÁ≠îÊ°à: ${r.correctAns}</div>`:''}</div>`).join('');
  document.getElementById('resultModal').classList.add('active');
}

function resetForm(){
  document.getElementById('resetModal').classList.add('active');
}

function confirmReset(){
  const tp=document.querySelector('input[name="resetType"]:checked').value;
  document.querySelectorAll('input[type="radio"]').forEach(i=>i.checked=false);
  localStorage.removeItem(`${PAPER_ID}_answers`);
  if(tp==='all'){
    document.querySelectorAll('.hl').forEach(el=>{
      const p=el.parentNode;
      while(el.firstChild)p.insertBefore(el.firstChild,el);
      p.removeChild(el);
      p.normalize();
    });
    document.querySelectorAll('.note').forEach(el=>{
      const p=el.parentNode;
      while(el.firstChild)p.insertBefore(el.firstChild,el);
      p.removeChild(el);
      p.normalize();
    });
    document.querySelectorAll('.flag-btn').forEach(b=>b.classList.remove('active'));
    localStorage.removeItem(`${PAPER_ID}_highlights`);
    localStorage.removeItem(`${PAPER_ID}_flags`);
  }
  closeModal('resetModal');
}

function addWrongToBook(){
  const wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]');
  const wr=lastResults.filter(r=>!r.isCorrect);
  wr.forEach(r=>{
    const en={paperId:PAPER_ID,title:"Tasmania‚Äôs Museum of Old and New Art",questionId:r.id,correctAnswer:r.correctAns,myAnswer:r.userAns||'(Êú™‰ΩúÁ≠î)',date:new Date().toISOString().split('T')[0]};
    const ix=wb.findIndex(i=>i.paperId===en.paperId&&i.questionId===en.questionId);
    if(ix>=0)wb[ix]=en;else wb.push(en);
  });
  localStorage.setItem('ielts_wrong_book',JSON.stringify(wb));
  alert(`Â∑≤Ê∑ªÂä† ${wr.length} ÈÅìÈîôÈ¢ò`);
  closeModal('resultModal');
}

function deleteWrongItem(pId,qId){
  if(!confirm('Á°ÆÂÆöÂà†Èô§ËøôÈÅìÈîôÈ¢òÔºü'))return;
  let wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]');
  wb=wb.filter(i=>!(i.paperId===pId&&i.questionId===qId));
  localStorage.setItem('ielts_wrong_book',JSON.stringify(wb));
  openWrongBook();
}

function clearCurrentWrongBook(){
  if(!confirm('Á°ÆÂÆöÊ∏ÖÁ©∫Êú¨ÁØáÊâÄÊúâÈîôÈ¢òÔºü'))return;
  let wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]');
  wb=wb.filter(i=>i.paperId!==PAPER_ID);
  localStorage.setItem('ielts_wrong_book',JSON.stringify(wb));
  openWrongBook();
}

function openWrongBook(){
  const wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]');
  const cu=wb.filter(i=>i.paperId===PAPER_ID);
  const ct=document.getElementById('wrongBookContent');
  if(cu.length===0)ct.innerHTML='<div style="text-align:center;padding:40px;color:#666;">ÊöÇÊó†ÈîôÈ¢ò</div>';
  else ct.innerHTML=
    `<div class="modal-actions"><button class="btn-danger" onclick="clearCurrentWrongBook()" style="width:100%;">üóëÔ∏è Ê∏ÖÁ©∫Êú¨ÁØáÈîôÈ¢ò</button></div>`+
    cu.map(i=>`<div class="wrong-item"><div class="wrong-item-content"><div style="font-weight:600;margin-bottom:8px;">${i.questionId}</div><div style="font-size:13px;color:#666;"><div>‚úì Ê≠£Á°Æ: ${i.correctAnswer}</div><div style="color:#d32f2f;">‚úó ÊàëÁöÑ: ${i.myAnswer}</div></div></div><button class="btn-delete" onclick="deleteWrongItem('${i.paperId}','${i.questionId}')">Âà†Èô§</button></div>`).join('');
  document.getElementById('wrongBookModal').classList.add('active');
}

function closeModal(id){
  document.getElementById(id).classList.remove('active');
}
</script>
</body>
</html>
