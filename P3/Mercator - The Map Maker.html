<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>P3 ‚Äì Mercator - The Map Maker</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  * { box-sizing: border-box; margin:0; padding:0; }
  html,body { height:100%; }
  body { font-family: Arial, sans-serif; background:#f5f5f5; }
  
  #timer { position:fixed; top:12px; right:12px; background:#fff; border:1px solid #ddd; border-radius:6px; padding:8px 12px; font-size:16px; font-weight:600; color:#0066cc; z-index:1000; }
  
  .shell { display:flex; height:100vh; width:100%; }
  .pane { background:#fff; overflow:auto; padding:24px; }
  #left { flex: 0 0 50%; border-right:1px solid #ddd; }
  #right { flex: 1 1 auto; background:#fafafa; }
  #divider { flex: 0 0 5px; background:#ddd; cursor: ew-resize; }
  #divider:hover { background:#999; }
  
  h2,h3,h4 { margin:0 0 12px; color:#333; }
  h2 { font-size:20px; }
  h3 { font-size:18px; color:#0066cc; }
  h4 { font-size:15px; font-weight:600; margin-top:20px; }
  
  #left p { margin: 0 0 14px; line-height: 1.7; text-align:justify; }
  
  .group { background:#fff; border:1px solid #ddd; border-radius:6px; padding:16px; margin-bottom:16px; }
  .group h4 { margin-top:0; color:#0066cc; }
  .group p { margin:8px 0; font-size:14px; line-height:1.6; }
  
  .headings { background:#f9f9f9; padding:12px; margin:12px 0; border-radius:4px; }
  .headings ol { margin-left:20px; }
  .headings li { margin:4px 0; font-size:13px; }
  
  table { border-collapse: collapse; width:100%; margin:12px 0; }
  th, td { border:1px solid #ddd; padding:6px; text-align:center; font-size:13px; position:relative; }
  th { background:#f5f5f5; font-weight:600; }
  
  .flag-btn { 
    position:absolute; 
    left:2px; 
    top:50%;
    transform:translateY(-50%);
    width:8px;
    height:8px;
    border-radius:50%;
    background:#ddd;
    cursor:pointer;
    z-index:10;
  }
  .flag-btn:hover { background:#999; }
  .flag-btn.active { background:#ff5722; }
  
  tr td:first-child { padding-left:16px; }
  
  .group ol { margin-left:20px; }
  .group ol li { margin:12px 0; font-size:14px; line-height:1.6; position:relative; }
  .group ol li label { display:inline-block; margin-right:8px; }
  
  /* Added for text inputs in fill-in-blanks */
  .group input[type="text"] { border:1px solid #ccc; border-radius:4px; padding:4px 8px; font-size:13px; width:160px; }
  .note-list li { margin-bottom: 12px; list-style-type: disc; margin-left: 20px; }
  
  .bottom-bar { display:flex; gap:10px; margin-top:16px; }
  button { padding:10px 20px; border:1px solid #999; border-radius:6px; background:#fff; cursor:pointer; font-size:14px; }
  button:hover { background:#f0f0f0; }
  .btn-primary { background:#0066cc; color:#fff; border-color:#0066cc; }
  .btn-primary:hover { background:#0052a3; }
  .btn-danger { background:#dc3545; color:#fff; border-color:#dc3545; }
  .btn-danger:hover { background:#c82333; }
  
  .hl { background:#fff59d; cursor:pointer; }
  .hl:hover { background:#ffeb3b; }
  .note { background:#b3d9ff; cursor:pointer; }
  .note:hover { background:#99ccff; }
  
  #selbar { position:fixed; display:none; z-index:2000; background:#fff; border:1px solid #ddd; border-radius:8px; padding:8px; gap:0; box-shadow:0 2px 8px rgba(0,0,0,0.15); flex-direction:column; min-width:120px; }
  #selbar button { background:#fff; color:#666; border:none; padding:3px 0px; cursor:pointer; font-size:14px; text-align:center; border-radius:4px; }
  #selbar button:hover { background:#f5f5f5; color:#333; }
  
  .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:3000; align-items:center; justify-content:center; }
  .modal.active { display:flex; }
  .modal-content { background:#fff; border-radius:8px; padding:24px; max-width:600px; width:90%; max-height:80vh; overflow-y:auto; }
  
  .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
  .modal-header h2 { font-size: 28px; color: #333; margin: 0; }
  .modal-close { font-size: 32px; cursor: pointer; color: #999; line-height: 1; }
  .modal-close:hover { color: #333; }
  
  .result-summary { text-align:center; padding:20px; background:#f0f0f0; margin-bottom:16px; border-radius:6px; }
  .result-score { font-size:36px; font-weight:600; color:#0066cc; }
  .result-item { padding:10px; margin:8px 0; border-left:3px solid #ddd; background:#f9f9f9; font-size:13px; }
  .result-item.correct { border-left-color:#28a745; background:#e8f5e9; }
  .result-item.incorrect { border-left-color:#dc3545; background:#ffebee; }
  
  .wrong-item { background:#fff3e0; padding:16px; margin:8px 0; border-radius:8px; border-left:4px solid #ff9800; display:flex; justify-content:space-between; align-items:start; }
  .wrong-item-content { flex:1; }
  .btn-delete { background:#dc3545; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-size:13px; margin-left:12px; }
  .btn-delete:hover { background:#c82333; }
  .modal-actions { display:flex; gap:10px; margin-bottom:20px; }
</style>
</head>
<body>
<div id="timer">00:00</div>

<div class="shell">
  <section class="pane" id="left">
    
<h2>READING PASSAGE 3</h2>
<p>You should spend about 20 minutes on Questions 27‚Äì40, which are based on Reading Passage 3 below.</p>
<h3>Mercator - The Map Maker</h3>

<p>Maps codify the miracle of existence. And the man who wrote the codes for the maps we use today was Gerard Mercator, a cobbler‚Äôs son born 500 years ago on a muddy floodplain in northern Europe.</p>
<p>Mercator was a humble man with a universal vision. In his own time he was ‚Äòthe prince of modern geographers‚Äô, his depictions of the planet and its regions unsurpassed in accuracy, clarity and consistency. More recently, he was crowned by the American scholar Robert W. Karrow as ‚Äòthe first modern, scientific cartographer‚Äô. Where his predecessors had adopted a piecemeal approach to cartography, Mercator sought to wrap the world in systematic overlapping maps. Along the way he erected a number of historic milestones. He participated in the naming and mapping of ‚ÄòAmerica‚Äô, he constructed the two most important globes of the 16th century, and the title of his pioneering ‚Äòmodern geography‚Äô, the Atlas, became the standard term for a volume of maps. Mercator also devised a new method - ‚Äòa projection‚Äô - of converting the spherical world into a two-dimensional map.</p>
<p>Mercator was born in 1512 and died in 1594. His world was one of military conflict, social upheaval, religious revolution - and geographical discovery. He was ten years old when the survivors of the world‚Äôs first circumnavigation returned to Spain in their leaking caravel. No better example is required of genius arising from turmoil. He knew poverty, plague, war and persecution. He was imprisoned for his ideas yet patronised by an emperor. His life was one of brilliant breakthroughs and abrupt reversals. In its telling, his is the story of the poor boy made good: the pauper who embraced the world, found fame, faced death, yet triumphed through fortitude. Variously described by his peers as honest, calm, candid, sincere and peaceable, Mercator wore an aura of calm in troubled times. His attitude to his geographical calling was described by his friend and neighbour, William Ghim, as ‚Äòindefatigable‚Äô. Some 40 or so of Mercator‚Äôs letters have survived, together with examples of virtually all of his printed maps and globes.</p>
<p>Mercator‚Äôs most significant work was a project of cosmic proportions. A multi-part cosmography, the work would include a section on astronomy, a chronology of world events and a modern geography, which would eventually contain over 100 maps.</p>
<p>Before he commenced the great work, Mercator produced in 1569 an enormous world map on a new projection. His method for converting the spherical globe into a two-dimensional map helped to solve the greatest cartographic riddle of the day: how could the course of a ship following a constant compass bearing be represented as a straight line on a map which had been constructed on a grid of latitude and longitude?</p>
<p>Mercator‚Äôs solution was to progressively increase the space between his lines of latitude, away from the equator. The effect was to straighten the lines of constant compass bearing (also known as rhumbs or loxodromes). Unfortunately, straightening the rhumbs caused areal distortion: at the map‚Äôs northern and southern extremities, the polar regions occupied the full width of the map, while North America appeared to fill half the circumference of the world.</p>
<p>Few of Mercator‚Äôs contemporaries understood what he was up to, despite the map‚Äôs title explaining that it was intended ‚Äòfor use in navigation‚Äô. Mercator knew that his projection was unsuitable as an areal description of the world, but it would be several decades before the map‚Äôs true navigational value would be recognised.</p>
<p>Meanwhile, Mercator was marshalling and editing all the geographical data he needed for his modern regional maps of the world. His sources were wide-ranging and multitudinous, including an imperial physician in Vienna and his competitor, the Viceroy of Holstein. He was still working on these maps when he died. The great cosmography that Mercator had already titled ‚ÄòAtlas‚Äô would never be finished.</p>
<p>In the Atlas, Mercator had embodied the principles of future mapmaking: his italic lettering, his identical map overlaps, his complete coverage of regions at more than one scale, his consistent use of grids of latitude and longitude, his singular editorial control, were all adopted as cartographic standards. ‚ÄòAtlas‚Äô, the cosmography, became ‚Äòatlas‚Äô, the (Oxford English Dictionary) term for ‚Äòa collection of maps in a volume.‚Äô</p>
<p>The projection assumed a life of its own. So powerful a cartographic tool did it become that Mercator the man became subsumed by his own device. By the 20th century, Mercator‚Äôs Projection had been adopted by state cartographers to map the land that he had named ‚ÄòNorth America‚Äô. In 1938, Mercator‚Äôs Projection was selected by the Ordnance Survey to map Britain anew. And in 1974, the American cartographer Alden P. Colvocoresses used the Space Oblique Mercator Projection for the first satellite map of the USA. When the Jet Propulsion Laboratory sent Mariner 8 and Mariner 9 to map Mars, they undertook their Martian cartography on a standard Mercator Projection. One by one, the mappable orbs of our solar system are appearing on the worldwide web, flattened for our screens according to Mercator‚Äôs cartographic principles.</p>
<p>Mercator‚Äôs Projection succeeded in reconciling the sphere and the plane, while his Atlas enveloped the world with an integrated system of maps.</p>

  </section>

  <div id="divider" title="Drag to resize"></div>

  <section class="pane" id="right">
    <h3>Questions</h3>

    <div class="group">
      <h4>Questions 27‚Äì34</h4>
      <p>Do the following statements agree with the information given in Reading Passage 3?</p>
      <p>In boxes <strong>27‚Äì34</strong> on your answer sheet, write</p>
      <div style="margin-left:20px; margin-top:8px;">
        <div><strong>TRUE</strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if the statement agrees with the information</div>
        <div><strong>FALSE</strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if the statement contradicts the information</div>
        <div><strong>NOT GIVEN</strong>&nbsp;&nbsp;if there is no information on this</div>
      </div>

      <ol start="27">
        <li><span class="flag-btn" data-q="q27" style="left:-20px;"></span>Cartographers before Mercator had tended to produce separate, individual maps.<br>
          <label><input type="radio" name="q27" value="TRUE"> TRUE</label>
          <label><input type="radio" name="q27" value="FALSE"> FALSE</label>
          <label><input type="radio" name="q27" value="NOT GIVEN"> NOT GIVEN</label>
        </li>
        <li><span class="flag-btn" data-q="q28" style="left:-20px;"></span>Mercator was critical of the work of his contemporaries.<br>
          <label><input type="radio" name="q28" value="TRUE"> TRUE</label>
          <label><input type="radio" name="q28" value="FALSE"> FALSE</label>
          <label><input type="radio" name="q28" value="NOT GIVEN"> NOT GIVEN</label>
        </li>
        <li><span class="flag-btn" data-q="q29" style="left:-20px;"></span>During his life, Mercator experienced great changes of fortune.<br>
          <label><input type="radio" name="q29" value="TRUE"> TRUE</label>
          <label><input type="radio" name="q29" value="FALSE"> FALSE</label>
          <label><input type="radio" name="q29" value="NOT GIVEN"> NOT GIVEN</label>
        </li>
        <li><span class="flag-btn" data-q="q30" style="left:-20px;"></span>Most of Mercator‚Äôs published work remains intact today.<br>
          <label><input type="radio" name="q30" value="TRUE"> TRUE</label>
          <label><input type="radio" name="q30" value="FALSE"> FALSE</label>
          <label><input type="radio" name="q30" value="NOT GIVEN"> NOT GIVEN</label>
        </li>
        <li><span class="flag-btn" data-q="q31" style="left:-20px;"></span>Mercator started work on his projection shortly after embarking on his cosmography.<br>
          <label><input type="radio" name="q31" value="TRUE"> TRUE</label>
          <label><input type="radio" name="q31" value="FALSE"> FALSE</label>
          <label><input type="radio" name="q31" value="NOT GIVEN"> NOT GIVEN</label>
        </li>
        <li><span class="flag-btn" data-q="q32" style="left:-20px;"></span>Mercator‚Äôs Projection was immediately seen as a major breakthrough.<br>
          <label><input type="radio" name="q32" value="TRUE"> TRUE</label>
          <label><input type="radio" name="q32" value="FALSE"> FALSE</label>
          <label><input type="radio" name="q32" value="NOT GIVEN"> NOT GIVEN</label>
        </li>
        <li><span class="flag-btn" data-q="q33" style="left:-20px;"></span>Mercator produced an accurate areal description of the world.<br>
          <label><input type="radio" name="q33" value="TRUE"> TRUE</label>
          <label><input type="radio" name="q33" value="FALSE"> FALSE</label>
          <label><input type="radio" name="q33" value="NOT GIVEN"> NOT GIVEN</label>
        </li>
        <li><span class="flag-btn" data-q="q34" style="left:-20px;"></span>Mercator consulted the work of various people when producing his maps.<br>
          <label><input type="radio" name="q34" value="TRUE"> TRUE</label>
          <label><input type="radio" name="q34" value="FALSE"> FALSE</label>
          <label><input type="radio" name="q34" value="NOT GIVEN"> NOT GIVEN</label>
        </li>
      </ol>
    </div>

    <div class="group">
      <h4>Questions 35‚Äì40</h4>
      <p>Complete the notes below.</p>
      <p>Choose <strong>NO MORE THAN TWO WORDS</strong> from the passage for each answer.</p>
      <p>Write your answers in boxes <strong>35‚Äì40</strong> on your answer sheet.</p>
      
      <div style="position:relative; margin-top:20px;">
        <h4 style="color:#333;">Mercator‚Äôs Projection:</h4>
        <ul class="note-list">
            <li>His attempt to represent the globe as a 
                <span class="flag-btn" data-q="q35" style="left:-20px;"></span>
                <b>35</b> <input type="text" name="q35" autocomplete="off"> map
            </li>
        </ul>
        <h4 style="color:#333; margin-top:10px;">Problem:</h4>
        <ul class="note-list">
            <li>When sailors used a map based on lines of latitude and longitude and kept to a constant compass bearing, the course of the ship could not be shown as a 
                <span class="flag-btn" data-q="q36" style="left:-20px;"></span>
                <b>36</b> <input type="text" name="q36" autocomplete="off"> on a map
            </li>
        </ul>
        <h4 style="color:#333; margin-top:10px;">Solution:</h4>
        <ul class="note-list">
            <li>To increase the space separating the lines of latitude, the further they are from the equator</li>
        </ul>
        <h4 style="color:#333; margin-top:10px;">Result:</h4>
        <ul class="note-list">
            <li>When Mercator straightened the ‚Äòrhumbs‚Äô as intended, this produced 
                <span class="flag-btn" data-q="q37" style="left:-20px;"></span>
                <b>37</b> <input type="text" name="q37" autocomplete="off"> at the northern and southern extremities, with the full width of the map being taken up by the 
                <span class="flag-btn" data-q="q38" style="left:-20px;"></span>
                <b>38</b> <input type="text" name="q38" autocomplete="off">
            </li>
        </ul>
        <h4 style="color:#333; margin-top:10px;">Original intention:</h4>
        <ul class="note-list">
            <li>Mercator originally designed the map for 
                <span class="flag-btn" data-q="q39" style="left:-20px;"></span>
                <b>39</b> <input type="text" name="q39" autocomplete="off"> purposes
            </li>
        </ul>
        <h4 style="color:#333; margin-top:10px;">Uses of Mercator‚Äôs Projection up to the present day:</h4>
        <ul class="note-list">
            <li>Various uses including the mapping of 
                <span class="flag-btn" data-q="q40" style="left:-20px;"></span>
                <b>40</b> <input type="text" name="q40" autocomplete="off"> by state cartographers
            </li>
            <li>Also used to portray planets in our solar system on the web</li>
        </ul>
      </div>
    </div>

    <div class="bottom-bar">
      <button class="btn-primary" onclick="submitAnswers()">Êèê‰∫§</button>
      <button onclick="resetForm()">ÈáçÁΩÆ</button>
      <button onclick="openWrongBook()">Êú¨ÁØáÈîôÈ¢ò</button>
    </div>
  </section>
</div>

<div id="selbar">
  <button id="btnNote">Note</button>
  <button id="btnHL">Highlight</button>
  <button id="btnUH" style="display:none;">Clear Highlight</button>
</div>

<div class="modal" id="resultModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ÊàêÁª©</h2>
      <span class="modal-close" onclick="closeModal('resultModal')">√ó</span>
    </div>
    <div id="resultContent"></div>
    <button class="btn-primary" style="width:100%; margin-top:16px;" onclick="addWrongToBook()">Âä†ÂÖ•ÈîôÈ¢òÊú¨</button>
  </div>
</div>

<div class="modal" id="wrongBookModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Êú¨ÁØáÈîôÈ¢ò</h2>
      <span class="modal-close" onclick="closeModal('wrongBookModal')">√ó</span>
    </div>
    <div id="wrongBookContent"></div>
  </div>
</div>

<div class="modal" id="resetModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ÈáçÁΩÆÁªÉ‰π†</h2>
      <span class="modal-close" onclick="closeModal('resetModal')">√ó</span>
    </div>
    <div style="margin:16px 0;">
      <label style="display:block; margin-bottom:10px;">
        <input type="radio" name="resetType" value="answers" checked>
        Âè™Ê∏ÖÁ©∫Á≠îÊ°à
      </label>
      <label style="display:block;">
        <input type="radio" name="resetType" value="all">
        Ê∏ÖÁ©∫Á≠îÊ°àÂíåÊ†áËÆ∞
      </label>
    </div>
    <button class="btn-primary" style="width:100%;" onclick="confirmReset()">Á°ÆÂÆö</button>
  </div>
</div>

<script>
const PAPER_ID='P3_MERCATOR';

let t=0;
const timerEl=document.getElementById('timer');
setInterval(()=>{ t++; timerEl.textContent=String(Math.floor(t/60)).padStart(2,'0')+':'+String(t%60).padStart(2,'0'); }, 1000);

const divider=document.getElementById('divider'), left=document.getElementById('left'), right=document.getElementById('right');
let dragging=false;
divider.onmousedown=()=>{ dragging=true; document.body.style.cursor='ew-resize'; };
window.onmousemove=(e)=>{ if(!dragging)return; const c=document.querySelector('.shell').getBoundingClientRect(); let x=e.clientX-c.left; x=Math.max(280,Math.min(c.width-280,x)); left.style.flex='0 0 '+x+'px'; right.style.flex='1 1 auto'; };
window.onmouseup=()=>{ dragging=false; document.body.style.cursor=''; };

const selbar=document.getElementById('selbar'), btnHL=document.getElementById('btnHL'), btnUH=document.getElementById('btnUH'), btnNote=document.getElementById('btnNote');
let lastRange=null, currentHlNode=null;

function posSelbar(r){ selbar.style.display='flex'; const t=window.scrollY+r.top-selbar.offsetHeight-8; const l=window.scrollX+r.left+r.width/2-selbar.offsetWidth/2; selbar.style.top=((t>0)?t:(window.scrollY+r.bottom+8))+'px'; selbar.style.left=Math.max(8,l)+'px'; }

function updSel(){ const s=window.getSelection(); if(!s||s.rangeCount===0||s.isCollapsed){ if(!currentHlNode)selbar.style.display='none'; return; } const r=s.getRangeAt(0); lastRange=r.cloneRange(); currentHlNode=null; btnNote.style.display='block'; btnHL.style.display='block'; btnUH.style.display='none'; posSelbar(r.getBoundingClientRect()); }

left.onmouseup=updSel; right.onmouseup=updSel;
document.onselectionchange=()=>{ const s=window.getSelection(); if((!s||s.rangeCount===0||s.isCollapsed)&&!currentHlNode)selbar.style.display='none'; };
document.addEventListener('click',(e)=>{ if(e.target.classList&&(e.target.classList.contains('hl')||e.target.classList.contains('note'))){ currentHlNode=e.target; lastRange=null; btnNote.style.display='none'; btnHL.style.display='none'; btnUH.style.display='block'; posSelbar(e.target.getBoundingClientRect()); const s=window.getSelection(); if(s)s.removeAllRanges(); }}, true);

btnHL.onclick=()=>{ if(currentHlNode||!lastRange||lastRange.collapsed)return; const s=document.createElement('span'); s.className='hl'; try{ lastRange.surroundContents(s); }catch(e){ const w=document.createElement('span'); w.className='hl'; w.appendChild(lastRange.cloneContents()); lastRange.deleteContents(); lastRange.insertNode(w); } selbar.style.display='none'; saveHighlights(); };

btnNote.onclick=()=>{ if(currentHlNode||!lastRange||lastRange.collapsed)return; const s=document.createElement('span'); s.className='note'; try{ lastRange.surroundContents(s); }catch(e){ const w=document.createElement('span'); w.className='note'; w.appendChild(lastRange.cloneContents()); lastRange.deleteContents(); lastRange.insertNode(w); } selbar.style.display='none'; saveHighlights(); };

btnUH.onclick=()=>{ if(currentHlNode){ const p=currentHlNode.parentNode; while(currentHlNode.firstChild)p.insertBefore(currentHlNode.firstChild,currentHlNode); p.removeChild(currentHlNode); p.normalize(); currentHlNode=null; selbar.style.display='none'; saveHighlights(); }else if(lastRange){ const sR=lastRange.getBoundingClientRect(); const w=document.createTreeWalker(document.body,NodeFilter.SHOW_ELEMENT); const tr=[]; while(w.nextNode()){ const n=w.currentNode; if(n.classList&&(n.classList.contains('hl')||n.classList.contains('note'))){ const r=n.getBoundingClientRect(); if(!(r.right<sR.left||r.left>sR.right||r.bottom<sR.top||r.top>sR.bottom))tr.push(n); }} tr.forEach(el=>{ const p=el.parentNode; while(el.firstChild)p.insertBefore(el.firstChild,el); p.removeChild(el); p.normalize(); }); selbar.style.display='none'; saveHighlights(); }};

document.querySelectorAll('.flag-btn').forEach(btn => {
  btn.onclick = e => {
    e.stopPropagation();
    btn.classList.toggle('active');
    saveFlags();
  };
});

const answerKey={
  q27:"TRUE",q28:"NOT GIVEN",q29:"TRUE",q30:"TRUE",
  q31:"FALSE",q32:"FALSE",q33:"FALSE",q34:"TRUE",
  q35:"two-dimensional",q36:"straight line",q37:"areal distortion",
  q38:"polar regions",q39:"navigation",q40:"North America"
};
let lastResults=[];

function saveAnswers() {
  const data = {};
  Object.keys(answerKey).forEach(q => {
    const el = document.querySelector(`[name="${q}"]`);
    if(el.type === 'radio') {
      const ch = document.querySelector(`input[name="${q}"]:checked`);
      if(ch) data[q] = ch.value;
    } else {
      data[q] = el.value;
    }
  });
  localStorage.setItem(`${PAPER_ID}_answers`, JSON.stringify(data));
}

function loadAnswers() {
  const data = JSON.parse(localStorage.getItem(`${PAPER_ID}_answers`) || '{}');
  Object.keys(data).forEach(q => {
    const el = document.querySelector(`[name="${q}"]`);
    if(el.type === 'radio') {
       const radio = document.querySelector(`input[name="${q}"][value="${data[q]}"]`);
       if(radio) radio.checked = true;
    } else {
       el.value = data[q];
    }
  });
}

function saveFlags() {
  const flags = [...document.querySelectorAll('.flag-btn.active')].map(b => b.dataset.q);
  localStorage.setItem(`${PAPER_ID}_flags`, JSON.stringify(flags));
}

function loadFlags() {
  const flags = JSON.parse(localStorage.getItem(`${PAPER_ID}_flags`) || '[]');
  flags.forEach(q => document.querySelector(`[data-q="${q}"]`)?.classList.add('active'));
}

function saveHighlights() {
  const highlights = { left: [], right: [] };
  document.querySelectorAll('#left .hl, #left .note').forEach((el, idx) => {
    highlights.left.push({
      type: el.classList.contains('hl') ? 'hl' : 'note',
      text: el.textContent,
      index: idx
    });
  });
  document.querySelectorAll('#right .hl, #right .note').forEach((el, idx) => {
    highlights.right.push({
      type: el.classList.contains('hl') ? 'hl' : 'note',
      text: el.textContent,
      index: idx
    });
  });
  localStorage.setItem(`${PAPER_ID}_highlights`, JSON.stringify(highlights));
}

function loadHighlights() {
  const data = JSON.parse(localStorage.getItem(`${PAPER_ID}_highlights`) || '{"left":[],"right":[]}');
  
  const restore = (container, items) => {
    if(!items || items.length === 0) return;
    items.forEach(item => {
      const walker = document.createTreeWalker(container, NodeFilter.SHOW_TEXT);
      let node;
      while(node = walker.nextNode()) {
        if(node.textContent.includes(item.text)) {
          const span = document.createElement('span');
          span.className = item.type;
          const parent = node.parentNode;
          const text = node.textContent;
          const idx = text.indexOf(item.text);
          if(idx >= 0) {
            const before = text.substring(0, idx);
            const match = text.substring(idx, idx + item.text.length);
            const after = text.substring(idx + item.text.length);
            parent.insertBefore(document.createTextNode(before), node);
            span.textContent = match;
            parent.insertBefore(span, node);
            parent.insertBefore(document.createTextNode(after), node);
            parent.removeChild(node);
            break;
          }
        }
      }
    });
  };
  restore(left, data.left);
  restore(right, data.right);
}

document.querySelectorAll('input').forEach(inp => {
  inp.addEventListener('change', saveAnswers);
  if(inp.type==='text') inp.addEventListener('input', saveAnswers);
});

document.addEventListener('DOMContentLoaded', () => {
  loadAnswers();
  loadFlags();
  loadHighlights();
});

function submitAnswers(){ 
  const res=[]; let cor=0; 
  Object.keys(answerKey).forEach(q=>{ 
    let uA="", iC=false;
    const el = document.querySelector(`[name="${q}"]`);
    const cA = answerKey[q];
    
    if(el.type === 'radio') {
      const ch = document.querySelector(`input[name="${q}"]:checked`);
      uA = ch ? ch.value : "";
      iC = uA === cA;
    } else {
      uA = el.value.trim();
      // Case insensitive check for text inputs
      iC = uA.toLowerCase() === cA.toLowerCase();
    }

    if(iC) cor++; 
    res.push({id:q,userAns:uA,correctAns:cA,isCorrect:iC}); 
  }); 
  lastResults=res; 
  const tot=Object.keys(answerKey).length; 
  const pct=((cor/tot)*100).toFixed(1); 
  localStorage.setItem(`ielts_score_${PAPER_ID}`, `${cor}/${tot}`);
  document.getElementById('resultContent').innerHTML=`<div class="result-summary"><div class="result-score">${cor} / ${tot}</div><div style="margin-top:8px;font-size:18px;">${pct}%</div></div>${res.map(r=>`<div class="result-item ${r.isCorrect?'correct':'incorrect'}"><div><strong>${r.id}</strong> ${r.isCorrect?'‚úì':'‚úó'}</div><div>‰Ω†ÁöÑÁ≠îÊ°à: ${r.userAns||'(Êú™‰ΩúÁ≠î)'}</div>${!r.isCorrect?`<div>Ê≠£Á°ÆÁ≠îÊ°à: ${r.correctAns}</div>`:''}</div>`).join('')}`; 
  document.getElementById('resultModal').classList.add('active'); 
}

function resetForm(){ document.getElementById('resetModal').classList.add('active'); }

function confirmReset(){ 
  const tp=document.querySelector('input[name="resetType"]:checked').value; 
  document.querySelectorAll('input[type="radio"]').forEach(i=>i.checked=false); 
  document.querySelectorAll('input[type="text"]').forEach(i=>i.value=''); 
  localStorage.removeItem(`${PAPER_ID}_answers`);
  
  if(tp==='all'){ 
    document.querySelectorAll('.hl').forEach(el=>{ const p=el.parentNode; while(el.firstChild)p.insertBefore(el.firstChild,el); p.removeChild(el); p.normalize(); }); 
    document.querySelectorAll('.note').forEach(el=>{ const p=el.parentNode; while(el.firstChild)p.insertBefore(el.firstChild,el); p.removeChild(el); p.normalize(); }); 
    document.querySelectorAll('.flag-btn').forEach(b => b.classList.remove('active'));
    localStorage.removeItem(`${PAPER_ID}_highlights`);
    localStorage.removeItem(`${PAPER_ID}_flags`);
  } 
  closeModal('resetModal'); 
}

function addWrongToBook(){ const wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); const wr=lastResults.filter(r=>!r.isCorrect); wr.forEach(r=>{ const en={paperId:PAPER_ID,title:'Mercator - The Map Maker',questionId:r.id,correctAnswer:r.correctAns,myAnswer:r.userAns||'(Êú™‰ΩúÁ≠î)',date:new Date().toISOString().split('T')[0]}; const ix=wb.findIndex(i=>i.paperId===en.paperId&&i.questionId===en.questionId); if(ix>=0)wb[ix]=en; else wb.push(en); }); localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); alert(`Â∑≤Ê∑ªÂä† ${wr.length} ÈÅìÈîôÈ¢ò`); closeModal('resultModal'); }

function deleteWrongItem(pId,qId){ if(!confirm('Á°ÆÂÆöÂà†Èô§ËøôÈÅìÈîôÈ¢òÔºü'))return; let wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); wb=wb.filter(i=>!(i.paperId===pId&&i.questionId===qId)); localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); openWrongBook(); }

function clearCurrentWrongBook(){ if(!confirm('Á°ÆÂÆöÊ∏ÖÁ©∫Êú¨ÁØáÊâÄÊúâÈîôÈ¢òÔºü'))return; let wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); wb=wb.filter(i=>i.paperId!==PAPER_ID); localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); openWrongBook(); }

function openWrongBook(){ const wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); const cu=wb.filter(i=>i.paperId===PAPER_ID); const ct=document.getElementById('wrongBookContent'); if(cu.length===0)ct.innerHTML='<div style="text-align:center;padding:40px;color:#666;">ÊöÇÊó†ÈîôÈ¢ò</div>'; else ct.innerHTML=`<div class="modal-actions"><button class="btn-danger" onclick="clearCurrentWrongBook()" style="width:100%;">üóëÔ∏è Ê∏ÖÁ©∫Êú¨ÁØáÈîôÈ¢ò</button></div>${cu.map(i=>`<div class="wrong-item"><div class="wrong-item-content"><div style="font-weight:600;margin-bottom:8px;">${i.questionId}</div><div style="font-size:13px;color:#666;"><div>‚úì Ê≠£Á°Æ: ${i.correctAnswer}</div><div style="color:#d32f2f;">‚úó ÊàëÁöÑ: ${i.myAnswer}</div></div></div><button class="btn-delete" onclick="deleteWrongItem('${i.paperId}','${i.questionId}')">Âà†Èô§</button></div>`).join('')}`; document.getElementById('wrongBookModal').classList.add('active'); }

function closeModal(id){ document.getElementById(id).classList.remove('active'); }
</script>
</body>
</html>
