<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>P3 ‚Äì The New Zealand writer Margaret Mahy</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  * { box-sizing: border-box; margin:0; padding:0; }
  html,body { height:100%; }
  body { font-family: Arial, sans-serif; background:#f5f5f5; }
  
  #timer { position:fixed; top:12px; right:12px; background:#fff; border:1px solid #ddd; border-radius:6px; padding:8px 12px; font-size:16px; font-weight:600; color:#0066cc; z-index:1000; }
  
  .shell { display:flex; height:100vh; width:100%; }
  .pane { background:#fff; overflow:auto; padding:24px; }
  #left { flex: 0 0 50%; border-right:1px solid #ddd; }
  #right { flex: 1 1 auto; background:#fafafa; }
  #divider { flex: 0 0 5px; background:#ddd; cursor: ew-resize; }
  #divider:hover { background:#999; }
  
  h2,h3,h4 { margin:0 0 12px; color:#333; }
  h2 { font-size:20px; }
  h3 { font-size:18px; color:#0066cc; }
  h4 { font-size:15px; font-weight:600; margin-top:20px; }
  
  #left p { margin: 0 0 14px; line-height: 1.7; text-align:justify; }
  
  .group { background:#fff; border:1px solid #ddd; border-radius:6px; padding:16px; margin-bottom:16px; }
  .group h4 { margin-top:0; color:#0066cc; }
  .group p { margin:8px 0; font-size:14px; line-height:1.6; }
  
  .group ol { margin-left:20px; }
  .group ol li { margin:12px 0; font-size:14px; line-height:1.6; position:relative; }
  .group ol li label { display:inline-block; margin-right:8px; }
  
  .flag-btn { 
    position:absolute; 
    left:-20px; 
    top:50%;
    transform:translateY(-50%);
    width:8px;
    height:8px;
    border-radius:50%;
    background:#ddd;
    cursor:pointer;
    z-index:10;
  }
  .flag-btn:hover { background:#999; }
  .flag-btn.active { background:#ff5722; }
  
  .bottom-bar { display:flex; gap:10px; margin-top:16px; }
  button { padding:10px 20px; border:1px solid #999; border-radius:6px; background:#fff; cursor:pointer; font-size:14px; }
  button:hover { background:#f0f0f0; }
  .btn-primary { background:#0066cc; color:#fff; border-color:#0066cc; }
  .btn-primary:hover { background:#0052a3; }
  .btn-danger { background:#dc3545; color:#fff; border-color:#dc3545; }
  .btn-danger:hover { background:#c82333; }
  
  .hl { background:#fff59d; cursor:pointer; }
  .hl:hover { background:#ffeb3b; }
  .note { background:#b3d9ff; cursor:pointer; }
  .note:hover { background:#99ccff; }
  
  #selbar { position:fixed; display:none; z-index:2000; background:#fff; border:1px solid #ddd; border-radius:8px; padding:8px; gap:0; box-shadow:0 2px 8px rgba(0,0,0,0.15); flex-direction:column; min-width:120px; }
  #selbar button { background:#fff; color:#666; border:none; padding:8px 12px; cursor:pointer; font-size:14px; text-align:center; border-radius:4px; }
  #selbar button:hover { background:#f5f5f5; color:#333; }
  
  .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:3000; align-items:center; justify-content:center; }
  .modal.active { display:flex; }
  .modal-content { background:#fff; border-radius:8px; padding:24px; max-width:600px; width:90%; max-height:80vh; overflow-y:auto; }
  
  .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
  .modal-header h2 { font-size: 28px; color: #333; margin: 0; }
  .modal-close { font-size: 32px; cursor: pointer; color: #999; line-height: 1; }
  .modal-close:hover { color: #333; }
  
  .result-summary { text-align:center; padding:20px; background:#f0f0f0; margin-bottom:16px; border-radius:6px; }
  .result-score { font-size:36px; font-weight:600; color:#0066cc; }
  .result-item { padding:10px; margin:8px 0; border-left:3px solid #ddd; background:#f9f9f9; font-size:13px; }
  .result-item.correct { border-left-color:#28a745; background:#e8f5e9; }
  .result-item.incorrect { border-left-color:#dc3545; background:#ffebee; }
  
  .wrong-item { background:#fff3e0; padding:16px; margin:8px 0; border-radius:8px; border-left:4px solid #ff9800; display:flex; justify-content:space-between; align-items:start; }
  .wrong-item-content { flex:1; }
  .btn-delete { background:#dc3545; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-size:13px; margin-left:12px; }
  .btn-delete:hover { background:#c82333; }
  .modal-actions { display:flex; gap:10px; margin-bottom:20px; }
</style>
</head>
<body>
<div id="timer">00:00</div>

<div class="shell">
  <section class="pane" id="left">
    
<h2>READING PASSAGE 3</h2>
<p>You should spend about 20 minutes on Questions 27‚Äì40, which are based on Reading Passage 3.</p>
<h3>The New Zealand writer Margaret Mahy</h3>

<p>In a career spanning some fifty years, Margaret Mahy has come to occupy a unique place in New Zealand writing with innovative fiction and original characterisation. In our solidly realist tradition, the linguistic fireworks of Mahy's children's fiction and the explorations of human behaviour at the heart of her supernatural teenage fiction stand gloriously alone. Mahy's clearest heir, I have always thought, is Elizabeth Knox ‚Äî and maybe the true inheritance there is sheer singularity. Just as there is no one else like Knox in New Zealand writing, Mahy, too, has ventured into imaginative territory unknown to other local writers. So it was with great pleasure that I visited Mahy recently at her Governor's Bay home to talk about her new book. As with all journalists, she is generous to a fault with her time and attention; and, as always ‚Äî despite her careful consideration of questions and thoughtful answers ‚Äî I'm reminded she isn't truly comfortable making herself or her life the heart of any conversation.</p>

<p>Certainly, any consideration of the style of Mahy's novels and picture books throws up some irresistible theories. As a writer committed to supporting herself through her art, she has seldom had the time for formal research. Rather, it has been a matter of going out and finding inspiration from her immediate environment: the writing on the side of a bus; a spelling mistake in a note to herself; the similarity between a cat and a fur hat. But despite these sometimes mundane origins, the settings for her stories are delightfully varied, as these books celebrate the dramatic plot twists and unpredictability of adventures on the high seas or in Antarctica, and also in quite unassuming places like the library or even down the back of a chair at home. Mahy has a lifelong affection for characters who are agents of upheaval and disturbance. Her junior and picture books are peppered with pirates, robbers and lions, though they appear alongside librarians, mothers and children, working against comfortable stereotype. Her fictions often have at their heart a young adult burdened with special powers, such as the ability to cast spells in order to transform their world in supernatural and fantastical ways. Another common feature is that, while the conclusions of her tales are usually predictable, they leave the reader feeling absolutely complete, the moral questions resulting from our hero's powers having been resolved.</p>

<p>Many of these themes can be found in her new novel, The Magician of Hoad. The book was begun more than 15 years ago and envisioned as an 'entire' fantasy ‚Äî one set in a fully imagined world with detailed history and complex tribal inter-relationships, a classical hero quest at its heart. The story ballooned at one point to 800 pages and has been through at least two substantial rewrites. Now half its original size, it is a fascinating read ‚Äî an adventure, a romance, and a gold mine of Mahy literary preoccupations.</p>

<p>The other splendid Mahy publication this year is a re-issue of Bubble Trouble in a now-illustrated edition. This tongue-twister tale first appeared in 1991, was included in 100 New Zealand Poems (1993) and has been recited by Mahy at countless private and public functions. Perhaps more than any other work, Bubble Trouble is the Mahy that New Zealand children and their parents know so well, the rollicking story of a clown who serves up a joyous torrent of word-play and unexpected rhyme.</p>

<p>Those connections are four or five deep now. I read The Lion in the Meadow in the School Journal in the late 1960s; my step-daughter listened to The Boy Who Was Followed Home over and over in the 1970s; my own children sat very still mouthing The Great White Man-Eating Shark in the 80s and 90s; now, in the 21st century, my grandchildren have heard Down the Dragon's Tongue, A Summery Saturday Morning and Dashing Dog many times.</p>

<p>Of course, readers are important to any working writer, but Mahy's espousal of the act of reading goes beyond that: a book is not properly finished, she has often said, until it has been read, because a reader brings something important to the book. So, doubtless out of need to build a market ‚Äî she's not ignorant of her popularity ‚Äî but also out of genuine care for that other dynamic part of the author-reader relationship, Mahy has, until recently, kept up a punishing schedule of public appearances.</p>

<p>Private conversation with Mahy has always been a wild ride ‚Äî marvellous, in the true sense of the word, the product of a hungry head and an infinite capacity to be astonished. She races away at one stage to consult an encyclopaedia for L. M. Montgomery's date of death, and speculates about the 'real' Montgomery, creator of the ever-popular Anne of Green Gables. Although I'd come to talk about her new book, I couldn't help but be captivated by her infectious curiosity.</p>

<p>A few years ago, the writer David Hill told a funny story. Though his writing was, he conceded, very different from Mahy's, he had been affected by her peculiarly alert way of looking at the world, particularly the mad, slippery life of language. Once, Hill said, in a motel room, a sign on a door caught his eye: 'This door is alarmed.' Mahy would like that, thought Hill. She would enjoy the comedy just below the surface of the formal warning; she would leap immediately to the possibilities for story and language play: 'Yes, and this window is concerned, this light fitting is irritated.' His story was a wonderful comment on Mahy's vision.</p>

  </section>

  <div id="divider" title="Drag to resize"></div>

  <section class="pane" id="right">
    <h3>Questions</h3>

    <div class="group">
      <h4>Questions 27‚Äì31</h4>
      <p>Do the following statements agree with the claims of the writer in Reading Passage 3?</p>
      <p>In boxes <strong>27‚Äì31</strong> on your answer sheet, write</p>
      <div style="margin-left:20px; margin-top:8px;">
        <div><strong>YES</strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if the statement agrees with the claims of the writer</div>
        <div><strong>NO</strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if the statement contradicts the claims of the writer</div>
        <div><strong>NOT GIVEN</strong>&nbsp;&nbsp;if it is impossible to say what the writer thinks about this</div>
      </div>

      <ol start="27">
        <li><span class="flag-btn" data-q="q27"></span>Mahy explores the traditional themes of New Zealand literature.<br>
          <label><input type="radio" name="q27" value="YES"> YES</label>
          <label><input type="radio" name="q27" value="NO"> NO</label>
          <label><input type="radio" name="q27" value="NOT GIVEN"> NOT GIVEN</label>
        </li>
        <li><span class="flag-btn" data-q="q28"></span>Mahy's children's books have been more popular than her teenage books.<br>
          <label><input type="radio" name="q28" value="YES"> YES</label>
          <label><input type="radio" name="q28" value="NO"> NO</label>
          <label><input type="radio" name="q28" value="NOT GIVEN"> NOT GIVEN</label>
        </li>
        <li><span class="flag-btn" data-q="q29"></span>Mahy and Knox have sometimes criticised each other's work.<br>
          <label><input type="radio" name="q29" value="YES"> YES</label>
          <label><input type="radio" name="q29" value="NO"> NO</label>
          <label><input type="radio" name="q29" value="NOT GIVEN"> NOT GIVEN</label>
        </li>
        <li><span class="flag-btn" data-q="q30"></span>Mahy is welcoming to interviewers.<br>
          <label><input type="radio" name="q30" value="YES"> YES</label>
          <label><input type="radio" name="q30" value="NO"> NO</label>
          <label><input type="radio" name="q30" value="NOT GIVEN"> NOT GIVEN</label>
        </li>
        <li><span class="flag-btn" data-q="q31"></span>Mahy is at ease speaking about her experiences.<br>
          <label><input type="radio" name="q31" value="YES"> YES</label>
          <label><input type="radio" name="q31" value="NO"> NO</label>
          <label><input type="radio" name="q31" value="NOT GIVEN"> NOT GIVEN</label>
        </li>
      </ol>
    </div>

    <div class="group">
      <h4>Questions 32‚Äì35</h4>
      <p>Complete the summary below using the list of words and phrases <strong>A‚ÄìI</strong>.</p>
      <p>Write the correct letter <strong>A‚ÄìI</strong> in boxes <strong>32‚Äì35</strong> on your answer sheet.</p>

      <div style="background:#f9f9f9; padding:16px; border-radius:6px; margin:16px 0;">
        <p style="font-weight:600; margin-bottom:12px;">Theories about Mahy's style</p>
        <p style="margin:8px 0;">Mahy's determination to earn a living from writing has encouraged her to find the ideas for her work in <strong>32</strong> <select name="q32" style="padding:4px;"><option value="">--</option><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option><option value="E">E</option><option value="F">F</option><option value="G">G</option><option value="H">H</option><option value="I">I</option></select> places. The stories themselves are set in locations that are <strong>33</strong> <select name="q33" style="padding:4px;"><option value="">--</option><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option><option value="E">E</option><option value="F">F</option><option value="G">G</option><option value="H">H</option><option value="I">I</option></select>. In terms of characterisation, almost all of her books feature unruly people, and very often an adolescent who possesses <strong>34</strong> <select name="q34" style="padding:4px;"><option value="">--</option><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option><option value="E">E</option><option value="F">F</option><option value="G">G</option><option value="H">H</option><option value="I">I</option></select> abilities. Finally, the endings of the stories tend to be <strong>35</strong> <select name="q35" style="padding:4px;"><option value="">--</option><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option><option value="E">E</option><option value="F">F</option><option value="G">G</option><option value="H">H</option><option value="I">I</option></select>.</p>
      </div>

      <div style="background:#f0f0f0; padding:12px; border-radius:6px;">
        <p style="margin:4px 0; font-size:13px;"><strong>A</strong> disruptive and unpredictable</p>
        <p style="margin:4px 0; font-size:13px;"><strong>B</strong> everyday</p>
        <p style="margin:4px 0; font-size:13px;"><strong>C</strong> loveable</p>
        <p style="margin:4px 0; font-size:13px;"><strong>D</strong> controversial</p>
        <p style="margin:4px 0; font-size:13px;"><strong>E</strong> exotic and ordinary</p>
        <p style="margin:4px 0; font-size:13px;"><strong>F</strong> isolated</p>
        <p style="margin:4px 0; font-size:13px;"><strong>G</strong> unconfident</p>
        <p style="margin:4px 0; font-size:13px;"><strong>H</strong> unsurprising but satisfying</p>
        <p style="margin:4px 0; font-size:13px;"><strong>I</strong> magical</p>
      </div>
    </div>

    <div class="group">
      <h4>Questions 36‚Äì40</h4>
      <p>Choose the correct letter, <strong>A, B, C or D</strong>.</p>
      <p>Write the correct letter <strong>A‚ÄìD</strong> in boxes <strong>36‚Äì40</strong> on your answer sheet.</p>

      <ol start="36">
        <li><span class="flag-btn" data-q="q36"></span><strong>36</strong> What does the writer say about <em>The Magician of Hoad</em>?<br>
          <label><input type="radio" name="q36" value="A"> <strong>A</strong></label> It is partly based on true history.<br>
          <label><input type="radio" name="q36" value="B"> <strong>B</strong></label> It was restructured in the writing process.<br>
          <label><input type="radio" name="q36" value="C"> <strong>C</strong></label> It is quite different from conventional stories.<br>
          <label><input type="radio" name="q36" value="D"> <strong>D</strong></label> It does not reflect the usual themes of Mahy's work.
        </li>
        <li><span class="flag-btn" data-q="q37"></span><strong>37</strong> According to the writer, <em>Bubble Trouble</em><br>
          <label><input type="radio" name="q37" value="A"> <strong>A</strong></label> was first illustrated in 1991.<br>
          <label><input type="radio" name="q37" value="B"> <strong>B</strong></label> is written in plain language.<br>
          <label><input type="radio" name="q37" value="C"> <strong>C</strong></label> is an old favourite for many families.<br>
          <label><input type="radio" name="q37" value="D"> <strong>D</strong></label> has not been read aloud by Mahy before.
        </li>
        <li><span class="flag-btn" data-q="q38"></span><strong>38</strong> The writer's purpose in the fifth paragraph is to<br>
          <label><input type="radio" name="q38" value="A"> <strong>A</strong></label> show how Mahy's style has changed through generations.<br>
          <label><input type="radio" name="q38" value="B"> <strong>B</strong></label> criticise Mahy's children's stories for being repetitive.<br>
          <label><input type="radio" name="q38" value="C"> <strong>C</strong></label> describe how new media have changed entertainment.<br>
          <label><input type="radio" name="q38" value="D"> <strong>D</strong></label> illustrate Mahy's popularity with generations of children.
        </li>
        <li><span class="flag-btn" data-q="q39"></span><strong>39</strong> According to the sixth paragraph, which of the following is true?<br>
          <label><input type="radio" name="q39" value="A"> <strong>A</strong></label> Readers sometimes do not finish Mahy's books.<br>
          <label><input type="radio" name="q39" value="B"> <strong>B</strong></label> Mahy actively encourages feedback from readers.<br>
          <label><input type="radio" name="q39" value="C"> <strong>C</strong></label> Readers are necessary in order to complete a book.<br>
          <label><input type="radio" name="q39" value="D"> <strong>D</strong></label> Mahy does not realise how important she is to some readers.
        </li>
        <li><span class="flag-btn" data-q="q40"></span><strong>40</strong> What is the writer doing in the final paragraph?<br>
          <label><input type="radio" name="q40" value="A"> <strong>A</strong></label> illustrating Mahy's view of the world<br>
          <label><input type="radio" name="q40" value="B"> <strong>B</strong></label> comparing Mahy with another writer<br>
          <label><input type="radio" name="q40" value="C"> <strong>C</strong></label> correcting a misconception about Mahy<br>
          <label><input type="radio" name="q40" value="D"> <strong>D</strong></label> suggesting reasons for Mahy's approach
        </li>
      </ol>
    </div>

    <div class="bottom-bar">
      <button class="btn-primary" onclick="submitAnswers()">Êèê‰∫§</button>
      <button onclick="resetForm()">ÈáçÁΩÆ</button>
      <button onclick="openWrongBook()">Êú¨ÁØáÈîôÈ¢ò</button>
    </div>
  </section>
</div>

<div id="selbar">
  <button id="btnNote">Note</button>
  <button id="btnHL">Highlight</button>
  <button id="btnUH" style="display:none;">Clear Highlight</button>
</div>

<div class="modal" id="resultModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ÊàêÁª©</h2>
      <span class="modal-close" onclick="closeModal('resultModal')">√ó</span>
    </div>
    <div id="resultContent"></div>
    <button class="btn-primary" style="width:100%; margin-top:16px;" onclick="addWrongToBook()">Âä†ÂÖ•ÈîôÈ¢òÊú¨</button>
  </div>
</div>

<div class="modal" id="wrongBookModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Êú¨ÁØáÈîôÈ¢ò</h2>
      <span class="modal-close" onclick="closeModal('wrongBookModal')">√ó</span>
    </div>
    <div id="wrongBookContent"></div>
  </div>
</div>

<div class="modal" id="resetModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ÈáçÁΩÆÁªÉ‰π†</h2>
      <span class="modal-close" onclick="closeModal('resetModal')">√ó</span>
    </div>
    <div style="margin:16px 0;">
      <label style="display:block; margin-bottom:10px;">
        <input type="radio" name="resetType" value="answers" checked>
        Âè™Ê∏ÖÁ©∫Á≠îÊ°à
      </label>
      <label style="display:block;">
        <input type="radio" name="resetType" value="all">
        Ê∏ÖÁ©∫Á≠îÊ°àÂíåÊ†áËÆ∞
      </label>
    </div>
    <button class="btn-primary" style="width:100%;" onclick="confirmReset()">Á°ÆÂÆö</button>
  </div>
</div>

<script>
const PAPER_ID='P3_MARGARET_MAHY';

let t=0;
const timerEl=document.getElementById('timer');
setInterval(()=>{ t++; timerEl.textContent=String(Math.floor(t/60)).padStart(2,'0')+':'+String(t%60).padStart(2,'0'); }, 1000);

const divider=document.getElementById('divider'), left=document.getElementById('left'), right=document.getElementById('right');
let dragging=false;
divider.onmousedown=()=>{ dragging=true; document.body.style.cursor='ew-resize'; };
window.onmousemove=(e)=>{ if(!dragging)return; const c=document.querySelector('.shell').getBoundingClientRect(); let x=e.clientX-c.left; x=Math.max(280,Math.min(c.width-280,x)); left.style.flex='0 0 '+x+'px'; right.style.flex='1 1 auto'; };
window.onmouseup=()=>{ dragging=false; document.body.style.cursor=''; };

const selbar=document.getElementById('selbar'), btnHL=document.getElementById('btnHL'), btnUH=document.getElementById('btnUH'), btnNote=document.getElementById('btnNote');
let lastRange=null, currentHlNode=null;

function posSelbar(r){ selbar.style.display='flex'; const t=window.scrollY+r.top-selbar.offsetHeight-8; const l=window.scrollX+r.left+r.width/2-selbar.offsetWidth/2; selbar.style.top=((t>0)?t:(window.scrollY+r.bottom+8))+'px'; selbar.style.left=Math.max(8,l)+'px'; }

function updSel(){ const s=window.getSelection(); if(!s||s.rangeCount===0||s.isCollapsed){ if(!currentHlNode)selbar.style.display='none'; return; } const r=s.getRangeAt(0); lastRange=r.cloneRange(); currentHlNode=null; btnNote.style.display='block'; btnHL.style.display='block'; btnUH.style.display='none'; posSelbar(r.getBoundingClientRect()); }

left.onmouseup=updSel; right.onmouseup=updSel;
document.onselectionchange=()=>{ const s=window.getSelection(); if((!s||s.rangeCount===0||s.isCollapsed)&&!currentHlNode)selbar.style.display='none'; };
document.addEventListener('click',(e)=>{ if(e.target.classList&&(e.target.classList.contains('hl')||e.target.classList.contains('note'))){ currentHlNode=e.target; lastRange=null; btnNote.style.display='none'; btnHL.style.display='none'; btnUH.style.display='block'; posSelbar(e.target.getBoundingClientRect()); const s=window.getSelection(); if(s)s.removeAllRanges(); }}, true);

btnHL.onclick=()=>{ if(currentHlNode||!lastRange||lastRange.collapsed)return; const s=document.createElement('span'); s.className='hl'; try{ lastRange.surroundContents(s); }catch(e){ const w=document.createElement('span'); w.className='hl'; w.appendChild(lastRange.cloneContents()); lastRange.deleteContents(); lastRange.insertNode(w); } selbar.style.display='none'; saveHighlights(); };

btnNote.onclick=()=>{ if(currentHlNode||!lastRange||lastRange.collapsed)return; const s=document.createElement('span'); s.className='note'; try{ lastRange.surroundContents(s); }catch(e){ const w=document.createElement('span'); w.className='note'; w.appendChild(lastRange.cloneContents()); lastRange.deleteContents(); lastRange.insertNode(w); } selbar.style.display='none'; saveHighlights(); };

btnUH.onclick=()=>{ if(currentHlNode){ const p=currentHlNode.parentNode; while(currentHlNode.firstChild)p.insertBefore(currentHlNode.firstChild,currentHlNode); p.removeChild(currentHlNode); p.normalize(); currentHlNode=null; selbar.style.display='none'; saveHighlights(); }else if(lastRange){ const sR=lastRange.getBoundingClientRect(); const w=document.createTreeWalker(document.body,NodeFilter.SHOW_ELEMENT); const tr=[]; while(w.nextNode()){ const n=w.currentNode; if(n.classList&&(n.classList.contains('hl')||n.classList.contains('note'))){ const r=n.getBoundingClientRect(); if(!(r.right<sR.left||r.left>sR.right||r.bottom<sR.top||r.top>sR.bottom))tr.push(n); }} tr.forEach(el=>{ const p=el.parentNode; while(el.firstChild)p.insertBefore(el.firstChild,el); p.removeChild(el); p.normalize(); }); selbar.style.display='none'; saveHighlights(); }};

document.querySelectorAll('.flag-btn').forEach(btn => {
  btn.onclick = e => {
    e.stopPropagation();
    btn.classList.toggle('active');
    saveFlags();
  };
});

const answerKey={q27:"NO",q28:"NOT GIVEN",q29:"NOT GIVEN",q30:"YES",q31:"NO",q32:"B",q33:"E",q34:"I",q35:"H",q36:"B",q37:"C",q38:"D",q39:"C",q40:"A"};
let lastResults=[];

function saveAnswers() {
  const data = {};
  Object.keys(answerKey).forEach(q => {
    const radio = document.querySelector(`input[name="${q}"]:checked`);
    const select = document.querySelector(`select[name="${q}"]`);
    if(radio) data[q] = radio.value;
    else if(select) data[q] = select.value;
  });
  localStorage.setItem(`${PAPER_ID}_answers`, JSON.stringify(data));
}

function loadAnswers() {
  const data = JSON.parse(localStorage.getItem(`${PAPER_ID}_answers`) || '{}');
  Object.keys(data).forEach(q => {
    const radio = document.querySelector(`input[name="${q}"][value="${data[q]}"]`);
    const select = document.querySelector(`select[name="${q}"]`);
    if(radio) radio.checked = true;
    else if(select) select.value = data[q];
  });
}

function saveFlags() {
  const flags = [...document.querySelectorAll('.flag-btn.active')].map(b => b.dataset.q);
  localStorage.setItem(`${PAPER_ID}_flags`, JSON.stringify(flags));
}

function loadFlags() {
  const flags = JSON.parse(localStorage.getItem(`${PAPER_ID}_flags`) || '[]');
  flags.forEach(q => document.querySelector(`[data-q="${q}"]`)?.classList.add('active'));
}

function saveHighlights() {
  const highlights = { left: [], right: [] };
  document.querySelectorAll('#left .hl, #left .note').forEach((el, idx) => {
    highlights.left.push({
      type: el.classList.contains('hl') ? 'hl' : 'note',
      text: el.textContent,
      index: idx
    });
  });
  document.querySelectorAll('#right .hl, #right .note').forEach((el, idx) => {
    highlights.right.push({
      type: el.classList.contains('hl') ? 'hl' : 'note',
      text: el.textContent,
      index: idx
    });
  });
  localStorage.setItem(`${PAPER_ID}_highlights`, JSON.stringify(highlights));
}

function loadHighlights() {
  const data = JSON.parse(localStorage.getItem(`${PAPER_ID}_highlights`) || '{"left":[],"right":[]}');
  
  if(data.left && data.left.length > 0) {
    data.left.forEach(item => {
      const walker = document.createTreeWalker(left, NodeFilter.SHOW_TEXT);
      let node;
      while(node = walker.nextNode()) {
        if(node.textContent.includes(item.text)) {
          const span = document.createElement('span');
          span.className = item.type;
          const parent = node.parentNode;
          const text = node.textContent;
          const idx = text.indexOf(item.text);
          if(idx >= 0) {
            const before = text.substring(0, idx);
            const match = text.substring(idx, idx + item.text.length);
            const after = text.substring(idx + item.text.length);
            
            parent.insertBefore(document.createTextNode(before), node);
            span.textContent = match;
            parent.insertBefore(span, node);
            parent.insertBefore(document.createTextNode(after), node);
            parent.removeChild(node);
            break;
          }
        }
      }
    });
  }
  
  if(data.right && data.right.length > 0) {
    data.right.forEach(item => {
      const walker = document.createTreeWalker(right, NodeFilter.SHOW_TEXT);
      let node;
      while(node = walker.nextNode()) {
        if(node.textContent.includes(item.text)) {
          const span = document.createElement('span');
          span.className = item.type;
          const parent = node.parentNode;
          const text = node.textContent;
          const idx = text.indexOf(item.text);
          if(idx >= 0) {
            const before = text.substring(0, idx);
            const match = text.substring(idx, idx + item.text.length);
            const after = text.substring(idx + item.text.length);
            
            parent.insertBefore(document.createTextNode(before), node);
            span.textContent = match;
            parent.insertBefore(span, node);
            parent.insertBefore(document.createTextNode(after), node);
            parent.removeChild(node);
            break;
          }
        }
      }
    });
  }
}

document.querySelectorAll('input[type="radio"]').forEach(radio => {
  radio.addEventListener('change', saveAnswers);
});

document.querySelectorAll('select').forEach(select => {
  select.addEventListener('change', saveAnswers);
});

document.addEventListener('DOMContentLoaded', () => {
  loadAnswers();
  loadFlags();
  loadHighlights();
});

function submitAnswers(){ 
  const res=[]; 
  let cor=0; 
  Object.keys(answerKey).forEach(q=>{ 
    const radio = document.querySelector(`input[name="${q}"]:checked`);
    const select = document.querySelector(`select[name="${q}"]`);
    const uA = radio ? radio.value : (select ? select.value : "");
    const cA=answerKey[q]; 
    const iC=uA===cA; 
    if(iC)cor++; 
    res.push({id:q,userAns:uA,correctAns:cA,isCorrect:iC}); 
  }); 
  lastResults=res; 
  const tot=Object.keys(answerKey).length; 
  const pct=((cor/tot)*100).toFixed(1); 
  document.getElementById('resultContent').innerHTML=`<div class="result-summary"><div class="result-score">${cor} / ${tot}</div><div style="margin-top:8px;font-size:18px;">${pct}%</div></div>${res.map(r=>`<div class="result-item ${r.isCorrect?'correct':'incorrect'}"><div><strong>${r.id}</strong> ${r.isCorrect?'‚úì':'‚úó'}</div><div>‰Ω†ÁöÑÁ≠îÊ°à: ${r.userAns||'(Êú™‰ΩúÁ≠î)'}</div>${!r.isCorrect?`<div>Ê≠£Á°ÆÁ≠îÊ°à: ${r.correctAns}</div>`:''}</div>`).join('')}`; 
  document.getElementById('resultModal').classList.add('active'); 
}

function resetForm(){ document.getElementById('resetModal').classList.add('active'); }

function confirmReset(){ 
  const tp=document.querySelector('input[name="resetType"]:checked').value; 
  document.querySelectorAll('input[type="radio"]').forEach(i=>i.checked=false);
  document.querySelectorAll('select').forEach(s=>s.value="");
  localStorage.removeItem(`${PAPER_ID}_answers`);
  
  if(tp==='all'){ 
    document.querySelectorAll('.hl').forEach(el=>{ const p=el.parentNode; while(el.firstChild)p.insertBefore(el.firstChild,el); p.removeChild(el); p.normalize(); }); 
    document.querySelectorAll('.note').forEach(el=>{ const p=el.parentNode; while(el.firstChild)p.insertBefore(el.firstChild,el); p.removeChild(el); p.normalize(); }); 
    document.querySelectorAll('.flag-btn').forEach(b => b.classList.remove('active'));
    localStorage.removeItem(`${PAPER_ID}_highlights`);
    localStorage.removeItem(`${PAPER_ID}_flags`);
  } 
  closeModal('resetModal'); 
}

function addWrongToBook(){ 
  const wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); 
  const wr=lastResults.filter(r=>!r.isCorrect); 
  wr.forEach(r=>{ 
    const en={paperId:PAPER_ID,title:'The New Zealand writer Margaret Mahy',questionId:r.id,correctAnswer:r.correctAns,myAnswer:r.userAns||'(Êú™‰ΩúÁ≠î)',date:new Date().toISOString().split('T')[0]}; 
    const ix=wb.findIndex(i=>i.paperId===en.paperId&&i.questionId===en.questionId); 
    if(ix>=0)wb[ix]=en; 
    else wb.push(en); 
  }); 
  localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); 
  alert(`Â∑≤Ê∑ªÂä† ${wr.length} ÈÅìÈîôÈ¢ò`); 
  closeModal('resultModal'); 
}

function deleteWrongItem(pId,qId){ 
  if(!confirm('Á°ÆÂÆöÂà†Èô§ËøôÈÅìÈîôÈ¢òÔºü'))return; 
  let wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); 
  wb=wb.filter(i=>!(i.paperId===pId&&i.questionId===qId)); 
  localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); 
  openWrongBook(); 
}

function clearCurrentWrongBook(){ 
  if(!confirm('Á°ÆÂÆöÊ∏ÖÁ©∫Êú¨ÁØáÊâÄÊúâÈîôÈ¢òÔºü'))return; 
  let wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); 
  wb=wb.filter(i=>i.paperId!==PAPER_ID); 
  localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); 
  openWrongBook(); 
}

function openWrongBook(){ 
  const wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); 
  const cu=wb.filter(i=>i.paperId===PAPER_ID); 
  const ct=document.getElementById('wrongBookContent'); 
  if(cu.length===0)ct.innerHTML='<div style="text-align:center;padding:40px;color:#666;">ÊöÇÊó†ÈîôÈ¢ò</div>'; 
  else ct.innerHTML=`<div class="modal-actions"><button class="btn-danger" onclick="clearCurrentWrongBook()" style="width:100%;">üóëÔ∏è Ê∏ÖÁ©∫Êú¨ÁØáÈîôÈ¢ò</button></div>${cu.map(i=>`<div class="wrong-item"><div class="wrong-item-content"><div style="font-weight:600;margin-bottom:8px;">${i.questionId}</div><div style="font-size:13px;color:#666;"><div>‚úì Ê≠£Á°Æ: ${i.correctAnswer}</div><div style="color:#d32f2f;">‚úó ÊàëÁöÑ: ${i.myAnswer}</div></div></div><button class="btn-delete" onclick="deleteWrongItem('${i.paperId}','${i.questionId}')">Âà†Èô§</button></div>`).join('')}`; 
  document.getElementById('wrongBookModal').classList.add('active'); 
}

function closeModal(id){ document.getElementById(id).classList.remove('active'); }
</script>
</body>
</html>