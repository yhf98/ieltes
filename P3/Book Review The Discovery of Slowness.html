<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>P3 ‚Äì Book Review The Discovery of Slowness</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  * { box-sizing: border-box; margin:0; padding:0; }
  html,body { height:100%; }
  body { font-family: Arial, sans-serif; background:#f5f5f5; }
  
  #timer { position:fixed; top:12px; right:12px; background:#fff; border:1px solid #ddd; border-radius:6px; padding:8px 12px; font-size:16px; font-weight:600; color:#0066cc; z-index:1000; }
  
  .shell { display:flex; height:100vh; width:100%; }
  .pane { background:#fff; overflow:auto; padding:24px; }
  #left { flex: 0 0 50%; border-right:1px solid #ddd; }
  #right { flex: 1 1 auto; background:#fafafa; }
  #divider { flex: 0 0 5px; background:#ddd; cursor: ew-resize; }
  #divider:hover { background:#999; }
  
  h2,h3,h4 { margin:0 0 12px; color:#333; }
  h2 { font-size:20px; }
  h3 { font-size:18px; color:#0066cc; }
  h4 { font-size:15px; font-weight:600; margin-top:20px; }
  
  #left p { margin: 0 0 14px; line-height: 1.7; text-align:justify; }
  
  .group { background:#fff; border:1px solid #ddd; border-radius:6px; padding:16px; margin-bottom:16px; }
  .group h4 { margin-top:0; color:#0066cc; }
  .group p { margin:8px 0; font-size:14px; line-height:1.6; }
  
  .headings { background:#f9f9f9; padding:12px; margin:12px 0; border-radius:4px; }
  .headings ol { margin-left:20px; }
  .headings li { margin:4px 0; font-size:13px; }
  
  table { border-collapse: collapse; width:100%; margin:12px 0; }
  th, td { border:1px solid #ddd; padding:6px; text-align:center; font-size:13px; position:relative; }
  th { background:#f5f5f5; font-weight:600; }
  
  .flag-btn { 
    position:absolute; 
    left:2px; 
    top:50%;
    transform:translateY(-50%);
    width:8px;
    height:8px;
    border-radius:50%;
    background:#ddd;
    cursor:pointer;
    z-index:10;
  }
  .flag-btn:hover { background:#999; }
  .flag-btn.active { background:#ff5722; }
  
  tr td:first-child { padding-left:16px; }
  
  .group ol { margin-left:20px; }
  .group ol li { margin:12px 0; font-size:14px; line-height:1.6; position:relative; }
  .group ol li label { display:inline-block; margin-right:8px; }
  
  .bottom-bar { display:flex; gap:10px; margin-top:16px; }
  button { padding:10px 20px; border:1px solid #999; border-radius:6px; background:#fff; cursor:pointer; font-size:14px; }
  button:hover { background:#f0f0f0; }
  .btn-primary { background:#0066cc; color:#fff; border-color:#0066cc; }
  .btn-primary:hover { background:#0052a3; }
  .btn-danger { background:#dc3545; color:#fff; border-color:#dc3545; }
  .btn-danger:hover { background:#c82333; }
  
  .hl { background:#fff59d; cursor:pointer; }
  .hl:hover { background:#ffeb3b; }
  .note { background:#b3d9ff; cursor:pointer; }
  .note:hover { background:#99ccff; }
  
  #selbar { position:fixed; display:none; z-index:2000; background:#fff; border:1px solid #ddd; border-radius:8px; padding:8px; gap:0; box-shadow:0 2px 8px rgba(0,0,0,0.15); flex-direction:column; min-width:120px; }
  #selbar button { background:#fff; color:#666; border:none; padding:3px 0px; cursor:pointer; font-size:14px; text-align:center; border-radius:4px; }
  #selbar button:hover { background:#f5f5f5; color:#333; }
  
  .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:3000; align-items:center; justify-content:center; }
  .modal.active { display:flex; }
  .modal-content { background:#fff; border-radius:8px; padding:24px; max-width:600px; width:90%; max-height:80vh; overflow-y:auto; }
  
  .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
  .modal-header h2 { font-size: 28px; color: #333; margin: 0; }
  .modal-close { font-size: 32px; cursor: pointer; color: #999; line-height: 1; }
  .modal-close:hover { color: #333; }
  
  .result-summary { text-align:center; padding:20px; background:#f0f0f0; margin-bottom:16px; border-radius:6px; }
  .result-score { font-size:36px; font-weight:600; color:#0066cc; }
  .result-item { padding:10px; margin:8px 0; border-left:3px solid #ddd; background:#f9f9f9; font-size:13px; }
  .result-item.correct { border-left-color:#28a745; background:#e8f5e9; }
  .result-item.incorrect { border-left-color:#dc3545; background:#ffebee; }
  
  .wrong-item { background:#fff3e0; padding:16px; margin:8px 0; border-radius:8px; border-left:4px solid #ff9800; display:flex; justify-content:space-between; align-items:start; }
  .wrong-item-content { flex:1; }
  .btn-delete { background:#dc3545; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-size:13px; margin-left:12px; }
  .btn-delete:hover { background:#c82333; }
  .modal-actions { display:flex; gap:10px; margin-bottom:20px; }
</style>
</head>
<body>
<div id="timer">00:00</div>

<div class="shell">
  <section class="pane" id="left">
    
<h2>READING PASSAGE 3</h2>
<p>You should spend about 20 minutes on Questions 27‚Äì40, which are based on Reading Passage 3 below.</p>
<h3>Book Review: The Discovery of Slowness</h3>

<h4>Paragraph A</h4>
<p>The English explorer and writer John Franklin (1786‚Äì1847) joined the Navy at the age of 14, and fought at the battle of Trafalgar. When peace came, he turned his attention to Arctic exploration, and in particular to solving the conundrum of the Northwest Passage, a mythical clear-water route through the ice which would, if it existed, link the Pacific Ocean on America‚Äôs West Coast with the Atlantic on its East. The first expedition Franklin led to the Arctic was an arduous overland journey lasting from 1819 to 1822, in which he and his twenty-strong team covered 8,880 kilometres on foot. Their expedition was a triumph of surveying ‚Äì they managed to chart hundreds of kilometres of previously unknown coastline ‚Äì but food ran out on their journey back to civilisation, and the men were forced to eat their belts and their boots (which they boiled up to make leather soup).</p>

<h4>Paragraph B</h4>
<p>There followed a career as a travel writer and public speaker (‚Äòthe man who ate his boots‚Äô was Franklin‚Äôs tag-line). Then in 1845, Franklin set off back to the Arctic with two ships ‚Äì the Erebus and the Terror ‚Äì and 129 men. Nothing was heard of them for 14 years, although more than 30 expeditions were dispatched in search of them. Eventually it was discovered that Franklin and all his team had perished after their ships were trapped in the ice.</p>

<h4>Paragraph C</h4>
<p>In his personal correspondence and published memoirs, Franklin comes across as a man dedicated to the external duties of war and exploration, who kept introspection and self-analysis to a minimum. His blandness makes him an amenably malleable subject for a novelist, and Sten Nadolny has taken full advantage of this in his book. Most important, Nadolny has endowed John Franklin with a defining trait for which there is no historical evidence: Langsamkeit (‚Äòslowness‚Äô, or ‚Äòcalmness‚Äô).</p>

<h4>Paragraph D</h4>
<p>Slowness influences not only Franklin‚Äôs behaviour, but also his vision, his thought and his speech. The opening scene of The Discovery of Slowness depicts Franklin as a young boy, failing to catch a ball because his reaction time is too slow. Despite the bullying of his peers, Franklin resolves not to fall into step with ‚Äòtheir way of doing things‚Äô. For Nadolny, Franklin‚Äôs fascination with the Arctic stems from his desire to find an environment suited to his peculiar slowness. He describes Franklin as a boy dreaming of the ‚Äòtime without hours and days‚Äô which exists in the far north, a place ‚Äòwhere nobody would find him too slow‚Äô.</p>

<h4>Paragraph E</h4>
<p>Ice is a slow mover. The compressed blue ice inside an Alpine crevasse will have fallen as snow several decades earlier. Polar pack ice takes at least two years to form. The film of crystals which first appears on the surface of the sea thickens into a silkily pliant layer called nilas; this in turn consolidates into young ice, which then deepens during several seasons to become pack. Ice demands a corresponding patience from those who venture onto it. The explorers who have thrived at high latitudes and at high altitudes haven‚Äôt usually been men of great speed. They have tended instead to demonstrate unusual self-possession, a considerable capacity for boredom, and a talent for the uncomplaining endurance of suffering.</p>

<h4>Paragraph F</h4>
<p>These were all qualities which the historical Franklin possessed in abundance, and so Nadolny‚Äôs exaggeration of them isn‚Äôt unreasonable. Even as an adult, Franklin‚Äôs slowness of thought means that he is unable to speak fluently, so he learns by heart ‚Äòentire fleets of words and batteries of responses‚Äô, and speaks a languid, bric-√†-brac language. In the Navy, his method of thinking first and acting later initially provokes mockery from his fellow sailors. But Franklin persists in doing things his way, and gradually earns the respect of those around him. To a commodore who tells him to speed up his report of an engagement, he replies: ‚ÄòWhen I tell something, sir, I use my own rhythm.‚Äô A lieutenant says approvingly of him: ‚ÄòBecause Franklin is so slow, he never loses time.‚Äô</p>

<h4>Paragraph G</h4>
<p>Nadolny also brings his central metaphor of slowness to bear on the novel‚Äôs language. The chapters describing Franklin‚Äôs early years are a medley of separate fragments, rhetorical questions, associative jumps and exclamation marks. In the later sections recounting Franklin‚Äôs first Arctic expedition, Nadolny brilliantly sets the narrative pace to the rhythms of the frozen landscape, and to the ‚Äòslowness which is bred by hunger‚Äô.</p>

<h4>Paragraph H</h4>
<p>Since it was first published in Germany in 1983, The Discovery of Slowness has sold more than a million copies and been translated into 15 languages. It has been adopted as a manual and manifesto by European pressure groups and institutions representing causes as diverse as sustainable development, management science and motoring policy, even becoming involved in the debate about speed limits on German roads. The various groups that have taken the novel up have one thing in common: a dislike of the high-speed culture of Postmodernity. Nadolny‚Äôs Franklin appeals to them because he is immune to ‚Äòthe compulsion to be constantly occupied‚Äô, and to the idea that ‚Äòsomeone was better if he could do the same thing fast‚Äô. It‚Äôs easy to see where the attraction lies for those in management. The novel is crammed with quotations about time-efficiency, punctiliousness and profitability: ‚ÄòWhat did ‚Äútoo late‚Äù mean? They hadn‚Äôt waited for it long enough, that‚Äôs what it meant.‚Äô</p>
  </section>

  <div id="divider" title="Drag to resize"></div>

  <section class="pane" id="right">
    <h3>Questions</h3>

    <div class="group">
      <h4>Questions 27‚Äì31</h4>
      <p>Reading Passage 3 has eight paragraphs, A‚ÄìH.</p>
      <p>Which paragraph contains the following information?</p>
      <p>Write the correct letter, <strong>A‚ÄìH</strong>, in boxes <strong>27‚Äì31</strong> on your answer sheet.</p>

      <ol start="27">
        <li><span class="flag-btn" data-q="q27" style="left:-20px;"></span>a summary of Franklin‚Äôs occupation in the period before his first expedition<br>
          <label><input type="radio" name="q27" value="A"> A</label>
          <label><input type="radio" name="q27" value="B"> B</label>
          <label><input type="radio" name="q27" value="C"> C</label>
          <label><input type="radio" name="q27" value="D"> D</label>
          <label><input type="radio" name="q27" value="E"> E</label>
          <label><input type="radio" name="q27" value="F"> F</label>
          <label><input type="radio" name="q27" value="G"> G</label>
          <label><input type="radio" name="q27" value="H"> H</label>
        </li>
        <li><span class="flag-btn" data-q="q28" style="left:-20px;"></span>a reference to a feature of Franklin‚Äôs character in Nadolny‚Äôs novel that has no definite basis in fact<br>
          <label><input type="radio" name="q28" value="A"> A</label>
          <label><input type="radio" name="q28" value="B"> B</label>
          <label><input type="radio" name="q28" value="C"> C</label>
          <label><input type="radio" name="q28" value="D"> D</label>
          <label><input type="radio" name="q28" value="E"> E</label>
          <label><input type="radio" name="q28" value="F"> F</label>
          <label><input type="radio" name="q28" value="G"> G</label>
          <label><input type="radio" name="q28" value="H"> H</label>
        </li>
        <li><span class="flag-btn" data-q="q29" style="left:-20px;"></span>a connection between the central theme of the novel and an environmental process<br>
          <label><input type="radio" name="q29" value="A"> A</label>
          <label><input type="radio" name="q29" value="B"> B</label>
          <label><input type="radio" name="q29" value="C"> C</label>
          <label><input type="radio" name="q29" value="D"> D</label>
          <label><input type="radio" name="q29" value="E"> E</label>
          <label><input type="radio" name="q29" value="F"> F</label>
          <label><input type="radio" name="q29" value="G"> G</label>
          <label><input type="radio" name="q29" value="H"> H</label>
        </li>
        <li><span class="flag-btn" data-q="q30" style="left:-20px;"></span>a reference to the widespread appeal of Nadolny‚Äôs novel<br>
          <label><input type="radio" name="q30" value="A"> A</label>
          <label><input type="radio" name="q30" value="B"> B</label>
          <label><input type="radio" name="q30" value="C"> C</label>
          <label><input type="radio" name="q30" value="D"> D</label>
          <label><input type="radio" name="q30" value="E"> E</label>
          <label><input type="radio" name="q30" value="F"> F</label>
          <label><input type="radio" name="q30" value="G"> G</label>
          <label><input type="radio" name="q30" value="H"> H</label>
        </li>
        <li><span class="flag-btn" data-q="q31" style="left:-20px;"></span>a summary of events following Franklin‚Äôs return from his first expedition<br>
          <label><input type="radio" name="q31" value="A"> A</label>
          <label><input type="radio" name="q31" value="B"> B</label>
          <label><input type="radio" name="q31" value="C"> C</label>
          <label><input type="radio" name="q31" value="D"> D</label>
          <label><input type="radio" name="q31" value="E"> E</label>
          <label><input type="radio" name="q31" value="F"> F</label>
          <label><input type="radio" name="q31" value="G"> G</label>
          <label><input type="radio" name="q31" value="H"> H</label>
        </li>
      </ol>
    </div>

    <div class="group">
      <h4>Questions 32‚Äì35</h4>
      <p>Complete the summary using the list of words, A‚ÄìL, below.</p>
      <p>Write the correct letter, <strong>A‚ÄìL</strong>, in boxes <strong>32‚Äì35</strong> on your answer sheet.</p>
      <div class="headings">
        <p>John Franklin and the Quality of Slowness</p>
        <p>Little is known from Franklin‚Äôs correspondence and published writings about his 32 ________. The author, Nadolny, suggests that Franklin‚Äôs whole life can be explained by the quality of ‚Äòslowness‚Äô. He begins the book by showing how this affects the young Franklin‚Äôs 33 ________ activities, and makes him become 34 ________. As a child, it is the quality of 35 ________ that attracts Franklin to the Arctic.</p>
        <p>List of Words:</p>
        <ol>
          <li>A a bully</li>
          <li>B discoveries</li>
          <li>C educational</li>
          <li>D family</li>
          <li>E isolation</li>
          <li>F an outsider</li>
          <li>G personality</li>
          <li>H problems</li>
          <li>I remoteness</li>
          <li>J a scholar</li>
          <li>K sporting</li>
          <li>L timelessness</li>
        </ol>
      </div>
      <ol start="32">
        <li><span class="flag-btn" data-q="q32" style="left:-20px;"></span>
          <label><input type="radio" name="q32" value="A"> A</label>
          <label><input type="radio" name="q32" value="B"> B</label>
          <label><input type="radio" name="q32" value="C"> C</label>
          <label><input type="radio" name="q32" value="D"> D</label>
          <label><input type="radio" name="q32" value="E"> E</label>
          <label><input type="radio" name="q32" value="F"> F</label>
          <label><input type="radio" name="q32" value="G"> G</label>
          <label><input type="radio" name="q32" value="H"> H</label>
          <label><input type="radio" name="q32" value="I"> I</label>
          <label><input type="radio" name="q32" value="J"> J</label>
          <label><input type="radio" name="q32" value="K"> K</label>
          <label><input type="radio" name="q32" value="L"> L</label>
        </li>
        <li><span class="flag-btn" data-q="q33" style="left:-20px;"></span>
          <label><input type="radio" name="q33" value="A"> A</label>
          <label><input type="radio" name="q33" value="B"> B</label>
          <label><input type="radio" name="q33" value="C"> C</label>
          <label><input type="radio" name="q33" value="D"> D</label>
          <label><input type="radio" name="q33" value="E"> E</label>
          <label><input type="radio" name="q33" value="F"> F</label>
          <label><input type="radio" name="q33" value="G"> G</label>
          <label><input type="radio" name="q33" value="H"> H</label>
          <label><input type="radio" name="q33" value="I"> I</label>
          <label><input type="radio" name="q33" value="J"> J</label>
          <label><input type="radio" name="q33" value="K"> K</label>
          <label><input type="radio" name="q33" value="L"> L</label>
        </li>
        <li><span class="flag-btn" data-q="q34" style="left:-20px;"></span>
          <label><input type="radio" name="q34" value="A"> A</label>
          <label><input type="radio" name="q34" value="B"> B</label>
          <label><input type="radio" name="q34" value="C"> C</label>
          <label><input type="radio" name="q34" value="D"> D</label>
          <label><input type="radio" name="q34" value="E"> E</label>
          <label><input type="radio" name="q34" value="F"> F</label>
          <label><input type="radio" name="q34" value="G"> G</label>
          <label><input type="radio" name="q34" value="H"> H</label>
          <label><input type="radio" name="q34" value="I"> I</label>
          <label><input type="radio" name="q34" value="J"> J</label>
          <label><input type="radio" name="q34" value="K"> K</label>
          <label><input type="radio" name="q34" value="L"> L</label>
        </li>
        <li><span class="flag-btn" data-q="q35" style="left:-20px;"></span>
          <label><input type="radio" name="q35" value="A"> A</label>
          <label><input type="radio" name="q35" value="B"> B</label>
          <label><input type="radio" name="q35" value="C"> C</label>
          <label><input type="radio" name="q35" value="D"> D</label>
          <label><input type="radio" name="q35" value="E"> E</label>
          <label><input type="radio" name="q35" value="F"> F</label>
          <label><input type="radio" name="q35" value="G"> G</label>
          <label><input type="radio" name="q35" value="H"> H</label>
          <label><input type="radio" name="q35" value="I"> I</label>
          <label><input type="radio" name="q35" value="J"> J</label>
          <label><input type="radio" name="q35" value="K"> K</label>
          <label><input type="radio" name="q35" value="L"> L</label>
        </li>
      </ol>
    </div>

    <div class="group">
      <h4>Questions 36‚Äì40</h4>
      <p>Choose the correct letter, A, B, C or D.</p>
      <p>Write the correct letter in boxes <strong>36‚Äì40</strong> on your answer sheet.</p>
      <ol start="36">
        <li><span class="flag-btn" data-q="q36" style="left:-20px;"></span>In paragraph E, the writer describes different types of ice in order to illustrate<br>
          <label><input type="radio" name="q36" value="A"> A. the extreme conditions that Polar explorers have to face.</label>
          <label><input type="radio" name="q36" value="B"> B. the unusual quality of the beauty of Polar regions.</label>
          <label><input type="radio" name="q36" value="C"> C. the vital importance of preserving the Arctic environment.</label>
          <label><input type="radio" name="q36" value="D"> D. the personal qualities required of an explorer in Arctic conditions.</label>
        </li>
        <li><span class="flag-btn" data-q="q37" style="left:-20px;"></span>What is said about the way Franklin communicates?<br>
          <label><input type="radio" name="q37" value="A"> A. He expresses a very limited range of ideas.</label>
          <label><input type="radio" name="q37" value="B"> B. He is only willing to discuss things he is familiar with.</label>
          <label><input type="radio" name="q37" value="C"> C. He uses words and phrases that he has previously memorised.</label>
          <label><input type="radio" name="q37" value="D"> D. He is only fluent when talking about naval matters.</label>
        </li>
        <li><span class="flag-btn" data-q="q38" style="left:-20px;"></span>How does the attitude of the other sailors change towards Franklin?<br>
          <label><input type="radio" name="q38" value="A"> A. They no longer notice his slowness.</label>
          <label><input type="radio" name="q38" value="B"> B. They start to copy his approach to work.</label>
          <label><input type="radio" name="q38" value="C"> C. They begin to recognise his efforts to overcome his problems.</label>
          <label><input type="radio" name="q38" value="D"> D. They eventually appreciate his good qualities.</label>
        </li>
        <li><span class="flag-btn" data-q="q39" style="left:-20px;"></span>The chapters of The Discovery of Slowness which describe Franklin‚Äôs early years contain<br>
          <label><input type="radio" name="q39" value="A"> A. text from a wide variety of sources.</label>
          <label><input type="radio" name="q39" value="B"> B. short, disconnected pieces of text.</label>
          <label><input type="radio" name="q39" value="C"> C. descriptions of the Arctic landscape.</label>
          <label><input type="radio" name="q39" value="D"> D. information about other explorers like Franklin.</label>
        </li>
        <li><span class="flag-btn" data-q="q40" style="left:-20px;"></span>The Discovery of Slowness has achieved widespread popularity because<br>
          <label><input type="radio" name="q40" value="A"> A. it reflects many people‚Äôs concern about one aspect of modern life.</label>
          <label><input type="radio" name="q40" value="B"> B. it offers achievable solutions to many of the problems of today.</label>
          <label><input type="radio" name="q40" value="C"> C. it tells the story of someone‚Äôs triumph over personal problems.</label>
          <label><input type="radio" name="q40" value="D"> D. it shows how life in the past was less pressured than it is now.</label>
        </li>
      </ol>
    </div>

    <div class="bottom-bar">
      <button class="btn-primary" onclick="submitAnswers()">Êèê‰∫§</button>
      <button onclick="resetForm()">ÈáçÁΩÆ</button>
      <button onclick="openWrongBook()">Êú¨ÁØáÈîôÈ¢ò</button>
    </div>
  </section>
</div>

<div id="selbar">
  <button id="btnNote">Note</button>
  <button id="btnHL">Highlight</button>
  <button id="btnUH" style="display:none;">Clear Highlight</button>
</div>

<div class="modal" id="resultModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ÊàêÁª©</h2>
      <span class="modal-close" onclick="closeModal('resultModal')">√ó</span>
    </div>
    <div id="resultContent"></div>
    <button class="btn-primary" style="width:100%; margin-top:16px;" onclick="addWrongToBook()">Âä†ÂÖ•ÈîôÈ¢òÊú¨</button>
  </div>
</div>

<div class="modal" id="wrongBookModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Êú¨ÁØáÈîôÈ¢ò</h2>
      <span class="modal-close" onclick="closeModal('wrongBookModal')">√ó</span>
    </div>
    <div id="wrongBookContent"></div>
  </div>
</div>

<div class="modal" id="resetModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ÈáçÁΩÆÁªÉ‰π†</h2>
      <span class="modal-close" onclick="closeModal('resetModal')">√ó</span>
    </div>
    <div style="margin:16px 0;">
      <label style="display:block; margin-bottom:10px;">
        <input type="radio" name="resetType" value="answers" checked>
        Âè™Ê∏ÖÁ©∫Á≠îÊ°à
      </label>
      <label style="display:block;">
        <input type="radio" name="resetType" value="all">
        Ê∏ÖÁ©∫Á≠îÊ°àÂíåÊ†áËÆ∞
      </label>
    </div>
    <button class="btn-primary" style="width:100%;" onclick="confirmReset()">Á°ÆÂÆö</button>
  </div>
</div>

<script>
const PAPER_ID='P3_BOOK_REVIEW';

let t=0;
const timerEl=document.getElementById('timer');
setInterval(()=>{ t++; timerEl.textContent=String(Math.floor(t/60)).padStart(2,'0')+':'+String(t%60).padStart(2,'0'); }, 1000);

const divider=document.getElementById('divider'), left=document.getElementById('left'), right=document.getElementById('right');
let dragging=false;
divider.onmousedown=()=>{ dragging=true; document.body.style.cursor='ew-resize'; };
window.onmousemove=(e)=>{ if(!dragging)return; const c=document.querySelector('.shell').getBoundingClientRect(); let x=e.clientX-c.left; x=Math.max(280,Math.min(c.width-280,x)); left.style.flex='0 0 '+x+'px'; right.style.flex='1 1 auto'; };
window.onmouseup=()=>{ dragging=false; document.body.style.cursor=''; };

const selbar=document.getElementById('selbar'), btnHL=document.getElementById('btnHL'), btnUH=document.getElementById('btnUH'), btnNote=document.getElementById('btnNote');
let lastRange=null, currentHlNode=null;

function posSelbar(r){ selbar.style.display='flex'; const t=window.scrollY+r.top-selbar.offsetHeight-8; const l=window.scrollX+r.left+r.width/2-selbar.offsetWidth/2; selbar.style.top=((t>0)?t:(window.scrollY+r.bottom+8))+'px'; selbar.style.left=Math.max(8,l)+'px'; }

function updSel(){ const s=window.getSelection(); if(!s||s.rangeCount===0||s.isCollapsed){ if(!currentHlNode)selbar.style.display='none'; return; } const r=s.getRangeAt(0); lastRange=r.cloneRange(); currentHlNode=null; btnNote.style.display='block'; btnHL.style.display='block'; btnUH.style.display='none'; posSelbar(r.getBoundingClientRect()); }

left.onmouseup=updSel; right.onmouseup=updSel;
document.onselectionchange=()=>{ const s=window.getSelection(); if((!s||s.rangeCount===0||s.isCollapsed)&&!currentHlNode)selbar.style.display='none'; };
document.addEventListener('click',(e)=>{ if(e.target.classList&&(e.target.classList.contains('hl')||e.target.classList.contains('note'))){ currentHlNode=e.target; lastRange=null; btnNote.style.display='none'; btnHL.style.display='none'; btnUH.style.display='block'; posSelbar(e.target.getBoundingClientRect()); const s=window.getSelection(); if(s)s.removeAllRanges(); }}, true);

btnHL.onclick=()=>{ if(currentHlNode||!lastRange||lastRange.collapsed)return; const s=document.createElement('span'); s.className='hl'; try{ lastRange.surroundContents(s); }catch(e){ const w=document.createElement('span'); w.className='hl'; w.appendChild(lastRange.cloneContents()); lastRange.deleteContents(); lastRange.insertNode(w); } selbar.style.display='none'; saveHighlights(); };

btnNote.onclick=()=>{ if(currentHlNode||!lastRange||lastRange.collapsed)return; const s=document.createElement('span'); s.className='note'; try{ lastRange.surroundContents(s); }catch(e){ const w=document.createElement('span'); w.className='note'; w.appendChild(lastRange.cloneContents()); lastRange.deleteContents(); lastRange.insertNode(w); } selbar.style.display='none'; saveHighlights(); };

btnUH.onclick=()=>{ if(currentHlNode){ const p=currentHlNode.parentNode; while(currentHlNode.firstChild)p.insertBefore(currentHlNode.firstChild,currentHlNode); p.removeChild(currentHlNode); p.normalize(); currentHlNode=null; selbar.style.display='none'; saveHighlights(); }else if(lastRange){ const sR=lastRange.getBoundingClientRect(); const w=document.createTreeWalker(document.body,NodeFilter.SHOW_ELEMENT); const tr=[]; while(w.nextNode()){ const n=w.currentNode; if(n.classList&&(n.classList.contains('hl')||n.classList.contains('note'))){ const r=n.getBoundingClientRect(); if(!(r.right<sR.left||r.left>sR.right||r.bottom<sR.top||r.top>sR.bottom))tr.push(n); }} tr.forEach(el=>{ const p=el.parentNode; while(el.firstChild)p.insertBefore(el.firstChild,el); p.removeChild(el); p.normalize(); }); selbar.style.display='none'; saveHighlights(); }};

document.querySelectorAll('.flag-btn').forEach(btn => {
  btn.onclick = e => {
    e.stopPropagation();
    btn.classList.toggle('active');
    saveFlags();
  };
});

const answerKey={
  q27:"A",q28:"C",q29:"E",q30:"H",q31:"B",
  q32:"G",q33:"K",q34:"F",q35:"L",
  q36:"D",q37:"C",q38:"D",q39:"B",q40:"A"
};
let lastResults=[];

function saveAnswers() {
  const data = {};
  Object.keys(answerKey).forEach(q => {
    const ch = document.querySelector(`input[name="${q}"]:checked`);
    if(ch) data[q] = ch.value;
  });
  localStorage.setItem(`${PAPER_ID}_answers`, JSON.stringify(data));
}

function loadAnswers() {
  const data = JSON.parse(localStorage.getItem(`${PAPER_ID}_answers`) || '{}');
  Object.keys(data).forEach(q => {
    const radio = document.querySelector(`input[name="${q}"][value="${data[q]}"]`);
    if(radio) radio.checked = true;
  });
}

function saveFlags() {
  const flags = [...document.querySelectorAll('.flag-btn.active')].map(b => b.dataset.q);
  localStorage.setItem(`${PAPER_ID}_flags`, JSON.stringify(flags));
}

function loadFlags() {
  const flags = JSON.parse(localStorage.getItem(`${PAPER_ID}_flags`) || '[]');
  flags.forEach(q => document.querySelector(`[data-q="${q}"]`)?.classList.add('active'));
}

function saveHighlights() {
  const highlights = { left: [], right: [] };
  document.querySelectorAll('#left .hl, #left .note').forEach((el, idx) => {
    highlights.left.push({
      type: el.classList.contains('hl') ? 'hl' : 'note',
      text: el.textContent,
      index: idx
    });
  });
  document.querySelectorAll('#right .hl, #right .note').forEach((el, idx) => {
    highlights.right.push({
      type: el.classList.contains('hl') ? 'hl' : 'note',
      text: el.textContent,
      index: idx
    });
  });
  localStorage.setItem(`${PAPER_ID}_highlights`, JSON.stringify(highlights));
}

function loadHighlights() {
  const data = JSON.parse(localStorage.getItem(`${PAPER_ID}_highlights`) || '{"left":[],"right":[]}');
  
  // ÊÅ¢Â§çÂ∑¶‰æßÈ´ò‰∫Æ
  if(data.left && data.left.length > 0) {
    data.left.forEach(item => {
      const walker = document.createTreeWalker(left, NodeFilter.SHOW_TEXT);
      let node;
      while(node = walker.nextNode()) {
        if(node.textContent.includes(item.text)) {
          const span = document.createElement('span');
          span.className = item.type;
          const parent = node.parentNode;
          const text = node.textContent;
          const idx = text.indexOf(item.text);
          if(idx >= 0) {
            const before = text.substring(0, idx);
            const match = text.substring(idx, idx + item.text.length);
            const after = text.substring(idx + item.text.length);
            
            parent.insertBefore(document.createTextNode(before), node);
            span.textContent = match;
            parent.insertBefore(span, node);
            parent.insertBefore(document.createTextNode(after), node);
            parent.removeChild(node);
            break;
          }
        }
      }
    });
  }
  
  // ÊÅ¢Â§çÂè≥‰æßÈ´ò‰∫Æ
  if(data.right && data.right.length > 0) {
    data.right.forEach(item => {
      const walker = document.createTreeWalker(right, NodeFilter.SHOW_TEXT);
      let node;
      while(node = walker.nextNode()) {
        if(node.textContent.includes(item.text)) {
          const span = document.createElement('span');
          span.className = item.type;
          const parent = node.parentNode;
          const text = node.textContent;
          const idx = text.indexOf(item.text);
          if(idx >= 0) {
            const before = text.substring(0, idx);
            const match = text.substring(idx, idx + item.text.length);
            const after = text.substring(idx + item.text.length);
            
            parent.insertBefore(document.createTextNode(before), node);
            span.textContent = match;
            parent.insertBefore(span, node);
            parent.insertBefore(document.createTextNode(after), node);
            parent.removeChild(node);
            break;
          }
        }
      }
    });
  }
}

document.querySelectorAll('input[type="radio"]').forEach(radio => {
  radio.addEventListener('change', saveAnswers);
});

document.addEventListener('DOMContentLoaded', () => {
  loadAnswers();
  loadFlags();
  loadHighlights();
});

function submitAnswers(){ 
  const res=[]; 
  let cor=0; 
  Object.keys(answerKey).forEach(q=>{ 
    const ch=document.querySelector('input[name="'+q+'"]:checked'); 
    const uA=ch?ch.value:""; 
    const cA=answerKey[q]; 
    const iC=uA===cA; 
    if(iC)cor++; 
    res.push({id:q,userAns:uA,correctAns:cA,isCorrect:iC}); 
  }); 
  lastResults=res; 
  const tot=Object.keys(answerKey).length; 
  const pct=((cor/tot)*100).toFixed(1); 
  localStorage.setItem(`ielts_score_${PAPER_ID}`, `${cor}/${tot}`);
  document.getElementById('resultContent').innerHTML=`<div class="result-summary"><div class="result-score">${cor} / ${tot}</div><div style="margin-top:8px;font-size:18px;">${pct}%</div></div>${res.map(r=>`<div class="result-item ${r.isCorrect?'correct':'incorrect'}"><div><strong>${r.id}</strong> ${r.isCorrect?'‚úì':'‚úó'}</div><div>‰Ω†ÁöÑÁ≠îÊ°à: ${r.userAns||'(Êú™‰ΩúÁ≠î)'}</div>${!r.isCorrect?`<div>Ê≠£Á°ÆÁ≠îÊ°à: ${r.correctAns}</div>`:''}</div>`).join('')}`; 
  document.getElementById('resultModal').classList.add('active'); 
}

function resetForm(){ document.getElementById('resetModal').classList.add('active'); }

function confirmReset(){ 
  const tp=document.querySelector('input[name="resetType"]:checked').value; 
  document.querySelectorAll('input[type="radio"]').forEach(i=>i.checked=false); 
  localStorage.removeItem(`${PAPER_ID}_answers`);
  
  if(tp==='all'){ 
    document.querySelectorAll('.hl').forEach(el=>{ const p=el.parentNode; while(el.firstChild)p.insertBefore(el.firstChild,el); p.removeChild(el); p.normalize(); }); 
    document.querySelectorAll('.note').forEach(el=>{ const p=el.parentNode; while(el.firstChild)p.insertBefore(el.firstChild,el); p.removeChild(el); p.normalize(); }); 
    document.querySelectorAll('.flag-btn').forEach(b => b.classList.remove('active'));
    localStorage.removeItem(`${PAPER_ID}_highlights`);
    localStorage.removeItem(`${PAPER_ID}_flags`);
  } 
  closeModal('resetModal'); 
}

function addWrongToBook(){ 
  const wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); 
  const wr=lastResults.filter(r=>!r.isCorrect); 
  wr.forEach(r=>{ 
    const en={
      paperId:PAPER_ID,
      title:'Book Review The Discovery of Slowness',
      questionId:r.id,
      correctAnswer:r.correctAns,
      myAnswer:r.userAns||'(Êú™‰ΩúÁ≠î)',
      date:new Date().toISOString().split('T')[0]
    }; 
    const ix=wb.findIndex(i=>i.paperId===en.paperId&&i.questionId===en.questionId); 
    if(ix>=0)wb[ix]=en; 
    else wb.push(en); 
  }); 
  localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); 
  alert(`Â∑≤Ê∑ªÂä† ${wr.length} ÈÅìÈîôÈ¢ò`); 
  closeModal('resultModal'); 
}

function deleteWrongItem(pId,qId){ 
  if(!confirm('Á°ÆÂÆöÂà†Èô§ËøôÈÅìÈîôÈ¢òÔºü'))return; 
  let wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); 
  wb=wb.filter(i=>!(i.paperId===pId&&i.questionId===qId)); 
  localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); 
  openWrongBook(); 
}

function clearCurrentWrongBook(){ 
  if(!confirm('Á°ÆÂÆöÊ∏ÖÁ©∫Êú¨ÁØáÊâÄÊúâÈîôÈ¢òÔºü'))return; 
  let wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); 
  wb=wb.filter(i=>i.paperId!==PAPER_ID); 
  localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); 
  openWrongBook(); 
}

function openWrongBook(){ 
  const wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); 
  const cu=wb.filter(i=>i.paperId===PAPER_ID); 
  const ct=document.getElementById('wrongBookContent'); 
  if(cu.length===0)ct.innerHTML='<div style="text-align:center;padding:40px;color:#666;">ÊöÇÊó†ÈîôÈ¢ò</div>'; 
  else ct.innerHTML=`<div class="modal-actions"><button class="btn-danger" onclick="clearCurrentWrongBook()">üóëÔ∏è Ê∏ÖÁ©∫Êú¨ÁØáÈîôÈ¢ò</button></div>${cu.map(i=>`<div class="wrong-item"><div class="wrong-item-content"><div style="font-weight:600;margin-bottom:8px;">${i.questionId}</div><div style="font-size:13px;color:#666;"><div>‚úì Ê≠£Á°Æ: ${i.correctAnswer}</div><div style="color:#d32f2f;">‚úó ÊàëÁöÑ: ${i.myAnswer}</div></div></div><button class="btn-delete" onclick="deleteWrongItem('${i.paperId}','${i.questionId}')">Âà†Èô§</button></div>`).join('')}`; 
  document.getElementById('wrongBookModal').classList.add('active'); 
}

function closeModal(id){ document.getElementById(id).classList.remove('active'); }
</script>
</body>
</html>