<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>P3 ‚Äì Research into Teaching Styles</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  * { box-sizing: border-box; margin:0; padding:0; }
  html,body { height:100%; }
  body { font-family: Arial, sans-serif; background:#f5f5f5; }
  
  #timer { position:fixed; top:12px; right:12px; background:#fff; border:1px solid #ddd; border-radius:6px; padding:8px 12px; font-size:16px; font-weight:600; color:#0066cc; z-index:1000; }
  
  .shell { display:flex; height:100vh; width:100%; }
  .pane { background:#fff; overflow:auto; padding:24px; }
  #left { flex: 0 0 50%; border-right:1px solid #ddd; }
  #right { flex: 1 1 auto; background:#fafafa; }
  #divider { flex: 0 0 5px; background:#ddd; cursor: ew-resize; }
  #divider:hover { background:#999; }
  
  h2,h3,h4 { margin:0 0 12px; color:#333; }
  h2 { font-size:20px; }
  h3 { font-size:18px; color:#0066cc; }
  h4 { font-size:15px; font-weight:600; margin-top:20px; }
  
  #left p { margin: 0 0 14px; line-height: 1.7; text-align:justify; }
  .paragraph-label { font-weight:bold; color:#0066cc; margin-right:8px; float:left; }
  
  .group { background:#fff; border:1px solid #ddd; border-radius:6px; padding:16px; margin-bottom:16px; }
  .group h4 { margin-top:0; color:#0066cc; }
  .group p { margin:8px 0; font-size:14px; line-height:1.6; }
  
  .flag-btn { 
    position:absolute; 
    left:2px; 
    top:50%;
    transform:translateY(-50%);
    width:8px;
    height:8px;
    border-radius:50%;
    background:#ddd;
    cursor:pointer;
    z-index:10;
  }
  .flag-btn:hover { background:#999; }
  .flag-btn.active { background:#ff5722; }
  
  .group ol { margin-left:20px; }
  .group ol li { margin:12px 0; font-size:14px; line-height:1.6; position:relative; }
  .group ol li label { display:inline-block; margin-right:8px; cursor: pointer; }
  
  .summary-box { border:1px solid #333; padding:15px; margin:15px 0; font-size:14px; line-height:1.8; }
  .options-box { border:1px solid #ddd; background:#f9f9f9; padding:10px; margin-top:10px; display:flex; flex-wrap:wrap; gap:12px; font-size:13px; }
  .option-item { flex: 0 0 45%; }

  .list-box { border:1px solid #333; padding:15px; margin:15px 0; display:inline-block; min-width:300px; }
  .list-item { margin:4px 0; font-size:14px; }
  
  select { padding:2px 4px; border:1px solid #ccc; border-radius:4px; margin:0 4px; font-weight:bold; }
  
  .bottom-bar { display:flex; gap:10px; margin-top:16px; }
  button { padding:10px 20px; border:1px solid #999; border-radius:6px; background:#fff; cursor:pointer; font-size:14px; }
  button:hover { background:#f0f0f0; }
  .btn-primary { background:#0066cc; color:#fff; border-color:#0066cc; }
  .btn-primary:hover { background:#0052a3; }
  .btn-danger { background:#dc3545; color:#fff; border-color:#dc3545; }
  .btn-danger:hover { background:#c82333; }
  
  .hl { background:#fff59d; cursor:pointer; }
  .hl:hover { background:#ffeb3b; }
  .note { background:#b3d9ff; cursor:pointer; }
  .note:hover { background:#99ccff; }
  
  #selbar { position:fixed; display:none; z-index:2000; background:#fff; border:1px solid #ddd; border-radius:8px; padding:8px; gap:0; box-shadow:0 2px 8px rgba(0,0,0,0.15); flex-direction:column; min-width:120px; }
  #selbar button { background:#fff; color:#666; border:none; padding:3px 0px; cursor:pointer; font-size:14px; text-align:center; border-radius:4px; }
  #selbar button:hover { background:#f5f5f5; color:#333; }
  
  .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:3000; align-items:center; justify-content:center; }
  .modal.active { display:flex; }
  .modal-content { background:#fff; border-radius:8px; padding:24px; max-width:600px; width:90%; max-height:80vh; overflow-y:auto; }
  
  .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
  .modal-header h2 { font-size: 28px; color: #333; margin: 0; }
  .modal-close { font-size: 32px; cursor: pointer; color: #999; line-height: 1; }
  .modal-close:hover { color: #333; }
  
  .result-summary { text-align:center; padding:20px; background:#f0f0f0; margin-bottom:16px; border-radius:6px; }
  .result-score { font-size:36px; font-weight:600; color:#0066cc; }
  .result-item { padding:10px; margin:8px 0; border-left:3px solid #ddd; background:#f9f9f9; font-size:13px; }
  .result-item.correct { border-left-color:#28a745; background:#e8f5e9; }
  .result-item.incorrect { border-left-color:#dc3545; background:#ffebee; }
  
  .wrong-item { background:#fff3e0; padding:16px; margin:8px 0; border-radius:8px; border-left:4px solid #ff9800; display:flex; justify-content:space-between; align-items:start; }
  .wrong-item-content { flex:1; }
  .btn-delete { background:#dc3545; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-size:13px; margin-left:12px; }
  .btn-delete:hover { background:#c82333; }
  .modal-actions { display:flex; gap:10px; margin-bottom:20px; }
</style>
</head>
<body>
<div id="timer">00:00</div>

<div class="shell">
  <section class="pane" id="left">
    
<h2>READING PASSAGE 3</h2>
<p>You should spend about 20 minutes on Questions 27‚Äì40, which are based on Reading Passage 3 below.</p>
<h3>Research into the effects of different teaching styles</h3>

<p><span class="paragraph-label">A</span> Prior to 1960, most inquiries into pupils‚Äô learning skills explored the relationship between factors such as children‚Äôs social background, personality or measured intelligence and their achievement in various school subjects. Studies of teachers were largely a quest for criteria of effectiveness, and numerous investigations sought links between personality or attitude and ‚Äòsuccess‚Äô at teaching. By 1950, Domas and Tiedeman were able to survey 672 such studies of teacher effectiveness. Yet there was widespread disappointment with such research, partly because so little of value seemed to emerge. First of all, there was little agreement about what constituted ‚Äògood‚Äô teaching or who the good teachers were. Secondly, there were numerous conflicting and contradictory findings. No sooner had one investigator found a relationship which appeared to be significant, than another discovered the opposite effect.</p>

<p><span class="paragraph-label">B</span> For example, in 1945, two American researchers, Rostker and Rolfe, both using standardized testing techniques and broad samples of teachers, reached exactly opposite conclusions. Rostker concluded that the intelligence of the teacher is the most important single factor conditioning teaching ability, and that there is no significant relationship between personality and teaching ability. Rolfe, however, found no correlation between intelligence and teaching efficiency: he claimed that the teacher‚Äôs personality was what produced good teaching. Another American writer, Barr (1961), summarized a massive amount of American research and underlined the chaos in the research literature on effectiveness: ‚ÄúSome teachers were preferred by administrators, some were liked by the pupils, and some taught in classes where there were substantial pupil gains, and generally speaking these were not the same teachers.‚Äù</p>

<p><span class="paragraph-label">C</span> One of the earliest pieces of research dates from 1912, when Stevens made 100 random observations of lessons in a variety of subject areas, in order to analyze the number and nature of questions being asked by teachers. Stevens‚Äôs overall total was 64% teacher talk and 36% pupil talk, figures which are remarkably similar to a number of findings half a century later.</p>

<p><span class="paragraph-label">D</span> For many years in the first half of the 20th century, so-called ‚Äòformal‚Äô teaching was the norm. Teachers taught their classes as a whole group, gave out information, asked questions which predominantly required factual recall, and frequently set a common written task for the children to complete in a prescribed period of time. It was hardly surprising, therefore, that one focus of classroom interaction research in the decades following Stevens‚Äôs inquiry was on the phenomenon of ‚Äòattentiveness‚Äô. A number of studies in the 1920s and 1930s, by Morrison and others, sought relationships between the degree of attention being paid by children and the amount they subsequently appeared to have learnt. Such research was usually based on observing teachers at work, a technique which was also employed extensively by United States administrators in the 1920s and 1930s, in order to assess teachers‚Äô competence and allocate merit payments to so-called ‚Äòsuperior‚Äô teachers.</p>

<p><span class="paragraph-label">E</span> As the 1930s came to an end, it was partly the emergence of totalitarian regimes in Europe which led to a shift in interest in the United States away from attentiveness, with its emphasis on the authority of the teacher, and towards a scrutiny of authoritarianism itself. A number of people began to feel that if dictatorship were to be avoided, children must learn in school how to handle democracy. Several investigators examined the processes taking place within small discussion groups, and tried to establish superiority for discussion groups over lecture classes, but with conflicting results. The movement towards what was becoming known as child-centred education was gathering momentum, and as interest in child development increased, investigators began to discover the usefulness of direct observation and the categorization of child behavior.</p>

<p><span class="paragraph-label">F</span> This was when systematic observation of teacher-pupil interaction began in earnest. Anderson (1939) studied what he called ‚Äòdomination‚Äô and ‚Äòintegration‚Äô amongst kindergarten children. Dominative acts by children included blaming and snatching toys, and such acts by teachers included restricting children‚Äôs activities; while children‚Äôs integrative acts included sharing facilities and playing harmoniously, and those of teachers included expanding opportunities for self-direction and co-operation. Anderson then attempted to measure what is now commonly called ‚Äòclassroom climate‚Äô.</p>

<p><span class="paragraph-label">G</span> Lewin, Lippitt and White (1939 and 1943) studied the effects of different teaching styles. They arranged for three groups of five boys each to be taught in very different ways: these were labelled ‚Äòauthoritarian‚Äô, ‚Äòdemocratic‚Äô and ‚Äòlaissez-faire‚Äô. The first two of these were similar to Anderson‚Äôs concept of dominative and integrative teachers.</p>

<p><span class="paragraph-label">H</span> Beginning with Withall‚Äôs work in 1949, there was much greater interest in interaction within the classroom. Withall used the term ‚Äòsocial-emotional climate‚Äô to describe the emotional tone created as a result of face-to-face interaction in groups, and, like many who followed him, concentrated his analysis of this climate on the study of teachers‚Äô verbal behavior. Withall also made efforts towards increasing the reliability of analyses, and this important pioneering work in the development of classroom observation methodology was followed by many others during the 1950s.</p>

<p><span class="paragraph-label">I</span> Partly because of the disappointing results of the teacher-effectiveness research, and partly because of the general neglect in earlier work of the variables of actual classroom behavior, the decade 1960‚Äì70 produced a large number of studies of classroom processes, based on observation of teachers at work.</p>
  </section>

  <div id="divider" title="Drag to resize"></div>

  <section class="pane" id="right">
    <h3>Questions</h3>

    <div class="group">
      <h4>Questions 27‚Äì31</h4>
      <p>Complete the summary using the list of phrases, <strong>A‚ÄìJ</strong>, below.</p>
      <p>Write the correct letter, <strong>A‚ÄìJ</strong>, in boxes 27‚Äì31 on your answer sheet.</p>

      <div class="summary-box">
        <h4 style="text-align:center;">Research into classroom interaction: 1920‚Äì1970</h4>
        <p><strong>1920‚Äì1939</strong><br>
        Research largely investigated the relationship between children‚Äôs attentiveness and their <span class="flag-btn" data-q="q27" style="left:-20px;"></span><strong>27</strong> <select name="q27"><option value=""></option><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option><option value="E">E</option><option value="F">F</option><option value="G">G</option><option value="H">H</option><option value="I">I</option><option value="J">J</option></select>. In addition, attentiveness was used to measure the <span class="flag-btn" data-q="q28" style="left:-20px;"></span><strong>28</strong> <select name="q28"><option value=""></option><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option><option value="E">E</option><option value="F">F</option><option value="G">G</option><option value="H">H</option><option value="I">I</option><option value="J">J</option></select> of the teachers.</p>
        
        <p><strong>1939‚Äì49</strong><br>
        Research was influenced by a growing distrust of <span class="flag-btn" data-q="q29" style="left:-20px;"></span><strong>29</strong> <select name="q29"><option value=""></option><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option><option value="E">E</option><option value="F">F</option><option value="G">G</option><option value="H">H</option><option value="I">I</option><option value="J">J</option></select>. The period saw the beginnings of systematic analysis of the <span class="flag-btn" data-q="q30" style="left:-20px;"></span><strong>30</strong> <select name="q30"><option value=""></option><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option><option value="E">E</option><option value="F">F</option><option value="G">G</option><option value="H">H</option><option value="I">I</option><option value="J">J</option></select> which occur in lecture classes and in small group discussions.</p>
        
        <p><strong>1949‚Äì60</strong><br>
        Classroom transactions were analysed in more detail, often with a focus on the <span class="flag-btn" data-q="q31" style="left:-20px;"></span><strong>31</strong> <select name="q31"><option value=""></option><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option><option value="E">E</option><option value="F">F</option><option value="G">G</option><option value="H">H</option><option value="I">I</option><option value="J">J</option></select> of teachers. Researchers aimed to improve the <span class="flag-btn" data-q="q32" style="left:-20px;"></span><strong>32</strong> <select name="q32"><option value=""></option><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option><option value="E">E</option><option value="F">F</option><option value="G">G</option><option value="H">H</option><option value="I">I</option><option value="J">J</option></select> of their methods.</p>
        
        <p><strong>1960‚Äì70</strong><br>
        The number of studies based on live <span class="flag-btn" data-q="q33" style="left:-20px;"></span><strong>33</strong> <select name="q33"><option value=""></option><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option><option value="E">E</option><option value="F">F</option><option value="G">G</option><option value="H">H</option><option value="I">I</option><option value="J">J</option></select> greatly increased.</p>
      </div>

      <div class="options-box">
        <div class="option-item"><strong>A</strong> authoritarianism</div>
        <div class="option-item"><strong>B</strong> competence</div>
        <div class="option-item"><strong>C</strong> emergence</div>
        <div class="option-item"><strong>D</strong> learning</div>
        <div class="option-item"><strong>E</strong> observation</div>
        <div class="option-item"><strong>F</strong> personality</div>
        <div class="option-item"><strong>G</strong> processes</div>
        <div class="option-item"><strong>H</strong> reliability</div>
        <div class="option-item"><strong>I</strong> training</div>
        <div class="option-item"><strong>J</strong> verbal behavior</div>
      </div>
    </div>

    <div class="group">
      <h4>Questions 34‚Äì37</h4>
      <p>Look at the following descriptions (Questions 34‚Äì37) and the list of researchers below.</p>
      <p>Match each description with the correct researcher(s), <strong>A‚ÄìG</strong>.</p>
      <p>Write the correct letter, <strong>A‚ÄìG</strong>, in boxes 34‚Äì37 on your answer sheet.</p>

      <div class="list-box">
        <h4>List of researchers</h4>
        <div class="list-item"><strong>A</strong> Domas and Tiedeman</div>
        <div class="list-item"><strong>B</strong> Rostker</div>
        <div class="list-item"><strong>C</strong> Rolfe</div>
        <div class="list-item"><strong>D</strong> Barr</div>
        <div class="list-item"><strong>E</strong> Stevens</div>
        <div class="list-item"><strong>F</strong> Morrison</div>
        <div class="list-item"><strong>G</strong> Lewin, Lippitt and White</div>
      </div>

      <ol start="34">
        <li><span class="flag-btn" data-q="q34" style="left:-20px;"></span>claimed that the most important contribution to success in teaching is made by intelligence
          <select name="q34"><option value=""></option><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option><option value="E">E</option><option value="F">F</option><option value="G">G</option></select>
        </li>
        <li><span class="flag-btn" data-q="q35" style="left:-20px;"></span>set up an experiment to discover how pupils responded to various types of teaching
          <select name="q35"><option value=""></option><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option><option value="E">E</option><option value="F">F</option><option value="G">G</option></select>
        </li>
        <li><span class="flag-btn" data-q="q36" style="left:-20px;"></span>focused on the questions which teachers asked in the classroom
          <select name="q36"><option value=""></option><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option><option value="E">E</option><option value="F">F</option><option value="G">G</option></select>
        </li>
        <li><span class="flag-btn" data-q="q37" style="left:-20px;"></span>discovered a connection between success in teaching and the personality of the teacher
          <select name="q37"><option value=""></option><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option><option value="E">E</option><option value="F">F</option><option value="G">G</option></select>
        </li>
      </ol>
    </div>

    <div class="group">
      <h4>Questions 38‚Äì40</h4>
      <p>Reading Passage 3 has nine paragraphs, <strong>A‚ÄìI</strong>.</p>
      <p>Which paragraph contains the following information?</p>
      <p>Write the correct letter, <strong>A‚ÄìI</strong>, in boxes 38‚Äì40 on your answer sheet.</p>

      <ol start="38">
        <li><span class="flag-btn" data-q="q38" style="left:-20px;"></span>the influence of political events on research
          <select name="q38"><option value=""></option><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option><option value="E">E</option><option value="F">F</option><option value="G">G</option><option value="H">H</option><option value="I">I</option></select>
        </li>
        <li><span class="flag-btn" data-q="q39" style="left:-20px;"></span>an example of how children‚Äôs behavior was categorized for research purposes
          <select name="q39"><option value=""></option><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option><option value="E">E</option><option value="F">F</option><option value="G">G</option><option value="H">H</option><option value="I">I</option></select>
        </li>
        <li><span class="flag-btn" data-q="q40" style="left:-20px;"></span>a reason for research into children‚Äôs attention
          <select name="q40"><option value=""></option><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option><option value="E">E</option><option value="F">F</option><option value="G">G</option><option value="H">H</option><option value="I">I</option></select>
        </li>
      </ol>
    </div>

    <div class="bottom-bar">
      <button class="btn-primary" onclick="submitAnswers()">Êèê‰∫§</button>
      <button onclick="resetForm()">ÈáçÁΩÆ</button>
      <button onclick="openWrongBook()">Êú¨ÁØáÈîôÈ¢ò</button>
    </div>
  </section>
</div>

<div id="selbar">
  <button id="btnNote">Note</button>
  <button id="btnHL">Highlight</button>
  <button id="btnUH" style="display:none;">Clear Highlight</button>
</div>

<div class="modal" id="resultModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ÊàêÁª©</h2>
      <span class="modal-close" onclick="closeModal('resultModal')">√ó</span>
    </div>
    <div id="resultContent"></div>
    <button class="btn-primary" style="width:100%; margin-top:16px;" onclick="addWrongToBook()">Âä†ÂÖ•ÈîôÈ¢òÊú¨</button>
  </div>
</div>

<div class="modal" id="wrongBookModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Êú¨ÁØáÈîôÈ¢ò</h2>
      <span class="modal-close" onclick="closeModal('wrongBookModal')">√ó</span>
    </div>
    <div id="wrongBookContent"></div>
  </div>
</div>

<div class="modal" id="resetModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ÈáçÁΩÆÁªÉ‰π†</h2>
      <span class="modal-close" onclick="closeModal('resetModal')">√ó</span>
    </div>
    <div style="margin:16px 0;">
      <label style="display:block; margin-bottom:10px;">
        <input type="radio" name="resetType" value="answers" checked>
        Âè™Ê∏ÖÁ©∫Á≠îÊ°à
      </label>
      <label style="display:block;">
        <input type="radio" name="resetType" value="all">
        Ê∏ÖÁ©∫Á≠îÊ°àÂíåÊ†áËÆ∞
      </label>
    </div>
    <button class="btn-primary" style="width:100%;" onclick="confirmReset()">Á°ÆÂÆö</button>
  </div>
</div>

<script>
const PAPER_ID='P3_TEACHING_STYLES';

let t=0;
const timerEl=document.getElementById('timer');
setInterval(()=>{ t++; timerEl.textContent=String(Math.floor(t/60)).padStart(2,'0')+':'+String(t%60).padStart(2,'0'); }, 1000);

const divider=document.getElementById('divider'), left=document.getElementById('left'), right=document.getElementById('right');
let dragging=false;
divider.onmousedown=()=>{ dragging=true; document.body.style.cursor='ew-resize'; };
window.onmousemove=(e)=>{ if(!dragging)return; const c=document.querySelector('.shell').getBoundingClientRect(); let x=e.clientX-c.left; x=Math.max(280,Math.min(c.width-280,x)); left.style.flex='0 0 '+x+'px'; right.style.flex='1 1 auto'; };
window.onmouseup=()=>{ dragging=false; document.body.style.cursor=''; };

const selbar=document.getElementById('selbar'), btnHL=document.getElementById('btnHL'), btnUH=document.getElementById('btnUH'), btnNote=document.getElementById('btnNote');
let lastRange=null, currentHlNode=null;

function posSelbar(r){ selbar.style.display='flex'; const t=window.scrollY+r.top-selbar.offsetHeight-8; const l=window.scrollX+r.left+r.width/2-selbar.offsetWidth/2; selbar.style.top=((t>0)?t:(window.scrollY+r.bottom+8))+'px'; selbar.style.left=Math.max(8,l)+'px'; }

function updSel(){ const s=window.getSelection(); if(!s||s.rangeCount===0||s.isCollapsed){ if(!currentHlNode)selbar.style.display='none'; return; } const r=s.getRangeAt(0); lastRange=r.cloneRange(); currentHlNode=null; btnNote.style.display='block'; btnHL.style.display='block'; btnUH.style.display='none'; posSelbar(r.getBoundingClientRect()); }

left.onmouseup=updSel; right.onmouseup=updSel;
document.onselectionchange=()=>{ const s=window.getSelection(); if((!s||s.rangeCount===0||s.isCollapsed)&&!currentHlNode)selbar.style.display='none'; };
document.addEventListener('click',(e)=>{ if(e.target.classList&&(e.target.classList.contains('hl')||e.target.classList.contains('note'))){ currentHlNode=e.target; lastRange=null; btnNote.style.display='none'; btnHL.style.display='none'; btnUH.style.display='block'; posSelbar(e.target.getBoundingClientRect()); const s=window.getSelection(); if(s)s.removeAllRanges(); }}, true);

btnHL.onclick=()=>{ if(currentHlNode||!lastRange||lastRange.collapsed)return; const s=document.createElement('span'); s.className='hl'; try{ lastRange.surroundContents(s); }catch(e){ const w=document.createElement('span'); w.className='hl'; w.appendChild(lastRange.cloneContents()); lastRange.deleteContents(); lastRange.insertNode(w); } selbar.style.display='none'; saveHighlights(); };

btnNote.onclick=()=>{ if(currentHlNode||!lastRange||lastRange.collapsed)return; const s=document.createElement('span'); s.className='note'; try{ lastRange.surroundContents(s); }catch(e){ const w=document.createElement('span'); w.className='note'; w.appendChild(lastRange.cloneContents()); lastRange.deleteContents(); lastRange.insertNode(w); } selbar.style.display='none'; saveHighlights(); };

btnUH.onclick=()=>{ if(currentHlNode){ const p=currentHlNode.parentNode; while(currentHlNode.firstChild)p.insertBefore(currentHlNode.firstChild,currentHlNode); p.removeChild(currentHlNode); p.normalize(); currentHlNode=null; selbar.style.display='none'; saveHighlights(); }else if(lastRange){ const sR=lastRange.getBoundingClientRect(); const w=document.createTreeWalker(document.body,NodeFilter.SHOW_ELEMENT); const tr=[]; while(w.nextNode()){ const n=w.currentNode; if(n.classList&&(n.classList.contains('hl')||n.classList.contains('note'))){ const r=n.getBoundingClientRect(); if(!(r.right<sR.left||r.left>sR.right||r.bottom<sR.top||r.top>sR.bottom))tr.push(n); }} tr.forEach(el=>{ const p=el.parentNode; while(el.firstChild)p.insertBefore(el.firstChild,el); p.removeChild(el); p.normalize(); }); selbar.style.display='none'; saveHighlights(); }};

document.querySelectorAll('.flag-btn').forEach(btn => {
  btn.onclick = e => {
    e.stopPropagation();
    btn.classList.toggle('active');
    saveFlags();
  };
});

const answerKey = {
  q27: "D", q28: "B", q29: "A", q30: "G", q31: "J", q32: "H", q33: "E",
  q34: "B", q35: "G", q36: "E", q37: "C",
  q38: "E", q39: "F", q40: "D"
};
let lastResults=[];

function saveAnswers() {
  const data = {};
  document.querySelectorAll('select').forEach(s => { if(s.value) data[s.name] = s.value; });
  localStorage.setItem(`${PAPER_ID}_answers`, JSON.stringify(data));
}

function loadAnswers() {
  const data = JSON.parse(localStorage.getItem(`${PAPER_ID}_answers`) || '{}');
  Object.keys(data).forEach(q => {
    const select = document.querySelector(`select[name="${q}"]`);
    if(select) select.value = data[q];
  });
}

function saveFlags() {
  const flags = [...document.querySelectorAll('.flag-btn.active')].map(b => b.dataset.q);
  localStorage.setItem(`${PAPER_ID}_flags`, JSON.stringify(flags));
}

function loadFlags() {
  const flags = JSON.parse(localStorage.getItem(`${PAPER_ID}_flags`) || '[]');
  flags.forEach(q => document.querySelector(`[data-q="${q}"]`)?.classList.add('active'));
}

function saveHighlights() {
  const highlights = { left: [], right: [] };
  document.querySelectorAll('#left .hl, #left .note').forEach((el, idx) => {
    highlights.left.push({ type: el.classList.contains('hl') ? 'hl' : 'note', text: el.textContent, index: idx });
  });
  document.querySelectorAll('#right .hl, #right .note').forEach((el, idx) => {
    highlights.right.push({ type: el.classList.contains('hl') ? 'hl' : 'note', text: el.textContent, index: idx });
  });
  localStorage.setItem(`${PAPER_ID}_highlights`, JSON.stringify(highlights));
}

function loadHighlights() {
  const data = JSON.parse(localStorage.getItem(`${PAPER_ID}_highlights`) || '{"left":[],"right":[]}');
  const restore = (pane, items) => {
    if(items && items.length > 0) {
      items.forEach(item => {
        const walker = document.createTreeWalker(pane, NodeFilter.SHOW_TEXT);
        let node;
        while(node = walker.nextNode()) {
          if(node.textContent.includes(item.text)) {
            const span = document.createElement('span');
            span.className = item.type;
            const parent = node.parentNode;
            const text = node.textContent;
            const idx = text.indexOf(item.text);
            if(idx >= 0) {
              const before = text.substring(0, idx);
              const match = text.substring(idx, idx + item.text.length);
              const after = text.substring(idx + item.text.length);
              parent.insertBefore(document.createTextNode(before), node);
              span.textContent = match;
              parent.insertBefore(span, node);
              parent.insertBefore(document.createTextNode(after), node);
              parent.removeChild(node);
              break;
            }
          }
        }
      });
    }
  };
  restore(left, data.left);
  restore(right, data.right);
}

document.querySelectorAll('select').forEach(el => {
  el.addEventListener('change', saveAnswers);
});

document.addEventListener('DOMContentLoaded', () => {
  loadAnswers();
  loadFlags();
  loadHighlights();
});

function submitAnswers(){ 
  const res=[]; let cor=0; 
  Object.keys(answerKey).forEach(q=>{ 
    const sel = document.querySelector(`select[name="${q}"]`);
    const uA = sel ? sel.value : "";
    const cA = answerKey[q];
    const iC = (uA === cA);
    if(iC) cor++; 
    res.push({id:q,userAns:uA,correctAns:cA,isCorrect:iC}); 
  }); 
  lastResults=res; 
  const tot=Object.keys(answerKey).length; 
  const pct=((cor/tot)*100).toFixed(1); 
  localStorage.setItem(`ielts_score_${PAPER_ID}`, `${cor}/${tot}`);
  document.getElementById('resultContent').innerHTML=`<div class="result-summary"><div class="result-score">${cor} / ${tot}</div><div style="margin-top:8px;font-size:18px;">${pct}%</div></div>${res.map(r=>`<div class="result-item ${r.isCorrect?'correct':'incorrect'}"><div><strong>${r.id}</strong> ${r.isCorrect?'‚úì':'‚úó'}</div><div>‰Ω†ÁöÑÁ≠îÊ°à: ${r.userAns||'(Êú™‰ΩúÁ≠î)'}</div>${!r.isCorrect?`<div>Ê≠£Á°ÆÁ≠îÊ°à: ${r.correctAns}</div>`:''}</div>`).join('')}`; 
  document.getElementById('resultModal').classList.add('active'); 
}

function resetForm(){ document.getElementById('resetModal').classList.add('active'); }

function confirmReset(){ 
  const tp=document.querySelector('input[name="resetType"]:checked').value; 
  document.querySelectorAll('select').forEach(s=>s.value=""); 
  localStorage.removeItem(`${PAPER_ID}_answers`);
  
  if(tp==='all'){ 
    document.querySelectorAll('.hl').forEach(el=>{ const p=el.parentNode; while(el.firstChild)p.insertBefore(el.firstChild,el); p.removeChild(el); p.normalize(); }); 
    document.querySelectorAll('.note').forEach(el=>{ const p=el.parentNode; while(el.firstChild)p.insertBefore(el.firstChild,el); p.removeChild(el); p.normalize(); }); 
    document.querySelectorAll('.flag-btn').forEach(b => b.classList.remove('active'));
    localStorage.removeItem(`${PAPER_ID}_highlights`);
    localStorage.removeItem(`${PAPER_ID}_flags`);
  } 
  closeModal('resetModal'); 
}

function addWrongToBook(){ const wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); const wr=lastResults.filter(r=>!r.isCorrect); wr.forEach(r=>{ const en={paperId:PAPER_ID,title:'Research into Teaching Styles',questionId:r.id,correctAnswer:r.correctAns,myAnswer:r.userAns||'(Êú™‰ΩúÁ≠î)',date:new Date().toISOString().split('T')[0]}; const ix=wb.findIndex(i=>i.paperId===en.paperId&&i.questionId===en.questionId); if(ix>=0)wb[ix]=en; else wb.push(en); }); localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); alert(`Â∑≤Ê∑ªÂä† ${wr.length} ÈÅìÈîôÈ¢ò`); closeModal('resultModal'); }

function deleteWrongItem(pId,qId){ if(!confirm('Á°ÆÂÆöÂà†Èô§ËøôÈÅìÈîôÈ¢òÔºü'))return; let wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); wb=wb.filter(i=>!(i.paperId===pId&&i.questionId===qId)); localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); openWrongBook(); }

function clearCurrentWrongBook(){ if(!confirm('Á°ÆÂÆöÊ∏ÖÁ©∫Êú¨ÁØáÊâÄÊúâÈîôÈ¢òÔºü'))return; let wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); wb=wb.filter(i=>i.paperId!==PAPER_ID); localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); openWrongBook(); }

function openWrongBook(){ const wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); const cu=wb.filter(i=>i.paperId===PAPER_ID); const ct=document.getElementById('wrongBookContent'); if(cu.length===0)ct.innerHTML='<div style="text-align:center;padding:40px;color:#666;">ÊöÇÊó†ÈîôÈ¢ò</div>'; else ct.innerHTML=`<div class="modal-actions"><button class="btn-danger" onclick="clearCurrentWrongBook()" style="width:100%;">üóëÔ∏è Ê∏ÖÁ©∫Êú¨ÁØáÈîôÈ¢ò</button></div>${cu.map(i=>`<div class="wrong-item"><div class="wrong-item-content"><div style="font-weight:600;margin-bottom:8px;">${i.questionId}</div><div style="font-size:13px;color:#666;"><div>‚úì Ê≠£Á°Æ: ${i.correctAnswer}</div><div style="color:#d32f2f;">‚úó ÊàëÁöÑ: ${i.myAnswer}</div></div></div><button class="btn-delete" onclick="deleteWrongItem('${i.paperId}','${i.questionId}')">Âà†Èô§</button></div>`).join('')}`; document.getElementById('wrongBookModal').classList.add('active'); }

function closeModal(id){ document.getElementById(id).classList.remove('active'); }
</script>
</body>
</html>