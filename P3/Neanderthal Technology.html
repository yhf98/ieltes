<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>P3 ‚Äì Neanderthal Technology</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  * { box-sizing: border-box; margin:0; padding:0; }
  html,body { height:100%; }
  body { font-family: Arial, sans-serif; background:#f5f5f5; }
  
  #timer { position:fixed; top:12px; right:12px; background:#fff; border:1px solid #ddd; border-radius:6px; padding:8px 12px; font-size:16px; font-weight:600; color:#0066cc; z-index:1000; }
  
  .shell { display:flex; height:100vh; width:100%; }
  .pane { background:#fff; overflow:auto; padding:24px; }
  #left { flex: 0 0 50%; border-right:1px solid #ddd; }
  #right { flex: 1 1 auto; background:#fafafa; }
  #divider { flex: 0 0 5px; background:#ddd; cursor: ew-resize; }
  #divider:hover { background:#999; }
  
  h2,h3,h4 { margin:0 0 12px; color:#333; }
  h2 { font-size:20px; }
  h3 { font-size:18px; color:#0066cc; }
  h4 { font-size:15px; font-weight:600; margin-top:20px; }
  
  #left p { margin: 0 0 14px; line-height: 1.7; text-align:justify; }
  
  .group { background:#fff; border:1px solid #ddd; border-radius:6px; padding:16px; margin-bottom:16px; }
  .group h4 { margin-top:0; color:#0066cc; }
  .group p { margin:8px 0; font-size:14px; line-height:1.6; }
  
  .headings { background:#f9f9f9; padding:12px; margin:12px 0; border-radius:4px; }
  .headings ol { margin-left:20px; }
  .headings li { margin:4px 0; font-size:13px; }
  
  .flag-btn { 
    position:absolute; 
    left:2px; 
    top:50%;
    transform:translateY(-50%);
    width:8px;
    height:8px;
    border-radius:50%;
    background:#ddd;
    cursor:pointer;
    z-index:10;
  }
  .flag-btn:hover { background:#999; }
  .flag-btn.active { background:#ff5722; }
  
  .group ol { margin-left:20px; }
  .group ol li { margin:12px 0; font-size:14px; line-height:1.6; position:relative; }
  .group ol li label { display:inline-block; margin-right:8px; }
  
  /* Additional style for text inputs in summary completion */
  input[type="text"] {
    border: 1px solid #ccc;
    border-radius: 4px;
    padding: 4px 8px;
    font-size: 14px;
    width: 150px;
    margin: 0 5px;
  }
  
  .bottom-bar { display:flex; gap:10px; margin-top:16px; }
  button { padding:10px 20px; border:1px solid #999; border-radius:6px; background:#fff; cursor:pointer; font-size:14px; }
  button:hover { background:#f0f0f0; }
  .btn-primary { background:#0066cc; color:#fff; border-color:#0066cc; }
  .btn-primary:hover { background:#0052a3; }
  .btn-danger { background:#dc3545; color:#fff; border-color:#dc3545; }
  .btn-danger:hover { background:#c82333; }
  
  .hl { background:#fff59d; cursor:pointer; }
  .hl:hover { background:#ffeb3b; }
  .note { background:#b3d9ff; cursor:pointer; }
  .note:hover { background:#99ccff; }
  
  #selbar { position:fixed; display:none; z-index:2000; background:#fff; border:1px solid #ddd; border-radius:8px; padding:8px; gap:0; box-shadow:0 2px 8px rgba(0,0,0,0.15); flex-direction:column; min-width:120px; }
  #selbar button { background:#fff; color:#666; border:none; padding:3px 0px; cursor:pointer; font-size:14px; text-align:center; border-radius:4px; }
  #selbar button:hover { background:#f5f5f5; color:#333; }
  
  .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:3000; align-items:center; justify-content:center; }
  .modal.active { display:flex; }
  .modal-content { background:#fff; border-radius:8px; padding:24px; max-width:600px; width:90%; max-height:80vh; overflow-y:auto; }
  
  .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
  .modal-header h2 { font-size: 28px; color: #333; margin: 0; }
  .modal-close { font-size: 32px; cursor: pointer; color: #999; line-height: 1; }
  .modal-close:hover { color: #333; }
  
  .result-summary { text-align:center; padding:20px; background:#f0f0f0; margin-bottom:16px; border-radius:6px; }
  .result-score { font-size:36px; font-weight:600; color:#0066cc; }
  .result-item { padding:10px; margin:8px 0; border-left:3px solid #ddd; background:#f9f9f9; font-size:13px; }
  .result-item.correct { border-left-color:#28a745; background:#e8f5e9; }
  .result-item.incorrect { border-left-color:#dc3545; background:#ffebee; }
  
  .wrong-item { background:#fff3e0; padding:16px; margin:8px 0; border-radius:8px; border-left:4px solid #ff9800; display:flex; justify-content:space-between; align-items:start; }
  .wrong-item-content { flex:1; }
  .btn-delete { background:#dc3545; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-size:13px; margin-left:12px; }
  .btn-delete:hover { background:#c82333; }
  .modal-actions { display:flex; gap:10px; margin-bottom:20px; }
</style>
</head>
<body>
<div id="timer">00:00</div>

<div class="shell">
  <section class="pane" id="left">
    
<h2>READING PASSAGE 3</h2>
<p>You should spend about 20 minutes on Questions 27‚Äì40, which are based on Reading Passage 3 below.</p>
<h3>Neanderthal Technology</h3>

<h4>Section A</h4>
<p>We think of our prehistoric ancestors as people of the ice and snow, living in caves, and for many of the West European Neanderthalers that is just a picture of their life. But where there were no caves, further to the east on the Russian steppe, for example, open-air sites with some sort of constructed shelter were the only option. We now know much more about the cave sites than the open-air ones because, historically, it was the cave sites of Western Europe that were first explored by archaeologists and also because open-air sites are harder to find ‚Äì many of them have disappeared under deep mud deposits or under the rising postglacial seas. Caves, moreover, aid the survival of archaeological material and can preserve the records of remote millennia.</p>

<h4>Section B</h4>
<p>In south-west France, the limestone caves of the P√©rigord region made ideal homes for the Neanderthal people. There were good supplies of flint to hand for axes and the like, and the caves were often sited in small river valleys that offered protection against the worst of the weather. The Neanderthalers liked south-facing caves, for obvious reasons of sunshine and wind avoidance, and caves at some height above the valley floor offered refuge from floods and good game-watching vantage points. The P√©rigord region during the last ice age was, in fact, an exceptionally benign habitat for humans. It enjoyed a rather maritime climate with cooler summers that permitted the extension of tundra and steppe over its higher plateaux, and its year-round high levels of sunshine favoured the growth of the ground plants needed by reindeer, bison and horse. Winters were mildish for the ice age, animals never needed to migrate far from summer to winter, and men never needed to travel far from home to find abundant supplies of meat.</p>

<h4>Section C</h4>
<p>In Central and Eastern Europe, where caves are less readily available, such open-air sites as have been discovered were mostly located near water: bottom-land was a good area to be for people and animals, and also because the sedimentation pattern of lakes and stream courses has aided archaeological preservation ‚Äì whereas erosion has presumably blown away sites which were out in the open. Some of the open-air sites in Germany, Central Europe and Russia have provided valuable information about Neanderthal man and his way of life. From Moldova, for example, comes evidence that has been interpreted as the remains of wind-breaks, or even a large tent-ring, up to about 8 x 5 m in size, of mainly mammoth bones enclosing a dense concentration of stone tools, animal bones and ash.</p>

<h4>Section D</h4>
<p>From the West European caves more evidence of built structures is available, and some of it goes back a long way in time. In the Grotte du Lazaret, near Nice, at a date during the last ice age but one, claims for some sort of skin tent within the cave have been advanced, on the basis of arrangements of large stones out from the cave wall that might have supported timber struts for a covering of skins up to the rock face above. At Lazaret, what might be openings in the hypothesised tents seem to point away from the cave mouth, and finds of wolf and fox foot bones, without the rest of the skeletons, inside these ‚Äòtents‚Äô have been thought to indicate the use of animal pelts as bed coverings. The two patches of ash at Lazaret that mark ancient fires, with stone tools around them evidently made and used on the spot, are edged with small marine mollusc shells, prompting the excavator to suggest that seaweed had been used as bedding around the fires. The cave of Baume-Bonne in the Basses-Alpes region of France, another early site, boasts ten square metres of cobbles brought up from the local river and laid down, as though to take care of a puddle area in the cave, with the smoothest and roundest surfaces of the stones uppermost, and there are other similar cases.</p>

<h4>Section E</h4>
<p>The ash encountered in concentrations at some sites testifies to the Neanderthal people‚Äôs use of fire: not surprising, since use of fire was, by Neanderthal times, an already ancient accomplishment of evolving humanity, and survival in the sub-arctic conditions faced by the Neanderthalers is inconceivable without control of fire. Fire gave warmth, light, heat for cooking and defence against predatory animals. A charred piece of birch from Krapina in Croatia is thought to be the remains of a fire-making twirl stick. But Neanderthal hearths, in the sense of specially constructed places for fire, are fewer and harder to identify with certainty than the mere ash piles that are a regular feature of their sites. They seem often to have just lit a small fire (40‚Äì50 cm across) on the existing ground surface of the cave, without preparation. Judging from the shallow penetration of heat effects under the ash, this fire was only of short duration. Sometimes the fires were larger in size, up to one metre across, and quite irregular in shape. It is not always easy to decide how much additional structure some fires possessed: claims of stone circles to contain the fire run up against the fact that stones tend to litter the cave floors everywhere and those around a fire can quite accidentally look as though they were arranged in a circle.</p>
  </section>

  <div id="divider" title="Drag to resize"></div>

  <section class="pane" id="right">
    <h3>Questions</h3>

    <div class="group">
      <h4>Questions 27‚Äì31</h4>
      <p>Reading Passage 3 has five sections, A‚ÄìE.</p>
      <p>Choose the correct heading for each section from the list of headings below.</p>
      <p>Write the correct number, <strong>i‚Äìvi</strong>, in boxes <strong>27‚Äì31</strong> on your answer sheet.</p>

      <div class="headings" style="border:1px solid #999; padding:15px; margin-bottom:20px;">
        <h5 style="margin:0 0 10px;">List of Headings</h5>
        <ol type="i">
            <li>Evidence of outdoor dwellings</li>
            <li>Learning to make fire</li>
            <li>A perfect place to live</li>
            <li>Examining the cave contents</li>
            <li>Contrasting two types of home</li>
            <li>A vital source of power</li>
        </ol>
      </div>

      <ol start="27">
        <li><span class="flag-btn" data-q="q27" style="left:-20px;"></span>Section A<br>
          <label><input type="radio" name="q27" value="i"> i</label>
          <label><input type="radio" name="q27" value="ii"> ii</label>
          <label><input type="radio" name="q27" value="iii"> iii</label>
          <label><input type="radio" name="q27" value="iv"> iv</label>
          <label><input type="radio" name="q27" value="v"> v</label>
          <label><input type="radio" name="q27" value="vi"> vi</label>
        </li>
        <li><span class="flag-btn" data-q="q28" style="left:-20px;"></span>Section B<br>
          <label><input type="radio" name="q28" value="i"> i</label>
          <label><input type="radio" name="q28" value="ii"> ii</label>
          <label><input type="radio" name="q28" value="iii"> iii</label>
          <label><input type="radio" name="q28" value="iv"> iv</label>
          <label><input type="radio" name="q28" value="v"> v</label>
          <label><input type="radio" name="q28" value="vi"> vi</label>
        </li>
        <li><span class="flag-btn" data-q="q29" style="left:-20px;"></span>Section C<br>
          <label><input type="radio" name="q29" value="i"> i</label>
          <label><input type="radio" name="q29" value="ii"> ii</label>
          <label><input type="radio" name="q29" value="iii"> iii</label>
          <label><input type="radio" name="q29" value="iv"> iv</label>
          <label><input type="radio" name="q29" value="v"> v</label>
          <label><input type="radio" name="q29" value="vi"> vi</label>
        </li>
        <li><span class="flag-btn" data-q="q30" style="left:-20px;"></span>Section D<br>
          <label><input type="radio" name="q30" value="i"> i</label>
          <label><input type="radio" name="q30" value="ii"> ii</label>
          <label><input type="radio" name="q30" value="iii"> iii</label>
          <label><input type="radio" name="q30" value="iv"> iv</label>
          <label><input type="radio" name="q30" value="v"> v</label>
          <label><input type="radio" name="q30" value="vi"> vi</label>
        </li>
        <li><span class="flag-btn" data-q="q31" style="left:-20px;"></span>Section E<br>
          <label><input type="radio" name="q31" value="i"> i</label>
          <label><input type="radio" name="q31" value="ii"> ii</label>
          <label><input type="radio" name="q31" value="iii"> iii</label>
          <label><input type="radio" name="q31" value="iv"> iv</label>
          <label><input type="radio" name="q31" value="v"> v</label>
          <label><input type="radio" name="q31" value="vi"> vi</label>
        </li>
      </ol>
    </div>

    <div class="group">
      <h4>Questions 32‚Äì36</h4>
      <p>Look at the following findings (Questions 32‚Äì36) and the list of places below.</p>
      <p>Match each finding with the correct place, A‚ÄìE.</p>
      <p>Write the correct letter, <strong>A‚ÄìE</strong>, in boxes <strong>32‚Äì36</strong> on your answer sheet.</p>
      <p><strong>NB</strong> You may use any letter more than once.</p>

      <div class="headings" style="border:1px solid #999; padding:15px; margin-bottom:20px;">
        <h5 style="margin:0 0 10px;">List of Places</h5>
        <ul style="list-style-type:none; padding:0;">
          <li><strong>A</strong> The P√©rigord region</li>
          <li><strong>B</strong> Moldova</li>
          <li><strong>C</strong> The Grotte du Lazaret</li>
          <li><strong>D</strong> The cave of Baume-Bonne</li>
          <li><strong>E</strong> Krapina</li>
        </ul>
      </div>

      <ol start="32">
        <li><span class="flag-btn" data-q="q32" style="left:-20px;"></span>a burnt piece of wood<br>
          <label><input type="radio" name="q32" value="A"> A</label>
          <label><input type="radio" name="q32" value="B"> B</label>
          <label><input type="radio" name="q32" value="C"> C</label>
          <label><input type="radio" name="q32" value="D"> D</label>
          <label><input type="radio" name="q32" value="E"> E</label>
        </li>
        <li><span class="flag-btn" data-q="q33" style="left:-20px;"></span>evidence of efforts to prevent pools of water forming<br>
          <label><input type="radio" name="q33" value="A"> A</label>
          <label><input type="radio" name="q33" value="B"> B</label>
          <label><input type="radio" name="q33" value="C"> C</label>
          <label><input type="radio" name="q33" value="D"> D</label>
          <label><input type="radio" name="q33" value="E"> E</label>
        </li>
        <li><span class="flag-btn" data-q="q34" style="left:-20px;"></span>the remains of sea creatures<br>
          <label><input type="radio" name="q34" value="A"> A</label>
          <label><input type="radio" name="q34" value="B"> B</label>
          <label><input type="radio" name="q34" value="C"> C</label>
          <label><input type="radio" name="q34" value="D"> D</label>
          <label><input type="radio" name="q34" value="E"> E</label>
        </li>
        <li><span class="flag-btn" data-q="q35" style="left:-20px;"></span>a circular arrangement of animal bones<br>
          <label><input type="radio" name="q35" value="A"> A</label>
          <label><input type="radio" name="q35" value="B"> B</label>
          <label><input type="radio" name="q35" value="C"> C</label>
          <label><input type="radio" name="q35" value="D"> D</label>
          <label><input type="radio" name="q35" value="E"> E</label>
        </li>
        <li><span class="flag-btn" data-q="q36" style="left:-20px;"></span>evidence suggesting the use of animal fur for warmth<br>
          <label><input type="radio" name="q36" value="A"> A</label>
          <label><input type="radio" name="q36" value="B"> B</label>
          <label><input type="radio" name="q36" value="C"> C</label>
          <label><input type="radio" name="q36" value="D"> D</label>
          <label><input type="radio" name="q36" value="E"> E</label>
        </li>
      </ol>
    </div>

    <div class="group">
      <h4>Questions 37‚Äì39</h4>
      <p>Complete the summary below.</p>
      <p>Choose <strong>NO MORE THAN TWO WORDS</strong> from the passage for each answer.</p>
      <p>Write your answers in boxes <strong>37‚Äì39</strong> on your answer sheet.</p>
      
      <div style="background:#f9f9f9; padding:16px; border-radius:4px; line-height:2;">
        <h5 style="text-align:center; margin-bottom:12px;">The use of fire</h5>
        <p>Neanderthalers could not have survived without fire because the conditions they lived in were <span class="flag-btn" data-q="q37" style="position:static; display:inline-block; margin-right:4px;"></span><b>37</b> <input type="text" name="q37" autocomplete="off">.</p>
        <p>Most evidence of purpose-built fires takes the form of ash piles, features of which suggest that the fires lasted a <span class="flag-btn" data-q="q38" style="position:static; display:inline-block; margin-right:4px;"></span><b>38</b> <input type="text" name="q38" autocomplete="off"> time.</p>
        <p>It is hard to be certain about the size and structure of the fires, though they were certainly needed to protect the occupants from dangerous <span class="flag-btn" data-q="q39" style="position:static; display:inline-block; margin-right:4px;"></span><b>39</b> <input type="text" name="q39" autocomplete="off">, among other things.</p>
      </div>
    </div>

    <div class="group">
      <h4>Question 40</h4>
      <p>Choose the correct letter, <strong>A, B, C or D</strong>.</p>
      <p>Write the correct letter in box <strong>40</strong> on your answer sheet.</p>
      
      <ol start="40" style="list-style:none; margin-left:0;">
        <li><span class="flag-btn" data-q="q40" style="left:-20px;"></span>The purpose of the writer of this article is to<br>
          <div style="margin-top:8px;">
            <label style="display:block; margin:6px 0;"><input type="radio" name="q40" value="A"> <strong>A</strong> argue that Neanderthal homes were bigger than originally thought.</label>
            <label style="display:block; margin:6px 0;"><input type="radio" name="q40" value="B"> <strong>B</strong> explain why Neanderthal people migrated to Western Europe.</label>
            <label style="display:block; margin:6px 0;"><input type="radio" name="q40" value="C"> <strong>C</strong> discuss what is known about Neanderthal settlements.</label>
            <label style="display:block; margin:6px 0;"><input type="radio" name="q40" value="D"> <strong>D</strong> track the progress of early Neanderthal development.</label>
          </div>
        </li>
      </ol>
    </div>

    <div class="bottom-bar">
      <button class="btn-primary" onclick="submitAnswers()">Êèê‰∫§</button>
      <button onclick="resetForm()">ÈáçÁΩÆ</button>
      <button onclick="openWrongBook()">Êú¨ÁØáÈîôÈ¢ò</button>
    </div>
  </section>
</div>

<div id="selbar">
  <button id="btnNote">Note</button>
  <button id="btnHL">Highlight</button>
  <button id="btnUH" style="display:none;">Clear Highlight</button>
</div>

<div class="modal" id="resultModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ÊàêÁª©</h2>
      <span class="modal-close" onclick="closeModal('resultModal')">√ó</span>
    </div>
    <div id="resultContent"></div>
    <button class="btn-primary" style="width:100%; margin-top:16px;" onclick="addWrongToBook()">Âä†ÂÖ•ÈîôÈ¢òÊú¨</button>
  </div>
</div>

<div class="modal" id="wrongBookModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Êú¨ÁØáÈîôÈ¢ò</h2>
      <span class="modal-close" onclick="closeModal('wrongBookModal')">√ó</span>
    </div>
    <div id="wrongBookContent"></div>
  </div>
</div>

<div class="modal" id="resetModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ÈáçÁΩÆÁªÉ‰π†</h2>
      <span class="modal-close" onclick="closeModal('resetModal')">√ó</span>
    </div>
    <div style="margin:16px 0;">
      <label style="display:block; margin-bottom:10px;">
        <input type="radio" name="resetType" value="answers" checked>
        Âè™Ê∏ÖÁ©∫Á≠îÊ°à
      </label>
      <label style="display:block;">
        <input type="radio" name="resetType" value="all">
        Ê∏ÖÁ©∫Á≠îÊ°àÂíåÊ†áËÆ∞
      </label>
    </div>
    <button class="btn-primary" style="width:100%;" onclick="confirmReset()">Á°ÆÂÆö</button>
  </div>
</div>

<script>
const PAPER_ID='P3_NEANDERTHAL';

let t=0;
const timerEl=document.getElementById('timer');
setInterval(()=>{ t++; timerEl.textContent=String(Math.floor(t/60)).padStart(2,'0')+':'+String(t%60).padStart(2,'0'); }, 1000);

const divider=document.getElementById('divider'), left=document.getElementById('left'), right=document.getElementById('right');
let dragging=false;
divider.onmousedown=()=>{ dragging=true; document.body.style.cursor='ew-resize'; };
window.onmousemove=(e)=>{ if(!dragging)return; const c=document.querySelector('.shell').getBoundingClientRect(); let x=e.clientX-c.left; x=Math.max(280,Math.min(c.width-280,x)); left.style.flex='0 0 '+x+'px'; right.style.flex='1 1 auto'; };
window.onmouseup=()=>{ dragging=false; document.body.style.cursor=''; };

const selbar=document.getElementById('selbar'), btnHL=document.getElementById('btnHL'), btnUH=document.getElementById('btnUH'), btnNote=document.getElementById('btnNote');
let lastRange=null, currentHlNode=null;

function posSelbar(r){ selbar.style.display='flex'; const t=window.scrollY+r.top-selbar.offsetHeight-8; const l=window.scrollX+r.left+r.width/2-selbar.offsetWidth/2; selbar.style.top=((t>0)?t:(window.scrollY+r.bottom+8))+'px'; selbar.style.left=Math.max(8,l)+'px'; }

function updSel(){ const s=window.getSelection(); if(!s||s.rangeCount===0||s.isCollapsed){ if(!currentHlNode)selbar.style.display='none'; return; } const r=s.getRangeAt(0); lastRange=r.cloneRange(); currentHlNode=null; btnNote.style.display='block'; btnHL.style.display='block'; btnUH.style.display='none'; posSelbar(r.getBoundingClientRect()); }

left.onmouseup=updSel; right.onmouseup=updSel;
document.onselectionchange=()=>{ const s=window.getSelection(); if((!s||s.rangeCount===0||s.isCollapsed)&&!currentHlNode)selbar.style.display='none'; };
document.addEventListener('click',(e)=>{ if(e.target.classList&&(e.target.classList.contains('hl')||e.target.classList.contains('note'))){ currentHlNode=e.target; lastRange=null; btnNote.style.display='none'; btnHL.style.display='none'; btnUH.style.display='block'; posSelbar(e.target.getBoundingClientRect()); const s=window.getSelection(); if(s)s.removeAllRanges(); }}, true);

btnHL.onclick=()=>{ if(currentHlNode||!lastRange||lastRange.collapsed)return; const s=document.createElement('span'); s.className='hl'; try{ lastRange.surroundContents(s); }catch(e){ const w=document.createElement('span'); w.className='hl'; w.appendChild(lastRange.cloneContents()); lastRange.deleteContents(); lastRange.insertNode(w); } selbar.style.display='none'; saveHighlights(); };

btnNote.onclick=()=>{ if(currentHlNode||!lastRange||lastRange.collapsed)return; const s=document.createElement('span'); s.className='note'; try{ lastRange.surroundContents(s); }catch(e){ const w=document.createElement('span'); w.className='note'; w.appendChild(lastRange.cloneContents()); lastRange.deleteContents(); lastRange.insertNode(w); } selbar.style.display='none'; saveHighlights(); };

btnUH.onclick=()=>{ if(currentHlNode){ const p=currentHlNode.parentNode; while(currentHlNode.firstChild)p.insertBefore(currentHlNode.firstChild,currentHlNode); p.removeChild(currentHlNode); p.normalize(); currentHlNode=null; selbar.style.display='none'; saveHighlights(); }else if(lastRange){ const sR=lastRange.getBoundingClientRect(); const w=document.createTreeWalker(document.body,NodeFilter.SHOW_ELEMENT); const tr=[]; while(w.nextNode()){ const n=w.currentNode; if(n.classList&&(n.classList.contains('hl')||n.classList.contains('note'))){ const r=n.getBoundingClientRect(); if(!(r.right<sR.left||r.left>sR.right||r.bottom<sR.top||r.top>sR.bottom))tr.push(n); }} tr.forEach(el=>{ const p=el.parentNode; while(el.firstChild)p.insertBefore(el.firstChild,el); p.removeChild(el); p.normalize(); }); selbar.style.display='none'; saveHighlights(); }};

document.querySelectorAll('.flag-btn').forEach(btn => {
  btn.onclick = e => {
    e.stopPropagation();
    btn.classList.toggle('active');
    saveFlags();
  };
});

const answerKey={q27:"v",q28:"iii",q29:"i",q30:"iv",q31:"vi",q32:"E",q33:"D",q34:"C",q35:"B",q36:"C",q37:"sub-arctic",q38:"short",q39:"predatory animals",q40:"C"};
let lastResults=[];

function saveAnswers() {
  const data = {};
  Object.keys(answerKey).forEach(q => {
    const radio = document.querySelector(`input[name="${q}"][type="radio"]:checked`);
    if(radio) {
      data[q] = radio.value;
    } else {
      const text = document.querySelector(`input[name="${q}"][type="text"]`);
      if(text) data[q] = text.value;
    }
  });
  localStorage.setItem(`${PAPER_ID}_answers`, JSON.stringify(data));
}

function loadAnswers() {
  const data = JSON.parse(localStorage.getItem(`${PAPER_ID}_answers`) || '{}');
  Object.keys(data).forEach(q => {
    const radio = document.querySelector(`input[name="${q}"][value="${data[q]}"]`);
    if(radio) {
      radio.checked = true;
    } else {
      const text = document.querySelector(`input[name="${q}"][type="text"]`);
      if(text) text.value = data[q];
    }
  });
}

function saveFlags() {
  const flags = [...document.querySelectorAll('.flag-btn.active')].map(b => b.dataset.q);
  localStorage.setItem(`${PAPER_ID}_flags`, JSON.stringify(flags));
}

function loadFlags() {
  const flags = JSON.parse(localStorage.getItem(`${PAPER_ID}_flags`) || '[]');
  flags.forEach(q => document.querySelector(`[data-q="${q}"]`)?.classList.add('active'));
}

function saveHighlights() {
  const highlights = { left: [], right: [] };
  document.querySelectorAll('#left .hl, #left .note').forEach((el, idx) => {
    highlights.left.push({
      type: el.classList.contains('hl') ? 'hl' : 'note',
      text: el.textContent,
      index: idx
    });
  });
  document.querySelectorAll('#right .hl, #right .note').forEach((el, idx) => {
    highlights.right.push({
      type: el.classList.contains('hl') ? 'hl' : 'note',
      text: el.textContent,
      index: idx
    });
  });
  localStorage.setItem(`${PAPER_ID}_highlights`, JSON.stringify(highlights));
}

function loadHighlights() {
  const data = JSON.parse(localStorage.getItem(`${PAPER_ID}_highlights`) || '{"left":[],"right":[]}');
  
  if(data.left && data.left.length > 0) {
    data.left.forEach(item => {
      const walker = document.createTreeWalker(left, NodeFilter.SHOW_TEXT);
      let node;
      while(node = walker.nextNode()) {
        if(node.textContent.includes(item.text)) {
          const span = document.createElement('span');
          span.className = item.type;
          const parent = node.parentNode;
          const text = node.textContent;
          const idx = text.indexOf(item.text);
          if(idx >= 0) {
            const before = text.substring(0, idx);
            const match = text.substring(idx, idx + item.text.length);
            const after = text.substring(idx + item.text.length);
            parent.insertBefore(document.createTextNode(before), node);
            span.textContent = match;
            parent.insertBefore(span, node);
            parent.insertBefore(document.createTextNode(after), node);
            parent.removeChild(node);
            break;
          }
        }
      }
    });
  }
  
  if(data.right && data.right.length > 0) {
    data.right.forEach(item => {
      const walker = document.createTreeWalker(right, NodeFilter.SHOW_TEXT);
      let node;
      while(node = walker.nextNode()) {
        if(node.textContent.includes(item.text)) {
          const span = document.createElement('span');
          span.className = item.type;
          const parent = node.parentNode;
          const text = node.textContent;
          const idx = text.indexOf(item.text);
          if(idx >= 0) {
            const before = text.substring(0, idx);
            const match = text.substring(idx, idx + item.text.length);
            const after = text.substring(idx + item.text.length);
            parent.insertBefore(document.createTextNode(before), node);
            span.textContent = match;
            parent.insertBefore(span, node);
            parent.insertBefore(document.createTextNode(after), node);
            parent.removeChild(node);
            break;
          }
        }
      }
    });
  }
}

document.querySelectorAll('input').forEach(inp => {
  inp.addEventListener('change', saveAnswers);
  if(inp.type === 'text') inp.addEventListener('input', saveAnswers);
});

document.addEventListener('DOMContentLoaded', () => {
  loadAnswers();
  loadFlags();
  loadHighlights();
});

function submitAnswers(){ 
  const res=[]; 
  let cor=0; 
  Object.keys(answerKey).forEach(q=>{ 
    let uA = "";
    const radio = document.querySelector(`input[name="${q}"][type="radio"]:checked`);
    if(radio) uA = radio.value;
    else {
      const text = document.querySelector(`input[name="${q}"][type="text"]`);
      if(text) uA = text.value;
    }

    const cA=answerKey[q];
    let iC = false;
    // Check if text input (case insensitive)
    if(document.querySelector(`input[name="${q}"][type="text"]`)) {
        iC = uA.trim().toLowerCase() === cA.toLowerCase();
    } else {
        iC = uA === cA;
    }

    if(iC)cor++; 
    res.push({id:q,userAns:uA,correctAns:cA,isCorrect:iC}); 
  }); 
  lastResults=res; 
  const tot=Object.keys(answerKey).length; 
  const pct=((cor/tot)*100).toFixed(1); 
  localStorage.setItem(`ielts_score_${PAPER_ID}`, `${cor}/${tot}`);
  document.getElementById('resultContent').innerHTML=`<div class="result-summary"><div class="result-score">${cor} / ${tot}</div><div style="margin-top:8px;font-size:18px;">${pct}%</div></div>${res.map(r=>`<div class="result-item ${r.isCorrect?'correct':'incorrect'}"><div><strong>${r.id}</strong> ${r.isCorrect?'‚úì':'‚úó'}</div><div>‰Ω†ÁöÑÁ≠îÊ°à: ${r.userAns||'(Êú™‰ΩúÁ≠î)'}</div>${!r.isCorrect?`<div>Ê≠£Á°ÆÁ≠îÊ°à: ${r.correctAns}</div>`:''}</div>`).join('')}`; 
  document.getElementById('resultModal').classList.add('active'); 
}

function resetForm(){ document.getElementById('resetModal').classList.add('active'); }

function confirmReset(){ 
  const tp=document.querySelector('input[name="resetType"]:checked').value; 
  document.querySelectorAll('input[type="radio"]').forEach(i=>i.checked=false); 
  document.querySelectorAll('input[type="text"]').forEach(i=>i.value="");
  localStorage.removeItem(`${PAPER_ID}_answers`);
  
  if(tp==='all'){ 
    document.querySelectorAll('.hl').forEach(el=>{ const p=el.parentNode; while(el.firstChild)p.insertBefore(el.firstChild,el); p.removeChild(el); p.normalize(); }); 
    document.querySelectorAll('.note').forEach(el=>{ const p=el.parentNode; while(el.firstChild)p.insertBefore(el.firstChild,el); p.removeChild(el); p.normalize(); }); 
    document.querySelectorAll('.flag-btn').forEach(b => b.classList.remove('active'));
    localStorage.removeItem(`${PAPER_ID}_highlights`);
    localStorage.removeItem(`${PAPER_ID}_flags`);
  } 
  closeModal('resetModal'); 
}

function addWrongToBook(){ const wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); const wr=lastResults.filter(r=>!r.isCorrect); wr.forEach(r=>{ const en={paperId:PAPER_ID,title:'Neanderthal Technology',questionId:r.id,correctAnswer:r.correctAns,myAnswer:r.userAns||'(Êú™‰ΩúÁ≠î)',date:new Date().toISOString().split('T')[0]}; const ix=wb.findIndex(i=>i.paperId===en.paperId&&i.questionId===en.questionId); if(ix>=0)wb[ix]=en; else wb.push(en); }); localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); alert(`Â∑≤Ê∑ªÂä† ${wr.length} ÈÅìÈîôÈ¢ò`); closeModal('resultModal'); }

function deleteWrongItem(pId,qId){ if(!confirm('Á°ÆÂÆöÂà†Èô§ËøôÈÅìÈîôÈ¢òÔºü'))return; let wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); wb=wb.filter(i=>!(i.paperId===pId&&i.questionId===qId)); localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); openWrongBook(); }

function clearCurrentWrongBook(){ if(!confirm('Á°ÆÂÆöÊ∏ÖÁ©∫Êú¨ÁØáÊâÄÊúâÈîôÈ¢òÔºü'))return; let wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); wb=wb.filter(i=>i.paperId!==PAPER_ID); localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); openWrongBook(); }

function openWrongBook(){ const wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); const cu=wb.filter(i=>i.paperId===PAPER_ID); const ct=document.getElementById('wrongBookContent'); if(cu.length===0)ct.innerHTML='<div style="text-align:center;padding:40px;color:#666;">ÊöÇÊó†ÈîôÈ¢ò</div>'; else ct.innerHTML=`<div class="modal-actions"><button class="btn-danger" onclick="clearCurrentWrongBook()" style="width:100%;">üóëÔ∏è Ê∏ÖÁ©∫Êú¨ÁØáÈîôÈ¢ò</button></div>${cu.map(i=>`<div class="wrong-item"><div class="wrong-item-content"><div style="font-weight:600;margin-bottom:8px;">${i.questionId}</div><div style="font-size:13px;color:#666;"><div>‚úì Ê≠£Á°Æ: ${i.correctAnswer}</div><div style="color:#d32f2f;">‚úó ÊàëÁöÑ: ${i.myAnswer}</div></div></div><button class="btn-delete" onclick="deleteWrongItem('${i.paperId}','${i.questionId}')">Âà†Èô§</button></div>`).join('')}`; document.getElementById('wrongBookModal').classList.add('active'); }

function closeModal(id){ document.getElementById(id).classList.remove('active'); }
</script>
</body>
</html>
