<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>P3 ‚Äì What is social history</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  * { box-sizing: border-box; margin:0; padding:0; }
  html,body { height:100%; }
  body { font-family: Arial, sans-serif; background:#f5f5f5; }
  
  #timer { position:fixed; top:12px; right:12px; background:#fff; border:1px solid #ddd; border-radius:6px; padding:8px 12px; font-size:16px; font-weight:600; color:#0066cc; z-index:1000; }
  
  .shell { display:flex; height:100vh; width:100%; }
  .pane { background:#fff; overflow:auto; padding:24px; }
  #left { flex: 0 0 50%; border-right:1px solid #ddd; }
  #right { flex: 1 1 auto; background:#fafafa; }
  #divider { flex: 0 0 5px; background:#ddd; cursor: ew-resize; }
  #divider:hover { background:#999; }
  
  h2,h3,h4 { margin:0 0 12px; color:#333; }
  h2 { font-size:20px; }
  h3 { font-size:18px; color:#0066cc; }
  h4 { font-size:15px; font-weight:600; margin-top:20px; }
  
  #left p { margin: 0 0 14px; line-height: 1.7; text-align:justify; }
  
  .group { background:#fff; border:1px solid #ddd; border-radius:6px; padding:16px; margin-bottom:16px; }
  .group h4 { margin-top:0; color:#0066cc; }
  .group p { margin:8px 0; font-size:14px; line-height:1.6; }
  
  .summary-box { background:#f9f9f9; border:1px solid #eee; padding:12px; margin:10px 0; border-radius:4px; font-size:14px; line-height:1.8; }
  .options-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap:8px; margin:12px 0; background:#f0f4f8; padding:10px; border-radius:4px; }
  .option-item { font-size:13px; }
  
  .flag-btn { 
    position:absolute; 
    left:2px; 
    top:50%;
    transform:translateY(-50%);
    width:8px;
    height:8px;
    border-radius:50%;
    background:#ddd;
    cursor:pointer;
    z-index:10;
  }
  .flag-btn:hover { background:#999; }
  .flag-btn.active { background:#ff5722; }
  
  .group ol { margin-left:20px; }
  .group ol li { margin:12px 0; font-size:14px; line-height:1.6; position:relative; }
  .group ol li label { display:inline-block; margin-right:8px; cursor:pointer; }
  
  .bottom-bar { display:flex; gap:10px; margin-top:16px; }
  button { padding:10px 20px; border:1px solid #999; border-radius:6px; background:#fff; cursor:pointer; font-size:14px; }
  button:hover { background:#f0f0f0; }
  .btn-primary { background:#0066cc; color:#fff; border-color:#0066cc; }
  .btn-primary:hover { background:#0052a3; }
  .btn-danger { background:#dc3545; color:#fff; border-color:#dc3545; }
  .btn-danger:hover { background:#c82333; }
  
  .hl { background:#fff59d; cursor:pointer; }
  .hl:hover { background:#ffeb3b; }
  .note { background:#b3d9ff; cursor:pointer; }
  .note:hover { background:#99ccff; }
  
  #selbar { position:fixed; display:none; z-index:2000; background:#fff; border:1px solid #ddd; border-radius:8px; padding:8px; gap:0; box-shadow:0 2px 8px rgba(0,0,0,0.15); flex-direction:column; min-width:120px; }
  #selbar button { background:#fff; color:#666; border:none; padding:3px 0px; cursor:pointer; font-size:14px; text-align:center; border-radius:4px; }
  #selbar button:hover { background:#f5f5f5; color:#333; }
  
  .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:3000; align-items:center; justify-content:center; }
  .modal.active { display:flex; }
  .modal-content { background:#fff; border-radius:8px; padding:24px; max-width:600px; width:90%; max-height:80vh; overflow-y:auto; }
  
  .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
  .modal-header h2 { font-size: 28px; color: #333; margin: 0; }
  .modal-close { font-size: 32px; cursor: pointer; color: #999; line-height: 1; }
  .modal-close:hover { color: #333; }
  
  .result-summary { text-align:center; padding:20px; background:#f0f0f0; margin-bottom:16px; border-radius:6px; }
  .result-score { font-size:36px; font-weight:600; color:#0066cc; }
  .result-item { padding:10px; margin:8px 0; border-left:3px solid #ddd; background:#f9f9f9; font-size:13px; }
  .result-item.correct { border-left-color:#28a745; background:#e8f5e9; }
  .result-item.incorrect { border-left-color:#dc3545; background:#ffebee; }
  
  .wrong-item { background:#fff3e0; padding:16px; margin:8px 0; border-radius:8px; border-left:4px solid #ff9800; display:flex; justify-content:space-between; align-items:start; }
  .wrong-item-content { flex:1; }
  .btn-delete { background:#dc3545; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-size:13px; margin-left:12px; }
  .btn-delete:hover { background:#c82333; }
  .modal-actions { display:flex; gap:10px; margin-bottom:20px; }
</style>
</head>
<body>
<div id="timer">00:00</div>

<div class="shell">
  <section class="pane" id="left">
    <h2>READING PASSAGE 3</h2>
    <p>You should spend about 20 minutes on Questions 27‚Äì40, which are based on Reading Passage 3 below.</p>
    <h3>What is social history?</h3>
    
    <p>Ever since its elevation to the status of an academic discipline, history has been very largely concerned with problems of its own making. These may be gaps which the young researcher is advised by supervisors to fill; or established views which he or she is encouraged to challenge. In either case, the need for the researcher to provide new insights in order to gain professional advancement often counts for more than the intrinsic interest of the topic.</p>
    <p>Social history is quite different. It touches on, and arguably helps to focus, major issues of public debate. It mobilises popular enthusiasm and engages popular passions. It prides itself on being concerned with everyday things rather than sensational events and is directed against the ‚ÄòGreat Man‚Äô theories that originally characterised history, and the tedious focus on bureaucratic issues that subsequently dominated the 1920s and 30s. This is also reflected in the way it is taught, through the adoption of multi-disciplinary perspectives rather than a narrow historical interpretation.</p>
    <p>Social history emerged, both as a popular enthusiasm and as a scholarly practice, from the cultural revolution of the 1960s in North America and Europe, and reproduces its leading inspirations. The spirit of social history was pre-eminently a modernising one, as reflected in its choice of subject matter. Whereas traditional history had focused on the 12th to 17th centuries, social history was apt to make its historical homeland in the 19th century. Latterly, it has even begun to extend its inquiry up to contemporary events and movements.</p>
    <p>The subject matter favoured by the new social history, with its move away from the aristocracy and the establishment, corresponds to other cultural manifestations of the 1960s, such as New Wave British cinema, with its working-class protagonists, or ‚ÄòPop art‚Äô, with its use of everyday artefacts. Similarly, the anti-institutional bias of the new social history‚Äîthe renewed determination to write the history of ‚Äòordinary‚Äô people as against that of statecraft‚Äîcould be said to echo a much more widespread collapse of social deference, and a questioning of authority figures of all kinds.</p>
    <p>Another major 1960s influence on the new social history‚Äîvery different in its origins and effects‚Äîwas the ‚Äònostalgia industry‚Äô, which focused on the sale of memorabilia and artefacts from recent history. This emerged as a kind of negative counterpart to the otherwise dominant modernisation of the decade and reflected a disenchantment, no less apparent on the Left of the political spectrum than on the Right, with post-war social change.</p>
    <p>Industrial archaeology, an invention of the 1960s, elevated disused factories and mills to the status of national monuments. Following in the same track, property restorers turned houses built for 19th-century factory workers‚Äîonce emblems of poverty, overcrowding, and ill-health‚Äîinto picturesque residences. In another sphere, one could point to the proliferation of folk clubs and the discovery of industrial folk songs, prefiguring one of the major themes of the new social history‚Äîthe dignity of labour.</p>
    <p>So far as historical work was concerned, by the 1970s the sense of disenchantment had crystallised into an idealised view of the past, fostering a nostalgic regard for disappearing communities. The restoration of vanished components of ‚Äòthe world we have lost‚Äô became a major impetus in historical writing and research. The dignity of ordinary people could be said to be the unifying theme of this line of historical inquiry and retrieval‚Äîa celebration of everyday life, even, perhaps especially, when it involved hardship and suffering.</p>
    <p>Despite the novelty of its subject matter, social history reproduces many of the characteristic biases of its predecessors. Social historians are good at amassing details on household artefacts, budgets, daily purchases, but at times the evidence is assumed to speak for itself, and the simple reproduction of fact masquerades as explanation. The facts accumulated may leave no conceptual space for the great absences, for the many areas where the documentary record is silent.</p>
    <p>The indulgence which social historians extend towards their subjects, and the desire to establish ‚Äòempathy‚Äô‚Äîseeing the past in terms of its own values rather than those of today‚Äîcan also serve to flatter our self-esteem, making history a field in which, at no great cost to ourselves, we can demonstrate our enlarged sympathies and benevolence. Recognising our kinship to people in the past, and tracing, or discovering, their likeness to ourselves, we are flattered in the belief that underneath we are all lovable; eccentric perhaps and even absurd, but large-hearted, generous and frank. This sense of integration with the past can thus serve as a comfortable alternative to critical awareness and self-questioning, allowing us to dignify the present by illegitimate association with the past.</p>
    <p>Social history, if it is to fulfil its subversive potential, needs to be a great deal more disturbing. If it is to celebrate a common humanity, and to bring past and present closer together, far more weight needs to be given to the effects of insecurities and emergencies‚Äîthe fears that shadow the growing up of children, the oppositions we encounter during our lives‚Äîexperiences which may be hard for an individual to categorise but which nevertheless have a significance which goes beyond that individual.</p>
    <p>Perhaps too we might recognise that there is a profound condescension in the notion of ‚Äòordinary people‚Äô‚Äîthat unified totality in which social historians are apt to deal. Implicitly it is a category from which we tend to exclude ourselves, although in fact we are exceptional only by our privilege of hindsight. ‚ÄòThere are ‚Ä¶ no masses,‚Äô Raymond Williams wrote, ‚Äòonly ways of seeing people as masses.‚Äô It is perhaps time for historians to scrutinise the term ‚Äòordinary people‚Äô in the same way.</p>
  </section>

  <div id="divider" title="Drag to resize"></div>

  <section class="pane" id="right">
    <h3>Questions</h3>

    <div class="group">
      <h4>Questions 27‚Äì31</h4>
      <p>Complete the summary using the list of words, A‚ÄìH, below.</p>
      <p>Write the correct letter, <strong>A‚ÄìH</strong>, in boxes <strong>27‚Äì31</strong> on your answer sheet.</p>
      
      <div class="summary-box">
        <strong>How is social history different from historical study?</strong><br>
        Since it became an academic discipline, historical study has been too concerned with a search for <strong>[27]</strong> ______ by researchers who want to develop their careers. Social history, however, is more closely related to the <strong>[28]</strong> ______ of the public. It avoids history‚Äôs traditional focus on <strong>[29]</strong> ______, and its later concentration on <strong>[30]</strong> ______, and it is also different from traditional history in its teaching <strong>[31]</strong> ______, which is derived from different academic subjects.
      </div>
      
      <div class="options-grid">
        <div class="option-item"><strong>A</strong> methodology</div>
        <div class="option-item"><strong>B</strong> needs</div>
        <div class="option-item"><strong>C</strong> originality</div>
        <div class="option-item"><strong>D</strong> important people</div>
        <div class="option-item"><strong>E</strong> accuracy</div>
        <div class="option-item"><strong>F</strong> interests and feelings</div>
        <div class="option-item"><strong>G</strong> explanation</div>
        <div class="option-item"><strong>H</strong> organisational matters</div>
      </div>

      <ol start="27">
        <li><span class="flag-btn" data-q="q27" style="left:-20px;"></span>
          <label><input type="radio" name="q27" value="A"> A</label>
          <label><input type="radio" name="q27" value="B"> B</label>
          <label><input type="radio" name="q27" value="C"> C</label>
          <label><input type="radio" name="q27" value="D"> D</label>
          <label><input type="radio" name="q27" value="E"> E</label>
          <label><input type="radio" name="q27" value="F"> F</label>
          <label><input type="radio" name="q27" value="G"> G</label>
          <label><input type="radio" name="q27" value="H"> H</label>
        </li>
        <li><span class="flag-btn" data-q="q28" style="left:-20px;"></span>
          <label><input type="radio" name="q28" value="A"> A</label>
          <label><input type="radio" name="q28" value="B"> B</label>
          <label><input type="radio" name="q28" value="C"> C</label>
          <label><input type="radio" name="q28" value="D"> D</label>
          <label><input type="radio" name="q28" value="E"> E</label>
          <label><input type="radio" name="q28" value="F"> F</label>
          <label><input type="radio" name="q28" value="G"> G</label>
          <label><input type="radio" name="q28" value="H"> H</label>
        </li>
        <li><span class="flag-btn" data-q="q29" style="left:-20px;"></span>
          <label><input type="radio" name="q29" value="A"> A</label>
          <label><input type="radio" name="q29" value="B"> B</label>
          <label><input type="radio" name="q29" value="C"> C</label>
          <label><input type="radio" name="q29" value="D"> D</label>
          <label><input type="radio" name="q29" value="E"> E</label>
          <label><input type="radio" name="q29" value="F"> F</label>
          <label><input type="radio" name="q29" value="G"> G</label>
          <label><input type="radio" name="q29" value="H"> H</label>
        </li>
        <li><span class="flag-btn" data-q="q30" style="left:-20px;"></span>
          <label><input type="radio" name="q30" value="A"> A</label>
          <label><input type="radio" name="q30" value="B"> B</label>
          <label><input type="radio" name="q30" value="C"> C</label>
          <label><input type="radio" name="q30" value="D"> D</label>
          <label><input type="radio" name="q30" value="E"> E</label>
          <label><input type="radio" name="q30" value="F"> F</label>
          <label><input type="radio" name="q30" value="G"> G</label>
          <label><input type="radio" name="q30" value="H"> H</label>
        </li>
        <li><span class="flag-btn" data-q="q31" style="left:-20px;"></span>
          <label><input type="radio" name="q31" value="A"> A</label>
          <label><input type="radio" name="q31" value="B"> B</label>
          <label><input type="radio" name="q31" value="C"> C</label>
          <label><input type="radio" name="q31" value="D"> D</label>
          <label><input type="radio" name="q31" value="E"> E</label>
          <label><input type="radio" name="q31" value="F"> F</label>
          <label><input type="radio" name="q31" value="G"> G</label>
          <label><input type="radio" name="q31" value="H"> H</label>
        </li>
      </ol>
    </div>

    <div class="group">
      <h4>Questions 32‚Äì35</h4>
      <p>Do the following statements agree with the claims of the writer in Reading Passage 3?</p>
      <p>In boxes <strong>32‚Äì35</strong> on your answer sheet, write</p>
      <div style="margin-left:20px; margin-top:8px; font-size:13px; margin-bottom:12px;">
        <div><strong>YES</strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if the statement agrees with the claims of the writer</div>
        <div><strong>NO</strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if the statement contradicts the claims of the writer</div>
        <div><strong>NOT GIVEN</strong>&nbsp;&nbsp;if it is impossible to say what the writer thinks about this</div>
      </div>

      <ol start="32">
        <li><span class="flag-btn" data-q="q32" style="left:-20px;"></span>The rise of social history led to the cultural revolution of the 1960s.<br>
          <label><input type="radio" name="q32" value="YES"> YES</label>
          <label><input type="radio" name="q32" value="NO"> NO</label>
          <label><input type="radio" name="q32" value="NOT GIVEN"> NOT GIVEN</label>
        </li>
        <li><span class="flag-btn" data-q="q33" style="left:-20px;"></span>Social historians tend to study a later period of history than traditional historians did.<br>
          <label><input type="radio" name="q33" value="YES"> YES</label>
          <label><input type="radio" name="q33" value="NO"> NO</label>
          <label><input type="radio" name="q33" value="NOT GIVEN"> NOT GIVEN</label>
        </li>
        <li><span class="flag-btn" data-q="q34" style="left:-20px;"></span>British cinema in the 1960s lacked any working-class characters.<br>
          <label><input type="radio" name="q34" value="YES"> YES</label>
          <label><input type="radio" name="q34" value="NO"> NO</label>
          <label><input type="radio" name="q34" value="NOT GIVEN"> NOT GIVEN</label>
        </li>
        <li><span class="flag-btn" data-q="q35" style="left:-20px;"></span>The loss of respect for authority in the 1960s was a leading cause of social problems.<br>
          <label><input type="radio" name="q35" value="YES"> YES</label>
          <label><input type="radio" name="q35" value="NO"> NO</label>
          <label><input type="radio" name="q35" value="NOT GIVEN"> NOT GIVEN</label>
        </li>
      </ol>
    </div>

    <div class="group">
      <h4>Questions 36‚Äì40</h4>
      <p>Choose the correct letter, <strong>A, B, C</strong> or <strong>D</strong>.</p>
      <p>Write the correct letter in boxes <strong>36‚Äì40</strong> on your answer sheet.</p>

      <ol start="36">
        <li><span class="flag-btn" data-q="q36" style="left:-20px;"></span>What point is made about the ‚Äònostalgia industry‚Äô?<br>
          <label style="display:block;"><input type="radio" name="q36" value="A"> A. Its products were not always genuine historical items.</label>
          <label style="display:block;"><input type="radio" name="q36" value="B"> B. It led to the abandonment of modernisation.</label>
          <label style="display:block;"><input type="radio" name="q36" value="C"> C. Its origins were political rather than industrial.</label>
          <label style="display:block;"><input type="radio" name="q36" value="D"> D. It opposed the dominant trend of the time.</label>
        </li>
        <li><span class="flag-btn" data-q="q37" style="left:-20px;"></span>In the sixth paragraph, the writer makes the point that in the 1960s<br>
          <label style="display:block;"><input type="radio" name="q37" value="A"> A. construction workers gained greater status.</label>
          <label style="display:block;"><input type="radio" name="q37" value="B"> B. there was a new interest in traditional industrial buildings.</label>
          <label style="display:block;"><input type="radio" name="q37" value="C"> C. architects applied industrial techniques to home design.</label>
          <label style="display:block;"><input type="radio" name="q37" value="D"> D. many older homes were unsuitable as places of residence.</label>
        </li>
        <li><span class="flag-btn" data-q="q38" style="left:-20px;"></span>By the 1970s, historians had come to believe that<br>
          <label style="display:block;"><input type="radio" name="q38" value="A"> A. researchers should focus on the immediate past.</label>
          <label style="display:block;"><input type="radio" name="q38" value="B"> B. modern life is not necessarily an improvement on the past.</label>
          <label style="display:block;"><input type="radio" name="q38" value="C"> C. they should not overemphasise the difficulties of life in the past.</label>
          <label style="display:block;"><input type="radio" name="q38" value="D"> D. there was a need for more ‚Äòordinary‚Äô people to do research into the past.</label>
        </li>
        <li><span class="flag-btn" data-q="q39" style="left:-20px;"></span>One problem related to the use of detail by social historians is that<br>
          <label style="display:block;"><input type="radio" name="q39" value="A"> A. the wrong types of facts are collected.</label>
          <label style="display:block;"><input type="radio" name="q39" value="B"> B. some information may be hard to categorise.</label>
          <label style="display:block;"><input type="radio" name="q39" value="C"> C. more important issues may be ignored.</label>
          <label style="display:block;"><input type="radio" name="q39" value="D"> D. some of the data may be incorrect.</label>
        </li>
        <li><span class="flag-btn" data-q="q40" style="left:-20px;"></span>The writer recommends that to be effective, social history must<br>
          <label style="display:block;"><input type="radio" name="q40" value="A"> A. explore the negative emotions that are part of daily life.</label>
          <label style="display:block;"><input type="radio" name="q40" value="B"> B. build on what has already been established by historians.</label>
          <label style="display:block;"><input type="radio" name="q40" value="C"> C. try to provide an objective view of the recent past.</label>
          <label style="display:block;"><input type="radio" name="q40" value="D"> D. offer solutions to the pressing problems of our day.</label>
        </li>
      </ol>
    </div>

    <div class="bottom-bar">
      <button class="btn-primary" onclick="submitAnswers()">Êèê‰∫§</button>
      <button onclick="resetForm()">ÈáçÁΩÆ</button>
      <button onclick="openWrongBook()">Êú¨ÁØáÈîôÈ¢ò</button>
    </div>
  </section>
</div>

<div id="selbar">
  <button id="btnNote">Note</button>
  <button id="btnHL">Highlight</button>
  <button id="btnUH" style="display:none;">Clear Highlight</button>
</div>

<div class="modal" id="resultModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ÊàêÁª©</h2>
      <span class="modal-close" onclick="closeModal('resultModal')">√ó</span>
    </div>
    <div id="resultContent"></div>
    <button class="btn-primary" style="width:100%; margin-top:16px;" onclick="addWrongToBook()">Âä†ÂÖ•ÈîôÈ¢òÊú¨</button>
  </div>
</div>

<div class="modal" id="wrongBookModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Êú¨ÁØáÈîôÈ¢ò</h2>
      <span class="modal-close" onclick="closeModal('wrongBookModal')">√ó</span>
    </div>
    <div id="wrongBookContent"></div>
  </div>
</div>

<div class="modal" id="resetModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ÈáçÁΩÆÁªÉ‰π†</h2>
      <span class="modal-close" onclick="closeModal('resetModal')">√ó</span>
    </div>
    <div style="margin:16px 0;">
      <label style="display:block; margin-bottom:10px;">
        <input type="radio" name="resetType" value="answers" checked>
        Âè™Ê∏ÖÁ©∫Á≠îÊ°à
      </label>
      <label style="display:block;">
        <input type="radio" name="resetType" value="all">
        Ê∏ÖÁ©∫Á≠îÊ°àÂíåÊ†áËÆ∞
      </label>
    </div>
    <button class="btn-primary" style="width:100%;" onclick="confirmReset()">Á°ÆÂÆö</button>
  </div>
</div>

<script>
const PAPER_ID='P3_SOCIAL_HISTORY';

let t=0;
const timerEl=document.getElementById('timer');
setInterval(()=>{ t++; timerEl.textContent=String(Math.floor(t/60)).padStart(2,'0')+':'+String(t%60).padStart(2,'0'); }, 1000);

const divider=document.getElementById('divider'), left=document.getElementById('left'), right=document.getElementById('right');
let dragging=false;
divider.onmousedown=()=>{ dragging=true; document.body.style.cursor='ew-resize'; };
window.onmousemove=(e)=>{ if(!dragging)return; const c=document.querySelector('.shell').getBoundingClientRect(); let x=e.clientX-c.left; x=Math.max(280,Math.min(c.width-280,x)); left.style.flex='0 0 '+x+'px'; right.style.flex='1 1 auto'; };
window.onmouseup=()=>{ dragging=false; document.body.style.cursor=''; };

const selbar=document.getElementById('selbar'), btnHL=document.getElementById('btnHL'), btnUH=document.getElementById('btnUH'), btnNote=document.getElementById('btnNote');
let lastRange=null, currentHlNode=null;

function posSelbar(r){ selbar.style.display='flex'; const t=window.scrollY+r.top-selbar.offsetHeight-8; const l=window.scrollX+r.left+r.width/2-selbar.offsetWidth/2; selbar.style.top=((t>0)?t:(window.scrollY+r.bottom+8))+'px'; selbar.style.left=Math.max(8,l)+'px'; }

function updSel(){ const s=window.getSelection(); if(!s||s.rangeCount===0||s.isCollapsed){ if(!currentHlNode)selbar.style.display='none'; return; } const r=s.getRangeAt(0); lastRange=r.cloneRange(); currentHlNode=null; btnNote.style.display='block'; btnHL.style.display='block'; btnUH.style.display='none'; posSelbar(r.getBoundingClientRect()); }

left.onmouseup=updSel; right.onmouseup=updSel;
document.onselectionchange=()=>{ const s=window.getSelection(); if((!s||s.rangeCount===0||s.isCollapsed)&&!currentHlNode)selbar.style.display='none'; };
document.addEventListener('click',(e)=>{ if(e.target.classList&&(e.target.classList.contains('hl')||e.target.classList.contains('note'))){ currentHlNode=e.target; lastRange=null; btnNote.style.display='none'; btnHL.style.display='none'; btnUH.style.display='block'; posSelbar(e.target.getBoundingClientRect()); const s=window.getSelection(); if(s)s.removeAllRanges(); }}, true);

btnHL.onclick=()=>{ if(currentHlNode||!lastRange||lastRange.collapsed)return; const s=document.createElement('span'); s.className='hl'; try{ lastRange.surroundContents(s); }catch(e){ const w=document.createElement('span'); w.className='hl'; w.appendChild(lastRange.cloneContents()); lastRange.deleteContents(); lastRange.insertNode(w); } selbar.style.display='none'; saveHighlights(); };

btnNote.onclick=()=>{ if(currentHlNode||!lastRange||lastRange.collapsed)return; const s=document.createElement('span'); s.className='note'; try{ lastRange.surroundContents(s); }catch(e){ const w=document.createElement('span'); w.className='note'; w.appendChild(lastRange.cloneContents()); lastRange.deleteContents(); lastRange.insertNode(w); } selbar.style.display='none'; saveHighlights(); };

btnUH.onclick=()=>{ if(currentHlNode){ const p=currentHlNode.parentNode; while(currentHlNode.firstChild)p.insertBefore(currentHlNode.firstChild,currentHlNode); p.removeChild(currentHlNode); p.normalize(); currentHlNode=null; selbar.style.display='none'; saveHighlights(); }else if(lastRange){ const sR=lastRange.getBoundingClientRect(); const w=document.createTreeWalker(document.body,NodeFilter.SHOW_ELEMENT); const tr=[]; while(w.nextNode()){ const n=w.currentNode; if(n.classList&&(n.classList.contains('hl')||n.classList.contains('note'))){ const r=n.getBoundingClientRect(); if(!(r.right<sR.left||r.left>sR.right||r.bottom<sR.top||r.top>sR.bottom))tr.push(n); }} tr.forEach(el=>{ const p=el.parentNode; while(el.firstChild)p.insertBefore(el.firstChild,el); p.removeChild(el); p.normalize(); }); selbar.style.display='none'; saveHighlights(); }};

document.querySelectorAll('.flag-btn').forEach(btn => {
  btn.onclick = e => {
    e.stopPropagation();
    btn.classList.toggle('active');
    saveFlags();
  };
});

// Answer Key derived from analysis of the text
const answerKey={
  q27:"C", q28:"F", q29:"D", q30:"H", q31:"A",
  q32:"NO", q33:"YES", q34:"NO", q35:"NOT GIVEN",
  q36:"D", q37:"B", q38:"B", q39:"C", q40:"A"
};
let lastResults=[];

function saveAnswers() {
  const data = {};
  Object.keys(answerKey).forEach(q => {
    const ch = document.querySelector(`input[name="${q}"]:checked`);
    if(ch) data[q] = ch.value;
  });
  localStorage.setItem(`${PAPER_ID}_answers`, JSON.stringify(data));
}

function loadAnswers() {
  const data = JSON.parse(localStorage.getItem(`${PAPER_ID}_answers`) || '{}');
  Object.keys(data).forEach(q => {
    const radio = document.querySelector(`input[name="${q}"][value="${data[q]}"]`);
    if(radio) radio.checked = true;
  });
}

function saveFlags() {
  const flags = [...document.querySelectorAll('.flag-btn.active')].map(b => b.dataset.q);
  localStorage.setItem(`${PAPER_ID}_flags`, JSON.stringify(flags));
}

function loadFlags() {
  const flags = JSON.parse(localStorage.getItem(`${PAPER_ID}_flags`) || '[]');
  flags.forEach(q => document.querySelector(`[data-q="${q}"]`)?.classList.add('active'));
}

function saveHighlights() {
  const highlights = { left: [], right: [] };
  document.querySelectorAll('#left .hl, #left .note').forEach((el, idx) => {
    highlights.left.push({
      type: el.classList.contains('hl') ? 'hl' : 'note',
      text: el.textContent,
      index: idx
    });
  });
  document.querySelectorAll('#right .hl, #right .note').forEach((el, idx) => {
    highlights.right.push({
      type: el.classList.contains('hl') ? 'hl' : 'note',
      text: el.textContent,
      index: idx
    });
  });
  localStorage.setItem(`${PAPER_ID}_highlights`, JSON.stringify(highlights));
}

function loadHighlights() {
  const data = JSON.parse(localStorage.getItem(`${PAPER_ID}_highlights`) || '{"left":[],"right":[]}');
  
  const restore = (sectionId, items) => {
    const container = document.getElementById(sectionId);
    items.forEach(item => {
      const walker = document.createTreeWalker(container, NodeFilter.SHOW_TEXT);
      let node;
      while(node = walker.nextNode()) {
        if(node.textContent.includes(item.text)) {
          const span = document.createElement('span');
          span.className = item.type;
          const parent = node.parentNode;
          const text = node.textContent;
          const idx = text.indexOf(item.text);
          if(idx >= 0) {
            const before = text.substring(0, idx);
            const match = text.substring(idx, idx + item.text.length);
            const after = text.substring(idx + item.text.length);
            
            if(before) parent.insertBefore(document.createTextNode(before), node);
            span.textContent = match;
            parent.insertBefore(span, node);
            if(after) parent.insertBefore(document.createTextNode(after), node);
            parent.removeChild(node);
            break;
          }
        }
      }
    });
  };

  if(data.left) restore('left', data.left);
  if(data.right) restore('right', data.right);
}

document.querySelectorAll('input[type="radio"]').forEach(radio => {
  radio.addEventListener('change', saveAnswers);
});

document.addEventListener('DOMContentLoaded', () => {
  loadAnswers();
  loadFlags();
  loadHighlights();
});

function submitAnswers(){ 
  const res=[]; let cor=0; 
  Object.keys(answerKey).forEach(q=>{ 
    const ch=document.querySelector('input[name="'+q+'"]:checked'); 
    const uA=ch?ch.value:""; 
    const cA=answerKey[q]; 
    const iC=uA===cA; 
    if(iC)cor++; 
    res.push({id:q,userAns:uA,correctAns:cA,isCorrect:iC}); 
  }); 
  lastResults=res; 
  const tot=Object.keys(answerKey).length; 
  const pct=((cor/tot)*100).toFixed(1); 
  localStorage.setItem(`ielts_score_${PAPER_ID}`, `${cor}/${tot}`);
  document.getElementById('resultContent').innerHTML=`<div class="result-summary"><div class="result-score">${cor} / ${tot}</div><div style="margin-top:8px;font-size:18px;">${pct}%</div></div>${res.map(r=>`<div class="result-item ${r.isCorrect?'correct':'incorrect'}"><div><strong>${r.id}</strong> ${r.isCorrect?'‚úì':'‚úó'}</div><div>‰Ω†ÁöÑÁ≠îÊ°à: ${r.userAns||'(Êú™‰ΩúÁ≠î)'}</div>${!r.isCorrect?`<div>Ê≠£Á°ÆÁ≠îÊ°à: ${r.correctAns}</div>`:''}</div>`).join('')}`; 
  document.getElementById('resultModal').classList.add('active'); 
}

function resetForm(){ document.getElementById('resetModal').classList.add('active'); }

function confirmReset(){ 
  const tp=document.querySelector('input[name="resetType"]:checked').value; 
  document.querySelectorAll('input[type="radio"]').forEach(i=>i.checked=false); 
  localStorage.removeItem(`${PAPER_ID}_answers`);
  
  if(tp==='all'){ 
    document.querySelectorAll('.hl').forEach(el=>{ const p=el.parentNode; while(el.firstChild)p.insertBefore(el.firstChild,el); p.removeChild(el); p.normalize(); }); 
    document.querySelectorAll('.note').forEach(el=>{ const p=el.parentNode; while(el.firstChild)p.insertBefore(el.firstChild,el); p.removeChild(el); p.normalize(); }); 
    document.querySelectorAll('.flag-btn').forEach(b => b.classList.remove('active'));
    localStorage.removeItem(`${PAPER_ID}_highlights`);
    localStorage.removeItem(`${PAPER_ID}_flags`);
  } 
  closeModal('resetModal'); 
}

function addWrongToBook(){ 
  const wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); 
  const wr=lastResults.filter(r=>!r.isCorrect); 
  wr.forEach(r=>{ 
    const en={paperId:PAPER_ID,title:'What is social history',questionId:r.id,correctAnswer:r.correctAns,myAnswer:r.userAns||'(Êú™‰ΩúÁ≠î)',date:new Date().toISOString().split('T')[0]}; 
    const ix=wb.findIndex(i=>i.paperId===en.paperId&&i.questionId===en.questionId); 
    if(ix>=0)wb[ix]=en; else wb.push(en); 
  }); 
  localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); 
  alert(`Â∑≤Ê∑ªÂä† ${wr.length} ÈÅìÈîôÈ¢ò`); 
  closeModal('resultModal'); 
}

function deleteWrongItem(pId,qId){ 
  if(!confirm('Á°ÆÂÆöÂà†Èô§ËøôÈÅìÈîôÈ¢òÔºü'))return; 
  let wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); 
  wb=wb.filter(i=>!(i.paperId===pId&&i.questionId===qId)); 
  localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); 
  openWrongBook(); 
}

function clearCurrentWrongBook(){ 
  if(!confirm('Á°ÆÂÆöÊ∏ÖÁ©∫Êú¨ÁØáÊâÄÊúâÈîôÈ¢òÔºü'))return; 
  let wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); 
  wb=wb.filter(i=>i.paperId!==PAPER_ID); 
  localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); 
  openWrongBook(); 
}

function openWrongBook(){ 
  const wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); 
  const cu=wb.filter(i=>i.paperId===PAPER_ID); 
  const ct=document.getElementById('wrongBookContent'); 
  if(cu.length===0)ct.innerHTML='<div style="text-align:center;padding:40px;color:#666;">ÊöÇÊó†ÈîôÈ¢ò</div>'; 
  else ct.innerHTML=`<div class="modal-actions"><button class="btn-danger" onclick="clearCurrentWrongBook()" style="width:100%;">üóëÔ∏è Ê∏ÖÁ©∫Êú¨ÁØáÈîôÈ¢ò</button></div>${cu.map(i=>`<div class="wrong-item"><div class="wrong-item-content"><div style="font-weight:600;margin-bottom:8px;">${i.questionId}</div><div style="font-size:13px;color:#666;"><div>‚úì Ê≠£Á°Æ: ${i.correctAnswer}</div><div style="color:#d32f2f;">‚úó ÊàëÁöÑ: ${i.myAnswer}</div></div></div><button class="btn-delete" onclick="deleteWrongItem('${i.paperId}','${i.questionId}')">Âà†Èô§</button></div>`).join('')}`; 
  document.getElementById('wrongBookModal').classList.add('active'); 
}

function closeModal(id){ document.getElementById(id).classList.remove('active'); }
</script>
</body>
</html>
