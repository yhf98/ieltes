<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>P3 ‚Äì Petrol power: an eco-revolution?</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  * { box-sizing: border-box; margin:0; padding:0; }
  html,body { height:100%; }
  body { font-family: Arial, sans-serif; background:#f5f5f5; }
  
  #timer { position:fixed; top:12px; right:12px; background:#fff; border:1px solid #ddd; border-radius:6px; padding:8px 12px; font-size:16px; font-weight:600; color:#0066cc; z-index:1000; }
  
  .shell { display:flex; height:100vh; width:100%; }
  .pane { background:#fff; overflow:auto; padding:24px; }
  #left { flex: 0 0 50%; border-right:1px solid #ddd; }
  #right { flex: 1 1 auto; background:#fafafa; }
  #divider { flex: 0 0 5px; background:#ddd; cursor: ew-resize; }
  #divider:hover { background:#999; }
  
  h2,h3,h4 { margin:0 0 12px; color:#333; }
  h2 { font-size:20px; }
  h3 { font-size:18px; color:#0066cc; }
  h4 { font-size:15px; font-weight:600; margin-top:20px; }
  
  #left p { margin: 0 0 14px; line-height: 1.7; text-align:justify; }
  
  .group { background:#fff; border:1px solid #ddd; border-radius:6px; padding:16px; margin-bottom:16px; }
  .group h4 { margin-top:0; color:#0066cc; }
  .group p { margin:8px 0; font-size:14px; line-height:1.6; }
  
  .headings { background:#f9f9f9; padding:12px; margin:12px 0; border-radius:4px; }
  .headings ol { margin-left:20px; }
  .headings li { margin:4px 0; font-size:13px; }
  
  table { border-collapse: collapse; width:100%; margin:12px 0; }
  th, td { border:1px solid #ddd; padding:6px; text-align:center; font-size:13px; position:relative; }
  th { background:#f5f5f5; font-weight:600; }

  /* Summary Box Styles */
  .summary-box { border: 2px solid #ddd; background: #fdfdfd; padding: 10px; margin-bottom: 15px; border-radius: 4px; }
  .summary-options { display: flex; flex-wrap: wrap; gap: 8px; font-size: 13px; color: #333; margin-top: 8px; }
  .summary-opt { background: #eee; padding: 2px 6px; border-radius: 3px; border: 1px solid #ccc; white-space: nowrap; }
  .gap-fill { display: inline-block; border-bottom: 1px solid #333; min-width: 40px; text-align: center; font-weight: bold; color: #0066cc; }

  .flag-btn { 
    position:absolute; 
    left:2px; 
    top:50%;
    transform:translateY(-50%);
    width:8px;
    height:8px;
    border-radius:50%;
    background:#ddd;
    cursor:pointer;
    z-index:10;
  }
  .flag-btn:hover { background:#999; }
  .flag-btn.active { background:#ff5722; }
  
  tr td:first-child { padding-left:16px; }
  
  .group ol { margin-left:20px; }
  .group ol li { margin:12px 0; font-size:14px; line-height:1.6; position:relative; }
  .group ol li label { display:inline-block; margin-right:8px; cursor: pointer;}
  
  .bottom-bar { display:flex; gap:10px; margin-top:16px; }
  button { padding:10px 20px; border:1px solid #999; border-radius:6px; background:#fff; cursor:pointer; font-size:14px; }
  button:hover { background:#f0f0f0; }
  .btn-primary { background:#0066cc; color:#fff; border-color:#0066cc; }
  .btn-primary:hover { background:#0052a3; }
  .btn-danger { background:#dc3545; color:#fff; border-color:#dc3545; }
  .btn-danger:hover { background:#c82333; }
  
  .hl { background:#fff59d; cursor:pointer; }
  .hl:hover { background:#ffeb3b; }
  .note { background:#b3d9ff; cursor:pointer; }
  .note:hover { background:#99ccff; }
  
  #selbar { position:fixed; display:none; z-index:2000; background:#fff; border:1px solid #ddd; border-radius:8px; padding:8px; gap:0; box-shadow:0 2px 8px rgba(0,0,0,0.15); flex-direction:column; min-width:120px; }
  #selbar button { background:#fff; color:#666; border:none; padding:3px 0px; cursor:pointer; font-size:14px; text-align:center; border-radius:4px; }
  #selbar button:hover { background:#f5f5f5; color:#333; }
  
  .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:3000; align-items:center; justify-content:center; }
  .modal.active { display:flex; }
  .modal-content { background:#fff; border-radius:8px; padding:24px; max-width:600px; width:90%; max-height:80vh; overflow-y:auto; }
  
  .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
  .modal-header h2 { font-size: 28px; color: #333; margin: 0; }
  .modal-close { font-size: 32px; cursor: pointer; color: #999; line-height: 1; }
  .modal-close:hover { color: #333; }
  
  .result-summary { text-align:center; padding:20px; background:#f0f0f0; margin-bottom:16px; border-radius:6px; }
  .result-score { font-size:36px; font-weight:600; color:#0066cc; }
  .result-item { padding:10px; margin:8px 0; border-left:3px solid #ddd; background:#f9f9f9; font-size:13px; }
  .result-item.correct { border-left-color:#28a745; background:#e8f5e9; }
  .result-item.incorrect { border-left-color:#dc3545; background:#ffebee; }
  
  .wrong-item { background:#fff3e0; padding:16px; margin:8px 0; border-radius:8px; border-left:4px solid #ff9800; display:flex; justify-content:space-between; align-items:start; }
  .wrong-item-content { flex:1; }
  .btn-delete { background:#dc3545; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-size:13px; margin-left:12px; }
  .btn-delete:hover { background:#c82333; }
  .modal-actions { display:flex; gap:10px; margin-bottom:20px; }
</style>
</head>
<body>
<div id="timer">00:00</div>

<div class="shell">
  <section class="pane" id="left">
    
<h2>READING PASSAGE 3</h2>
<p>You should spend about 20 minutes on Questions 27‚Äì40, which are based on Reading Passage 3 below.</p>
<h3>Petrol power: an eco-revolution?</h3>

<p>Laura Ingalls Wilder‚Äôs semi-autobiographical novel The Long Winter describes how the inhabitants of a small town called De Smet in the American Midwest narrowly avoided starvation during the severe winter of 1880‚Äì1881. Over three metres of snow fell on the northern plains, immobilising the railways and cutting off the settlers from the rest of the world. Laura and her neighbours were only saved when her fianc√© and his friend trudged 30 kilometres through the snow to fetch food, risking their lives in the process. The story is a reminder of how lethal geographical isolation and crop failures could be before the advent of modern farming and transportation technologies. Not long ago, subsistence farmers in many countries had to cope with the ‚Äòlean season‚Äô ‚Äì the period of greatest scarcity before new crops became available. In England, late spring was once referred to as the ‚Äòhungry gap‚Äô. The situation was made worse by the cost of moving heavy things over muddy dirt roads; three centuries ago, moving goods 50 kilometres on land between, say, Liverpool and Manchester was as expensive as shipping them across the North Atlantic.</p>

<p>The development of coal-powered railways and steamships in the 19th century revolutionized the lives of farmers. Instead of having to grow everything they needed, they could now specialise in what they did best and rely on other producers for their remaining needs. The result was not only food and ever-cheaper prices, but the end of widespread famine and starvation, as the surplus from regions with good harvests could now be transported to those that had experienced mediocre ones. Since then, petroleum-derived fuels have largely displaced coal because of their higher energy density, cleaner combustion and greater ease of extraction, further improving road and rail transportation systems.</p>

<p>While the convenience of modern methods of transportation is obvious, few people grasp their historical significance in terms of their beneficial impact on large cities and the health of residents. In 1898, delegates gathered in New York City for the world‚Äôs first international urban-planning conference.</p>

<p>The topic that dominated discussions was not infrastructure or housing, but horse manure. The problem was that as the populations of cities like New York and London grew, the number of horses there also grew, and in New York these produced nearly two million kilograms of manure each day. If this problem continued, it was estimated that by 1950 every street in London would be buried three metres deep in horse manure. Unable to think of any solution, the delegates concluded that urban living was inherently unsustainable.</p>

<p>Paradoxically, much of the urban manure problem was related to the growth of the railways. The ability to deliver perishable goods, such as meat and dairy products, from locations that benefited from better soil and climate, put many farms located near cities out of business. As these had relied on manure from city workhorses for fertiliser, the demand for this was greatly reduced.</p>

<p>The impact of urban workhorses was felt both in the cities and in the countryside. In cities, apart from their overpowering stench, the manure piles were prime breeding grounds for house flies, perhaps three billion of which hatched each day in US cities in the early 20th century. With flies came outbreaks of typhoid, cholera and diphtheria. Workhorses sometimes panicked in heavy traffic and kicked or bit bystanders. The clatter of wagon wheels on cobblestone pavement could be deafening, and since a horse and wagon occupied more street space than a modern truck, they also created significant traffic congestion, while a horse that collapsed on the road created an obstruction that was difficult to remove. The countryside also suffered. To supply the workhorses with oats and hay, additional land had to be cleared of its natural animal life and vegetation, and sometimes water had to be diverted to irrigate it, with considerable negative effects on the whole area.</p>

<p>So, while the trains, cars and trucks of the early 20th century were noisy and polluting by today‚Äôs standards, they were regarded as a significant improvement on what had gone before. Before they were available, poor soils often meant that a large amount of land was required to sustain a household, and much environmental damage, primarily in the form of soil erosion, was caused by trying to farm these soils. It could be argued that modern transportation allowed the development of remote regions like the Canadian Prairies and allowed more suitable crops to be grown in the poorer soils in Europe before being sold elsewhere.</p>

<p>Over time, the concentration of food production in the world‚Äôs best locations allowed some agricultural land to revert to a wild state. For instance, France benefited from an expansion of its forest area by one third between 1830 and 1960. This so-called ‚Äòforest transition‚Äô occurred in the context of a doubling of the French population and a dramatic increase in standards of living.</p>

<p>Improvements in logistics also allowed the production and export of food from locations where water was abundant to regions where it was scarce, thus preventing the depletion of water resources there. It also made possible a drastic increase in the size of our cities. Contrary to what most people believe, the growth in cities is a positive development. In the words of economist Ed Glaeser: ‚ÄòResiding in a forest might seem to be a good way of showing one‚Äôs love of nature, but living in a concrete jungle is actually far more ecologically friendly‚Ä¶ If you love nature, stay away from it.‚Äô It could be argued that modern transportation technologies have been a major contributor to a wealthier, cleaner and more sustainable world.</p>

  </section>

  <div id="divider" title="Drag to resize"></div>

  <section class="pane" id="right">
    <h3>Questions</h3>

    <div class="group">
      <h4>Questions 27‚Äì30</h4>
      <p>Choose the correct letter, <strong>A, B, C or D</strong>.</p>
      <p>Write the correct letter in boxes <strong>27‚Äì30</strong> on your answer sheet.</p>

      <ol start="27">
        <li><span class="flag-btn" data-q="q27" style="left:-20px;"></span>Why were the inhabitants of De Smet in danger of starvation?<br>
          <label><input type="radio" name="q27" value="A"> A. The trains were unable to operate normally.</label><br>
          <label><input type="radio" name="q27" value="B"> B. The harvest had been completely destroyed.</label><br>
          <label><input type="radio" name="q27" value="C"> C. The roads to the town had not yet been built.</label><br>
          <label><input type="radio" name="q27" value="D"> D. The farmers were reluctant to sell their produce.</label>
        </li>
        <li><span class="flag-btn" data-q="q28" style="left:-20px;"></span>What problem did subsistence farmers have in the past?<br>
          <label><input type="radio" name="q28" value="A"> A. They had no effective means of storing food.</label><br>
          <label><input type="radio" name="q28" value="B"> B. Food was expensive because of high shipping costs.</label><br>
          <label><input type="radio" name="q28" value="C"> C. Their access to food was limited at certain times.</label><br>
          <label><input type="radio" name="q28" value="D"> D. Food could not be transported for long distances by road.</label>
        </li>
        <li><span class="flag-btn" data-q="q29" style="left:-20px;"></span>The writer says that the use of coal to power railways and steamships<br>
          <label><input type="radio" name="q29" value="A"> A. led to a greater range of fresh vegetables being available in urban areas.</label><br>
          <label><input type="radio" name="q29" value="B"> B. was less efficient than the use of petroleum-derived products.</label><br>
          <label><input type="radio" name="q29" value="C"> C. allowed farmers to be more self-sufficient than they were previously.</label><br>
          <label><input type="radio" name="q29" value="D"> D. was better for the environment than using petroleum-derived products.</label>
        </li>
        <li><span class="flag-btn" data-q="q30" style="left:-20px;"></span>The writer refers to an urban-planning conference held in 1898 in order to<br>
          <label><input type="radio" name="q30" value="A"> A. illustrate a problem that was later solved by modern technology.</label><br>
          <label><input type="radio" name="q30" value="B"> B. give an example of poor decisions made about urban planning.</label><br>
          <label><input type="radio" name="q30" value="C"> C. show that urban issues were misunderstood in the past.</label><br>
          <label><input type="radio" name="q30" value="D"> D. indicate the disregard at the time for public health concerns.</label>
        </li>
      </ol>
    </div>

    <div class="group">
      <h4>Questions 31‚Äì35</h4>
      <p>Complete the summary using the list of words, <strong>A‚ÄìJ</strong>, below.</p>
      <p>Write the correct letter, <strong>A‚ÄìJ</strong>, in boxes <strong>31‚Äì35</strong> on your answer sheet.</p>
      
      <div class="summary-box">
        <p><strong>Problems caused by urban workhorses</strong></p>
        <p>In cities, the large amounts of horse manure led to <span class="gap-fill">31</span> in the streets and were also linked to the spread of <span class="gap-fill">32</span>. In certain situations, the horses might even cause <span class="gap-fill">33</span> to passers-by. There were also the problems of noise and congestion caused by horse-drawn vehicles. In the countryside, there were problems too. The <span class="gap-fill">34</span> was damaged because of the need to provide <span class="gap-fill">35</span> for urban workhorses.</p>
      </div>

      <div class="summary-box">
        <strong>List of Options</strong>
        <div class="summary-options">
           <span class="summary-opt">A rich landowners</span>
           <span class="summary-opt">B injuries</span>
           <span class="summary-opt">C food</span>
           <span class="summary-opt">D accidental falls</span>
           <span class="summary-opt">E environment</span>
           <span class="summary-opt">F dangerous area</span>
           <span class="summary-opt">G use of irrigation</span>
           <span class="summary-opt">H unpleasant smells</span>
           <span class="summary-opt">I treatment</span>
           <span class="summary-opt">J diseases</span>
        </div>
      </div>

      <ol start="31">
        <li><span class="flag-btn" data-q="q31" style="left:-20px;"></span>31. <br>
          <label><input type="radio" name="q31" value="A"> A</label> <label><input type="radio" name="q31" value="B"> B</label> <label><input type="radio" name="q31" value="C"> C</label> <label><input type="radio" name="q31" value="D"> D</label> <label><input type="radio" name="q31" value="E"> E</label> <label><input type="radio" name="q31" value="F"> F</label> <label><input type="radio" name="q31" value="G"> G</label> <label><input type="radio" name="q31" value="H"> H</label> <label><input type="radio" name="q31" value="I"> I</label> <label><input type="radio" name="q31" value="J"> J</label>
        </li>
        <li><span class="flag-btn" data-q="q32" style="left:-20px;"></span>32. <br>
          <label><input type="radio" name="q32" value="A"> A</label> <label><input type="radio" name="q32" value="B"> B</label> <label><input type="radio" name="q32" value="C"> C</label> <label><input type="radio" name="q32" value="D"> D</label> <label><input type="radio" name="q32" value="E"> E</label> <label><input type="radio" name="q32" value="F"> F</label> <label><input type="radio" name="q32" value="G"> G</label> <label><input type="radio" name="q32" value="H"> H</label> <label><input type="radio" name="q32" value="I"> I</label> <label><input type="radio" name="q32" value="J"> J</label>
        </li>
        <li><span class="flag-btn" data-q="q33" style="left:-20px;"></span>33. <br>
          <label><input type="radio" name="q33" value="A"> A</label> <label><input type="radio" name="q33" value="B"> B</label> <label><input type="radio" name="q33" value="C"> C</label> <label><input type="radio" name="q33" value="D"> D</label> <label><input type="radio" name="q33" value="E"> E</label> <label><input type="radio" name="q33" value="F"> F</label> <label><input type="radio" name="q33" value="G"> G</label> <label><input type="radio" name="q33" value="H"> H</label> <label><input type="radio" name="q33" value="I"> I</label> <label><input type="radio" name="q33" value="J"> J</label>
        </li>
        <li><span class="flag-btn" data-q="q34" style="left:-20px;"></span>34. <br>
          <label><input type="radio" name="q34" value="A"> A</label> <label><input type="radio" name="q34" value="B"> B</label> <label><input type="radio" name="q34" value="C"> C</label> <label><input type="radio" name="q34" value="D"> D</label> <label><input type="radio" name="q34" value="E"> E</label> <label><input type="radio" name="q34" value="F"> F</label> <label><input type="radio" name="q34" value="G"> G</label> <label><input type="radio" name="q34" value="H"> H</label> <label><input type="radio" name="q34" value="I"> I</label> <label><input type="radio" name="q34" value="J"> J</label>
        </li>
        <li><span class="flag-btn" data-q="q35" style="left:-20px;"></span>35. <br>
          <label><input type="radio" name="q35" value="A"> A</label> <label><input type="radio" name="q35" value="B"> B</label> <label><input type="radio" name="q35" value="C"> C</label> <label><input type="radio" name="q35" value="D"> D</label> <label><input type="radio" name="q35" value="E"> E</label> <label><input type="radio" name="q35" value="F"> F</label> <label><input type="radio" name="q35" value="G"> G</label> <label><input type="radio" name="q35" value="H"> H</label> <label><input type="radio" name="q35" value="I"> I</label> <label><input type="radio" name="q35" value="J"> J</label>
        </li>
      </ol>
    </div>

    <div class="group">
      <h4>Questions 36‚Äì40</h4>
      <p>Do the following statements agree with the views of the writer in Reading Passage 3?</p>
      <p>In boxes <strong>36‚Äì40</strong> on your answer sheet, write</p>
      <div style="margin-left:20px; margin-top:8px;">
        <div><strong>YES</strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if the statement agrees with the views of the writer</div>
        <div><strong>NO</strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if the statement contradicts the views of the writer</div>
        <div><strong>NOT GIVEN</strong>&nbsp;&nbsp;if it is impossible to say what the writer thinks about this</div>
      </div>

      <ol start="36">
        <li><span class="flag-btn" data-q="q36" style="left:-20px;"></span>Farmers whose land was poor failed to benefit from modern forms of transport.<br>
          <label><input type="radio" name="q36" value="YES"> YES</label>
          <label><input type="radio" name="q36" value="NO"> NO</label>
          <label><input type="radio" name="q36" value="NOT GIVEN"> NOT GIVEN</label>
        </li>
        <li><span class="flag-btn" data-q="q37" style="left:-20px;"></span>Between 1830 and 1960 there were positive effects associated with changing patterns of agriculture in France.<br>
          <label><input type="radio" name="q37" value="YES"> YES</label>
          <label><input type="radio" name="q37" value="NO"> NO</label>
          <label><input type="radio" name="q37" value="NOT GIVEN"> NOT GIVEN</label>
        </li>
        <li><span class="flag-btn" data-q="q38" style="left:-20px;"></span>A fairer distribution of the world‚Äôs water resources is needed.<br>
          <label><input type="radio" name="q38" value="YES"> YES</label>
          <label><input type="radio" name="q38" value="NO"> NO</label>
          <label><input type="radio" name="q38" value="NOT GIVEN"> NOT GIVEN</label>
        </li>
        <li><span class="flag-btn" data-q="q39" style="left:-20px;"></span>Living in the countryside does less harm to the environment than living in a city.<br>
          <label><input type="radio" name="q39" value="YES"> YES</label>
          <label><input type="radio" name="q39" value="NO"> NO</label>
          <label><input type="radio" name="q39" value="NOT GIVEN"> NOT GIVEN</label>
        </li>
        <li><span class="flag-btn" data-q="q40" style="left:-20px;"></span>It is possible that modern developments in transportation have had an beneficial impact on the world.<br>
          <label><input type="radio" name="q40" value="YES"> YES</label>
          <label><input type="radio" name="q40" value="NO"> NO</label>
          <label><input type="radio" name="q40" value="NOT GIVEN"> NOT GIVEN</label>
        </li>
      </ol>
    </div>

    <div class="bottom-bar">
      <button class="btn-primary" onclick="submitAnswers()">Êèê‰∫§</button>
      <button onclick="resetForm()">ÈáçÁΩÆ</button>
      <button onclick="openWrongBook()">Êú¨ÁØáÈîôÈ¢ò</button>
    </div>
  </section>
</div>

<div id="selbar">
  <button id="btnNote">Note</button>
  <button id="btnHL">Highlight</button>
  <button id="btnUH" style="display:none;">Clear Highlight</button>
</div>

<div class="modal" id="resultModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ÊàêÁª©</h2>
      <span class="modal-close" onclick="closeModal('resultModal')">√ó</span>
    </div>
    <div id="resultContent"></div>
    <button class="btn-primary" style="width:100%; margin-top:16px;" onclick="addWrongToBook()">Âä†ÂÖ•ÈîôÈ¢òÊú¨</button>
  </div>
</div>

<div class="modal" id="wrongBookModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Êú¨ÁØáÈîôÈ¢ò</h2>
      <span class="modal-close" onclick="closeModal('wrongBookModal')">√ó</span>
    </div>
    <div id="wrongBookContent"></div>
  </div>
</div>

<div class="modal" id="resetModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ÈáçÁΩÆÁªÉ‰π†</h2>
      <span class="modal-close" onclick="closeModal('resetModal')">√ó</span>
    </div>
    <div style="margin:16px 0;">
      <label style="display:block; margin-bottom:10px;">
        <input type="radio" name="resetType" value="answers" checked>
        Âè™Ê∏ÖÁ©∫Á≠îÊ°à
      </label>
      <label style="display:block;">
        <input type="radio" name="resetType" value="all">
        Ê∏ÖÁ©∫Á≠îÊ°àÂíåÊ†áËÆ∞
      </label>
    </div>
    <button class="btn-primary" style="width:100%;" onclick="confirmReset()">Á°ÆÂÆö</button>
  </div>
</div>

<script>
const PAPER_ID='P3_PETROL_POWER';

let t=0;
const timerEl=document.getElementById('timer');
setInterval(()=>{ t++; timerEl.textContent=String(Math.floor(t/60)).padStart(2,'0')+':'+String(t%60).padStart(2,'0'); }, 1000);

const divider=document.getElementById('divider'), left=document.getElementById('left'), right=document.getElementById('right');
let dragging=false;
divider.onmousedown=()=>{ dragging=true; document.body.style.cursor='ew-resize'; };
window.onmousemove=(e)=>{ if(!dragging)return; const c=document.querySelector('.shell').getBoundingClientRect(); let x=e.clientX-c.left; x=Math.max(280,Math.min(c.width-280,x)); left.style.flex='0 0 '+x+'px'; right.style.flex='1 1 auto'; };
window.onmouseup=()=>{ dragging=false; document.body.style.cursor=''; };

const selbar=document.getElementById('selbar'), btnHL=document.getElementById('btnHL'), btnUH=document.getElementById('btnUH'), btnNote=document.getElementById('btnNote');
let lastRange=null, currentHlNode=null;

function posSelbar(r){ selbar.style.display='flex'; const t=window.scrollY+r.top-selbar.offsetHeight-8; const l=window.scrollX+r.left+r.width/2-selbar.offsetWidth/2; selbar.style.top=((t>0)?t:(window.scrollY+r.bottom+8))+'px'; selbar.style.left=Math.max(8,l)+'px'; }

function updSel(){ const s=window.getSelection(); if(!s||s.rangeCount===0||s.isCollapsed){ if(!currentHlNode)selbar.style.display='none'; return; } const r=s.getRangeAt(0); lastRange=r.cloneRange(); currentHlNode=null; btnNote.style.display='block'; btnHL.style.display='block'; btnUH.style.display='none'; posSelbar(r.getBoundingClientRect()); }

left.onmouseup=updSel; right.onmouseup=updSel;
document.onselectionchange=()=>{ const s=window.getSelection(); if((!s||s.rangeCount===0||s.isCollapsed)&&!currentHlNode)selbar.style.display='none'; };
document.addEventListener('click',(e)=>{ if(e.target.classList&&(e.target.classList.contains('hl')||e.target.classList.contains('note'))){ currentHlNode=e.target; lastRange=null; btnNote.style.display='none'; btnHL.style.display='none'; btnUH.style.display='block'; posSelbar(e.target.getBoundingClientRect()); const s=window.getSelection(); if(s)s.removeAllRanges(); }}, true);

btnHL.onclick=()=>{ if(currentHlNode||!lastRange||lastRange.collapsed)return; const s=document.createElement('span'); s.className='hl'; try{ lastRange.surroundContents(s); }catch(e){ const w=document.createElement('span'); w.className='hl'; w.appendChild(lastRange.cloneContents()); lastRange.deleteContents(); lastRange.insertNode(w); } selbar.style.display='none'; saveHighlights(); };

btnNote.onclick=()=>{ if(currentHlNode||!lastRange||lastRange.collapsed)return; const s=document.createElement('span'); s.className='note'; try{ lastRange.surroundContents(s); }catch(e){ const w=document.createElement('span'); w.className='note'; w.appendChild(lastRange.cloneContents()); lastRange.deleteContents(); lastRange.insertNode(w); } selbar.style.display='none'; saveHighlights(); };

btnUH.onclick=()=>{ if(currentHlNode){ const p=currentHlNode.parentNode; while(currentHlNode.firstChild)p.insertBefore(currentHlNode.firstChild,currentHlNode); p.removeChild(currentHlNode); p.normalize(); currentHlNode=null; selbar.style.display='none'; saveHighlights(); }else if(lastRange){ const sR=lastRange.getBoundingClientRect(); const w=document.createTreeWalker(document.body,NodeFilter.SHOW_ELEMENT); const tr=[]; while(w.nextNode()){ const n=w.currentNode; if(n.classList&&(n.classList.contains('hl')||n.classList.contains('note'))){ const r=n.getBoundingClientRect(); if(!(r.right<sR.left||r.left>sR.right||r.bottom<sR.top||r.top>sR.bottom))tr.push(n); }} tr.forEach(el=>{ const p=el.parentNode; while(el.firstChild)p.insertBefore(el.firstChild,el); p.removeChild(el); p.normalize(); }); selbar.style.display='none'; saveHighlights(); }};

document.querySelectorAll('.flag-btn').forEach(btn => {
  btn.onclick = e => {
    e.stopPropagation();
    btn.classList.toggle('active');
    saveFlags();
  };
});

// Answers based on Reading Passage 3 - Petrol power: an eco-revolution?
const answerKey={
  q27:"A", 
  q28:"C", 
  q29:"B", 
  q30:"A", 
  q31:"H", 
  q32:"J", 
  q33:"B", 
  q34:"E", 
  q35:"C", 
  q36:"NO", 
  q37:"YES", 
  q38:"NOT GIVEN", 
  q39:"NO", 
  q40:"YES"
};
let lastResults=[];

function saveAnswers() {
  const data = {};
  Object.keys(answerKey).forEach(q => {
    const ch = document.querySelector(`input[name="${q}"]:checked`);
    if(ch) data[q] = ch.value;
  });
  localStorage.setItem(`${PAPER_ID}_answers`, JSON.stringify(data));
}

function loadAnswers() {
  const data = JSON.parse(localStorage.getItem(`${PAPER_ID}_answers`) || '{}');
  Object.keys(data).forEach(q => {
    const radio = document.querySelector(`input[name="${q}"][value="${data[q]}"]`);
    if(radio) radio.checked = true;
  });
}

function saveFlags() {
  const flags = [...document.querySelectorAll('.flag-btn.active')].map(b => b.dataset.q);
  localStorage.setItem(`${PAPER_ID}_flags`, JSON.stringify(flags));
}

function loadFlags() {
  const flags = JSON.parse(localStorage.getItem(`${PAPER_ID}_flags`) || '[]');
  flags.forEach(q => document.querySelector(`[data-q="${q}"]`)?.classList.add('active'));
}

function saveHighlights() {
  const highlights = { left: [], right: [] };
  document.querySelectorAll('#left .hl, #left .note').forEach((el, idx) => {
    highlights.left.push({
      type: el.classList.contains('hl') ? 'hl' : 'note',
      text: el.textContent,
      index: idx
    });
  });
  document.querySelectorAll('#right .hl, #right .note').forEach((el, idx) => {
    highlights.right.push({
      type: el.classList.contains('hl') ? 'hl' : 'note',
      text: el.textContent,
      index: idx
    });
  });
  localStorage.setItem(`${PAPER_ID}_highlights`, JSON.stringify(highlights));
}

function loadHighlights() {
  const data = JSON.parse(localStorage.getItem(`${PAPER_ID}_highlights`) || '{"left":[],"right":[]}');
  
  if(data.left && data.left.length > 0) {
    data.left.forEach(item => {
      const walker = document.createTreeWalker(left, NodeFilter.SHOW_TEXT);
      let node;
      while(node = walker.nextNode()) {
        if(node.textContent.includes(item.text)) {
          const span = document.createElement('span');
          span.className = item.type;
          const parent = node.parentNode;
          const text = node.textContent;
          const idx = text.indexOf(item.text);
          if(idx >= 0) {
            const before = text.substring(0, idx);
            const match = text.substring(idx, idx + item.text.length);
            const after = text.substring(idx + item.text.length);
            
            parent.insertBefore(document.createTextNode(before), node);
            span.textContent = match;
            parent.insertBefore(span, node);
            parent.insertBefore(document.createTextNode(after), node);
            parent.removeChild(node);
            break;
          }
        }
      }
    });
  }
  
  if(data.right && data.right.length > 0) {
    data.right.forEach(item => {
      const walker = document.createTreeWalker(right, NodeFilter.SHOW_TEXT);
      let node;
      while(node = walker.nextNode()) {
        if(node.textContent.includes(item.text)) {
          const span = document.createElement('span');
          span.className = item.type;
          const parent = node.parentNode;
          const text = node.textContent;
          const idx = text.indexOf(item.text);
          if(idx >= 0) {
            const before = text.substring(0, idx);
            const match = text.substring(idx, idx + item.text.length);
            const after = text.substring(idx + item.text.length);
            
            parent.insertBefore(document.createTextNode(before), node);
            span.textContent = match;
            parent.insertBefore(span, node);
            parent.insertBefore(document.createTextNode(after), node);
            parent.removeChild(node);
            break;
          }
        }
      }
    });
  }
}

document.querySelectorAll('input[type="radio"]').forEach(radio => {
  radio.addEventListener('change', saveAnswers);
});

document.addEventListener('DOMContentLoaded', () => {
  loadAnswers();
  loadFlags();
  loadHighlights();
});

function submitAnswers(){ 
  const res=[]; 
  let cor=0; 
  Object.keys(answerKey).forEach(q=>{ 
    const ch=document.querySelector('input[name="'+q+'"]:checked'); 
    const uA=ch?ch.value:""; 
    const cA=answerKey[q]; 
    const iC=uA===cA; 
    if(iC)cor++; 
    res.push({id:q,userAns:uA,correctAns:cA,isCorrect:iC}); 
  }); 
  lastResults=res; 
  const tot=Object.keys(answerKey).length; 
  const pct=((cor/tot)*100).toFixed(1); 
  localStorage.setItem(`ielts_score_${PAPER_ID}`, `${cor}/${tot}`);
  
  document.getElementById('resultContent').innerHTML=`<div class="result-summary"><div class="result-score">${cor} / ${tot}</div><div style="margin-top:8px;font-size:18px;">${pct}%</div></div>${res.map(r=>`<div class="result-item ${r.isCorrect?'correct':'incorrect'}"><div><strong>${r.id}</strong> ${r.isCorrect?'‚úì':'‚úó'}</div><div>‰Ω†ÁöÑÁ≠îÊ°à: ${r.userAns||'(Êú™‰ΩúÁ≠î)'}</div>${!r.isCorrect?`<div>Ê≠£Á°ÆÁ≠îÊ°à: ${r.correctAns}</div>`:''}</div>`).join('')}`; 
  document.getElementById('resultModal').classList.add('active'); 
}

function resetForm(){ document.getElementById('resetModal').classList.add('active'); }

function confirmReset(){ 
  const tp=document.querySelector('input[name="resetType"]:checked').value; 
  document.querySelectorAll('input[type="radio"]').forEach(i=>i.checked=false); 
  localStorage.removeItem(`${PAPER_ID}_answers`);
  
  if(tp==='all'){ 
    document.querySelectorAll('.hl').forEach(el=>{ const p=el.parentNode; while(el.firstChild)p.insertBefore(el.firstChild,el); p.removeChild(el); p.normalize(); }); 
    document.querySelectorAll('.note').forEach(el=>{ const p=el.parentNode; while(el.firstChild)p.insertBefore(el.firstChild,el); p.removeChild(el); p.normalize(); }); 
    document.querySelectorAll('.flag-btn').forEach(b => b.classList.remove('active'));
    localStorage.removeItem(`${PAPER_ID}_highlights`);
    localStorage.removeItem(`${PAPER_ID}_flags`);
  } 
  closeModal('resetModal'); 
}

function addWrongToBook(){ 
  const wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); 
  const wr=lastResults.filter(r=>!r.isCorrect); 
  wr.forEach(r=>{ 
    const en={paperId:PAPER_ID,title:'Petrol power: an eco-revolution?',questionId:r.id,correctAnswer:r.correctAns,myAnswer:r.userAns||'(Êú™‰ΩúÁ≠î)',date:new Date().toISOString().split('T')[0]}; 
    const ix=wb.findIndex(i=>i.paperId===en.paperId&&i.questionId===en.questionId); 
    if(ix>=0)wb[ix]=en; else wb.push(en); 
  }); 
  localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); 
  alert(`Â∑≤Ê∑ªÂä† ${wr.length} ÈÅìÈîôÈ¢ò`); 
  closeModal('resultModal'); 
}

function deleteWrongItem(pId,qId){ if(!confirm('Á°ÆÂÆöÂà†Èô§ËøôÈÅìÈîôÈ¢òÔºü'))return; let wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); wb=wb.filter(i=>!(i.paperId===pId&&i.questionId===qId)); localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); openWrongBook(); }

function clearCurrentWrongBook(){ if(!confirm('Á°ÆÂÆöÊ∏ÖÁ©∫Êú¨ÁØáÊâÄÊúâÈîôÈ¢òÔºü'))return; let wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); wb=wb.filter(i=>i.paperId!==PAPER_ID); localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); openWrongBook(); }

function openWrongBook(){ 
  const wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); 
  const cu=wb.filter(i=>i.paperId===PAPER_ID); 
  const ct=document.getElementById('wrongBookContent'); 
  if(cu.length===0)ct.innerHTML='<div style="text-align:center;padding:40px;color:#666;">ÊöÇÊó†ÈîôÈ¢ò</div>'; 
  else ct.innerHTML=`<div class="modal-actions"><button class="btn-danger" onclick="clearCurrentWrongBook()" stylewidth:100%;">üóëÔ∏è Ê∏ÖÁ©∫Êú¨ÁØáÈîôÈ¢ò</button></div>${cu.map(i=>`<div class="wrong-item"><div class="wrong-item-content"><div style="font-weight:600;margin-bottom:8px;">${i.questionId}</div><div style="font-size:13px;color:#666;"><div>‚úì Ê≠£Á°Æ: ${i.correctAnswer}</div><div style="color:#d32f2f;">‚úó ÊàëÁöÑ: ${i.myAnswer}</div></div></div><button class="btn-delete" onclick="deleteWrongItem('${i.paperId}','${i.questionId}')">Âà†Èô§</button></div>`).join('')}`; 
  document.getElementById('wrongBookModal').classList.add('active'); 
}

function closeModal(id){ document.getElementById(id).classList.remove('active'); }
</script>
</body>
</html>
