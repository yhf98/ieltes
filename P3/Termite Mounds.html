<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>P3 ‚Äì Termite Mounds</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  * { box-sizing: border-box; margin:0; padding:0; }
  html,body { height:100%; }
  body { font-family: Arial, sans-serif; background:#f5f5f5; }
  
  #timer { position:fixed; top:12px; right:12px; background:#fff; border:1px solid #ddd; border-radius:6px; padding:8px 12px; font-size:16px; font-weight:600; color:#0066cc; z-index:1000; }
  
  .shell { display:flex; height:100vh; width:100%; }
  .pane { background:#fff; overflow:auto; padding:24px; }
  #left { flex: 0 0 50%; border-right:1px solid #ddd; }
  #right { flex: 1 1 auto; background:#fafafa; }
  #divider { flex: 0 0 5px; background:#ddd; cursor: ew-resize; }
  #divider:hover { background:#999; }
  
  h2,h3,h4 { margin:0 0 12px; color:#333; }
  h2 { font-size:20px; }
  h3 { font-size:18px; color:#0066cc; }
  h4 { font-size:15px; font-weight:600; margin-top:20px; }
  
  #left p { margin: 0 0 14px; line-height: 1.7; text-align:justify; }
  
  .group { background:#fff; border:1px solid #ddd; border-radius:6px; padding:16px; margin-bottom:16px; }
  .group h4 { margin-top:0; color:#0066cc; }
  .group p { margin:8px 0; font-size:14px; line-height:1.6; }
  
  .headings-box { background:#f9f9f9; padding:15px; border:1px solid #ddd; margin-bottom:15px; font-size:13px; line-height: 1.6; }
  .headings-box strong { display:block; margin-bottom:10px; font-size:14px; }
  
  .flag-btn { 
    position:absolute; 
    left:2px; 
    top:50%;
    transform:translateY(-50%);
    width:8px;
    height:8px;
    border-radius:50%;
    background:#ddd;
    cursor:pointer;
    z-index:10;
  }
  .flag-btn:hover { background:#999; }
  .flag-btn.active { background:#ff5722; }
  
  .group ol { margin-left:20px; }
  .group ol li { margin:12px 0; font-size:14px; line-height:1.6; position:relative; }
  .group ol li label { display:block; margin:4px 0; cursor:pointer; }
  .group ol li label input { margin-right:8px; }

  /* Specific styles for this paper */
  select { padding: 4px; border: 1px solid #ccc; border-radius: 4px; background: #fff; }
  input[type="text"] { padding: 4px; border: 1px solid #ccc; border-radius: 4px; width: 120px; }
  .diagram-container { background:#f9f9f9; padding:15px; border:1px solid #eee; margin-top:10px; }
  .diagram-item { margin-bottom: 10px; }
  
  .bottom-bar { display:flex; gap:10px; margin-top:16px; }
  button { padding:10px 20px; border:1px solid #999; border-radius:6px; background:#fff; cursor:pointer; font-size:14px; }
  button:hover { background:#f0f0f0; }
  .btn-primary { background:#0066cc; color:#fff; border-color:#0066cc; }
  .btn-primary:hover { background:#0052a3; }
  .btn-danger { background:#dc3545; color:#fff; border-color:#dc3545; }
  .btn-danger:hover { background:#c82333; }
  
  .hl { background:#fff59d; cursor:pointer; }
  .hl:hover { background:#ffeb3b; }
  .note { background:#b3d9ff; cursor:pointer; }
  .note:hover { background:#99ccff; }
  
  #selbar { position:fixed; display:none; z-index:2000; background:#fff; border:1px solid #ddd; border-radius:8px; padding:8px; gap:0; box-shadow:0 2px 8px rgba(0,0,0,0.15); flex-direction:column; min-width:120px; }
  #selbar button { background:#fff; color:#666; border:none; padding:3px 0px; cursor:pointer; font-size:14px; text-align:center; border-radius:4px; }
  #selbar button:hover { background:#f5f5f5; color:#333; }
  
  .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:3000; align-items:center; justify-content:center; }
  .modal.active { display:flex; }
  .modal-content { background:#fff; border-radius:8px; padding:24px; max-width:600px; width:90%; max-height:80vh; overflow-y:auto; }
  
  .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
  .modal-header h2 { font-size: 28px; color: #333; margin: 0; }
  .modal-close { font-size: 32px; cursor: pointer; color: #999; line-height: 1; }
  .modal-close:hover { color: #333; }
  
  .result-summary { text-align:center; padding:20px; background:#f0f0f0; margin-bottom:16px; border-radius:6px; }
  .result-score { font-size:36px; font-weight:600; color:#0066cc; }
  .result-item { padding:10px; margin:8px 0; border-left:3px solid #ddd; background:#f9f9f9; font-size:13px; }
  .result-item.correct { border-left-color:#28a745; background:#e8f5e9; }
  .result-item.incorrect { border-left-color:#dc3545; background:#ffebee; }
  
  .wrong-item { background:#fff3e0; padding:16px; margin:8px 0; border-radius:8px; border-left:4px solid #ff9800; display:flex; justify-content:space-between; align-items:start; }
  .wrong-item-content { flex:1; }
  .btn-delete { background:#dc3545; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-size:13px; margin-left:12px; }
  .btn-delete:hover { background:#c82333; }
  .modal-actions { display:flex; gap:10px; margin-bottom:20px; }
</style>
</head>
<body>
<div id="timer">00:00</div>

<div class="shell">
  <section class="pane" id="left">
    
<h2>READING PASSAGE 3</h2>
<p>You should spend about 20 minutes on Questions 27‚Äì40, which are based on Reading Passage 3 below.</p>
<h3>Termite Mounds</h3>
<p><em>Could the vast towers of mud constructed by insects in sub-Saharan Africa hold the key to our energy-efficient building of the future?</em></p>

<p><strong>A</strong> To most of us, termites are destructive insects which can cause damage on a devastating scale. But according to Dr Rupert Soar of Loughborough University‚Äôs School of Mechanical and Manufacturing Engineering, these pests may serve a useful purpose for us after all. His multidisciplinary team of British and American engineers and biologists has set out to investigate the giant mounds built by termites in Namibia, in sub-Saharan Africa, as part of the most extensive study of these structures ever taken.</p>

<p><strong>B</strong> Termite mounds are impressive for their size alone; typically they are three metres high, and some as tall as eight metres have been found. They also reach far into the earth, where the insects ‚Äòmine‚Äô their building materials, carefully selecting each grain of sand they use. The termite‚Äôs nest is contained in the central cavity of the mound, safely protected from the harsh environment outside. The mound itself is formed of an intricate lattice of tunnels, which split into smaller and smaller tunnels, much like a person‚Äôs blood vessels.</p>

<p><strong>C</strong> This complex system of tunnels draws in air from the outside, capturing wind energy to drive it through the mound. It also serves to expel spent respiratory gases from the nest to prevent the termites from suffocating, so ensuring them a continuous provision of fresh, breathable air. So detailed is the design that the nest stays within three degrees of a constant temperature, despite variations on the outside of up to 50 ¬∞C, from blistering heat in the daytime to below freezing on the coldest nights. The mound also automatically regulates moisture in the air, by means of both its underground ‚Äòcellar‚Äô, and evaporation from the top of the mound. Some colonies even had ‚Äòchimneys‚Äô at a height of 20 m to control moisture loss in the hottest regions of sub-Saharan Africa.</p>

<p><strong>D</strong> Furthermore, the termites have evolved in such a way as to outsource some of their biological functions. Part of their digestive process is carried out by a fungus, which they ‚Äòfarm‚Äô inside the mound. This fungus, which is found nowhere else on earth, thrives in the constant and optimum environment of the mound. The termites feed the fungus with slightly chewed wood pulp, which the fungus then breaks down into a digestible sugary food to provide the insects with energy, and cellulose which they use for building. And, although the termites must generate waste, none ever leaves the structure, indicating that there is also some kind of internal waste-recycling system.</p>

<p><strong>E</strong> Scientists are so excited by the mounds that they have labelled them a ‚Äòsuper organism‚Äô because, in Soar‚Äôs words, ‚ÄúThey dance on the edge of what we would perceive to be cool or, if you‚Äôre too cold, you need to thrive: that‚Äôs called homeostasis.‚Äù What the termites have done is to move homeostatic function away from their body, into the structure in which they live. ‚ÄúAs more information comes to light about the unique features of termite mounds, we may ultimately need to redefine our understanding of what constitutes a ‚Äòliving‚Äô organism.‚Äù</p>

<p><strong>F</strong> To reveal the structure of the mounds, Soar‚Äôs team begins by filling and covering their plaster of Paris, a chalky white paste based on the mineral gypsum, which becomes rock-solid when dry. The researcher then carves the plaster of Paris into half-millimetre thick slices, and photographs them sequentially. Once the pictures are digitally scanned, computer technology is able to recreate complex three-dimensional images of the mounds. These models have enabled the team to map termite architecture at a level of detail never before attained.</p>

<p><strong>G</strong> Soar hopes that the models will explain how termite mounds create a self-regulating living environment which manages to respond to changing internal and external conditions without drawing on any outside source of power. If they do, the findings could be invaluable in informing future architectural design, and could inspire buildings that are self-sufficient, environmentally friendly, and cheap to run. ‚ÄúAs we approach a world of climate change and temperatures rise,‚Äù he explains, ‚Äúthere will not be enough fuel to drive air conditioners around the world.‚Äù It is hoped, says Soar, ‚Äúthat the findings will provide clues that aid the ultimate development of new kinds of human habitats, suitable for a variety of arid, hostile environments not only on the earth but maybe one day on the moon and beyond.‚Äù</p>
  </section>

  <div id="divider" title="Drag to resize"></div>

  <section class="pane" id="right">
    <h3>Questions</h3>

    <div class="group">
      <h4>Questions 27‚Äì33</h4>
      <p>Reading Passage 3 has seven paragraphs <strong>A‚ÄìG</strong>.</p>
      <p>Choose the correct heading for each paragraph from the list of headings below.</p>
      <p>Write the correct number, <strong>i‚Äìix</strong>, in boxes <strong>27‚Äì33</strong> on your answer sheet.</p>
      
      <div class="headings-box">
        <strong>List of headings</strong>
        <div>i &nbsp;&nbsp;&nbsp; methods used to investigate termite mound formation</div>
        <div>ii &nbsp;&nbsp;&nbsp; challenging our assumptions about the nature of life</div>
        <div>iii &nbsp;&nbsp; reconsidering the termite‚Äôs reputation</div>
        <div>iv &nbsp;&nbsp; principal functions of the termite mound</div>
        <div>v &nbsp;&nbsp;&nbsp; distribution of termite mounds in sub-Saharan Africa</div>
        <div>vi &nbsp;&nbsp; some potential benefits of understanding termite architecture</div>
        <div>vii &nbsp; the astonishing physical dimensions of the termite mound</div>
        <div>viii &nbsp; termite mounds under threat from global climate change</div>
        <div>ix &nbsp;&nbsp; a mutually beneficial relationship</div>
      </div>

      <div style="line-height:2.2; margin-left:20px;">
        <div style="position:relative;"><span class="flag-btn" data-q="q27" style="left:-20px;"></span>
          <strong>27</strong> Paragraph A 
          <select name="q27">
            <option value="">Select...</option>
            <option value="i">i</option><option value="ii">ii</option><option value="iii">iii</option>
            <option value="iv">iv</option><option value="v">v</option><option value="vi">vi</option>
            <option value="vii">vii</option><option value="viii">viii</option><option value="ix">ix</option>
          </select>
        </div>
        <div style="position:relative;"><span class="flag-btn" data-q="q28" style="left:-20px;"></span>
          <strong>28</strong> Paragraph B 
          <select name="q28">
            <option value="">Select...</option>
            <option value="i">i</option><option value="ii">ii</option><option value="iii">iii</option>
            <option value="iv">iv</option><option value="v">v</option><option value="vi">vi</option>
            <option value="vii">vii</option><option value="viii">viii</option><option value="ix">ix</option>
          </select>
        </div>
        <div style="position:relative;"><span class="flag-btn" data-q="q29" style="left:-20px;"></span>
          <strong>29</strong> Paragraph C 
          <select name="q29">
            <option value="">Select...</option>
            <option value="i">i</option><option value="ii">ii</option><option value="iii">iii</option>
            <option value="iv">iv</option><option value="v">v</option><option value="vi">vi</option>
            <option value="vii">vii</option><option value="viii">viii</option><option value="ix">ix</option>
          </select>
        </div>
        <div style="position:relative;"><span class="flag-btn" data-q="q30" style="left:-20px;"></span>
          <strong>30</strong> Paragraph D 
          <select name="q30">
            <option value="">Select...</option>
            <option value="i">i</option><option value="ii">ii</option><option value="iii">iii</option>
            <option value="iv">iv</option><option value="v">v</option><option value="vi">vi</option>
            <option value="vii">vii</option><option value="viii">viii</option><option value="ix">ix</option>
          </select>
        </div>
        <div style="position:relative;"><span class="flag-btn" data-q="q31" style="left:-20px;"></span>
          <strong>31</strong> Paragraph E 
          <select name="q31">
            <option value="">Select...</option>
            <option value="i">i</option><option value="ii">ii</option><option value="iii">iii</option>
            <option value="iv">iv</option><option value="v">v</option><option value="vi">vi</option>
            <option value="vii">vii</option><option value="viii">viii</option><option value="ix">ix</option>
          </select>
        </div>
        <div style="position:relative;"><span class="flag-btn" data-q="q32" style="left:-20px;"></span>
          <strong>32</strong> Paragraph F 
          <select name="q32">
            <option value="">Select...</option>
            <option value="i">i</option><option value="ii">ii</option><option value="iii">iii</option>
            <option value="iv">iv</option><option value="v">v</option><option value="vi">vi</option>
            <option value="vii">vii</option><option value="viii">viii</option><option value="ix">ix</option>
          </select>
        </div>
        <div style="position:relative;"><span class="flag-btn" data-q="q33" style="left:-20px;"></span>
          <strong>33</strong> Paragraph G 
          <select name="q33">
            <option value="">Select...</option>
            <option value="i">i</option><option value="ii">ii</option><option value="iii">iii</option>
            <option value="iv">iv</option><option value="v">v</option><option value="vi">vi</option>
            <option value="vii">vii</option><option value="viii">viii</option><option value="ix">ix</option>
          </select>
        </div>
      </div>
    </div>

    <div class="group">
      <h4>Questions 34‚Äì37</h4>
      <p>Label the diagram below.</p>
      <p>Choose <strong>ONE WORD ONLY</strong> from the passage for each answer.</p>
      
      <div class="diagram-container">
        <div class="diagram-item" style="position:relative;">
            <span class="flag-btn" data-q="q34" style="left:-15px;"></span>
            <strong>34</strong>. network of <input type="text" name="q34"> helps to give the termites...
        </div>
        <div class="diagram-item" style="position:relative;">
            <span class="flag-btn" data-q="q35" style="left:-15px;"></span>
            <strong>35</strong>. ...a constant <input type="text" name="q35"> supply and to maintain a limited temperature range
        </div>
        <div class="diagram-item" style="position:relative;">
            <span class="flag-btn" data-q="q36" style="left:-15px;"></span>
            <strong>36</strong>. cellar to aid control of <input type="text" name="q36"> levels in mound
        </div>
        <div class="diagram-item" style="position:relative;">
            <span class="flag-btn" data-q="q37" style="left:-15px;"></span>
            <strong>37</strong>. top of the mound permits <input type="text" name="q37">
        </div>
      </div>
    </div>

    <div class="group">
      <h4>Questions 38‚Äì40</h4>
      <p>Do the following statements agree with the claims of the writer in Reading Passage 3?</p>
      <div style="margin-left:20px; margin-top:8px; margin-bottom:12px; font-size:13px;">
        <div><strong>YES</strong> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if the statement agrees with the claims of the writer</div>
        <div><strong>NO</strong> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if the statement contradicts the claims of the writer</div>
        <div><strong>NOT GIVEN</strong> &nbsp;if it is impossible to say what the writer thinks about this</div>
      </div>

      <ol start="38">
        <li><span class="flag-btn" data-q="q38" style="left:-20px;"></span>The termite mound appears to process its refuse material internally.<br>
          <label><input type="radio" name="q38" value="YES"> YES</label>
          <label><input type="radio" name="q38" value="NO"> NO</label>
          <label><input type="radio" name="q38" value="NOT GIVEN"> NOT GIVEN</label>
        </li>
        <li><span class="flag-btn" data-q="q39" style="left:-20px;"></span>Dr Soar‚Äôs reconstruction involves scanning a single photograph of a complete mound into a computer.<br>
          <label><input type="radio" name="q39" value="YES"> YES</label>
          <label><input type="radio" name="q39" value="NO"> NO</label>
          <label><input type="radio" name="q39" value="NOT GIVEN"> NOT GIVEN</label>
        </li>
        <li><span class="flag-btn" data-q="q40" style="left:-20px;"></span>New information about termite architecture could help people deal with future energy crises.<br>
          <label><input type="radio" name="q40" value="YES"> YES</label>
          <label><input type="radio" name="q40" value="NO"> NO</label>
          <label><input type="radio" name="q40" value="NOT GIVEN"> NOT GIVEN</label>
        </li>
      </ol>
    </div>

    <div class="bottom-bar">
      <button class="btn-primary" onclick="submitAnswers()">Êèê‰∫§</button>
      <button onclick="resetForm()">ÈáçÁΩÆ</button>
      <button onclick="openWrongBook()">Êú¨ÁØáÈîôÈ¢ò</button>
    </div>
  </section>
</div>

<div id="selbar">
  <button id="btnNote">Note</button>
  <button id="btnHL">Highlight</button>
  <button id="btnUH" style="display:none;">Clear Highlight</button>
</div>

<div class="modal" id="resultModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ÊàêÁª©</h2>
      <span class="modal-close" onclick="closeModal('resultModal')">√ó</span>
    </div>
    <div id="resultContent"></div>
    <button class="btn-primary" style="width:100%; margin-top:16px;" onclick="addWrongToBook()">Âä†ÂÖ•ÈîôÈ¢òÊú¨</button>
  </div>
</div>

<div class="modal" id="wrongBookModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Êú¨ÁØáÈîôÈ¢ò</h2>
      <span class="modal-close" onclick="closeModal('wrongBookModal')">√ó</span>
    </div>
    <div id="wrongBookContent"></div>
  </div>
</div>

<div class="modal" id="resetModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ÈáçÁΩÆÁªÉ‰π†</h2>
      <span class="modal-close" onclick="closeModal('resetModal')">√ó</span>
    </div>
    <div style="margin:16px 0;">
      <label style="display:block; margin-bottom:10px;">
        <input type="radio" name="resetType" value="answers" checked>
        Âè™Ê∏ÖÁ©∫Á≠îÊ°à
      </label>
      <label style="display:block;">
        <input type="radio" name="resetType" value="all">
        Ê∏ÖÁ©∫Á≠îÊ°àÂíåÊ†áËÆ∞
      </label>
    </div>
    <button class="btn-primary" style="width:100%;" onclick="confirmReset()">Á°ÆÂÆö</button>
  </div>
</div>

<script>
const PAPER_ID='P3_TERMITE_MOUNDS';

let t=0;
const timerEl=document.getElementById('timer');
setInterval(()=>{ t++; timerEl.textContent=String(Math.floor(t/60)).padStart(2,'0')+':'+String(t%60).padStart(2,'0'); }, 1000);

const divider=document.getElementById('divider'), left=document.getElementById('left'), right=document.getElementById('right');
let dragging=false;
divider.onmousedown=()=>{ dragging=true; document.body.style.cursor='ew-resize'; };
window.onmousemove=(e)=>{ if(!dragging)return; const c=document.querySelector('.shell').getBoundingClientRect(); let x=e.clientX-c.left; x=Math.max(280,Math.min(c.width-280,x)); left.style.flex='0 0 '+x+'px'; right.style.flex='1 1 auto'; };
window.onmouseup=()=>{ dragging=false; document.body.style.cursor=''; };

const selbar=document.getElementById('selbar'), btnHL=document.getElementById('btnHL'), btnUH=document.getElementById('btnUH'), btnNote=document.getElementById('btnNote');
let lastRange=null, currentHlNode=null;

function posSelbar(r){ selbar.style.display='flex'; const t=window.scrollY+r.top-selbar.offsetHeight-8; const l=window.scrollX+r.left+r.width/2-selbar.offsetWidth/2; selbar.style.top=((t>0)?t:(window.scrollY+r.bottom+8))+'px'; selbar.style.left=Math.max(8,l)+'px'; }

function updSel(){ const s=window.getSelection(); if(!s||s.rangeCount===0||s.isCollapsed){ if(!currentHlNode)selbar.style.display='none'; return; } const r=s.getRangeAt(0); lastRange=r.cloneRange(); currentHlNode=null; btnNote.style.display='block'; btnHL.style.display='block'; btnUH.style.display='none'; posSelbar(r.getBoundingClientRect()); }

left.onmouseup=updSel; right.onmouseup=updSel;
document.onselectionchange=()=>{ const s=window.getSelection(); if((!s||s.rangeCount===0||s.isCollapsed)&&!currentHlNode)selbar.style.display='none'; };
document.addEventListener('click',(e)=>{ if(e.target.classList&&(e.target.classList.contains('hl')||e.target.classList.contains('note'))){ currentHlNode=e.target; lastRange=null; btnNote.style.display='none'; btnHL.style.display='none'; btnUH.style.display='block'; posSelbar(e.target.getBoundingClientRect()); const s=window.getSelection(); if(s)s.removeAllRanges(); }}, true);

btnHL.onclick=()=>{ if(currentHlNode||!lastRange||lastRange.collapsed)return; const s=document.createElement('span'); s.className='hl'; try{ lastRange.surroundContents(s); }catch(e){ const w=document.createElement('span'); w.className='hl'; w.appendChild(lastRange.cloneContents()); lastRange.deleteContents(); lastRange.insertNode(w); } selbar.style.display='none'; saveHighlights(); };

btnNote.onclick=()=>{ if(currentHlNode||!lastRange||lastRange.collapsed)return; const s=document.createElement('span'); s.className='note'; try{ lastRange.surroundContents(s); }catch(e){ const w=document.createElement('span'); w.className='note'; w.appendChild(lastRange.cloneContents()); lastRange.deleteContents(); lastRange.insertNode(w); } selbar.style.display='none'; saveHighlights(); };

btnUH.onclick=()=>{ if(currentHlNode){ const p=currentHlNode.parentNode; while(currentHlNode.firstChild)p.insertBefore(currentHlNode.firstChild,currentHlNode); p.removeChild(currentHlNode); p.normalize(); currentHlNode=null; selbar.style.display='none'; saveHighlights(); }else if(lastRange){ const sR=lastRange.getBoundingClientRect(); const w=document.createTreeWalker(document.body,NodeFilter.SHOW_ELEMENT); const tr=[]; while(w.nextNode()){ const n=w.currentNode; if(n.classList&&(n.classList.contains('hl')||n.classList.contains('note'))){ const r=n.getBoundingClientRect(); if(!(r.right<sR.left||r.left>sR.right||r.bottom<sR.top||r.top>sR.bottom))tr.push(n); }} tr.forEach(el=>{ const p=el.parentNode; while(el.firstChild)p.insertBefore(el.firstChild,el); p.removeChild(el); p.normalize(); }); selbar.style.display='none'; saveHighlights(); }};

document.querySelectorAll('.flag-btn').forEach(btn => {
  btn.onclick = e => {
    e.stopPropagation();
    btn.classList.toggle('active');
    saveFlags();
  };
});

const answerKey={
    q27:"iii", q28:"vii", q29:"iv", q30:"ix", q31:"ii", q32:"i", q33:"vi",
    q34:"tunnels", q35:"air", q36:"moisture", q37:"evaporation",
    q38:"YES", q39:"NO", q40:"YES"
};
let lastResults=[];

function saveAnswers() {
  const data = {};
  // Save Radios
  document.querySelectorAll('input[type="radio"]:checked').forEach(el => {
    data[el.name] = el.value;
  });
  // Save Selects
  document.querySelectorAll('select').forEach(el => {
      if(el.value) data[el.name] = el.value;
  });
  // Save Text Inputs
  document.querySelectorAll('input[type="text"]').forEach(el => {
      if(el.value) data[el.name] = el.value;
  });
  localStorage.setItem(`${PAPER_ID}_answers`, JSON.stringify(data));
}

function loadAnswers() {
  const data = JSON.parse(localStorage.getItem(`${PAPER_ID}_answers`) || '{}');
  Object.keys(data).forEach(q => {
    // Try Radio
    const radio = document.querySelector(`input[name="${q}"][value="${data[q]}"]`);
    if(radio) radio.checked = true;
    // Try Select
    const sel = document.querySelector(`select[name="${q}"]`);
    if(sel) sel.value = data[q];
    // Try Text
    const txt = document.querySelector(`input[type="text"][name="${q}"]`);
    if(txt) txt.value = data[q];
  });
}

function saveFlags() {
  const flags = [...document.querySelectorAll('.flag-btn.active')].map(b => b.dataset.q);
  localStorage.setItem(`${PAPER_ID}_flags`, JSON.stringify(flags));
}

function loadFlags() {
  const flags = JSON.parse(localStorage.getItem(`${PAPER_ID}_flags`) || '[]');
  flags.forEach(q => document.querySelector(`[data-q="${q}"]`)?.classList.add('active'));
}

function saveHighlights() {
  const highlights = { left: [], right: [] };
  document.querySelectorAll('#left .hl, #left .note').forEach((el, idx) => {
    highlights.left.push({ type: el.classList.contains('hl') ? 'hl' : 'note', text: el.textContent, index: idx });
  });
  document.querySelectorAll('#right .hl, #right .note').forEach((el, idx) => {
    highlights.right.push({ type: el.classList.contains('hl') ? 'hl' : 'note', text: el.textContent, index: idx });
  });
  localStorage.setItem(`${PAPER_ID}_highlights`, JSON.stringify(highlights));
}

function loadHighlights() {
  const data = JSON.parse(localStorage.getItem(`${PAPER_ID}_highlights`) || '{"left":[],"right":[]}');
  ['left', 'right'].forEach(side => {
    if(data[side] && data[side].length > 0) {
      const container = document.getElementById(side);
      data[side].forEach(item => {
        const walker = document.createTreeWalker(container, NodeFilter.SHOW_TEXT);
        let node;
        while(node = walker.nextNode()) {
          if(node.textContent.includes(item.text)) {
            const span = document.createElement('span');
            span.className = item.type;
            const parent = node.parentNode;
            const text = node.textContent;
            const idx = text.indexOf(item.text);
            if(idx >= 0) {
              const before = text.substring(0, idx);
              const match = text.substring(idx, idx + item.text.length);
              const after = text.substring(idx + item.text.length);
              parent.insertBefore(document.createTextNode(before), node);
              span.textContent = match;
              parent.insertBefore(span, node);
              parent.insertBefore(document.createTextNode(after), node);
              parent.removeChild(node);
              break;
            }
          }
        }
      });
    }
  });
}

// Event Listeners for Input Changes
document.querySelectorAll('input[type="radio"], select, input[type="text"]').forEach(el => {
  el.addEventListener('change', saveAnswers);
});

document.addEventListener('DOMContentLoaded', () => {
  loadAnswers();
  loadFlags();
  loadHighlights();
});

function submitAnswers(){ 
  const res=[]; let cor=0; 
  Object.keys(answerKey).forEach(q=>{ 
    let uA = "";
    // Check radio
    const radio = document.querySelector(`input[name="${q}"]:checked`);
    if(radio) uA = radio.value;
    // Check select 
    const sel = document.querySelector(`select[name="${q}"]`);
    if(sel) uA = sel.value;
    // Check text
    const txt = document.querySelector(`input[type="text"][name="${q}"]`);
    if(txt) uA = txt.value;

    const cA=answerKey[q]; 
    // Case insensitive comparison for text
    const iC = uA.trim().toLowerCase() === cA.toLowerCase(); 
    if(iC)cor++; 
    res.push({id:q,userAns:uA,correctAns:cA,isCorrect:iC}); 
  }); 
  lastResults=res; 
  const tot=Object.keys(answerKey).length; 
  const pct=((cor/tot)*100).toFixed(1); 
  localStorage.setItem(`ielts_score_${PAPER_ID}`, `${cor}/${tot}`);
  document.getElementById('resultContent').innerHTML=`<div class="result-summary"><div class="result-score">${cor} / ${tot}</div><div style="margin-top:8px;font-size:18px;">${pct}%</div></div>${res.map(r=>`<div class="result-item ${r.isCorrect?'correct':'incorrect'}"><div><strong>${r.id}</strong> ${r.isCorrect?'‚úì':'‚úó'}</div><div>‰Ω†ÁöÑÁ≠îÊ°à: ${r.userAns||'(Êú™‰ΩúÁ≠î)'}</div>${!r.isCorrect?`<div>Ê≠£Á°ÆÁ≠îÊ°à: ${r.correctAns}</div>`:''}</div>`).join('')}`; 
  document.getElementById('resultModal').classList.add('active'); 
}

function resetForm(){ document.getElementById('resetModal').classList.add('active'); }

function confirmReset(){ 
  const tp=document.querySelector('input[name="resetType"]:checked').value; 
  document.querySelectorAll('input[type="radio"]').forEach(i=>i.checked=false); 
  document.querySelectorAll('select').forEach(i=>i.value="");
  document.querySelectorAll('input[type="text"]').forEach(i=>i.value="");
  localStorage.removeItem(`${PAPER_ID}_answers`);
  
  if(tp==='all'){ 
    document.querySelectorAll('.hl').forEach(el=>{ const p=el.parentNode; while(el.firstChild)p.insertBefore(el.firstChild,el); p.removeChild(el); p.normalize(); }); 
    document.querySelectorAll('.note').forEach(el=>{ const p=el.parentNode; while(el.firstChild)p.insertBefore(el.firstChild,el); p.removeChild(el); p.normalize(); }); 
    document.querySelectorAll('.flag-btn').forEach(b => b.classList.remove('active'));
    localStorage.removeItem(`${PAPER_ID}_highlights`);
    localStorage.removeItem(`${PAPER_ID}_flags`);
  } 
  closeModal('resetModal'); 
}

function addWrongToBook(){ const wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); const wr=lastResults.filter(r=>!r.isCorrect); wr.forEach(r=>{ const en={paperId:PAPER_ID,title:'Termite Mounds',questionId:r.id,correctAnswer:r.correctAns,myAnswer:r.userAns||'(Êú™‰ΩúÁ≠î)',date:new Date().toISOString().split('T')[0]}; const ix=wb.findIndex(i=>i.paperId===en.paperId&&i.questionId===en.questionId); if(ix>=0)wb[ix]=en; else wb.push(en); }); localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); alert(`Â∑≤Ê∑ªÂä† ${wr.length} ÈÅìÈîôÈ¢ò`); closeModal('resultModal'); }

function deleteWrongItem(pId,qId){ if(!confirm('Á°ÆÂÆöÂà†Èô§ËøôÈÅìÈîôÈ¢òÔºü'))return; let wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); wb=wb.filter(i=>!(i.paperId===pId&&i.questionId===qId)); localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); openWrongBook(); }

function clearCurrentWrongBook(){ if(!confirm('Á°ÆÂÆöÊ∏ÖÁ©∫Êú¨ÁØáÊâÄÊúâÈîôÈ¢òÔºü'))return; let wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); wb=wb.filter(i=>i.paperId!==PAPER_ID); localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); openWrongBook(); }

function openWrongBook(){ const wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); const cu=wb.filter(i=>i.paperId===PAPER_ID); const ct=document.getElementById('wrongBookContent'); if(cu.length===0)ct.innerHTML='<div style="text-align:center;padding:40px;color:#666;">ÊöÇÊó†ÈîôÈ¢ò</div>'; else ct.innerHTML=`<div class="modal-actions"><button class="btn-danger" onclick="clearCurrentWrongBook()" style="width:100%;">üóëÔ∏è Ê∏ÖÁ©∫Êú¨ÁØáÈîôÈ¢ò</button></div>${cu.map(i=>`<div class="wrong-item"><div class="wrong-item-content"><div style="font-weight:600;margin-bottom:8px;">${i.questionId}</div><div style="font-size:13px;color:#666;"><div>‚úì Ê≠£Á°Æ: ${i.correctAnswer}</div><div style="color:#d32f2f;">‚úó ÊàëÁöÑ: ${i.myAnswer}</div></div></div><button class="btn-delete" onclick="deleteWrongItem('${i.paperId}','${i.questionId}')">Âà†Èô§</button></div>`).join('')}`; document.getElementById('wrongBookModal').classList.add('active'); }

function closeModal(id){ document.getElementById(id).classList.remove('active'); }
</script>
</body>
</html>