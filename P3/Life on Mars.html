<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>P3 ‚Äì Life on Mars?</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  * { box-sizing: border-box; margin:0; padding:0; }
  html,body { height:100%; }
  body { font-family: Arial, sans-serif; background:#f5f5f5; }
  
  #timer { position:fixed; top:12px; right:12px; background:#fff; border:1px solid #ddd; border-radius:6px; padding:8px 12px; font-size:16px; font-weight:600; color:#0066cc; z-index:1000; }
  
  .shell { display:flex; height:100vh; width:100%; }
  .pane { background:#fff; overflow:auto; padding:24px; }
  #left { flex: 0 0 50%; border-right:1px solid #ddd; }
  #right { flex: 1 1 auto; background:#fafafa; }
  #divider { flex: 0 0 5px; background:#ddd; cursor: ew-resize; }
  #divider:hover { background:#999; }
  
  h2,h3,h4 { margin:0 0 12px; color:#333; }
  h2 { font-size:20px; }
  h3 { font-size:18px; color:#0066cc; }
  h4 { font-size:15px; font-weight:600; margin-top:20px; }
  
  #left p { margin: 0 0 14px; line-height: 1.7; text-align:justify; }
  
  .group { background:#fff; border:1px solid #ddd; border-radius:6px; padding:16px; margin-bottom:16px; }
  .group h4 { margin-top:0; color:#0066cc; }
  .group p { margin:8px 0; font-size:14px; line-height:1.6; }
  
  .headings { background:#f9f9f9; padding:12px; margin:12px 0; border-radius:4px; }
  
  .flag-btn { 
    position:absolute; 
    left:2px; 
    top:50%;
    transform:translateY(-50%);
    width:8px;
    height:8px;
    border-radius:50%;
    background:#ddd;
    cursor:pointer;
    z-index:10;
  }
  .flag-btn:hover { background:#999; }
  .flag-btn.active { background:#ff5722; }
  
  .group ol { margin-left:20px; }
  .group ol li { margin:12px 0; font-size:14px; line-height:1.6; position:relative; }
  .group ol li label { display:block; margin:4px 0; cursor:pointer; }
  .group ol li label input { margin-right:8px; }

  /* Summary Gap Style */
  .summary-text { line-height: 2; font-size: 14px; }
  .summary-text select { margin: 0 5px; padding: 2px; border: 1px solid #999; border-radius: 4px; background: #fff; }
  .word-list { margin-top: 15px; padding: 10px; background: #f0f0f0; border-radius: 4px; display: flex; flex-wrap: wrap; gap: 10px; font-size: 13px; }
  .word-item { width: 30%; }
  
  .bottom-bar { display:flex; gap:10px; margin-top:16px; }
  button { padding:10px 20px; border:1px solid #999; border-radius:6px; background:#fff; cursor:pointer; font-size:14px; }
  button:hover { background:#f0f0f0; }
  .btn-primary { background:#0066cc; color:#fff; border-color:#0066cc; }
  .btn-primary:hover { background:#0052a3; }
  .btn-danger { background:#dc3545; color:#fff; border-color:#dc3545; }
  .btn-danger:hover { background:#c82333; }
  
  .hl { background:#fff59d; cursor:pointer; }
  .hl:hover { background:#ffeb3b; }
  .note { background:#b3d9ff; cursor:pointer; }
  .note:hover { background:#99ccff; }
  
  #selbar { position:fixed; display:none; z-index:2000; background:#fff; border:1px solid #ddd; border-radius:8px; padding:8px; gap:0; box-shadow:0 2px 8px rgba(0,0,0,0.15); flex-direction:column; min-width:120px; }
  #selbar button { background:#fff; color:#666; border:none; padding:3px 0px; cursor:pointer; font-size:14px; text-align:center; border-radius:4px; }
  #selbar button:hover { background:#f5f5f5; color:#333; }
  
  .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:3000; align-items:center; justify-content:center; }
  .modal.active { display:flex; }
  .modal-content { background:#fff; border-radius:8px; padding:24px; max-width:600px; width:90%; max-height:80vh; overflow-y:auto; }
  
  .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
  .modal-header h2 { font-size: 28px; color: #333; margin: 0; }
  .modal-close { font-size: 32px; cursor: pointer; color: #999; line-height: 1; }
  .modal-close:hover { color: #333; }
  
  .result-summary { text-align:center; padding:20px; background:#f0f0f0; margin-bottom:16px; border-radius:6px; }
  .result-score { font-size:36px; font-weight:600; color:#0066cc; }
  .result-item { padding:10px; margin:8px 0; border-left:3px solid #ddd; background:#f9f9f9; font-size:13px; }
  .result-item.correct { border-left-color:#28a745; background:#e8f5e9; }
  .result-item.incorrect { border-left-color:#dc3545; background:#ffebee; }
  
  .wrong-item { background:#fff3e0; padding:16px; margin:8px 0; border-radius:8px; border-left:4px solid #ff9800; display:flex; justify-content:space-between; align-items:start; }
  .wrong-item-content { flex:1; }
  .btn-delete { background:#dc3545; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-size:13px; margin-left:12px; }
  .btn-delete:hover { background:#c82333; }
  .modal-actions { display:flex; gap:10px; margin-bottom:20px; }
</style>
</head>
<body>
<div id="timer">00:00</div>

<div class="shell">
  <section class="pane" id="left">
    
<h2>READING PASSAGE 3</h2>
<p>You should spend about 20 minutes on Questions 27‚Äì40, which are based on Reading Passage 3 below.</p>
<h3>Life on Mars?</h3>
<p><em>Terraforming may sound like something out of science fiction, but some believe it is possible to turn that fiction into fact.</em></p>

<p>As plans are slowly being drawn up for the first manned mission to Mars, many space-travel sceptics are asking one vital question: why go there? Mars is a barren, desolate planet, and with its thin atmosphere and bitterly cold climate, it would appear to be completely unsuitable for human life. Above all, it is a very distant place, and getting there would be an enormous challenge. However, the planet might just hold the key to long-term human survival. With the Earth‚Äôs population currently at more than seven billion and climbing, we may eventually be forced to look elsewhere in the solar system for somewhere to live. It is just possible that, contrary to photographic evidence, Mars may be more promising than it appears.</p>

<p>Today, Mars is a viciously cold, dry place. However, it does have some things in common with our own planet. For example, it has a daily rotation rate of 24 hours 37 minutes, compared with 23 hours 56 minutes on Earth. It also has an axial tilt of 24 degrees, which is just half a degree more than Earth‚Äôs, and a gravitational pull one third of Earth‚Äôs. Furthermore, it holds many of the elements that are required to support life, including carbon and oxygen (in the form of carbon dioxide), nitrogen, and frozen water at its polar ice caps. In fact, if you were to travel back in time several billion years, you would notice some remarkable parallels between the atmosphere on Earth then and Mars today. Back then, Earth was also a lifeless planet; until photosynthetic bacteria developed and began to produce enough oxygen to allow for the development of animal and plant life, our atmosphere also consisted entirely of carbon dioxide and nitrogen.</p>

<p>It comes as no surprise to learn, therefore, that some scientists believe the same process which turned Earth‚Äôs atmosphere from mostly carbon dioxide into breathable air could be repeated on Mars, but by using technology rather than by letting nature and evolution take its natural course. Terraforming, as this process is known, would initially create a greenhouse effect that would heat the planet, which in turn would create other conditions necessary to provide a suitable living environment for plants and animals. However, it would be a highly challenging undertaking, and the process of terraforming the entire planet into an Earth-like habitat could still take many thousands of years.</p>

<p>Three terraforming methods have been suggested, with the first already under development, albeit for a different purpose. At present, the American space agency NASA is working on a system that will use large mirrors to capture the Sun‚Äôs radiation. This radiation will be used to propel spacecraft through space, removing the need for heavy and expensive rocket fuel. With a few changes, it might be possible to use similar mirrors to reflect the Sun‚Äôs radiation and heat the surface of Mars. Aimed at the planet from a distance of two hundred thousand miles, these enormous mirrors would raise the surface temperature by a few degrees. If they were concentrated on the polar ice caps, they would provide enough heat to melt the polar ice caps and release the carbon dioxide that is believed to be trapped there. Gradually, as the temperature rose, greenhouse gases would be released, and this would create a form of Martian global warming, the first stage in making the planet sustainable for life.</p>

<p>The second method would be to set up greenhouse-gas ‚Äòfactories‚Äô in order to raise the temperature of the planet. It is generally accepted that greenhouse gases produced by heavy industry are raising the Earth‚Äôs temperature. Therefore, by building hundreds of greenhouse-gas-emitting factories on Mars, a similar effect could be achieved. Carbon dioxide, methane and other greenhouse gases would be pumped into the Martian atmosphere. The same factories would then produce oxygen by mimicking the natural process of plant photosynthesis: they would inhale the carbon dioxide they produce, and then emit oxygen. The process could be accelerated by ‚Äòsowing the planet‚Äôs surface with photosynthetic bacteria‚Äô, which would increase the rate at which oxygen is produced. Eventually, there would be enough oxygen on the planet for humans to breathe using only special apparatus similar to that used by mountain climbers.</p>

<p>The third, and by far the most extreme, method has been proposed by space scientists Robert Zubrin and Christopher McKay. They believe that it would be possible to produce greenhouse gases and water by firing large, ammonia-bearing asteroids at the planet. Each asteroid would weigh about ten billion tons, and would be powered by huge rocket engines which would move it towards Mars at over 10,000 miles per hour. At this speed, it would take each asteroid about ten years to reach its destination. The energy produced by one asteroid slamming into Mars‚Äô surface, say Zubrin and McKay, would raise the temperature of the planet by three degrees Celsius and melt about one thousand billion tons of ice at the polar caps. They believe it would take many of these asteroids, and at least fifty years, in order to create a temperate climate and enough water to cover a quarter of the planet‚Äôs surface.</p>

<p>Terraforming Mars, if it is ever attempted, will be neither cheap nor easy. And it certainly won‚Äôt be quick: although optimists like Zubrin and McKay say it could be achieved in five or six decades, the reality is that terraforming is more likely to take hundreds or even thousands of years. Furthermore, it will stretch human ingenuity to its limits, and will require levels of will and commitment that have rarely been seen before. The challenge of developing a habitable environment and bringing life to the cold, dry world of Mars is fraught with challenges, but it might just be one that saves the human race.</p>
  </section>

  <div id="divider" title="Drag to resize"></div>

  <section class="pane" id="right">
    <h3>Questions</h3>

    <div class="group">
      <h4>Questions 27‚Äì31</h4>
      <p>Do the following statements agree with the views of the writer in Reading Passage 3?</p>
      <div style="margin-left:20px; margin-top:8px; margin-bottom:12px; font-size:13px;">
        <div><strong>YES</strong> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if the statement agrees with the views of the writer</div>
        <div><strong>NO</strong> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if the statement contradicts the views of the writer</div>
        <div><strong>NOT GIVEN</strong> &nbsp;if it is impossible to say what the writer thinks about this</div>
      </div>

      <ol start="27">
        <li><span class="flag-btn" data-q="q27" style="left:-20px;"></span>Pictures of Mars suggest it might make a good place for people to settle.<br>
          <label><input type="radio" name="q27" value="YES"> YES</label>
          <label><input type="radio" name="q27" value="NO"> NO</label>
          <label><input type="radio" name="q27" value="NOT GIVEN"> NOT GIVEN</label>
        </li>
        <li><span class="flag-btn" data-q="q28" style="left:-20px;"></span>Modern Mars and ancient Earth looked remarkably similar.<br>
          <label><input type="radio" name="q28" value="YES"> YES</label>
          <label><input type="radio" name="q28" value="NO"> NO</label>
          <label><input type="radio" name="q28" value="NOT GIVEN"> NOT GIVEN</label>
        </li>
        <li><span class="flag-btn" data-q="q29" style="left:-20px;"></span>One method of terraforming could involve adapting technology that is already under development.<br>
          <label><input type="radio" name="q29" value="YES"> YES</label>
          <label><input type="radio" name="q29" value="NO"> NO</label>
          <label><input type="radio" name="q29" value="NOT GIVEN"> NOT GIVEN</label>
        </li>
        <li><span class="flag-btn" data-q="q30" style="left:-20px;"></span>Greenhouse-gas factories would provide enough oxygen for people to breathe without special equipment.<br>
          <label><input type="radio" name="q30" value="YES"> YES</label>
          <label><input type="radio" name="q30" value="NO"> NO</label>
          <label><input type="radio" name="q30" value="NOT GIVEN"> NOT GIVEN</label>
        </li>
        <li><span class="flag-btn" data-q="q31" style="left:-20px;"></span>Terraforming Mars would be an extreme test of human skill and intelligence.<br>
          <label><input type="radio" name="q31" value="YES"> YES</label>
          <label><input type="radio" name="q31" value="NO"> NO</label>
          <label><input type="radio" name="q31" value="NOT GIVEN"> NOT GIVEN</label>
        </li>
      </ol>
    </div>

    <div class="group">
      <h4>Questions 32‚Äì35</h4>
      <p>Choose the correct letter, <strong>A, B, C</strong> or <strong>D</strong>.</p>
      
      <ol start="32">
        <li><span class="flag-btn" data-q="q32" style="left:-20px;"></span>Which one of these factors suggests that Mars might be a good place for people to settle?<br>
          <label><input type="radio" name="q32" value="A"> A. It is not too far from Earth.</label>
          <label><input type="radio" name="q32" value="B"> B. It has no other life forms living there.</label>
          <label><input type="radio" name="q32" value="C"> C. It has a cool, dry climate.</label>
          <label><input type="radio" name="q32" value="D"> D. It has some similarities with Earth.</label>
        </li>
        <li><span class="flag-btn" data-q="q33" style="left:-20px;"></span>The first step in terraforming Mars would be to<br>
          <label><input type="radio" name="q33" value="A"> A. make the planet warmer.</label>
          <label><input type="radio" name="q33" value="B"> B. create a breathable atmosphere.</label>
          <label><input type="radio" name="q33" value="C"> C. find a suitable source of water.</label>
          <label><input type="radio" name="q33" value="D"> D. create a habitat for living organisms.</label>
        </li>
        <li><span class="flag-btn" data-q="q34" style="left:-20px;"></span>Special factories on Mars could be used to<br>
          <label><input type="radio" name="q34" value="A"> A. control the level of greenhouse gases.</label>
          <label><input type="radio" name="q34" value="B"> B. absorb excess levels of carbon dioxide.</label>
          <label><input type="radio" name="q34" value="C"> C. produce oxygen in a manner similar to plants.</label>
          <label><input type="radio" name="q34" value="D"> D. help grow essential bacteria.</label>
        </li>
        <li><span class="flag-btn" data-q="q35" style="left:-20px;"></span>What is the writer‚Äôs main purpose in the passage?<br>
          <label><input type="radio" name="q35" value="A"> A. To explain why we need to terraform Mars.</label>
          <label><input type="radio" name="q35" value="B"> B. To illustrate the three processes required to terraform a planet like Mars.</label>
          <label><input type="radio" name="q35" value="C"> C. To consider how and why Mars might be terraformed.</label>
          <label><input type="radio" name="q35" value="D"> D. To demonstrate how straightforward it would be to terraform a planet.</label>
        </li>
      </ol>
    </div>

    <div class="group">
      <h4>Questions 36‚Äì40</h4>
      <p>Complete the summary using a word <strong>A‚ÄìI</strong> from the box.</p>
      
      <div class="summary-text">
        One method of terraforming Mars would be to <span class="flag-btn" data-q="q36" style="left:-12px;"></span>
        <select name="q36">
            <option value="">(36)</option>
            <option value="A">A</option><option value="B">B</option><option value="C">C</option>
            <option value="D">D</option><option value="E">E</option><option value="F">F</option>
            <option value="G">G</option><option value="H">H</option><option value="I">I</option>
        </select>
        asteroids at the planet. Rockets attached to an enormous asteroid would propel it towards Mars, taking ten years to <span class="flag-btn" data-q="q37" style="left:-12px;"></span>
        <select name="q37">
            <option value="">(37)</option>
            <option value="A">A</option><option value="B">B</option><option value="C">C</option>
            <option value="D">D</option><option value="E">E</option><option value="F">F</option>
            <option value="G">G</option><option value="H">H</option><option value="I">I</option>
        </select>
        the enormous distances required. The asteroid would <span class="flag-btn" data-q="q38" style="left:-12px;"></span>
        <select name="q38">
            <option value="">(38)</option>
            <option value="A">A</option><option value="B">B</option><option value="C">C</option>
            <option value="D">D</option><option value="E">E</option><option value="F">F</option>
            <option value="G">G</option><option value="H">H</option><option value="I">I</option>
        </select>
        the planet with incredible force and <span class="flag-btn" data-q="q39" style="left:-12px;"></span>
        <select name="q39">
            <option value="">(39)</option>
            <option value="A">A</option><option value="B">B</option><option value="C">C</option>
            <option value="D">D</option><option value="E">E</option><option value="F">F</option>
            <option value="G">G</option><option value="H">H</option><option value="I">I</option>
        </select>
        enough energy to <span class="flag-btn" data-q="q40" style="left:-12px;"></span>
        <select name="q40">
            <option value="">(40)</option>
            <option value="A">A</option><option value="B">B</option><option value="C">C</option>
            <option value="D">D</option><option value="E">E</option><option value="F">F</option>
            <option value="G">G</option><option value="H">H</option><option value="I">I</option>
        </select>
        the planet‚Äôs temperature. The result would be a temperate climate and lots of water from melting ice caps.
      </div>
      
      <div class="word-list">
        <div class="word-item"><strong>A</strong> cover</div>
        <div class="word-item"><strong>B</strong> create</div>
        <div class="word-item"><strong>C</strong> hit</div>
        <div class="word-item"><strong>D</strong> increase</div>
        <div class="word-item"><strong>E</strong> land</div>
        <div class="word-item"><strong>F</strong> drive</div>
        <div class="word-item"><strong>G</strong> power</div>
        <div class="word-item"><strong>H</strong> rise</div>
        <div class="word-item"><strong>I</strong> shoot</div>
      </div>
    </div>

    <div class="bottom-bar">
      <button class="btn-primary" onclick="submitAnswers()">Êèê‰∫§</button>
      <button onclick="resetForm()">ÈáçÁΩÆ</button>
      <button onclick="openWrongBook()">Êú¨ÁØáÈîôÈ¢ò</button>
    </div>
  </section>
</div>

<div id="selbar">
  <button id="btnNote">Note</button>
  <button id="btnHL">Highlight</button>
  <button id="btnUH" style="display:none;">Clear Highlight</button>
</div>

<div class="modal" id="resultModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ÊàêÁª©</h2>
      <span class="modal-close" onclick="closeModal('resultModal')">√ó</span>
    </div>
    <div id="resultContent"></div>
    <button class="btn-primary" style="width:100%; margin-top:16px;" onclick="addWrongToBook()">Âä†ÂÖ•ÈîôÈ¢òÊú¨</button>
  </div>
</div>

<div class="modal" id="wrongBookModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Êú¨ÁØáÈîôÈ¢ò</h2>
      <span class="modal-close" onclick="closeModal('wrongBookModal')">√ó</span>
    </div>
    <div id="wrongBookContent"></div>
  </div>
</div>

<div class="modal" id="resetModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ÈáçÁΩÆÁªÉ‰π†</h2>
      <span class="modal-close" onclick="closeModal('resetModal')">√ó</span>
    </div>
    <div style="margin:16px 0;">
      <label style="display:block; margin-bottom:10px;">
        <input type="radio" name="resetType" value="answers" checked>
        Âè™Ê∏ÖÁ©∫Á≠îÊ°à
      </label>
      <label style="display:block;">
        <input type="radio" name="resetType" value="all">
        Ê∏ÖÁ©∫Á≠îÊ°àÂíåÊ†áËÆ∞
      </label>
    </div>
    <button class="btn-primary" style="width:100%;" onclick="confirmReset()">Á°ÆÂÆö</button>
  </div>
</div>

<script>
const PAPER_ID='P3_LIFE_ON_MARS';

let t=0;
const timerEl=document.getElementById('timer');
setInterval(()=>{ t++; timerEl.textContent=String(Math.floor(t/60)).padStart(2,'0')+':'+String(t%60).padStart(2,'0'); }, 1000);

const divider=document.getElementById('divider'), left=document.getElementById('left'), right=document.getElementById('right');
let dragging=false;
divider.onmousedown=()=>{ dragging=true; document.body.style.cursor='ew-resize'; };
window.onmousemove=(e)=>{ if(!dragging)return; const c=document.querySelector('.shell').getBoundingClientRect(); let x=e.clientX-c.left; x=Math.max(280,Math.min(c.width-280,x)); left.style.flex='0 0 '+x+'px'; right.style.flex='1 1 auto'; };
window.onmouseup=()=>{ dragging=false; document.body.style.cursor=''; };

const selbar=document.getElementById('selbar'), btnHL=document.getElementById('btnHL'), btnUH=document.getElementById('btnUH'), btnNote=document.getElementById('btnNote');
let lastRange=null, currentHlNode=null;

function posSelbar(r){ selbar.style.display='flex'; const t=window.scrollY+r.top-selbar.offsetHeight-8; const l=window.scrollX+r.left+r.width/2-selbar.offsetWidth/2; selbar.style.top=((t>0)?t:(window.scrollY+r.bottom+8))+'px'; selbar.style.left=Math.max(8,l)+'px'; }

function updSel(){ const s=window.getSelection(); if(!s||s.rangeCount===0||s.isCollapsed){ if(!currentHlNode)selbar.style.display='none'; return; } const r=s.getRangeAt(0); lastRange=r.cloneRange(); currentHlNode=null; btnNote.style.display='block'; btnHL.style.display='block'; btnUH.style.display='none'; posSelbar(r.getBoundingClientRect()); }

left.onmouseup=updSel; right.onmouseup=updSel;
document.onselectionchange=()=>{ const s=window.getSelection(); if((!s||s.rangeCount===0||s.isCollapsed)&&!currentHlNode)selbar.style.display='none'; };
document.addEventListener('click',(e)=>{ if(e.target.classList&&(e.target.classList.contains('hl')||e.target.classList.contains('note'))){ currentHlNode=e.target; lastRange=null; btnNote.style.display='none'; btnHL.style.display='none'; btnUH.style.display='block'; posSelbar(e.target.getBoundingClientRect()); const s=window.getSelection(); if(s)s.removeAllRanges(); }}, true);

btnHL.onclick=()=>{ if(currentHlNode||!lastRange||lastRange.collapsed)return; const s=document.createElement('span'); s.className='hl'; try{ lastRange.surroundContents(s); }catch(e){ const w=document.createElement('span'); w.className='hl'; w.appendChild(lastRange.cloneContents()); lastRange.deleteContents(); lastRange.insertNode(w); } selbar.style.display='none'; saveHighlights(); };

btnNote.onclick=()=>{ if(currentHlNode||!lastRange||lastRange.collapsed)return; const s=document.createElement('span'); s.className='note'; try{ lastRange.surroundContents(s); }catch(e){ const w=document.createElement('span'); w.className='note'; w.appendChild(lastRange.cloneContents()); lastRange.deleteContents(); lastRange.insertNode(w); } selbar.style.display='none'; saveHighlights(); };

btnUH.onclick=()=>{ if(currentHlNode){ const p=currentHlNode.parentNode; while(currentHlNode.firstChild)p.insertBefore(currentHlNode.firstChild,currentHlNode); p.removeChild(currentHlNode); p.normalize(); currentHlNode=null; selbar.style.display='none'; saveHighlights(); }else if(lastRange){ const sR=lastRange.getBoundingClientRect(); const w=document.createTreeWalker(document.body,NodeFilter.SHOW_ELEMENT); const tr=[]; while(w.nextNode()){ const n=w.currentNode; if(n.classList&&(n.classList.contains('hl')||n.classList.contains('note'))){ const r=n.getBoundingClientRect(); if(!(r.right<sR.left||r.left>sR.right||r.bottom<sR.top||r.top>sR.bottom))tr.push(n); }} tr.forEach(el=>{ const p=el.parentNode; while(el.firstChild)p.insertBefore(el.firstChild,el); p.removeChild(el); p.normalize(); }); selbar.style.display='none'; saveHighlights(); }};

document.querySelectorAll('.flag-btn').forEach(btn => {
  btn.onclick = e => {
    e.stopPropagation();
    btn.classList.toggle('active');
    saveFlags();
  };
});

const answerKey={
    q27:"NO", q28:"NOT GIVEN", q29:"YES", q30:"NO", q31:"YES",
    q32:"D", q33:"A", q34:"C", q35:"C",
    q36:"I", q37:"A", q38:"C", q39:"B", q40:"D"
};
let lastResults=[];

function saveAnswers() {
  const data = {};
  // Save Radios
  document.querySelectorAll('input[type="radio"]:checked').forEach(el => {
    data[el.name] = el.value;
  });
  // Save Selects (for Q36-40)
  document.querySelectorAll('select').forEach(el => {
      if(el.value) data[el.name] = el.value;
  });
  localStorage.setItem(`${PAPER_ID}_answers`, JSON.stringify(data));
}

function loadAnswers() {
  const data = JSON.parse(localStorage.getItem(`${PAPER_ID}_answers`) || '{}');
  Object.keys(data).forEach(q => {
    // Try Radio
    const radio = document.querySelector(`input[name="${q}"][value="${data[q]}"]`);
    if(radio) radio.checked = true;
    // Try Select
    const sel = document.querySelector(`select[name="${q}"]`);
    if(sel) sel.value = data[q];
  });
}

function saveFlags() {
  const flags = [...document.querySelectorAll('.flag-btn.active')].map(b => b.dataset.q);
  localStorage.setItem(`${PAPER_ID}_flags`, JSON.stringify(flags));
}

function loadFlags() {
  const flags = JSON.parse(localStorage.getItem(`${PAPER_ID}_flags`) || '[]');
  flags.forEach(q => document.querySelector(`[data-q="${q}"]`)?.classList.add('active'));
}

function saveHighlights() {
  const highlights = { left: [], right: [] };
  document.querySelectorAll('#left .hl, #left .note').forEach((el, idx) => {
    highlights.left.push({ type: el.classList.contains('hl') ? 'hl' : 'note', text: el.textContent, index: idx });
  });
  document.querySelectorAll('#right .hl, #right .note').forEach((el, idx) => {
    highlights.right.push({ type: el.classList.contains('hl') ? 'hl' : 'note', text: el.textContent, index: idx });
  });
  localStorage.setItem(`${PAPER_ID}_highlights`, JSON.stringify(highlights));
}

function loadHighlights() {
  const data = JSON.parse(localStorage.getItem(`${PAPER_ID}_highlights`) || '{"left":[],"right":[]}');
  ['left', 'right'].forEach(side => {
    if(data[side] && data[side].length > 0) {
      const container = document.getElementById(side);
      data[side].forEach(item => {
        const walker = document.createTreeWalker(container, NodeFilter.SHOW_TEXT);
        let node;
        while(node = walker.nextNode()) {
          if(node.textContent.includes(item.text)) {
            const span = document.createElement('span');
            span.className = item.type;
            const parent = node.parentNode;
            const text = node.textContent;
            const idx = text.indexOf(item.text);
            if(idx >= 0) {
              const before = text.substring(0, idx);
              const match = text.substring(idx, idx + item.text.length);
              const after = text.substring(idx + item.text.length);
              parent.insertBefore(document.createTextNode(before), node);
              span.textContent = match;
              parent.insertBefore(span, node);
              parent.insertBefore(document.createTextNode(after), node);
              parent.removeChild(node);
              break;
            }
          }
        }
      });
    }
  });
}

// Event Listeners for Input Changes
document.querySelectorAll('input[type="radio"], select').forEach(el => {
  el.addEventListener('change', saveAnswers);
});

document.addEventListener('DOMContentLoaded', () => {
  loadAnswers();
  loadFlags();
  loadHighlights();
});

function submitAnswers(){ 
  const res=[]; let cor=0; 
  Object.keys(answerKey).forEach(q=>{ 
    let uA = "";
    // Check radio
    const radio = document.querySelector(`input[name="${q}"]:checked`);
    if(radio) uA = radio.value;
    // Check select (if radio not found or for select types)
    const sel = document.querySelector(`select[name="${q}"]`);
    if(sel) uA = sel.value;

    const cA=answerKey[q]; 
    const iC=uA===cA; 
    if(iC)cor++; 
    res.push({id:q,userAns:uA,correctAns:cA,isCorrect:iC}); 
  }); 
  lastResults=res; 
  const tot=Object.keys(answerKey).length; 
  const pct=((cor/tot)*100).toFixed(1); 
  localStorage.setItem(`ielts_score_${PAPER_ID}`, `${cor}/${tot}`);
  document.getElementById('resultContent').innerHTML=`<div class="result-summary"><div class="result-score">${cor} / ${tot}</div><div style="margin-top:8px;font-size:18px;">${pct}%</div></div>${res.map(r=>`<div class="result-item ${r.isCorrect?'correct':'incorrect'}"><div><strong>${r.id}</strong> ${r.isCorrect?'‚úì':'‚úó'}</div><div>‰Ω†ÁöÑÁ≠îÊ°à: ${r.userAns||'(Êú™‰ΩúÁ≠î)'}</div>${!r.isCorrect?`<div>Ê≠£Á°ÆÁ≠îÊ°à: ${r.correctAns}</div>`:''}</div>`).join('')}`; 
  document.getElementById('resultModal').classList.add('active'); 
}

function resetForm(){ document.getElementById('resetModal').classList.add('active'); }

function confirmReset(){ 
  const tp=document.querySelector('input[name="resetType"]:checked').value; 
  document.querySelectorAll('input[type="radio"]').forEach(i=>i.checked=false); 
  document.querySelectorAll('select').forEach(i=>i.value=""); // Reset selects
  localStorage.removeItem(`${PAPER_ID}_answers`);
  
  if(tp==='all'){ 
    document.querySelectorAll('.hl').forEach(el=>{ const p=el.parentNode; while(el.firstChild)p.insertBefore(el.firstChild,el); p.removeChild(el); p.normalize(); }); 
    document.querySelectorAll('.note').forEach(el=>{ const p=el.parentNode; while(el.firstChild)p.insertBefore(el.firstChild,el); p.removeChild(el); p.normalize(); }); 
    document.querySelectorAll('.flag-btn').forEach(b => b.classList.remove('active'));
    localStorage.removeItem(`${PAPER_ID}_highlights`);
    localStorage.removeItem(`${PAPER_ID}_flags`);
  } 
  closeModal('resetModal'); 
}

function addWrongToBook(){ const wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); const wr=lastResults.filter(r=>!r.isCorrect); wr.forEach(r=>{ const en={paperId:PAPER_ID,title:'Life on Mars?',questionId:r.id,correctAnswer:r.correctAns,myAnswer:r.userAns||'(Êú™‰ΩúÁ≠î)',date:new Date().toISOString().split('T')[0]}; const ix=wb.findIndex(i=>i.paperId===en.paperId&&i.questionId===en.questionId); if(ix>=0)wb[ix]=en; else wb.push(en); }); localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); alert(`Â∑≤Ê∑ªÂä† ${wr.length} ÈÅìÈîôÈ¢ò`); closeModal('resultModal'); }

function deleteWrongItem(pId,qId){ if(!confirm('Á°ÆÂÆöÂà†Èô§ËøôÈÅìÈîôÈ¢òÔºü'))return; let wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); wb=wb.filter(i=>!(i.paperId===pId&&i.questionId===qId)); localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); openWrongBook(); }

function clearCurrentWrongBook(){ if(!confirm('Á°ÆÂÆöÊ∏ÖÁ©∫Êú¨ÁØáÊâÄÊúâÈîôÈ¢òÔºü'))return; let wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); wb=wb.filter(i=>i.paperId!==PAPER_ID); localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); openWrongBook(); }

function openWrongBook(){ const wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); const cu=wb.filter(i=>i.paperId===PAPER_ID); const ct=document.getElementById('wrongBookContent'); if(cu.length===0)ct.innerHTML='<div style="text-align:center;padding:40px;color:#666;">ÊöÇÊó†ÈîôÈ¢ò</div>'; else ct.innerHTML=`<div class="modal-actions"><button class="btn-danger" onclick="clearCurrentWrongBook()" style="width:100%;">üóëÔ∏è Ê∏ÖÁ©∫Êú¨ÁØáÈîôÈ¢ò</button></div>${cu.map(i=>`<div class="wrong-item"><div class="wrong-item-content"><div style="font-weight:600;margin-bottom:8px;">${i.questionId}</div><div style="font-size:13px;color:#666;"><div>‚úì Ê≠£Á°Æ: ${i.correctAnswer}</div><div style="color:#d32f2f;">‚úó ÊàëÁöÑ: ${i.myAnswer}</div></div></div><button class="btn-delete" onclick="deleteWrongItem('${i.paperId}','${i.questionId}')">Âà†Èô§</button></div>`).join('')}`; document.getElementById('wrongBookModal').classList.add('active'); }

function closeModal(id){ document.getElementById(id).classList.remove('active'); }
</script>
</body>
</html>