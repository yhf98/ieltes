<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>P3 ‚Äì Jean Piaget (1896‚Äì1980)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  * { box-sizing: border-box; margin:0; padding:0; }
  html,body { height:100%; }
  body { font-family: Arial, sans-serif; background:#f5f5f5; }
  
  #timer { position:fixed; top:12px; right:12px; background:#fff; border:1px solid #ddd; border-radius:6px; padding:8px 12px; font-size:16px; font-weight:600; color:#0066cc; z-index:1000; }
  
  .shell { display:flex; height:100vh; width:100%; }
  .pane { background:#fff; overflow:auto; padding:24px; }
  #left { flex: 0 0 50%; border-right:1px solid #ddd; }
  #right { flex: 1 1 auto; background:#fafafa; }
  #divider { flex: 0 0 5px; background:#ddd; cursor: ew-resize; }
  #divider:hover { background:#999; }
  
  h2,h3,h4 { margin:0 0 12px; color:#333; }
  h2 { font-size:20px; }
  h3 { font-size:18px; color:#0066cc; }
  h4 { font-size:15px; font-weight:600; margin-top:20px; }
  
  #left p { margin: 0 0 14px; line-height: 1.7; text-align:justify; }
  
  .dialogue { margin:20px 0; padding:16px; background:#f9f9f9; border-left:4px solid #0066cc; border-radius:4px; }
  .dialogue-line { margin:6px 0; font-size:14px; }
  .dialogue-line strong { color:#0066cc; min-width:80px; display:inline-block; }
  
  .group { background:#fff; border:1px solid #ddd; border-radius:6px; padding:16px; margin-bottom:16px; }
  .group h4 { margin-top:0; color:#0066cc; }
  .group p { margin:8px 0; font-size:14px; line-height:1.6; }
  
  .flag-btn { 
    position:absolute; 
    left:2px; 
    top:50%;
    transform:translateY(-50%);
    width:8px;
    height:8px;
    border-radius:50%;
    background:#ddd;
    cursor:pointer;
    z-index:10;
  }
  .flag-btn:hover { background:#999; }
  .flag-btn.active { background:#ff5722; }
  
  .match-area { margin:16px 0; }
  .match-options { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:16px; padding:12px; background:#f9f9f9; border-radius:6px; min-height:50px; }
  .match-option { 
    padding:8px 16px; 
    background:#fff; 
    border:1px solid #ddd; 
    border-radius:6px; 
    cursor:move; 
    font-size:14px;
    user-select:none;
  }
  .match-option:hover { background:#f0f0f0; }
  .match-option.dragging { opacity:0.5; }
  
  .match-dropzone { 
    min-width:100px; 
    min-height:36px; 
    padding:6px 12px; 
    margin-left:12px; 
    border:2px dashed #ddd; 
    border-radius:6px; 
    display:flex; 
    align-items:center; 
    justify-content:center; 
    font-size:14px; 
    font-weight:600; 
    color:#666;
  }
  .match-dropzone.drag-over { background:#e3f2fd; border-color:#0066cc; }
  .match-dropzone.filled { background:#e8f5e9; border-color:#4caf50; border-style:solid; }
  
  .summary-box { padding:16px; background:#f9f9f9; border-radius:6px; margin:16px 0; line-height:2; font-size:14px; }
  
  .group ol { margin-left:20px; }
  .group ol li { margin:12px 0; font-size:14px; line-height:1.6; position:relative; }
  .group ol li label { display:inline-block; margin-right:8px; }
  
  .bottom-bar { display:flex; gap:10px; margin-top:16px; }
  button { padding:10px 20px; border:1px solid #999; border-radius:6px; background:#fff; cursor:pointer; font-size:14px; }
  button:hover { background:#f0f0f0; }
  .btn-primary { background:#0066cc; color:#fff; border-color:#0066cc; }
  .btn-primary:hover { background:#0052a3; }
  .btn-danger { background:#dc3545; color:#fff; border-color:#dc3545; }
  .btn-danger:hover { background:#c82333; }
  
  .hl { background:#fff59d; cursor:pointer; }
  .hl:hover { background:#ffeb3b; }
  .note { background:#b3d9ff; cursor:pointer; }
  .note:hover { background:#99ccff; }
  
  #selbar { position:fixed; display:none; z-index:2000; background:#fff; border:1px solid #ddd; border-radius:8px; padding:8px; gap:0; box-shadow:0 2px 8px rgba(0,0,0,0.15); flex-direction:column; min-width:120px; }
  #selbar button { background:#fff; color:#666; border:none; padding:3px 0px; cursor:pointer; font-size:14px; text-align:center; border-radius:4px; }
  #selbar button:hover { background:#f5f5f5; color:#333; }
  
  .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:3000; align-items:center; justify-content:center; }
  .modal.active { display:flex; }
  .modal-content { background:#fff; border-radius:8px; padding:24px; max-width:600px; width:90%; max-height:80vh; overflow-y:auto; }
  
  .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
  .modal-header h2 { font-size: 28px; color: #333; margin: 0; }
  .modal-close { font-size: 32px; cursor: pointer; color: #999; line-height: 1; }
  .modal-close:hover { color: #333; }
  
  .result-summary { text-align:center; padding:20px; background:#f0f0f0; margin-bottom:16px; border-radius:6px; }
  .result-score { font-size:36px; font-weight:600; color:#0066cc; }
  .result-item { padding:10px; margin:8px 0; border-left:3px solid #ddd; background:#f9f9f9; font-size:13px; }
  .result-item.correct { border-left-color:#28a745; background:#e8f5e9; }
  .result-item.incorrect { border-left-color:#dc3545; background:#ffebee; }
  
  .wrong-item { background:#fff3e0; padding:16px; margin:8px 0; border-radius:8px; border-left:4px solid #ff9800; display:flex; justify-content:space-between; align-items:start; }
  .wrong-item-content { flex:1; }
  .btn-delete { background:#dc3545; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-size:13px; margin-left:12px; }
  .btn-delete:hover { background:#c82333; }
  .modal-actions { display:flex; gap:10px; margin-bottom:20px; }
</style>
</head>
<body>
<div id="timer">00:00</div>

<div class="shell">
  <section class="pane" id="left">
    
<h2>READING PASSAGE 3</h2>
<p>You should spend about 20 minutes on Questions 27-40, which are based on Reading Passage 3 below.</p>
<h3>Jean Piaget (1896‚Äì1980)</h3>
<p style="font-style:italic;">Seymour Papert looks at the work of the pioneering Swiss philosopher and psychologist</p>

<p>Jean Piaget spent much of his professional life listening to children, watching children and poring over reports of researchers around the world who were doing the same. He found, to put it most succinctly, that children don't think like grown-ups. After thousands of interactions with young people often barely old enough to talk, Piaget began to suspect that behind their cute and seemingly irrational utterances were thought processes that had their own kind of order and their own special logic. Einstein called it "a discovery so simple that only a genius could have thought of it."</p>

<p>Although not an educational reformer, Piaget championed a way of thinking about children that provided the foundation for today's education-reform movements. It was a shift comparable to the way modern anthropology displaced stories of primitive tribes being 'noble savages' and 'cannibals'. One might say that Piaget was the first to take children's thinking seriously.</p>

<p>He has been revered by generations of teachers inspired by the belief that children are not empty vessels to be filled with knowledge (as traditional pedagogical theory had it) but active builders of knowledge‚Äîlittle scientists who are constantly creating and testing their own hypotheses about the world. And though he may not be as famous as Sigmund Freud or even B. F. Skinner, his influence on psychology may be longer lasting.</p>

<p>In 1920, while doing research in a child-psychology laboratory in Paris, Piaget noticed that children of the same age made similar errors on intelligence tests. Fascinated by their reasoning processes, he began to suspect that the key to human knowledge might be discovered by observing how the child's mind develops. On his return to Switzerland he began watching children play, scrupulously recording their words and actions as their minds raced to find reasons for why things are the way they are. In one of his most famous experiments, Piaget asked children, 'What makes the wind?' A typical dialogue would be:</p>

<div class="dialogue">
  <div class="dialogue-line"><strong>Piaget</strong> What makes the wind?</div>
  <div class="dialogue-line"><strong>Julia</strong> The trees.</div>
  <div class="dialogue-line"><strong>Piaget</strong> How do you know?</div>
  <div class="dialogue-line"><strong>Julia</strong> I saw them waving their arms.</div>
  <div class="dialogue-line"><strong>Piaget</strong> How does that make the wind?</div>
  <div class="dialogue-line"><strong>Julia</strong> (waving her hand in front of his face)<br>Like this. Only they are bigger. And there are lots of trees.</div>
</div>

<p>Piaget recognised that five-year-old Julia's beliefs, while not correct by any adult criterion, are not 'incorrect' either. They are entirely sensible and coherent within the framework of the child's way of knowing. Classifying them as 'true' or 'false' misses the point and shows a lack of respect for the child. What Piaget was after was a theory that the wind dialogue demonstrated coherence, ingenuity and the practice of a kind of explanatory principle (in this case by referring to body actions) that stands young children in very good stead when they don't know enough or don't have enough skill to handle the kind of explanation that grown-ups prefer.</p>

<p>Piaget was not an educator and never laid down rules about how to intervene in such situations. But his work strongly suggests that the automatic reaction of putting the child right may well be counter-productive. If their theories are always greeted by 'Nice try, but this is how it really is‚Ä¶' they might give up after a while on making theories. As Piaget put it, 'children have real understanding only of that which they invent themselves, and each time that we try to teach them something too quickly, we keep them from inventing it themselves.'</p>

<p>Disciples of Piaget have a tolerance for‚Äîindeed a fascination with‚Äîchildren's primitive laws of physics: that things disappear when they are out of sight; that the moon and the sun follow you around; that big things float and small things sink. Einstein was intrigued by Piaget's findings, especially by the idea that seven-year-olds insist that going faster can take more time‚Äîperhaps because this, like Einstein's own theories of relativity, runs so contrary to common sense.</p>

<p>Although every teacher in training still memorises Piaget's successive stages of childhood development, the greater part of Piaget's work is less well known, perhaps because schools of education regard it as 'too deep' for teachers. Piaget never thought of himself as a child psychologist. His real interest was epistemology‚Äîthe theory of knowledge‚Äîwhich, like physics, was considered a branch of philosophy until Piaget came along and made it a science.</p>

<p>Through epistemology, Piaget explored multiple ways of knowing. He acknowledged them and examined them non-judgementally, yet with a philosopher's analytic rigour. Since Piaget, the territory has been widely colonised by those who write about women's ways of knowing, Afrocentric ways of knowing, even the computer's ways of knowing. Indeed, artificial intelligence and the information-processing model of the mind owe more to Piaget than its proponents may realise.</p>

<p>The core of Piaget is his belief that looking carefully at how knowledge develops in children will elucidate the nature of knowledge in general. Whether this has in fact led to deeper understanding remains, like everything about Piaget, controversial. In the past decade, Piaget has been vigorously challenged by the current fashion of viewing knowledge as an intrinsic property of the brain. Ingenious experiments have demonstrated that newborn infants already have some of the knowledge that Piaget believed children constructed. But for those, like me, who still see Piaget as the giant in the field of cognitive theory, the difference between what the baby brings and what the adult has is so immense that the new discoveries do not significantly reduce the gap, but only increase the mystery.</p>

  </section>

  <div id="divider" title="Drag to resize"></div>

  <section class="pane" id="right">
    <h3>Questions</h3>

    <div class="group">
      <h4>Questions 27‚Äì31</h4>
      <p>Choose the correct letter, <strong>A, B, C or D</strong>.</p>
      <p>Write the correct letter in boxes <strong>27‚Äì31</strong> on your answer sheet.</p>

      <ol start="27">
        <li><span class="flag-btn" data-q="q27" style="left:-20px;"></span>In the second paragraph, the writer mentions the example of modern anthropology to illustrate<br>
          <label><input type="radio" name="q27" value="A"> A</label> the universality of Piaget's insights into the workings of the mind.<br>
          <label><input type="radio" name="q27" value="B"> B</label> the similarity between children's thought-processing in different cultures.<br>
          <label><input type="radio" name="q27" value="C"> C</label> how Piaget's work represents a crucial turning-point in our approach to education.<br>
          <label><input type="radio" name="q27" value="D"> D</label> how Piaget's work has aided our understanding of humankind's evolution from primitive origins.
        </li>
        <li><span class="flag-btn" data-q="q28" style="left:-20px;"></span>According to the writer, what point is illustrated by the dialogue about the wind?<br>
          <label><input type="radio" name="q28" value="A"> A</label> The factual accuracy of what children say is of minor significance.<br>
          <label><input type="radio" name="q28" value="B"> B</label> Children want to learn about scientific principles.<br>
          <label><input type="radio" name="q28" value="C"> C</label> Children's reasoning processes can be amusing to adults.<br>
          <label><input type="radio" name="q28" value="D"> D</label> Children often pretend that they know the answers to questions.
        </li>
        <li><span class="flag-btn" data-q="q29" style="left:-20px;"></span>Piaget believed in the importance of<br>
          <label><input type="radio" name="q29" value="A"> A</label> preventing children from making false assumptions.<br>
          <label><input type="radio" name="q29" value="B"> B</label> giving children honest feedback on their hypotheses.<br>
          <label><input type="radio" name="q29" value="C"> C</label> showing children how to formulate their own ideas about the world.<br>
          <label><input type="radio" name="q29" value="D"> D</label> maintaining children's confidence in their ability to interpret the world.
        </li>
        <li><span class="flag-btn" data-q="q30" style="left:-20px;"></span>What does the writer suggest in the seventh paragraph?<br>
          <label><input type="radio" name="q30" value="A"> A</label> Children's sense of their surroundings changes as they get older.<br>
          <label><input type="radio" name="q30" value="B"> B</label> Children are able to grasp certain complex ideas as well as adults are.<br>
          <label><input type="radio" name="q30" value="C"> C</label> Even apparently irrational ideas can be worthy of interest.<br>
          <label><input type="radio" name="q30" value="D"> D</label> Sometimes the simplest explanations are the best.
        </li>
        <li><span class="flag-btn" data-q="q31" style="left:-20px;"></span>The writer's main purpose is to<br>
          <label><input type="radio" name="q31" value="A"> A</label> outline Piaget's contribution to a range of scientific fields.<br>
          <label><input type="radio" name="q31" value="B"> B</label> summarise how education has benefited from Piaget's findings.<br>
          <label><input type="radio" name="q31" value="C"> C</label> discuss Piaget's role in the development of 20th-century psychology.<br>
          <label><input type="radio" name="q31" value="D"> D</label> express doubts about a number of Piaget's theories.
        </li>
      </ol>
    </div>

    <div class="group">
      <h4>Questions 32‚Äì36</h4>
      <p>Complete the summary using the list of words, <strong>A‚ÄìI</strong>, below.</p>
      <p>Write the correct letter, <strong>A‚ÄìI</strong>, in boxes <strong>32‚Äì36</strong> on your answer sheet.</p>

      <div style="background:#f0f0f0; padding:12px; margin:12px 0; border-radius:6px;">
        <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; font-size:13px;">
          <div><strong>A</strong> correct</div>
          <div><strong>B</strong> theories</div>
          <div><strong>C</strong> brain</div>
          <div><strong>D</strong> simple</div>
          <div><strong>E</strong> teachers</div>
          <div><strong>F</strong> psychology</div>
          <div><strong>G</strong> logical</div>
          <div><strong>H</strong> thought</div>
          <div><strong>I</strong> philosophers</div>
        </div>
      </div>

      <div class="summary-box">
        Piaget maintained that children's mental processes were far more <span style="display:inline-flex; align-items:center;"><span class="flag-btn" data-q="q32" style="position:relative;left:0;top:0;transform:none;margin-right:4px;"></span><span class="match-dropzone" data-q="q32" style="display:inline-flex;min-width:80px;margin:0 4px;vertical-align:middle;">32</span></span> than they might appear. He encouraged the view that a child was not a 'blank slate' waiting to be filled with information, but rather a systematic builder of knowledge who regularly tries out his or her own <span style="display:inline-flex; align-items:center;"><span class="flag-btn" data-q="q33" style="position:relative;left:0;top:0;transform:none;margin-right:4px;"></span><span class="match-dropzone" data-q="q33" style="display:inline-flex;min-width:80px;margin:0 4px;vertical-align:middle;">33</span></span> about the world.
        <br><br>
        Piaget's impact on the area of <span style="display:inline-flex; align-items:center;"><span class="flag-btn" data-q="q34" style="position:relative;left:0;top:0;transform:none;margin-right:4px;"></span><span class="match-dropzone" data-q="q34" style="display:inline-flex;min-width:100px;margin:0 4px;vertical-align:middle;">34</span></span> could well outlast that of more celebrated pioneers of this discipline. Despite doubts cast over his ideas by the current view associating knowledge exclusively with the <span style="display:inline-flex; align-items:center;"><span class="flag-btn" data-q="q35" style="position:relative;left:0;top:0;transform:none;margin-right:4px;"></span><span class="match-dropzone" data-q="q35" style="display:inline-flex;min-width:80px;margin:0 4px;vertical-align:middle;">35</span></span>, the effects of his work are still strong today. His principles are still widely used in the professional development of <span style="display:inline-flex; align-items:center;"><span class="flag-btn" data-q="q36" style="position:relative;left:0;top:0;transform:none;margin-right:4px;"></span><span class="match-dropzone" data-q="q36" style="display:inline-flex;min-width:80px;margin:0 4px;vertical-align:middle;">36</span></span>.
      </div>

      <div class="match-area">
        <div class="match-options" id="wordOptions">
          <div class="match-option" draggable="true" data-value="A">A</div>
          <div class="match-option" draggable="true" data-value="B">B</div>
          <div class="match-option" draggable="true" data-value="C">C</div>
          <div class="match-option" draggable="true" data-value="D">D</div>
          <div class="match-option" draggable="true" data-value="E">E</div>
          <div class="match-option" draggable="true" data-value="F">F</div>
          <div class="match-option" draggable="true" data-value="G">G</div>
          <div class="match-option" draggable="true" data-value="H">H</div>
          <div class="match-option" draggable="true" data-value="I">I</div>
        </div>
      </div>
    </div>

    <div class="group">
      <h4>Questions 37‚Äì40</h4>
      <p>Do the following statements agree with the claims of the writer in Reading Passage 3?</p>
      <p>In boxes <strong>37‚Äì40</strong> on your answer sheet, write</p>
      <div style="margin-left:20px; margin-top:8px;">
        <div><strong>YES</strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if the statement agrees with the claims of the writer</div>
        <div><strong>NO</strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if the statement contradicts the claims of the writer</div>
        <div><strong>NOT GIVEN</strong>&nbsp;&nbsp;if it is impossible to say what the writer thinks about this</div>
      </div>

      <ol start="37">
        <li><span class="flag-btn" data-q="q37" style="left:-20px;"></span>Piaget's early work in Paris involved innovative research techniques.<br>
          <label><input type="radio" name="q37" value="YES"> YES</label>
          <label><input type="radio" name="q37" value="NO"> NO</label>
          <label><input type="radio" name="q37" value="NOT GIVEN"> NOT GIVEN</label>
        </li>
        <li><span class="flag-btn" data-q="q38" style="left:-20px;"></span>Piaget gave clear guidelines as to how adults should give information to children.<br>
          <label><input type="radio" name="q38" value="YES"> YES</label>
          <label><input type="radio" name="q38" value="NO"> NO</label>
          <label><input type="radio" name="q38" value="NOT GIVEN"> NOT GIVEN</label>
        </li>
        <li><span class="flag-btn" data-q="q39" style="left:-20px;"></span>Piaget made a significant contribution to the field of epistemology.<br>
          <label><input type="radio" name="q39" value="YES"> YES</label>
          <label><input type="radio" name="q39" value="NO"> NO</label>
          <label><input type="radio" name="q39" value="NOT GIVEN"> NOT GIVEN</label>
        </li>
        <li><span class="flag-btn" data-q="q40" style="left:-20px;"></span>We still have much to learn about the nature of knowledge.<br>
          <label><input type="radio" name="q40" value="YES"> YES</label>
          <label><input type="radio" name="q40" value="NO"> NO</label>
          <label><input type="radio" name="q40" value="NOT GIVEN"> NOT GIVEN</label>
        </li>
      </ol>
    </div>

    <div class="bottom-bar">
      <button class="btn-primary" onclick="submitAnswers()">Êèê‰∫§</button>
      <button onclick="resetForm()">ÈáçÁΩÆ</button>
      <button onclick="openWrongBook()">Êú¨ÁØáÈîôÈ¢ò</button>
    </div>
  </section>
</div>

<div id="selbar">
  <button id="btnNote">Note</button>
  <button id="btnHL">Highlight</button>
  <button id="btnUH" style="display:none;">Clear Highlight</button>
</div>

<div class="modal" id="resultModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ÊàêÁª©</h2>
      <span class="modal-close" onclick="closeModal('resultModal')">√ó</span>
    </div>
    <div id="resultContent"></div>
    <button class="btn-primary" style="width:100%; margin-top:16px;" onclick="addWrongToBook()">Âä†ÂÖ•ÈîôÈ¢òÊú¨</button>
  </div>
</div>

<div class="modal" id="wrongBookModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Êú¨ÁØáÈîôÈ¢ò</h2>
      <span class="modal-close" onclick="closeModal('wrongBookModal')">√ó</span>
    </div>
    <div id="wrongBookContent"></div>
  </div>
</div>

<div class="modal" id="resetModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ÈáçÁΩÆÁªÉ‰π†</h2>
      <span class="modal-close" onclick="closeModal('resetModal')">√ó</span>
    </div>
    <div style="margin:16px 0;">
      <label style="display:block; margin-bottom:10px;">
        <input type="radio" name="resetType" value="answers" checked>
        Âè™Ê∏ÖÁ©∫Á≠îÊ°à
      </label>
      <label style="display:block;">
        <input type="radio" name="resetType" value="all">
        Ê∏ÖÁ©∫Á≠îÊ°àÂíåÊ†áËÆ∞
      </label>
    </div>
    <button class="btn-primary" style="width:100%;" onclick="confirmReset()">Á°ÆÂÆö</button>
  </div>
</div>

<script>
const PAPER_ID='P3_JEAN_PIAGET';

let t=0;
const timerEl=document.getElementById('timer');
setInterval(()=>{ t++; timerEl.textContent=String(Math.floor(t/60)).padStart(2,'0')+':'+String(t%60).padStart(2,'0'); }, 1000);

const divider=document.getElementById('divider'), left=document.getElementById('left'), right=document.getElementById('right');
let dragging=false;
divider.onmousedown=()=>{ dragging=true; document.body.style.cursor='ew-resize'; };
window.onmousemove=(e)=>{ if(!dragging)return; const c=document.querySelector('.shell').getBoundingClientRect(); let x=e.clientX-c.left; x=Math.max(280,Math.min(c.width-280,x)); left.style.flex='0 0 '+x+'px'; right.style.flex='1 1 auto'; };
window.onmouseup=()=>{ dragging=false; document.body.style.cursor=''; };

const selbar=document.getElementById('selbar'), btnHL=document.getElementById('btnHL'), btnUH=document.getElementById('btnUH'), btnNote=document.getElementById('btnNote');
let lastRange=null, currentHlNode=null;

function posSelbar(r){ selbar.style.display='flex'; const t=window.scrollY+r.top-selbar.offsetHeight-8; const l=window.scrollX+r.left+r.width/2-selbar.offsetWidth/2; selbar.style.top=((t>0)?t:(window.scrollY+r.bottom+8))+'px'; selbar.style.left=Math.max(8,l)+'px'; }

function updSel(){ const s=window.getSelection(); if(!s||s.rangeCount===0||s.isCollapsed){ if(!currentHlNode)selbar.style.display='none'; return; } const r=s.getRangeAt(0); lastRange=r.cloneRange(); currentHlNode=null; btnNote.style.display='block'; btnHL.style.display='block'; btnUH.style.display='none'; posSelbar(r.getBoundingClientRect()); }

left.onmouseup=updSel; right.onmouseup=updSel;
document.onselectionchange=()=>{ const s=window.getSelection(); if((!s||s.rangeCount===0||s.isCollapsed)&&!currentHlNode)selbar.style.display='none'; };
document.addEventListener('click',(e)=>{ if(e.target.classList&&(e.target.classList.contains('hl')||e.target.classList.contains('note'))){ currentHlNode=e.target; lastRange=null; btnNote.style.display='none'; btnHL.style.display='none'; btnUH.style.display='block'; posSelbar(e.target.getBoundingClientRect()); const s=window.getSelection(); if(s)s.removeAllRanges(); }}, true);

btnHL.onclick=()=>{ if(currentHlNode||!lastRange||lastRange.collapsed)return; const s=document.createElement('span'); s.className='hl'; try{ lastRange.surroundContents(s); }catch(e){ const w=document.createElement('span'); w.className='hl'; w.appendChild(lastRange.cloneContents()); lastRange.deleteContents(); lastRange.insertNode(w); } selbar.style.display='none'; saveHighlights(); };

btnNote.onclick=()=>{ if(currentHlNode||!lastRange||lastRange.collapsed)return; const s=document.createElement('span'); s.className='note'; try{ lastRange.surroundContents(s); }catch(e){ const w=document.createElement('span'); w.className='note'; w.appendChild(lastRange.cloneContents()); lastRange.deleteContents(); lastRange.insertNode(w); } selbar.style.display='none'; saveHighlights(); };

btnUH.onclick=()=>{ if(currentHlNode){ const p=currentHlNode.parentNode; while(currentHlNode.firstChild)p.insertBefore(currentHlNode.firstChild,currentHlNode); p.removeChild(currentHlNode); p.normalize(); currentHlNode=null; selbar.style.display='none'; saveHighlights(); }else if(lastRange){ const sR=lastRange.getBoundingClientRect(); const w=document.createTreeWalker(document.body,NodeFilter.SHOW_ELEMENT); const tr=[]; while(w.nextNode()){ const n=w.currentNode; if(n.classList&&(n.classList.contains('hl')||n.classList.contains('note'))){ const r=n.getBoundingClientRect(); if(!(r.right<sR.left||r.left>sR.right||r.bottom<sR.top||r.top>sR.bottom))tr.push(n); }} tr.forEach(el=>{ const p=el.parentNode; while(el.firstChild)p.insertBefore(el.firstChild,el); p.removeChild(el); p.normalize(); }); selbar.style.display='none'; saveHighlights(); }};

document.querySelectorAll('.flag-btn').forEach(btn => {
  btn.onclick = e => {
    e.stopPropagation();
    btn.classList.toggle('active');
    saveFlags();
  };
});

let draggedElement = null;

document.querySelectorAll('.match-option').forEach(opt => {
  opt.addEventListener('dragstart', e => {
    draggedElement = e.target;
    e.target.classList.add('dragging');
  });
  
  opt.addEventListener('dragend', e => {
    e.target.classList.remove('dragging');
  });
});

document.querySelectorAll('.match-dropzone').forEach(zone => {
  zone.addEventListener('dragover', e => {
    e.preventDefault();
    zone.classList.add('drag-over');
  });
  
  zone.addEventListener('dragleave', () => {
    zone.classList.remove('drag-over');
  });
  
  zone.addEventListener('drop', e => {
    e.preventDefault();
    zone.classList.remove('drag-over');
    if(draggedElement) {
      zone.textContent = draggedElement.dataset.value;
      zone.classList.add('filled');
      saveAnswers();
    }
  });
  
  zone.addEventListener('click', () => {
    zone.textContent = '';
    zone.classList.remove('filled');
    saveAnswers();
  });
});

const answerKey={q27:"C",q28:"A",q29:"D",q30:"C",q31:"A",q32:"G",q33:"B",q34:"F",q35:"C",q36:"E",q37:"NOT GIVEN",q38:"NO",q39:"YES",q40:"YES"};
let lastResults=[];

function saveAnswers() {
  const data = {};
  Object.keys(answerKey).forEach(q => {
    const ch = document.querySelector(`input[name="${q}"]:checked`);
    if(ch) data[q] = ch.value;
  });
  document.querySelectorAll('.match-dropzone').forEach(zone => {
    if(zone.textContent && zone.textContent.trim() && zone.dataset.q) data[zone.dataset.q] = zone.textContent.trim();
  });
  localStorage.setItem(`${PAPER_ID}_answers`, JSON.stringify(data));
}

function loadAnswers() {
  const data = JSON.parse(localStorage.getItem(`${PAPER_ID}_answers`) || '{}');
  Object.keys(data).forEach(q => {
    const radio = document.querySelector(`input[name="${q}"][value="${data[q]}"]`);
    if(radio) radio.checked = true;
    const zone = document.querySelector(`.match-dropzone[data-q="${q}"]`);
    if(zone) {
      zone.textContent = data[q];
      zone.classList.add('filled');
    }
  });
}

function saveFlags() {
  const flags = [...document.querySelectorAll('.flag-btn.active')].map(b => b.dataset.q);
  localStorage.setItem(`${PAPER_ID}_flags`, JSON.stringify(flags));
}

function loadFlags() {
  const flags = JSON.parse(localStorage.getItem(`${PAPER_ID}_flags`) || '[]');
  flags.forEach(q => document.querySelector(`[data-q="${q}"]`)?.classList.add('active'));
}

function saveHighlights() {
  const highlights = { left: [], right: [] };
  document.querySelectorAll('#left .hl, #left .note').forEach((el, idx) => {
    highlights.left.push({
      type: el.classList.contains('hl') ? 'hl' : 'note',
      text: el.textContent,
      index: idx
    });
  });
  document.querySelectorAll('#right .hl, #right .note').forEach((el, idx) => {
    highlights.right.push({
      type: el.classList.contains('hl') ? 'hl' : 'note',
      text: el.textContent,
      index: idx
    });
  });
  localStorage.setItem(`${PAPER_ID}_highlights`, JSON.stringify(highlights));
}

function loadHighlights() {
  const data = JSON.parse(localStorage.getItem(`${PAPER_ID}_highlights`) || '{"left":[],"right":[]}');
  
  if(data.left && data.left.length > 0) {
    data.left.forEach(item => {
      const walker = document.createTreeWalker(left, NodeFilter.SHOW_TEXT);
      let node;
      while(node = walker.nextNode()) {
        if(node.textContent.includes(item.text)) {
          const span = document.createElement('span');
          span.className = item.type;
          const parent = node.parentNode;
          const text = node.textContent;
          const idx = text.indexOf(item.text);
          if(idx >= 0) {
            const before = text.substring(0, idx);
            const match = text.substring(idx, idx + item.text.length);
            const after = text.substring(idx + item.text.length);
            
            parent.insertBefore(document.createTextNode(before), node);
            span.textContent = match;
            parent.insertBefore(span, node);
            parent.insertBefore(document.createTextNode(after), node);
            parent.removeChild(node);
            break;
          }
        }
      }
    });
  }
  
  if(data.right && data.right.length > 0) {
    data.right.forEach(item => {
      const walker = document.createTreeWalker(right, NodeFilter.SHOW_TEXT);
      let node;
      while(node = walker.nextNode()) {
        if(node.textContent.includes(item.text)) {
          const span = document.createElement('span');
          span.className = item.type;
          const parent = node.parentNode;
          const text = node.textContent;
          const idx = text.indexOf(item.text);
          if(idx >= 0) {
            const before = text.substring(0, idx);
            const match = text.substring(idx, idx + item.text.length);
            const after = text.substring(idx + item.text.length);
            
            parent.insertBefore(document.createTextNode(before), node);
            span.textContent = match;
            parent.insertBefore(span, node);
            parent.insertBefore(document.createTextNode(after), node);
            parent.removeChild(node);
            break;
          }
        }
      }
    });
  }
}

document.querySelectorAll('input[type="radio"]').forEach(radio => {
  radio.addEventListener('change', saveAnswers);
});

document.addEventListener('DOMContentLoaded', () => {
  loadAnswers();
  loadFlags();
  loadHighlights();
});

function submitAnswers(){ 
  const res=[]; 
  let cor=0; 
  Object.keys(answerKey).forEach(q=>{ 
    let uA="";
    const ch = document.querySelector(`input[name="${q}"]:checked`);
    if(ch) uA = ch.value;
    const zone = document.querySelector(`.match-dropzone[data-q="${q}"]`);
    if(zone && zone.textContent.trim()) uA = zone.textContent.trim();
    
    const cA=answerKey[q]; 
    const iC = uA === cA;
    if(iC)cor++; 
    res.push({id:q,userAns:uA,correctAns:cA,isCorrect:iC}); 
  }); 
  lastResults=res; 
  const tot=Object.keys(answerKey).length; 
  const pct=((cor/tot)*100).toFixed(1); 
  document.getElementById('resultContent').innerHTML=`<div class="result-summary"><div class="result-score">${cor} / ${tot}</div><div style="margin-top:8px;font-size:18px;">${pct}%</div></div>${res.map(r=>`<div class="result-item ${r.isCorrect?'correct':'incorrect'}"><div><strong>${r.id}</strong> ${r.isCorrect?'‚úì':'‚úó'}</div><div>‰Ω†ÁöÑÁ≠îÊ°à: ${r.userAns||'(Êú™‰ΩúÁ≠î)'}</div>${!r.isCorrect?`<div>Ê≠£Á°ÆÁ≠îÊ°à: ${r.correctAns}</div>`:''}</div>`).join('')}`; 
  document.getElementById('resultModal').classList.add('active'); 
}

function resetForm(){ document.getElementById('resetModal').classList.add('active'); }

function confirmReset(){ 
  const tp=document.querySelector('input[name="resetType"]:checked').value; 
  document.querySelectorAll('input[type="radio"]').forEach(i=>i.checked=false);
  document.querySelectorAll('.match-dropzone').forEach(z=>{z.textContent='';z.classList.remove('filled');});
  localStorage.removeItem(`${PAPER_ID}_answers`);
  
  if(tp==='all'){ 
    document.querySelectorAll('.hl').forEach(el=>{ const p=el.parentNode; while(el.firstChild)p.insertBefore(el.firstChild,el); p.removeChild(el); p.normalize(); }); 
    document.querySelectorAll('.note').forEach(el=>{ const p=el.parentNode; while(el.firstChild)p.insertBefore(el.firstChild,el); p.removeChild(el); p.normalize(); }); 
    document.querySelectorAll('.flag-btn').forEach(b => b.classList.remove('active'));
    localStorage.removeItem(`${PAPER_ID}_highlights`);
    localStorage.removeItem(`${PAPER_ID}_flags`);
  } 
  closeModal('resetModal'); 
}

function addWrongToBook(){ const wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); const wr=lastResults.filter(r=>!r.isCorrect); wr.forEach(r=>{ const en={paperId:PAPER_ID,title:'Jean Piaget (1896‚Äì1980)',questionId:r.id,correctAnswer:r.correctAns,myAnswer:r.userAns||'(Êú™‰ΩúÁ≠î)',date:new Date().toISOString().split('T')[0]}; const ix=wb.findIndex(i=>i.paperId===en.paperId&&i.questionId===en.questionId); if(ix>=0)wb[ix]=en; else wb.push(en); }); localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); alert(`Â∑≤Ê∑ªÂä† ${wr.length} ÈÅìÈîôÈ¢ò`); closeModal('resultModal'); }

function deleteWrongItem(pId,qId){ if(!confirm('Á°ÆÂÆöÂà†Èô§ËøôÈÅìÈîôÈ¢òÔºü'))return; let wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); wb=wb.filter(i=>!(i.paperId===pId&&i.questionId===qId)); localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); openWrongBook(); }

function clearCurrentWrongBook(){ if(!confirm('Á°ÆÂÆöÊ∏ÖÁ©∫Êú¨ÁØáÊâÄÊúâÈîôÈ¢òÔºü'))return; let wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); wb=wb.filter(i=>i.paperId!==PAPER_ID); localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); openWrongBook(); }

function openWrongBook(){ const wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); const cu=wb.filter(i=>i.paperId===PAPER_ID); const ct=document.getElementById('wrongBookContent'); if(cu.length===0)ct.innerHTML='<div style="text-align:center;padding:40px;color:#666;">ÊöÇÊó†ÈîôÈ¢ò</div>'; else ct.innerHTML=`<div class="modal-actions"><button class="btn-danger" onclick="clearCurrentWrongBook()" style="width:100%;">üóëÔ∏è Ê∏ÖÁ©∫Êú¨ÁØáÈîôÈ¢ò</button></div>${cu.map(i=>`<div class="wrong-item"><div class="wrong-item-content"><div style="font-weight:600;margin-bottom:8px;">${i.questionId}</div><div style="font-size:13px;color:#666;"><div>‚úì Ê≠£Á°Æ: ${i.correctAnswer}</div><div style="color:#d32f2f;">‚úó ÊàëÁöÑ: ${i.myAnswer}</div></div></div><button class="btn-delete" onclick="deleteWrongItem('${i.paperId}','${i.questionId}')">Âà†Èô§</button></div>`).join('')}`; document.getElementById('wrongBookModal').classList.add('active'); }

function closeModal(id){ document.getElementById(id).classList.remove('active'); }
</script>
</body>
</html>