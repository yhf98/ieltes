<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>P3 ‚Äì Movement Underwater</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  * { box-sizing: border-box; margin:0; padding:0; }
  html,body { height:100%; }
  body { font-family: Arial, sans-serif; background:#f5f5f5; }
  
  #timer { position:fixed; top:12px; right:12px; background:#fff; border:1px solid #ddd; border-radius:6px; padding:8px 12px; font-size:16px; font-weight:600; color:#0066cc; z-index:1000; }
  
  .shell { display:flex; height:100vh; width:100%; }
  .pane { background:#fff; overflow:auto; padding:24px; }
  #left { flex: 0 0 50%; border-right:1px solid #ddd; }
  #right { flex: 1 1 auto; background:#fafafa; }
  #divider { flex: 0 0 5px; background:#ddd; cursor: ew-resize; }
  #divider:hover { background:#999; }
  
  h2,h3,h4 { margin:0 0 12px; color:#333; }
  h2 { font-size:20px; }
  h3 { font-size:18px; color:#0066cc; }
  h4 { font-size:15px; font-weight:600; margin-top:20px; }
  
  #left p { margin: 0 0 14px; line-height: 1.7; text-align:justify; }
  .paragraph-label { font-weight:bold; color:#0066cc; margin-right:8px; float:left; }
  
  .group { background:#fff; border:1px solid #ddd; border-radius:6px; padding:16px; margin-bottom:16px; }
  .group h4 { margin-top:0; color:#0066cc; }
  .group p { margin:8px 0; font-size:14px; line-height:1.6; }
  
  .flag-btn { 
    position:absolute; 
    left:2px; 
    top:50%;
    transform:translateY(-50%);
    width:8px;
    height:8px;
    border-radius:50%;
    background:#ddd;
    cursor:pointer;
    z-index:10;
  }
  .flag-btn:hover { background:#999; }
  .flag-btn.active { background:#ff5722; }
  
  .group ol { margin-left:20px; }
  .group ol li { margin:12px 0; font-size:14px; line-height:1.6; position:relative; }
  .group ol li label { display:inline-block; margin-right:8px; cursor: pointer; }
  
  /* Table Styles */
  .q-table { width:100%; border-collapse:collapse; margin-top:10px; font-size:13px; }
  .q-table th, .q-table td { border:1px solid #ccc; padding:8px; vertical-align:top; }
  .q-table th { background:#f0f0f0; text-align:left; font-weight:bold; }
  
  /* Diagram Styles */
  .diagram-container { position:relative; border:1px solid #ddd; padding:20px; margin-top:10px; background:#fff; text-align:center; }
  .diagram-img-placeholder { 
    width: 250px; 
    height: 100px; 
    border: 2px dashed #ccc; 
    margin: 20px auto; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    color: #999;
    font-style: italic;
  }
  .diagram-label { font-size:13px; margin:10px 0; text-align:left; }
  .diagram-label input { width:120px; text-align:center; padding:2px; border:1px solid #ccc; border-radius:4px; }
  
  input[type="text"] { border:1px solid #ccc; border-radius:4px; padding:2px 4px; width:150px; text-align:center; }
  
  .bottom-bar { display:flex; gap:10px; margin-top:16px; }
  button { padding:10px 20px; border:1px solid #999; border-radius:6px; background:#fff; cursor:pointer; font-size:14px; }
  button:hover { background:#f0f0f0; }
  .btn-primary { background:#0066cc; color:#fff; border-color:#0066cc; }
  .btn-primary:hover { background:#0052a3; }
  .btn-danger { background:#dc3545; color:#fff; border-color:#dc3545; }
  .btn-danger:hover { background:#c82333; }
  
  .hl { background:#fff59d; cursor:pointer; }
  .hl:hover { background:#ffeb3b; }
  .note { background:#b3d9ff; cursor:pointer; }
  .note:hover { background:#99ccff; }
  
  #selbar { position:fixed; display:none; z-index:2000; background:#fff; border:1px solid #ddd; border-radius:8px; padding:8px; gap:0; box-shadow:0 2px 8px rgba(0,0,0,0.15); flex-direction:column; min-width:120px; }
  #selbar button { background:#fff; color:#666; border:none; padding:3px 0px; cursor:pointer; font-size:14px; text-align:center; border-radius:4px; }
  #selbar button:hover { background:#f5f5f5; color:#333; }
  
  .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:3000; align-items:center; justify-content:center; }
  .modal.active { display:flex; }
  .modal-content { background:#fff; border-radius:8px; padding:24px; max-width:600px; width:90%; max-height:80vh; overflow-y:auto; }
  
  .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
  .modal-header h2 { font-size: 28px; color: #333; margin: 0; }
  .modal-close { font-size: 32px; cursor: pointer; color: #999; line-height: 1; }
  .modal-close:hover { color: #333; }
  
  .result-summary { text-align:center; padding:20px; background:#f0f0f0; margin-bottom:16px; border-radius:6px; }
  .result-score { font-size:36px; font-weight:600; color:#0066cc; }
  .result-item { padding:10px; margin:8px 0; border-left:3px solid #ddd; background:#f9f9f9; font-size:13px; }
  .result-item.correct { border-left-color:#28a745; background:#e8f5e9; }
  .result-item.incorrect { border-left-color:#dc3545; background:#ffebee; }
  
  .wrong-item { background:#fff3e0; padding:16px; margin:8px 0; border-radius:8px; border-left:4px solid #ff9800; display:flex; justify-content:space-between; align-items:start; }
  .wrong-item-content { flex:1; }
  .btn-delete { background:#dc3545; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-size:13px; margin-left:12px; }
  .btn-delete:hover { background:#c82333; }
  .modal-actions { display:flex; gap:10px; margin-bottom:20px; }
</style>
</head>
<body>
<div id="timer">00:00</div>

<div class="shell">
  <section class="pane" id="left">
    
<h2>READING PASSAGE 3</h2>
<p>You should spend about 20 minutes on Questions 27‚Äì40, which are based on Reading Passage 3 below.</p>
<h3>Movement Underwater</h3>

<p><span class="paragraph-label">A</span> Self-propelled motion is a fundamental ability in many organisms. From the beating flagella of tiny plankton keeping afloat near the ocean surface to the playful perfection of dolphins surfing the bow wave of a ship, marine creatures have adopted a huge variety of styles, speeds, and methods of movement. Each species has its own particular need for the evolutionary developments that have taken place, but the basic requirements are the same‚Äîfinding food, avoiding predation, seeking a mate or a safe place to have young, or migrating to an area with more favorable conditions.</p>

<p><span class="paragraph-label">B</span> The particular physical properties of water that most affect movement are density, viscosity (stickiness), and buoyancy. Seawater is about 800 times denser than air and nearly 100 times as viscous. Consequently, there is much more resistance to movement than on land, as anyone will know who has ever tried to wade through waist-deep water. However, with density comes much greater buoyancy, so that organisms need to spend relatively little energy to stay afloat. As they move through the ocean environment, organisms seek to make wave motion, currents, and natural turbulence work to their advantage, not to their detriment.</p>

<p><span class="paragraph-label">C</span> Most fishes have swim bladders to help them offset the density of their bodies and so maintain neutral buoyancy with minimal effort. These small, gas-filled chambers contain specialized networks of blood vessels that can add or remove gases such as oxygen and carbon dioxide. The ability to remain indefinitely at a constant depth without expending energy is especially important for slow-moving fishes that seek food in the shallows, or for those that hunt and scavenge in kelp forests. Active swimmers, such as mackerel, skipjacks, and sharks, do not have swim bladders because they need to change depth more rapidly than they could regulate the gas content. These fishes must swim forever or they will sink.</p>

<p><span class="paragraph-label">D</span> Many animals, especially the tiny zooplankton, have taken to a life of simply drifting near the surface, contentedly feeding on the microscopic phytoplankton and bacteria floating there. Although life among the plankton might seem easy, there is in fact a remarkable range of movement. Some tiny plankton only 1‚Äì2 mm in length actually travel long distances each day. Species that live below the level where sunlight reaches nightly swim hundreds of meters up to the surface to feed in the relative safety of darkness. At dawn, they sink back down in an effort to escape predators‚Äîa double journey equivalent to a person swimming 700 km a day.</p>

<p><span class="paragraph-label">E</span> It has taken marine creatures millions of years of evolution to overcome the chief deterrent to motion through a dense medium such as water‚Äîthat of drag resistance. Swimming efficiency has been achieved by minimizing the three types of drag created by friction, turbulence, and body form. To reduce surface friction, the body must be smooth and rounded. In addition, the scales of most fishes are coated with slime to lubricate their passage through water. To reduce the turbulent drag created as water flows around the moving shape, a rounded front end and tapered back end are required. To reduce form drag, the cross-sectional area of the body should be minimal‚Äîa pencil shape would be ideal. The combined shape, taking into account all three types of drag, is the streamlined torpedo form of a tuna, the fastest-swimming of all fishes.</p>

<p><span class="paragraph-label">F</span> Speed is only one of three important aspects of swimming ability. Tuna, swordfish, and mackerel all specialize in fast, steady cruising, but there are many other fishes for whom sustained speed is less important, such as the barracuda. This formidable predator specializes in swift acceleration, and has a far higher success rate for its attacks than its steady-cruising cousins. The freshwater pike, which lurks in the shadows until its quarry is within striking distance and then lunges with great rapidity, achieves a remarkable 70‚Äì80 percent success rate. The third specialization is maneuverability, best demonstrated by the butterfly fishes. These have disk-shaped bodies that permit abrupt changes of track. Many fishes are generalists, being at least partly proficient in all three modes of movement.</p>

<p><span class="paragraph-label">G</span> Almost all fishes swim by undulation. Strong W-shaped muscles along the side of the body progressively contract and relax in sequence, from head to tail and from side to side, creating a traveling horizontal wave. The body is thrown into a series of curves that press sideways and back against the water, producing a forward thrust. The narrow, elongated forms of eels and sea snakes allow easy undulation along their full length. In contrast, the more stubby and inflexible bodies of armor-plated trunkfish use only the swish of their short tail fins to move themselves through the water. Most other fishes combine elements of both methods, coordinating powerful strokes of the tail fins with subtle body undulations.</p>

<p><span class="paragraph-label">H</span> A fish‚Äôs fins also play a vital and versatile role. The vertically oriented dorsal and ventral fins on the back and belly control sideways motion, while up-and-down motion is controlled by the pectoral and pelvic fins on the fish‚Äôs sides. Whereas the shape of the tail fin relates directly to speed‚Äîcrescent-moon-shaped for fast cruising, broad and flat for acceleration‚Äîthe style and arrangement of the other fins are crucial for maneuverability. Puffer fishes scull with tiny, oscillating pectoral fins, while butterfly fishes undulate their broad dorsal and ventral fins, twisting and turning with great precision through intricate coral reefs.</p>
  </section>

  <div id="divider" title="Drag to resize"></div>

  <section class="pane" id="right">
    <h3>Questions</h3>

    <div class="group">
      <h4>Questions 27‚Äì31</h4>
      <p>Reading Passage 3 has eight paragraphs, <strong>A‚ÄìH</strong>.</p>
      <p>Which paragraph contains the following information?</p>
      <p>Write the correct letter, <strong>A‚ÄìH</strong>, in boxes 27‚Äì31 on your answer sheet.</p>

      <ol start="27">
        <li><span class="flag-btn" data-q="q27" style="left:-20px;"></span>A strategy to avoid being attacked<br>
          <div style="margin-top:5px;">
             <label style="margin-right:5px;"><input type="radio" name="q27" value="A"> A</label>
             <label style="margin-right:5px;"><input type="radio" name="q27" value="B"> B</label>
             <label style="margin-right:5px;"><input type="radio" name="q27" value="C"> C</label>
             <label style="margin-right:5px;"><input type="radio" name="q27" value="D"> D</label>
             <label style="margin-right:5px;"><input type="radio" name="q27" value="E"> E</label>
             <label style="margin-right:5px;"><input type="radio" name="q27" value="F"> F</label>
             <label style="margin-right:5px;"><input type="radio" name="q27" value="G"> G</label>
             <label style="margin-right:5px;"><input type="radio" name="q27" value="H"> H</label>
          </div>
        </li>
        <li><span class="flag-btn" data-q="q28" style="left:-20px;"></span>How fish are able to keep afloat naturally<br>
          <div style="margin-top:5px;">
             <label style="margin-right:5px;"><input type="radio" name="q28" value="A"> A</label>
             <label style="margin-right:5px;"><input type="radio" name="q28" value="B"> B</label>
             <label style="margin-right:5px;"><input type="radio" name="q28" value="C"> C</label>
             <label style="margin-right:5px;"><input type="radio" name="q28" value="D"> D</label>
             <label style="margin-right:5px;"><input type="radio" name="q28" value="E"> E</label>
             <label style="margin-right:5px;"><input type="radio" name="q28" value="F"> F</label>
             <label style="margin-right:5px;"><input type="radio" name="q28" value="G"> G</label>
             <label style="margin-right:5px;"><input type="radio" name="q28" value="H"> H</label>
          </div>
        </li>
        <li><span class="flag-btn" data-q="q29" style="left:-20px;"></span>The physical process by which fish propel themselves ahead<br>
          <div style="margin-top:5px;">
             <label style="margin-right:5px;"><input type="radio" name="q29" value="A"> A</label>
             <label style="margin-right:5px;"><input type="radio" name="q29" value="B"> B</label>
             <label style="margin-right:5px;"><input type="radio" name="q29" value="C"> C</label>
             <label style="margin-right:5px;"><input type="radio" name="q29" value="D"> D</label>
             <label style="margin-right:5px;"><input type="radio" name="q29" value="E"> E</label>
             <label style="margin-right:5px;"><input type="radio" name="q29" value="F"> F</label>
             <label style="margin-right:5px;"><input type="radio" name="q29" value="G"> G</label>
             <label style="margin-right:5px;"><input type="radio" name="q29" value="H"> H</label>
          </div>
        </li>
        <li><span class="flag-btn" data-q="q30" style="left:-20px;"></span>A list of reasons why different creatures move from one place to another<br>
          <div style="margin-top:5px;">
             <label style="margin-right:5px;"><input type="radio" name="q30" value="A"> A</label>
             <label style="margin-right:5px;"><input type="radio" name="q30" value="B"> B</label>
             <label style="margin-right:5px;"><input type="radio" name="q30" value="C"> C</label>
             <label style="margin-right:5px;"><input type="radio" name="q30" value="D"> D</label>
             <label style="margin-right:5px;"><input type="radio" name="q30" value="E"> E</label>
             <label style="margin-right:5px;"><input type="radio" name="q30" value="F"> F</label>
             <label style="margin-right:5px;"><input type="radio" name="q30" value="G"> G</label>
             <label style="margin-right:5px;"><input type="radio" name="q30" value="H"> H</label>
          </div>
        </li>
        <li><span class="flag-btn" data-q="q31" style="left:-20px;"></span>How the medium of water both restricts and aids movement<br>
          <div style="margin-top:5px;">
             <label style="margin-right:5px;"><input type="radio" name="q31" value="A"> A</label>
             <label style="margin-right:5px;"><input type="radio" name="q31" value="B"> B</label>
             <label style="margin-right:5px;"><input type="radio" name="q31" value="C"> C</label>
             <label style="margin-right:5px;"><input type="radio" name="q31" value="D"> D</label>
             <label style="margin-right:5px;"><input type="radio" name="q31" value="E"> E</label>
             <label style="margin-right:5px;"><input type="radio" name="q31" value="F"> F</label>
             <label style="margin-right:5px;"><input type="radio" name="q31" value="G"> G</label>
             <label style="margin-right:5px;"><input type="radio" name="q31" value="H"> H</label>
          </div>
        </li>
      </ol>
    </div>

    <div class="group">
      <h4>Questions 32‚Äì35</h4>
      <p>Complete the table below.</p>
      <p>Choose <strong>NO MORE THAN TWO WORDS</strong> from the passage for each answer.</p>
      <p>Write your answers in boxes 32‚Äì35 on your answer sheet.</p>

      <table class="q-table">
        <thead>
          <tr>
            <th>Specialised ability</th>
            <th>Example fish species</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Ability to maintain the same <span class="flag-btn" data-q="q32" style="left:-15px;"></span><strong>32</strong> <input type="text" name="q32" autocomplete="off"> over long distances</td>
            <td>Swordfish</td>
          </tr>
          <tr>
            <td>Rapid <span class="flag-btn" data-q="q33" style="left:-15px;"></span><strong>33</strong> <input type="text" name="q33" autocomplete="off"></td>
            <td>Barracuda</td>
          </tr>
          <tr>
            <td>Sudden attack on prey following period of lying in wait</td>
            <td><span class="flag-btn" data-q="q34" style="left:-15px;"></span><strong>34</strong> <input type="text" name="q34" autocomplete="off"></td>
          </tr>
          <tr>
            <td>Rapid changes of direction</td>
            <td><span class="flag-btn" data-q="q35" style="left:-15px;"></span><strong>35</strong> <input type="text" name="q35" autocomplete="off"></td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="group">
      <h4>Questions 36‚Äì40</h4>
      <p>Complete the diagram below.</p>
      <p>Choose <strong>NO MORE THAN TWO WORDS</strong> from the passage for each answer.</p>
      <p>Write your answers in boxes 36‚Äì40 on your answer sheet.</p>

      <div class="diagram-container">
        <h4>Mobility, stability and combating different types of drag resistance</h4>
        
        <div style="display:flex; flex-direction:column; align-items:center; gap:10px;">
          <!-- Top label -->
          <div class="diagram-label">
            Streamlined shape narrowing towards the rear to reduce <span class="flag-btn" data-q="q36" style="left:-20px;"></span><strong>36</strong> <input type="text" name="q36" autocomplete="off"> drag
          </div>

          <!-- Main Fish Visualization Placeholder -->
          <div class="diagram-img-placeholder">
            [Fish Diagram: Fins, Scales, Shape]
          </div>

          <div style="display:flex; justify-content:space-between; width:100%; flex-wrap:wrap;">
            <!-- Left Side Labels -->
            <div style="flex:1; text-align:left; padding-right:10px;">
              <div class="diagram-label">
                Fins controlling <span class="flag-btn" data-q="q38" style="left:-20px;"></span><strong>38</strong> <input type="text" name="q38" autocomplete="off"> movement
              </div>
              <div class="diagram-label">
                Fins which are important for <span class="flag-btn" data-q="q39" style="left:-20px;"></span><strong>39</strong> <input type="text" name="q39" autocomplete="off"> of fish
              </div>
            </div>

            <!-- Right/Center Labels -->
            <div style="flex:1; text-align:right; padding-left:10px;">
              <div class="diagram-label">
                 Fins controlling <span class="flag-btn" data-q="q37" style="left:-20px;"></span><strong>37</strong> <input type="text" name="q37" autocomplete="off"> movement
              </div>
              <div class="diagram-label">
                Minimal cross-sectional body area to decrease <span class="flag-btn" data-q="q40" style="left:-20px;"></span><strong>40</strong> <input type="text" name="q40" autocomplete="off"> drag
              </div>
            </div>
          </div>
          
          <div style="margin-top:20px; font-style:italic; font-size:12px; color:#555;">
            (Other labels in diagram: "Ideal tail fin shape for steady movement known as cruising", "Slime-covered scales to minimise surface friction")
          </div>
        </div>
      </div>
    </div>

    <div class="bottom-bar">
      <button class="btn-primary" onclick="submitAnswers()">Êèê‰∫§</button>
      <button onclick="resetForm()">ÈáçÁΩÆ</button>
      <button onclick="openWrongBook()">Êú¨ÁØáÈîôÈ¢ò</button>
    </div>
  </section>
</div>

<div id="selbar">
  <button id="btnNote">Note</button>
  <button id="btnHL">Highlight</button>
  <button id="btnUH" style="display:none;">Clear Highlight</button>
</div>

<div class="modal" id="resultModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ÊàêÁª©</h2>
      <span class="modal-close" onclick="closeModal('resultModal')">√ó</span>
    </div>
    <div id="resultContent"></div>
    <button class="btn-primary" style="width:100%; margin-top:16px;" onclick="addWrongToBook()">Âä†ÂÖ•ÈîôÈ¢òÊú¨</button>
  </div>
</div>

<div class="modal" id="wrongBookModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Êú¨ÁØáÈîôÈ¢ò</h2>
      <span class="modal-close" onclick="closeModal('wrongBookModal')">√ó</span>
    </div>
    <div id="wrongBookContent"></div>
  </div>
</div>

<div class="modal" id="resetModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ÈáçÁΩÆÁªÉ‰π†</h2>
      <span class="modal-close" onclick="closeModal('resetModal')">√ó</span>
    </div>
    <div style="margin:16px 0;">
      <label style="display:block; margin-bottom:10px;">
        <input type="radio" name="resetType" value="answers" checked>
        Âè™Ê∏ÖÁ©∫Á≠îÊ°à
      </label>
      <label style="display:block;">
        <input type="radio" name="resetType" value="all">
        Ê∏ÖÁ©∫Á≠îÊ°àÂíåÊ†áËÆ∞
      </label>
    </div>
    <button class="btn-primary" style="width:100%;" onclick="confirmReset()">Á°ÆÂÆö</button>
  </div>
</div>

<script>
const PAPER_ID='P3_MOVEMENT_UNDERWATER';

let t=0;
const timerEl=document.getElementById('timer');
setInterval(()=>{ t++; timerEl.textContent=String(Math.floor(t/60)).padStart(2,'0')+':'+String(t%60).padStart(2,'0'); }, 1000);

const divider=document.getElementById('divider'), left=document.getElementById('left'), right=document.getElementById('right');
let dragging=false;
divider.onmousedown=()=>{ dragging=true; document.body.style.cursor='ew-resize'; };
window.onmousemove=(e)=>{ if(!dragging)return; const c=document.querySelector('.shell').getBoundingClientRect(); let x=e.clientX-c.left; x=Math.max(280,Math.min(c.width-280,x)); left.style.flex='0 0 '+x+'px'; right.style.flex='1 1 auto'; };
window.onmouseup=()=>{ dragging=false; document.body.style.cursor=''; };

const selbar=document.getElementById('selbar'), btnHL=document.getElementById('btnHL'), btnUH=document.getElementById('btnUH'), btnNote=document.getElementById('btnNote');
let lastRange=null, currentHlNode=null;

function posSelbar(r){ selbar.style.display='flex'; const t=window.scrollY+r.top-selbar.offsetHeight-8; const l=window.scrollX+r.left+r.width/2-selbar.offsetWidth/2; selbar.style.top=((t>0)?t:(window.scrollY+r.bottom+8))+'px'; selbar.style.left=Math.max(8,l)+'px'; }

function updSel(){ const s=window.getSelection(); if(!s||s.rangeCount===0||s.isCollapsed){ if(!currentHlNode)selbar.style.display='none'; return; } const r=s.getRangeAt(0); lastRange=r.cloneRange(); currentHlNode=null; btnNote.style.display='block'; btnHL.style.display='block'; btnUH.style.display='none'; posSelbar(r.getBoundingClientRect()); }

left.onmouseup=updSel; right.onmouseup=updSel;
document.onselectionchange=()=>{ const s=window.getSelection(); if((!s||s.rangeCount===0||s.isCollapsed)&&!currentHlNode)selbar.style.display='none'; };
document.addEventListener('click',(e)=>{ if(e.target.classList&&(e.target.classList.contains('hl')||e.target.classList.contains('note'))){ currentHlNode=e.target; lastRange=null; btnNote.style.display='none'; btnHL.style.display='none'; btnUH.style.display='block'; posSelbar(e.target.getBoundingClientRect()); const s=window.getSelection(); if(s)s.removeAllRanges(); }}, true);

btnHL.onclick=()=>{ if(currentHlNode||!lastRange||lastRange.collapsed)return; const s=document.createElement('span'); s.className='hl'; try{ lastRange.surroundContents(s); }catch(e){ const w=document.createElement('span'); w.className='hl'; w.appendChild(lastRange.cloneContents()); lastRange.deleteContents(); lastRange.insertNode(w); } selbar.style.display='none'; saveHighlights(); };

btnNote.onclick=()=>{ if(currentHlNode||!lastRange||lastRange.collapsed)return; const s=document.createElement('span'); s.className='note'; try{ lastRange.surroundContents(s); }catch(e){ const w=document.createElement('span'); w.className='note'; w.appendChild(lastRange.cloneContents()); lastRange.deleteContents(); lastRange.insertNode(w); } selbar.style.display='none'; saveHighlights(); };

btnUH.onclick=()=>{ if(currentHlNode){ const p=currentHlNode.parentNode; while(currentHlNode.firstChild)p.insertBefore(currentHlNode.firstChild,currentHlNode); p.removeChild(currentHlNode); p.normalize(); currentHlNode=null; selbar.style.display='none'; saveHighlights(); }else if(lastRange){ const sR=lastRange.getBoundingClientRect(); const w=document.createTreeWalker(document.body,NodeFilter.SHOW_ELEMENT); const tr=[]; while(w.nextNode()){ const n=w.currentNode; if(n.classList&&(n.classList.contains('hl')||n.classList.contains('note'))){ const r=n.getBoundingClientRect(); if(!(r.right<sR.left||r.left>sR.right||r.bottom<sR.top||r.top>sR.bottom))tr.push(n); }} tr.forEach(el=>{ const p=el.parentNode; while(el.firstChild)p.insertBefore(el.firstChild,el); p.removeChild(el); p.normalize(); }); selbar.style.display='none'; saveHighlights(); }};

document.querySelectorAll('.flag-btn').forEach(btn => {
  btn.onclick = e => {
    e.stopPropagation();
    btn.classList.toggle('active');
    saveFlags();
  };
});

const answerKey = {
  q27: "D", q28: "C", q29: "G", q30: "A", q31: "B",
  q32: "speed", q33: "acceleration", q34: "freshwater pike", q35: "butterfly fishes",
  q36: "turbulent", q37: "up-and-down", q38: "sideways", q39: "maneuverability", q40: "form"
};
let lastResults=[];

function saveAnswers() {
  const data = {};
  document.querySelectorAll('input[type="radio"]:checked').forEach(r => data[r.name] = r.value);
  document.querySelectorAll('input[type="text"]').forEach(i => { if(i.value) data[i.name] = i.value; });
  localStorage.setItem(`${PAPER_ID}_answers`, JSON.stringify(data));
}

function loadAnswers() {
  const data = JSON.parse(localStorage.getItem(`${PAPER_ID}_answers`) || '{}');
  Object.keys(data).forEach(q => {
    const radio = document.querySelector(`input[name="${q}"][value="${data[q]}"]`);
    if(radio) radio.checked = true;
    const text = document.querySelector(`input[name="${q}"][type="text"]`);
    if(text) text.value = data[q];
  });
}

function saveFlags() {
  const flags = [...document.querySelectorAll('.flag-btn.active')].map(b => b.dataset.q);
  localStorage.setItem(`${PAPER_ID}_flags`, JSON.stringify(flags));
}

function loadFlags() {
  const flags = JSON.parse(localStorage.getItem(`${PAPER_ID}_flags`) || '[]');
  flags.forEach(q => document.querySelector(`[data-q="${q}"]`)?.classList.add('active'));
}

function saveHighlights() {
  const highlights = { left: [], right: [] };
  document.querySelectorAll('#left .hl, #left .note').forEach((el, idx) => {
    highlights.left.push({ type: el.classList.contains('hl') ? 'hl' : 'note', text: el.textContent, index: idx });
  });
  document.querySelectorAll('#right .hl, #right .note').forEach((el, idx) => {
    highlights.right.push({ type: el.classList.contains('hl') ? 'hl' : 'note', text: el.textContent, index: idx });
  });
  localStorage.setItem(`${PAPER_ID}_highlights`, JSON.stringify(highlights));
}

function loadHighlights() {
  const data = JSON.parse(localStorage.getItem(`${PAPER_ID}_highlights`) || '{"left":[],"right":[]}');
  const restore = (pane, items) => {
    if(items && items.length > 0) {
      items.forEach(item => {
        const walker = document.createTreeWalker(pane, NodeFilter.SHOW_TEXT);
        let node;
        while(node = walker.nextNode()) {
          if(node.textContent.includes(item.text)) {
            const span = document.createElement('span');
            span.className = item.type;
            const parent = node.parentNode;
            const text = node.textContent;
            const idx = text.indexOf(item.text);
            if(idx >= 0) {
              const before = text.substring(0, idx);
              const match = text.substring(idx, idx + item.text.length);
              const after = text.substring(idx + item.text.length);
              parent.insertBefore(document.createTextNode(before), node);
              span.textContent = match;
              parent.insertBefore(span, node);
              parent.insertBefore(document.createTextNode(after), node);
              parent.removeChild(node);
              break;
            }
          }
        }
      });
    }
  };
  restore(left, data.left);
  restore(right, data.right);
}

document.querySelectorAll('input').forEach(el => {
  el.addEventListener('change', saveAnswers);
  if(el.type === 'text') el.addEventListener('input', saveAnswers);
});

document.addEventListener('DOMContentLoaded', () => {
  loadAnswers();
  loadFlags();
  loadHighlights();
});

function submitAnswers(){ 
  const res=[]; let cor=0; 
  Object.keys(answerKey).forEach(q=>{ 
    let uA = "";
    const rad = document.querySelector(`input[name="${q}"]:checked`);
    const txt = document.querySelector(`input[name="${q}"][type="text"]`);
    if(rad) uA = rad.value;
    else if(txt) uA = txt.value.trim();
    
    const cA = answerKey[q];
    let iC = false;
    // Simple case-insensitive match for text inputs
    if(uA.toLowerCase() === cA.toLowerCase()) iC = true;
    
    // Handling specific cases if "freshwater pike" allows "pike" etc.
    if(q==='q34' && (uA.toLowerCase()==='freshwater pike' || uA.toLowerCase()==='pike')) iC=true;

    if(iC) cor++; 
    res.push({id:q,userAns:uA,correctAns:cA,isCorrect:iC}); 
  }); 
  lastResults=res; 
  const tot=Object.keys(answerKey).length; 
  const pct=((cor/tot)*100).toFixed(1); 
  localStorage.setItem(`ielts_score_${PAPER_ID}`, `${cor}/${tot}`);
  document.getElementById('resultContent').innerHTML=`<div class="result-summary"><div class="result-score">${cor} / ${tot}</div><div style="margin-top:8px;font-size:18px;">${pct}%</div></div>${res.map(r=>`<div class="result-item ${r.isCorrect?'correct':'incorrect'}"><div><strong>${r.id.replace('q','')}</strong> ${r.isCorrect?'‚úì':'‚úó'}</div><div>‰Ω†ÁöÑÁ≠îÊ°à: ${r.userAns||'(Êú™‰ΩúÁ≠î)'}</div>${!r.isCorrect?`<div>Ê≠£Á°ÆÁ≠îÊ°à: ${r.correctAns}</div>`:''}</div>`).join('')}`; 
  document.getElementById('resultModal').classList.add('active'); 
}

function resetForm(){ document.getElementById('resetModal').classList.add('active'); }

function confirmReset(){ 
  const tp=document.querySelector('input[name="resetType"]:checked').value; 
  document.querySelectorAll('input[type="radio"]').forEach(i=>i.checked=false); 
  document.querySelectorAll('input[type="text"]').forEach(i=>i.value="");
  localStorage.removeItem(`${PAPER_ID}_answers`);
  
  if(tp==='all'){ 
    document.querySelectorAll('.hl').forEach(el=>{ const p=el.parentNode; while(el.firstChild)p.insertBefore(el.firstChild,el); p.removeChild(el); p.normalize(); }); 
    document.querySelectorAll('.note').forEach(el=>{ const p=el.parentNode; while(el.firstChild)p.insertBefore(el.firstChild,el); p.removeChild(el); p.normalize(); }); 
    document.querySelectorAll('.flag-btn').forEach(b => b.classList.remove('active'));
    localStorage.removeItem(`${PAPER_ID}_highlights`);
    localStorage.removeItem(`${PAPER_ID}_flags`);
  } 
  closeModal('resetModal'); 
}

function addWrongToBook(){ const wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); const wr=lastResults.filter(r=>!r.isCorrect); wr.forEach(r=>{ const en={paperId:PAPER_ID,title:'Movement Underwater',questionId:r.id.replace('q',''),correctAnswer:r.correctAns,myAnswer:r.userAns||'(Êú™‰ΩúÁ≠î)',date:new Date().toISOString().split('T')[0]}; const ix=wb.findIndex(i=>i.paperId===en.paperId&&i.questionId===en.questionId); if(ix>=0)wb[ix]=en; else wb.push(en); }); localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); alert(`Â∑≤Ê∑ªÂä† ${wr.length} ÈÅìÈîôÈ¢ò`); closeModal('resultModal'); }

function deleteWrongItem(pId,qId){ if(!confirm('Á°ÆÂÆöÂà†Èô§ËøôÈÅìÈîôÈ¢òÔºü'))return; let wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); wb=wb.filter(i=>!(i.paperId===pId&&i.questionId===qId)); localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); openWrongBook(); }

function clearCurrentWrongBook(){ if(!confirm('Á°ÆÂÆöÊ∏ÖÁ©∫Êú¨ÁØáÊâÄÊúâÈîôÈ¢òÔºü'))return; let wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); wb=wb.filter(i=>i.paperId!==PAPER_ID); localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); openWrongBook(); }

function openWrongBook(){ const wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); const cu=wb.filter(i=>i.paperId===PAPER_ID); const ct=document.getElementById('wrongBookContent'); if(cu.length===0)ct.innerHTML='<div style="text-align:center;padding:40px;color:#666;">ÊöÇÊó†ÈîôÈ¢ò</div>'; else ct.innerHTML=`<div class="modal-actions"><button class="btn-danger" onclick="clearCurrentWrongBook()" style="width:100%;">üóëÔ∏è Ê∏ÖÁ©∫Êú¨ÁØáÈîôÈ¢ò</button></div>${cu.map(i=>`<div class="wrong-item"><div class="wrong-item-content"><div style="font-weight:600;margin-bottom:8px;">${i.questionId}</div><div style="font-size:13px;color:#666;"><div>‚úì Ê≠£Á°Æ: ${i.correctAnswer}</div><div style="color:#d32f2f;">‚úó ÊàëÁöÑ: ${i.myAnswer}</div></div></div><button class="btn-delete" onclick="deleteWrongItem('${i.paperId}','${i.questionId}')">Âà†Èô§</button></div>`).join('')}`; document.getElementById('wrongBookModal').classList.add('active'); }

function closeModal(id){ document.getElementById(id).classList.remove('active'); }
</script>
</body>
</html>