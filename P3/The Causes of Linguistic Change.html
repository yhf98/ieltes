<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>P3 ‚Äì The Causes of Linguistic Change</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  * { box-sizing: border-box; margin:0; padding:0; }
  html,body { height:100%; }
  body { font-family: Arial, sans-serif; background:#f5f5f5; }
  
  #timer { position:fixed; top:12px; right:12px; background:#fff; border:1px solid #ddd; border-radius:6px; padding:8px 12px; font-size:16px; font-weight:600; color:#0066cc; z-index:1000; }
  
  .shell { display:flex; height:100vh; width:100%; }
  .pane { background:#fff; overflow:auto; padding:24px; }
  #left { flex: 0 0 50%; border-right:1px solid #ddd; }
  #right { flex: 1 1 auto; background:#fafafa; }
  #divider { flex: 0 0 5px; background:#ddd; cursor: ew-resize; }
  #divider:hover { background:#999; }
  
  h2,h3,h4 { margin:0 0 12px; color:#333; }
  h2 { font-size:20px; }
  h3 { font-size:18px; color:#0066cc; }
  h4 { font-size:15px; font-weight:600; margin-top:20px; }
  
  #left p { margin: 0 0 14px; line-height: 1.7; text-align:justify; }
  
  .group { background:#fff; border:1px solid #ddd; border-radius:6px; padding:16px; margin-bottom:16px; }
  .group h4 { margin-top:0; color:#0066cc; }
  .group p { margin:8px 0; font-size:14px; line-height:1.6; }
  
  .headings { background:#f9f9f9; padding:12px; margin:12px 0; border-radius:4px; }
  .headings ol { margin-left:20px; }
  .headings li { margin:4px 0; font-size:13px; }
  
  table { border-collapse: collapse; width:100%; margin:12px 0; }
  th, td { border:1px solid #ddd; padding:6px; text-align:center; font-size:13px; position:relative; }
  th { background:#f5f5f5; font-weight:600; }
  
  .flag-btn { 
    position:absolute; 
    left:2px; 
    top:50%;
    transform:translateY(-50%);
    width:8px;
    height:8px;
    border-radius:50%;
    background:#ddd;
    cursor:pointer;
    z-index:10;
  }
  .flag-btn:hover { background:#999; }
  .flag-btn.active { background:#ff5722; }
  
  tr td:first-child { padding-left:16px; }
  
  .group ol { margin-left:20px; }
  .group ol li { margin:12px 0; font-size:14px; line-height:1.6; position:relative; }
  .group ol li label { display:inline-block; margin-right:8px; }
  
  .bottom-bar { display:flex; gap:10px; margin-top:16px; }
  button { padding:10px 20px; border:1px solid #999; border-radius:6px; background:#fff; cursor:pointer; font-size:14px; }
  button:hover { background:#f0f0f0; }
  .btn-primary { background:#0066cc; color:#fff; border-color:#0066cc; }
  .btn-primary:hover { background:#0052a3; }
  .btn-danger { background:#dc3545; color:#fff; border-color:#dc3545; }
  .btn-danger:hover { background:#c82333; }
  
  .hl { background:#fff59d; cursor:pointer; }
  .hl:hover { background:#ffeb3b; }
  .note { background:#b3d9ff; cursor:pointer; }
  .note:hover { background:#99ccff; }
  
  #selbar { position:fixed; display:none; z-index:2000; background:#fff; border:1px solid #ddd; border-radius:8px; padding:8px; gap:0; box-shadow:0 2px 8px rgba(0,0,0,0.15); flex-direction:column; min-width:120px; }
  #selbar button { background:#fff; color:#666; border:none; padding:3px 0px; cursor:pointer; font-size:14px; text-align:center; border-radius:4px; }
  #selbar button:hover { background:#f5f5f5; color:#333; }
  
  .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:3000; align-items:center; justify-content:center; }
  .modal.active { display:flex; }
  .modal-content { background:#fff; border-radius:8px; padding:24px; max-width:600px; width:90%; max-height:80vh; overflow-y:auto; }
  
  .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
  .modal-header h2 { font-size: 28px; color: #333; margin: 0; }
  .modal-close { font-size: 32px; cursor: pointer; color: #999; line-height: 1; }
  .modal-close:hover { color: #333; }
  
  .result-summary { text-align:center; padding:20px; background:#f0f0f0; margin-bottom:16px; border-radius:6px; }
  .result-score { font-size:36px; font-weight:600; color:#0066cc; }
  .result-item { padding:10px; margin:8px 0; border-left:3px solid #ddd; background:#f9f9f9; font-size:13px; }
  .result-item.correct { border-left-color:#28a745; background:#e8f5e9; }
  .result-item.incorrect { border-left-color:#dc3545; background:#ffebee; }
  
  .wrong-item { background:#fff3e0; padding:16px; margin:8px 0; border-radius:8px; border-left:4px solid #ff9800; display:flex; justify-content:space-between; align-items:start; }
  .wrong-item-content { flex:1; }
  .btn-delete { background:#dc3545; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-size:13px; margin-left:12px; }
  .btn-delete:hover { background:#c82333; }
  .modal-actions { display:flex; gap:10px; margin-bottom:20px; }
</style>
</head>
<body>
<div id="timer">00:00</div>

<div class="shell">
  <section class="pane" id="left">
    
<h2>READING PASSAGE 3</h2>
<p>You should spend about 20 minutes on Questions 27‚Äì40, which are based on Reading Passage 3 below.</p>
<h3>The Causes of Linguistic Change</h3>

<p>All living languages undergo changes of various kinds, for which there are various reasons. The changes that have caused most dispute are those in pronunciation. We have various sources of evidence for the pronunciations of earlier times, like the evidence of spellings, the treatment of words borrowed from other languages or borrowed by them, the descriptions of contemporary grammarians, and the modern pronunciations in all the languages and dialects concerned. These, combined with a knowledge of the mechanism of speech production, can often give us a very good idea of the pronunciation of an earlier age, though absolute certainty is never possible. When we study the pronunciation of a language over any period of a few generations or more, we find that it is subject to change. Moreover, there are always large-scale regularities in the changes: for example, over a period of time, all the long a sounds in a language may change into long o sounds, or all the b sounds in a certain position (for example, at the end of a word) may change into p sounds. Such regular changes are often called sound laws. There are no universal sound laws, but simply particular sound laws for one given language at one given period.</p>

<p>One cause of change is the influence of one language on another. We learn our mother tongue very thoroughly, and acquire a whole set of speech habits which become second nature to us. When later we learn a foreign language, we inevitably carry over some of these speech habits into it, and so do not speak it exactly like a native. Consequently, in bilingual situations the second language tends to be modified. Such modifications may not persist, of course: an isolated Polish or German immigrant to Britain will usually have grandchildren who speak English like natives because the influence of the general speech environment (playmates, school, work) is stronger than that of the home. But if a large and closely knit group of people adopt a new language, then the modifications they make in it may persist among their descendants, even if the latter no longer speak the original language that caused the changes. This can be seen in Wales, where the influence of Welsh has affected the pronunciation of English, and the very characteristic melody of Welsh English has been carried over from Welsh.</p>

<p>It is also possible that fashion plays a part in the process of change. It certainly plays a part in the spread of change: one person imitates another, and people with the most prestige are most likely to be imitated, so that a change that takes place in one social group may be imitated (more or less accurately) by speakers in another group. When a social group goes up or down in the world, its pronunciation will gain or lose prestige. Some of the changes in accepted English pronunciation in the seventeenth and eighteenth centuries have been shown to consist of the replacement of one style of pronunciation by another style already existing, and it is likely that such substitutions were a result of the great social changes of the period: the increased power and wealth of the middle classes, and their steady infiltration upwards into the ranks of the landed gentry probably carried elements of middle class dialect into upper class speech. However, besides spreading changes that have already taken place, fashion may actually cause changes in pronunciation. In a stratified society, the important thing about a fashion is that it is exclusive: as soon as the fashion has penetrated to a lower social group, it‚Äôs time to move on. This can be seen in clothes: fashionable people may find it flattering to be imitated, but as soon as the new fashion has really caught on they must change to something else, to mark themselves off as different. It may be the same with language, for social groups use characteristic styles of language to mark themselves off from other groups. A group that has high prestige may find that its style of speech is being imitated by other groups, and then its members may (perhaps subconsciously) begin to change it, perhaps by exaggerating its distinguishing characteristics.</p>

<p>However, while interaction between different languages, and between the dialects of a single language, can explain some changes in pronunciation, it cannot explain them all. Another cause that has been suggested is the fact that the imitation of children is imperfect: they copy their parents‚Äô speech, but never reproduce it exactly. This seems to be true enough and it moreover seems to be true that even adults show a certain amount of random variation in their pronunciation. However, these facts cannot explain changes in pronunciation, unless it can be shown that there is some systematic trend in the failures in imitation. If they are merely random deviations they will cancel one another out and there will be no net change in the language. For some of these random variations to be selected at the expense of others, there must be further forces at work.</p>

<p>One such force, which is often suggested, is known as the principle of ease. We are all naturally lazy, it is argued, and so we tend to take short cuts in the movements of our speech organs, to replace movements calling for great accuracy or energy by less demanding ones, to omit sounds if they are not essential for understanding, and so on. For example, the word scant was once skamt, but the m has been changed to n under the influence of the following t. An economy of effort has thereby been achieved, because n and t are articulated in the same place (with the tip of the tongue against the teeth-ridge), whereas m is articulated elsewhere (with the two lips). The change from skamt to scant would be an example of assimilation, which is a very common kind of change. Assimilation is the changing of a sound under the influence of a neighbouring sound.</p>

<p>Assimilation is not the only way in which we change our pronunciation in order to reduce effort. A sound may come to be pronounced less energetically, wherever it occurs: the English r and h sounds are undoubtedly pronounced much less vigorously now than they were a thousand years ago. In some positions a sound may disappear altogether. At one time the t was pronounced in words like castle and Christmas, and the g in words like gnat and gnaw. Sometimes a whole syllable is dropped out if it occurs twice running. A modern example is temporary, which in Britain is pronounced as if it were tempory.</p>
  </section>

  <div id="divider" title="Drag to resize"></div>

  <section class="pane" id="right">
    <h3>Questions</h3>

    <div class="group">
      <h4>Questions 27‚Äì30</h4>
      <p>Complete the summary below.</p>
      <p>Choose <strong>NO MORE THAN THREE WORDS</strong> from the passage for each answer.</p>
      <p>Write your answers in boxes <strong>27‚Äì30</strong> on your answer sheet.</p>
      <div class="headings">
        <p>It is known that the pronunciation of language changes over time. The changes include large-scale regularities known as 27 ‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶ . There are several possible causes for change. Firstly, there is the effect of one language on another. Secondly, there is the role of 28 ‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶ . The speech of certain groups has prestige, and is imitated by others. It has also been suggested that some changes are introduced by 29 ‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶ , who are unable to imitate speech in an exact way. Finally, there is a factor referred to as the 30 ‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶ , by which the effort necessary to produce words is reduced.</p>
      </div>
      <ol start="27">
        <li><span class="flag-btn" data-q="q27" style="left:-20px;"></span>
          <input type="text" name="q27" style="width:200px; padding:6px; border:1px solid #ddd; border-radius:4px;" placeholder="ËæìÂÖ•Á≠îÊ°àÔºà‰∏çË∂ÖËøá3‰∏™ËØçÔºâ">
        </li>
        <li><span class="flag-btn" data-q="q28" style="left:-20px;"></span>
          <input type="text" name="q28" style="width:200px; padding:6px; border:1px solid #ddd; border-radius:4px;" placeholder="ËæìÂÖ•Á≠îÊ°àÔºà‰∏çË∂ÖËøá3‰∏™ËØçÔºâ">
        </li>
        <li><span class="flag-btn" data-q="q29" style="left:-20px;"></span>
          <input type="text" name="q29" style="width:200px; padding:6px; border:1px solid #ddd; border-radius:4px;" placeholder="ËæìÂÖ•Á≠îÊ°àÔºà‰∏çË∂ÖËøá3‰∏™ËØçÔºâ">
        </li>
        <li><span class="flag-btn" data-q="q30" style="left:-20px;"></span>
          <input type="text" name="q30" style="width:200px; padding:6px; border:1px solid #ddd; border-radius:4px;" placeholder="ËæìÂÖ•Á≠îÊ°àÔºà‰∏çË∂ÖËøá3‰∏™ËØçÔºâ">
        </li>
      </ol>
    </div>

    <div class="group">
      <h4>Questions 31‚Äì37</h4>
      <p>Do the following statements agree with the information given in Reading Passage 3?</p>
      <p>In boxes <strong>31‚Äì37</strong> on your answer sheet, write</p>
      <div style="margin-left:20px; margin-top:8px;">
        <div><strong>TRUE</strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if the statement agrees with the information</div>
        <div><strong>FALSE</strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if the statement contradicts the information</div>
        <div><strong>NOT GIVEN</strong>&nbsp;&nbsp;if there is no information on this</div>
      </div>
      <ol start="31">
        <li><span class="flag-btn" data-q="q31" style="left:-20px;"></span>It is impossible to know how words used to be pronounced.<br>
          <label><input type="radio" name="q31" value="TRUE"> TRUE</label>
          <label><input type="radio" name="q31" value="FALSE"> FALSE</label>
          <label><input type="radio" name="q31" value="NOT GIVEN"> NOT GIVEN</label>
        </li>
        <li><span class="flag-btn" data-q="q32" style="left:-20px;"></span>Some languages appear to have changed more than others.<br>
          <label><input type="radio" name="q32" value="TRUE"> TRUE</label>
          <label><input type="radio" name="q32" value="FALSE"> FALSE</label>
          <label><input type="radio" name="q32" value="NOT GIVEN"> NOT GIVEN</label>
        </li>
        <li><span class="flag-btn" data-q="q33" style="left:-20px;"></span>Some changes in English were probably led by the middle classes.<br>
          <label><input type="radio" name="q33" value="TRUE"> TRUE</label>
          <label><input type="radio" name="q33" value="FALSE"> FALSE</label>
          <label><input type="radio" name="q33" value="NOT GIVEN"> NOT GIVEN</label>
        </li>
        <li><span class="flag-btn" data-q="q34" style="left:-20px;"></span>Certain English sounds are difficult for all children to pronounce.<br>
          <label><input type="radio" name="q34" value="TRUE"> TRUE</label>
          <label><input type="radio" name="q34" value="FALSE"> FALSE</label>
          <label><input type="radio" name="q34" value="NOT GIVEN"> NOT GIVEN</label>
        </li>
        <li><span class="flag-btn" data-q="q35" style="left:-20px;"></span>Scant is generally easier to pronounce than skamt.<br>
          <label><input type="radio" name="q35" value="TRUE"> TRUE</label>
          <label><input type="radio" name="q35" value="FALSE"> FALSE</label>
          <label><input type="radio" name="q35" value="NOT GIVEN"> NOT GIVEN</label>
        </li>
        <li><span class="flag-btn" data-q="q36" style="left:-20px;"></span>The spelling of gnat is likely to change in the future.<br>
          <label><input type="radio" name="q36" value="TRUE"> TRUE</label>
          <label><input type="radio" name="q36" value="FALSE"> FALSE</label>
          <label><input type="radio" name="q36" value="NOT GIVEN"> NOT GIVEN</label>
        </li>
        <li><span class="flag-btn" data-q="q37" style="left:-20px;"></span>The spelling of temporary no longer reflects its pronunciation.<br>
          <label><input type="radio" name="q37" value="TRUE"> TRUE</label>
          <label><input type="radio" name="q37" value="FALSE"> FALSE</label>
          <label><input type="radio" name="q37" value="NOT GIVEN"> NOT GIVEN</label>
        </li>
      </ol>
    </div>

    <div class="group">
      <h4>Questions 38‚Äì40</h4>
      <p>Look at the following statements (questions 38‚Äì40) and the list of options below.</p>
      <p>Match each statement with the option A, B, C or D.</p>
      <p>Write the correct letter A, B, C or D in boxes <strong>38‚Äì40</strong> on your answer sheet.</p>
      <div class="headings">
        <p>List of Options:</p>
        <ol>
          <li>A large-scale change</li>
          <li>B influence of one language on another</li>
          <li>C minimisation of effort</li>
          <li>D imitation of prestigious group</li>
        </ol>
      </div>
      <ol start="38">
        <li><span class="flag-btn" data-q="q38" style="left:-20px;"></span>the b sound changing to a p sound at the end of words<br>
          <label><input type="radio" name="q38" value="A"> A</label>
          <label><input type="radio" name="q38" value="B"> B</label>
          <label><input type="radio" name="q38" value="C"> C</label>
          <label><input type="radio" name="q38" value="D"> D</label>
        </li>
        <li><span class="flag-btn" data-q="q39" style="left:-20px;"></span>the melodic pronunciation of Welsh English<br>
          <label><input type="radio" name="q39" value="A"> A</label>
          <label><input type="radio" name="q39" value="B"> B</label>
          <label><input type="radio" name="q39" value="C"> C</label>
          <label><input type="radio" name="q39" value="D"> D</label>
        </li>
        <li><span class="flag-btn" data-q="q40" style="left:-20px;"></span>the disappearance of the t sound in Christmas<br>
          <label><input type="radio" name="q40" value="A"> A</label>
          <label><input type="radio" name="q40" value="B"> B</label>
          <label><input type="radio" name="q40" value="C"> C</label>
          <label><input type="radio" name="q40" value="D"> D</label>
        </li>
      </ol>
    </div>

    <div class="bottom-bar">
      <button class="btn-primary" onclick="submitAnswers()">Êèê‰∫§</button>
      <button onclick="resetForm()">ÈáçÁΩÆ</button>
      <button onclick="openWrongBook()">Êú¨ÁØáÈîôÈ¢ò</button>
    </div>
  </section>
</div>

<div id="selbar">
  <button id="btnNote">Note</button>
  <button id="btnHL">Highlight</button>
  <button id="btnUH" style="display:none;">Clear Highlight</button>
</div>

<div class="modal" id="resultModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ÊàêÁª©</h2>
      <span class="modal-close" onclick="closeModal('resultModal')">√ó</span>
    </div>
    <div id="resultContent"></div>
    <button class="btn-primary" style="width:100%; margin-top:16px;" onclick="addWrongToBook()">Âä†ÂÖ•ÈîôÈ¢òÊú¨</button>
  </div>
</div>

<div class="modal" id="wrongBookModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Êú¨ÁØáÈîôÈ¢ò</h2>
      <span class="modal-close" onclick="closeModal('wrongBookModal')">√ó</span>
    </div>
    <div id="wrongBookContent"></div>
  </div>
</div>

<div class="modal" id="resetModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ÈáçÁΩÆÁªÉ‰π†</h2>
      <span class="modal-close" onclick="closeModal('resetModal')">√ó</span>
    </div>
    <div style="margin:16px 0;">
      <label style="display:block; margin-bottom:10px;">
        <input type="radio" name="resetType" value="answers" checked>
        Âè™Ê∏ÖÁ©∫Á≠îÊ°à
      </label>
      <label style="display:block;">
        <input type="radio" name="resetType" value="all">
        Ê∏ÖÁ©∫Á≠îÊ°àÂíåÊ†áËÆ∞
      </label>
    </div>
    <button class="btn-primary" style="width:100%;" onclick="confirmReset()">Á°ÆÂÆö</button>
  </div>
</div>

<script>
const PAPER_ID='P3_LINGUISTIC_CHANGE';

let t=0;
const timerEl=document.getElementById('timer');
setInterval(()=>{ t++; timerEl.textContent=String(Math.floor(t/60)).padStart(2,'0')+':'+String(t%60).padStart(2,'0'); }, 1000);

const divider=document.getElementById('divider'), left=document.getElementById('left'), right=document.getElementById('right');
let dragging=false;
divider.onmousedown=()=>{ dragging=true; document.body.style.cursor='ew-resize'; };
window.onmousemove=(e)=>{ if(!dragging)return; const c=document.querySelector('.shell').getBoundingClientRect(); let x=e.clientX-c.left; x=Math.max(280,Math.min(c.width-280,x)); left.style.flex='0 0 '+x+'px'; right.style.flex='1 1 auto'; };
window.onmouseup=()=>{ dragging=false; document.body.style.cursor=''; };

const selbar=document.getElementById('selbar'), btnHL=document.getElementById('btnHL'), btnUH=document.getElementById('btnUH'), btnNote=document.getElementById('btnNote');
let lastRange=null, currentHlNode=null;

function posSelbar(r){ selbar.style.display='flex'; const t=window.scrollY+r.top-selbar.offsetHeight-8; const l=window.scrollX+r.left+r.width/2-selbar.offsetWidth/2; selbar.style.top=((t>0)?t:(window.scrollY+r.bottom+8))+'px'; selbar.style.left=Math.max(8,l)+'px'; }

function updSel(){ const s=window.getSelection(); if(!s||s.rangeCount===0||s.isCollapsed){ if(!currentHlNode)selbar.style.display='none'; return; } const r=s.getRangeAt(0); lastRange=r.cloneRange(); currentHlNode=null; btnNote.style.display='block'; btnHL.style.display='block'; btnUH.style.display='none'; posSelbar(r.getBoundingClientRect()); }

left.onmouseup=updSel; right.onmouseup=updSel;
document.onselectionchange=()=>{ const s=window.getSelection(); if((!s||s.rangeCount===0||s.isCollapsed)&&!currentHlNode)selbar.style.display='none'; };
document.addEventListener('click',(e)=>{ if(e.target.classList&&(e.target.classList.contains('hl')||e.target.classList.contains('note'))){ currentHlNode=e.target; lastRange=null; btnNote.style.display='none'; btnHL.style.display='none'; btnUH.style.display='block'; posSelbar(e.target.getBoundingClientRect()); const s=window.getSelection(); if(s)s.removeAllRanges(); }}, true);

btnHL.onclick=()=>{ if(currentHlNode||!lastRange||lastRange.collapsed)return; const s=document.createElement('span'); s.className='hl'; try{ lastRange.surroundContents(s); }catch(e){ const w=document.createElement('span'); w.className='hl'; w.appendChild(lastRange.cloneContents()); lastRange.deleteContents(); lastRange.insertNode(w); } selbar.style.display='none'; saveHighlights(); };

btnNote.onclick=()=>{ if(currentHlNode||!lastRange||lastRange.collapsed)return; const s=document.createElement('span'); s.className='note'; try{ lastRange.surroundContents(s); }catch(e){ const w=document.createElement('span'); w.className='note'; w.appendChild(lastRange.cloneContents()); lastRange.deleteContents(); lastRange.insertNode(w); } selbar.style.display='none'; saveHighlights(); };

btnUH.onclick=()=>{ if(currentHlNode){ const p=currentHlNode.parentNode; while(currentHlNode.firstChild)p.insertBefore(currentHlNode.firstChild,currentHlNode); p.removeChild(currentHlNode); p.normalize(); currentHlNode=null; selbar.style.display='none'; saveHighlights(); }else if(lastRange){ const sR=lastRange.getBoundingClientRect(); const w=document.createTreeWalker(document.body,NodeFilter.SHOW_ELEMENT); const tr=[]; while(w.nextNode()){ const n=w.currentNode; if(n.classList&&(n.classList.contains('hl')||n.classList.contains('note'))){ const r=n.getBoundingClientRect(); if(!(r.right<sR.left||r.left>sR.right||r.bottom<sR.top||r.top>sR.bottom))tr.push(n); }} tr.forEach(el=>{ const p=el.parentNode; while(el.firstChild)p.insertBefore(el.firstChild,el); p.removeChild(el); p.normalize(); }); selbar.style.display='none'; saveHighlights(); }};

document.querySelectorAll('.flag-btn').forEach(btn => {
  btn.onclick = e => {
    e.stopPropagation();
    btn.classList.toggle('active');
    saveFlags();
  };
});

const answerKey={
  q27:"sound laws",q28:"fashion",q29:"children",q30:"principle of ease",
  q31:"FALSE",q32:"NOT GIVEN",q33:"TRUE",q34:"NOT GIVEN",q35:"TRUE",q36:"NOT GIVEN",q37:"TRUE",
  q38:"A",q39:"B",q40:"C"
};
let lastResults=[];

function saveAnswers() {
  const data = {};
  Object.keys(answerKey).forEach(q => {
    if(q.startsWith('q27') && q <= 'q30') {
      const input = document.querySelector(`input[name="${q}"]`);
      data[q] = input ? input.value.trim() : "";
    } else {
      const radio = document.querySelector(`input[name="${q}"]:checked`);
      data[q] = radio ? radio.value : "";
    }
  });
  localStorage.setItem(`${PAPER_ID}_answers`, JSON.stringify(data));
}

function loadAnswers() {
  const data = JSON.parse(localStorage.getItem(`${PAPER_ID}_answers`) || '{}');
  Object.keys(data).forEach(q => {
    if(q.startsWith('q27') && q <= 'q30') {
      const input = document.querySelector(`input[name="${q}"]`);
      if(input) input.value = data[q];
    } else {
      const radio = document.querySelector(`input[name="${q}"][value="${data[q]}"]`);
      if(radio) radio.checked = true;
    }
  });
}

function saveFlags() {
  const flags = [...document.querySelectorAll('.flag-btn.active')].map(b => b.dataset.q);
  localStorage.setItem(`${PAPER_ID}_flags`, JSON.stringify(flags));
}

function loadFlags() {
  const flags = JSON.parse(localStorage.getItem(`${PAPER_ID}_flags`) || '[]');
  flags.forEach(q => document.querySelector(`[data-q="${q}"]`)?.classList.add('active'));
}

function saveHighlights() {
  const highlights = { left: [], right: [] };
  document.querySelectorAll('#left .hl, #left .note').forEach((el, idx) => {
    highlights.left.push({
      type: el.classList.contains('hl') ? 'hl' : 'note',
      text: el.textContent,
      index: idx
    });
  });
  document.querySelectorAll('#right .hl, #right .note').forEach((el, idx) => {
    highlights.right.push({
      type: el.classList.contains('hl') ? 'hl' : 'note',
      text: el.textContent,
      index: idx
    });
  });
  localStorage.setItem(`${PAPER_ID}_highlights`, JSON.stringify(highlights));
}

function loadHighlights() {
  const data = JSON.parse(localStorage.getItem(`${PAPER_ID}_highlights`) || '{"left":[],"right":[]}');
  
  // ÊÅ¢Â§çÂ∑¶‰æßÈ´ò‰∫Æ
  if(data.left && data.left.length > 0) {
    data.left.forEach(item => {
      const walker = document.createTreeWalker(left, NodeFilter.SHOW_TEXT);
      let node;
      while(node = walker.nextNode()) {
        if(node.textContent.includes(item.text)) {
          const span = document.createElement('span');
          span.className = item.type;
          const parent = node.parentNode;
          const text = node.textContent;
          const idx = text.indexOf(item.text);
          if(idx >= 0) {
            const before = text.substring(0, idx);
            const match = text.substring(idx, idx + item.text.length);
            const after = text.substring(idx + item.text.length);
            
            parent.insertBefore(document.createTextNode(before), node);
            span.textContent = match;
            parent.insertBefore(span, node);
            parent.insertBefore(document.createTextNode(after), node);
            parent.removeChild(node);
            break;
          }
        }
      }
    });
  }
  
  // ÊÅ¢Â§çÂè≥‰æßÈ´ò‰∫Æ
  if(data.right && data.right.length > 0) {
    data.right.forEach(item => {
      const walker = document.createTreeWalker(right, NodeFilter.SHOW_TEXT);
      let node;
      while(node = walker.nextNode()) {
        if(node.textContent.includes(item.text)) {
          const span = document.createElement('span');
          span.className = item.type;
          const parent = node.parentNode;
          const text = node.textContent;
          const idx = text.indexOf(item.text);
          if(idx >= 0) {
            const before = text.substring(0, idx);
            const match = text.substring(idx, idx + item.text.length);
            const after = text.substring(idx + item.text.length);
            
            parent.insertBefore(document.createTextNode(before), node);
            span.textContent = match;
            parent.insertBefore(span, node);
            parent.insertBefore(document.createTextNode(after), node);
            parent.removeChild(node);
            break;
          }
        }
      }
    });
  }
}

// ÁõëÂê¨ËæìÂÖ•Ê°ÜÂèòÂåñ‰øùÂ≠òÁ≠îÊ°à
document.querySelectorAll('input[type="text"]').forEach(input => {
  input.addEventListener('input', saveAnswers);
});

document.querySelectorAll('input[type="radio"]').forEach(radio => {
  radio.addEventListener('change', saveAnswers);
});

document.addEventListener('DOMContentLoaded', () => {
  loadAnswers();
  loadFlags();
  loadHighlights();
});

function submitAnswers(){ 
  const res=[]; 
  let cor=0; 
  Object.keys(answerKey).forEach(q=>{ 
    let uA="";
    if(q.startsWith('q27') && q <= 'q30') {
      const input = document.querySelector(`input[name="${q}"]`);
      uA = input ? input.value.trim().toLowerCase() : "";
    } else {
      const radio = document.querySelector(`input[name="${q}"]:checked`);
      uA = radio ? radio.value : "";
    }
    const cA=answerKey[q].toString().toLowerCase();
    const iC=uA===cA; 
    if(iC)cor++; 
    res.push({id:q,userAns:uA||'(Êú™‰ΩúÁ≠î)',correctAns:answerKey[q],isCorrect:iC}); 
  }); 
  lastResults=res; 
  const tot=Object.keys(answerKey).length; 
  const pct=((cor/tot)*100).toFixed(1); 
  localStorage.setItem(`ielts_score_${PAPER_ID}`, `${cor}/${tot}`);
  document.getElementById('resultContent').innerHTML=`<div class="result-summary"><div class="result-score">${cor} / ${tot}</div><div style="margin-top:8px;font-size:18px;">${pct}%</div></div>${res.map(r=>`<div class="result-item ${r.isCorrect?'correct':'incorrect'}"><div><strong>${r.id}</strong> ${r.isCorrect?'‚úì':'‚úó'}</div><div>‰Ω†ÁöÑÁ≠îÊ°à: ${r.userAns}</div>${!r.isCorrect?`<div>Ê≠£Á°ÆÁ≠îÊ°à: ${r.correctAns}</div>`:''}</div>`).join('')}`; 
  document.getElementById('resultModal').classList.add('active'); 
}

function resetForm(){ document.getElementById('resetModal').classList.add('active'); }

function confirmReset(){ 
  const tp=document.querySelector('input[name="resetType"]:checked').value; 
  document.querySelectorAll('input[type="radio"]').forEach(i=>i.checked=false); 
  document.querySelectorAll('input[type="text"]').forEach(i=>i.value=""); 
  localStorage.removeItem(`${PAPER_ID}_answers`);
  
  if(tp==='all'){ 
    document.querySelectorAll('.hl').forEach(el=>{ const p=el.parentNode; while(el.firstChild)p.insertBefore(el.firstChild,el); p.removeChild(el); p.normalize(); }); 
    document.querySelectorAll('.note').forEach(el=>{ const p=el.parentNode; while(el.firstChild)p.insertBefore(el.firstChild,el); p.removeChild(el); p.normalize(); }); 
    document.querySelectorAll('.flag-btn').forEach(b => b.classList.remove('active'));
    localStorage.removeItem(`${PAPER_ID}_highlights`);
    localStorage.removeItem(`${PAPER_ID}_flags`);
  } 
  closeModal('resetModal'); 
}

function addWrongToBook(){ 
  const wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); 
  const wr=lastResults.filter(r=>!r.isCorrect); 
  wr.forEach(r=>{ 
    const en={
      paperId:PAPER_ID,
      title:'The Causes of Linguistic Change',
      questionId:r.id,
      correctAnswer:r.correctAns,
      myAnswer:r.userAns,
      date:new Date().toISOString().split('T')[0]
    }; 
    const ix=wb.findIndex(i=>i.paperId===en.paperId&&i.questionId===en.questionId); 
    if(ix>=0)wb[ix]=en; 
    else wb.push(en); 
  }); 
  localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); 
  alert(`Â∑≤Ê∑ªÂä† ${wr.length} ÈÅìÈîôÈ¢ò`); 
  closeModal('resultModal'); 
}

function deleteWrongItem(pId,qId){ 
  if(!confirm('Á°ÆÂÆöÂà†Èô§ËøôÈÅìÈîôÈ¢òÔºü'))return; 
  let wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); 
  wb=wb.filter(i=>!(i.paperId===pId&&i.questionId===qId)); 
  localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); 
  openWrongBook(); 
}

function clearCurrentWrongBook(){ 
  if(!confirm('Á°ÆÂÆöÊ∏ÖÁ©∫Êú¨ÁØáÊâÄÊúâÈîôÈ¢òÔºü'))return; 
  let wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); 
  wb=wb.filter(i=>i.paperId!==PAPER_ID); 
  localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); 
  openWrongBook(); 
}

function openWrongBook(){ 
  const wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); 
  const cu=wb.filter(i=>i.paperId===PAPER_ID); 
  const ct=document.getElementById('wrongBookContent'); 
  if(cu.length===0)ct.innerHTML='<div style="text-align:center;padding:40px;color:#666;">ÊöÇÊó†ÈîôÈ¢ò</div>'; 
  else ct.innerHTML=`<div class="modal-actions"><button class="btn-danger" onclick="clearCurrentWrongBook()">üóëÔ∏è Ê∏ÖÁ©∫Êú¨ÁØáÈîôÈ¢ò</button></div>${cu.map(i=>`<div class="wrong-item"><div class="wrong-item-content"><div style="font-weight:600;margin-bottom:8px;">${i.questionId}</div><div style="font-size:13px;color:#666;"><div>‚úì Ê≠£Á°Æ: ${i.correctAnswer}</div><div style="color:#d32f2f;">‚úó ÊàëÁöÑ: ${i.myAnswer}</div></div></div><button class="btn-delete" onclick="deleteWrongItem('${i.paperId}','${i.questionId}')">Âà†Èô§</button></div>`).join('')}`; 
  document.getElementById('wrongBookModal').classList.add('active'); 
}

function closeModal(id){ document.getElementById(id).classList.remove('active'); }
</script>
</body>
</html>