<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>P2 ‚Äì The dingo debate</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  * { box-sizing: border-box; margin:0; padding:0; }
  html,body { height:100%; }
  body { font-family: Arial, sans-serif; background:#f5f5f5; }
  
  #timer { position:fixed; top:12px; right:12px; background:#fff; border:1px solid #ddd; border-radius:6px; padding:8px 12px; font-size:16px; font-weight:600; color:#0066cc; z-index:1000; }
  
  .shell { display:flex; height:100vh; width:100%; }
  .pane { background:#fff; overflow:auto; padding:24px; }
  #left { flex: 0 0 50%; border-right:1px solid #ddd; }
  #right { flex: 1 1 auto; background:#fafafa; }
  #divider { flex: 0 0 5px; background:#ddd; cursor: ew-resize; }
  #divider:hover { background:#999; }
  
  h2,h3,h4 { margin:0 0 12px; color:#333; }
  h2 { font-size:20px; }
  h3 { font-size:18px; color:#0066cc; }
  h4 { font-size:15px; font-weight:600; margin-top:20px; }
  
  #left p { margin: 0 0 14px; line-height: 1.7; text-align:justify; }
  
  .group { background:#fff; border:1px solid #ddd; border-radius:6px; padding:16px; margin-bottom:16px; }
  .group h4 { margin-top:0; color:#0066cc; }
  .group p { margin:8px 0; font-size:14px; line-height:1.6; }
  
  .drop-zone { min-height:40px; border:2px dashed #ccc; border-radius:6px; padding:8px; margin:8px 0; background:#f9f9f9; }
  .drop-zone.over { border-color:#0066cc; background:#e3f2fd; }
  .drop-item { display:inline-block; padding:6px 12px; margin:4px; background:#0066cc; color:#fff; border-radius:4px; cursor:move; user-select:none; }
  .drop-item.placed { background:#666; }
  
  .options-pool { display:flex; flex-wrap:wrap; gap:8px; padding:12px; background:#fff; border:1px solid #ddd; border-radius:6px; margin:12px 0; }
  
  .flag-btn { 
    position:absolute; 
    left:2px; 
    top:50%;
    transform:translateY(-50%);
    width:8px;
    height:8px;
    border-radius:50%;
    background:#ddd;
    cursor:pointer;
    z-index:10;
  }
  .flag-btn:hover { background:#999; }
  .flag-btn.active { background:#ff5722; }
  
  .question-item { position:relative; padding-left:16px; margin:16px 0; }
  
  .bottom-bar { display:flex; gap:10px; margin-top:16px; }
  button { padding:10px 20px; border:1px solid #999; border-radius:6px; background:#fff; cursor:pointer; font-size:14px; }
  button:hover { background:#f0f0f0; }
  .btn-primary { background:#0066cc; color:#fff; border-color:#0066cc; }
  .btn-primary:hover { background:#0052a3; }
  .btn-danger { background:#dc3545; color:#fff; border-color:#dc3545; }
  .btn-danger:hover { background:#c82333; }
  
  .hl { background:#fff59d; cursor:pointer; }
  .hl:hover { background:#ffeb3b; }
  .note { background:#b3d9ff; cursor:pointer; }
  .note:hover { background:#99ccff; }
  
  #selbar { position:fixed; display:none; z-index:2000; background:#fff; border:1px solid #ddd; border-radius:8px; padding:8px; gap:0; box-shadow:0 2px 8px rgba(0,0,0,0.15); flex-direction:column; min-width:120px; }
  #selbar button { background:#fff; color:#666; border:none; padding:8px 16px; cursor:pointer; font-size:14px; text-align:center; border-radius:4px; }
  #selbar button:hover { background:#f5f5f5; color:#333; }
  
  .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:3000; align-items:center; justify-content:center; }
  .modal.active { display:flex; }
  .modal-content { background:#fff; border-radius:8px; padding:24px; max-width:600px; width:90%; max-height:80vh; overflow-y:auto; }
  
  .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
  .modal-header h2 { font-size: 28px; color: #333; margin: 0; }
  .modal-close { font-size: 32px; cursor: pointer; color: #999; line-height: 1; }
  .modal-close:hover { color: #333; }
  
  .result-summary { text-align:center; padding:20px; background:#f0f0f0; margin-bottom:16px; border-radius:6px; }
  .result-score { font-size:36px; font-weight:600; color:#0066cc; }
  .result-item { padding:10px; margin:8px 0; border-left:3px solid #ddd; background:#f9f9f9; font-size:13px; }
  .result-item.correct { border-left-color:#28a745; background:#e8f5e9; }
  .result-item.incorrect { border-left-color:#dc3545; background:#ffebee; }
  
  .wrong-item { background:#fff3e0; padding:16px; margin:8px 0; border-radius:8px; border-left:4px solid #ff9800; display:flex; justify-content:space-between; align-items:start; }
  .wrong-item-content { flex:1; }
  .btn-delete { background:#dc3545; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-size:13px; margin-left:12px; }
  .btn-delete:hover { background:#c82333; }
  .modal-actions { display:flex; gap:10px; margin-bottom:20px; }
  
  input[type="text"] { width:200px; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:14px; }
</style>
</head>
<body>
<div id="timer">00:00</div>

<div class="shell">
  <section class="pane" id="left">
    
<h2>READING PASSAGE 2</h2>
<p>You should spend about 20 minutes on Questions 14‚Äì26, which are based on Reading Passage 2 below.</p>
<h3>The dingo debate</h3>

<p style="font-style:italic;">Graziers see them as pests, and poisoning is common, but some biologists think Australia's dingoes are the best weapon in a war against imported cats and foxes.</p>

<h4>Paragraph A</h4>
<p>A plane flies a slow pattern over Carlton Hill station, a 3,600 square kilometre ranch in the Kimberley region in northwest Australia. As the plane circles, those aboard drop 1,000 small pieces of meat, one by one, onto the scrubland below, each piece laced with poison; this practice is known as baiting.</p>

<p>Besides 50,000 head of cattle, Carlton Hill is home to the dingo, Australia's largest mammalian predator and the bane of a grazier's (cattle farmer's) life. Stuart McKechnie, manager of Carlton Hill, complains that graziers' livelihoods are threatened when dingoes prey on cattle. But one man wants the baiting to end, and for dingoes to once again roam Australia's wide-open spaces. According to Chris Johnson of James Cook University, "Australia needs more dingoes to protect our biodiversity."</p>

<h4>Paragraph B</h4>
<p>About 4,000 years ago, Asian sailors introduced dingoes to Australia. Throughout the ensuing millennia, these descendants of the wolf spread across the continent and, as the Tasmanian tiger disappeared completely from Australia, dingoes became Australia's top predators. As agricultural development took place, the European settlers found that they could not safely keep their livestock where dingoes roamed. So began one of the most sustained efforts at pest control in Australia's history. Over the last 150 years, dingoes have been shot and poisoned, and fences have been used in an attempt to keep them away from livestock. But at the same time, as the European settlers tried to eliminate one native pest from Australia, they introduced more of their own.</p>

<h4>Paragraph C</h4>
<p>In 1860, the rabbit was unleashed on Australia by a wealthy landowner and by 1980 rabbits had covered most of the mainland. Rabbits provide huge prey base for two other introduced species: the feral (wild) cat and the red fox.</p>

<p>The interaction between foxes, cats and rabbits is a huge problem for native mammals. In good years, rabbit numbers increase dramatically, and fox and cat populations grow quickly in response to the abundance of this prey. When bad seasons follow, rabbit numbers are significantly reduced ‚Äì and the dwindling but still large fox and cat populations are left with little to eat besides native mammals.</p>

<h4>Paragraph D</h4>
<p>Australian mammals generally reproduce much more slowly than rabbits, cats and foxes ‚Äì an adaption to prevent overpopulation in the arid environment, where food can be scarce and unreliable ‚Äì and populations decline because they can't grow fast enough to replace animals killed by the predators. Johnson says dingoes are the solution to this problem because they keep cat and fox populations under control. Besides regularly eating the smaller predators, dingoes will kill them simply to lessen competition.</p>

<p>Dingo packs live in large, stable territories and generally have only one fertile female, which limits their rate of increase. In the 4,000 years that dingoes have been Australia, they have contributed to few, if any, extinctions, Johnson says.</p>

<h4>Paragraph E</h4>
<p>Reaching out from a desolate spot where three states meet, for 2,500 km in either direction, is the world's longest fence, two meters high and stretching from the coast in Queensland to the Great Australian Bight in South Australia; it is there to keep dingoes out of southeast, the fence separates the main types of livestock found in Australia. To the northwest of the fence, cattle predominate; to the southwest, sheep fill the landscape. In fact, Australia is a land dominated by these animals ‚Äì 25 million cattle, 100 million sheep and just over 20 million people.</p>

<h4>Paragraph F</h4>
<p>While there is no argument that dingoes will prey on sheep if given the chance, they don't hunt cattle once the calves are much past two or three weeks old, according to McKechnie. And a study in Queensland suggests that dingoes don't even prey heavily on the newborn calves unless their staple prey disappears due to deteriorating conditions like drought.</p>

<p>This study, co-authored by Lee Allen of the Robert Wicks Research Centre in Queensland, suggests that the aggressive baiting programs used against dingoes may actually be counter-productive for graziers. When dingoes are removed from an area by baiting, the area is recolonized by younger, more solitary dingoes. These animals aren't capable of going after large prey like kangaroos, so they turn to calves. In their study, some of the highest rates of calf predation occurred in areas that had been baited.</p>

<h4>Paragraph G</h4>
<p>Mark Clifford, general manager of a firm that manages over 200,000 head of cattle, is not convinced by Allen's assertion. Clifford says, "It's obvious if we drop or loosen control on dingoes, we are going to lose more calves." He doesn't believe that dingoes will go after kangaroos when calves are around. Nor is he persuaded of dingoes' supposed ecological benefits, saying he is not convinced that they manage to catch cats that often, believing they are more likely to catch small native animals instead.</p>

<h4>Paragraph H</h4>
<p>McKechnie agrees that dingoes kill the wallabies (small native animals) that compete with his cattle for food, but points out that in parts of Western Australia, there are no foxes, and not very many cats. He doesn't see how relaxing controls on dingoes in his area will improve the ecological balance.</p>

<p>Johnson sees a need for a change in philosophy on the part of graziers. "There might be a number of different ways of thinking through dingo management in cattle country," he says. "At the moment, though, that hasn't got through to graziers. There's still just one prescription, and that is to bait as widely as possible."</p>

  </section>

  <div id="divider" title="Drag to resize"></div>

  <section class="pane" id="right">
    <h3>Questions</h3>

    <div class="group">
      <h4>Questions 14‚Äì20</h4>
      <p>Reading Passage 2 has eight sections, A‚ÄìH.</p>
      <p>Which section contains the following information?</p>
      <p>Write the correct letter, <strong>A‚ÄìH</strong>, in boxes <strong>14‚Äì20</strong> on your answer sheet.</p>
      <p><strong>NB</strong> You may use any letter more than once.</p>

      <div class="options-pool" id="sectionsPool"></div>

      <div class="question-item">
        <span class="flag-btn" data-q="q14"></span>
        <strong>14</strong> a description of a barrier designed to stop dingoes, which also divides two kinds of non-native animals
        <div class="drop-zone" data-question="q14"></div>
      </div>

      <div class="question-item">
        <span class="flag-btn" data-q="q15"></span>
        <strong>15</strong> how dingoes ensure that rival species do not dominate
        <div class="drop-zone" data-question="q15"></div>
      </div>

      <div class="question-item">
        <span class="flag-btn" data-q="q16"></span>
        <strong>16</strong> a reference to a widespread non-native species that other animals feed on
        <div class="drop-zone" data-question="q16"></div>
      </div>

      <div class="question-item">
        <span class="flag-btn" data-q="q17"></span>
        <strong>17</strong> a mention of the dingo's arrival in Australia
        <div class="drop-zone" data-question="q17"></div>
      </div>

      <div class="question-item">
        <span class="flag-btn" data-q="q18"></span>
        <strong>18</strong> research which has proved that dingoes have resorted to eating young livestock
        <div class="drop-zone" data-question="q18"></div>
      </div>

      <div class="question-item">
        <span class="flag-btn" data-q="q19"></span>
        <strong>19</strong> a description of a method used to kill dingoes
        <div class="drop-zone" data-question="q19"></div>
      </div>

      <div class="question-item">
        <span class="flag-btn" data-q="q20"></span>
        <strong>20</strong> the way that the structure of dingo groups affects how quickly their numbers grow
        <div class="drop-zone" data-question="q20"></div>
      </div>
    </div>

    <div class="group">
      <h4>Questions 21‚Äì23</h4>
      <p>Look at the following statements (Questions 21‚Äì23) and the list of people below.</p>
      <p>Match each statement with the correct person, <strong>A, B, C or D</strong>.</p>
      <p>Write the correct letter, <strong>A, B, C or D</strong>, in boxes <strong>21‚Äì23</strong> on your answer sheet.</p>

      <div style="background:#f0f0f0; padding:12px; border-radius:6px; margin:12px 0;">
        <strong>List of People</strong>
        <div style="margin-left:20px; margin-top:8px; font-size:13px;">
          <div><strong>A</strong> Stuart McKechnie</div>
          <div><strong>B</strong> Chris Johnson</div>
          <div><strong>C</strong> Lee Allen</div>
          <div><strong>D</strong> Mark Clifford</div>
        </div>
      </div>

      <div class="options-pool" id="peoplePool"></div>

      <div class="question-item">
        <span class="flag-btn" data-q="q21"></span>
        <strong>21</strong> Dingoes tend to hunt native animals rather than hunting other non-native predators.
        <div class="drop-zone" data-question="q21"></div>
      </div>

      <div class="question-item">
        <span class="flag-btn" data-q="q22"></span>
        <strong>22</strong> The presence of dingoes puts the income of some people at risk.
        <div class="drop-zone" data-question="q22"></div>
      </div>

      <div class="question-item">
        <span class="flag-btn" data-q="q23"></span>
        <strong>23</strong> Dingoes have had little impact on the dying out of animal species in Australia.
        <div class="drop-zone" data-question="q23"></div>
      </div>
    </div>

    <div class="group">
      <h4>Questions 24‚Äì26</h4>
      <p>Complete the sentences below.</p>
      <p>Choose <strong>NO MORE THAN TWO WORDS</strong> from the passage for each answer.</p>
      <p>Write your answers in boxes <strong>24‚Äì26</strong> on your answer sheet.</p>

      <div class="question-item">
        <span class="flag-btn" data-q="q24"></span>
        <strong>24</strong> The dingo replaced the <input type="text" name="q24"> as the main predatory animal in Australia.
      </div>

      <div class="question-item">
        <span class="flag-btn" data-q="q25"></span>
        <strong>25</strong> Foxes and cats are more likely to hunt native animals when there are fewer <input type="text" name="q25">.
      </div>

      <div class="question-item">
        <span class="flag-btn" data-q="q26"></span>
        <strong>26</strong> Australian animals reproduce at a slow rate as a natural way of avoiding <input type="text" name="q26">.
      </div>
    </div>

    <div class="bottom-bar">
      <button class="btn-primary" onclick="submitAnswers()">Êèê‰∫§</button>
      <button onclick="resetForm()">ÈáçÁΩÆ</button>
      <button onclick="openWrongBook()">Êú¨ÁØáÈîôÈ¢ò</button>
    </div>
  </section>
</div>

<div id="selbar">
  <button id="btnNote">Note</button>
  <button id="btnHL">Highlight</button>
  <button id="btnUH" style="display:none;">Clear Highlight</button>
</div>

<div class="modal" id="resultModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ÊàêÁª©</h2>
      <span class="modal-close" onclick="closeModal('resultModal')">√ó</span>
    </div>
    <div id="resultContent"></div>
    <button class="btn-primary" style="width:100%; margin-top:16px;" onclick="addWrongToBook()">Âä†ÂÖ•ÈîôÈ¢òÊú¨</button>
  </div>
</div>

<div class="modal" id="wrongBookModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Êú¨ÁØáÈîôÈ¢ò</h2>
      <span class="modal-close" onclick="closeModal('wrongBookModal')">√ó</span>
    </div>
    <div id="wrongBookContent"></div>
  </div>
</div>

<div class="modal" id="resetModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ÈáçÁΩÆÁªÉ‰π†</h2>
      <span class="modal-close" onclick="closeModal('resetModal')">√ó</span>
    </div>
    <div style="margin:16px 0;">
      <label style="display:block; margin-bottom:10px;">
        <input type="radio" name="resetType" value="answers" checked>
        Âè™Ê∏ÖÁ©∫Á≠îÊ°à
      </label>
      <label style="display:block;">
        <input type="radio" name="resetType" value="all">
        Ê∏ÖÁ©∫Á≠îÊ°àÂíåÊ†áËÆ∞
      </label>
    </div>
    <button class="btn-primary" style="width:100%;" onclick="confirmReset()">Á°ÆÂÆö</button>
  </div>
</div>

<script>
const PAPER_ID='P2_DINGO_DEBATE';

let t=0;
const timerEl=document.getElementById('timer');
setInterval(()=>{ t++; timerEl.textContent=String(Math.floor(t/60)).padStart(2,'0')+':'+String(t%60).padStart(2,'0'); }, 1000);

const divider=document.getElementById('divider'), left=document.getElementById('left'), right=document.getElementById('right');
let dragging=false;
divider.onmousedown=()=>{ dragging=true; document.body.style.cursor='ew-resize'; };
window.onmousemove=(e)=>{ if(!dragging)return; const c=document.querySelector('.shell').getBoundingClientRect(); let x=e.clientX-c.left; x=Math.max(280,Math.min(c.width-280,x)); left.style.flex='0 0 '+x+'px'; right.style.flex='1 1 auto'; };
window.onmouseup=()=>{ dragging=false; document.body.style.cursor=''; };

const selbar=document.getElementById('selbar'), btnHL=document.getElementById('btnHL'), btnUH=document.getElementById('btnUH'), btnNote=document.getElementById('btnNote');
let lastRange=null, currentHlNode=null;

function posSelbar(r){ selbar.style.display='flex'; const t=window.scrollY+r.top-selbar.offsetHeight-8; const l=window.scrollX+r.left+r.width/2-selbar.offsetWidth/2; selbar.style.top=((t>0)?t:(window.scrollY+r.bottom+8))+'px'; selbar.style.left=Math.max(8,l)+'px'; }

function updSel(){ const s=window.getSelection(); if(!s||s.rangeCount===0||s.isCollapsed){ if(!currentHlNode)selbar.style.display='none'; return; } const r=s.getRangeAt(0); lastRange=r.cloneRange(); currentHlNode=null; btnNote.style.display='block'; btnHL.style.display='block'; btnUH.style.display='none'; posSelbar(r.getBoundingClientRect()); }

left.onmouseup=updSel; right.onmouseup=updSel;
document.onselectionchange=()=>{ const s=window.getSelection(); if((!s||s.rangeCount===0||s.isCollapsed)&&!currentHlNode)selbar.style.display='none'; };
document.addEventListener('click',(e)=>{ if(e.target.classList&&(e.target.classList.contains('hl')||e.target.classList.contains('note'))){ currentHlNode=e.target; lastRange=null; btnNote.style.display='none'; btnHL.style.display='none'; btnUH.style.display='block'; posSelbar(e.target.getBoundingClientRect()); const s=window.getSelection(); if(s)s.removeAllRanges(); }}, true);

btnHL.onclick=()=>{ if(currentHlNode||!lastRange||lastRange.collapsed)return; const s=document.createElement('span'); s.className='hl'; try{ lastRange.surroundContents(s); }catch(e){ const w=document.createElement('span'); w.className='hl'; w.appendChild(lastRange.cloneContents()); lastRange.deleteContents(); lastRange.insertNode(w); } selbar.style.display='none'; saveHighlights(); };

btnNote.onclick=()=>{ if(currentHlNode||!lastRange||lastRange.collapsed)return; const s=document.createElement('span'); s.className='note'; try{ lastRange.surroundContents(s); }catch(e){ const w=document.createElement('span'); w.className='note'; w.appendChild(lastRange.cloneContents()); lastRange.deleteContents(); lastRange.insertNode(w); } selbar.style.display='none'; saveHighlights(); };

btnUH.onclick=()=>{ if(currentHlNode){ const p=currentHlNode.parentNode; while(currentHlNode.firstChild)p.insertBefore(currentHlNode.firstChild,currentHlNode); p.removeChild(currentHlNode); p.normalize(); currentHlNode=null; selbar.style.display='none'; saveHighlights(); }};

document.querySelectorAll('.flag-btn').forEach(btn => {
  btn.onclick = e => {
    e.stopPropagation();
    btn.classList.toggle('active');
    saveFlags();
  };
});

const answerKey={
  q14:"E",q15:"D",q16:"C",q17:"B",q18:"F",q19:"A",q20:"D",
  q21:"D",q22:"A",q23:"B",
  q24:"tasmanian tiger",q25:"rabbits",q26:"overpopulation"
};
let lastResults=[];

const sectionsOptions = ['A','B','C','D','E','F','G','H'];
const peopleOptions = ['A','B','C','D'];

function initDragDrop() {
  const sectionsPool = document.getElementById('sectionsPool');
  const peoplePool = document.getElementById('peoplePool');
  
  sectionsOptions.forEach(opt => {
    const item = document.createElement('div');
    item.className = 'drop-item';
    item.textContent = opt;
    item.draggable = true;
    item.dataset.value = opt;
    item.dataset.group = 'sections';
    sectionsPool.appendChild(item);
  });
  
  peopleOptions.forEach(opt => {
    const item = document.createElement('div');
    item.className = 'drop-item';
    item.textContent = opt;
    item.draggable = true;
    item.dataset.value = opt;
    item.dataset.group = 'people';
    peoplePool.appendChild(item);
  });
  
  document.querySelectorAll('.drop-item').forEach(item => {
    item.addEventListener('dragstart', e => {
      e.dataTransfer.setData('text/plain', JSON.stringify({
        value: item.dataset.value,
        group: item.dataset.group
      }));
      item.style.opacity = '0.5';
    });
    
    item.addEventListener('dragend', e => {
      item.style.opacity = '1';
    });
  });
  
  document.querySelectorAll('.drop-zone').forEach(zone => {
    zone.addEventListener('dragover', e => {
      e.preventDefault();
      zone.classList.add('over');
    });
    
    zone.addEventListener('dragleave', e => {
      zone.classList.remove('over');
    });
    
    zone.addEventListener('drop', e => {
      e.preventDefault();
      zone.classList.remove('over');
      
      const data = JSON.parse(e.dataTransfer.getData('text/plain'));
      const qid = zone.dataset.question;
      
      if((qid.match(/q1[4-9]|q20/) && data.group !== 'sections') ||
         (qid.match(/q2[1-3]/) && data.group !== 'people')) {
        return;
      }
      
      while(zone.firstChild) {
        const child = zone.firstChild;
        child.classList.remove('placed');
        if(child.dataset.group === 'sections') {
          document.getElementById('sectionsPool').appendChild(child);
        } else {
          document.getElementById('peoplePool').appendChild(child);
        }
      }
      
      const item = document.querySelector(`.drop-item[data-value="${data.value}"][data-group="${data.group}"]`);
      if(item && !item.classList.contains('placed')) {
        zone.appendChild(item);
        item.classList.add('placed');
        saveAnswers();
      }
    });
  });
}

function saveAnswers() {
  const data = {};
  
  document.querySelectorAll('.drop-zone').forEach(zone => {
    const item = zone.querySelector('.drop-item');
    if(item) {
      data[zone.dataset.question] = item.dataset.value;
    }
  });
  
  document.querySelectorAll('input[type="text"]').forEach(input => {
    if(input.name && input.value.trim()) {
      data[input.name] = input.value.trim().toLowerCase();
    }
  });
  
  localStorage.setItem(`${PAPER_ID}_answers`, JSON.stringify(data));
}

function loadAnswers() {
  const data = JSON.parse(localStorage.getItem(`${PAPER_ID}_answers`) || '{}');
  
  Object.keys(data).forEach(qid => {
    const value = data[qid];
    
    const zone = document.querySelector(`.drop-zone[data-question="${qid}"]`);
    if(zone) {
      const group = qid.match(/q1[4-9]|q20/) ? 'sections' : 'people';
      const item = document.querySelector(`.drop-item[data-value="${value}"][data-group="${group}"]`);
      if(item) {
        zone.appendChild(item);
        item.classList.add('placed');
      }
    }
    
    const input = document.querySelector(`input[name="${qid}"]`);
    if(input) {
      input.value = value;
    }
  });
}

function saveFlags() {
  const flags = [...document.querySelectorAll('.flag-btn.active')].map(b => b.dataset.q);
  localStorage.setItem(`${PAPER_ID}_flags`, JSON.stringify(flags));
}

function loadFlags() {
  const flags = JSON.parse(localStorage.getItem(`${PAPER_ID}_flags`) || '[]');
  flags.forEach(q => document.querySelector(`[data-q="${q}"]`)?.classList.add('active'));
}

function saveHighlights() {
  const highlights = { left: [], right: [] };
  ['left','right'].forEach(pane=>{
    document.querySelectorAll(`#${pane} .hl, #${pane} .note`).forEach((el,idx)=>{
      highlights[pane].push({
        type: el.classList.contains('hl') ? 'hl' : 'note',
        text: el.textContent,
        index: idx
      });
    });
  });
  localStorage.setItem(`${PAPER_ID}_highlights`, JSON.stringify(highlights));
}
function loadHighlights() {
  const data = JSON.parse(localStorage.getItem(`${PAPER_ID}_highlights`) || '{"left":[],"right":[]}');
  ['left','right'].forEach(pane=>{
    if(!data[pane]) return;
    data[pane].forEach(item=>{
      const walker = document.createTreeWalker(document.getElementById(pane), NodeFilter.SHOW_TEXT);
      let node;
      while(node = walker.nextNode()){
        const idx = node.textContent.indexOf(item.text);
        if(idx === -1) continue;
        const parent = node.parentNode;
        const before = node.textContent.substring(0, idx);
        const match  = node.textContent.substring(idx, idx + item.text.length);
        const after  = node.textContent.substring(idx + item.text.length);

        parent.insertBefore(document.createTextNode(before), node);
        const span = document.createElement('span');
        span.className = item.type;
        span.textContent = match;
        parent.insertBefore(span, node);
        parent.insertBefore(document.createTextNode(after), node);
        parent.removeChild(node);
        break;
      }
    });
  });
}

document.querySelectorAll('input[type="text"]').forEach(input => {
  input.addEventListener('input', saveAnswers);
});

document.addEventListener('DOMContentLoaded', () => {
  initDragDrop();
  loadAnswers();
  loadFlags();
  loadHighlights();
});

function submitAnswers(){ 
  const res=[]; 
  let cor=0; 
  
  Object.keys(answerKey).forEach(q=>{ 
    let uA = "";
    
    const zone = document.querySelector(`.drop-zone[data-question="${q}"]`);
    if(zone) {
      const item = zone.querySelector('.drop-item');
      if(item) uA = item.dataset.value;
    }
    
    const input = document.querySelector(`input[name="${q}"]`);
    if(input && input.value.trim()) {
      uA = input.value.trim().toLowerCase();
    }
    
    const cA = answerKey[q];
    const iC = uA.toLowerCase() === cA.toLowerCase();
    if(iC) cor++; 
    res.push({id:q, userAns:uA, correctAns:cA, isCorrect:iC}); 
  }); 
  
  lastResults=res; 
  const tot=Object.keys(answerKey).length; 
  const pct=((cor/tot)*100).toFixed(1); 
  localStorage.setItem(`ielts_score_${PAPER_ID}`, `${cor}/${tot}`);
  document.getElementById('resultContent').innerHTML=`<div class="result-summary"><div class="result-score">${cor} / ${tot}</div><div style="margin-top:8px;font-size:18px;">${pct}%</div></div>${res.map(r=>`<div class="result-item ${r.isCorrect?'correct':'incorrect'}"><div><strong>${r.id}</strong> ${r.isCorrect?'‚úì':'‚úó'}</div><div>‰Ω†ÁöÑÁ≠îÊ°à: ${r.userAns||'(Êú™‰ΩúÁ≠î)'}</div>${!r.isCorrect?`<div>Ê≠£Á°ÆÁ≠îÊ°à: ${r.correctAns}</div>`:''}</div>`).join('')}`; 
  document.getElementById('resultModal').classList.add('active'); 
}

function resetForm(){ 
  document.getElementById('resetModal').classList.add('active'); 
}

function confirmReset(){ 
  const tp=document.querySelector('input[name="resetType"]:checked').value; 
  
  document.querySelectorAll('.drop-item.placed').forEach(item => {
    item.classList.remove('placed');
    if(item.dataset.group === 'sections') {
      document.getElementById('sectionsPool').appendChild(item);
    } else {
      document.getElementById('peoplePool').appendChild(item);
    }
  });
  
  document.querySelectorAll('input[type="text"]').forEach(i=>i.value=''); 
  localStorage.removeItem(`${PAPER_ID}_answers`);
  
  if(tp==='all'){ 
    document.querySelectorAll('.hl').forEach(el=>{ const p=el.parentNode; while(el.firstChild)p.insertBefore(el.firstChild,el); p.removeChild(el); p.normalize(); }); 
    document.querySelectorAll('.note').forEach(el=>{ const p=el.parentNode; while(el.firstChild)p.insertBefore(el.firstChild,el); p.removeChild(el); p.normalize(); }); 
    document.querySelectorAll('.flag-btn').forEach(b => b.classList.remove('active'));
    localStorage.removeItem(`${PAPER_ID}_highlights`);
    localStorage.removeItem(`${PAPER_ID}_flags`);
  } 
  closeModal('resetModal'); 
}

function addWrongToBook(){ 
  const wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); 
  const wr=lastResults.filter(r=>!r.isCorrect); 
  wr.forEach(r=>{ 
    const en={paperId:PAPER_ID,title:'The dingo debate',questionId:r.id,correctAnswer:r.correctAns,myAnswer:r.userAns||'(Êú™‰ΩúÁ≠î)',date:new Date().toISOString().split('T')[0]}; 
    const ix=wb.findIndex(i=>i.paperId===en.paperId&&i.questionId===en.questionId); 
    if(ix>=0)wb[ix]=en; else wb.push(en); 
  }); 
  localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); 
  alert(`Â∑≤Ê∑ªÂä† ${wr.length} ÈÅìÈîôÈ¢ò`); 
  closeModal('resultModal'); 
}

function deleteWrongItem(pId,qId){ 
  if(!confirm('Á°ÆÂÆöÂà†Èô§ËøôÈÅìÈîôÈ¢òÔºü'))return; 
  let wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); 
  wb=wb.filter(i=>!(i.paperId===pId&&i.questionId===qId)); 
  localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); 
  openWrongBook(); 
}

function clearCurrentWrongBook(){ 
  if(!confirm('Á°ÆÂÆöÊ∏ÖÁ©∫Êú¨ÁØáÊâÄÊúâÈîôÈ¢òÔºü'))return; 
  let wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); 
  wb=wb.filter(i=>i.paperId!==PAPER_ID); 
  localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); 
  openWrongBook(); 
}

function openWrongBook(){ 
  const wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); 
  const cu=wb.filter(i=>i.paperId===PAPER_ID); 
  const ct=document.getElementById('wrongBookContent'); 
  if(cu.length===0)ct.innerHTML='<div style="text-align:center;padding:40px;color:#666;">ÊöÇÊó†ÈîôÈ¢ò</div>'; 
  else ct.innerHTML=`<div class="modal-actions"><button class="btn-danger" onclick="clearCurrentWrongBook()" style="width:100%;">üóëÔ∏è Ê∏ÖÁ©∫Êú¨ÁØáÈîôÈ¢ò</button></div>${cu.map(i=>`<div class="wrong-item"><div class="wrong-item-content"><div style="font-weight:600;margin-bottom:8px;">${i.questionId}</div><div style="font-size:13px;color:#666;"><div>‚úì Ê≠£Á°Æ: ${i.correctAnswer}</div><div style="color:#d32f2f;">‚úó ÊàëÁöÑ: ${i.myAnswer}</div></div></div><button class="btn-delete" onclick="deleteWrongItem('${i.paperId}','${i.questionId}')">Âà†Èô§</button></div>`).join('')}`; 
  document.getElementById('wrongBookModal').classList.add('active'); 
}

function closeModal(id){ 
  document.getElementById(id).classList.remove('active'); 
}
</script>
</body>
</html>
