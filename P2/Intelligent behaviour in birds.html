<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>P2 ‚Äì Intelligent behaviour in birds</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      html,
      body {
        height: 100%;
      }
      body {
        font-family: Arial, sans-serif;
        background: #f5f5f5;
      }
      #timer {
        position: fixed;
        top: 12px;
        right: 12px;
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 8px 12px;
        font-size: 16px;
        font-weight: 600;
        color: #0066cc;
        z-index: 1000;
      }
      .shell {
        display: flex;
        height: 100vh;
        width: 100%;
      }
      .pane {
        background: #fff;
        overflow: auto;
        padding: 24px;
      }
      #left {
        flex: 0 0 50%;
        border-right: 1px solid #ddd;
      }
      #right {
        flex: 1 1 auto;
        background: #fafafa;
      }
      #divider {
        flex: 0 0 5px;
        background: #ddd;
        cursor: ew-resize;
      }
      #divider:hover {
        background: #999;
      }
      h2,
      h3,
      h4 {
        margin: 0 0 12px;
        color: #333;
      }
      h2 {
        font-size: 20px;
      }
      h3 {
        font-size: 18px;
        color: #0066cc;
      }
      h4 {
        font-size: 15px;
        font-weight: 600;
        margin-top: 20px;
      }
      #left p {
        margin: 0 0 14px;
        line-height: 1.7;
        text-align: justify;
      }
      .group {
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 16px;
        margin-bottom: 16px;
      }
      .group h4 {
        margin-top: 0;
        color: #0066cc;
      }
      .group p {
        margin: 8px 0;
        font-size: 14px;
        line-height: 1.6;
      }
      .flag-btn {
        position: absolute;
        left: 2px;
        top: 50%;
        transform: translateY(-50%);
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #ddd;
        cursor: pointer;
        z-index: 10;
      }
      .flag-btn:hover {
        background: #999;
      }
      .flag-btn.active {
        background: #ff5722;
      }
      .group ol {
        margin-left: 20px;
      }
      .group ol li {
        margin: 12px 0;
        font-size: 14px;
        line-height: 1.6;
        position: relative;
      }
      .group ol li label {
        display: inline-block;
        margin-right: 8px;
      }
      input[type="text"] {
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 4px 8px;
        font-size: 14px;
        width: 160px;
        background: #fdfdfd;
      }
      input[type="text"]:focus {
        border-color: #0066cc;
        outline: none;
        background: #fff;
      }
      .bottom-bar {
        display: flex;
        gap: 10px;
        margin-top: 16px;
      }
      button {
        padding: 10px 20px;
        border: 1px solid #999;
        border-radius: 6px;
        background: #fff;
        cursor: pointer;
        font-size: 14px;
      }
      button:hover {
        background: #f0f0f0;
      }
      .btn-primary {
        background: #0066cc;
        color: #fff;
        border-color: #0066cc;
      }
      .btn-primary:hover {
        background: #0052a3;
      }
      .btn-danger {
        background: #dc3545;
        color: #fff;
        border-color: #dc3545;
      }
      .btn-danger:hover {
        background: #c82333;
      }
      .hl {
        background: #fff59d;
        cursor: pointer;
      }
      .hl:hover {
        background: #ffeb3b;
      }
      .note {
        background: #b3d9ff;
        cursor: pointer;
      }
      .note:hover {
        background: #99ccff;
      }
      #selbar {
        position: fixed;
        display: none;
        z-index: 2000;
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 8px;
        gap: 0;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        flex-direction: column;
        min-width: 120px;
      }
      #selbar button {
        background: #fff;
        color: #666;
        border: none;
        padding: 3px 0px;
        cursor: pointer;
        font-size: 14px;
        text-align: center;
        border-radius: 4px;
      }
      #selbar button:hover {
        background: #f5f5f5;
        color: #333;
      }
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 3000;
        align-items: center;
        justify-content: center;
      }
      .modal.active {
        display: flex;
      }
      .modal-content {
        background: #fff;
        border-radius: 8px;
        padding: 24px;
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
      }
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
      }
      .modal-header h2 {
        font-size: 28px;
        color: #333;
        margin: 0;
      }
      .modal-close {
        font-size: 32px;
        cursor: pointer;
        color: #999;
        line-height: 1;
      }
      .modal-close:hover {
        color: #333;
      }
      .result-summary {
        text-align: center;
        padding: 20px;
        background: #f0f0f0;
        margin-bottom: 16px;
        border-radius: 6px;
      }
      .result-score {
        font-size: 36px;
        font-weight: 600;
        color: #0066cc;
      }
      .result-item {
        padding: 10px;
        margin: 8px 0;
        border-left: 3px solid #ddd;
        background: #f9f9f9;
        font-size: 13px;
      }
      .result-item.correct {
        border-left-color: #28a745;
        background: #e8f5e9;
      }
      .result-item.incorrect {
        border-left-color: #dc3545;
        background: #ffebee;
      }
      .wrong-item {
        background: #fff3e0;
        padding: 16px;
        margin: 8px 0;
        border-radius: 8px;
        border-left: 4px solid #ff9800;
        display: flex;
        justify-content: space-between;
        align-items: start;
      }
      .wrong-item-content {
        flex: 1;
      }
      .btn-delete {
        background: #dc3545;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
        margin-left: 12px;
      }
      .btn-delete:hover {
        background: #c82333;
      }
      .modal-actions {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }
      .headings-box {
        background: #f9f9f9;
        padding: 12px;
        border: 1px solid #eee;
        border-radius: 4px;
        margin-bottom: 12px;
      }
      .headings-box h5 {
        margin: 0 0 8px;
        font-size: 14px;
        color: #333;
      }
      .headings-box ol {
        margin-left: 20px;
        font-size: 13px;
        line-height: 1.4;
      }
    </style>
  </head>
  <body>
    <div id="timer">00:00</div>
    <div class="shell">
      <section class="pane" id="left">
        <h2>READING PASSAGE 2</h2>
        <p>
          You should spend about 20 minutes on Questions 14‚Äì26, which are based
          on Reading Passage 2 below.
        </p>
        <h3>Intelligent behaviour in birds</h3>
        <p>
          <i
            >Many people are aware of the intelligence of chimpanzees and other
            mammals. However, birds also demonstrate intelligent behaviour.</i
          >
        </p>
        <p>
          <strong>A</strong> For centuries, many scholars maintained that humans
          were the only intelligent organisms on Earth. Many traits were
          considered to be exclusively human examples of acumen ‚Äì for example,
          language, tool use, deception, and awareness of self and others.
          However, exciting new research on a number of animals, particularly
          birds, has called into question the uniqueness of these traits,
          forcing us to reconsider this opinion. In 1964, people were amazed
          when naturalist Jane Goodall first discovered chimpanzees making and
          using tools. But ornithologists, people who study birds, were not
          overly surprised. Almost 20 years earlier, a renowned ornithologist
          had shown that tool use was commonplace in populations of woodpecker
          finches residing on the Gal√°pagos Islands. These tiny birds routinely
          used twigs to extract grubs from under bark.
        </p>
        <p>
          <strong>B</strong> Since then, the catalogue of tool-using animals has
          grown. At least three Australian bird species make tools similar to
          those of the woodpecker finch, and when white-winged choughs come
          across shellfish, they have been known to use rocks as hammers to
          crack open the recalcitrant shells. Other birds show a more
          sophisticated level of insight. For example, black kites have been
          reported dropping bait into lakes to bring fish to the surface of the
          water, thereby making them easier to catch. A kite may also pick up a
          smouldering stick from an area recently burned by a bushfire and drop
          the stick on a patch of unburned grass. The bird then feasts on the
          small animals that flee from the subsequent fire.
        </p>
        <p>
          <strong>C</strong> Most tool-using behaviours are a means of
          extracting food, which may provide a clue as to how the mental
          abilities needed for tool use evolved. The predominant explanation is
          based on the proverb that ‚Äònecessity is the mother of invention‚Äô.
          Essentially, brain tissue is energetically expensive, so animals
          should have evolved only the intellectual capabilities required to
          overcome the challenges they face in their environment. Consider a
          hypothetical duck grazing on a seemingly endless supply of grass.
          Being particularly intelligent will not help the duck eat more grass.
          In contrast, other species, such as birds of prey, live in a more
          challenging environment, where food may be distributed erratically,
          hidden from view or highly mobile. The food itself may be quite
          intelligent. So, if there are not enough resources to feed all
          individuals, then only the smartest in each generation will live and
          reproduce.
        </p>
        <p>
          <strong>D</strong> New Caledonian crows boast many different tools in
          their toolkit. They use a hooked tool made by removing all but one of
          the side branches from a twig. They fashion serrated rakes (using
          their beaks as scissors) from stiff, leathery pandanus leaves. They
          also make probes by modifying their own moulted feathers. Each tool is
          used in slightly different ways to pull grubs from deep within tree
          trunks. The crows carry their favourite tool from one foraging site to
          the next. They also store their tools for later reuse in a secure
          place on their perch. Problem-solving abilities have traditionally
          been thought to be beyond the reach of animals. Nevertheless, birds
          are coming up with innovative solutions all the time. Recently, New
          Caledonian crows were observed moulding a piece of wire, something
          they had never seen before, into a hook and then using it to retrieve
          food.
        </p>
        <p>
          <strong>E</strong> Literally hundreds of such reports have accumulated
          in back copies of scientific journals. Recently, a team of biologists
          from McGill University in Canada collated them and compared the
          frequency and size of innovations with the size of the birds‚Äô
          forebrain (the brain area responsible for higher-order information
          processing) relative to the hindbrain. The team uncovered a clear
          relationship: birds with relatively large forebrains are able to
          invent fresh solutions to ecological challenges, and to exploit the
          discoveries and inventions of others, more often than birds with
          relatively small forebrains.
        </p>
        <p>
          <strong>F</strong> Intelligence in birds may also arise as a result of
          selection to overcome the dynamic challenges of communal living. Since
          this involves competition between group members, to be successful a
          social animal may need to be able to reflect on its own intentions, as
          well as those of others. The consequence of being part of a community
          may be the evolution of a distinctly ‚Äòpolitical‚Äô brain.
        </p>
        <p>
          <strong>G</strong> What better way to exercise a political brain than
          to be deceitful! Perhaps the best example of deception among birds
          comes from the white-winged choughs. Choughs are cooperative breeders
          ‚Äì that is, they form a communal group consisting of one breeding pair
          and up to 15 non-breeding ‚Äòhelpers‚Äô. However, because young choughs
          have so little enthusiasm for foraging, or gathering food, they are
          often too hungry to help. And because it is socially unacceptable to
          be part of a group and provide little help, young choughs often act
          deceptively. For example, when an adult is watching, a young chough
          will place some food in the mouth of a hungry chick but not release
          it. Instead, it waits until the adult departs and then eats the food
          itself. A chough can also help the group by preening the chicks.
          Interestingly, it is more likely to preen the chicks if another bird
          can see it do so. A chough that has been sitting totally still on the
          nest while the rest of the group is foraging out of sight will
          comically spring up and frantically start to preen the chicks as soon
          as some of its group members come into view. It is likely that these
          young choughs are only motivated to help when others are watching
          because they are concerned about their social status. Choughs need
          other choughs to like them, as they cannot breed without them.
        </p>
      </section>
      <div id="divider"></div>
      <section class="pane" id="right">
        <h3>Questions</h3>
        <div class="group">
          <h4>Questions 14‚Äì20</h4>
          <p>Reading Passage 2 has seven paragraphs, A‚ÄìG.</p>
          <p>
            Choose the correct heading for each paragraph from the list of
            headings below.
          </p>
          <div class="headings-box">
            <h5>List of Headings</h5>
            <ol type="i">
              <li>
                The theory linking capacity for tool use in birds and survival
              </li>
              <li>The influence of humans on tool use</li>
              <li>
                The theory linking cognitive ability and living in a society
              </li>
              <li>Reviewing long-held beliefs</li>
              <li>Intelligence helps birds to remember</li>
              <li>How some birds trick each other</li>
              <li>Physiological evidence of birds‚Äô intelligence</li>
              <li>Several examples of birds that use tools</li>
              <li>One species‚Äô multiple tool-using techniques</li>
            </ol>
          </div>
          <ol start="14">
            <li>
              <span class="flag-btn" data-q="q14" style="left: -20px"></span
              >Paragraph A<br />
              <label><input type="radio" name="q14" value="i" /> i</label>
              <label><input type="radio" name="q14" value="ii" /> ii</label>
              <label><input type="radio" name="q14" value="iii" /> iii</label>
              <label><input type="radio" name="q14" value="iv" /> iv</label>
              <label><input type="radio" name="q14" value="v" /> v</label>
              <label><input type="radio" name="q14" value="vi" /> vi</label>
              <label><input type="radio" name="q14" value="vii" /> vii</label>
              <label><input type="radio" name="q14" value="viii" /> viii</label>
              <label><input type="radio" name="q14" value="ix" /> ix</label>
            </li>
            <li>
              <span class="flag-btn" data-q="q15" style="left: -20px"></span
              >Paragraph B<br />
              <label><input type="radio" name="q15" value="i" /> i</label>
              <label><input type="radio" name="q15" value="ii" /> ii</label>
              <label><input type="radio" name="q15" value="iii" /> iii</label>
              <label><input type="radio" name="q15" value="iv" /> iv</label>
              <label><input type="radio" name="q15" value="v" /> v</label>
              <label><input type="radio" name="q15" value="vi" /> vi</label>
              <label><input type="radio" name="q15" value="vii" /> vii</label>
              <label><input type="radio" name="q15" value="viii" /> viii</label>
              <label><input type="radio" name="q15" value="ix" /> ix</label>
            </li>
            <li>
              <span class="flag-btn" data-q="q16" style="left: -20px"></span
              >Paragraph C<br />
              <label><input type="radio" name="q16" value="i" /> i</label>
              <label><input type="radio" name="q16" value="ii" /> ii</label>
              <label><input type="radio" name="q16" value="iii" /> iii</label>
              <label><input type="radio" name="q16" value="iv" /> iv</label>
              <label><input type="radio" name="q16" value="v" /> v</label>
              <label><input type="radio" name="q16" value="vi" /> vi</label>
              <label><input type="radio" name="q16" value="vii" /> vii</label>
              <label><input type="radio" name="q16" value="viii" /> viii</label>
              <label><input type="radio" name="q16" value="ix" /> ix</label>
            </li>
            <li>
              <span class="flag-btn" data-q="q17" style="left: -20px"></span
              >Paragraph D<br />
              <label><input type="radio" name="q17" value="i" /> i</label>
              <label><input type="radio" name="q17" value="ii" /> ii</label>
              <label><input type="radio" name="q17" value="iii" /> iii</label>
              <label><input type="radio" name="q17" value="iv" /> iv</label>
              <label><input type="radio" name="q17" value="v" /> v</label>
              <label><input type="radio" name="q17" value="vi" /> vi</label>
              <label><input type="radio" name="q17" value="vii" /> vii</label>
              <label><input type="radio" name="q17" value="viii" /> viii</label>
              <label><input type="radio" name="q17" value="ix" /> ix</label>
            </li>
            <li>
              <span class="flag-btn" data-q="q18" style="left: -20px"></span
              >Paragraph E<br />
              <label><input type="radio" name="q18" value="i" /> i</label>
              <label><input type="radio" name="q18" value="ii" /> ii</label>
              <label><input type="radio" name="q18" value="iii" /> iii</label>
              <label><input type="radio" name="q18" value="iv" /> iv</label>
              <label><input type="radio" name="q18" value="v" /> v</label>
              <label><input type="radio" name="q18" value="vi" /> vi</label>
              <label><input type="radio" name="q18" value="vii" /> vii</label>
              <label><input type="radio" name="q18" value="viii" /> viii</label>
              <label><input type="radio" name="q18" value="ix" /> ix</label>
            </li>
            <li>
              <span class="flag-btn" data-q="q19" style="left: -20px"></span
              >Paragraph F<br />
              <label><input type="radio" name="q19" value="i" /> i</label>
              <label><input type="radio" name="q19" value="ii" /> ii</label>
              <label><input type="radio" name="q19" value="iii" /> iii</label>
              <label><input type="radio" name="q19" value="iv" /> iv</label>
              <label><input type="radio" name="q19" value="v" /> v</label>
              <label><input type="radio" name="q19" value="vi" /> vi</label>
              <label><input type="radio" name="q19" value="vii" /> vii</label>
              <label><input type="radio" name="q19" value="viii" /> viii</label>
              <label><input type="radio" name="q19" value="ix" /> ix</label>
            </li>
            <li>
              <span class="flag-btn" data-q="q20" style="left: -20px"></span
              >Paragraph G<br />
              <label><input type="radio" name="q20" value="i" /> i</label>
              <label><input type="radio" name="q20" value="ii" /> ii</label>
              <label><input type="radio" name="q20" value="iii" /> iii</label>
              <label><input type="radio" name="q20" value="iv" /> iv</label>
              <label><input type="radio" name="q20" value="v" /> v</label>
              <label><input type="radio" name="q20" value="vi" /> vi</label>
              <label><input type="radio" name="q20" value="vii" /> vii</label>
              <label><input type="radio" name="q20" value="viii" /> viii</label>
              <label><input type="radio" name="q20" value="ix" /> ix</label>
            </li>
          </ol>
        </div>
        <div class="group">
          <h4>Questions 21‚Äì26</h4>
          <p>
            Match each characteristic with the correct bird,
            <strong>A, B or C</strong>.
          </p>
          <div class="headings-box">
            <h5>List of Birds</h5>
            <div style="margin-left: 10px">
              <strong>A</strong> White-winged choughs<br />
              <strong>B</strong> Black kites<br />
              <strong>C</strong> New Caledonian crows
            </div>
          </div>
          <ol start="21">
            <li>
              <span class="flag-btn" data-q="q21" style="left: -20px"></span
              >keeping tools that they like to use<br />
              <label><input type="radio" name="q21" value="A" /> A</label>
              <label><input type="radio" name="q21" value="B" /> B</label>
              <label><input type="radio" name="q21" value="C" /> C</label>
            </li>
            <li>
              <span class="flag-btn" data-q="q22" style="left: -20px"></span
              >drawing out their prey by frightening it<br />
              <label><input type="radio" name="q22" value="A" /> A</label>
              <label><input type="radio" name="q22" value="B" /> B</label>
              <label><input type="radio" name="q22" value="C" /> C</label>
            </li>
            <li>
              <span class="flag-btn" data-q="q23" style="left: -20px"></span>the
              use of tools to remove the outer covering from food<br />
              <label><input type="radio" name="q23" value="A" /> A</label>
              <label><input type="radio" name="q23" value="B" /> B</label>
              <label><input type="radio" name="q23" value="C" /> C</label>
            </li>
            <li>
              <span class="flag-btn" data-q="q24" style="left: -20px"></span
              >using food to attract their prey<br />
              <label><input type="radio" name="q24" value="A" /> A</label>
              <label><input type="radio" name="q24" value="B" /> B</label>
              <label><input type="radio" name="q24" value="C" /> C</label>
            </li>
            <li>
              <span class="flag-btn" data-q="q25" style="left: -20px"></span>the
              use of unfamiliar materials to make tools<br />
              <label><input type="radio" name="q25" value="A" /> A</label>
              <label><input type="radio" name="q25" value="B" /> B</label>
              <label><input type="radio" name="q25" value="C" /> C</label>
            </li>
            <li>
              <span class="flag-btn" data-q="q26" style="left: -20px"></span
              >engaging in certain activities for the benefit of observers<br />
              <label><input type="radio" name="q26" value="A" /> A</label>
              <label><input type="radio" name="q26" value="B" /> B</label>
              <label><input type="radio" name="q26" value="C" /> C</label>
            </li>
          </ol>
        </div>
        <div class="bottom-bar">
          <button class="btn-primary" onclick="submitAnswers()">Êèê‰∫§</button>
          <button onclick="resetForm()">ÈáçÁΩÆ</button>
          <button onclick="openWrongBook()">Êú¨ÁØáÈîôÈ¢ò</button>
        </div>
      </section>
    </div>
    <div id="selbar">
      <button id="btnNote">Note</button>
      <button id="btnHL">Highlight</button>
      <button id="btnUH" style="display: none">Clear Highlight</button>
    </div>
    <div class="modal" id="resultModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>ÊàêÁª©</h2>
          <span class="modal-close" onclick="closeModal('resultModal')">√ó</span>
        </div>
        <div id="resultContent"></div>
        <button
          class="btn-primary"
          style="width: 100%; margin-top: 16px"
          onclick="addWrongToBook()"
        >
          Âä†ÂÖ•ÈîôÈ¢òÊú¨
        </button>
      </div>
    </div>
    <div class="modal" id="wrongBookModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Êú¨ÁØáÈîôÈ¢ò</h2>
          <span class="modal-close" onclick="closeModal('wrongBookModal')"
            >√ó</span
          >
        </div>
        <div id="wrongBookContent"></div>
      </div>
    </div>
    <div class="modal" id="resetModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>ÈáçÁΩÆÁªÉ‰π†</h2>
          <span class="modal-close" onclick="closeModal('resetModal')">√ó</span>
        </div>
        <div style="margin: 16px 0">
          <label style="display: block; margin-bottom: 10px"
            ><input type="radio" name="resetType" value="answers" checked />
            Âè™Ê∏ÖÁ©∫Á≠îÊ°à</label
          >
          <label style="display: block"
            ><input type="radio" name="resetType" value="all" />
            Ê∏ÖÁ©∫Á≠îÊ°àÂíåÊ†áËÆ∞</label
          >
        </div>
        <button
          class="btn-primary"
          style="width: 100%"
          onclick="confirmReset()"
        >
          Á°ÆÂÆö
        </button>
      </div>
    </div>
    <script>
      const PAPER_ID = "P2_INTELLIGENT_BIRDS";
      let t = 0;
      const timerEl = document.getElementById("timer");
      setInterval(() => {
        t++;
        timerEl.textContent =
          String(Math.floor(t / 60)).padStart(2, "0") +
          ":" +
          String(t % 60).padStart(2, "0");
      }, 1000);
      const divider = document.getElementById("divider"),
        left = document.getElementById("left"),
        right = document.getElementById("right");
      let dragging = false;
      divider.onmousedown = () => {
        dragging = true;
        document.body.style.cursor = "ew-resize";
      };
      window.onmousemove = (e) => {
        if (!dragging) return;
        const c = document.querySelector(".shell").getBoundingClientRect();
        let x = e.clientX - c.left;
        x = Math.max(280, Math.min(c.width - 280, x));
        left.style.flex = "0 0 " + x + "px";
        right.style.flex = "1 1 auto";
      };
      window.onmouseup = () => {
        dragging = false;
        document.body.style.cursor = "";
      };
      const selbar = document.getElementById("selbar"),
        btnHL = document.getElementById("btnHL"),
        btnUH = document.getElementById("btnUH"),
        btnNote = document.getElementById("btnNote");
      let lastRange = null,
        currentHlNode = null;
      function posSelbar(r) {
        selbar.style.display = "flex";
        const t = window.scrollY + r.top - selbar.offsetHeight - 8;
        const l =
          window.scrollX + r.left + r.width / 2 - selbar.offsetWidth / 2;
        selbar.style.top = (t > 0 ? t : window.scrollY + r.bottom + 8) + "px";
        selbar.style.left = Math.max(8, l) + "px";
      }
      function updSel() {
        const s = window.getSelection();
        if (!s || s.rangeCount === 0 || s.isCollapsed) {
          if (!currentHlNode) selbar.style.display = "none";
          return;
        }
        const r = s.getRangeAt(0);
        lastRange = r.cloneRange();
        currentHlNode = null;
        btnNote.style.display = "block";
        btnHL.style.display = "block";
        btnUH.style.display = "none";
        posSelbar(r.getBoundingClientRect());
      }
      left.onmouseup = updSel;
      right.onmouseup = updSel;
      document.onselectionchange = () => {
        const s = window.getSelection();
        if ((!s || s.rangeCount === 0 || s.isCollapsed) && !currentHlNode)
          selbar.style.display = "none";
      };
      document.addEventListener(
        "click",
        (e) => {
          if (
            e.target.classList &&
            (e.target.classList.contains("hl") ||
              e.target.classList.contains("note"))
          ) {
            currentHlNode = e.target;
            lastRange = null;
            btnNote.style.display = "none";
            btnHL.style.display = "none";
            btnUH.style.display = "block";
            posSelbar(e.target.getBoundingClientRect());
            const s = window.getSelection();
            if (s) s.removeAllRanges();
          }
        },
        true
      );
      btnHL.onclick = () => {
        if (currentHlNode || !lastRange || lastRange.collapsed) return;
        const s = document.createElement("span");
        s.className = "hl";
        try {
          lastRange.surroundContents(s);
        } catch (e) {
          const w = document.createElement("span");
          w.className = "hl";
          w.appendChild(lastRange.cloneContents());
          lastRange.deleteContents();
          lastRange.insertNode(w);
        }
        selbar.style.display = "none";
        saveHighlights();
      };
      btnNote.onclick = () => {
        if (currentHlNode || !lastRange || lastRange.collapsed) return;
        const s = document.createElement("span");
        s.className = "note";
        try {
          lastRange.surroundContents(s);
        } catch (e) {
          const w = document.createElement("span");
          w.className = "note";
          w.appendChild(lastRange.cloneContents());
          lastRange.deleteContents();
          lastRange.insertNode(w);
        }
        selbar.style.display = "none";
        saveHighlights();
      };
      btnUH.onclick = () => {
        if (currentHlNode) {
          const p = currentHlNode.parentNode;
          while (currentHlNode.firstChild)
            p.insertBefore(currentHlNode.firstChild, currentHlNode);
          p.removeChild(currentHlNode);
          p.normalize();
          currentHlNode = null;
          selbar.style.display = "none";
          saveHighlights();
        } else if (lastRange) {
          const sR = lastRange.getBoundingClientRect();
          const w = document.createTreeWalker(
            document.body,
            NodeFilter.SHOW_ELEMENT
          );
          const tr = [];
          while (w.nextNode()) {
            const n = w.currentNode;
            if (
              n.classList &&
              (n.classList.contains("hl") || n.classList.contains("note"))
            ) {
              const r = n.getBoundingClientRect();
              if (
                !(
                  r.right < sR.left ||
                  r.left > sR.right ||
                  r.bottom < sR.top ||
                  r.top > sR.bottom
                )
              )
                tr.push(n);
            }
          }
          tr.forEach((el) => {
            const p = el.parentNode;
            while (el.firstChild) p.insertBefore(el.firstChild, el);
            p.removeChild(el);
            p.normalize();
          });
          selbar.style.display = "none";
          saveHighlights();
        }
      };
      document.querySelectorAll(".flag-btn").forEach((btn) => {
        btn.onclick = (e) => {
          e.stopPropagation();
          btn.classList.toggle("active");
          saveFlags();
        };
      });
      const answerKey = {
        q14: "iv",
        q15: "viii",
        q16: "i",
        q17: "ix",
        q18: "vii",
        q19: "iii",
        q20: "vi",
        q21: "C",
        q22: "B",
        q23: "A",
        q24: "B",
        q25: "C",
        q26: "A",
      };
      let lastResults = [];
      function saveAnswers() {
        const data = {};
        Object.keys(answerKey).forEach((q) => {
          const radio = document.querySelector(
            `input[name="${q}"][type="radio"]:checked`
          );
          const text = document.querySelector(
            `input[name="${q}"][type="text"]`
          );
          if (radio) data[q] = radio.value;
          else if (text) data[q] = text.value;
        });
        localStorage.setItem(`${PAPER_ID}_answers`, JSON.stringify(data));
      }
      function loadAnswers() {
        const data = JSON.parse(
          localStorage.getItem(`${PAPER_ID}_answers`) || "{}"
        );
        Object.keys(data).forEach((q) => {
          const radio = document.querySelector(
            `input[name="${q}"][value="${data[q]}"]`
          );
          const text = document.querySelector(
            `input[name="${q}"][type="text"]`
          );
          if (radio) radio.checked = true;
          else if (text) text.value = data[q];
        });
      }
      function saveFlags() {
        const flags = [...document.querySelectorAll(".flag-btn.active")].map(
          (b) => b.dataset.q
        );
        localStorage.setItem(`${PAPER_ID}_flags`, JSON.stringify(flags));
      }
      function loadFlags() {
        const flags = JSON.parse(
          localStorage.getItem(`${PAPER_ID}_flags`) || "[]"
        );
        flags.forEach((q) =>
          document.querySelector(`[data-q="${q}"]`)?.classList.add("active")
        );
      }
      function saveHighlights() {
        const highlights = { left: [], right: [] };
        document
          .querySelectorAll("#left .hl, #left .note")
          .forEach((el, idx) => {
            highlights.left.push({
              type: el.classList.contains("hl") ? "hl" : "note",
              text: el.textContent,
              index: idx,
            });
          });
        document
          .querySelectorAll("#right .hl, #right .note")
          .forEach((el, idx) => {
            highlights.right.push({
              type: el.classList.contains("hl") ? "hl" : "note",
              text: el.textContent,
              index: idx,
            });
          });
        localStorage.setItem(
          `${PAPER_ID}_highlights`,
          JSON.stringify(highlights)
        );
      }
      function loadHighlights() {
        const data = JSON.parse(
          localStorage.getItem(`${PAPER_ID}_highlights`) ||
            '{"left":[],"right":[]}'
        );
        const restore = (pane, items) => {
          if (!items || items.length === 0) return;
          items.forEach((item) => {
            const walker = document.createTreeWalker(
              pane,
              NodeFilter.SHOW_TEXT
            );
            let node;
            while ((node = walker.nextNode())) {
              if (node.textContent.includes(item.text)) {
                const span = document.createElement("span");
                span.className = item.type;
                const parent = node.parentNode;
                const text = node.textContent;
                const idx = text.indexOf(item.text);
                if (idx >= 0) {
                  const before = text.substring(0, idx);
                  const match = text.substring(idx, idx + item.text.length);
                  const after = text.substring(idx + item.text.length);
                  parent.insertBefore(document.createTextNode(before), node);
                  span.textContent = match;
                  parent.insertBefore(span, node);
                  parent.insertBefore(document.createTextNode(after), node);
                  parent.removeChild(node);
                  break;
                }
              }
            }
          });
        };
        restore(left, data.left);
        restore(right, data.right);
      }
      document.querySelectorAll("input").forEach((inp) => {
        inp.addEventListener("change", saveAnswers);
        if (inp.type === "text") inp.addEventListener("input", saveAnswers);
      });
      document.addEventListener("DOMContentLoaded", () => {
        loadAnswers();
        loadFlags();
        loadHighlights();
      });
      function submitAnswers() {
        const res = [];
        let cor = 0;
        Object.keys(answerKey).forEach((q) => {
          let uA = "";
          const radio = document.querySelector(
            `input[name="${q}"][type="radio"]:checked`
          );
          const text = document.querySelector(
            `input[name="${q}"][type="text"]`
          );
          if (radio) uA = radio.value;
          else if (text) uA = text.value.trim();
          const cA = answerKey[q];
          const iC = uA.toLowerCase() === cA.toLowerCase();
          if (iC) cor++;
          res.push({ id: q, userAns: uA, correctAns: cA, isCorrect: iC });
        });
        lastResults = res;
        const tot = Object.keys(answerKey).length;
        const pct = ((cor / tot) * 100).toFixed(1);
        localStorage.setItem(`ielts_score_${PAPER_ID}`, `${cor}/${tot}`);
        document.getElementById(
          "resultContent"
        ).innerHTML = `<div class="result-summary"><div class="result-score">${cor} / ${tot}</div><div style="margin-top:8px;font-size:18px;">${pct}%</div></div>${res
          .map(
            (r) =>
              `<div class="result-item ${
                r.isCorrect ? "correct" : "incorrect"
              }"><div><strong>${r.id}</strong> ${
                r.isCorrect ? "‚úì" : "‚úó"
              }</div><div>‰Ω†ÁöÑÁ≠îÊ°à: ${r.userAns || "(Êú™‰ΩúÁ≠î)"}</div>${
                !r.isCorrect ? `<div>Ê≠£Á°ÆÁ≠îÊ°à: ${r.correctAns}</div>` : ""
              }</div>`
          )
          .join("")}`;
        document.getElementById("resultModal").classList.add("active");
      }
      function resetForm() {
        document.getElementById("resetModal").classList.add("active");
      }
      function confirmReset() {
        const tp = document.querySelector(
          'input[name="resetType"]:checked'
        ).value;
        document.querySelectorAll("input").forEach((i) => {
          if (i.type === "radio") i.checked = false;
          if (i.type === "text") i.value = "";
        });
        localStorage.removeItem(`${PAPER_ID}_answers`);
        if (tp === "all") {
          document.querySelectorAll(".hl").forEach((el) => {
            const p = el.parentNode;
            while (el.firstChild) p.insertBefore(el.firstChild, el);
            p.removeChild(el);
            p.normalize();
          });
          document.querySelectorAll(".note").forEach((el) => {
            const p = el.parentNode;
            while (el.firstChild) p.insertBefore(el.firstChild, el);
            p.removeChild(el);
            p.normalize();
          });
          document
            .querySelectorAll(".flag-btn")
            .forEach((b) => b.classList.remove("active"));
          localStorage.removeItem(`${PAPER_ID}_highlights`);
          localStorage.removeItem(`${PAPER_ID}_flags`);
        }
        closeModal("resetModal");
      }
      function addWrongToBook() {
        const wb = JSON.parse(localStorage.getItem("ielts_wrong_book") || "[]");
        const wr = lastResults.filter((r) => !r.isCorrect);
        wr.forEach((r) => {
          const en = {
            paperId: PAPER_ID,
            title: "Intelligent behaviour in birds",
            questionId: r.id,
            correctAnswer: r.correctAns,
            myAnswer: r.userAns || "(Êú™‰ΩúÁ≠î)",
            date: new Date().toISOString().split("T")[0],
          };
          const ix = wb.findIndex(
            (i) => i.paperId === en.paperId && i.questionId === en.questionId
          );
          if (ix >= 0) wb[ix] = en;
          else wb.push(en);
        });
        localStorage.setItem("ielts_wrong_book", JSON.stringify(wb));
        alert(`Â∑≤Ê∑ªÂä† ${wr.length} ÈÅìÈîôÈ¢ò`);
        closeModal("resultModal");
      }
      function deleteWrongItem(pId, qId) {
        if (!confirm("Á°ÆÂÆöÂà†Èô§ËøôÈÅìÈîôÈ¢òÔºü")) return;
        let wb = JSON.parse(localStorage.getItem("ielts_wrong_book") || "[]");
        wb = wb.filter((i) => !(i.paperId === pId && i.questionId === qId));
        localStorage.setItem("ielts_wrong_book", JSON.stringify(wb));
        openWrongBook();
      }
      function clearCurrentWrongBook() {
        if (!confirm("Á°ÆÂÆöÊ∏ÖÁ©∫Êú¨ÁØáÊâÄÊúâÈîôÈ¢òÔºü")) return;
        let wb = JSON.parse(localStorage.getItem("ielts_wrong_book") || "[]");
        wb = wb.filter((i) => i.paperId !== PAPER_ID);
        localStorage.setItem("ielts_wrong_book", JSON.stringify(wb));
        openWrongBook();
      }
      function openWrongBook() {
        const wb = JSON.parse(localStorage.getItem("ielts_wrong_book") || "[]");
        const cu = wb.filter((i) => i.paperId === PAPER_ID);
        const ct = document.getElementById("wrongBookContent");
        if (cu.length === 0)
          ct.innerHTML =
            '<div style="text-align:center;padding:40px;color:#666;">ÊöÇÊó†ÈîôÈ¢ò</div>';
        else
          ct.innerHTML = `<div class="modal-actions"><button class="btn-danger" onclick="clearCurrentWrongBook()" stylewidth:100%;">üóëÔ∏è Ê∏ÖÁ©∫Êú¨ÁØáÈîôÈ¢ò</button></div>${cu
            .map(
              (i) =>
                `<div class="wrong-item"><div class="wrong-item-content"><div style="font-weight:600;margin-bottom:8px;">${i.questionId}</div><div style="font-size:13px;color:#666;"><div>‚úì Ê≠£Á°Æ: ${i.correctAnswer}</div><div style="color:#d32f2f;">‚úó ÊàëÁöÑ: ${i.myAnswer}</div></div></div><button class="btn-delete" onclick="deleteWrongItem('${i.paperId}','${i.questionId}')">Âà†Èô§</button></div>`
            )
            .join("")}`;
        document.getElementById("wrongBookModal").classList.add("active");
      }
      function closeModal(id) {
        document.getElementById(id).classList.remove("active");
      }
    </script>
  </body>
</html>
