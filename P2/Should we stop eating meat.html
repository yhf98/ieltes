<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>P2 ‚Äì Should we stop eating meat?</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  * { box-sizing: border-box; margin:0; padding:0; }
  html,body { height:100%; }
  body { font-family: Arial, sans-serif; background:#f5f5f5; }
  
  #timer { position:fixed; top:12px; right:12px; background:#fff; border:1px solid #ddd; border-radius:6px; padding:8px 12px; font-size:16px; font-weight:600; color:#0066cc; z-index:1000; }
  
  .shell { display:flex; height:100vh; width:100%; }
  .pane { background:#fff; overflow:auto; padding:24px; }
  #left { flex: 0 0 50%; border-right:1px solid #ddd; }
  #right { flex: 1 1 auto; background:#fafafa; }
  #divider { flex: 0 0 5px; background:#ddd; cursor: ew-resize; }
  #divider:hover { background:#999; }
  
  h2,h3,h4 { margin:0 0 12px; color:#333; }
  h2 { font-size:20px; }
  h3 { font-size:18px; color:#0066cc; }
  h4 { font-size:15px; font-weight:600; margin-top:20px; }
  
  #left p { margin: 0 0 14px; line-height: 1.7; text-align:justify; }
  
  .group { background:#fff; border:1px solid #ddd; border-radius:6px; padding:16px; margin-bottom:16px; }
  .group h4 { margin-top:0; color:#0066cc; }
  .group p { margin:8px 0; font-size:14px; line-height:1.6; }
  
  .headings { background:#f9f9f9; padding:12px; margin:12px 0; border-radius:4px; }
  .headings ol { margin-left:20px; }
  .headings li { margin:4px 0; font-size:13px; }
  
  /* Input Styles */
  .input-text { border:none; border-bottom:1px solid #333; background:#f0f8ff; width:140px; text-align:center; font-size:14px; color:#0066cc; outline:none; padding:2px 4px; border-radius:3px; }
  .input-text:focus { background:#e1f0ff; border-bottom:2px solid #0066cc; }

  .flag-btn { 
    position:absolute; 
    left:2px; 
    top:50%;
    transform:translateY(-50%);
    width:8px;
    height:8px;
    border-radius:50%;
    background:#ddd;
    cursor:pointer;
    z-index:10;
  }
  .flag-btn:hover { background:#999; }
  .flag-btn.active { background:#ff5722; }
  /* Inline flag for summary */
  .flag-inline { position:relative; display:inline-block; margin-left:5px; top:0; transform:none; }

  .group ol { margin-left:20px; }
  .group ol li { margin:12px 0; font-size:14px; line-height:1.6; position:relative; }
  .group ol li label { display:inline-block; margin-right:8px; cursor: pointer; }
  
  .bottom-bar { display:flex; gap:10px; margin-top:16px; }
  button { padding:10px 20px; border:1px solid #999; border-radius:6px; background:#fff; cursor:pointer; font-size:14px; }
  button:hover { background:#f0f0f0; }
  .btn-primary { background:#0066cc; color:#fff; border-color:#0066cc; }
  .btn-primary:hover { background:#0052a3; }
  .btn-danger { background:#dc3545; color:#fff; border-color:#dc3545; }
  .btn-danger:hover { background:#c82333; }
  
  .hl { background:#fff59d; cursor:pointer; }
  .hl:hover { background:#ffeb3b; }
  .note { background:#b3d9ff; cursor:pointer; }
  .note:hover { background:#99ccff; }
  
  #selbar { position:fixed; display:none; z-index:2000; background:#fff; border:1px solid #ddd; border-radius:8px; padding:8px; gap:0; box-shadow:0 2px 8px rgba(0,0,0,0.15); flex-direction:column; min-width:120px; }
  #selbar button { background:#fff; color:#666; border:none; padding:3px 0px; cursor:pointer; font-size:14px; text-align:center; border-radius:4px; }
  #selbar button:hover { background:#f5f5f5; color:#333; }
  
  .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:3000; align-items:center; justify-content:center; }
  .modal.active { display:flex; }
  .modal-content { background:#fff; border-radius:8px; padding:24px; max-width:600px; width:90%; max-height:80vh; overflow-y:auto; }
  
  .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
  .modal-header h2 { font-size: 28px; color: #333; margin: 0; }
  .modal-close { font-size: 32px; cursor: pointer; color: #999; line-height: 1; }
  .modal-close:hover { color: #333; }
  
  .result-summary { text-align:center; padding:20px; background:#f0f0f0; margin-bottom:16px; border-radius:6px; }
  .result-score { font-size:36px; font-weight:600; color:#0066cc; }
  .result-item { padding:10px; margin:8px 0; border-left:3px solid #ddd; background:#f9f9f9; font-size:13px; }
  .result-item.correct { border-left-color:#28a745; background:#e8f5e9; }
  .result-item.incorrect { border-left-color:#dc3545; background:#ffebee; }
  
  .wrong-item { background:#fff3e0; padding:16px; margin:8px 0; border-radius:8px; border-left:4px solid #ff9800; display:flex; justify-content:space-between; align-items:start; }
  .wrong-item-content { flex:1; }
  .btn-delete { background:#dc3545; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-size:13px; margin-left:12px; }
  .btn-delete:hover { background:#c82333; }
  .modal-actions { display:flex; gap:10px; margin-bottom:20px; }
</style>
</head>
<body>
<div id="timer">00:00</div>

<div class="shell">
  <section class="pane" id="left">
    
<h2>READING PASSAGE 2</h2>
<p>You should spend about 20 minutes on Questions 14‚Äì26, which are based on Reading Passage 2 below.</p>
<h3>Should we stop eating meat?</h3>
<p><em>Some claim that it‚Äôs the only way to save our planet from disaster. But is it really that simple?</em></p>

<h4>Paragraph A</h4>
<p>The call for people to eat less meat to save the planet is growing louder, so if less is good, wouldn‚Äôt none be better? To find out, let‚Äôs imagine what would happen if the world eliminated meat, milk and eggs from its diet, then trace the effects. Last year the world consumed 289 million tonnes of meat, 700 million tonnes of milk and 1.2 billion eggs. Environmentally speaking, this came at an enormous cost.</p>

<h4>Paragraph B</h4>
<p>All agriculture damages the environment. Take for example the felled forests and the common use of irrigation systems. And it may surprise you to know that agriculture creates more greenhouse gases than all methods of transport put together. Livestock farming does the most damage. In part, that is because most livestock eat grain that could be used to feed human populations, and farmers are forced to grow more than we would otherwise need to meet the demand. Altogether, if we switched to a vegan diet, meaning no meat, dairy or eggs, the land currently required for crops would drop by an estimated 21 per cent, about 3.4 million hectares, roughly the size of India.</p>

<h4>Paragraph C</h4>
<p>One environmental impact that would also lessen through a reduction in animal farming would be that of the nitrogen emitted from agricultural processes, which spreads into both waterways and land. According to environmental scientist Allison Leach, if everyone eliminated dairy products and eggs, this kind of pollution would fall by 60%. Livestock production has another serious environmental impact. Global statistics are hard to come by, but in the US at least, livestock account for 55% of erosion, mostly from forests being cut down to make way for grazing land. On top of this, half of all antibiotics manufactured are fed to livestock as part of their normal diet, a practice that is leading to drug-resistant bacteria.</p>

<h4>Paragraph D</h4>
<p>A meat-free world, then would be greener in many ways. However, if everyone opted to give up meat there would be significant costs too. For most of human history, livestock grazed on land that wasn‚Äôt suitable for ploughing, and in doing so they converted inedible grass into edible meat and milk. Even today, a flock of sheep or goats can be the most efficient way to get food from marginal land. In a world in which over a billion people do not have enough to eat, using this land for crop production would contribute to food insecurity.</p>

<h4>Paragraph E</h4>
<p>In some parts of the world today, livestock like chickens, for instance, can subsist on leftovers and whatever they find. Tara Garnett, who heads the Food Climate Research Network at the University of Surrey, points out the usefulness of these animals. By giving them your leftovers, she says, they deal with your rubbish, and you get meat. Garnett admits, though, that if this kind of approach were generally adopted, it would require a major adjustment in food preferences; people would have to get used to chicken, for example, with less fat.</p>

<h4>Paragraph F</h4>
<p>Another downside to a meat-free world would be the disappearance of animal by-products. Such a world would have to replace the 11 million tonnes of leather and 2 million tonnes of wool that come annually from livestock farming and which are turned into clothing. Furthermore, even ardent vegetarians acknowledge that dairy products and meat may be a good thing in poorer countries. ‚ÄòWhilst there‚Äôs no doubt that considerable reduction of meat consumption would have an environmental benefit, we do have to be careful about saying it would be the best solution if the whole world went vegetarian,‚Äô says Annette Pinner, chief executive of the UK Vegetarian Society. For many of the world‚Äôs poorest rural residents, an animal may represent their only realistic hope for a little extra income, and a little animal protein can make a big difference to a marginal diet.</p>

<h4>Paragraph G</h4>
<p>What if we decided on a no-meat vegetarian diet, rather than a vegan diet? After all, milk and eggs are very efficient ways of producing animal calories. ‚ÄòIt‚Äôs difficult to switch to a no-meat-but-milk diet,‚Äô says Helmut Haberl, a social ecologist. ‚ÄòDairy cows must calve every year to keep producing milk, and only half their offspring will be female. While many vegetarians see moral reasons not to kill and eat the males, there is surely no practical reason to waste so much meat.‚Äô Similar arguments apply to chickens kept for eggs.</p>

<h4>Paragraph H</h4>
<p>So even though a meat-free world sounds good on paper, it is likely that a utopian future will still have some animal products in it. The real questions, then, are how much meat do we want, and how will we produce it? The answers depend on how you approach these questions. The most straightforward approach is to assume that the world will continue to want evermore meat. The United Nations‚Äô best guess is that by 2050, the world will need to more than double its production of meat, an increase that would be environmentally disastrous.</p>

<h4>Paragraph I</h4>
<p>Under this scenario the goal will have to be producing the most meat at the lowest environmental cost. According to Walter Falcon, an agricultural economist, this means fewer free range cattle and sheep in green fields. ‚ÄòIf you‚Äôre going to keep some livestock systems, I think the ones you‚Äôll want to keep are the intensive ones,‚Äô he says. Of course this does not take into account animal welfare issues, as intensive farming usually means poor living conditions and the use of growth hormones.</p>

  </section>

  <div id="divider" title="Drag to resize"></div>

  <section class="pane" id="right">
    <h3>Questions</h3>

    <div class="group">
      <h4>Questions 14‚Äì17</h4>
      <p>Reading Passage 2 has nine paragraphs, A‚ÄìI.</p>
      <p>Which paragraph contains the following information?</p>
      <p>Write the correct letter, <strong>A‚ÄìI</strong>, in boxes <strong>14‚Äì17</strong> on your answer sheet.</p>

      <ol start="14">
        <li><span class="flag-btn" data-q="q14" style="left:-20px;"></span>the suggestion that people may need to adapt to a different quality of meat<br>
          <label><input type="radio" name="q14" value="A"> A</label>
          <label><input type="radio" name="q14" value="B"> B</label>
          <label><input type="radio" name="q14" value="C"> C</label>
          <label><input type="radio" name="q14" value="D"> D</label>
          <label><input type="radio" name="q14" value="E"> E</label>
          <label><input type="radio" name="q14" value="F"> F</label>
          <label><input type="radio" name="q14" value="G"> G</label>
          <label><input type="radio" name="q14" value="H"> H</label>
          <label><input type="radio" name="q14" value="I"> I</label>
        </li>
        <li><span class="flag-btn" data-q="q15" style="left:-20px;"></span>a description of the way animals were fed in the past<br>
          <label><input type="radio" name="q15" value="A"> A</label>
          <label><input type="radio" name="q15" value="B"> B</label>
          <label><input type="radio" name="q15" value="C"> C</label>
          <label><input type="radio" name="q15" value="D"> D</label>
          <label><input type="radio" name="q15" value="E"> E</label>
          <label><input type="radio" name="q15" value="F"> F</label>
          <label><input type="radio" name="q15" value="G"> G</label>
          <label><input type="radio" name="q15" value="H"> H</label>
          <label><input type="radio" name="q15" value="I"> I</label>
        </li>
        <li><span class="flag-btn" data-q="q16" style="left:-20px;"></span>a prediction in regard to human demand for meat<br>
          <label><input type="radio" name="q16" value="A"> A</label>
          <label><input type="radio" name="q16" value="B"> B</label>
          <label><input type="radio" name="q16" value="C"> C</label>
          <label><input type="radio" name="q16" value="D"> D</label>
          <label><input type="radio" name="q16" value="E"> E</label>
          <label><input type="radio" name="q16" value="F"> F</label>
          <label><input type="radio" name="q16" value="G"> G</label>
          <label><input type="radio" name="q16" value="H"> H</label>
          <label><input type="radio" name="q16" value="I"> I</label>
        </li>
        <li><span class="flag-btn" data-q="q17" style="left:-20px;"></span>the potential consequences of a meat-free world for textile industries<br>
          <label><input type="radio" name="q17" value="A"> A</label>
          <label><input type="radio" name="q17" value="B"> B</label>
          <label><input type="radio" name="q17" value="C"> C</label>
          <label><input type="radio" name="q17" value="D"> D</label>
          <label><input type="radio" name="q17" value="E"> E</label>
          <label><input type="radio" name="q17" value="F"> F</label>
          <label><input type="radio" name="q17" value="G"> G</label>
          <label><input type="radio" name="q17" value="H"> H</label>
          <label><input type="radio" name="q17" value="I"> I</label>
        </li>
      </ol>
    </div>

    <div class="group">
      <h4>Questions 18‚Äì22</h4>
      <p>Complete the summary below.</p>
      <p>Choose <strong>ONE WORD ONLY</strong> from the passage for each answer.</p>
      <p>Write your answers in boxes <strong>18‚Äì22</strong> on your answer sheet.</p>
      
      <div style="background:#f9f9f9; padding:15px; border-radius:4px; line-height:2.2;">
        <strong>How does agriculture damage the environment?</strong><br>
        <p>Agriculture causes significant harm to the environment in a number of ways, including the frequent use of <strong>18</strong> <input type="text" class="input-text" data-q="q18"> <span class="flag-btn flag-inline" data-q="q18"></span> in modern farming and the cutting down of trees. It is also responsible for the production of many greenhouse gases, more so than <strong>19</strong> <input type="text" class="input-text" data-q="q19"> <span class="flag-btn flag-inline" data-q="q19"></span> is. However, it is livestock farming in particular that is most harmful, because cows, chickens and sheep, for example, are given vast quantities of grain which could be consumed by people instead. A meat-free diet would mean that actually less <strong>20</strong> <input type="text" class="input-text" data-q="q20"> <span class="flag-btn flag-inline" data-q="q20"></span> could be used for crops. Far less chemical pollution, specifically in the form of <strong>21</strong> <input type="text" class="input-text" data-q="q21"> <span class="flag-btn flag-inline" data-q="q21"></span>, would also be released into the environment, especially if consumers cut out dairy and egg products as well as meat. In the US, there is clear evidence that considerable <strong>22</strong> <input type="text" class="input-text" data-q="q22"> <span class="flag-btn flag-inline" data-q="q22"></span> is caused by the demand for grazing land, although there is no information on this from other countries.</p>
      </div>
    </div>

    <div class="group">
      <h4>Questions 23‚Äì26</h4>
      <p>Look at the following statements (Questions 23‚Äì26) and the list of people below.</p>
      <p>Match each statement with the correct researcher, <strong>A-E</strong>.</p>
      <p>Write the correct letter, <strong>A-E</strong>, in boxes <strong>23‚Äì26</strong> on your answer sheet.</p>
      
      <div style="margin-left:20px; margin-bottom:10px; font-size:13px; background:#f0f0f0; padding:10px; border-radius:4px;">
        <p><strong>List of People</strong></p>
        <div><strong>A</strong> Allison Leach</div>
        <div><strong>B</strong> Tara Garnett</div>
        <div><strong>C</strong> Annette Pinner</div>
        <div><strong>D</strong> Helmut Haberl</div>
        <div><strong>E</strong> Walter Falcon</div>
      </div>

      <ol start="23">
        <li><span class="flag-btn" data-q="q23" style="left:-20px;"></span>It is not possible to say that a vegetarian diet is right for everyone.<br>
          <label><input type="radio" name="q23" value="A"> A</label>
          <label><input type="radio" name="q23" value="B"> B</label>
          <label><input type="radio" name="q23" value="C"> C</label>
          <label><input type="radio" name="q23" value="D"> D</label>
          <label><input type="radio" name="q23" value="E"> E</label>
        </li>
        <li><span class="flag-btn" data-q="q24" style="left:-20px;"></span>It may be economically preferable to farm animals in limited space.<br>
          <label><input type="radio" name="q24" value="A"> A</label>
          <label><input type="radio" name="q24" value="B"> B</label>
          <label><input type="radio" name="q24" value="C"> C</label>
          <label><input type="radio" name="q24" value="D"> D</label>
          <label><input type="radio" name="q24" value="E"> E</label>
        </li>
        <li><span class="flag-btn" data-q="q25" style="left:-20px;"></span>It does not make sense to give up meat without giving up dairy products too.<br>
          <label><input type="radio" name="q25" value="A"> A</label>
          <label><input type="radio" name="q25" value="B"> B</label>
          <label><input type="radio" name="q25" value="C"> C</label>
          <label><input type="radio" name="q25" value="D"> D</label>
          <label><input type="radio" name="q25" value="E"> E</label>
        </li>
        <li><span class="flag-btn" data-q="q26" style="left:-20px;"></span>Some animals can be fed in a way that allows waste to be recycled.<br>
          <label><input type="radio" name="q26" value="A"> A</label>
          <label><input type="radio" name="q26" value="B"> B</label>
          <label><input type="radio" name="q26" value="C"> C</label>
          <label><input type="radio" name="q26" value="D"> D</label>
          <label><input type="radio" name="q26" value="E"> E</label>
        </li>
      </ol>
    </div>

    <div class="bottom-bar">
      <button class="btn-primary" onclick="submitAnswers()">Êèê‰∫§</button>
      <button onclick="resetForm()">ÈáçÁΩÆ</button>
      <button onclick="openWrongBook()">Êú¨ÁØáÈîôÈ¢ò</button>
    </div>
  </section>
</div>

<div id="selbar">
  <button id="btnNote">Note</button>
  <button id="btnHL">Highlight</button>
  <button id="btnUH" style="display:none;">Clear Highlight</button>
</div>

<div class="modal" id="resultModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ÊàêÁª©</h2>
      <span class="modal-close" onclick="closeModal('resultModal')">√ó</span>
    </div>
    <div id="resultContent"></div>
    <button class="btn-primary" style="width:100%; margin-top:16px;" onclick="addWrongToBook()">Âä†ÂÖ•ÈîôÈ¢òÊú¨</button>
  </div>
</div>

<div class="modal" id="wrongBookModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Êú¨ÁØáÈîôÈ¢ò</h2>
      <span class="modal-close" onclick="closeModal('wrongBookModal')">√ó</span>
    </div>
    <div id="wrongBookContent"></div>
  </div>
</div>

<div class="modal" id="resetModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ÈáçÁΩÆÁªÉ‰π†</h2>
      <span class="modal-close" onclick="closeModal('resetModal')">√ó</span>
    </div>
    <div style="margin:16px 0;">
      <label style="display:block; margin-bottom:10px;">
        <input type="radio" name="resetType" value="answers" checked>
        Âè™Ê∏ÖÁ©∫Á≠îÊ°à
      </label>
      <label style="display:block;">
        <input type="radio" name="resetType" value="all">
        Ê∏ÖÁ©∫Á≠îÊ°àÂíåÊ†áËÆ∞
      </label>
    </div>
    <button class="btn-primary" style="width:100%;" onclick="confirmReset()">Á°ÆÂÆö</button>
  </div>
</div>

<script>
const PAPER_ID='P2_MEAT';

let t=0;
const timerEl=document.getElementById('timer');
setInterval(()=>{ t++; timerEl.textContent=String(Math.floor(t/60)).padStart(2,'0')+':'+String(t%60).padStart(2,'0'); }, 1000);

const divider=document.getElementById('divider'), left=document.getElementById('left'), right=document.getElementById('right');
let dragging=false;
divider.onmousedown=()=>{ dragging=true; document.body.style.cursor='ew-resize'; };
window.onmousemove=(e)=>{ if(!dragging)return; const c=document.querySelector('.shell').getBoundingClientRect(); let x=e.clientX-c.left; x=Math.max(280,Math.min(c.width-280,x)); left.style.flex='0 0 '+x+'px'; right.style.flex='1 1 auto'; };
window.onmouseup=()=>{ dragging=false; document.body.style.cursor=''; };

const selbar=document.getElementById('selbar'), btnHL=document.getElementById('btnHL'), btnUH=document.getElementById('btnUH'), btnNote=document.getElementById('btnNote');
let lastRange=null, currentHlNode=null;

function posSelbar(r){ selbar.style.display='flex'; const t=window.scrollY+r.top-selbar.offsetHeight-8; const l=window.scrollX+r.left+r.width/2-selbar.offsetWidth/2; selbar.style.top=((t>0)?t:(window.scrollY+r.bottom+8))+'px'; selbar.style.left=Math.max(8,l)+'px'; }

function updSel(){ const s=window.getSelection(); if(!s||s.rangeCount===0||s.isCollapsed){ if(!currentHlNode)selbar.style.display='none'; return; } const r=s.getRangeAt(0); lastRange=r.cloneRange(); currentHlNode=null; btnNote.style.display='block'; btnHL.style.display='block'; btnUH.style.display='none'; posSelbar(r.getBoundingClientRect()); }

left.onmouseup=updSel; right.onmouseup=updSel;
document.onselectionchange=()=>{ const s=window.getSelection(); if((!s||s.rangeCount===0||s.isCollapsed)&&!currentHlNode)selbar.style.display='none'; };
document.addEventListener('click',(e)=>{ if(e.target.classList&&(e.target.classList.contains('hl')||e.target.classList.contains('note'))){ currentHlNode=e.target; lastRange=null; btnNote.style.display='none'; btnHL.style.display='none'; btnUH.style.display='block'; posSelbar(e.target.getBoundingClientRect()); const s=window.getSelection(); if(s)s.removeAllRanges(); }}, true);

btnHL.onclick=()=>{ if(currentHlNode||!lastRange||lastRange.collapsed)return; const s=document.createElement('span'); s.className='hl'; try{ lastRange.surroundContents(s); }catch(e){ const w=document.createElement('span'); w.className='hl'; w.appendChild(lastRange.cloneContents()); lastRange.deleteContents(); lastRange.insertNode(w); } selbar.style.display='none'; saveHighlights(); };

btnNote.onclick=()=>{ if(currentHlNode||!lastRange||lastRange.collapsed)return; const s=document.createElement('span'); s.className='note'; try{ lastRange.surroundContents(s); }catch(e){ const w=document.createElement('span'); w.className='note'; w.appendChild(lastRange.cloneContents()); lastRange.deleteContents(); lastRange.insertNode(w); } selbar.style.display='none'; saveHighlights(); };

btnUH.onclick=()=>{ if(currentHlNode){ const p=currentHlNode.parentNode; while(currentHlNode.firstChild)p.insertBefore(currentHlNode.firstChild,currentHlNode); p.removeChild(currentHlNode); p.normalize(); currentHlNode=null; selbar.style.display='none'; saveHighlights(); }else if(lastRange){ const sR=lastRange.getBoundingClientRect(); const w=document.createTreeWalker(document.body,NodeFilter.SHOW_ELEMENT); const tr=[]; while(w.nextNode()){ const n=w.currentNode; if(n.classList&&(n.classList.contains('hl')||n.classList.contains('note'))){ const r=n.getBoundingClientRect(); if(!(r.right<sR.left||r.left>sR.right||r.bottom<sR.top||r.top>sR.bottom))tr.push(n); }} tr.forEach(el=>{ const p=el.parentNode; while(el.firstChild)p.insertBefore(el.firstChild,el); p.removeChild(el); p.normalize(); }); selbar.style.display='none'; saveHighlights(); }};

document.querySelectorAll('.flag-btn').forEach(btn => {
  btn.onclick = e => {
    e.stopPropagation();
    btn.classList.toggle('active');
    saveFlags();
  };
});

// Answer Key based on PDF
const answerKey={
  q14:"E", q15:"D", q16:"H", q17:"F",
  q18:"irrigation", q19:"transport", q20:"land", q21:"nitrogen", q22:"erosion",
  q23:"C", q24:"E", q25:"D", q26:"B"
};
let lastResults=[];

function saveAnswers() {
  const data = {};
  Object.keys(answerKey).forEach(q => {
    // Check Radio
    const ch = document.querySelector(`input[name="${q}"]:checked`);
    if(ch) {
      data[q] = ch.value;
    } else {
      // Check Text Input
      const txt = document.querySelector(`input[data-q="${q}"][type="text"]`);
      if(txt) data[q] = txt.value;
    }
  });
  localStorage.setItem(`${PAPER_ID}_answers`, JSON.stringify(data));
}

function loadAnswers() {
  const data = JSON.parse(localStorage.getItem(`${PAPER_ID}_answers`) || '{}');
  Object.keys(data).forEach(q => {
    const radio = document.querySelector(`input[name="${q}"][value="${data[q]}"]`);
    if(radio) radio.checked = true;
    
    const txt = document.querySelector(`input[data-q="${q}"][type="text"]`);
    if(txt) txt.value = data[q];
  });
}

function saveFlags() {
  const flags = [...document.querySelectorAll('.flag-btn.active')].map(b => b.dataset.q);
  localStorage.setItem(`${PAPER_ID}_flags`, JSON.stringify(flags));
}

function loadFlags() {
  const flags = JSON.parse(localStorage.getItem(`${PAPER_ID}_flags`) || '[]');
  flags.forEach(q => document.querySelector(`[data-q="${q}"].flag-btn`)?.classList.add('active'));
}

function saveHighlights() {
  const highlights = { left: [], right: [] };
  document.querySelectorAll('#left .hl, #left .note').forEach((el, idx) => {
    highlights.left.push({ type: el.classList.contains('hl') ? 'hl' : 'note', text: el.textContent, index: idx });
  });
  document.querySelectorAll('#right .hl, #right .note').forEach((el, idx) => {
    highlights.right.push({ type: el.classList.contains('hl') ? 'hl' : 'note', text: el.textContent, index: idx });
  });
  localStorage.setItem(`${PAPER_ID}_highlights`, JSON.stringify(highlights));
}

function loadHighlights() {
  const data = JSON.parse(localStorage.getItem(`${PAPER_ID}_highlights`) || '{"left":[],"right":[]}');
  const restore = (list, root) => {
    if(!list || list.length === 0) return;
    list.forEach(item => {
      const walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT);
      let node;
      while(node = walker.nextNode()) {
        if(node.textContent.includes(item.text)) {
          const span = document.createElement('span');
          span.className = item.type;
          const parent = node.parentNode;
          const idx = node.textContent.indexOf(item.text);
          if(idx >= 0) {
            const before = node.textContent.substring(0, idx);
            const match = node.textContent.substring(idx, idx + item.text.length);
            const after = node.textContent.substring(idx + item.text.length);
            parent.insertBefore(document.createTextNode(before), node);
            span.textContent = match;
            parent.insertBefore(span, node);
            parent.insertBefore(document.createTextNode(after), node);
            parent.removeChild(node);
            break;
          }
        }
      }
    });
  };
  restore(data.left, left);
  restore(data.right, right);
}

document.querySelectorAll('input').forEach(inp => {
  if(inp.type === 'radio') inp.addEventListener('change', saveAnswers);
  else inp.addEventListener('input', saveAnswers);
});

document.addEventListener('DOMContentLoaded', () => {
  loadAnswers();
  loadFlags();
  loadHighlights();
});

function submitAnswers(){ 
  const res=[]; let cor=0; 
  Object.keys(answerKey).forEach(q=>{ 
    const r=document.querySelector('input[name="'+q+'"]:checked');
    const t=document.querySelector('input[data-q="'+q+'"][type="text"]');
    let uA = "";
    if(r) uA = r.value;
    else if(t) uA = t.value.trim();

    const cA=answerKey[q];
    // Case insensitive comparison for text inputs
    const iC = (uA.toLowerCase() === cA.toLowerCase()); 
    if(iC) cor++; 
    res.push({id:q,userAns:uA,correctAns:cA,isCorrect:iC}); 
  }); 
  lastResults=res; 
  const tot=Object.keys(answerKey).length; 
  const pct=((cor/tot)*100).toFixed(1); 
  localStorage.setItem(`ielts_score_${PAPER_ID}`, `${cor}/${tot}`);
  document.getElementById('resultContent').innerHTML=`<div class="result-summary"><div class="result-score">${cor} / ${tot}</div><div style="margin-top:8px;font-size:18px;">${pct}%</div></div>${res.map(r=>`<div class="result-item ${r.isCorrect?'correct':'incorrect'}"><div><strong>${r.id}</strong> ${r.isCorrect?'‚úì':'‚úó'}</div><div>‰Ω†ÁöÑÁ≠îÊ°à: ${r.userAns||'(Êú™‰ΩúÁ≠î)'}</div>${!r.isCorrect?`<div>Ê≠£Á°ÆÁ≠îÊ°à: ${r.correctAns}</div>`:''}</div>`).join('')}`; 
  document.getElementById('resultModal').classList.add('active'); 
}

function resetForm(){ document.getElementById('resetModal').classList.add('active'); }

function confirmReset(){ 
  const tp=document.querySelector('input[name="resetType"]:checked').value; 
  document.querySelectorAll('input[type="radio"]').forEach(i=>i.checked=false); 
  document.querySelectorAll('input[type="text"]').forEach(i=>i.value='');
  localStorage.removeItem(`${PAPER_ID}_answers`);
  
  if(tp==='all'){ 
    document.querySelectorAll('.hl').forEach(el=>{ const p=el.parentNode; while(el.firstChild)p.insertBefore(el.firstChild,el); p.removeChild(el); p.normalize(); }); 
    document.querySelectorAll('.note').forEach(el=>{ const p=el.parentNode; while(el.firstChild)p.insertBefore(el.firstChild,el); p.removeChild(el); p.normalize(); }); 
    document.querySelectorAll('.flag-btn').forEach(b => b.classList.remove('active'));
    localStorage.removeItem(`${PAPER_ID}_highlights`);
    localStorage.removeItem(`${PAPER_ID}_flags`);
  } 
  closeModal('resetModal'); 
}

function addWrongToBook(){ const wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); const wr=lastResults.filter(r=>!r.isCorrect); wr.forEach(r=>{ const en={paperId:PAPER_ID,title:'Should we stop eating meat?',questionId:r.id,correctAnswer:r.correctAns,myAnswer:r.userAns||'(Êú™‰ΩúÁ≠î)',date:new Date().toISOString().split('T')[0]}; const ix=wb.findIndex(i=>i.paperId===en.paperId&&i.questionId===en.questionId); if(ix>=0)wb[ix]=en; else wb.push(en); }); localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); alert(`Â∑≤Ê∑ªÂä† ${wr.length} ÈÅìÈîôÈ¢ò`); closeModal('resultModal'); }

function deleteWrongItem(pId,qId){ if(!confirm('Á°ÆÂÆöÂà†Èô§ËøôÈÅìÈîôÈ¢òÔºü'))return; let wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); wb=wb.filter(i=>!(i.paperId===pId&&i.questionId===qId)); localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); openWrongBook(); }

function clearCurrentWrongBook(){ if(!confirm('Á°ÆÂÆöÊ∏ÖÁ©∫Êú¨ÁØáÊâÄÊúâÈîôÈ¢òÔºü'))return; let wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); wb=wb.filter(i=>i.paperId!==PAPER_ID); localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); openWrongBook(); }

function openWrongBook(){ const wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); const cu=wb.filter(i=>i.paperId===PAPER_ID); const ct=document.getElementById('wrongBookContent'); if(cu.length===0)ct.innerHTML='<div style="text-align:center;padding:40px;color:#666;">ÊöÇÊó†ÈîôÈ¢ò</div>'; else ct.innerHTML=`<div class="modal-actions"><button class="btn-danger" onclick="clearCurrentWrongBook()" style="width:100%;">üóëÔ∏è Ê∏ÖÁ©∫Êú¨ÁØáÈîôÈ¢ò</button></div>${cu.map(i=>`<div class="wrong-item"><div class="wrong-item-content"><div style="font-weight:600;margin-bottom:8px;">${i.questionId}</div><div style="font-size:13px;color:#666;"><div>‚úì Ê≠£Á°Æ: ${i.correctAnswer}</div><div style="color:#d32f2f;">‚úó ÊàëÁöÑ: ${i.myAnswer}</div></div></div><button class="btn-delete" onclick="deleteWrongItem('${i.paperId}','${i.questionId}')">Âà†Èô§</button></div>`).join('')}`; document.getElementById('wrongBookModal').classList.add('active'); }

function closeModal(id){ document.getElementById(id).classList.remove('active'); }
</script>
</body>
</html>
