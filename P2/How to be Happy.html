<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>P2 ‚Äì How to be Happy</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  * { box-sizing: border-box; margin:0; padding:0; }
  html,body { height:100%; }
  body { font-family: Arial, sans-serif; background:#f5f5f5; }
  
  #timer { position:fixed; top:12px; right:12px; background:#fff; border:1px solid #ddd; border-radius:6px; padding:8px 12px; font-size:16px; font-weight:600; color:#0066cc; z-index:1000; }
  
  .shell { display:flex; height:100vh; width:100%; }
  .pane { background:#fff; overflow:auto; padding:24px; }
  #left { flex: 0 0 50%; border-right:1px solid #ddd; }
  #right { flex: 1 1 auto; background:#fafafa; }
  #divider { flex: 0 0 5px; background:#ddd; cursor: ew-resize; }
  #divider:hover { background:#999; }
  
  h2,h3,h4 { margin:0 0 12px; color:#333; }
  h2 { font-size:20px; }
  h3 { font-size:18px; color:#0066cc; }
  h4 { font-size:15px; font-weight:600; margin-top:20px; }
  
  #left p { margin: 0 0 14px; line-height: 1.7; text-align:justify; }
  
  .group { background:#fff; border:1px solid #ddd; border-radius:6px; padding:16px; margin-bottom:16px; }
  .group h4 { margin-top:0; color:#0066cc; }
  .group p { margin:8px 0; font-size:14px; line-height:1.6; }
  
  .headings { background:#f9f9f9; padding:12px; margin:12px 0; border-radius:4px; border: 1px solid #eee;}
  .headings ol, .headings ul { margin-left:20px; list-style-type: none; }
  .headings li { margin:4px 0; font-size:13px; }
  
  .flag-btn { 
    position:absolute; 
    left:-18px; 
    top:4px;
    width:8px;
    height:8px;
    border-radius:50%;
    background:#ddd;
    cursor:pointer;
    z-index:10;
  }
  .flag-btn:hover { background:#999; }
  .flag-btn.active { background:#ff5722; }
  
  .question-item { position: relative; margin-bottom: 15px; padding-left: 10px; }
  
  /* Radio grid for Headings/Matching */
  .radio-grid { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 5px; }
  .radio-grid label { font-size: 12px; display: flex; align-items: center; gap: 3px; cursor: pointer; background: #f0f0f0; padding: 2px 6px; border-radius: 4px; }
  .radio-grid label:hover { background: #e0e0e0; }

  /* Fill in the blank inputs */
  .gap-input {
    border: none;
    border-bottom: 1px solid #333;
    background: #fdfdfd;
    width: 100px;
    padding: 0 5px;
    font-size: 14px;
    color: #0066cc;
    text-align: center;
    outline: none;
  }
  .gap-input:focus { border-bottom: 2px solid #0066cc; background: #fff; }

  .bottom-bar { display:flex; gap:10px; margin-top:16px; }
  button { padding:10px 20px; border:1px solid #999; border-radius:6px; background:#fff; cursor:pointer; font-size:14px; }
  button:hover { background:#f0f0f0; }
  .btn-primary { background:#0066cc; color:#fff; border-color:#0066cc; }
  .btn-primary:hover { background:#0052a3; }
  .btn-danger { background:#dc3545; color:#fff; border-color:#dc3545; }
  .btn-danger:hover { background:#c82333; }
  
  .hl { background:#fff59d; cursor:pointer; }
  .hl:hover { background:#ffeb3b; }
  .note { background:#b3d9ff; cursor:pointer; }
  .note:hover { background:#99ccff; }
  
  #selbar { position:fixed; display:none; z-index:2000; background:#fff; border:1px solid #ddd; border-radius:8px; padding:8px; gap:0; box-shadow:0 2px 8px rgba(0,0,0,0.15); flex-direction:column; min-width:120px; }
  #selbar button { background:#fff; color:#666; border:none; padding:3px 0px; cursor:pointer; font-size:14px; text-align:center; border-radius:4px; }
  #selbar button:hover { background:#f5f5f5; color:#333; }
  
  .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:3000; align-items:center; justify-content:center; }
  .modal.active { display:flex; }
  .modal-content { background:#fff; border-radius:8px; padding:24px; max-width:600px; width:90%; max-height:80vh; overflow-y:auto; }
  
  .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
  .modal-header h2 { font-size: 28px; color: #333; margin: 0; }
  .modal-close { font-size: 32px; cursor: pointer; color: #999; line-height: 1; }
  .modal-close:hover { color: #333; }
  
  .result-summary { text-align:center; padding:20px; background:#f0f0f0; margin-bottom:16px; border-radius:6px; }
  .result-score { font-size:36px; font-weight:600; color:#0066cc; }
  .result-item { padding:10px; margin:8px 0; border-left:3px solid #ddd; background:#f9f9f9; font-size:13px; }
  .result-item.correct { border-left-color:#28a745; background:#e8f5e9; }
  .result-item.incorrect { border-left-color:#dc3545; background:#ffebee; }
  
  .wrong-item { background:#fff3e0; padding:16px; margin:8px 0; border-radius:8px; border-left:4px solid #ff9800; display:flex; justify-content:space-between; align-items:start; }
  .wrong-item-content { flex:1; }
  .btn-delete { background:#dc3545; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-size:13px; margin-left:12px; }
  .btn-delete:hover { background:#c82333; }
  .modal-actions { display:flex; gap:10px; margin-bottom:20px; }
</style>
</head>
<body>
<div id="timer">00:00</div>

<div class="shell">
  <section class="pane" id="left">
    <h2>READING PASSAGE 2</h2>
    <p>You should spend about 20 minutes on Questions 14‚Äì26, which are based on Reading Passage 2 below.</p>
    
    <h3>How to be Happy</h3>
    <p><em>Some recent developments in the science of happiness</em></p>

    <h4>Paragraph A</h4>
    <p>A psychiatrist Tony Fernando was walking down the street when he saw a group of young homeless men sitting on the footpath. As Fernando handed out gifts of food, he tried to video the men‚Äôs reactions in his mind, recording how their gratitude lifted him in return. ‚ÄòI felt warm, content, meaningful,‚Äô he says. Fernando believes the brain can be trained to make us happy and that his ‚Äòvideo method‚Äô is one way to achieve this. In fact, a growing body of scientific research internationally is showing how we can learn happiness in the same way we can learn to play the piano. In the soft tissue that forms the brain, there are approximately ten trillion synapses connecting roughly a hundred billion neurons. Active synapses become more sensitive; less active synapses die, but new ones grow quickly. This is relatively new thinking ‚Äì just 30 years ago, neuroscientists believed that adult brain cells couldn‚Äôt regenerate. One of the pioneers in this field is University of Wisconsin professor Richard Davidson. He studied Buddhist monks using brain scans in his research facility, and found that those trained in meditation had higher levels of activity in the left prefrontal cortex ‚Äì the area associated with happiness. Davidson believes that the trained brain is physically different from the untrained one.</p>

    <h4>Paragraph B</h4>
    <p>The idea that we can train our brains to find more happiness has been called ‚Äòmindfulness‚Äô by neuropsychologist Rick Hanson, author of <em>Hardwiring Happiness</em>. It was in college that Hanson, quite unintentionally, first recognised the importance of something that would become his life‚Äôs work. As an unconfident teenager, he discovered he could turn a small event, ‚Äòa young woman smiling at me‚Äô, into a good feeling he could hold on to. To do this, Hanson employs exactly the same imaginary ‚Äòvideo method‚Äô as psychiatrist Tony Fernando. ‚ÄòThe brain takes its shape from what the mind rests upon,‚Äô says Hanson. If you keep resting your mind on self-criticism and worries, he argues, your brain will be shaped by that. Hanson explains that resting it on pleasant feelings and the things you have accomplished means that over time your brain will take on a different shape, with strength and optimism hard-wired into it.</p>

    <h4>Paragraph C</h4>
    <p>In New Zealand, the Mental Health Foundation runs mindfulness programmes in 14 schools. Foundation CEO Judi Clements says, ‚ÄòIt‚Äôs a valuable approach because children are told to pay attention, but aren‚Äôt told how to pay attention.‚Äô Preliminary results on the outcomes found that children had sustained increases in well-being. The Foundation recognises five pathways to happiness ‚Äì being active, connecting with others, taking notice, learning and giving. And, says Clements, ‚ÄòWe‚Äôre detecting a hunger for it from different organisations and professions as well, so the Foundation is soon going to pilot an online ‚Äúwell-being game‚Äù in several workplaces.‚Äô The project leader is psychologist Carsten Grimm, who is interested in whether some pathways to happiness are more effective than others. In a study, Grimm recorded the activities and corresponding happiness scores of 173 people. What he found was that people who used several pathways to happiness achieved the best results, suggesting it‚Äôs better to have a balance than concentrate on the single pathway you most identify with.</p>

    <h4>Paragraph D</h4>
    <p>However, Associate Professor of Psychological Medicine Nathan Consedine greets our relentless search for the secrets to happiness with a tired sigh. ‚ÄòThe more you chase it, the less you get it,‚Äô he says, quoting studies showing those who value contentment and well-being are, in fact, less happy. The big question, he says, is whether there‚Äôs any benefit in actively seeking happiness. He cites a study, for example, which showed that people who were happier were less inclined to show sympathy. Consedine says that‚Äôs probably because happy people are strongly motivated to stay happy, but engaging sympathetically with others typically involves engaging with their distress, and that‚Äôs going to reduce their own happiness. Consedine‚Äôs not disagreeing with the theory of mindfulness, but believes there‚Äôs more work to be done.</p>

    <h4>Paragraph E</h4>
    <p>Some of that work is being conducted at Auckland University‚Äôs Centre for Brain Research. Associate Professor Johanna Montgomery has been studying Hanson‚Äôs theory ‚Äì that altering our brain activity at a synaptic level affects our behaviour. She accepts that it‚Äôs a logical explanation based on studies from animals, but we haven‚Äôt yet got the technology to prove it scientifically in humans. It‚Äôs true that MRI scans certainly do indicate an increased flow of blood to different areas of the brain which are experiencing positive stimuli. However, she warns that this is a long way from confirming that the brain itself is developing or strengthening.</p>

    <h4>Paragraph F</h4>
    <p>Nonetheless, Montgomery believes she is making progress. In the laboratory, when scientists want to experiment with synaptic connections, they stimulate the brain with electricity, as this copies the high-frequency firings that happen normally in the brain every second. Using this technique, Montgomery has made a number of findings. For example, the hormones that are released routinely in response to good or bad situations ‚Äì such as adrenaline ‚Äì act to regulate the brain, in the same way that weather has a regulating effect on human activity more generally. But scientists understand some of these stimuli better than others. More is known about the impact on brain activity of prolonged periods of fear than the effects of ‚Äòhappiness‚Äô hormones that are released by positive events in life. This is one potentially important area that she hopes to investigate further in future.</p>
  </section>

  <div id="divider" title="Drag to resize"></div>

  <section class="pane" id="right">
    <h3>Questions</h3>

    <div class="group">
      <h4>Questions 14‚Äì17</h4>
      <p>Reading Passage 2 has six paragraphs, A‚ÄìF.<br>Which paragraph contains the following information?<br>Write the correct letter, <strong>A‚ÄìF</strong>, in boxes 14‚Äì17 on your answer sheet.</p>
      <p><strong>NB</strong> You may use any letter more than once.</p>
      
      <div class="question-item">
        <span class="flag-btn" data-q="q14"></span>
        <strong>14.</strong> a reference to a fact that two scientists use the same technique to promote their own happiness
        <div class="radio-grid">
            <label><input type="radio" name="q14" value="A"> A</label> <label><input type="radio" name="q14" value="B"> B</label> <label><input type="radio" name="q14" value="C"> C</label> <label><input type="radio" name="q14" value="D"> D</label> <label><input type="radio" name="q14" value="E"> E</label> <label><input type="radio" name="q14" value="F"> F</label>
        </div>
      </div>
      <div class="question-item">
        <span class="flag-btn" data-q="q15"></span>
        <strong>15.</strong> the suggestion that scientific opinion about an aspect of brain function has changed over a given time period
        <div class="radio-grid">
            <label><input type="radio" name="q15" value="A"> A</label> <label><input type="radio" name="q15" value="B"> B</label> <label><input type="radio" name="q15" value="C"> C</label> <label><input type="radio" name="q15" value="D"> D</label> <label><input type="radio" name="q15" value="E"> E</label> <label><input type="radio" name="q15" value="F"> F</label>
        </div>
      </div>
      <div class="question-item">
        <span class="flag-btn" data-q="q16"></span>
        <strong>16.</strong> an estimate of how numerous some brain components are
        <div class="radio-grid">
            <label><input type="radio" name="q16" value="A"> A</label> <label><input type="radio" name="q16" value="B"> B</label> <label><input type="radio" name="q16" value="C"> C</label> <label><input type="radio" name="q16" value="D"> D</label> <label><input type="radio" name="q16" value="E"> E</label> <label><input type="radio" name="q16" value="F"> F</label>
        </div>
      </div>
      <div class="question-item">
        <span class="flag-btn" data-q="q17"></span>
        <strong>17.</strong> the reason why some educational courses were set up
        <div class="radio-grid">
            <label><input type="radio" name="q17" value="A"> A</label> <label><input type="radio" name="q17" value="B"> B</label> <label><input type="radio" name="q17" value="C"> C</label> <label><input type="radio" name="q17" value="D"> D</label> <label><input type="radio" name="q17" value="E"> E</label> <label><input type="radio" name="q17" value="F"> F</label>
        </div>
      </div>
    </div>

    <div class="group">
      <h4>Questions 18‚Äì21</h4>
      <p>Look at the following statements (Questions 18‚Äì21) and the list of people below.<br>Match each statement with the correct person, A‚ÄìF.<br>Write the correct letter, <strong>A‚ÄìF</strong>, in boxes 18‚Äì21 on your answer sheet.</p>
      
      <div class="headings">
        <strong>List of People</strong>
        <ul>
            <li><strong>A</strong> Tony Fernando</li>
            <li><strong>B</strong> Richard Davidson</li>
            <li><strong>C</strong> Rick Hanson</li>
            <li><strong>D</strong> Judi Clements</li>
            <li><strong>E</strong> Carsten Grimm</li>
            <li><strong>F</strong> Nathan Consedine</li>
        </ul>
      </div>

      <div class="question-item">
        <span class="flag-btn" data-q="q18"></span>
        <strong>18.</strong> It‚Äôs better to look for a variety of ways to increase happiness than focus on just one.
        <div class="radio-grid">
           <label><input type="radio" name="q18" value="A"> A</label> <label><input type="radio" name="q18" value="B"> B</label> <label><input type="radio" name="q18" value="C"> C</label> <label><input type="radio" name="q18" value="D"> D</label> <label><input type="radio" name="q18" value="E"> E</label> <label><input type="radio" name="q18" value="F"> F</label>
        </div>
      </div>
      <div class="question-item">
        <span class="flag-btn" data-q="q19"></span>
        <strong>19.</strong> Focusing on personal achievements rather than negative experiences will make people happier.
        <div class="radio-grid">
           <label><input type="radio" name="q19" value="A"> A</label> <label><input type="radio" name="q19" value="B"> B</label> <label><input type="radio" name="q19" value="C"> C</label> <label><input type="radio" name="q19" value="D"> D</label> <label><input type="radio" name="q19" value="E"> E</label> <label><input type="radio" name="q19" value="F"> F</label>
        </div>
      </div>
      <div class="question-item">
        <span class="flag-btn" data-q="q20"></span>
        <strong>20.</strong> Happy people might have a reason not to display one favourable characteristic.
        <div class="radio-grid">
           <label><input type="radio" name="q20" value="A"> A</label> <label><input type="radio" name="q20" value="B"> B</label> <label><input type="radio" name="q20" value="C"> C</label> <label><input type="radio" name="q20" value="D"> D</label> <label><input type="radio" name="q20" value="E"> E</label> <label><input type="radio" name="q20" value="F"> F</label>
        </div>
      </div>
       <div class="question-item">
        <span class="flag-btn" data-q="q21"></span>
        <strong>21.</strong> A range of groups are becoming more interested in learning techniques to improve happiness.
        <div class="radio-grid">
           <label><input type="radio" name="q21" value="A"> A</label> <label><input type="radio" name="q21" value="B"> B</label> <label><input type="radio" name="q21" value="C"> C</label> <label><input type="radio" name="q21" value="D"> D</label> <label><input type="radio" name="q21" value="E"> E</label> <label><input type="radio" name="q21" value="F"> F</label>
        </div>
      </div>
    </div>

    <div class="group">
      <h4>Questions 22‚Äì26</h4>
      <p>Complete the summary below.<br>Choose <strong>ONE WORD ONLY</strong> from the passage for each answer.<br>Write your answers in boxes 22‚Äì26 on your answer sheet.</p>
      
      <div style="background:#fafafa; padding:15px; border-radius:6px; line-height:2;">
        <h4 style="text-align:center;">Auckland University‚Äôs Centre for Brain Research</h4>
        <p>Associate Professor Johanna Montgomery says that current research into brain activity and behaviour only relates to <span class="question-item" style="display:inline-block; margin:0; padding:0;"><span class="flag-btn" data-q="q22" style="left:-12px; top:6px;"></span><input type="text" class="gap-input" id="q22" placeholder="22"></span> , so Hanson‚Äôs theories have not been proved correct. While scans do show that positive stimuli result in more <span class="question-item" style="display:inline-block; margin:0; padding:0;"><span class="flag-btn" data-q="q23" style="left:-12px; top:6px;"></span><input type="text" class="gap-input" id="q23" placeholder="23"></span> reaching parts of the brain, this isn‚Äôt proof that the brain is getting stronger.</p>
        <p>But Montgomery is making progress. In laboratory experiments, scientists use <span class="question-item" style="display:inline-block; margin:0; padding:0;"><span class="flag-btn" data-q="q24" style="left:-12px; top:6px;"></span><input type="text" class="gap-input" id="q24" placeholder="24"></span> to initiate brain activity, because it‚Äôs similar to natural processes. One finding is that hormones can be compared to the <span class="question-item" style="display:inline-block; margin:0; padding:0;"><span class="flag-btn" data-q="q25" style="left:-12px; top:6px;"></span><input type="text" class="gap-input" id="q25" placeholder="25"></span> , because both can change human behaviour. But scientists understand some stimuli, such as <span class="question-item" style="display:inline-block; margin:0; padding:0;"><span class="flag-btn" data-q="q26" style="left:-12px; top:6px;"></span><input type="text" class="gap-input" id="q26" placeholder="26"></span> , better than they understand more positive stimuli.</p>
      </div>
    </div>

    <div class="bottom-bar">
      <button class="btn-primary" onclick="submitAnswers()">Êèê‰∫§</button>
      <button onclick="resetForm()">ÈáçÁΩÆ</button>
      <button onclick="openWrongBook()">Êú¨ÁØáÈîôÈ¢ò</button>
    </div>
  </section>
</div>

<div id="selbar">
  <button id="btnNote">Note</button>
  <button id="btnHL">Highlight</button>
  <button id="btnUH" style="display:none;">Clear Highlight</button>
</div>

<div class="modal" id="resultModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ÊàêÁª©</h2>
      <span class="modal-close" onclick="closeModal('resultModal')">√ó</span>
    </div>
    <div id="resultContent"></div>
    <button class="btn-primary" style="width:100%; margin-top:16px;" onclick="addWrongToBook()">Âä†ÂÖ•ÈîôÈ¢òÊú¨</button>
  </div>
</div>

<div class="modal" id="wrongBookModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Êú¨ÁØáÈîôÈ¢ò</h2>
      <span class="modal-close" onclick="closeModal('wrongBookModal')">√ó</span>
    </div>
    <div id="wrongBookContent"></div>
  </div>
</div>

<div class="modal" id="resetModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ÈáçÁΩÆÁªÉ‰π†</h2>
      <span class="modal-close" onclick="closeModal('resetModal')">√ó</span>
    </div>
    <div style="margin:16px 0;">
      <label style="display:block; margin-bottom:10px;">
        <input type="radio" name="resetType" value="answers" checked>
        Âè™Ê∏ÖÁ©∫Á≠îÊ°à
      </label>
      <label style="display:block;">
        <input type="radio" name="resetType" value="all">
        Ê∏ÖÁ©∫Á≠îÊ°àÂíåÊ†áËÆ∞
      </label>
    </div>
    <button class="btn-primary" style="width:100%;" onclick="confirmReset()">Á°ÆÂÆö</button>
  </div>
</div>

<script>
const PAPER_ID='P2_HAPPY';

let t=0;
const timerEl=document.getElementById('timer');
setInterval(()=>{ t++; timerEl.textContent=String(Math.floor(t/60)).padStart(2,'0')+':'+String(t%60).padStart(2,'0'); }, 1000);

const divider=document.getElementById('divider'), left=document.getElementById('left'), right=document.getElementById('right');
let dragging=false;
divider.onmousedown=()=>{ dragging=true; document.body.style.cursor='ew-resize'; };
window.onmousemove=(e)=>{ if(!dragging)return; const c=document.querySelector('.shell').getBoundingClientRect(); let x=e.clientX-c.left; x=Math.max(280,Math.min(c.width-280,x)); left.style.flex='0 0 '+x+'px'; right.style.flex='1 1 auto'; };
window.onmouseup=()=>{ dragging=false; document.body.style.cursor=''; };

const selbar=document.getElementById('selbar'), btnHL=document.getElementById('btnHL'), btnUH=document.getElementById('btnUH'), btnNote=document.getElementById('btnNote');
let lastRange=null, currentHlNode=null;

function posSelbar(r){ selbar.style.display='flex'; const t=window.scrollY+r.top-selbar.offsetHeight-8; const l=window.scrollX+r.left+r.width/2-selbar.offsetWidth/2; selbar.style.top=((t>0)?t:(window.scrollY+r.bottom+8))+'px'; selbar.style.left=Math.max(8,l)+'px'; }

function updSel(){ const s=window.getSelection(); if(!s||s.rangeCount===0||s.isCollapsed){ if(!currentHlNode)selbar.style.display='none'; return; } const r=s.getRangeAt(0); lastRange=r.cloneRange(); currentHlNode=null; btnNote.style.display='block'; btnHL.style.display='block'; btnUH.style.display='none'; posSelbar(r.getBoundingClientRect()); }

left.onmouseup=updSel; right.onmouseup=updSel;
document.onselectionchange=()=>{ const s=window.getSelection(); if((!s||s.rangeCount===0||s.isCollapsed)&&!currentHlNode)selbar.style.display='none'; };
document.addEventListener('click',(e)=>{ if(e.target.classList&&(e.target.classList.contains('hl')||e.target.classList.contains('note'))){ currentHlNode=e.target; lastRange=null; btnNote.style.display='none'; btnHL.style.display='none'; btnUH.style.display='block'; posSelbar(e.target.getBoundingClientRect()); const s=window.getSelection(); if(s)s.removeAllRanges(); }}, true);

btnHL.onclick=()=>{ if(currentHlNode||!lastRange||lastRange.collapsed)return; const s=document.createElement('span'); s.className='hl'; try{ lastRange.surroundContents(s); }catch(e){ const w=document.createElement('span'); w.className='hl'; w.appendChild(lastRange.cloneContents()); lastRange.deleteContents(); lastRange.insertNode(w); } selbar.style.display='none'; saveHighlights(); };

btnNote.onclick=()=>{ if(currentHlNode||!lastRange||lastRange.collapsed)return; const s=document.createElement('span'); s.className='note'; try{ lastRange.surroundContents(s); }catch(e){ const w=document.createElement('span'); w.className='note'; w.appendChild(lastRange.cloneContents()); lastRange.deleteContents(); lastRange.insertNode(w); } selbar.style.display='none'; saveHighlights(); };

btnUH.onclick=()=>{ if(currentHlNode){ const p=currentHlNode.parentNode; while(currentHlNode.firstChild)p.insertBefore(currentHlNode.firstChild,currentHlNode); p.removeChild(currentHlNode); p.normalize(); currentHlNode=null; selbar.style.display='none'; saveHighlights(); }else if(lastRange){ const sR=lastRange.getBoundingClientRect(); const w=document.createTreeWalker(document.body,NodeFilter.SHOW_ELEMENT); const tr=[]; while(w.nextNode()){ const n=w.currentNode; if(n.classList&&(n.classList.contains('hl')||n.classList.contains('note'))){ const r=n.getBoundingClientRect(); if(!(r.right<sR.left||r.left>sR.right||r.bottom<sR.top||r.top>sR.bottom))tr.push(n); }} tr.forEach(el=>{ const p=el.parentNode; while(el.firstChild)p.insertBefore(el.firstChild,el); p.removeChild(el); p.normalize(); }); selbar.style.display='none'; saveHighlights(); }};

document.querySelectorAll('.flag-btn').forEach(btn => {
  btn.onclick = e => {
    e.stopPropagation();
    btn.classList.toggle('active');
    saveFlags();
  };
});

// Answer Key based on PDF
const answerKey={
  q14:"B", q15:"A", q16:"A", q17:"C",
  q18:"E", q19:"C", q20:"F", q21:"D",
  q22:"animals", q23:"blood", q24:"electricity", q25:"weather", q26:"fear"
};
const textInputs = ['q22','q23','q24','q25','q26'];

let lastResults=[];

function saveAnswers() {
  const data = {};
  // Save Radio Buttons
  Object.keys(answerKey).forEach(q => {
    if(textInputs.includes(q)) return;
    const ch = document.querySelector(`input[name="${q}"]:checked`);
    if(ch) data[q] = ch.value;
  });
  // Save Text Inputs
  textInputs.forEach(id => {
    const el = document.getElementById(id);
    if(el) data[id] = el.value;
  });
  localStorage.setItem(`${PAPER_ID}_answers`, JSON.stringify(data));
}

function loadAnswers() {
  const data = JSON.parse(localStorage.getItem(`${PAPER_ID}_answers`) || '{}');
  Object.keys(data).forEach(q => {
    if(textInputs.includes(q)){
      const el = document.getElementById(q);
      if(el) el.value = data[q];
    } else {
      const radio = document.querySelector(`input[name="${q}"][value="${data[q]}"]`);
      if(radio) radio.checked = true;
    }
  });
}

function saveFlags() {
  const flags = [...document.querySelectorAll('.flag-btn.active')].map(b => b.dataset.q);
  localStorage.setItem(`${PAPER_ID}_flags`, JSON.stringify(flags));
}

function loadFlags() {
  const flags = JSON.parse(localStorage.getItem(`${PAPER_ID}_flags`) || '[]');
  flags.forEach(q => document.querySelector(`[data-q="${q}"]`)?.classList.add('active'));
}

function saveHighlights() {
  const highlights = { left: [], right: [] };
  document.querySelectorAll('#left .hl, #left .note').forEach((el, idx) => {
    highlights.left.push({ type: el.classList.contains('hl') ? 'hl' : 'note', text: el.textContent, index: idx });
  });
  document.querySelectorAll('#right .hl, #right .note').forEach((el, idx) => {
    highlights.right.push({ type: el.classList.contains('hl') ? 'hl' : 'note', text: el.textContent, index: idx });
  });
  localStorage.setItem(`${PAPER_ID}_highlights`, JSON.stringify(highlights));
}

function loadHighlights() {
  const data = JSON.parse(localStorage.getItem(`${PAPER_ID}_highlights`) || '{"left":[],"right":[]}');
  ['left','right'].forEach(pane => {
    const container = document.getElementById(pane);
    if(data[pane] && data[pane].length > 0) {
      data[pane].forEach(item => {
        const walker = document.createTreeWalker(container, NodeFilter.SHOW_TEXT);
        let node;
        while(node = walker.nextNode()) {
          if(node.textContent.includes(item.text)) {
            const span = document.createElement('span');
            span.className = item.type;
            const parent = node.parentNode;
            const text = node.textContent;
            const idx = text.indexOf(item.text);
            if(idx >= 0) {
              parent.insertBefore(document.createTextNode(text.substring(0, idx)), node);
              span.textContent = text.substring(idx, idx + item.text.length);
              parent.insertBefore(span, node);
              parent.insertBefore(document.createTextNode(text.substring(idx + item.text.length)), node);
              parent.removeChild(node);
              break;
            }
          }
        }
      });
    }
  });
}

document.querySelectorAll('input[type="radio"]').forEach(radio => radio.addEventListener('change', saveAnswers));
document.querySelectorAll('input[type="text"]').forEach(txt => txt.addEventListener('input', saveAnswers));

document.addEventListener('DOMContentLoaded', () => {
  loadAnswers();
  loadFlags();
  loadHighlights();
});

function submitAnswers(){ 
  const res=[]; let cor=0; 
  Object.keys(answerKey).forEach(q=>{ 
    let uA = "";
    if(textInputs.includes(q)){
      uA = document.getElementById(q).value.trim();
    } else {
      const ch=document.querySelector('input[name="'+q+'"]:checked'); 
      uA = ch?ch.value:"";
    }
    const cA=answerKey[q]; 
    const iC = uA.toLowerCase() === cA.toLowerCase(); 
    if(iC) cor++; 
    res.push({id:q,userAns:uA,correctAns:cA,isCorrect:iC}); 
  }); 
  lastResults=res; 
  const tot=Object.keys(answerKey).length; 
  const pct=((cor/tot)*100).toFixed(1); 
  localStorage.setItem(`ielts_score_${PAPER_ID}`, `${cor}/${tot}`);
  document.getElementById('resultContent').innerHTML=`<div class="result-summary"><div class="result-score">${cor} / ${tot}</div><div style="margin-top:8px;font-size:18px;">${pct}%</div></div>${res.map(r=>`<div class="result-item ${r.isCorrect?'correct':'incorrect'}"><div><strong>${r.id}</strong> ${r.isCorrect?'‚úì':'‚úó'}</div><div>‰Ω†ÁöÑÁ≠îÊ°à: ${r.userAns||'(Êú™‰ΩúÁ≠î)'}</div>${!r.isCorrect?`<div>Ê≠£Á°ÆÁ≠îÊ°à: ${r.correctAns}</div>`:''}</div>`).join('')}`; 
  document.getElementById('resultModal').classList.add('active'); 
}

function resetForm(){ document.getElementById('resetModal').classList.add('active'); }

function confirmReset(){ 
  const tp=document.querySelector('input[name="resetType"]:checked').value; 
  document.querySelectorAll('input[type="radio"]').forEach(i=>i.checked=false); 
  document.querySelectorAll('input[type="text"]').forEach(i=>i.value=''); 
  localStorage.removeItem(`${PAPER_ID}_answers`);
  
  if(tp==='all'){ 
    document.querySelectorAll('.hl').forEach(el=>{ const p=el.parentNode; while(el.firstChild)p.insertBefore(el.firstChild,el); p.removeChild(el); p.normalize(); }); 
    document.querySelectorAll('.note').forEach(el=>{ const p=el.parentNode; while(el.firstChild)p.insertBefore(el.firstChild,el); p.removeChild(el); p.normalize(); }); 
    document.querySelectorAll('.flag-btn').forEach(b => b.classList.remove('active'));
    localStorage.removeItem(`${PAPER_ID}_highlights`);
    localStorage.removeItem(`${PAPER_ID}_flags`);
  } 
  closeModal('resetModal'); 
}

function addWrongToBook(){ 
  const wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); 
  const wr=lastResults.filter(r=>!r.isCorrect); 
  wr.forEach(r=>{ 
    const en={paperId:PAPER_ID,title:'How to be Happy',questionId:r.id,correctAnswer:r.correctAns,myAnswer:r.userAns||'(Êú™‰ΩúÁ≠î)',date:new Date().toISOString().split('T')[0]}; 
    const ix=wb.findIndex(i=>i.paperId===en.paperId&&i.questionId===en.questionId); 
    if(ix>=0)wb[ix]=en; else wb.push(en); 
  }); 
  localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); 
  alert(`Â∑≤Ê∑ªÂä† ${wr.length} ÈÅìÈîôÈ¢ò`); 
  closeModal('resultModal'); 
}

function deleteWrongItem(pId,qId){ if(!confirm('Á°ÆÂÆöÂà†Èô§ËøôÈÅìÈîôÈ¢òÔºü'))return; let wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); wb=wb.filter(i=>!(i.paperId===pId&&i.questionId===qId)); localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); openWrongBook(); }

function clearCurrentWrongBook(){ if(!confirm('Á°ÆÂÆöÊ∏ÖÁ©∫Êú¨ÁØáÊâÄÊúâÈîôÈ¢òÔºü'))return; let wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); wb=wb.filter(i=>i.paperId!==PAPER_ID); localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); openWrongBook(); }

function openWrongBook(){ 
  const wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); 
  const cu=wb.filter(i=>i.paperId===PAPER_ID); 
  const ct=document.getElementById('wrongBookContent'); 
  if(cu.length===0)ct.innerHTML='<div style="text-align:center;padding:40px;color:#666;">ÊöÇÊó†ÈîôÈ¢ò</div>'; 
  else ct.innerHTML=`<div class="modal-actions"><button class="btn-danger" onclick="clearCurrentWrongBook()" style="width:100%;">üóëÔ∏è Ê∏ÖÁ©∫Êú¨ÁØáÈîôÈ¢ò</button></div>${cu.map(i=>`<div class="wrong-item"><div class="wrong-item-content"><div style="font-weight:600;margin-bottom:8px;">${i.questionId}</div><div style="font-size:13px;color:#666;"><div>‚úì Ê≠£Á°Æ: ${i.correctAnswer}</div><div style="color:#d32f2f;">‚úó ÊàëÁöÑ: ${i.myAnswer}</div></div></div><button class="btn-delete" onclick="deleteWrongItem('${i.paperId}','${i.questionId}')">Âà†Èô§</button></div>`).join('')}`; 
  document.getElementById('wrongBookModal').classList.add('active'); 
}

function closeModal(id){ document.getElementById(id).classList.remove('active'); }
</script>
</body>
</html>
