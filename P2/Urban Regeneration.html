<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>P2 ‚Äì Urban Regeneration</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  * { box-sizing: border-box; margin:0; padding:0; }
  html,body { height:100%; }
  body { font-family: Arial, sans-serif; background:#f5f5f5; }
  
  #timer { position:fixed; top:12px; right:12px; background:#fff; border:1px solid #ddd; border-radius:6px; padding:8px 12px; font-size:16px; font-weight:600; color:#0066cc; z-index:1000; }
  
  .shell { display:flex; height:100vh; width:100%; }
  .pane { background:#fff; overflow:auto; padding:24px; }
  #left { flex: 0 0 50%; border-right:1px solid #ddd; }
  #right { flex: 1 1 auto; background:#fafafa; }
  #divider { flex: 0 0 5px; background:#ddd; cursor: ew-resize; }
  #divider:hover { background:#999; }
  
  h2,h3,h4 { margin:0 0 12px; color:#333; }
  h2 { font-size:20px; }
  h3 { font-size:18px; color:#0066cc; }
  h4 { font-size:15px; font-weight:600; margin-top:20px; }
  
  #left p { margin: 0 0 14px; line-height: 1.7; text-align:justify; }
  
  .group { background:#fff; border:1px solid #ddd; border-radius:6px; padding:16px; margin-bottom:16px; }
  .group h4 { margin-top:0; color:#0066cc; }
  .group p { margin:8px 0; font-size:14px; line-height:1.6; }
  
  .headings { background:#f9f9f9; padding:12px; margin:12px 0; border-radius:4px; }
  .headings ol { margin-left:20px; }
  .headings li { margin:4px 0; font-size:13px; }
  
  .flag-btn { 
    position:absolute; 
    left:2px; 
    top:50%;
    transform:translateY(-50%);
    width:8px;
    height:8px;
    border-radius:50%;
    background:#ddd;
    cursor:pointer;
    z-index:10;
  }
  .flag-btn:hover { background:#999; }
  .flag-btn.active { background:#ff5722; }
  
  .group ol { margin-left:20px; }
  .group ol li { margin:12px 0; font-size:14px; line-height:1.6; position:relative; }
  .group ol li label { display:inline-block; margin-right:8px; }
  
  .bottom-bar { display:flex; gap:10px; margin-top:16px; }
  button { padding:10px 20px; border:1px solid #999; border-radius:6px; background:#fff; cursor:pointer; font-size:14px; }
  button:hover { background:#f0f0f0; }
  .btn-primary { background:#0066cc; color:#fff; border-color:#0066cc; }
  .btn-primary:hover { background:#0052a3; }
  .btn-danger { background:#dc3545; color:#fff; border-color:#dc3545; }
  .btn-danger:hover { background:#c82333; }
  
  .hl { background:#fff59d; cursor:pointer; }
  .hl:hover { background:#ffeb3b; }
  .note { background:#b3d9ff; cursor:pointer; }
  .note:hover { background:#99ccff; }
  
  #selbar { position:fixed; display:none; z-index:2000; background:#fff; border:1px solid #ddd; border-radius:8px; padding:8px; gap:0; box-shadow:0 2px 8px rgba(0,0,0,0.15); flex-direction:column; min-width:120px; }
  #selbar button { background:#fff; color:#666; border:none; padding:3px 0px; cursor:pointer; font-size:14px; text-align:center; border-radius:4px; }
  #selbar button:hover { background:#f5f5f5; color:#333; }
  
  .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:3000; align-items:center; justify-content:center; }
  .modal.active { display:flex; }
  .modal-content { background:#fff; border-radius:8px; padding:24px; max-width:600px; width:90%; max-height:80vh; overflow-y:auto; }
  
  .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
  .modal-header h2 { font-size: 28px; color: #333; margin: 0; }
  .modal-close { font-size: 32px; cursor: pointer; color: #999; line-height: 1; }
  .modal-close:hover { color: #333; }
  
  .result-summary { text-align:center; padding:20px; background:#f0f0f0; margin-bottom:16px; border-radius:6px; }
  .result-score { font-size:36px; font-weight:600; color:#0066cc; }
  .result-item { padding:10px; margin:8px 0; border-left:3px solid #ddd; background:#f9f9f9; font-size:13px; }
  .result-item.correct { border-left-color:#28a745; background:#e8f5e9; }
  .result-item.incorrect { border-left-color:#dc3545; background:#ffebee; }
  
  .wrong-item { background:#fff3e0; padding:16px; margin:8px 0; border-radius:8px; border-left:4px solid #ff9800; display:flex; justify-content:space-between; align-items:start; }
  .wrong-item-content { flex:1; }
  .btn-delete { background:#dc3545; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-size:13px; margin-left:12px; }
  .btn-delete:hover { background:#c82333; }
  .modal-actions { display:flex; gap:10px; margin-bottom:20px; }
  
  input[type="text"] { width:200px; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:14px; }
</style>
</head>
<body>
<div id="timer">00:00</div>

<div class="shell">
  <section class="pane" id="left">
    
<h2>READING PASSAGE 2</h2>
<p>You should spend about 20 minutes on Questions 14‚Äì26, which are based on Reading Passage 2 below.</p>
<h3>Urban Regeneration: an award-winning redevelopment project in Berlin</h3>

<h4>Paragraph A</h4>
<p>Just over a kilometer south of Berlin's Potsdamer Platz, near the left bank of the Landwehr Canal, an extensive, triangular-shaped area of waste ground once separated the neighbourhoods of Kreuzberg to the east and Sch√∂neberg to the west. Known as Gleisdreieck, meaning 'triangle of rails', it was formed by the intersection of different railway lines built in the mid-nineteenth century that entered Berlin from the south. Tracks, sheds and warehouses belonging to three old railway stations ‚Äì Dresdner Bahnhof (1875-1882), Potsdamer Bahnhof (1838-1944) and Anhalter Bahnhof (1839-1952) ‚Äì are situated on a raised area some twenty hectares in size, at a height of four metres above the surrounding ground level.</p>

<h4>Paragraph B</h4>
<p>As the railway infrastructure gradually ceased to be used, the whole area of Gleisdreieck became increasingly run down and abandoned, to the point of being used as a rubbish tip after 1945. Meanwhile, vegetation took over, turning it into a surprising, natural haven in the middle of built-up areas. The closeness of the wall which divided the city of Berlin between 1961 and 1990 also contributed to the fact that Gleisdreieck was for decades clearly identified as no-man's-land. Only a station of the same name in Berlin's underground railway system testified to its existence. Shortly before the fall of the Berlin Wall, however, the German Museum of Technology was established there, attracting large numbers of visitors and giving visibility to the site. More importantly, the unification of the formerly divided city gave the zone more centrality, at which point it became imperative to identify a purpose for it.</p>

<h4>Paragraph C</h4>
<p>After 2006, the State of Berlin put forward the proposal of converting Gleisdreieck into a large urban park that would integrate the different urban zones which converged there. The decades-long isolation of the site, which had formerly presented a problem, now represented an opportunity for joining the southern area of Potsdamer Platz with Kreuzberg and Sch√∂neberg. The creation of the park would trigger one of the biggest urban expansions inside Berlin, all within a framework of multiple uses and social characteristics. It was necessary to stimulate the development of sixteen new hectares of local amenities that would be capable of integrating different generations and social groups in a sustainable way, and in harmony with nature. Following intense discussion with local proprietors and residents, the need to reconcile these goals with the conservation of railway heritage also emerged.</p>

<h4>Paragraph D</h4>
<p>Once the area had been subjected to a process of undergrowth clearance and decontamination, it was then organized around a combination of existing and added elements. The project as a whole was planned around a large central meadow, intersected from east to west by a concrete footpath, and from north to south by a pair of railway lines. Once a month, a train slowly travels along these lines from its parking shed to the German Museum of Technology. The concrete footpath, which is a continuation of one of the main Kreuzberg boulevards, starts in the east, bridges the four-metre difference in ground level by means of a stairway, and suddenly ends in the west on reaching the underground lines.</p>

<h4>Paragraph E</h4>
<p>North of the meadow, there is a large concrete slab with rounded edges. Being south-facing, this functions as a big sunny terrace, full of benches complete with footrests. In the south, the meadow overlooks Yorckstrasse, an underpass crossed by more than fifteen former railway bridges. To the east of the meadow there is quite a dense forest of pre-existing maples, oaks and birches, as well as newly planted trees of the same species. In this area, a couple of large metal frames each hold two swings. The edges of the park are finished with a collection of distinctive, functional spaces, for example a nursery, sports fields, concave surfaces for skateboards, stages for dancing, community gardens, or simply areas covered in gravel obtained from the site itself.</p>

<h4>Paragraph F</h4>
<p>Although initially the regeneration of Gleisdreieck Park was the subject of disagreement between those who were in favour of safeguarding the railway heritage and those who wanted to regenerate the adjacent neighbourhoods, it was opened to the public in September 2011. The heart of Berlin now has a new green lung, in which the atmosphere of various small, very different corners fits neatly into a large-scale, wide-ranging and robust general order. This has been possible precisely because the intervention was not limited to conserving industrial remains in order to promote railway history. And as a reminder of the six decades of human absence, during which nature took over, the park has been able to conserve to some extent the spirit of the non-place that preceded it.</p>

  </section>

  <div id="divider" title="Drag to resize"></div>

  <section class="pane" id="right">
    <h3>Questions</h3>

    <div class="group">
      <h4>Questions 14‚Äì19</h4>
      <p>Reading Passage 2 has six paragraphs, A‚ÄìF.</p>
      <p>Choose the correct heading for each paragraph from the list of headings below.</p>
      <p>Write the correct number, <strong>i‚Äìviii</strong>, in boxes <strong>14‚Äì19</strong> on your answer sheet.</p>

      <div class="headings">
        <strong>List of Headings</strong>
        <ol type="i">
          <li>Objectives of the regeneration project</li>
          <li>Architectural details of the station buildings</li>
          <li>Features and facilities of the completed development</li>
          <li>The remains of a railway system</li>
          <li>A positive evaluation of the finished project</li>
          <li>A way of controlling development costs</li>
          <li>Ways of crossing the site</li>
          <li>Reasons why the area had become neglected</li>
        </ol>
      </div>

      <ol start="14">
        <li><span class="flag-btn" data-q="q14" style="left:-20px;"></span>Paragraph A<br>
          <label><input type="radio" name="q14" value="i"> i</label>
          <label><input type="radio" name="q14" value="ii"> ii</label>
          <label><input type="radio" name="q14" value="iii"> iii</label>
          <label><input type="radio" name="q14" value="iv"> iv</label>
          <label><input type="radio" name="q14" value="v"> v</label>
          <label><input type="radio" name="q14" value="vi"> vi</label>
          <label><input type="radio" name="q14" value="vii"> vii</label>
          <label><input type="radio" name="q14" value="viii"> viii</label>
        </li>
        <li><span class="flag-btn" data-q="q15" style="left:-20px;"></span>Paragraph B<br>
          <label><input type="radio" name="q15" value="i"> i</label>
          <label><input type="radio" name="q15" value="ii"> ii</label>
          <label><input type="radio" name="q15" value="iii"> iii</label>
          <label><input type="radio" name="q15" value="iv"> iv</label>
          <label><input type="radio" name="q15" value="v"> v</label>
          <label><input type="radio" name="q15" value="vi"> vi</label>
          <label><input type="radio" name="q15" value="vii"> vii</label>
          <label><input type="radio" name="q15" value="viii"> viii</label>
        </li>
        <li><span class="flag-btn" data-q="q16" style="left:-20px;"></span>Paragraph C<br>
          <label><input type="radio" name="q16" value="i"> i</label>
          <label><input type="radio" name="q16" value="ii"> ii</label>
          <label><input type="radio" name="q16" value="iii"> iii</label>
          <label><input type="radio" name="q16" value="iv"> iv</label>
          <label><input type="radio" name="q16" value="v"> v</label>
          <label><input type="radio" name="q16" value="vi"> vi</label>
          <label><input type="radio" name="q16" value="vii"> vii</label>
          <label><input type="radio" name="q16" value="viii"> viii</label>
        </li>
        <li><span class="flag-btn" data-q="q17" style="left:-20px;"></span>Paragraph D<br>
          <label><input type="radio" name="q17" value="i"> i</label>
          <label><input type="radio" name="q17" value="ii"> ii</label>
          <label><input type="radio" name="q17" value="iii"> iii</label>
          <label><input type="radio" name="q17" value="iv"> iv</label>
          <label><input type="radio" name="q17" value="v"> v</label>
          <label><input type="radio" name="q17" value="vi"> vi</label>
          <label><input type="radio" name="q17" value="vii"> vii</label>
          <label><input type="radio" name="q17" value="viii"> viii</label>
        </li>
        <li><span class="flag-btn" data-q="q18" style="left:-20px;"></span>Paragraph E<br>
          <label><input type="radio" name="q18" value="i"> i</label>
          <label><input type="radio" name="q18" value="ii"> ii</label>
          <label><input type="radio" name="q18" value="iii"> iii</label>
          <label><input type="radio" name="q18" value="iv"> iv</label>
          <label><input type="radio" name="q18" value="v"> v</label>
          <label><input type="radio" name="q18" value="vi"> vi</label>
          <label><input type="radio" name="q18" value="vii"> vii</label>
          <label><input type="radio" name="q18" value="viii"> viii</label>
        </li>
        <li><span class="flag-btn" data-q="q19" style="left:-20px;"></span>Paragraph F<br>
          <label><input type="radio" name="q19" value="i"> i</label>
          <label><input type="radio" name="q19" value="ii"> ii</label>
          <label><input type="radio" name="q19" value="iii"> iii</label>
          <label><input type="radio" name="q19" value="iv"> iv</label>
          <label><input type="radio" name="q19" value="v"> v</label>
          <label><input type="radio" name="q19" value="vi"> vi</label>
          <label><input type="radio" name="q19" value="vii"> vii</label>
          <label><input type="radio" name="q19" value="viii"> viii</label>
        </li>
      </ol>
    </div>

    <div class="group">
      <h4>Questions 20 and 21</h4>
      <p>Choose <strong>TWO</strong> letters A‚ÄìE.</p>
      <p>Write the correct letters in boxes <strong>20 and 21</strong> on your answer sheet.</p>
      <p>Which <strong>TWO</strong> reasons are given for the choice of Gleisdreieck as a site for a park?</p>

      <div style="margin:12px 0;">
        <div style="margin:8px 0;"><span class="flag-btn" data-q="q20" style="position:relative;display:inline-block;width:auto;height:auto;transform:none;vertical-align:middle;"></span><label><input type="checkbox" name="q20" value="A"> <strong>A</strong> It was a habitat for some rare wildlife species.</label></div>
        <div style="margin:8px 0;"><span class="flag-btn" data-q="q20" style="position:relative;display:inline-block;width:auto;height:auto;transform:none;vertical-align:middle;"></span><label><input type="checkbox" name="q20" value="B"> <strong>B</strong> It contained a particular tourist attraction.</label></div>
        <div style="margin:8px 0;"><span class="flag-btn" data-q="q20" style="position:relative;display:inline-block;width:auto;height:auto;transform:none;vertical-align:middle;"></span><label><input type="checkbox" name="q20" value="C"> <strong>C</strong> It lay at the heart of the reunited city.</label></div>
        <div style="margin:8px 0;"><span class="flag-btn" data-q="q20" style="position:relative;display:inline-block;width:auto;height:auto;transform:none;vertical-align:middle;"></span><label><input type="checkbox" name="q20" value="D"> <strong>D</strong> It was served by a major rail network.</label></div>
        <div style="margin:8px 0;"><span class="flag-btn" data-q="q20" style="position:relative;display:inline-block;width:auto;height:auto;transform:none;vertical-align:middle;"></span><label><input type="checkbox" name="q20" value="E"> <strong>E</strong> It contained buildings which could be easily converted.</label></div>
      </div>
    </div>

    <div class="group">
      <h4>Questions 22 and 23</h4>
      <p>Choose <strong>TWO</strong> letters A‚ÄìE.</p>
      <p>Write the correct letters in boxes <strong>22 and 23</strong> on your answer sheet.</p>
      <p>The list below identifies some of the possible aims of urban redevelopment projects.</p>
      <p>Which <strong>TWO</strong> things did the State of Berlin hope to achieve with the Gleisdreieck development?</p>

      <div style="margin:12px 0;">
        <div style="margin:8px 0;"><span class="flag-btn" data-q="q22" style="position:relative;display:inline-block;width:auto;height:auto;transform:none;vertical-align:middle;"></span><label><input type="checkbox" name="q22" value="A"> <strong>A</strong> to bring people of different ages together</label></div>
        <div style="margin:8px 0;"><span class="flag-btn" data-q="q22" style="position:relative;display:inline-block;width:auto;height:auto;transform:none;vertical-align:middle;"></span><label><input type="checkbox" name="q22" value="B"> <strong>B</strong> to encourage tourism</label></div>
        <div style="margin:8px 0;"><span class="flag-btn" data-q="q22" style="position:relative;display:inline-block;width:auto;height:auto;transform:none;vertical-align:middle;"></span><label><input type="checkbox" name="q22" value="C"> <strong>C</strong> to improve transport links</label></div>
        <div style="margin:8px 0;"><span class="flag-btn" data-q="q22" style="position:relative;display:inline-block;width:auto;height:auto;transform:none;vertical-align:middle;"></span><label><input type="checkbox" name="q22" value="D"> <strong>D</strong> to preserve industrial remains</label></div>
        <div style="margin:8px 0;"><span class="flag-btn" data-q="q22" style="position:relative;display:inline-block;width:auto;height:auto;transform:none;vertical-align:middle;"></span><label><input type="checkbox" name="q22" value="E"> <strong>E</strong> to generate income for the city</label></div>
      </div>
    </div>

    <div class="group">
      <h4>Questions 24‚Äì26</h4>
      <p>Complete the summary below.</p>
      <p>Choose <strong>ONE WORD ONLY</strong> from the passage for each answer.</p>
      <p>Write your answers in boxes <strong>24‚Äì26</strong> on your answer sheet.</p>

      <p style="margin:16px 0;">In the middle of the new park is a <input type="text" name="q24">, where there is a path for pedestrians and two railway lines. A slow train uses these lines to make a regular journey between its base and a <input type="text" name="q25">. Benches have been provided on the north side, so that people can relax and enjoy the sunshine, and to the east is an area with mature trees of various kinds, as well as sets of swings. A range of sports and leisure areas are situated around the <input type="text" name="q26"> of the site.</p>
    </div>

    <div class="bottom-bar">
      <button class="btn-primary" onclick="submitAnswers()">Êèê‰∫§</button>
      <button onclick="resetForm()">ÈáçÁΩÆ</button>
      <button onclick="openWrongBook()">Êú¨ÁØáÈîôÈ¢ò</button>
    </div>
  </section>
</div>

<div id="selbar">
  <button id="btnNote">Note</button>
  <button id="btnHL">Highlight</button>
  <button id="btnUH" style="display:none;">Clear Highlight</button>
</div>

<div class="modal" id="resultModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ÊàêÁª©</h2>
      <span class="modal-close" onclick="closeModal('resultModal')">√ó</span>
    </div>
    <div id="resultContent"></div>
    <button class="btn-primary" style="width:100%; margin-top:16px;" onclick="addWrongToBook()">Âä†ÂÖ•ÈîôÈ¢òÊú¨</button>
  </div>
</div>

<div class="modal" id="wrongBookModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Êú¨ÁØáÈîôÈ¢ò</h2>
      <span class="modal-close" onclick="closeModal('wrongBookModal')">√ó</span>
    </div>
    <div id="wrongBookContent"></div>
  </div>
</div>

<div class="modal" id="resetModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ÈáçÁΩÆÁªÉ‰π†</h2>
      <span class="modal-close" onclick="closeModal('resetModal')">√ó</span>
    </div>
    <div style="margin:16px 0;">
      <label style="display:block; margin-bottom:10px;">
        <input type="radio" name="resetType" value="answers" checked>
        Âè™Ê∏ÖÁ©∫Á≠îÊ°à
      </label>
      <label style="display:block;">
        <input type="radio" name="resetType" value="all">
        Ê∏ÖÁ©∫Á≠îÊ°àÂíåÊ†áËÆ∞
      </label>
    </div>
    <button class="btn-primary" style="width:100%;" onclick="confirmReset()">Á°ÆÂÆö</button>
  </div>
</div>

<script>
const PAPER_ID='P2_URBAN_REGENERATION';

let t=0;
const timerEl=document.getElementById('timer');
setInterval(()=>{ t++; timerEl.textContent=String(Math.floor(t/60)).padStart(2,'0')+':'+String(t%60).padStart(2,'0'); }, 1000);

const divider=document.getElementById('divider'), left=document.getElementById('left'), right=document.getElementById('right');
let dragging=false;
divider.onmousedown=()=>{ dragging=true; document.body.style.cursor='ew-resize'; };
window.onmousemove=(e)=>{ if(!dragging)return; const c=document.querySelector('.shell').getBoundingClientRect(); let x=e.clientX-c.left; x=Math.max(280,Math.min(c.width-280,x)); left.style.flex='0 0 '+x+'px'; right.style.flex='1 1 auto'; };
window.onmouseup=()=>{ dragging=false; document.body.style.cursor=''; };

const selbar=document.getElementById('selbar'), btnHL=document.getElementById('btnHL'), btnUH=document.getElementById('btnUH'), btnNote=document.getElementById('btnNote');
let lastRange=null, currentHlNode=null;

function posSelbar(r){ selbar.style.display='flex'; const t=window.scrollY+r.top-selbar.offsetHeight-8; const l=window.scrollX+r.left+r.width/2-selbar.offsetWidth/2; selbar.style.top=((t>0)?t:(window.scrollY+r.bottom+8))+'px'; selbar.style.left=Math.max(8,l)+'px'; }

function updSel(){ const s=window.getSelection(); if(!s||s.rangeCount===0||s.isCollapsed){ if(!currentHlNode)selbar.style.display='none'; return; } const r=s.getRangeAt(0); lastRange=r.cloneRange(); currentHlNode=null; btnNote.style.display='block'; btnHL.style.display='block'; btnUH.style.display='none'; posSelbar(r.getBoundingClientRect()); }

left.onmouseup=updSel; right.onmouseup=updSel;
document.onselectionchange=()=>{ const s=window.getSelection(); if((!s||s.rangeCount===0||s.isCollapsed)&&!currentHlNode)selbar.style.display='none'; };
document.addEventListener('click',(e)=>{ if(e.target.classList&&(e.target.classList.contains('hl')||e.target.classList.contains('note'))){ currentHlNode=e.target; lastRange=null; btnNote.style.display='none'; btnHL.style.display='none'; btnUH.style.display='block'; posSelbar(e.target.getBoundingClientRect()); const s=window.getSelection(); if(s)s.removeAllRanges(); }}, true);

btnHL.onclick=()=>{ if(currentHlNode||!lastRange||lastRange.collapsed)return; const s=document.createElement('span'); s.className='hl'; try{ lastRange.surroundContents(s); }catch(e){ const w=document.createElement('span'); w.className='hl'; w.appendChild(lastRange.cloneContents()); lastRange.deleteContents(); lastRange.insertNode(w); } selbar.style.display='none'; saveHighlights(); };

btnNote.onclick=()=>{ if(currentHlNode||!lastRange||lastRange.collapsed)return; const s=document.createElement('span'); s.className='note'; try{ lastRange.surroundContents(s); }catch(e){ const w=document.createElement('span'); w.className='note'; w.appendChild(lastRange.cloneContents()); lastRange.deleteContents(); lastRange.insertNode(w); } selbar.style.display='none'; saveHighlights(); };

btnUH.onclick=()=>{ if(currentHlNode){ const p=currentHlNode.parentNode; while(currentHlNode.firstChild)p.insertBefore(currentHlNode.firstChild,currentHlNode); p.removeChild(currentHlNode); p.normalize(); currentHlNode=null; selbar.style.display='none'; saveHighlights(); }};

document.querySelectorAll('.flag-btn').forEach(btn => {
  btn.onclick = e => {
    e.stopPropagation();
    btn.classList.toggle('active');
    saveFlags();
  };
});

const answerKey={
  q14:"iv",q15:"viii",q16:"i",q17:"vii",q18:"iii",q19:"v",
  q20:["B","C"],
  q22:["A","D"],
  q24:"meadow",q25:"museum",q26:"edges"
};
let lastResults=[];

function saveAnswers() {
  const data = {};
  
  document.querySelectorAll('input[type="text"]').forEach(input => {
    if(input.name && input.value.trim()) {
      data[input.name] = input.value.trim().toLowerCase();
    }
  });
  
  Object.keys(answerKey).forEach(q => {
    if(q === 'q20' || q === 'q22') {
      const checked = [...document.querySelectorAll(`input[name="${q}"]:checked`)].map(cb => cb.value);
      if(checked.length > 0) data[q] = checked;
    } else if(q.startsWith('q14') || q.startsWith('q15') || q.startsWith('q16') || q.startsWith('q17') || q.startsWith('q18') || q.startsWith('q19')) {
      const ch = document.querySelector(`input[name="${q}"]:checked`);
      if(ch) data[q] = ch.value;
    }
  });
  
  localStorage.setItem(`${PAPER_ID}_answers`, JSON.stringify(data));
}

function loadAnswers() {
  const data = JSON.parse(localStorage.getItem(`${PAPER_ID}_answers`) || '{}');
  
  Object.keys(data).forEach(qid => {
    const value = data[qid];
    
    if(Array.isArray(value)) {
      value.forEach(v => {
        const cb = document.querySelector(`input[name="${qid}"][value="${v}"]`);
        if(cb) cb.checked = true;
      });
    } else {
      const input = document.querySelector(`input[name="${qid}"]`);
      if(input && input.type === 'text') {
        input.value = value;
      }
      
      const radio = document.querySelector(`input[name="${qid}"][value="${value}"]`);
      if(radio) radio.checked = true;
    }
  });
}

function saveFlags() {
  const flags = [...document.querySelectorAll('.flag-btn.active')].map(b => b.dataset.q);
  localStorage.setItem(`${PAPER_ID}_flags`, JSON.stringify(flags));
}

function loadFlags() {
  const flags = JSON.parse(localStorage.getItem(`${PAPER_ID}_flags`) || '[]');
  flags.forEach(q => document.querySelector(`[data-q="${q}"]`)?.classList.add('active'));
}

function saveHighlights() {
  const highlights = { left: [], right: [] };
  ['left','right'].forEach(pane=>{
    document.querySelectorAll(`#${pane} .hl, #${pane} .note`).forEach((el,idx)=>{
      highlights[pane].push({
        type: el.classList.contains('hl') ? 'hl' : 'note',
        text: el.textContent,
        index: idx
      });
    });
  });
  localStorage.setItem(`${PAPER_ID}_highlights`, JSON.stringify(highlights));
}
function loadHighlights() {
  const data = JSON.parse(localStorage.getItem(`${PAPER_ID}_highlights`) || '{"left":[],"right":[]}');
  ['left','right'].forEach(pane=>{
    if(!data[pane]) return;
    data[pane].forEach(item=>{
      const walker = document.createTreeWalker(document.getElementById(pane), NodeFilter.SHOW_TEXT);
      let node;
      while(node = walker.nextNode()){
        const idx = node.textContent.indexOf(item.text);
        if(idx === -1) continue;
        const parent = node.parentNode;
        const before = node.textContent.substring(0, idx);
        const match  = node.textContent.substring(idx, idx + item.text.length);
        const after  = node.textContent.substring(idx + item.text.length);

        parent.insertBefore(document.createTextNode(before), node);
        const span = document.createElement('span');
        span.className = item.type;
        span.textContent = match;
        parent.insertBefore(span, node);
        parent.insertBefore(document.createTextNode(after), node);
        parent.removeChild(node);
        break;
      }
    });
  });
}

document.querySelectorAll('input[type="text"]').forEach(input => {
  input.addEventListener('input', saveAnswers);
});

document.querySelectorAll('input[type="radio"]').forEach(radio => {
  radio.addEventListener('change', saveAnswers);
});

document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
  cb.addEventListener('change', saveAnswers);
});

document.addEventListener('DOMContentLoaded', () => {
  loadAnswers();
  loadFlags();
  loadHighlights();
});

function submitAnswers(){ 
  const res=[]; 
  let cor=0; 
  
  Object.keys(answerKey).forEach(q=>{ 
    let uA = "";
    let cA = answerKey[q];
    let iC = false;
    
    if(q === 'q20' || q === 'q22') {
      const checked = [...document.querySelectorAll(`input[name="${q}"]:checked`)].map(cb => cb.value).sort();
      uA = checked.join(',');
      const correct = [...cA].sort();
      iC = checked.length === correct.length && checked.every((v, i) => v === correct[i]);
      cA = correct.join(',');
    } else {
      const input = document.querySelector(`input[name="${q}"]`);
      if(input && input.type === 'text' && input.value.trim()) {
        uA = input.value.trim().toLowerCase();
      }
      
      const ch = document.querySelector(`input[name="${q}"]:checked`);
      if(ch) uA = ch.value;
      
      iC = uA === cA || (typeof cA === 'string' && uA.toLowerCase() === cA.toLowerCase());
    }
    
    if(iC) cor++; 
    res.push({id:q, userAns:uA, correctAns:cA, isCorrect:iC}); 
  }); 
  
  lastResults=res; 
  const tot=Object.keys(answerKey).length; 
  const pct=((cor/tot)*100).toFixed(1); 
  localStorage.setItem(`ielts_score_${PAPER_ID}`, `${cor}/${tot}`);
  document.getElementById('resultContent').innerHTML=`<div class="result-summary"><div class="result-score">${cor} / ${tot}</div><div style="margin-top:8px;font-size:18px;">${pct}%</div></div>${res.map(r=>`<div class="result-item ${r.isCorrect?'correct':'incorrect'}"><div><strong>${r.id}</strong> ${r.isCorrect?'‚úì':'‚úó'}</div><div>‰Ω†ÁöÑÁ≠îÊ°à: ${r.userAns||'(Êú™‰ΩúÁ≠î)'}</div>${!r.isCorrect?`<div>Ê≠£Á°ÆÁ≠îÊ°à: ${r.correctAns}</div>`:''}</div>`).join('')}`; 
  document.getElementById('resultModal').classList.add('active'); 
}

function resetForm(){ 
  document.getElementById('resetModal').classList.add('active'); 
}

function confirmReset(){ 
  const tp=document.querySelector('input[name="resetType"]:checked').value; 
  
  document.querySelectorAll('input[type="text"]').forEach(i=>i.value=''); 
  document.querySelectorAll('input[type="radio"]').forEach(i=>i.checked=false); 
  document.querySelectorAll('input[type="checkbox"]').forEach(i=>i.checked=false);
  localStorage.removeItem(`${PAPER_ID}_answers`);
  
  if(tp==='all'){ 
    document.querySelectorAll('.hl').forEach(el=>{ const p=el.parentNode; while(el.firstChild)p.insertBefore(el.firstChild,el); p.removeChild(el); p.normalize(); }); 
    document.querySelectorAll('.note').forEach(el=>{ const p=el.parentNode; while(el.firstChild)p.insertBefore(el.firstChild,el); p.removeChild(el); p.normalize(); }); 
    document.querySelectorAll('.flag-btn').forEach(b => b.classList.remove('active'));
    localStorage.removeItem(`${PAPER_ID}_highlights`);
    localStorage.removeItem(`${PAPER_ID}_flags`);
  } 
  closeModal('resetModal'); 
}

function addWrongToBook(){ 
  const wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); 
  const wr=lastResults.filter(r=>!r.isCorrect); 
  wr.forEach(r=>{ 
    const en={paperId:PAPER_ID,title:'Urban Regeneration',questionId:r.id,correctAnswer:r.correctAns,myAnswer:r.userAns||'(Êú™‰ΩúÁ≠î)',date:new Date().toISOString().split('T')[0]}; 
    const ix=wb.findIndex(i=>i.paperId===en.paperId&&i.questionId===en.questionId); 
    if(ix>=0)wb[ix]=en; else wb.push(en); 
  }); 
  localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); 
  alert(`Â∑≤Ê∑ªÂä† ${wr.length} ÈÅìÈîôÈ¢ò`); 
  closeModal('resultModal'); 
}

function deleteWrongItem(pId,qId){ 
  if(!confirm('Á°ÆÂÆöÂà†Èô§ËøôÈÅìÈîôÈ¢òÔºü'))return; 
  let wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); 
  wb=wb.filter(i=>!(i.paperId===pId&&i.questionId===qId)); 
  localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); 
  openWrongBook(); 
}

function clearCurrentWrongBook(){ 
  if(!confirm('Á°ÆÂÆöÊ∏ÖÁ©∫Êú¨ÁØáÊâÄÊúâÈîôÈ¢òÔºü'))return; 
  let wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); 
  wb=wb.filter(i=>i.paperId!==PAPER_ID); 
  localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); 
  openWrongBook(); 
}

function openWrongBook(){ 
  const wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); 
  const cu=wb.filter(i=>i.paperId===PAPER_ID); 
  const ct=document.getElementById('wrongBookContent'); 
  if(cu.length===0)ct.innerHTML='<div style="text-align:center;padding:40px;color:#666;">ÊöÇÊó†ÈîôÈ¢ò</div>'; 
  else ct.innerHTML=`<div class="modal-actions"><button class="btn-danger" onclick="clearCurrentWrongBook()" style="width:100%;">üóëÔ∏è Ê∏ÖÁ©∫Êú¨ÁØáÈîôÈ¢ò</button></div>${cu.map(i=>`<div class="wrong-item"><div class="wrong-item-content"><div style="font-weight:600;margin-bottom:8px;">${i.questionId}</div><div style="font-size:13px;color:#666;"><div>‚úì Ê≠£Á°Æ: ${i.correctAnswer}</div><div style="color:#d32f2f;">‚úó ÊàëÁöÑ: ${i.myAnswer}</div></div></div><button class="btn-delete" onclick="deleteWrongItem('${i.paperId}','${i.questionId}')">Âà†Èô§</button></div>`).join('')}`; 
  document.getElementById('wrongBookModal').classList.add('active'); 
}

function closeModal(id){ 
  document.getElementById(id).classList.remove('active'); 
}
</script>
</body>
</html>
