<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>P2 ‚Äì Jellyfish ‚Äì The Dominant Species</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  * { box-sizing: border-box; margin:0; padding:0; }
  html,body { height:100%; }
  body { font-family: Arial, sans-serif; background:#f5f5f5; }
  
  #timer { position:fixed; top:12px; right:12px; background:#fff; border:1px solid #ddd; border-radius:6px; padding:8px 12px; font-size:16px; font-weight:600; color:#0066cc; z-index:1000; }
  
  .shell { display:flex; height:100vh; width:100%; }
  .pane { background:#fff; overflow:auto; padding:24px; }
  #left { flex: 0 0 50%; border-right:1px solid #ddd; }
  #right { flex: 1 1 auto; background:#fafafa; }
  #divider { flex: 0 0 5px; background:#ddd; cursor: ew-resize; }
  #divider:hover { background:#999; }
  
  h2,h3,h4 { margin:0 0 12px; color:#333; }
  h2 { font-size:20px; }
  h3 { font-size:18px; color:#0066cc; }
  h4 { font-size:15px; font-weight:600; margin-top:20px; }
  
  #left p { margin: 0 0 14px; line-height: 1.7; text-align:justify; }
  
  .group { background:#fff; border:1px solid #ddd; border-radius:6px; padding:16px; margin-bottom:16px; }
  .group h4 { margin-top:0; color:#0066cc; }
  .group p { margin:8px 0; font-size:14px; line-height:1.6; }
  
  .flag-btn { 
    position:absolute; 
    left:2px; 
    top:50%;
    transform:translateY(-50%);
    width:8px;
    height:8px;
    border-radius:50%;
    background:#ddd;
    cursor:pointer;
    z-index:10;
  }
  .flag-btn:hover { background:#999; }
  .flag-btn.active { background:#ff5722; }
  
  .group ol { margin-left:20px; }
  .group ol li { margin:12px 0; font-size:14px; line-height:1.6; position:relative; }
  .group ol li label { display:inline-block; margin-right:8px; }
  
  .bottom-bar { display:flex; gap:10px; margin-top:16px; }
  button { padding:10px 20px; border:1px solid #999; border-radius:6px; background:#fff; cursor:pointer; font-size:14px; }
  button:hover { background:#f0f0f0; }
  .btn-primary { background:#0066cc; color:#fff; border-color:#0066cc; }
  .btn-primary:hover { background:#0052a3; }
  .btn-danger { background:#dc3545; color:#fff; border-color:#dc3545; }
  .btn-danger:hover { background:#c82333; }
  
  .hl { background:#fff59d; cursor:pointer; }
  .hl:hover { background:#ffeb3b; }
  .note { background:#b3d9ff; cursor:pointer; }
  .note:hover { background:#99ccff; }
  
  #selbar { position:fixed; display:none; z-index:2000; background:#fff; border:1px solid #ddd; border-radius:8px; padding:8px; gap:0; box-shadow:0 2px 8px rgba(0,0,0,0.15); flex-direction:column; min-width:120px; }
  #selbar button { background:#fff; color:#666; border:none; padding:3px 0px; cursor:pointer; font-size:14px; text-align:center; border-radius:4px; }
  #selbar button:hover { background:#f5f5f5; color:#333; }
  
  .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:3000; align-items:center; justify-content:center; }
  .modal.active { display:flex; }
  .modal-content { background:#fff; border-radius:8px; padding:24px; max-width:600px; width:90%; max-height:80vh; overflow-y:auto; }
  
  .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
  .modal-header h2 { font-size: 28px; color: #333; margin: 0; }
  .modal-close { font-size: 32px; cursor: pointer; color: #999; line-height: 1; }
  .modal-close:hover { color: #333; }
  
  .result-summary { text-align:center; padding:20px; background:#f0f0f0; margin-bottom:16px; border-radius:6px; }
  .result-score { font-size:36px; font-weight:600; color:#0066cc; }
  .result-item { padding:10px; margin:8px 0; border-left:3px solid #ddd; background:#f9f9f9; font-size:13px; }
  .result-item.correct { border-left-color:#28a745; background:#e8f5e9; }
  .result-item.incorrect { border-left-color:#dc3545; background:#ffebee; }
  
  .wrong-item { background:#fff3e0; padding:16px; margin:8px 0; border-radius:8px; border-left:4px solid #ff9800; display:flex; justify-content:space-between; align-items:start; }
  .wrong-item-content { flex:1; }
  .btn-delete { background:#dc3545; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-size:13px; margin-left:12px; }
  .btn-delete:hover { background:#c82333; }
  .modal-actions { display:flex; gap:10px; margin-bottom:20px; }
  
  input[type="text"] { width:200px; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:14px; }
</style>
</head>
<body>
<div id="timer">00:00</div>

<div class="shell">
  <section class="pane" id="left">
    
<h2>READING PASSAGE 2</h2>
<p>You should spend about 20 minutes on Questions 14‚Äì26, which are based on Reading Passage 2 below.</p>
<h3>Jellyfish ‚Äì The Dominant Species</h3>

<h4>Paragraph A</h4>
<p>Jellyfish have become the curse of beach holidays, permeating every ocean on the globe, thriving in the Arctic and the tropics. In an ever-changing world where other species struggle to endure, jellyfish populations are on the rise.</p>
<p>To the untrained eye, these creatures drift aimlessly on the oceans' currents and appear benign. In addition, they lack sharp claws, piercing teeth or even a brain. Despite this, they are armed with an amazing arsenal of weapons, especially the stinging power of their tentacles. As a result, jellyfish are among the most-feared, least-understood creatures in the seas.</p>

<h4>Paragraph B</h4>
<p>According to Dr Monty Graham, a jellyfish scientist at the University of South Alabama, US, 'Jellyfish are a pretty good group of animals to track coastal ecosystems. When you start to see jellyfish numbers grow, that usually indicates a stressed system.' While populations appear to be down this year, Dr Graham sees 'a statistically solid increase' over the longer term.</p>
<p>This increase first gained attention in the 1980s when a huge number of jellyfish, Atlantic Ocean natives named Mnemiopsis leidyi, devastated the Black Sea, an ecosystem already weakened by overfishing of anchovies. Scientists believe that this species of jellyfish came in on the bottom of a ship and then rapidly multiplied, feeding on anchovy eggs and the plankton that young fish rely on.</p>

<h4>Paragraph C</h4>
<p>Dense jellyfish aggregations can be a natural feature of healthy ocean ecosystems, but a clear picture is now emerging of more severe and frequent jellyfish outbreaks worldwide. Dr Anthony Richardson, from the University of Queensland, Australia, explains that once jellyfish gain a foothold, if conditions are right, they can establish a massive population at the expense of other ocean life. The problem is that parts of the ocean might switch from being dominated by fish to being dominated by jellyfish.</p>

<h4>Paragraph D</h4>
<p>A study done by Richardson and his colleagues explores the causes behind jellyfish infestation, and the need for swift, decisive action to stem the jellyfish takeover. Jellyfish outbreaks are linked directly to human actions, including overfishing, the input of fertilizer and sewage into the ocean, and climate change.</p>
<p>Overfishing has removed fish from marine ecosystems at astounding rates. According to Richardson, this has made it possible for jellyfish to take their place. 'This is because small fish appear to keep jellyfish in check by predation (on jellyfish when they are very small) and competition (when feeding). So, once we remove fish, jellyfish can proliferate.'</p>
<p>Eutrophication is another human-caused change in the ocean that has likely contributed to jellyfish explosions. Eutrophication is an increase in nitrogen and phosphorus in the ocean, largely caused by fertilizer and waste run-off. This leads to algae blooms, which lower oxygen in the marine ecosystem, creating so-called 'dead zones', which have been increasing dramatically around the world. According to Richardson, these low-oxygen waters give jellyfish the advantage. 'Fish avoid low-oxygen waters but jellyfish, having lower oxygen demands, not only survive but can thrive in these conditions as there is less predation and competition from fish.'</p>

<h4>Paragraph E</h4>
<p>Furthermore, Richardson and his colleagues speculate that climate change may expand the traditional geographical range of jellyfish. 'As water warms, tropical species are moving towards the poles. Many venomous jellyfish species are tropical and could move into more densely populated subtropical and temperate regions.'</p>

<h4>Paragraph F</h4>
<p>Once jellyfish appear en masse in an ecosystem, they can make it very difficult for fish to stage a comeback. By feeding on fish, the jellyfish successfully prevent fish from returning to their normal population numbers, says Richardson. 'One can thus think of two alternate states with each being stable: one dominated by fish and the other by jellyfish. Unfortunately, where there is a jellyfish-dominated state then this does not support the nutritional needs of other fish, marine mammals, and seabirds.' In other words, an ecosystem that loses fish also loses the species that depend on fish for survival.</p>
<p>This state has been defined as a 'monoculture of jellyfish', an apt analogy since the situation shares similarities with other monocultures. When the rich biodiversity of tropical forests is replaced by plantations growing a single species of tree, an area of rich variety becomes a desert in terms of biodiversity, as do ocean ecosystems when jellyfish become the dominant species.</p>
<p>One result of large jellyfish populations is the economic effect it has had on the fishing industry. In the Gulf of Mexico, shrimp fishermen are struggling with a jellyfish boom that fills nets, causing them to break and resulting in millions of dollars in losses.</p>

<h4>Paragraph G</h4>
<p>Experts say that a greater understanding of jellyfish, including their ideal water temperature and feeding habits, is necessary to determine with certainty what is causing the recent massive invasion and to come up with ways to combat it.</p>
<p>Due to the difficulty of turning ecosystems around once jellyfish have become dominant, Richardson and his colleagues propose focusing on 'prevention rather than cure'. They recommend a halt to overfishing small fish that are vital to keeping jellyfish in check, reducing the amount of fertilizer and sewage running off into the oceans, and finally, if possible, confronting climate change.</p>

  </section>

  <div id="divider" title="Drag to resize"></div>

  <section class="pane" id="right">
    <h3>Questions</h3>

    <div class="group">
      <h4>Questions 14‚Äì17</h4>
      <p>Reading Passage 2 has seven sections, A‚ÄìG.</p>
      <p>Which paragraph contains the following information?</p>
      <p>Write the correct letter, <strong>A‚ÄìG</strong>, in boxes <strong>14‚Äì17</strong> on your answer sheet.</p>
      <p><strong>NB</strong> You may use any letter more than once.</p>

      <ol start="14">
        <li><span class="flag-btn" data-q="q14" style="left:-20px;"></span>a prediction as to the direction in which the jellyfish population may spread<br>
          <label><input type="radio" name="q14" value="A"> A</label>
          <label><input type="radio" name="q14" value="B"> B</label>
          <label><input type="radio" name="q14" value="C"> C</label>
          <label><input type="radio" name="q14" value="D"> D</label>
          <label><input type="radio" name="q14" value="E"> E</label>
          <label><input type="radio" name="q14" value="F"> F</label>
          <label><input type="radio" name="q14" value="G"> G</label>
        </li>
        <li><span class="flag-btn" data-q="q15" style="left:-20px;"></span>a description of some physical characteristics of jellyfish<br>
          <label><input type="radio" name="q15" value="A"> A</label>
          <label><input type="radio" name="q15" value="B"> B</label>
          <label><input type="radio" name="q15" value="C"> C</label>
          <label><input type="radio" name="q15" value="D"> D</label>
          <label><input type="radio" name="q15" value="E"> E</label>
          <label><input type="radio" name="q15" value="F"> F</label>
          <label><input type="radio" name="q15" value="G"> G</label>
        </li>
        <li><span class="flag-btn" data-q="q16" style="left:-20px;"></span>an account of the consequences of jellyfish as lone survivors<br>
          <label><input type="radio" name="q16" value="A"> A</label>
          <label><input type="radio" name="q16" value="B"> B</label>
          <label><input type="radio" name="q16" value="C"> C</label>
          <label><input type="radio" name="q16" value="D"> D</label>
          <label><input type="radio" name="q16" value="E"> E</label>
          <label><input type="radio" name="q16" value="F"> F</label>
          <label><input type="radio" name="q16" value="G"> G</label>
        </li>
        <li><span class="flag-btn" data-q="q17" style="left:-20px;"></span>suggestions on how to avoid further jellyfish invasions<br>
          <label><input type="radio" name="q17" value="A"> A</label>
          <label><input type="radio" name="q17" value="B"> B</label>
          <label><input type="radio" name="q17" value="C"> C</label>
          <label><input type="radio" name="q17" value="D"> D</label>
          <label><input type="radio" name="q17" value="E"> E</label>
          <label><input type="radio" name="q17" value="F"> F</label>
          <label><input type="radio" name="q17" value="G"> G</label>
        </li>
      </ol>
    </div>

    <div class="group">
      <h4>Questions 18 and 19</h4>
      <p>Choose <strong>TWO</strong> letters A‚ÄìE.</p>
      <p>Write the correct letters in boxes <strong>18 and 19</strong> on your answer sheet.</p>
      <p>The list below gives some effects that jellyfish have had on the world.</p>
      <p>Which <strong>TWO</strong> of these effects are mentioned by the writer of the text?</p>

      <div style="margin:12px 0;">
        <div style="margin:8px 0;"><span class="flag-btn" data-q="q18" style="position:relative;display:inline-block;width:auto;height:auto;transform:none;vertical-align:middle;"></span><label><input type="checkbox" name="q18" value="A"> <strong>A</strong> They have damaged the tourism industry in some areas.</label></div>
        <div style="margin:8px 0;"><span class="flag-btn" data-q="q18" style="position:relative;display:inline-block;width:auto;height:auto;transform:none;vertical-align:middle;"></span><label><input type="checkbox" name="q18" value="B"> <strong>B</strong> They have led to a reduction in the oceans' oxygen levels.</label></div>
        <div style="margin:8px 0;"><span class="flag-btn" data-q="q18" style="position:relative;display:inline-block;width:auto;height:auto;transform:none;vertical-align:middle;"></span><label><input type="checkbox" name="q18" value="C"> <strong>C</strong> They have contributed to the decline in the Black Sea anchovy population.</label></div>
        <div style="margin:8px 0;"><span class="flag-btn" data-q="q18" style="position:relative;display:inline-block;width:auto;height:auto;transform:none;vertical-align:middle;"></span><label><input type="checkbox" name="q18" value="D"> <strong>D</strong> They have caused the shrimp business in the Gulf of Mexico to shut down.</label></div>
        <div style="margin:8px 0;"><span class="flag-btn" data-q="q18" style="position:relative;display:inline-block;width:auto;height:auto;transform:none;vertical-align:middle;"></span><label><input type="checkbox" name="q18" value="E"> <strong>E</strong> They have created financial hardship in the fishing industry.</label></div>
      </div>
    </div>

    <div class="group">
      <h4>Questions 20 and 21</h4>
      <p>Choose <strong>TWO</strong> letters A‚ÄìE.</p>
      <p>Write the correct letters in boxes <strong>20 and 21</strong> on your answer sheet.</p>
      <p>Which <strong>TWO</strong> of the following are possible causes of an increase in jellyfish numbers?</p>

      <div style="margin:12px 0;">
        <div style="margin:8px 0;"><span class="flag-btn" data-q="q20" style="position:relative;display:inline-block;width:auto;height:auto;transform:none;vertical-align:middle;"></span><label><input type="checkbox" name="q20" value="A"> <strong>A</strong> a shortage of small fish in the oceans</label></div>
        <div style="margin:8px 0;"><span class="flag-btn" data-q="q20" style="position:relative;display:inline-block;width:auto;height:auto;transform:none;vertical-align:middle;"></span><label><input type="checkbox" name="q20" value="B"> <strong>B</strong> the dumping of chemicals into the oceans</label></div>
        <div style="margin:8px 0;"><span class="flag-btn" data-q="q20" style="position:relative;display:inline-block;width:auto;height:auto;transform:none;vertical-align:middle;"></span><label><input type="checkbox" name="q20" value="C"> <strong>C</strong> a decline in biodiversity in the oceans</label></div>
        <div style="margin:8px 0;"><span class="flag-btn" data-q="q20" style="position:relative;display:inline-block;width:auto;height:auto;transform:none;vertical-align:middle;"></span><label><input type="checkbox" name="q20" value="D"> <strong>D</strong> more competition among other fish in the oceans</label></div>
        <div style="margin:8px 0;"><span class="flag-btn" data-q="q20" style="position:relative;display:inline-block;width:auto;height:auto;transform:none;vertical-align:middle;"></span><label><input type="checkbox" name="q20" value="E"> <strong>E</strong> a decrease in seabird populations</label></div>
      </div>
    </div>

    <div class="group">
      <h4>Questions 22‚Äì26</h4>
      <p>Complete the sentences below.</p>
      <p>Write <strong>ONE WORD ONLY</strong> from the passage for each answer.</p>
      <p>Write your answers in boxes <strong>22‚Äì26</strong> on your answer sheet.</p>

      <ol start="22">
        <li style="margin:16px 0;"><span class="flag-btn" data-q="q22" style="left:-20px;"></span>Some fish in the oceans may be unable to sustain their population as the jellyfish eat their <input type="text" name="q22">.</li>
        <li style="margin:16px 0;"><span class="flag-btn" data-q="q23" style="left:-20px;"></span>The state of jellyfish becoming the main ocean species has been named <input type="text" name="q23">.</li>
        <li style="margin:16px 0;"><span class="flag-btn" data-q="q24" style="left:-20px;"></span>Increasing numbers of jellyfish can damage <input type="text" name="q24"> used for commercial fishing.</li>
        <li style="margin:16px 0;"><span class="flag-btn" data-q="q25" style="left:-20px;"></span>Understanding basic facts about jellyfish, such as the <input type="text" name="q25"> of the ocean which suits them best, may help control their numbers.</li>
        <li style="margin:16px 0;"><span class="flag-btn" data-q="q26" style="left:-20px;"></span>Richardson believes it is better to direct attention to <input type="text" name="q26">, instead of just trying to solve existing problems.</li>
      </ol>
    </div>

    <div class="bottom-bar">
      <button class="btn-primary" onclick="submitAnswers()">Êèê‰∫§</button>
      <button onclick="resetForm()">ÈáçÁΩÆ</button>
      <button onclick="openWrongBook()">Êú¨ÁØáÈîôÈ¢ò</button>
    </div>
  </section>
</div>

<div id="selbar">
  <button id="btnNote">Note</button>
  <button id="btnHL">Highlight</button>
  <button id="btnUH" style="display:none;">Clear Highlight</button>
</div>

<div class="modal" id="resultModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ÊàêÁª©</h2>
      <span class="modal-close" onclick="closeModal('resultModal')">√ó</span>
    </div>
    <div id="resultContent"></div>
    <button class="btn-primary" style="width:100%; margin-top:16px;" onclick="addWrongToBook()">Âä†ÂÖ•ÈîôÈ¢òÊú¨</button>
  </div>
</div>

<div class="modal" id="wrongBookModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Êú¨ÁØáÈîôÈ¢ò</h2>
      <span class="modal-close" onclick="closeModal('wrongBookModal')">√ó</span>
    </div>
    <div id="wrongBookContent"></div>
  </div>
</div>

<div class="modal" id="resetModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ÈáçÁΩÆÁªÉ‰π†</h2>
      <span class="modal-close" onclick="closeModal('resetModal')">√ó</span>
    </div>
    <div style="margin:16px 0;">
      <label style="display:block; margin-bottom:10px;">
        <input type="radio" name="resetType" value="answers" checked>
        Âè™Ê∏ÖÁ©∫Á≠îÊ°à
      </label>
      <label style="display:block;">
        <input type="radio" name="resetType" value="all">
        Ê∏ÖÁ©∫Á≠îÊ°àÂíåÊ†áËÆ∞
      </label>
    </div>
    <button class="btn-primary" style="width:100%;" onclick="confirmReset()">Á°ÆÂÆö</button>
  </div>
</div>

<script>
const PAPER_ID='P2_JELLYFISH';

let t=0;
const timerEl=document.getElementById('timer');
setInterval(()=>{ t++; timerEl.textContent=String(Math.floor(t/60)).padStart(2,'0')+':'+String(t%60).padStart(2,'0'); }, 1000);

const divider=document.getElementById('divider'), left=document.getElementById('left'), right=document.getElementById('right');
let dragging=false;
divider.onmousedown=()=>{ dragging=true; document.body.style.cursor='ew-resize'; };
window.onmousemove=(e)=>{ if(!dragging)return; const c=document.querySelector('.shell').getBoundingClientRect(); let x=e.clientX-c.left; x=Math.max(280,Math.min(c.width-280,x)); left.style.flex='0 0 '+x+'px'; right.style.flex='1 1 auto'; };
window.onmouseup=()=>{ dragging=false; document.body.style.cursor=''; };

const selbar=document.getElementById('selbar'), btnHL=document.getElementById('btnHL'), btnUH=document.getElementById('btnUH'), btnNote=document.getElementById('btnNote');
let lastRange=null, currentHlNode=null;

function posSelbar(r){ selbar.style.display='flex'; const t=window.scrollY+r.top-selbar.offsetHeight-8; const l=window.scrollX+r.left+r.width/2-selbar.offsetWidth/2; selbar.style.top=((t>0)?t:(window.scrollY+r.bottom+8))+'px'; selbar.style.left=Math.max(8,l)+'px'; }

function updSel(){ const s=window.getSelection(); if(!s||s.rangeCount===0||s.isCollapsed){ if(!currentHlNode)selbar.style.display='none'; return; } const r=s.getRangeAt(0); lastRange=r.cloneRange(); currentHlNode=null; btnNote.style.display='block'; btnHL.style.display='block'; btnUH.style.display='none'; posSelbar(r.getBoundingClientRect()); }

left.onmouseup=updSel; right.onmouseup=updSel;
document.onselectionchange=()=>{ const s=window.getSelection(); if((!s||s.rangeCount===0||s.isCollapsed)&&!currentHlNode)selbar.style.display='none'; };
document.addEventListener('click',(e)=>{ if(e.target.classList&&(e.target.classList.contains('hl')||e.target.classList.contains('note'))){ currentHlNode=e.target; lastRange=null; btnNote.style.display='none'; btnHL.style.display='none'; btnUH.style.display='block'; posSelbar(e.target.getBoundingClientRect()); const s=window.getSelection(); if(s)s.removeAllRanges(); }}, true);

btnHL.onclick=()=>{ if(currentHlNode||!lastRange||lastRange.collapsed)return; const s=document.createElement('span'); s.className='hl'; try{ lastRange.surroundContents(s); }catch(e){ const w=document.createElement('span'); w.className='hl'; w.appendChild(lastRange.cloneContents()); lastRange.deleteContents(); lastRange.insertNode(w); } selbar.style.display='none'; saveHighlights(); };

btnNote.onclick=()=>{ if(currentHlNode||!lastRange||lastRange.collapsed)return; const s=document.createElement('span'); s.className='note'; try{ lastRange.surroundContents(s); }catch(e){ const w=document.createElement('span'); w.className='note'; w.appendChild(lastRange.cloneContents()); lastRange.deleteContents(); lastRange.insertNode(w); } selbar.style.display='none'; saveHighlights(); };

btnUH.onclick=()=>{ if(currentHlNode){ const p=currentHlNode.parentNode; while(currentHlNode.firstChild)p.insertBefore(currentHlNode.firstChild,currentHlNode); p.removeChild(currentHlNode); p.normalize(); currentHlNode=null; selbar.style.display='none'; saveHighlights(); }};

document.querySelectorAll('.flag-btn').forEach(btn => {
  btn.onclick = e => {
    e.stopPropagation();
    btn.classList.toggle('active');
    saveFlags();
  };
});

const answerKey={
  q14:"E",q15:"A",q16:"F",q17:"G",
  q18:["C","E"],
  q20:["A","B"],
  q22:"eggs",q23:"monoculture",q24:"nets",q25:"temperature",q26:"prevention"
};
let lastResults=[];

function saveAnswers() {
  const data = {};
  
  document.querySelectorAll('input[type="text"]').forEach(input => {
    if(input.name && input.value.trim()) {
      data[input.name] = input.value.trim().toLowerCase();
    }
  });
  
  Object.keys(answerKey).forEach(q => {
    if(q === 'q18' || q === 'q20') {
      const checked = [...document.querySelectorAll(`input[name="${q}"]:checked`)].map(cb => cb.value);
      if(checked.length > 0) data[q] = checked;
    } else if(q.startsWith('q14') || q.startsWith('q15') || q.startsWith('q16') || q.startsWith('q17')) {
      const ch = document.querySelector(`input[name="${q}"]:checked`);
      if(ch) data[q] = ch.value;
    }
  });
  
  localStorage.setItem(`${PAPER_ID}_answers`, JSON.stringify(data));
}

function loadAnswers() {
  const data = JSON.parse(localStorage.getItem(`${PAPER_ID}_answers`) || '{}');
  
  Object.keys(data).forEach(qid => {
    const value = data[qid];
    
    if(Array.isArray(value)) {
      value.forEach(v => {
        const cb = document.querySelector(`input[name="${qid}"][value="${v}"]`);
        if(cb) cb.checked = true;
      });
    } else {
      const input = document.querySelector(`input[name="${qid}"]`);
      if(input && input.type === 'text') {
        input.value = value;
      }
      
      const radio = document.querySelector(`input[name="${qid}"][value="${value}"]`);
      if(radio) radio.checked = true;
    }
  });
}

function saveFlags() {
  const flags = [...document.querySelectorAll('.flag-btn.active')].map(b => b.dataset.q);
  localStorage.setItem(`${PAPER_ID}_flags`, JSON.stringify(flags));
}

function loadFlags() {
  const flags = JSON.parse(localStorage.getItem(`${PAPER_ID}_flags`) || '[]');
  flags.forEach(q => document.querySelector(`[data-q="${q}"]`)?.classList.add('active'));
}

function saveHighlights() {
  const highlights = { left: [], right: [] };
  ['left','right'].forEach(pane=>{
    document.querySelectorAll(`#${pane} .hl, #${pane} .note`).forEach((el,idx)=>{
      highlights[pane].push({
        type: el.classList.contains('hl') ? 'hl' : 'note',
        text: el.textContent,
        index: idx
      });
    });
  });
  localStorage.setItem(`${PAPER_ID}_highlights`, JSON.stringify(highlights));
}
function loadHighlights() {
  const data = JSON.parse(localStorage.getItem(`${PAPER_ID}_highlights`) || '{"left":[],"right":[]}');
  ['left','right'].forEach(pane=>{
    if(!data[pane]) return;
    data[pane].forEach(item=>{
      const walker = document.createTreeWalker(document.getElementById(pane), NodeFilter.SHOW_TEXT);
      let node;
      while(node = walker.nextNode()){
        const idx = node.textContent.indexOf(item.text);
        if(idx === -1) continue;
        const parent = node.parentNode;
        const before = node.textContent.substring(0, idx);
        const match  = node.textContent.substring(idx, idx + item.text.length);
        const after  = node.textContent.substring(idx + item.text.length);

        parent.insertBefore(document.createTextNode(before), node);
        const span = document.createElement('span');
        span.className = item.type;
        span.textContent = match;
        parent.insertBefore(span, node);
        parent.insertBefore(document.createTextNode(after), node);
        parent.removeChild(node);
        break;
      }
    });
  });
}

document.querySelectorAll('input[type="text"]').forEach(input => {
  input.addEventListener('input', saveAnswers);
});

document.querySelectorAll('input[type="radio"]').forEach(radio => {
  radio.addEventListener('change', saveAnswers);
});

document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
  cb.addEventListener('change', saveAnswers);
});

document.addEventListener('DOMContentLoaded', () => {
  loadAnswers();
  loadFlags();
  loadHighlights();
});

function submitAnswers(){ 
  const res=[]; 
  let cor=0; 
  
  Object.keys(answerKey).forEach(q=>{ 
    let uA = "";
    let cA = answerKey[q];
    let iC = false;
    
    if(q === 'q18' || q === 'q20') {
      const checked = [...document.querySelectorAll(`input[name="${q}"]:checked`)].map(cb => cb.value).sort();
      uA = checked.join(',');
      const correct = [...cA].sort();
      iC = checked.length === correct.length && checked.every((v, i) => v === correct[i]);
      cA = correct.join(',');
    } else {
      const input = document.querySelector(`input[name="${q}"]`);
      if(input && input.type === 'text' && input.value.trim()) {
        uA = input.value.trim().toLowerCase();
      }
      
      const ch = document.querySelector(`input[name="${q}"]:checked`);
      if(ch) uA = ch.value;
      
      iC = uA === cA || (typeof cA === 'string' && uA.toLowerCase() === cA.toLowerCase());
    }
    
    if(iC) cor++; 
    res.push({id:q, userAns:uA, correctAns:cA, isCorrect:iC}); 
  }); 
  
  lastResults=res; 
  const tot=Object.keys(answerKey).length; 
  const pct=((cor/tot)*100).toFixed(1); 
  localStorage.setItem(`ielts_score_${PAPER_ID}`, `${cor}/${tot}`);
  document.getElementById('resultContent').innerHTML=`<div class="result-summary"><div class="result-score">${cor} / ${tot}</div><div style="margin-top:8px;font-size:18px;">${pct}%</div></div>${res.map(r=>`<div class="result-item ${r.isCorrect?'correct':'incorrect'}"><div><strong>${r.id}</strong> ${r.isCorrect?'‚úì':'‚úó'}</div><div>‰Ω†ÁöÑÁ≠îÊ°à: ${r.userAns||'(Êú™‰ΩúÁ≠î)'}</div>${!r.isCorrect?`<div>Ê≠£Á°ÆÁ≠îÊ°à: ${r.correctAns}</div>`:''}</div>`).join('')}`; 
  document.getElementById('resultModal').classList.add('active'); 
}

function resetForm(){ 
  document.getElementById('resetModal').classList.add('active'); 
}

function confirmReset(){ 
  const tp=document.querySelector('input[name="resetType"]:checked').value; 
  
  document.querySelectorAll('input[type="text"]').forEach(i=>i.value=''); 
  document.querySelectorAll('input[type="radio"]').forEach(i=>i.checked=false); 
  document.querySelectorAll('input[type="checkbox"]').forEach(i=>i.checked=false);
  localStorage.removeItem(`${PAPER_ID}_answers`);
  
  if(tp==='all'){ 
    document.querySelectorAll('.hl').forEach(el=>{ const p=el.parentNode; while(el.firstChild)p.insertBefore(el.firstChild,el); p.removeChild(el); p.normalize(); }); 
    document.querySelectorAll('.note').forEach(el=>{ const p=el.parentNode; while(el.firstChild)p.insertBefore(el.firstChild,el); p.removeChild(el); p.normalize(); }); 
    document.querySelectorAll('.flag-btn').forEach(b => b.classList.remove('active'));
    localStorage.removeItem(`${PAPER_ID}_highlights`);
    localStorage.removeItem(`${PAPER_ID}_flags`);
  } 
  closeModal('resetModal'); 
}

function addWrongToBook(){ 
  const wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); 
  const wr=lastResults.filter(r=>!r.isCorrect); 
  wr.forEach(r=>{ 
    const en={paperId:PAPER_ID,title:'Jellyfish ‚Äì The Dominant Species',questionId:r.id,correctAnswer:r.correctAns,myAnswer:r.userAns||'(Êú™‰ΩúÁ≠î)',date:new Date().toISOString().split('T')[0]}; 
    const ix=wb.findIndex(i=>i.paperId===en.paperId&&i.questionId===en.questionId); 
    if(ix>=0)wb[ix]=en; else wb.push(en); 
  }); 
  localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); 
  alert(`Â∑≤Ê∑ªÂä† ${wr.length} ÈÅìÈîôÈ¢ò`); 
  closeModal('resultModal'); 
}

function deleteWrongItem(pId,qId){ 
  if(!confirm('Á°ÆÂÆöÂà†Èô§ËøôÈÅìÈîôÈ¢òÔºü'))return; 
  let wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); 
  wb=wb.filter(i=>!(i.paperId===pId&&i.questionId===qId)); 
  localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); 
  openWrongBook(); 
}

function clearCurrentWrongBook(){ 
  if(!confirm('Á°ÆÂÆöÊ∏ÖÁ©∫Êú¨ÁØáÊâÄÊúâÈîôÈ¢òÔºü'))return; 
  let wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); 
  wb=wb.filter(i=>i.paperId!==PAPER_ID); 
  localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); 
  openWrongBook(); 
}

function openWrongBook(){ 
  const wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); 
  const cu=wb.filter(i=>i.paperId===PAPER_ID); 
  const ct=document.getElementById('wrongBookContent'); 
  if(cu.length===0)ct.innerHTML='<div style="text-align:center;padding:40px;color:#666;">ÊöÇÊó†ÈîôÈ¢ò</div>'; 
  else ct.innerHTML=`<div class="modal-actions"><button class="btn-danger" onclick="clearCurrentWrongBook()" style="width:100%;">üóëÔ∏è Ê∏ÖÁ©∫Êú¨ÁØáÈîôÈ¢ò</button></div>${cu.map(i=>`<div class="wrong-item"><div class="wrong-item-content"><div style="font-weight:600;margin-bottom:8px;">${i.questionId}</div><div style="font-size:13px;color:#666;"><div>‚úì Ê≠£Á°Æ: ${i.correctAnswer}</div><div style="color:#d32f2f;">‚úó ÊàëÁöÑ: ${i.myAnswer}</div></div></div><button class="btn-delete" onclick="deleteWrongItem('${i.paperId}','${i.questionId}')">Âà†Èô§</button></div>`).join('')}`; 
  document.getElementById('wrongBookModal').classList.add('active'); 
}

function closeModal(id){ 
  document.getElementById(id).classList.remove('active'); 
}
</script>
</body>
</html>
