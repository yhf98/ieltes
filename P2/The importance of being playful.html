<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>P2 ‚Äì The importance of being playful</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  * { box-sizing: border-box; margin:0; padding:0; }
  html,body { height:100%; }
  body { font-family: Arial, sans-serif; background:#f5f5f5; }
  
  #timer { position:fixed; top:12px; right:12px; background:#fff; border:1px solid #ddd; border-radius:6px; padding:8px 12px; font-size:16px; font-weight:600; color:#0066cc; z-index:1000; }
  
  .shell { display:flex; height:100vh; width:100%; }
  .pane { background:#fff; overflow:auto; padding:24px; }
  #left { flex: 0 0 50%; border-right:1px solid #ddd; }
  #right { flex: 1 1 auto; background:#fafafa; }
  #divider { flex: 0 0 5px; background:#ddd; cursor: ew-resize; }
  #divider:hover { background:#999; }
  
  h2,h3,h4 { margin:0 0 12px; color:#333; }
  h2 { font-size:20px; }
  h3 { font-size:18px; color:#0066cc; }
  h4 { font-size:15px; font-weight:600; margin-top:20px; }
  
  #left p { margin: 0 0 14px; line-height: 1.7; text-align:justify; }
  
  .group { background:#fff; border:1px solid #ddd; border-radius:6px; padding:16px; margin-bottom:16px; }
  .group h4 { margin-top:0; color:#0066cc; }
  .group p { margin:8px 0; font-size:14px; line-height:1.6; }
  
  .headings { background:#f9f9f9; padding:12px; margin:12px 0; border-radius:4px; border: 1px solid #eee;}
  .headings ol, .headings ul { margin-left:20px; list-style-type: none; }
  .headings li { margin:4px 0; font-size:13px; }
  
  .flag-btn { 
    position:absolute; 
    left:-18px; 
    top:4px;
    width:8px;
    height:8px;
    border-radius:50%;
    background:#ddd;
    cursor:pointer;
    z-index:10;
  }
  .flag-btn:hover { background:#999; }
  .flag-btn.active { background:#ff5722; }
  
  .question-item { position: relative; margin-bottom: 15px; padding-left: 10px; }
  
  /* Radio grid for Headings/Matching */
  .radio-grid { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 5px; }
  .radio-grid label { font-size: 12px; display: flex; align-items: center; gap: 3px; cursor: pointer; background: #f0f0f0; padding: 2px 6px; border-radius: 4px; }
  .radio-grid label:hover { background: #e0e0e0; }

  /* Fill in the blank inputs */
  .gap-input {
    border: none;
    border-bottom: 1px solid #333;
    background: #fdfdfd;
    width: 100px;
    padding: 0 5px;
    font-size: 14px;
    color: #0066cc;
    text-align: center;
    outline: none;
  }
  .gap-input:focus { border-bottom: 2px solid #0066cc; background: #fff; }

  .bottom-bar { display:flex; gap:10px; margin-top:16px; }
  button { padding:10px 20px; border:1px solid #999; border-radius:6px; background:#fff; cursor:pointer; font-size:14px; }
  button:hover { background:#f0f0f0; }
  .btn-primary { background:#0066cc; color:#fff; border-color:#0066cc; }
  .btn-primary:hover { background:#0052a3; }
  .btn-danger { background:#dc3545; color:#fff; border-color:#dc3545; }
  .btn-danger:hover { background:#c82333; }
  
  .hl { background:#fff59d; cursor:pointer; }
  .hl:hover { background:#ffeb3b; }
  .note { background:#b3d9ff; cursor:pointer; }
  .note:hover { background:#99ccff; }
  
  #selbar { position:fixed; display:none; z-index:2000; background:#fff; border:1px solid #ddd; border-radius:8px; padding:8px; gap:0; box-shadow:0 2px 8px rgba(0,0,0,0.15); flex-direction:column; min-width:120px; }
  #selbar button { background:#fff; color:#666; border:none; padding:3px 0px; cursor:pointer; font-size:14px; text-align:center; border-radius:4px; }
  #selbar button:hover { background:#f5f5f5; color:#333; }
  
  .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:3000; align-items:center; justify-content:center; }
  .modal.active { display:flex; }
  .modal-content { background:#fff; border-radius:8px; padding:24px; max-width:600px; width:90%; max-height:80vh; overflow-y:auto; }
  
  .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
  .modal-header h2 { font-size: 28px; color: #333; margin: 0; }
  .modal-close { font-size: 32px; cursor: pointer; color: #999; line-height: 1; }
  .modal-close:hover { color: #333; }
  
  .result-summary { text-align:center; padding:20px; background:#f0f0f0; margin-bottom:16px; border-radius:6px; }
  .result-score { font-size:36px; font-weight:600; color:#0066cc; }
  .result-item { padding:10px; margin:8px 0; border-left:3px solid #ddd; background:#f9f9f9; font-size:13px; }
  .result-item.correct { border-left-color:#28a745; background:#e8f5e9; }
  .result-item.incorrect { border-left-color:#dc3545; background:#ffebee; }
  
  .wrong-item { background:#fff3e0; padding:16px; margin:8px 0; border-radius:8px; border-left:4px solid #ff9800; display:flex; justify-content:space-between; align-items:start; }
  .wrong-item-content { flex:1; }
  .btn-delete { background:#dc3545; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-size:13px; margin-left:12px; }
  .btn-delete:hover { background:#c82333; }
  .modal-actions { display:flex; gap:10px; margin-bottom:20px; }
</style>
</head>
<body>
<div id="timer">00:00</div>

<div class="shell">
  <section class="pane" id="left">
    <h2>READING PASSAGE 2</h2>
    <p>You should spend about 20 minutes on Questions 14‚Äì26, which are based on Reading Passage 2 below.</p>
    
    <h3>The importance of being playful</h3>
    <p><strong>Free play makes us better adjusted, smarter and less stressed</strong></p>

    <h4>Paragraph A</h4>
    <p>While it has long been recognized that play affords benefits that last through adulthood, psychologists in the US are now becoming concerned that lack of play could actually be harming their country‚Äôs kids. In the past, few children grew up without ample free-play time. But youngsters‚Äô leisure hours are now filled with structured activities such as music lessons and sports. Kids play soccer, Scrabble and saxophone ‚Äì so why are experts worried that these activities are eating into free play? Most games are fun and sources of learning experiences ‚Äì fostering group cohesion, for instance, says educational psychologist Anthony Pellegrini. But, Pellegrini explains, ‚Äúgames have predetermined rules ‚Äì set up in advance and followed. Play, on the other hand, does not have rules, so affords more creative responses. Children initiate and create free play, and use their imagination to try out new activities and roles.‚Äù</p>

    <h4>Paragraph B</h4>
    <p>Perhaps most crucially, play helps us develop strong social skills. ‚ÄúYou don‚Äôt become socially competent via teachers telling you how to behave,‚Äù Pellegrini says. ‚ÄúKids learn those skills by interacting with peers, learning what is and isn‚Äôt acceptable. They want this thing to keep going, so they‚Äôre willing to ‚Äògo the extra mile‚Äô to accommodate their playmates‚Äô desires. Keeping things friendly requires communication ‚Äì arguably the most valuable social skill of all. Play among peers is the most important in this regard.‚Äù Studies show that children use more sophisticated language when playing with other children than when playing with adults. In pretend play, for instance, they have to communicate about something that‚Äôs not physically present, so they have to use complicated language to communicate what it is that they‚Äôre trying to say,‚Äù Pellegrini explains.</p>

    <h4>Paragraph C</h4>
    <p>If play helps children become socialized, then lack of play should impede social development ‚Äì and research suggests that it does. A study of children in Michigan revealed that kids who enrolled in play-oriented preschools were more socially adjusted later in life ‚Äì and less likely to commit a felony or be suspended from work ‚Äì than kids who attended play-free preschools where they were constantly instructed by teachers.</p>

    <h4>Paragraph D</h4>
    <p>A 2003 study even suggests that play promotes emotional and social development in animals. Researchers allowed thirteen rats to play freely with companions for three and a half days, and kept fourteen others isolated for the same period. Examination revealed that the brains of the rats which had played contained much higher levels of BDNF ‚Äì a protein that stimulates the growth of new neurons ‚Äì than those of the animals that had not. ‚ÄúI think play is the major mechanism whereby higher regions of the brain get socialized,‚Äù says neuroscientist Jaak Panksepp, who co-authored the study.</p>

    <h4>Paragraph E</h4>
    <p>Research also suggests that imaginative play is critical for children‚Äôs emotional health, as it enables them to work through anxiety. In a 1984 study, researchers assessed the anxiety levels of seventy-four children on their first day of preschool. They labeled each child as either ‚Äúanxious‚Äù or ‚Äúnot anxious‚Äù, then randomly split the kids into groups. Half were escorted to rooms full of toys, where they played for 15 minutes; the other half listened to a teacher tell a story for 15 minutes. Afterward, their levels were assessed again. The anxiety levels of the anxious kids who had played had dropped by more than twice as much compared with the anxious kids who had listened to the story.</p>

    <h4>Paragraph F</h4>
    <p>Results of animal studies support these views. In 2008, neuroscientist Stephen Siviy put rats into a chamber and exposed them to a collar previously worn by a cat, making them visibly anxious. Later, the chamber was cleaned to remove the cat odor, and the rats were put back without the collar. They immediately became anxious again, probably because they associated the space with the cat. The researchers then introduced another rat ‚Äì one that had never been exposed to the collar and was not afraid ‚Äì and it began playing with one of the rats. ‚ÄúShortly thereafter, the first rat relaxed and became calm,‚Äù says Siviy, ‚Äúsuggesting that play helped lessen its anxiety.‚Äù</p>

    <h4>Paragraph G</h4>
    <p>Play even appears to make kids smarter. In a classic study, researchers told a group of preschool children to play freely with some common objects such as paper towels, a screwdriver, a wooden board and paper clips. Another group was asked to imitate an experimenter using the objects in common ways. A third set was told to sit and draw whatever they wanted, without seeing the objects. After 10 minutes, the researchers asked the children to come up with ideas for how one of the objects could be used. The kids who had played with the objects named, on average, three times as many nonstandard, creative uses for the objects as those in either of the other two groups did, suggesting that play fosters imaginative thinking.</p>

    <h4>Paragraph H</h4>
    <p>A later animal study produced similar results. Experimenters isolated young rats during the development period when they would have most frequently played. The researchers taught these rats, and a group that had been allowed to play without constraints, to pull a rubber ball out of the way to get a food treat. A few days later they switched the setup so the rats would have to push the same ball to get the treat. Compared with the isolated rats, the ones which had played proved to be far more adept at solving problems. ‚ÄúPlay is like a kaleidoscope,‚Äù says evolutionary biologist Marc Bekoff, ‚Äúin that it is random and creative. It encourages flexibility and creativity that may, in the future, be advantageous in unexpected situations or new environments. And in the absence of play, children miss vital learning experiences.‚Äù</p>
  </section>

  <div id="divider" title="Drag to resize"></div>

  <section class="pane" id="right">
    <h3>Questions</h3>

    <div class="group">
      <h4>Questions 14‚Äì18</h4>
      <p>Reading Passage 2 has eight paragraphs, A‚ÄìH.<br>Which paragraph contains the following information?<br>Write the correct letter, <strong>A‚ÄìH</strong>, in boxes 14‚Äì18 on your answer sheet.<br><strong>NB</strong> You may use any letter more than once.</p>
      
      <div class="question-item">
        <span class="flag-btn" data-q="q14"></span>
        <strong>14.</strong> reference to how play can develop children‚Äôs verbal skills
        <div class="radio-grid">
            <label><input type="radio" name="q14" value="A"> A</label> <label><input type="radio" name="q14" value="B"> B</label> <label><input type="radio" name="q14" value="C"> C</label> <label><input type="radio" name="q14" value="D"> D</label> <label><input type="radio" name="q14" value="E"> E</label> <label><input type="radio" name="q14" value="F"> F</label> <label><input type="radio" name="q14" value="G"> G</label> <label><input type="radio" name="q14" value="H"> H</label>
        </div>
      </div>
      <div class="question-item">
        <span class="flag-btn" data-q="q15"></span>
        <strong>15.</strong> mention of a change in the amount of free play children engage in
        <div class="radio-grid">
            <label><input type="radio" name="q15" value="A"> A</label> <label><input type="radio" name="q15" value="B"> B</label> <label><input type="radio" name="q15" value="C"> C</label> <label><input type="radio" name="q15" value="D"> D</label> <label><input type="radio" name="q15" value="E"> E</label> <label><input type="radio" name="q15" value="F"> F</label> <label><input type="radio" name="q15" value="G"> G</label> <label><input type="radio" name="q15" value="H"> H</label>
        </div>
      </div>
      <div class="question-item">
        <span class="flag-btn" data-q="q16"></span>
        <strong>16.</strong> an account of some research indicating that free play stimulates children‚Äôs creativity
        <div class="radio-grid">
            <label><input type="radio" name="q16" value="A"> A</label> <label><input type="radio" name="q16" value="B"> B</label> <label><input type="radio" name="q16" value="C"> C</label> <label><input type="radio" name="q16" value="D"> D</label> <label><input type="radio" name="q16" value="E"> E</label> <label><input type="radio" name="q16" value="F"> F</label> <label><input type="radio" name="q16" value="G"> G</label> <label><input type="radio" name="q16" value="H"> H</label>
        </div>
      </div>
      <div class="question-item">
        <span class="flag-btn" data-q="q17"></span>
        <strong>17.</strong> evidence of the link between antisocial behaviour and a lack of free play
        <div class="radio-grid">
            <label><input type="radio" name="q17" value="A"> A</label> <label><input type="radio" name="q17" value="B"> B</label> <label><input type="radio" name="q17" value="C"> C</label> <label><input type="radio" name="q17" value="D"> D</label> <label><input type="radio" name="q17" value="E"> E</label> <label><input type="radio" name="q17" value="F"> F</label> <label><input type="radio" name="q17" value="G"> G</label> <label><input type="radio" name="q17" value="H"> H</label>
        </div>
      </div>
      <div class="question-item">
        <span class="flag-btn" data-q="q18"></span>
        <strong>18.</strong> a comparison between free play and other forms of play
        <div class="radio-grid">
            <label><input type="radio" name="q18" value="A"> A</label> <label><input type="radio" name="q18" value="B"> B</label> <label><input type="radio" name="q18" value="C"> C</label> <label><input type="radio" name="q18" value="D"> D</label> <label><input type="radio" name="q18" value="E"> E</label> <label><input type="radio" name="q18" value="F"> F</label> <label><input type="radio" name="q18" value="G"> G</label> <label><input type="radio" name="q18" value="H"> H</label>
        </div>
      </div>
    </div>

    <div class="group">
      <h4>Questions 19‚Äì22</h4>
      <p>Look at the following statements about free play (Questions 19‚Äì22) and the list of researchers below.<br>Match each statement with the correct researcher, A, B, C or D.<br>Write the correct letter, <strong>A‚ÄìD</strong>, in boxes 19‚Äì22 on your answer sheet.<br><strong>NB</strong> You may use any letter more than once.</p>
      
      <div class="headings">
        <strong>List of Researchers</strong>
        <ul>
            <li><strong>A</strong> Anthony Pellegrini</li>
            <li><strong>B</strong> Jaak Panksepp</li>
            <li><strong>C</strong> Stephen Siviy</li>
            <li><strong>D</strong> Marc Bekoff</li>
        </ul>
      </div>

      <div class="question-item">
        <span class="flag-btn" data-q="q19"></span>
        <strong>19.</strong> It encourages children to take other people‚Äôs wishes into account.
        <div class="radio-grid">
           <label><input type="radio" name="q19" value="A"> A</label> <label><input type="radio" name="q19" value="B"> B</label> <label><input type="radio" name="q19" value="C"> C</label> <label><input type="radio" name="q19" value="D"> D</label>
        </div>
      </div>
      <div class="question-item">
        <span class="flag-btn" data-q="q20"></span>
        <strong>20.</strong> It can serve to relieve stress.
        <div class="radio-grid">
           <label><input type="radio" name="q20" value="A"> A</label> <label><input type="radio" name="q20" value="B"> B</label> <label><input type="radio" name="q20" value="C"> C</label> <label><input type="radio" name="q20" value="D"> D</label>
        </div>
      </div>
      <div class="question-item">
        <span class="flag-btn" data-q="q21"></span>
        <strong>21.</strong> It prepares children for dealing with unpredictable situations.
        <div class="radio-grid">
           <label><input type="radio" name="q21" value="A"> A</label> <label><input type="radio" name="q21" value="B"> B</label> <label><input type="radio" name="q21" value="C"> C</label> <label><input type="radio" name="q21" value="D"> D</label>
        </div>
      </div>
       <div class="question-item">
        <span class="flag-btn" data-q="q22"></span>
        <strong>22.</strong> It is less useful for children when adults are involved.
        <div class="radio-grid">
           <label><input type="radio" name="q22" value="A"> A</label> <label><input type="radio" name="q22" value="B"> B</label> <label><input type="radio" name="q22" value="C"> C</label> <label><input type="radio" name="q22" value="D"> D</label>
        </div>
      </div>
    </div>

    <div class="group">
      <h4>Questions 23‚Äì26</h4>
      <p>Complete the summary below.<br>Choose <strong>ONE WORD ONLY</strong> from the passage for each answer.<br>Write your answers in boxes 23‚Äì26 on your answer sheet.</p>
      
      <div style="background:#fafafa; padding:15px; border-radius:6px; line-height:2;">
        <h4 style="text-align:center;">Animal research into the value of play</h4>
        <p>In studies researching links between play and social learning, experiments analysing protein levels in the 23 <span class="question-item" style="display:inline-block; margin:0; padding:0;"><span class="flag-btn" data-q="q23" style="left:-12px; top:6px;"></span><input type="text" class="gap-input" id="q23" placeholder="23"></span> of rats noted significant differences between rats which had played and those which had not.</p>
        <p>In another study, rats made distressed by an object smelling of a 24 <span class="question-item" style="display:inline-block; margin:0; padding:0;"><span class="flag-btn" data-q="q24" style="left:-12px; top:6px;"></span><input type="text" class="gap-input" id="q24" placeholder="24"></span> experienced a noticeable reduction in their 25 <span class="question-item" style="display:inline-block; margin:0; padding:0;"><span class="flag-btn" data-q="q25" style="left:-12px; top:6px;"></span><input type="text" class="gap-input" id="q25" placeholder="25"></span> levels after they had been allowed to play.</p>
        <p>A further experiment, in which rats had to move a 26 <span class="question-item" style="display:inline-block; margin:0; padding:0;"><span class="flag-btn" data-q="q26" style="left:-12px; top:6px;"></span><input type="text" class="gap-input" id="q26" placeholder="26"></span> in order to reach a reward, indicated that rats deprived of play were less skilled at dealing with problems.</p>
      </div>
    </div>

    <div class="bottom-bar">
      <button class="btn-primary" onclick="submitAnswers()">Êèê‰∫§</button>
      <button onclick="resetForm()">ÈáçÁΩÆ</button>
      <button onclick="openWrongBook()">Êú¨ÁØáÈîôÈ¢ò</button>
    </div>
  </section>
</div>

<div id="selbar">
  <button id="btnNote">Note</button>
  <button id="btnHL">Highlight</button>
  <button id="btnUH" style="display:none;">Clear Highlight</button>
</div>

<div class="modal" id="resultModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ÊàêÁª©</h2>
      <span class="modal-close" onclick="closeModal('resultModal')">√ó</span>
    </div>
    <div id="resultContent"></div>
    <button class="btn-primary" style="width:100%; margin-top:16px;" onclick="addWrongToBook()">Âä†ÂÖ•ÈîôÈ¢òÊú¨</button>
  </div>
</div>

<div class="modal" id="wrongBookModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Êú¨ÁØáÈîôÈ¢ò</h2>
      <span class="modal-close" onclick="closeModal('wrongBookModal')">√ó</span>
    </div>
    <div id="wrongBookContent"></div>
  </div>
</div>

<div class="modal" id="resetModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ÈáçÁΩÆÁªÉ‰π†</h2>
      <span class="modal-close" onclick="closeModal('resetModal')">√ó</span>
    </div>
    <div style="margin:16px 0;">
      <label style="display:block; margin-bottom:10px;">
        <input type="radio" name="resetType" value="answers" checked>
        Âè™Ê∏ÖÁ©∫Á≠îÊ°à
      </label>
      <label style="display:block;">
        <input type="radio" name="resetType" value="all">
        Ê∏ÖÁ©∫Á≠îÊ°àÂíåÊ†áËÆ∞
      </label>
    </div>
    <button class="btn-primary" style="width:100%;" onclick="confirmReset()">Á°ÆÂÆö</button>
  </div>
</div>

<script>
const PAPER_ID='P2_PLAYFUL';

let t=0;
const timerEl=document.getElementById('timer');
setInterval(()=>{ t++; timerEl.textContent=String(Math.floor(t/60)).padStart(2,'0')+':'+String(t%60).padStart(2,'0'); }, 1000);

const divider=document.getElementById('divider'), left=document.getElementById('left'), right=document.getElementById('right');
let dragging=false;
divider.onmousedown=()=>{ dragging=true; document.body.style.cursor='ew-resize'; };
window.onmousemove=(e)=>{ if(!dragging)return; const c=document.querySelector('.shell').getBoundingClientRect(); let x=e.clientX-c.left; x=Math.max(280,Math.min(c.width-280,x)); left.style.flex='0 0 '+x+'px'; right.style.flex='1 1 auto'; };
window.onmouseup=()=>{ dragging=false; document.body.style.cursor=''; };

const selbar=document.getElementById('selbar'), btnHL=document.getElementById('btnHL'), btnUH=document.getElementById('btnUH'), btnNote=document.getElementById('btnNote');
let lastRange=null, currentHlNode=null;

function posSelbar(r){ selbar.style.display='flex'; const t=window.scrollY+r.top-selbar.offsetHeight-8; const l=window.scrollX+r.left+r.width/2-selbar.offsetWidth/2; selbar.style.top=((t>0)?t:(window.scrollY+r.bottom+8))+'px'; selbar.style.left=Math.max(8,l)+'px'; }

function updSel(){ const s=window.getSelection(); if(!s||s.rangeCount===0||s.isCollapsed){ if(!currentHlNode)selbar.style.display='none'; return; } const r=s.getRangeAt(0); lastRange=r.cloneRange(); currentHlNode=null; btnNote.style.display='block'; btnHL.style.display='block'; btnUH.style.display='none'; posSelbar(r.getBoundingClientRect()); }

left.onmouseup=updSel; right.onmouseup=updSel;
document.onselectionchange=()=>{ const s=window.getSelection(); if((!s||s.rangeCount===0||s.isCollapsed)&&!currentHlNode)selbar.style.display='none'; };
document.addEventListener('click',(e)=>{ if(e.target.classList&&(e.target.classList.contains('hl')||e.target.classList.contains('note'))){ currentHlNode=e.target; lastRange=null; btnNote.style.display='none'; btnHL.style.display='none'; btnUH.style.display='block'; posSelbar(e.target.getBoundingClientRect()); const s=window.getSelection(); if(s)s.removeAllRanges(); }}, true);

btnHL.onclick=()=>{ if(currentHlNode||!lastRange||lastRange.collapsed)return; const s=document.createElement('span'); s.className='hl'; try{ lastRange.surroundContents(s); }catch(e){ const w=document.createElement('span'); w.className='hl'; w.appendChild(lastRange.cloneContents()); lastRange.deleteContents(); lastRange.insertNode(w); } selbar.style.display='none'; saveHighlights(); };

btnNote.onclick=()=>{ if(currentHlNode||!lastRange||lastRange.collapsed)return; const s=document.createElement('span'); s.className='note'; try{ lastRange.surroundContents(s); }catch(e){ const w=document.createElement('span'); w.className='note'; w.appendChild(lastRange.cloneContents()); lastRange.deleteContents(); lastRange.insertNode(w); } selbar.style.display='none'; saveHighlights(); };

btnUH.onclick=()=>{ if(currentHlNode){ const p=currentHlNode.parentNode; while(currentHlNode.firstChild)p.insertBefore(currentHlNode.firstChild,currentHlNode); p.removeChild(currentHlNode); p.normalize(); currentHlNode=null; selbar.style.display='none'; saveHighlights(); }else if(lastRange){ const sR=lastRange.getBoundingClientRect(); const w=document.createTreeWalker(document.body,NodeFilter.SHOW_ELEMENT); const tr=[]; while(w.nextNode()){ const n=w.currentNode; if(n.classList&&(n.classList.contains('hl')||n.classList.contains('note'))){ const r=n.getBoundingClientRect(); if(!(r.right<sR.left||r.left>sR.right||r.bottom<sR.top||r.top>sR.bottom))tr.push(n); }} tr.forEach(el=>{ const p=el.parentNode; while(el.firstChild)p.insertBefore(el.firstChild,el); p.removeChild(el); p.normalize(); }); selbar.style.display='none'; saveHighlights(); }};

document.querySelectorAll('.flag-btn').forEach(btn => {
  btn.onclick = e => {
    e.stopPropagation();
    btn.classList.toggle('active');
    saveFlags();
  };
});

// Answer Key (Standard IELTS answers for this passage)
const answerKey={
  q14:"B", q15:"A", q16:"G", q17:"C", q18:"A",
  q19:"A", q20:"C", q21:"D", q22:"A",
  q23:"brains", q24:"cat", q25:"anxiety", q26:"ball"
};
const textInputs = ['q23','q24','q25','q26'];

let lastResults=[];

function saveAnswers() {
  const data = {};
  // Save Radio Buttons
  Object.keys(answerKey).forEach(q => {
    if(textInputs.includes(q)) return;
    const ch = document.querySelector(`input[name="${q}"]:checked`);
    if(ch) data[q] = ch.value;
  });
  // Save Text Inputs
  textInputs.forEach(id => {
    const el = document.getElementById(id);
    if(el) data[id] = el.value;
  });
  localStorage.setItem(`${PAPER_ID}_answers`, JSON.stringify(data));
}

function loadAnswers() {
  const data = JSON.parse(localStorage.getItem(`${PAPER_ID}_answers`) || '{}');
  Object.keys(data).forEach(q => {
    if(textInputs.includes(q)){
      const el = document.getElementById(q);
      if(el) el.value = data[q];
    } else {
      const radio = document.querySelector(`input[name="${q}"][value="${data[q]}"]`);
      if(radio) radio.checked = true;
    }
  });
}

function saveFlags() {
  const flags = [...document.querySelectorAll('.flag-btn.active')].map(b => b.dataset.q);
  localStorage.setItem(`${PAPER_ID}_flags`, JSON.stringify(flags));
}

function loadFlags() {
  const flags = JSON.parse(localStorage.getItem(`${PAPER_ID}_flags`) || '[]');
  flags.forEach(q => document.querySelector(`[data-q="${q}"]`)?.classList.add('active'));
}

function saveHighlights() {
  const highlights = { left: [], right: [] };
  document.querySelectorAll('#left .hl, #left .note').forEach((el, idx) => {
    highlights.left.push({ type: el.classList.contains('hl') ? 'hl' : 'note', text: el.textContent, index: idx });
  });
  document.querySelectorAll('#right .hl, #right .note').forEach((el, idx) => {
    highlights.right.push({ type: el.classList.contains('hl') ? 'hl' : 'note', text: el.textContent, index: idx });
  });
  localStorage.setItem(`${PAPER_ID}_highlights`, JSON.stringify(highlights));
}

function loadHighlights() {
  const data = JSON.parse(localStorage.getItem(`${PAPER_ID}_highlights`) || '{"left":[],"right":[]}');
  ['left','right'].forEach(pane => {
    const container = document.getElementById(pane);
    if(data[pane] && data[pane].length > 0) {
      data[pane].forEach(item => {
        const walker = document.createTreeWalker(container, NodeFilter.SHOW_TEXT);
        let node;
        while(node = walker.nextNode()) {
          if(node.textContent.includes(item.text)) {
            const span = document.createElement('span');
            span.className = item.type;
            const parent = node.parentNode;
            const text = node.textContent;
            const idx = text.indexOf(item.text);
            if(idx >= 0) {
              parent.insertBefore(document.createTextNode(text.substring(0, idx)), node);
              span.textContent = text.substring(idx, idx + item.text.length);
              parent.insertBefore(span, node);
              parent.insertBefore(document.createTextNode(text.substring(idx + item.text.length)), node);
              parent.removeChild(node);
              break;
            }
          }
        }
      });
    }
  });
}

document.querySelectorAll('input[type="radio"]').forEach(radio => radio.addEventListener('change', saveAnswers));
document.querySelectorAll('input[type="text"]').forEach(txt => txt.addEventListener('input', saveAnswers));

document.addEventListener('DOMContentLoaded', () => {
  loadAnswers();
  loadFlags();
  loadHighlights();
});

function submitAnswers(){ 
  const res=[]; let cor=0; 
  Object.keys(answerKey).forEach(q=>{ 
    let uA = "";
    if(textInputs.includes(q)){
      uA = document.getElementById(q).value.trim();
    } else {
      const ch=document.querySelector('input[name="'+q+'"]:checked'); 
      uA = ch?ch.value:"";
    }
    const cA=answerKey[q]; 
    const iC = uA.toLowerCase() === cA.toLowerCase(); 
    if(iC) cor++; 
    res.push({id:q,userAns:uA,correctAns:cA,isCorrect:iC}); 
  }); 
  lastResults=res; 
  const tot=Object.keys(answerKey).length; 
  const pct=((cor/tot)*100).toFixed(1); 
  localStorage.setItem(`ielts_score_${PAPER_ID}`, `${cor}/${tot}`);
  document.getElementById('resultContent').innerHTML=`<div class="result-summary"><div class="result-score">${cor} / ${tot}</div><div style="margin-top:8px;font-size:18px;">${pct}%</div></div>${res.map(r=>`<div class="result-item ${r.isCorrect?'correct':'incorrect'}"><div><strong>${r.id}</strong> ${r.isCorrect?'‚úì':'‚úó'}</div><div>‰Ω†ÁöÑÁ≠îÊ°à: ${r.userAns||'(Êú™‰ΩúÁ≠î)'}</div>${!r.isCorrect?`<div>Ê≠£Á°ÆÁ≠îÊ°à: ${r.correctAns}</div>`:''}</div>`).join('')}`; 
  document.getElementById('resultModal').classList.add('active'); 
}

function resetForm(){ document.getElementById('resetModal').classList.add('active'); }

function confirmReset(){ 
  const tp=document.querySelector('input[name="resetType"]:checked').value; 
  
  // Clear inputs
  document.querySelectorAll('input[type="radio"]').forEach(i=>i.checked=false); 
  document.querySelectorAll('input[type="text"]').forEach(i=>i.value='');
  
  localStorage.removeItem(`${PAPER_ID}_answers`);
  
  if(tp==='all'){ 
    document.querySelectorAll('.hl').forEach(el=>{ const p=el.parentNode; while(el.firstChild)p.insertBefore(el.firstChild,el); p.removeChild(el); p.normalize(); }); 
    document.querySelectorAll('.note').forEach(el=>{ const p=el.parentNode; while(el.firstChild)p.insertBefore(el.firstChild,el); p.removeChild(el); p.normalize(); }); 
    document.querySelectorAll('.flag-btn').forEach(b => b.classList.remove('active'));
    localStorage.removeItem(`${PAPER_ID}_highlights`);
    localStorage.removeItem(`${PAPER_ID}_flags`);
  } 
  closeModal('resetModal'); 
}

function addWrongToBook(){ 
  const wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); 
  const wr=lastResults.filter(r=>!r.isCorrect); 
  wr.forEach(r=>{ 
    const en={
      paperId:PAPER_ID,
      title:'The importance of being playful',
      questionId:r.id,
      correctAnswer:r.correctAns,
      myAnswer:r.userAns||'(Êú™‰ΩúÁ≠î)',
      date:new Date().toISOString().split('T')[0]
    }; 
    const ix=wb.findIndex(i=>i.paperId===en.paperId&&i.questionId===en.questionId); 
    if(ix>=0)wb[ix]=en; else wb.push(en); 
  }); 
  localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); 
  alert(`Â∑≤Ê∑ªÂä† ${wr.length} ÈÅìÈîôÈ¢ò`); 
  closeModal('resultModal'); 
}

function deleteWrongItem(pId,qId){ 
  if(!confirm('Á°ÆÂÆöÂà†Èô§ËøôÈÅìÈîôÈ¢òÔºü'))return; 
  let wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); 
  wb=wb.filter(i=>!(i.paperId===pId&&i.questionId===qId)); 
  localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); 
  openWrongBook(); 
}

function clearCurrentWrongBook(){ 
  if(!confirm('Á°ÆÂÆöÊ∏ÖÁ©∫Êú¨ÁØáÊâÄÊúâÈîôÈ¢òÔºü'))return; 
  let wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); 
  wb=wb.filter(i=>i.paperId!==PAPER_ID); 
  localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); 
  openWrongBook(); 
}

function openWrongBook(){ 
  const wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); 
  const cu=wb.filter(i=>i.paperId===PAPER_ID); 
  const ct=document.getElementById('wrongBookContent'); 
  if(cu.length===0) ct.innerHTML='<div style="text-align:center;padding:40px;color:#666;">ÊöÇÊó†ÈîôÈ¢ò</div>'; 
  else ct.innerHTML=`<div class="modal-actions"><button class="btn-danger" onclick="clearCurrentWrongBook()" style="width:100%;">üóëÔ∏è Ê∏ÖÁ©∫Êú¨ÁØáÈîôÈ¢ò</button></div>${cu.map(i=>`<div class="wrong-item"><div class="wrong-item-content"><div style="font-weight:600;margin-bottom:8px;">${i.questionId}</div><div style="font-size:13px;color:#666;"><div>‚úì Ê≠£Á°Æ: ${i.correctAnswer}</div><div style="color:#d32f2f;">‚úó ÊàëÁöÑ: ${i.myAnswer}</div></div></div><button class="btn-delete" onclick="deleteWrongItem('${i.paperId}','${i.questionId}')">Âà†Èô§</button></div>`).join('')}`; 
  document.getElementById('wrongBookModal').classList.add('active'); 
}

function closeModal(id){ document.getElementById(id).classList.remove('active'); }
</script>
</body>
</html>
