<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>P2 ‚Äì Skyscraper Farming</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      html,
      body {
        height: 100%;
      }
      body {
        font-family: Arial, sans-serif;
        background: #f5f5f5;
      }
      #timer {
        position: fixed;
        top: 12px;
        right: 12px;
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 8px 12px;
        font-size: 16px;
        font-weight: 600;
        color: #0066cc;
        z-index: 1000;
      }
      .shell {
        display: flex;
        height: 100vh;
        width: 100%;
      }
      .pane {
        background: #fff;
        overflow: auto;
        padding: 24px;
      }
      #left {
        flex: 0 0 50%;
        border-right: 1px solid #ddd;
      }
      #right {
        flex: 1 1 auto;
        background: #fafafa;
      }
      #divider {
        flex: 0 0 5px;
        background: #ddd;
        cursor: ew-resize;
      }
      #divider:hover {
        background: #999;
      }
      h2,
      h3,
      h4 {
        margin: 0 0 12px;
        color: #333;
      }
      h2 {
        font-size: 20px;
      }
      h3 {
        font-size: 18px;
        color: #0066cc;
      }
      h4 {
        font-size: 15px;
        font-weight: 600;
        margin-top: 20px;
      }
      #left p {
        margin: 0 0 14px;
        line-height: 1.7;
        text-align: justify;
      }
      .group {
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 16px;
        margin-bottom: 16px;
      }
      .group h4 {
        margin-top: 0;
        color: #0066cc;
      }
      .group p {
        margin: 8px 0;
        font-size: 14px;
        line-height: 1.6;
      }
      .flag-btn {
        position: absolute;
        left: 2px;
        top: 50%;
        transform: translateY(-50%);
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #ddd;
        cursor: pointer;
        z-index: 10;
      }
      .flag-btn:hover {
        background: #999;
      }
      .flag-btn.active {
        background: #ff5722;
      }
      .group ol {
        margin-left: 20px;
      }
      .group ol li {
        margin: 12px 0;
        font-size: 14px;
        line-height: 1.6;
        position: relative;
      }
      .group ol li label {
        display: inline-block;
        margin-right: 8px;
      }
      input[type="text"] {
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 4px 8px;
        font-size: 14px;
        width: 160px;
        background: #fdfdfd;
      }
      input[type="text"]:focus {
        border-color: #0066cc;
        outline: none;
        background: #fff;
      }
      .bottom-bar {
        display: flex;
        gap: 10px;
        margin-top: 16px;
      }
      button {
        padding: 10px 20px;
        border: 1px solid #999;
        border-radius: 6px;
        background: #fff;
        cursor: pointer;
        font-size: 14px;
      }
      button:hover {
        background: #f0f0f0;
      }
      .btn-primary {
        background: #0066cc;
        color: #fff;
        border-color: #0066cc;
      }
      .btn-primary:hover {
        background: #0052a3;
      }
      .btn-danger {
        background: #dc3545;
        color: #fff;
        border-color: #dc3545;
      }
      .btn-danger:hover {
        background: #c82333;
      }
      .hl {
        background: #fff59d;
        cursor: pointer;
      }
      .hl:hover {
        background: #ffeb3b;
      }
      .note {
        background: #b3d9ff;
        cursor: pointer;
      }
      .note:hover {
        background: #99ccff;
      }
      #selbar {
        position: fixed;
        display: none;
        z-index: 2000;
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 8px;
        gap: 0;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        flex-direction: column;
        min-width: 120px;
      }
      #selbar button {
        background: #fff;
        color: #666;
        border: none;
        padding: 3px 0px;
        cursor: pointer;
        font-size: 14px;
        text-align: center;
        border-radius: 4px;
      }
      #selbar button:hover {
        background: #f5f5f5;
        color: #333;
      }
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 3000;
        align-items: center;
        justify-content: center;
      }
      .modal.active {
        display: flex;
      }
      .modal-content {
        background: #fff;
        border-radius: 8px;
        padding: 24px;
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
      }
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
      }
      .modal-header h2 {
        font-size: 28px;
        color: #333;
        margin: 0;
      }
      .modal-close {
        font-size: 32px;
        cursor: pointer;
        color: #999;
        line-height: 1;
      }
      .modal-close:hover {
        color: #333;
      }
      .result-summary {
        text-align: center;
        padding: 20px;
        background: #f0f0f0;
        margin-bottom: 16px;
        border-radius: 6px;
      }
      .result-score {
        font-size: 36px;
        font-weight: 600;
        color: #0066cc;
      }
      .result-item {
        padding: 10px;
        margin: 8px 0;
        border-left: 3px solid #ddd;
        background: #f9f9f9;
        font-size: 13px;
      }
      .result-item.correct {
        border-left-color: #28a745;
        background: #e8f5e9;
      }
      .result-item.incorrect {
        border-left-color: #dc3545;
        background: #ffebee;
      }
      .wrong-item {
        background: #fff3e0;
        padding: 16px;
        margin: 8px 0;
        border-radius: 8px;
        border-left: 4px solid #ff9800;
        display: flex;
        justify-content: space-between;
        align-items: start;
      }
      .wrong-item-content {
        flex: 1;
      }
      .btn-delete {
        background: #dc3545;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
        margin-left: 12px;
      }
      .btn-delete:hover {
        background: #c82333;
      }
      .modal-actions {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }
      .headings-box {
        background: #f9f9f9;
        padding: 12px;
        border: 1px solid #eee;
        border-radius: 4px;
        margin-bottom: 12px;
      }
      .headings-box h5 {
        margin: 0 0 8px;
        font-size: 14px;
        color: #333;
      }
      .headings-box ol {
        margin-left: 20px;
        font-size: 13px;
        line-height: 1.4;
      }
    </style>
  </head>
  <body>
    <div id="timer">00:00</div>
    <div class="shell">
      <section class="pane" id="left">
        <h2>READING PASSAGE 2</h2>
        <p>
          You should spend about 20 minutes on Questions 14‚Äì26, which are based
          on Reading Passage 2 below.
        </p>
        <h3>Skyscraper Farming</h3>
        <p>
          <strong>A</strong> Today‚Äôs environmental scientists are in no doubt
          that the world‚Äôs resources of fertile soil are rapidly deteriorating,
          and that new land for agriculture is becoming ever more sparse.
          Intensive farming, urbanisation, desertification and sea-level rises
          are all putting growing pressure on the planet‚Äôs agricultural land and
          therefore on food supplies. Currently 24 per cent of the world‚Äôs 11.5
          billion hectares of cultivated land has already undergone
          human-induced soil degradation, particularly through erosion,
          according to a recent study by the UK Government Office for Science.
        </p>
        <p>
          <strong>B</strong> The global population is expected to exceed nine
          billion by 2050 ‚Äî up a third from today‚Äôs level ‚Äî and studies suggest
          that food production will have to go up by 70 per cent if we are to
          feed all of those new mouths. This means that scientists will have to
          develop new ways of growing crops if we are to avoid a humanitarian
          crisis. Indeed, UN Food and Agriculture Organization figures suggest
          that the number of under-nourished people is already growing, and with
          escalating climate change, crop yields in many areas have been
          projected to decline.
        </p>
        <p>
          <strong>C</strong> With this in mind, some scientists and agricultural
          experts are advocating an innovative alternative to traditional
          farming whereby skyscrapers packed with shelf-based systems for
          growing vegetables on each storey ‚Äî known as ‚Äòvertical farms‚Äô ‚Äî could
          hold the key to revolutionising agriculture. Columbia University
          professor Dickson Despommier claims that vertical farming could boost
          crop yields many times over. A single 20-storey vertical farm could
          theoretically feed 50 000 people. And if the theory translates into
          reality as proposed, 160 skyscraper-sized vertical farms could feed
          the entire population of New York City, while 180 would be needed for
          London, 289 for Cairo and 302 for Kolkata.
        </p>
        <p>
          <strong>D</strong> It‚Äôs a compelling vision, and one that has already
          been put into practice in Asia ‚Äî albeit on a smaller scale. ‚ÄòBut there
          are problems, such as initial investment and operating costs that are
          too great,‚Äô says a spokesman for Japan‚Äôs Ministry of Agriculture,
          Forestry and Fisheries. Nevertheless, Tokyo-based mushroom producer
          Hokuto Corporation is a model example of how a vertical farm can be
          profitable. With 28 vertical mushroom farms operating across the
          country, it produces some 68 000 tonnes of mushrooms annually.
          ‚ÄòVertical mushroom farms have more advantages than ground-level
          farms,‚Äô says Hokuto‚Äôs Ted Yamanoko, who highlights the relative
          cost-effectiveness of his organisation‚Äôs farming practices together
          with reduced emissions of greenhouse gases.
        </p>
        <p>
          <strong>E</strong> And the impact of vertical farms could extend
          beyond feeding established urban populations. Despommier sees them as
          being capable of helping centres of displaced persons ‚Äî such as
          refugee camps ‚Äî in much the same way that Mobile Army Surgical
          Hospital (MASH) units are deployed in emergencies. ‚ÄòDeveloping an
          emergency response system for crop production inside specially
          constructed modular and highly transportable greenhouses would allow
          for humanitarian interventions,‚Äô he says. ‚ÄòIf you have three or four
          storeys of food already growing someplace, they could become mobile
          units that could be picked up by helicopters and dropped into the
          middle of a crisis zone.‚Äô
        </p>
        <p>
          <strong>F</strong> But it isn‚Äôt only about increasing food production.
          Despommier is concerned about the harm that farming has done to the
          world‚Äôs landscape over a relatively short time span, particularly the
          elimination of hardwood forests. ‚ÄòFarming is only 12 000 years old,‚Äô
          he points out. ‚ÄòVertical farming could allow us for the first time to
          feed everyone on Earth and still return land to its original
          ecological function.‚Äô Natalie Jeremijenko of New York University
          agrees. Reducing the land needed for food production could enrich
          biodiversity, which in turn can raise the productivity of conventional
          farms. Furthermore, vertical farming could dramatically cut
          fossil-fuel use and reduce geopolitical tensions in regions where poor
          farming conditions drive conflict and malnutrition.
        </p>
      </section>
      <div id="divider"></div>
      <section class="pane" id="right">
        <h3>Questions</h3>
        <div class="group">
          <h4>Questions 14‚Äì19</h4>
          <p>Reading Passage 2 has six paragraphs, A‚ÄìF.</p>
          <p>
            Choose the correct heading for each paragraph from the list of
            headings below.
          </p>
          <div class="headings-box">
            <h5>List of Headings</h5>
            <ol type="i">
              <li>Potential production capabilities of vertical farms</li>
              <li>Opposition to new ideas about food production</li>
              <li>A successful application of vertical-farming technology</li>
              <li>The potential to provide urgent relief</li>
              <li>The original inspiration for vertical farming</li>
              <li>Various environmental benefits of vertical farming</li>
              <li>An increasing problem for farmers worldwide</li>
              <li>A return to traditional farming methods</li>
              <li>A rising demand for food</li>
            </ol>
          </div>
          <ol start="14">
            <li>
              <span class="flag-btn" data-q="q14" style="left: -20px"></span
              >Paragraph A<br />
              <label><input type="radio" name="q14" value="i" /> i</label>
              <label><input type="radio" name="q14" value="ii" /> ii</label>
              <label><input type="radio" name="q14" value="iii" /> iii</label>
              <label><input type="radio" name="q14" value="iv" /> iv</label>
              <label><input type="radio" name="q14" value="v" /> v</label>
              <label><input type="radio" name="q14" value="vi" /> vi</label>
              <label><input type="radio" name="q14" value="vii" /> vii</label>
              <label><input type="radio" name="q14" value="viii" /> viii</label>
              <label><input type="radio" name="q14" value="ix" /> ix</label>
            </li>
            <li>
              <span class="flag-btn" data-q="q15" style="left: -20px"></span
              >Paragraph B<br />
              <label><input type="radio" name="q15" value="i" /> i</label>
              <label><input type="radio" name="q15" value="ii" /> ii</label>
              <label><input type="radio" name="q15" value="iii" /> iii</label>
              <label><input type="radio" name="q15" value="iv" /> iv</label>
              <label><input type="radio" name="q15" value="v" /> v</label>
              <label><input type="radio" name="q15" value="vi" /> vi</label>
              <label><input type="radio" name="q15" value="vii" /> vii</label>
              <label><input type="radio" name="q15" value="viii" /> viii</label>
              <label><input type="radio" name="q15" value="ix" /> ix</label>
            </li>
            <li>
              <span class="flag-btn" data-q="q16" style="left: -20px"></span
              >Paragraph C<br />
              <label><input type="radio" name="q16" value="i" /> i</label>
              <label><input type="radio" name="q16" value="ii" /> ii</label>
              <label><input type="radio" name="q16" value="iii" /> iii</label>
              <label><input type="radio" name="q16" value="iv" /> iv</label>
              <label><input type="radio" name="q16" value="v" /> v</label>
              <label><input type="radio" name="q16" value="vi" /> vi</label>
              <label><input type="radio" name="q16" value="vii" /> vii</label>
              <label><input type="radio" name="q16" value="viii" /> viii</label>
              <label><input type="radio" name="q16" value="ix" /> ix</label>
            </li>
            <li>
              <span class="flag-btn" data-q="q17" style="left: -20px"></span
              >Paragraph D<br />
              <label><input type="radio" name="q17" value="i" /> i</label>
              <label><input type="radio" name="q17" value="ii" /> ii</label>
              <label><input type="radio" name="q17" value="iii" /> iii</label>
              <label><input type="radio" name="q17" value="iv" /> iv</label>
              <label><input type="radio" name="q17" value="v" /> v</label>
              <label><input type="radio" name="q17" value="vi" /> vi</label>
              <label><input type="radio" name="q17" value="vii" /> vii</label>
              <label><input type="radio" name="q17" value="viii" /> viii</label>
              <label><input type="radio" name="q17" value="ix" /> ix</label>
            </li>
            <li>
              <span class="flag-btn" data-q="q18" style="left: -20px"></span
              >Paragraph E<br />
              <label><input type="radio" name="q18" value="i" /> i</label>
              <label><input type="radio" name="q18" value="ii" /> ii</label>
              <label><input type="radio" name="q18" value="iii" /> iii</label>
              <label><input type="radio" name="q18" value="iv" /> iv</label>
              <label><input type="radio" name="q18" value="v" /> v</label>
              <label><input type="radio" name="q18" value="vi" /> vi</label>
              <label><input type="radio" name="q18" value="vii" /> vii</label>
              <label><input type="radio" name="q18" value="viii" /> viii</label>
              <label><input type="radio" name="q18" value="ix" /> ix</label>
            </li>
            <li>
              <span class="flag-btn" data-q="q19" style="left: -20px"></span
              >Paragraph F<br />
              <label><input type="radio" name="q19" value="i" /> i</label>
              <label><input type="radio" name="q19" value="ii" /> ii</label>
              <label><input type="radio" name="q19" value="iii" /> iii</label>
              <label><input type="radio" name="q19" value="iv" /> iv</label>
              <label><input type="radio" name="q19" value="v" /> v</label>
              <label><input type="radio" name="q19" value="vi" /> vi</label>
              <label><input type="radio" name="q19" value="vii" /> vii</label>
              <label><input type="radio" name="q19" value="viii" /> viii</label>
              <label><input type="radio" name="q19" value="ix" /> ix</label>
            </li>
          </ol>
        </div>
        <div class="group">
          <h4>Questions 20‚Äì22</h4>
          <p>
            Complete the sentences below. Choose
            <strong>NO MORE THAN TWO WORDS</strong> from the passage for each
            answer.
          </p>
          <ol start="20">
            <li>
              <span class="flag-btn" data-q="q20" style="left: -20px"></span>A
              UK Government study found that <input type="text" name="q20" /> is
              a significant factor contributing to worldwide levels of soil
              degradation.
            </li>
            <li>
              <span class="flag-btn" data-q="q21" style="left: -20px"></span
              >Disadvantages of vertical-farming projects include the expense of
              setting them up, as well as their high
              <input type="text" name="q21" />.
            </li>
            <li>
              <span class="flag-btn" data-q="q22" style="left: -20px"></span
              ><input type="text" name="q22" /> could potentially be used to
              take vertical-farming facilities to areas where there is a
              critical food shortage.
            </li>
          </ol>
        </div>
        <div class="group">
          <h4>Questions 23‚Äì26</h4>
          <p>
            Match each statement with the correct person,
            <strong>A, B or C</strong>.
          </p>
          <div class="headings-box">
            <h5>List of People</h5>
            <div style="margin-left: 10px">
              <strong>A</strong> Dickson Despommier<br />
              <strong>B</strong> Ted Yamanoko<br />
              <strong>C</strong> Natalie Jeremijenko
            </div>
          </div>
          <ol start="23">
            <li>
              <span class="flag-btn" data-q="q23" style="left: -20px"></span
              >Vertical farming can have financial benefits.<br />
              <label><input type="radio" name="q23" value="A" /> A</label>
              <label><input type="radio" name="q23" value="B" /> B</label>
              <label><input type="radio" name="q23" value="C" /> C</label>
            </li>
            <li>
              <span class="flag-btn" data-q="q24" style="left: -20px"></span
              >Traditional farming has had a negative effect on the natural
              world.<br />
              <label><input type="radio" name="q24" value="A" /> A</label>
              <label><input type="radio" name="q24" value="B" /> B</label>
              <label><input type="radio" name="q24" value="C" /> C</label>
            </li>
            <li>
              <span class="flag-btn" data-q="q25" style="left: -20px"></span
              >Vertical farming could dramatically increase world food
              production.<br />
              <label><input type="radio" name="q25" value="A" /> A</label>
              <label><input type="radio" name="q25" value="B" /> B</label>
              <label><input type="radio" name="q25" value="C" /> C</label>
            </li>
            <li>
              <span class="flag-btn" data-q="q26" style="left: -20px"></span
              >Traditional farms may benefit from wider use of vertical
              farming.<br />
              <label><input type="radio" name="q26" value="A" /> A</label>
              <label><input type="radio" name="q26" value="B" /> B</label>
              <label><input type="radio" name="q26" value="C" /> C</label>
            </li>
          </ol>
        </div>
        <div class="bottom-bar">
          <button class="btn-primary" onclick="submitAnswers()">Êèê‰∫§</button>
          <button onclick="resetForm()">ÈáçÁΩÆ</button>
          <button onclick="openWrongBook()">Êú¨ÁØáÈîôÈ¢ò</button>
        </div>
      </section>
    </div>
    <div id="selbar">
      <button id="btnNote">Note</button>
      <button id="btnHL">Highlight</button>
      <button id="btnUH" style="display: none">Clear Highlight</button>
    </div>
    <div class="modal" id="resultModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>ÊàêÁª©</h2>
          <span class="modal-close" onclick="closeModal('resultModal')">√ó</span>
        </div>
        <div id="resultContent"></div>
        <button
          class="btn-primary"
          style="width: 100%; margin-top: 16px"
          onclick="addWrongToBook()"
        >
          Âä†ÂÖ•ÈîôÈ¢òÊú¨
        </button>
      </div>
    </div>
    <div class="modal" id="wrongBookModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Êú¨ÁØáÈîôÈ¢ò</h2>
          <span class="modal-close" onclick="closeModal('wrongBookModal')"
            >√ó</span
          >
        </div>
        <div id="wrongBookContent"></div>
      </div>
    </div>
    <div class="modal" id="resetModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>ÈáçÁΩÆÁªÉ‰π†</h2>
          <span class="modal-close" onclick="closeModal('resetModal')">√ó</span>
        </div>
        <div style="margin: 16px 0">
          <label style="display: block; margin-bottom: 10px"
            ><input type="radio" name="resetType" value="answers" checked />
            Âè™Ê∏ÖÁ©∫Á≠îÊ°à</label
          >
          <label style="display: block"
            ><input type="radio" name="resetType" value="all" />
            Ê∏ÖÁ©∫Á≠îÊ°àÂíåÊ†áËÆ∞</label
          >
        </div>
        <button
          class="btn-primary"
          style="width: 100%"
          onclick="confirmReset()"
        >
          Á°ÆÂÆö
        </button>
      </div>
    </div>
    <script>
      const PAPER_ID = "P2_SKYSCRAPER_FARMING";
      let t = 0;
      const timerEl = document.getElementById("timer");
      setInterval(() => {
        t++;
        timerEl.textContent =
          String(Math.floor(t / 60)).padStart(2, "0") +
          ":" +
          String(t % 60).padStart(2, "0");
      }, 1000);
      const divider = document.getElementById("divider"),
        left = document.getElementById("left"),
        right = document.getElementById("right");
      let dragging = false;
      divider.onmousedown = () => {
        dragging = true;
        document.body.style.cursor = "ew-resize";
      };
      window.onmousemove = (e) => {
        if (!dragging) return;
        const c = document.querySelector(".shell").getBoundingClientRect();
        let x = e.clientX - c.left;
        x = Math.max(280, Math.min(c.width - 280, x));
        left.style.flex = "0 0 " + x + "px";
        right.style.flex = "1 1 auto";
      };
      window.onmouseup = () => {
        dragging = false;
        document.body.style.cursor = "";
      };
      const selbar = document.getElementById("selbar"),
        btnHL = document.getElementById("btnHL"),
        btnUH = document.getElementById("btnUH"),
        btnNote = document.getElementById("btnNote");
      let lastRange = null,
        currentHlNode = null;
      function posSelbar(r) {
        selbar.style.display = "flex";
        const t = window.scrollY + r.top - selbar.offsetHeight - 8;
        const l =
          window.scrollX + r.left + r.width / 2 - selbar.offsetWidth / 2;
        selbar.style.top = (t > 0 ? t : window.scrollY + r.bottom + 8) + "px";
        selbar.style.left = Math.max(8, l) + "px";
      }
      function updSel() {
        const s = window.getSelection();
        if (!s || s.rangeCount === 0 || s.isCollapsed) {
          if (!currentHlNode) selbar.style.display = "none";
          return;
        }
        const r = s.getRangeAt(0);
        lastRange = r.cloneRange();
        currentHlNode = null;
        btnNote.style.display = "block";
        btnHL.style.display = "block";
        btnUH.style.display = "none";
        posSelbar(r.getBoundingClientRect());
      }
      left.onmouseup = updSel;
      right.onmouseup = updSel;
      document.onselectionchange = () => {
        const s = window.getSelection();
        if ((!s || s.rangeCount === 0 || s.isCollapsed) && !currentHlNode)
          selbar.style.display = "none";
      };
      document.addEventListener(
        "click",
        (e) => {
          if (
            e.target.classList &&
            (e.target.classList.contains("hl") ||
              e.target.classList.contains("note"))
          ) {
            currentHlNode = e.target;
            lastRange = null;
            btnNote.style.display = "none";
            btnHL.style.display = "none";
            btnUH.style.display = "block";
            posSelbar(e.target.getBoundingClientRect());
            const s = window.getSelection();
            if (s) s.removeAllRanges();
          }
        },
        true
      );
      btnHL.onclick = () => {
        if (currentHlNode || !lastRange || lastRange.collapsed) return;
        const s = document.createElement("span");
        s.className = "hl";
        try {
          lastRange.surroundContents(s);
        } catch (e) {
          const w = document.createElement("span");
          w.className = "hl";
          w.appendChild(lastRange.cloneContents());
          lastRange.deleteContents();
          lastRange.insertNode(w);
        }
        selbar.style.display = "none";
        saveHighlights();
      };
      btnNote.onclick = () => {
        if (currentHlNode || !lastRange || lastRange.collapsed) return;
        const s = document.createElement("span");
        s.className = "note";
        try {
          lastRange.surroundContents(s);
        } catch (e) {
          const w = document.createElement("span");
          w.className = "note";
          w.appendChild(lastRange.cloneContents());
          lastRange.deleteContents();
          lastRange.insertNode(w);
        }
        selbar.style.display = "none";
        saveHighlights();
      };
      btnUH.onclick = () => {
        if (currentHlNode) {
          const p = currentHlNode.parentNode;
          while (currentHlNode.firstChild)
            p.insertBefore(currentHlNode.firstChild, currentHlNode);
          p.removeChild(currentHlNode);
          p.normalize();
          currentHlNode = null;
          selbar.style.display = "none";
          saveHighlights();
        } else if (lastRange) {
          const sR = lastRange.getBoundingClientRect();
          const w = document.createTreeWalker(
            document.body,
            NodeFilter.SHOW_ELEMENT
          );
          const tr = [];
          while (w.nextNode()) {
            const n = w.currentNode;
            if (
              n.classList &&
              (n.classList.contains("hl") || n.classList.contains("note"))
            ) {
              const r = n.getBoundingClientRect();
              if (
                !(
                  r.right < sR.left ||
                  r.left > sR.right ||
                  r.bottom < sR.top ||
                  r.top > sR.bottom
                )
              )
                tr.push(n);
            }
          }
          tr.forEach((el) => {
            const p = el.parentNode;
            while (el.firstChild) p.insertBefore(el.firstChild, el);
            p.removeChild(el);
            p.normalize();
          });
          selbar.style.display = "none";
          saveHighlights();
        }
      };
      document.querySelectorAll(".flag-btn").forEach((btn) => {
        btn.onclick = (e) => {
          e.stopPropagation();
          btn.classList.toggle("active");
          saveFlags();
        };
      });
      const answerKey = {
        q14: "vii",
        q15: "ix",
        q16: "i",
        q17: "iii",
        q18: "iv",
        q19: "vi",
        q20: "erosion",
        q21: "operating costs",
        q22: "helicopters",
        q23: "B",
        q24: "A",
        q25: "A",
        q26: "C",
      };
      let lastResults = [];
      function saveAnswers() {
        const data = {};
        Object.keys(answerKey).forEach((q) => {
          const radio = document.querySelector(
            `input[name="${q}"][type="radio"]:checked`
          );
          const text = document.querySelector(
            `input[name="${q}"][type="text"]`
          );
          if (radio) data[q] = radio.value;
          else if (text) data[q] = text.value;
        });
        localStorage.setItem(`${PAPER_ID}_answers`, JSON.stringify(data));
      }
      function loadAnswers() {
        const data = JSON.parse(
          localStorage.getItem(`${PAPER_ID}_answers`) || "{}"
        );
        Object.keys(data).forEach((q) => {
          const radio = document.querySelector(
            `input[name="${q}"][value="${data[q]}"]`
          );
          const text = document.querySelector(
            `input[name="${q}"][type="text"]`
          );
          if (radio) radio.checked = true;
          else if (text) text.value = data[q];
        });
      }
      function saveFlags() {
        const flags = [...document.querySelectorAll(".flag-btn.active")].map(
          (b) => b.dataset.q
        );
        localStorage.setItem(`${PAPER_ID}_flags`, JSON.stringify(flags));
      }
      function loadFlags() {
        const flags = JSON.parse(
          localStorage.getItem(`${PAPER_ID}_flags`) || "[]"
        );
        flags.forEach((q) =>
          document.querySelector(`[data-q="${q}"]`)?.classList.add("active")
        );
      }
      function saveHighlights() {
        const highlights = { left: [], right: [] };
        document
          .querySelectorAll("#left .hl, #left .note")
          .forEach((el, idx) => {
            highlights.left.push({
              type: el.classList.contains("hl") ? "hl" : "note",
              text: el.textContent,
              index: idx,
            });
          });
        document
          .querySelectorAll("#right .hl, #right .note")
          .forEach((el, idx) => {
            highlights.right.push({
              type: el.classList.contains("hl") ? "hl" : "note",
              text: el.textContent,
              index: idx,
            });
          });
        localStorage.setItem(
          `${PAPER_ID}_highlights`,
          JSON.stringify(highlights)
        );
      }
      function loadHighlights() {
        const data = JSON.parse(
          localStorage.getItem(`${PAPER_ID}_highlights`) ||
            '{"left":[],"right":[]}'
        );
        const restore = (pane, items) => {
          if (!items || items.length === 0) return;
          items.forEach((item) => {
            const walker = document.createTreeWalker(
              pane,
              NodeFilter.SHOW_TEXT
            );
            let node;
            while ((node = walker.nextNode())) {
              if (node.textContent.includes(item.text)) {
                const span = document.createElement("span");
                span.className = item.type;
                const parent = node.parentNode;
                const text = node.textContent;
                const idx = text.indexOf(item.text);
                if (idx >= 0) {
                  const before = text.substring(0, idx);
                  const match = text.substring(idx, idx + item.text.length);
                  const after = text.substring(idx + item.text.length);
                  parent.insertBefore(document.createTextNode(before), node);
                  span.textContent = match;
                  parent.insertBefore(span, node);
                  parent.insertBefore(document.createTextNode(after), node);
                  parent.removeChild(node);
                  break;
                }
              }
            }
          });
        };
        restore(left, data.left);
        restore(right, data.right);
      }
      document.querySelectorAll("input").forEach((inp) => {
        inp.addEventListener("change", saveAnswers);
        if (inp.type === "text") inp.addEventListener("input", saveAnswers);
      });
      document.addEventListener("DOMContentLoaded", () => {
        loadAnswers();
        loadFlags();
        loadHighlights();
      });
      function submitAnswers() {
        const res = [];
        let cor = 0;
        Object.keys(answerKey).forEach((q) => {
          let uA = "";
          const radio = document.querySelector(
            `input[name="${q}"][type="radio"]:checked`
          );
          const text = document.querySelector(
            `input[name="${q}"][type="text"]`
          );
          if (radio) uA = radio.value;
          else if (text) uA = text.value.trim();
          const cA = answerKey[q];
          const iC = uA.toLowerCase() === cA.toLowerCase();
          if (iC) cor++;
          res.push({ id: q, userAns: uA, correctAns: cA, isCorrect: iC });
        });
        lastResults = res;
        const tot = Object.keys(answerKey).length;
        const pct = ((cor / tot) * 100).toFixed(1);
        localStorage.setItem(`ielts_score_${PAPER_ID}`, `${cor}/${tot}`);
        document.getElementById(
          "resultContent"
        ).innerHTML = `<div class="result-summary"><div class="result-score">${cor} / ${tot}</div><div style="margin-top:8px;font-size:18px;">${pct}%</div></div>${res
          .map(
            (r) =>
              `<div class="result-item ${
                r.isCorrect ? "correct" : "incorrect"
              }"><div><strong>${r.id}</strong> ${
                r.isCorrect ? "‚úì" : "‚úó"
              }</div><div>‰Ω†ÁöÑÁ≠îÊ°à: ${r.userAns || "(Êú™‰ΩúÁ≠î)"}</div>${
                !r.isCorrect ? `<div>Ê≠£Á°ÆÁ≠îÊ°à: ${r.correctAns}</div>` : ""
              }</div>`
          )
          .join("")}`;
        document.getElementById("resultModal").classList.add("active");
      }
      function resetForm() {
        document.getElementById("resetModal").classList.add("active");
      }
      function confirmReset() {
        const tp = document.querySelector(
          'input[name="resetType"]:checked'
        ).value;
        document.querySelectorAll("input").forEach((i) => {
          if (i.type === "radio") i.checked = false;
          if (i.type === "text") i.value = "";
        });
        localStorage.removeItem(`${PAPER_ID}_answers`);
        if (tp === "all") {
          document.querySelectorAll(".hl").forEach((el) => {
            const p = el.parentNode;
            while (el.firstChild) p.insertBefore(el.firstChild, el);
            p.removeChild(el);
            p.normalize();
          });
          document.querySelectorAll(".note").forEach((el) => {
            const p = el.parentNode;
            while (el.firstChild) p.insertBefore(el.firstChild, el);
            p.removeChild(el);
            p.normalize();
          });
          document
            .querySelectorAll(".flag-btn")
            .forEach((b) => b.classList.remove("active"));
          localStorage.removeItem(`${PAPER_ID}_highlights`);
          localStorage.removeItem(`${PAPER_ID}_flags`);
        }
        closeModal("resetModal");
      }
      function addWrongToBook() {
        const wb = JSON.parse(localStorage.getItem("ielts_wrong_book") || "[]");
        const wr = lastResults.filter((r) => !r.isCorrect);
        wr.forEach((r) => {
          const en = {
            paperId: PAPER_ID,
            title: "Skyscraper Farming",
            questionId: r.id,
            correctAnswer: r.correctAns,
            myAnswer: r.userAns || "(Êú™‰ΩúÁ≠î)",
            date: new Date().toISOString().split("T")[0],
          };
          const ix = wb.findIndex(
            (i) => i.paperId === en.paperId && i.questionId === en.questionId
          );
          if (ix >= 0) wb[ix] = en;
          else wb.push(en);
        });
        localStorage.setItem("ielts_wrong_book", JSON.stringify(wb));
        alert(`Â∑≤Ê∑ªÂä† ${wr.length} ÈÅìÈîôÈ¢ò`);
        closeModal("resultModal");
      }
      function deleteWrongItem(pId, qId) {
        if (!confirm("Á°ÆÂÆöÂà†Èô§ËøôÈÅìÈîôÈ¢òÔºü")) return;
        let wb = JSON.parse(localStorage.getItem("ielts_wrong_book") || "[]");
        wb = wb.filter((i) => !(i.paperId === pId && i.questionId === qId));
        localStorage.setItem("ielts_wrong_book", JSON.stringify(wb));
        openWrongBook();
      }
      function clearCurrentWrongBook() {
        if (!confirm("Á°ÆÂÆöÊ∏ÖÁ©∫Êú¨ÁØáÊâÄÊúâÈîôÈ¢òÔºü")) return;
        let wb = JSON.parse(localStorage.getItem("ielts_wrong_book") || "[]");
        wb = wb.filter((i) => i.paperId !== PAPER_ID);
        localStorage.setItem("ielts_wrong_book", JSON.stringify(wb));
        openWrongBook();
      }
      function openWrongBook() {
        const wb = JSON.parse(localStorage.getItem("ielts_wrong_book") || "[]");
        const cu = wb.filter((i) => i.paperId === PAPER_ID);
        const ct = document.getElementById("wrongBookContent");
        if (cu.length === 0)
          ct.innerHTML =
            '<div style="text-align:center;padding:40px;color:#666;">ÊöÇÊó†ÈîôÈ¢ò</div>';
        else
          ct.innerHTML = `<div class="modal-actions"><button class="btn-danger" onclick="clearCurrentWrongBook()" stylewidth:100%;">üóëÔ∏è Ê∏ÖÁ©∫Êú¨ÁØáÈîôÈ¢ò</button></div>${cu
            .map(
              (i) =>
                `<div class="wrong-item"><div class="wrong-item-content"><div style="font-weight:600;margin-bottom:8px;">${i.questionId}</div><div style="font-size:13px;color:#666;"><div>‚úì Ê≠£Á°Æ: ${i.correctAnswer}</div><div style="color:#d32f2f;">‚úó ÊàëÁöÑ: ${i.myAnswer}</div></div></div><button class="btn-delete" onclick="deleteWrongItem('${i.paperId}','${i.questionId}')">Âà†Èô§</button></div>`
            )
            .join("")}`;
        document.getElementById("wrongBookModal").classList.add("active");
      }
      function closeModal(id) {
        document.getElementById(id).classList.remove("active");
      }
    </script>
  </body>
</html>
