<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>P2 ‚Äì Keeping the water away</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  * { box-sizing: border-box; margin:0; padding:0; }
  html,body { height:100%; }
  body { font-family: Arial, sans-serif; background:#f5f5f5; }
  
  #timer { position:fixed; top:12px; right:12px; background:#fff; border:1px solid #ddd; border-radius:6px; padding:8px 12px; font-size:16px; font-weight:600; color:#0066cc; z-index:1000; }
  
  .shell { display:flex; height:100vh; width:100%; }
  .pane { background:#fff; overflow:auto; padding:24px; }
  #left { flex: 0 0 50%; border-right:1px solid #ddd; }
  #right { flex: 1 1 auto; background:#fafafa; }
  #divider { flex: 0 0 5px; background:#ddd; cursor: ew-resize; }
  #divider:hover { background:#999; }
  
  h2,h3,h4 { margin:0 0 12px; color:#333; }
  h2 { font-size:20px; }
  h3 { font-size:18px; color:#0066cc; }
  h4 { font-size:15px; font-weight:600; margin-top:20px; }
  
  #left p { margin: 0 0 14px; line-height: 1.7; text-align:justify; }
  
  .group { background:#fff; border:1px solid #ddd; border-radius:6px; padding:16px; margin-bottom:16px; }
  .group h4 { margin-top:0; color:#0066cc; }
  .group p { margin:8px 0; font-size:14px; line-height:1.6; }
  
  .flag-btn { 
    position:absolute; 
    left:2px; 
    top:50%;
    transform:translateY(-50%);
    width:8px;
    height:8px;
    border-radius:50%;
    background:#ddd;
    cursor:pointer;
    z-index:10;
  }
  .flag-btn:hover { background:#999; }
  .flag-btn.active { background:#ff5722; }
  
  .group ol { margin-left:20px; }
  .group ol li { margin:12px 0; font-size:14px; line-height:1.6; position:relative; }
  .group ol li label { display:inline-block; margin-right:8px; }
  
  .bottom-bar { display:flex; gap:10px; margin-top:16px; }
  button { padding:10px 20px; border:1px solid #999; border-radius:6px; background:#fff; cursor:pointer; font-size:14px; }
  button:hover { background:#f0f0f0; }
  .btn-primary { background:#0066cc; color:#fff; border-color:#0066cc; }
  .btn-primary:hover { background:#0052a3; }
  .btn-danger { background:#dc3545; color:#fff; border-color:#dc3545; }
  .btn-danger:hover { background:#c82333; }
  
  .hl { background:#fff59d; cursor:pointer; }
  .hl:hover { background:#ffeb3b; }
  .note { background:#b3d9ff; cursor:pointer; }
  .note:hover { background:#99ccff; }
  
  #selbar { position:fixed; display:none; z-index:2000; background:#fff; border:1px solid #ddd; border-radius:8px; padding:8px; gap:0; box-shadow:0 2px 8px rgba(0,0,0,0.15); flex-direction:column; min-width:120px; }
  #selbar button { background:#fff; color:#666; border:none; padding:3px 0px; cursor:pointer; font-size:14px; text-align:center; border-radius:4px; }
  #selbar button:hover { background:#f5f5f5; color:#333; }
  
  .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:3000; align-items:center; justify-content:center; }
  .modal.active { display:flex; }
  .modal-content { background:#fff; border-radius:8px; padding:24px; max-width:600px; width:90%; max-height:80vh; overflow-y:auto; }
  
  .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
  .modal-header h2 { font-size: 28px; color: #333; margin: 0; }
  .modal-close { font-size: 32px; cursor: pointer; color: #999; line-height: 1; }
  .modal-close:hover { color: #333; }
  
  .result-summary { text-align:center; padding:20px; background:#f0f0f0; margin-bottom:16px; border-radius:6px; }
  .result-score { font-size:36px; font-weight:600; color:#0066cc; }
  .result-item { padding:10px; margin:8px 0; border-left:3px solid #ddd; background:#f9f9f9; font-size:13px; }
  .result-item.correct { border-left-color:#28a745; background:#e8f5e9; }
  .result-item.incorrect { border-left-color:#dc3545; background:#ffebee; }
  
  .wrong-item { background:#fff3e0; padding:16px; margin:8px 0; border-radius:8px; border-left:4px solid #ff9800; display:flex; justify-content:space-between; align-items:start; }
  .wrong-item-content { flex:1; }
  .btn-delete { background:#dc3545; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-size:13px; margin-left:12px; }
  .btn-delete:hover { background:#c82333; }
  .modal-actions { display:flex; gap:10px; margin-bottom:20px; }
  
  input[type="text"] { width:200px; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:14px; }
</style>
</head>
<body>
<div id="timer">00:00</div>

<div class="shell">
  <section class="pane" id="left">
    
<h2>READING PASSAGE 2</h2>
<p>You should spend about 20 minutes on Questions 14‚Äì26, which are based on Reading Passage 2 below.</p>
<h3>Keeping the water away</h3>
<p style="font-style:italic;">New approaches to flood control</p>

<h4>Paragraph A</h4>
<p>Recently, winter floods on the rivers of central Europe have been among the worst for 600 to 700 years, and dams and dykes (protective sea walls) have failed to solve the problem. Traditionally, river engineers have tried to get rid of the water quickly, draining it off the land and down to the sea in rivers reengineered as high-performance drains. But however high they build the artificial riverbanks, the floods keep coming back. And when they come, they seem to be worse than ever.</p>

<h4>Paragraph B</h4>
<p>Engineers are now turning to a different plan: to sap the water's destructive strength by dispersing it into fields, forgotten lakes and flood plains. They are reviving river bends and marshes to curb the flow, and even plugging city drains to encourage floodwater to use other means to go underground. Back in the days when rivers took a winding path to the sea, floodwaters lost force and volume while meandering across flood plains and inland deltas, but today the water tends to have a direct passage to the sea. This means that, when it rains in the uplands, the water comes down all at once.</p>

<h4>Paragraph C</h4>
<p>Worse, when the flood plains are closed off, the river's flow downstream becomes more violent and uncontrollable; by turning complex river systems into the simple mechanics of a water pipe, engineers have often created danger where they promised safety. The Rhine, Europe's most engineered river, is a good example. For a long time engineers have erased its backwaters and cut it off from its plain. The aim was partly to improve navigation, and partly to speed floodwaters out of the Alps and down to the North Sea. Now, when it rains in the Alps, the peak flows from several branches of the Rhine coincide where once they arrived separately, and with four-fifths of the Lower Rhine's flood plain barricaded off, the waters rise. The result is more frequent flooding and greater damage. The same thing has happened in the US on the Mississippi River, which drains the world's second-largest river catchment into the Gulf of Mexico. Despite some $7 billion spent over the last century on levees (embankments), the situation is growing worse.</p>

<h4>Paragraph D</h4>
<p>Specialists in water control now say that a new approach is needed ‚Äî one which takes the whole landscape into consideration. To help keep London's feet dry, the UK Environment Agency is reflooding 10 square kilometres of the ancient flood plain of the River Thames outside Oxford. Nearer to London, it has spent ¬£100 million creating new wetlands and a relief channel across 16 kilometres of flood plain. Similar ideas are being tested in Austria, in one of Europe's largest river restorations to date. The engineers calculate that the restored flood plain of the Drava River can now store up to 10 million cubic metres of floodwater, and slow down storm surges coming out of the Alps by more than an hour, protecting towns not only in Austria, but as far downstream as Slovenia and Croatia.</p>

<h4>Paragraph E</h4>
<p>The Dutch, for whom preventing floods is a matter of survival, have gone furthest. This nation, built largely on drained marshes and seabed, has had several severe shocks in the last two decades, when very large numbers of people have had to be evacuated. Since that time, the Dutch have broken one of their most enduring national stereotypes by allowing engineers to punch holes in dykes. They plan to return up to a sixth of the country to its former waterlogged state in order to better protect the rest.</p>

<h4>Paragraph F</h4>
<p>Water use in cities also needs to change. At the moment, cities seem to create floods; they are concreted and paved so that rains flow quickly into rivers. A new breed of 'soft engineers' wants cities to be porous; Berlin is one place where this is being done. Tough new rules for new developments mean that drains will be prevented from becoming overloaded after heavy rains. Architects of new urban buildings are diverting rainwater from the roofs for use in toilets and the irrigation of roof gardens, while water falling onto the ground is collected in ponds, or passes underground through porous paving. One high-tech urban development can store a sixth of its annual rainfall, and reuse most of the rest.</p>

<h4>Paragraph G</h4>
<p>Could this be expanded to protect a whole city? The test case could be Los Angeles. With non-porous surfaces covering 70% of the city, drainage is a huge challenge. Billions of dollars have been spent digging huge drains and concreting riverbeds, but many communities still flood regularly. Meanwhile, this desert city ships water from hundreds of kilometres away to fill its taps and swimming pool. Los Angeles has recently launched a new scheme to utilise floodwater in the Sun Valley section of the city. The plan is to catch the rain that falls on thousands of driveways, parking lots and rooftops in the valley. Trees will soak up water from parking lots; houses and public buildings will capture roof water to irrigate gardens and parks, and road drains will empty into old gravel pits to recharge the city's underground water reserves. Result: less flooding and more water for the city. It may sound expensive, until we realise how much is spent trying to drain cities and protect areas from flooding, and how little this method achieves.</p>

  </section>

  <div id="divider" title="Drag to resize"></div>

  <section class="pane" id="right">
    <h3>Questions</h3>

    <div class="group">
      <h4>Questions 14‚Äì19</h4>
      <p>Reading Passage 2 has seven paragraphs, A‚ÄìG.</p>
      <p>Which paragraph contains the following information?</p>
      <p>Write the correct letter, <strong>A‚ÄìG</strong>, in boxes <strong>14‚Äì19</strong> on your answer sheet.</p>

      <ol start="14">
        <li><span class="flag-btn" data-q="q14" style="left:-20px;"></span>how legislation has forced building designers to improve water use<br>
          <label><input type="radio" name="q14" value="A"> A</label>
          <label><input type="radio" name="q14" value="B"> B</label>
          <label><input type="radio" name="q14" value="C"> C</label>
          <label><input type="radio" name="q14" value="D"> D</label>
          <label><input type="radio" name="q14" value="E"> E</label>
          <label><input type="radio" name="q14" value="F"> F</label>
          <label><input type="radio" name="q14" value="G"> G</label>
        </li>
        <li><span class="flag-btn" data-q="q15" style="left:-20px;"></span>two reasons why one river was isolated from its flood plain<br>
          <label><input type="radio" name="q15" value="A"> A</label>
          <label><input type="radio" name="q15" value="B"> B</label>
          <label><input type="radio" name="q15" value="C"> C</label>
          <label><input type="radio" name="q15" value="D"> D</label>
          <label><input type="radio" name="q15" value="E"> E</label>
          <label><input type="radio" name="q15" value="F"> F</label>
          <label><input type="radio" name="q15" value="G"> G</label>
        </li>
        <li><span class="flag-btn" data-q="q16" style="left:-20px;"></span>how natural watercourses in the past assisted flood control<br>
          <label><input type="radio" name="q16" value="A"> A</label>
          <label><input type="radio" name="q16" value="B"> B</label>
          <label><input type="radio" name="q16" value="C"> C</label>
          <label><input type="radio" name="q16" value="D"> D</label>
          <label><input type="radio" name="q16" value="E"> E</label>
          <label><input type="radio" name="q16" value="F"> F</label>
          <label><input type="radio" name="q16" value="G"> G</label>
        </li>
        <li><span class="flag-btn" data-q="q17" style="left:-20px;"></span>an example of flood control on one river, affecting three countries<br>
          <label><input type="radio" name="q17" value="A"> A</label>
          <label><input type="radio" name="q17" value="B"> B</label>
          <label><input type="radio" name="q17" value="C"> C</label>
          <label><input type="radio" name="q17" value="D"> D</label>
          <label><input type="radio" name="q17" value="E"> E</label>
          <label><input type="radio" name="q17" value="F"> F</label>
          <label><input type="radio" name="q17" value="G"> G</label>
        </li>
        <li><span class="flag-btn" data-q="q18" style="left:-20px;"></span>a country which has partly destroyed one of its most typical features in order to control water<br>
          <label><input type="radio" name="q18" value="A"> A</label>
          <label><input type="radio" name="q18" value="B"> B</label>
          <label><input type="radio" name="q18" value="C"> C</label>
          <label><input type="radio" name="q18" value="D"> D</label>
          <label><input type="radio" name="q18" value="E"> E</label>
          <label><input type="radio" name="q18" value="F"> F</label>
          <label><input type="radio" name="q18" value="G"> G</label>
        </li>
        <li><span class="flag-btn" data-q="q19" style="left:-20px;"></span>the writer's comment on the comparative cost-effectiveness of traditional flood control and newer methods<br>
          <label><input type="radio" name="q19" value="A"> A</label>
          <label><input type="radio" name="q19" value="B"> B</label>
          <label><input type="radio" name="q19" value="C"> C</label>
          <label><input type="radio" name="q19" value="D"> D</label>
          <label><input type="radio" name="q19" value="E"> E</label>
          <label><input type="radio" name="q19" value="F"> F</label>
          <label><input type="radio" name="q19" value="G"> G</label>
        </li>
      </ol>
    </div>

    <div class="group">
      <h4>Questions 20 and 21</h4>
      <p>Choose <strong>TWO</strong> letters A‚ÄìE.</p>
      <p>Write the correct letters in boxes <strong>20 and 21</strong> on your answer sheet.</p>
      <p>According to the article, which <strong>TWO</strong> of these statements are true of the new approach to flood control?</p>

      <div style="margin:12px 0;">
        <div style="margin:8px 0;"><span class="flag-btn" data-q="q20" style="position:relative;display:inline-block;width:auto;height:auto;transform:none;vertical-align:middle;"></span><label><input type="checkbox" name="q20" value="A"> <strong>A</strong> It aims to slow the movement of water to the sea.</label></div>
        <div style="margin:8px 0;"><span class="flag-btn" data-q="q20" style="position:relative;display:inline-block;width:auto;height:auto;transform:none;vertical-align:middle;"></span><label><input type="checkbox" name="q20" value="B"> <strong>B</strong> It aims to channel water more directly into rivers.</label></div>
        <div style="margin:8px 0;"><span class="flag-btn" data-q="q20" style="position:relative;display:inline-block;width:auto;height:auto;transform:none;vertical-align:middle;"></span><label><input type="checkbox" name="q20" value="C"> <strong>C</strong> It will cost more than twice as much as former measures.</label></div>
        <div style="margin:8px 0;"><span class="flag-btn" data-q="q20" style="position:relative;display:inline-block;width:auto;height:auto;transform:none;vertical-align:middle;"></span><label><input type="checkbox" name="q20" value="D"> <strong>D</strong> It will involve the loss of some areas of land.</label></div>
        <div style="margin:8px 0;"><span class="flag-btn" data-q="q20" style="position:relative;display:inline-block;width:auto;height:auto;transform:none;vertical-align:middle;"></span><label><input type="checkbox" name="q20" value="E"> <strong>E</strong> It has been tested only in the Netherlands.</label></div>
      </div>
    </div>

    <div class="group">
      <h4>Questions 22‚Äì26</h4>
      <p>Complete the sentences below.</p>
      <p>Choose <strong>NO MORE THAN TWO WORDS</strong> from the passage for each answer.</p>
      <p>Write your answers in boxes <strong>22‚Äì26</strong> on your answer sheet.</p>

      <ol start="22">
        <li style="margin:16px 0;"><span class="flag-btn" data-q="q22" style="left:-20px;"></span>Some of the most severe floods for many centuries have recently occurred in parts of <input type="text" name="q22">.</li>
        <li style="margin:16px 0;"><span class="flag-btn" data-q="q23" style="left:-20px;"></span>The Rhine and the <input type="text" name="q23"> river have experienced similar problems with water control.</li>
        <li style="margin:16px 0;"><span class="flag-btn" data-q="q24" style="left:-20px;"></span>An area near Oxford will be flooded to protect the city of <input type="text" name="q24">.</li>
        <li style="margin:16px 0;"><span class="flag-btn" data-q="q25" style="left:-20px;"></span>Planners who wish to allow water to pass more freely through city surfaces are called <input type="text" name="q25">.</li>
        <li style="margin:16px 0;"><span class="flag-btn" data-q="q26" style="left:-20px;"></span>A proposal for part of the city of <input type="text" name="q26"> could show whether small-scale water projects could be applied on a large scale.</li>
      </ol>
    </div>

    <div class="bottom-bar">
      <button class="btn-primary" onclick="submitAnswers()">Êèê‰∫§</button>
      <button onclick="resetForm()">ÈáçÁΩÆ</button>
      <button onclick="openWrongBook()">Êú¨ÁØáÈîôÈ¢ò</button>
    </div>
  </section>
</div>

<div id="selbar">
  <button id="btnNote">Note</button>
  <button id="btnHL">Highlight</button>
  <button id="btnUH" style="display:none;">Clear Highlight</button>
</div>

<div class="modal" id="resultModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ÊàêÁª©</h2>
      <span class="modal-close" onclick="closeModal('resultModal')">√ó</span>
    </div>
    <div id="resultContent"></div>
    <button class="btn-primary" style="width:100%; margin-top:16px;" onclick="addWrongToBook()">Âä†ÂÖ•ÈîôÈ¢òÊú¨</button>
  </div>
</div>

<div class="modal" id="wrongBookModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Êú¨ÁØáÈîôÈ¢ò</h2>
      <span class="modal-close" onclick="closeModal('wrongBookModal')">√ó</span>
    </div>
    <div id="wrongBookContent"></div>
  </div>
</div>

<div class="modal" id="resetModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ÈáçÁΩÆÁªÉ‰π†</h2>
      <span class="modal-close" onclick="closeModal('resetModal')">√ó</span>
    </div>
    <div style="margin:16px 0;">
      <label style="display:block; margin-bottom:10px;">
        <input type="radio" name="resetType" value="answers" checked>
        Âè™Ê∏ÖÁ©∫Á≠îÊ°à
      </label>
      <label style="display:block;">
        <input type="radio" name="resetType" value="all">
        Ê∏ÖÁ©∫Á≠îÊ°àÂíåÊ†áËÆ∞
      </label>
    </div>
    <button class="btn-primary" style="width:100%;" onclick="confirmReset()">Á°ÆÂÆö</button>
  </div>
</div>

<script>
const PAPER_ID='P2_KEEPING_WATER_AWAY';

let t=0;
const timerEl=document.getElementById('timer');
setInterval(()=>{ t++; timerEl.textContent=String(Math.floor(t/60)).padStart(2,'0')+':'+String(t%60).padStart(2,'0'); }, 1000);

const divider=document.getElementById('divider'), left=document.getElementById('left'), right=document.getElementById('right');
let dragging=false;
divider.onmousedown=()=>{ dragging=true; document.body.style.cursor='ew-resize'; };
window.onmousemove=(e)=>{ if(!dragging)return; const c=document.querySelector('.shell').getBoundingClientRect(); let x=e.clientX-c.left; x=Math.max(280,Math.min(c.width-280,x)); left.style.flex='0 0 '+x+'px'; right.style.flex='1 1 auto'; };
window.onmouseup=()=>{ dragging=false; document.body.style.cursor=''; };

const selbar=document.getElementById('selbar'), btnHL=document.getElementById('btnHL'), btnUH=document.getElementById('btnUH'), btnNote=document.getElementById('btnNote');
let lastRange=null, currentHlNode=null;

function posSelbar(r){ selbar.style.display='flex'; const t=window.scrollY+r.top-selbar.offsetHeight-8; const l=window.scrollX+r.left+r.width/2-selbar.offsetWidth/2; selbar.style.top=((t>0)?t:(window.scrollY+r.bottom+8))+'px'; selbar.style.left=Math.max(8,l)+'px'; }

function updSel(){ const s=window.getSelection(); if(!s||s.rangeCount===0||s.isCollapsed){ if(!currentHlNode)selbar.style.display='none'; return; } const r=s.getRangeAt(0); lastRange=r.cloneRange(); currentHlNode=null; btnNote.style.display='block'; btnHL.style.display='block'; btnUH.style.display='none'; posSelbar(r.getBoundingClientRect()); }

left.onmouseup=updSel; right.onmouseup=updSel;
document.onselectionchange=()=>{ const s=window.getSelection(); if((!s||s.rangeCount===0||s.isCollapsed)&&!currentHlNode)selbar.style.display='none'; };
document.addEventListener('click',(e)=>{ if(e.target.classList&&(e.target.classList.contains('hl')||e.target.classList.contains('note'))){ currentHlNode=e.target; lastRange=null; btnNote.style.display='none'; btnHL.style.display='none'; btnUH.style.display='block'; posSelbar(e.target.getBoundingClientRect()); const s=window.getSelection(); if(s)s.removeAllRanges(); }}, true);

btnHL.onclick=()=>{ if(currentHlNode||!lastRange||lastRange.collapsed)return; const s=document.createElement('span'); s.className='hl'; try{ lastRange.surroundContents(s); }catch(e){ const w=document.createElement('span'); w.className='hl'; w.appendChild(lastRange.cloneContents()); lastRange.deleteContents(); lastRange.insertNode(w); } selbar.style.display='none'; saveHighlights(); };

btnNote.onclick=()=>{ if(currentHlNode||!lastRange||lastRange.collapsed)return; const s=document.createElement('span'); s.className='note'; try{ lastRange.surroundContents(s); }catch(e){ const w=document.createElement('span'); w.className='note'; w.appendChild(lastRange.cloneContents()); lastRange.deleteContents(); lastRange.insertNode(w); } selbar.style.display='none'; saveHighlights(); };

btnUH.onclick=()=>{ if(currentHlNode){ const p=currentHlNode.parentNode; while(currentHlNode.firstChild)p.insertBefore(currentHlNode.firstChild,currentHlNode); p.removeChild(currentHlNode); p.normalize(); currentHlNode=null; selbar.style.display='none'; saveHighlights(); }};

document.querySelectorAll('.flag-btn').forEach(btn => {
  btn.onclick = e => {
    e.stopPropagation();
    btn.classList.toggle('active');
    saveFlags();
  };
});

const answerKey={
  q14:"F",q15:"C",q16:"B",q17:"D",q18:"E",q19:"G",
  q20:["A","D"],
  q22:"central europe",q23:"mississippi",q24:"london",q25:"soft engineers",q26:"los angeles"
};
let lastResults=[];

function saveAnswers() {
  const data = {};
  
  document.querySelectorAll('input[type="text"]').forEach(input => {
    if(input.name && input.value.trim()) {
      data[input.name] = input.value.trim().toLowerCase();
    }
  });
  
  Object.keys(answerKey).forEach(q => {
    if(q === 'q20') {
      const checked = [...document.querySelectorAll('input[name="q20"]:checked')].map(cb => cb.value);
      if(checked.length > 0) data[q] = checked;
    } else if(q.startsWith('q14') || q.startsWith('q15') || q.startsWith('q16') || q.startsWith('q17') || q.startsWith('q18') || q.startsWith('q19')) {
      const ch = document.querySelector(`input[name="${q}"]:checked`);
      if(ch) data[q] = ch.value;
    }
  });
  
  localStorage.setItem(`${PAPER_ID}_answers`, JSON.stringify(data));
}

function loadAnswers() {
  const data = JSON.parse(localStorage.getItem(`${PAPER_ID}_answers`) || '{}');
  
  Object.keys(data).forEach(qid => {
    const value = data[qid];
    
    if(qid === 'q20' && Array.isArray(value)) {
      value.forEach(v => {
        const cb = document.querySelector(`input[name="q20"][value="${v}"]`);
        if(cb) cb.checked = true;
      });
    } else {
      const input = document.querySelector(`input[name="${qid}"]`);
      if(input && input.type === 'text') {
        input.value = value;
      }
      
      const radio = document.querySelector(`input[name="${qid}"][value="${value}"]`);
      if(radio) radio.checked = true;
    }
  });
}

function saveFlags() {
  const flags = [...document.querySelectorAll('.flag-btn.active')].map(b => b.dataset.q);
  localStorage.setItem(`${PAPER_ID}_flags`, JSON.stringify(flags));
}

function loadFlags() {
  const flags = JSON.parse(localStorage.getItem(`${PAPER_ID}_flags`) || '[]');
  flags.forEach(q => document.querySelector(`[data-q="${q}"]`)?.classList.add('active'));
}

function saveHighlights() {
  const highlights = { left: [], right: [] };
  ['left','right'].forEach(pane=>{
    document.querySelectorAll(`#${pane} .hl, #${pane} .note`).forEach((el,idx)=>{
      highlights[pane].push({
        type: el.classList.contains('hl') ? 'hl' : 'note',
        text: el.textContent,
        index: idx
      });
    });
  });
  localStorage.setItem(`${PAPER_ID}_highlights`, JSON.stringify(highlights));
}
function loadHighlights() {
  const data = JSON.parse(localStorage.getItem(`${PAPER_ID}_highlights`) || '{"left":[],"right":[]}');
  ['left','right'].forEach(pane=>{
    if(!data[pane]) return;
    data[pane].forEach(item=>{
      const walker = document.createTreeWalker(document.getElementById(pane), NodeFilter.SHOW_TEXT);
      let node;
      while(node = walker.nextNode()){
        const idx = node.textContent.indexOf(item.text);
        if(idx === -1) continue;
        const parent = node.parentNode;
        const before = node.textContent.substring(0, idx);
        const match  = node.textContent.substring(idx, idx + item.text.length);
        const after  = node.textContent.substring(idx + item.text.length);

        parent.insertBefore(document.createTextNode(before), node);
        const span = document.createElement('span');
        span.className = item.type;
        span.textContent = match;
        parent.insertBefore(span, node);
        parent.insertBefore(document.createTextNode(after), node);
        parent.removeChild(node);
        break;
      }
    });
  });
}

document.querySelectorAll('input[type="text"]').forEach(input => {
  input.addEventListener('input', saveAnswers);
});

document.querySelectorAll('input[type="radio"]').forEach(radio => {
  radio.addEventListener('change', saveAnswers);
});

document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
  cb.addEventListener('change', saveAnswers);
});

document.addEventListener('DOMContentLoaded', () => {
  loadAnswers();
  loadFlags();
  loadHighlights();
});

function submitAnswers(){ 
  const res=[]; 
  let cor=0; 
  
  Object.keys(answerKey).forEach(q=>{ 
    let uA = "";
    let cA = answerKey[q];
    let iC = false;
    
    if(q === 'q20') {
      const checked = [...document.querySelectorAll('input[name="q20"]:checked')].map(cb => cb.value).sort();
      uA = checked.join(',');
      const correct = [...cA].sort();
      iC = checked.length === correct.length && checked.every((v, i) => v === correct[i]);
      cA = correct.join(',');
    } else {
      const input = document.querySelector(`input[name="${q}"]`);
      if(input && input.type === 'text' && input.value.trim()) {
        uA = input.value.trim().toLowerCase();
      }
      
      const ch = document.querySelector(`input[name="${q}"]:checked`);
      if(ch) uA = ch.value;
      
      iC = uA === cA || (typeof cA === 'string' && uA.toLowerCase() === cA.toLowerCase());
    }
    
    if(iC) cor++; 
    res.push({id:q, userAns:uA, correctAns:cA, isCorrect:iC}); 
  }); 
  
  lastResults=res; 
  const tot=Object.keys(answerKey).length; 
  const pct=((cor/tot)*100).toFixed(1); 
  localStorage.setItem(`ielts_score_${PAPER_ID}`, `${cor}/${tot}`);
  document.getElementById('resultContent').innerHTML=`<div class="result-summary"><div class="result-score">${cor} / ${tot}</div><div style="margin-top:8px;font-size:18px;">${pct}%</div></div>${res.map(r=>`<div class="result-item ${r.isCorrect?'correct':'incorrect'}"><div><strong>${r.id}</strong> ${r.isCorrect?'‚úì':'‚úó'}</div><div>‰Ω†ÁöÑÁ≠îÊ°à: ${r.userAns||'(Êú™‰ΩúÁ≠î)'}</div>${!r.isCorrect?`<div>Ê≠£Á°ÆÁ≠îÊ°à: ${r.correctAns}</div>`:''}</div>`).join('')}`; 
  document.getElementById('resultModal').classList.add('active'); 
}

function resetForm(){ 
  document.getElementById('resetModal').classList.add('active'); 
}

function confirmReset(){ 
  const tp=document.querySelector('input[name="resetType"]:checked').value; 
  
  document.querySelectorAll('input[type="text"]').forEach(i=>i.value=''); 
  document.querySelectorAll('input[type="radio"]').forEach(i=>i.checked=false); 
  document.querySelectorAll('input[type="checkbox"]').forEach(i=>i.checked=false);
  localStorage.removeItem(`${PAPER_ID}_answers`);
  
  if(tp==='all'){ 
    document.querySelectorAll('.hl').forEach(el=>{ const p=el.parentNode; while(el.firstChild)p.insertBefore(el.firstChild,el); p.removeChild(el); p.normalize(); }); 
    document.querySelectorAll('.note').forEach(el=>{ const p=el.parentNode; while(el.firstChild)p.insertBefore(el.firstChild,el); p.removeChild(el); p.normalize(); }); 
    document.querySelectorAll('.flag-btn').forEach(b => b.classList.remove('active'));
    localStorage.removeItem(`${PAPER_ID}_highlights`);
    localStorage.removeItem(`${PAPER_ID}_flags`);
  } 
  closeModal('resetModal'); 
}

function addWrongToBook(){ 
  const wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); 
  const wr=lastResults.filter(r=>!r.isCorrect); 
  wr.forEach(r=>{ 
    const en={paperId:PAPER_ID,title:'Keeping the water away',questionId:r.id,correctAnswer:r.correctAns,myAnswer:r.userAns||'(Êú™‰ΩúÁ≠î)',date:new Date().toISOString().split('T')[0]}; 
    const ix=wb.findIndex(i=>i.paperId===en.paperId&&i.questionId===en.questionId); 
    if(ix>=0)wb[ix]=en; else wb.push(en); 
  }); 
  localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); 
  alert(`Â∑≤Ê∑ªÂä† ${wr.length} ÈÅìÈîôÈ¢ò`); 
  closeModal('resultModal'); 
}

function deleteWrongItem(pId,qId){ 
  if(!confirm('Á°ÆÂÆöÂà†Èô§ËøôÈÅìÈîôÈ¢òÔºü'))return; 
  let wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); 
  wb=wb.filter(i=>!(i.paperId===pId&&i.questionId===qId)); 
  localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); 
  openWrongBook(); 
}

function clearCurrentWrongBook(){ 
  if(!confirm('Á°ÆÂÆöÊ∏ÖÁ©∫Êú¨ÁØáÊâÄÊúâÈîôÈ¢òÔºü'))return; 
  let wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); 
  wb=wb.filter(i=>i.paperId!==PAPER_ID); 
  localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); 
  openWrongBook(); 
}

function openWrongBook(){ 
  const wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); 
  const cu=wb.filter(i=>i.paperId===PAPER_ID); 
  const ct=document.getElementById('wrongBookContent'); 
  if(cu.length===0)ct.innerHTML='<div style="text-align:center;padding:40px;color:#666;">ÊöÇÊó†ÈîôÈ¢ò</div>'; 
  else ct.innerHTML=`<div class="modal-actions"><button class="btn-danger" onclick="clearCurrentWrongBook()" style="width:100%;">üóëÔ∏è Ê∏ÖÁ©∫Êú¨ÁØáÈîôÈ¢ò</button></div>${cu.map(i=>`<div class="wrong-item"><div class="wrong-item-content"><div style="font-weight:600;margin-bottom:8px;">${i.questionId}</div><div style="font-size:13px;color:#666;"><div>‚úì Ê≠£Á°Æ: ${i.correctAnswer}</div><div style="color:#d32f2f;">‚úó ÊàëÁöÑ: ${i.myAnswer}</div></div></div><button class="btn-delete" onclick="deleteWrongItem('${i.paperId}','${i.questionId}')">Âà†Èô§</button></div>`).join('')}`; 
  document.getElementById('wrongBookModal').classList.add('active'); 
}

function closeModal(id){ 
  document.getElementById(id).classList.remove('active'); 
}
</script>
</body>
</html>
