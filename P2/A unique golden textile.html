<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>P2 ‚Äì A Unique Golden Textile</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      html,
      body {
        height: 100%;
      }
      body {
        font-family: Arial, sans-serif;
        background: #f5f5f5;
      }

      #timer {
        position: fixed;
        top: 12px;
        right: 12px;
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 8px 12px;
        font-size: 16px;
        font-weight: 600;
        color: #0066cc;
        z-index: 1000;
      }

      .shell {
        display: flex;
        height: 100vh;
        width: 100%;
      }
      .pane {
        background: #fff;
        overflow: auto;
        padding: 24px;
      }
      #left {
        flex: 0 0 50%;
        border-right: 1px solid #ddd;
      }
      #right {
        flex: 1 1 auto;
        background: #fafafa;
      }
      #divider {
        flex: 0 0 5px;
        background: #ddd;
        cursor: ew-resize;
      }
      #divider:hover {
        background: #999;
      }

      h2,
      h3,
      h4 {
        margin: 0 0 12px;
        color: #333;
      }
      h2 {
        font-size: 20px;
      }
      h3 {
        font-size: 18px;
        color: #0066cc;
      }
      h4 {
        font-size: 15px;
        font-weight: 600;
        margin-top: 20px;
      }

      #left p {
        margin: 0 0 14px;
        line-height: 1.7;
        text-align: justify;
      }

      .paragraph-label {
        font-weight: 600;
        color: #0066cc;
        margin-right: 8px;
      }

      .group {
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 16px;
        margin-bottom: 16px;
      }
      .group h4 {
        margin-top: 0;
        color: #0066cc;
      }
      .group p {
        margin: 8px 0;
        font-size: 14px;
        line-height: 1.6;
      }

      .headings {
        background: #f9f9f9;
        padding: 12px;
        margin: 12px 0;
        border-radius: 4px;
      }
      .headings ol {
        margin-left: 20px;
      }
      .headings li {
        margin: 4px 0;
        font-size: 13px;
      }
      .headings ul {
        list-style: none;
        padding-left: 0;
      }
      .headings ul li {
        margin: 4px 0;
        font-size: 13px;
      }

      table {
        border-collapse: collapse;
        width: 100%;
        margin: 12px 0;
      }
      th,
      td {
        border: 1px solid #ddd;
        padding: 6px;
        text-align: center;
        font-size: 13px;
        position: relative;
      }
      th {
        background: #f5f5f5;
        font-weight: 600;
      }

      .flag-btn {
        position: absolute;
        left: 2px;
        top: 50%;
        transform: translateY(-50%);
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #ddd;
        cursor: pointer;
        z-index: 10;
      }
      .flag-btn:hover {
        background: #999;
      }
      .flag-btn.active {
        background: #ff5722;
      }

      tr td:first-child {
        padding-left: 16px;
      }

      .group ol {
        margin-left: 20px;
      }
      .group ol li {
        margin: 12px 0;
        font-size: 14px;
        line-height: 1.6;
        position: relative;
      }
      .group ol li label {
        display: inline-block;
        margin-right: 8px;
      }

      .answer-input {
        width: 150px;
        padding: 6px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }

      .bottom-bar {
        display: flex;
        gap: 10px;
        margin-top: 16px;
      }
      button {
        padding: 10px 20px;
        border: 1px solid #999;
        border-radius: 6px;
        background: #fff;
        cursor: pointer;
        font-size: 14px;
      }
      button:hover {
        background: #f0f0f0;
      }
      .btn-primary {
        background: #0066cc;
        color: #fff;
        border-color: #0066cc;
      }
      .btn-primary:hover {
        background: #0052a3;
      }
      .btn-danger {
        background: #dc3545;
        color: #fff;
        border-color: #dc3545;
      }
      .btn-danger:hover {
        background: #c82333;
      }

      .hl {
        background: #fff59d;
        cursor: pointer;
      }
      .hl:hover {
        background: #ffeb3b;
      }
      .note {
        background: #b3d9ff;
        cursor: pointer;
      }
      .note:hover {
        background: #99ccff;
      }

      #selbar {
        position: fixed;
        display: none;
        z-index: 2000;
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 8px;
        gap: 0;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        flex-direction: column;
        min-width: 120px;
      }
      #selbar button {
        background: #fff;
        color: #666;
        border: none;
        padding: 3px 0px;
        cursor: pointer;
        font-size: 14px;
        text-align: center;
        border-radius: 4px;
      }
      #selbar button:hover {
        background: #f5f5f5;
        color: #333;
      }

      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 3000;
        align-items: center;
        justify-content: center;
      }
      .modal.active {
        display: flex;
      }
      .modal-content {
        background: #fff;
        border-radius: 8px;
        padding: 24px;
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
      }
      .modal-header h2 {
        font-size: 28px;
        color: #333;
        margin: 0;
      }
      .modal-close {
        font-size: 32px;
        cursor: pointer;
        color: #999;
        line-height: 1;
      }
      .modal-close:hover {
        color: #333;
      }

      .result-summary {
        text-align: center;
        padding: 20px;
        background: #f0f0f0;
        margin-bottom: 16px;
        border-radius: 6px;
      }
      .result-score {
        font-size: 36px;
        font-weight: 600;
        color: #0066cc;
      }
      .result-item {
        padding: 10px;
        margin: 8px 0;
        border-left: 3px solid #ddd;
        background: #f9f9f9;
        font-size: 13px;
      }
      .result-item.correct {
        border-left-color: #28a745;
        background: #e8f5e9;
      }
      .result-item.incorrect {
        border-left-color: #dc3545;
        background: #ffebee;
      }

      .wrong-item {
        background: #fff3e0;
        padding: 16px;
        margin: 8px 0;
        border-radius: 8px;
        border-left: 4px solid #ff9800;
        display: flex;
        justify-content: space-between;
        align-items: start;
      }
      .wrong-item-content {
        flex: 1;
      }
      .btn-delete {
        background: #dc3545;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
        margin-left: 12px;
      }
      .btn-delete:hover {
        background: #c82333;
      }
      .modal-actions {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }
    </style>
  </head>
  <body>
    <div id="timer">00:00</div>

    <div class="shell">
      <section class="pane" id="left">
        <h2>READING PASSAGE 2</h2>
        <p>
          You should spend about 20 minutes on Questions 14‚Äì26, which are based
          on Reading Passage 2 below.
        </p>
        <h3>A Unique Golden Textile</h3>
        <p>
          <em
            >A two-man project to use spider silk is achieved after 4 years</em
          >
        </p>

        <p><span class="paragraph-label">Paragraph A</span></p>
        <p>
          A rare textile made from the silk of more than a million wild spiders
          has been on display at the American Museum of Natural History in New
          York City. To produce this golden cloth, 70 people spent four years
          collecting golden-orb spiders from telephone poles in Madagascar,
          while another dozen workers carefully extracted about 80 feet of silk
          filament from each of the arachnids. The resulting 11-foot-by-4-foot
          textile is the only large piece of cloth made from natural spider silk
          in the world today.
        </p>

        <p><span class="paragraph-label">Paragraph B</span></p>
        <p>
          Spider silk is very elastic and strong compared with steel or Kevlar,
          said textile expert Simon Peers, who co-led the project. Kevlar is a
          lightweight synthetic fabric, chemically related to nylon, that is
          used in bullet-proof vests. Kevlar is resistant to wear, tear and heat
          and has virtually no melting point. But the tensile strength of spider
          silk is even greater than Kevlar's aramid filaments and higher than
          that of high-grade steel. Most importantly, spider silk is extremely
          lightweight: a strand long enough to circle the Earth would weigh less
          than 500 grams (18 oz). It is also especially ductile, able to stretch
          up to 140 percent of its length without breaking and to retain its
          strength below ‚Äì40 ¬∞C, giving it toughness equal to that of leading
          commercial fibres.
        </p>

        <p><span class="paragraph-label">Paragraph C</span></p>
        <p>
          Researchers have long been intrigued by the unique properties of
          spider silk. Unfortunately, spider silk is extremely hard to
          mass-produce. Unlike silkworms‚Äîeasy to raise in captivity‚Äîspiders have
          a habit of biting off each other's heads when housed together.
          According to Peers, there is intensive research worldwide aimed at
          replicating spider-silk tensile properties for use in medicine and
          industry, but no-one has yet reproduced all the qualities of natural
          silk.
        </p>

        <p><span class="paragraph-label">Paragraph D</span></p>
        <p>
          Peers conceived the idea of weaving spider silk after reading about
          French missionary Jacob Paul Cambou√©, who worked with spiders in
          Madagascar during the 1880s and 1890s. Cambou√© built a small
          hand-driven machine to extract silk from up to 24 spiders at once,
          without harming them: the spiders were briefly restrained, their silk
          collected, then released. Peers built a replica of this 24-spider
          "silking" machine, said co-leader Nicholas Godley. As a test the pair
          collected about 20 spiders. "When we stuck them in the machine and
          started turning it, lo and behold, this beautiful gold-coloured silk
          started coming out," Godley recalled.
        </p>

        <p><span class="paragraph-label">Paragraph E</span></p>
        <p>
          To make a textile of any significant size, the scale had to increase
          dramatically. Fourteen thousand spiders yield about an ounce of silk,
          Godley said, and the finished textile weighs about 2.6 pounds. By the
          end, handlers had worked with more than one million female golden-orb
          spiders‚Äîabundant in Madagascar and famed for their golden thread.
          Because the spiders produce silk only in the rainy season, all were
          collected between October and June. An additional 12 workers used
          hand-powered machines to extract the silk and twist it into
          96-filament yarn. After "silking", the spiders were released; within a
          week they regenerate their silk, allowing the same individuals to be
          used again‚Äî"the gift that never stops giving," said Godley.
        </p>

        <p><span class="paragraph-label">Paragraph F</span></p>
        <p>
          Spending four years to produce a single piece of cloth is hardly
          practical for scientists or companies hoping to exploit spider silk in
          biomedicine or as a Kevlar alternative. Several groups have inserted
          spider genes into bacteria and even goats to make silk, but results
          have been only partly successful. One reason is that spider silk
          begins as a liquid protein produced in a special gland in the abdomen.
          Using the spinneret, the spider applies force that rearranges the
          protein's molecular structure, transforming it into solid fibre. "When
          we talk about a spider spinning silk, we're talking about how it
          applies forces to convert liquid to solid," explained spider-silk
          expert Todd Blackledge of the University of Akron, who was not
          involved in the project. "Every year we get closer to mass production,
          but we're not there yet." For now, we must be content with one
          extraordinarily beautiful cloth‚Äîcourtesy of more than a million
          spiders.
        </p>
      </section>

      <div id="divider" title="Drag to resize"></div>

      <section class="pane" id="right">
        <h3>Questions</h3>

        <div class="group">
          <h4>Questions 14‚Äì19</h4>
          <p>Reading Passage 2 has six paragraphs, A‚ÄìF.</p>
          <p>
            Choose the correct heading for each paragraph from the list of
            headings below.
          </p>
          <p>
            Write the correct number, <strong>i‚Äìix</strong>, in boxes
            <strong>14‚Äì19</strong> on your answer sheet.
          </p>

          <div class="headings">
            <p><strong>List of Headings</strong></p>
            <ol type="i" style="line-height: 2">
              <li>Experimenting with an old idea</li>
              <li>Life cycle of Madagascar spiders</li>
              <li>Advances in the textile industry</li>
              <li>Resources needed to meet the project's demands</li>
              <li>The physical properties of spider silk</li>
              <li>A scientific analysis of spider silk</li>
              <li>A unique work of art</li>
              <li>Importance of the silk-textile market</li>
              <li>Difficulties of raising spiders in captivity</li>
            </ol>
          </div>

          <table>
            <tr>
              <th>Para</th>
              <th>i</th>
              <th>ii</th>
              <th>iii</th>
              <th>iv</th>
              <th>v</th>
              <th>vi</th>
              <th>vii</th>
              <th>viii</th>
              <th>ix</th>
            </tr>
            <tr>
              <td><span class="flag-btn" data-q="q14"></span>14. A</td>
              <td><input type="radio" name="q14" value="i" /></td>
              <td><input type="radio" name="q14" value="ii" /></td>
              <td><input type="radio" name="q14" value="iii" /></td>
              <td><input type="radio" name="q14" value="iv" /></td>
              <td><input type="radio" name="q14" value="v" /></td>
              <td><input type="radio" name="q14" value="vi" /></td>
              <td><input type="radio" name="q14" value="vii" /></td>
              <td><input type="radio" name="q14" value="viii" /></td>
              <td><input type="radio" name="q14" value="ix" /></td>
            </tr>
            <tr>
              <td><span class="flag-btn" data-q="q15"></span>15. B</td>
              <td><input type="radio" name="q15" value="i" /></td>
              <td><input type="radio" name="q15" value="ii" /></td>
              <td><input type="radio" name="q15" value="iii" /></td>
              <td><input type="radio" name="q15" value="iv" /></td>
              <td><input type="radio" name="q15" value="v" /></td>
              <td><input type="radio" name="q15" value="vi" /></td>
              <td><input type="radio" name="q15" value="vii" /></td>
              <td><input type="radio" name="q15" value="viii" /></td>
              <td><input type="radio" name="q15" value="ix" /></td>
            </tr>
            <tr>
              <td><span class="flag-btn" data-q="q16"></span>16. C</td>
              <td><input type="radio" name="q16" value="i" /></td>
              <td><input type="radio" name="q16" value="ii" /></td>
              <td><input type="radio" name="q16" value="iii" /></td>
              <td><input type="radio" name="q16" value="iv" /></td>
              <td><input type="radio" name="q16" value="v" /></td>
              <td><input type="radio" name="q16" value="vi" /></td>
              <td><input type="radio" name="q16" value="vii" /></td>
              <td><input type="radio" name="q16" value="viii" /></td>
              <td><input type="radio" name="q16" value="ix" /></td>
            </tr>
            <tr>
              <td><span class="flag-btn" data-q="q17"></span>17. D</td>
              <td><input type="radio" name="q17" value="i" /></td>
              <td><input type="radio" name="q17" value="ii" /></td>
              <td><input type="radio" name="q17" value="iii" /></td>
              <td><input type="radio" name="q17" value="iv" /></td>
              <td><input type="radio" name="q17" value="v" /></td>
              <td><input type="radio" name="q17" value="vi" /></td>
              <td><input type="radio" name="q17" value="vii" /></td>
              <td><input type="radio" name="q17" value="viii" /></td>
              <td><input type="radio" name="q17" value="ix" /></td>
            </tr>
            <tr>
              <td><span class="flag-btn" data-q="q18"></span>18. E</td>
              <td><input type="radio" name="q18" value="i" /></td>
              <td><input type="radio" name="q18" value="ii" /></td>
              <td><input type="radio" name="q18" value="iii" /></td>
              <td><input type="radio" name="q18" value="iv" /></td>
              <td><input type="radio" name="q18" value="v" /></td>
              <td><input type="radio" name="q18" value="vi" /></td>
              <td><input type="radio" name="q18" value="vii" /></td>
              <td><input type="radio" name="q18" value="viii" /></td>
              <td><input type="radio" name="q18" value="ix" /></td>
            </tr>
            <tr>
              <td><span class="flag-btn" data-q="q19"></span>19. F</td>
              <td><input type="radio" name="q19" value="i" /></td>
              <td><input type="radio" name="q19" value="ii" /></td>
              <td><input type="radio" name="q19" value="iii" /></td>
              <td><input type="radio" name="q19" value="iv" /></td>
              <td><input type="radio" name="q19" value="v" /></td>
              <td><input type="radio" name="q19" value="vi" /></td>
              <td><input type="radio" name="q19" value="vii" /></td>
              <td><input type="radio" name="q19" value="viii" /></td>
              <td><input type="radio" name="q19" value="ix" /></td>
            </tr>
          </table>
        </div>

        <div class="group">
          <h4>Questions 20‚Äì23</h4>
          <p>
            Look at the following statements (Questions 20‚Äì23) and the list of
            researchers below.
          </p>
          <p>
            Match each statement with the correct researcher,
            <strong>A, B or C</strong>.
          </p>
          <p>
            Write the correct letter, <strong>A, B or C</strong>, in boxes
            <strong>20‚Äì23</strong> on your answer sheet.
          </p>
          <p><strong>NB</strong> You may use any letter more than once.</p>

          <div class="headings">
            <p><strong>List of Researchers</strong></p>
            <ul style="line-height: 2">
              <li>A. Simon Peers</li>
              <li>B. Nicholas Godley</li>
              <li>C. Todd Blackledge</li>
            </ul>
          </div>

          <ol start="20">
            <li>
              <span class="flag-btn" data-q="q20" style="left: -20px"></span>It
              takes a tremendous number of spiders to make a small amount of
              silk.<br />
              <label><input type="radio" name="q20" value="A" /> A</label>
              <label><input type="radio" name="q20" value="B" /> B</label>
              <label><input type="radio" name="q20" value="C" /> C</label>
            </li>
            <li>
              <span class="flag-btn" data-q="q21" style="left: -20px"></span
              >Scientists want to use the qualities of spider silk for medical
              purposes.<br />
              <label><input type="radio" name="q21" value="A" /> A</label>
              <label><input type="radio" name="q21" value="B" /> B</label>
              <label><input type="radio" name="q21" value="C" /> C</label>
            </li>
            <li>
              <span class="flag-btn" data-q="q22" style="left: -20px"></span
              >Scientists are making some progress in their efforts to
              manufacture spider silk.<br />
              <label><input type="radio" name="q22" value="A" /> A</label>
              <label><input type="radio" name="q22" value="B" /> B</label>
              <label><input type="radio" name="q22" value="C" /> C</label>
            </li>
            <li>
              <span class="flag-btn" data-q="q23" style="left: -20px"></span
              >Spider silk compares favourably to materials known for their
              strength.<br />
              <label><input type="radio" name="q23" value="A" /> A</label>
              <label><input type="radio" name="q23" value="B" /> B</label>
              <label><input type="radio" name="q23" value="C" /> C</label>
            </li>
          </ol>
        </div>

        <div class="group">
          <h4>Questions 24‚Äì26</h4>
          <p>Complete the summary below.</p>
          <p>
            Choose <strong>ONE WORD ONLY</strong> from the passage for each
            answer.
          </p>
          <p>
            Write your answers in boxes <strong>24‚Äì26</strong> on your answer
            sheet.
          </p>

          <h5 style="margin-top: 12px">Producing spider silk in the lab</h5>
          <p style="line-height: 1.8; margin-top: 8px">
            Both scientists and manufacturers are interested in producing silk
            for many different purposes. Some researchers have tried to grow
            silk by introducing genetic material into
            <span
              class="flag-btn"
              data-q="q24"
              style="position: relative; display: inline-block; margin: 0 4px"
            ></span
            ><strong>24.</strong>
            <input type="text" class="answer-input" id="q24" /> and some
            animals. But these experiments have been somewhat disappointing.
          </p>
          <p style="line-height: 1.8; margin-top: 8px">
            It is difficult to make spider silk in a lab setting because the
            silk comes from a liquid protein made in a
            <span
              class="flag-btn"
              data-q="q25"
              style="position: relative; display: inline-block; margin: 0 4px"
            ></span
            ><strong>25.</strong>
            <input type="text" class="answer-input" id="q25" /> inside the
            spider's body. When a spider spins silk, it applies
            <span
              class="flag-btn"
              data-q="q26"
              style="position: relative; display: inline-block; margin: 0 4px"
            ></span
            ><strong>26.</strong>
            <input type="text" class="answer-input" id="q26" /> that turns this
            liquid into solid silk. Scientists cannot replicate this yet.
          </p>
        </div>

        <div class="bottom-bar">
          <button class="btn-primary" onclick="submitAnswers()">Êèê‰∫§</button>
          <button onclick="resetForm()">ÈáçÁΩÆ</button>
          <button onclick="openWrongBook()">Êú¨ÁØáÈîôÈ¢ò</button>
        </div>
      </section>
    </div>

    <div id="selbar">
      <button id="btnNote">Note</button>
      <button id="btnHL">Highlight</button>
      <button id="btnUH" style="display: none">Clear Highlight</button>
    </div>

    <div class="modal" id="resultModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>ÊàêÁª©</h2>
          <span class="modal-close" onclick="closeModal('resultModal')">√ó</span>
        </div>
        <div id="resultContent"></div>
        <button
          class="btn-primary"
          style="width: 100%; margin-top: 16px"
          onclick="addWrongToBook()"
        >
          Âä†ÂÖ•ÈîôÈ¢òÊú¨
        </button>
      </div>
    </div>

    <div class="modal" id="wrongBookModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Êú¨ÁØáÈîôÈ¢ò</h2>
          <span class="modal-close" onclick="closeModal('wrongBookModal')"
            >√ó</span
          >
        </div>
        <div id="wrongBookContent"></div>
      </div>
    </div>

    <div class="modal" id="resetModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>ÈáçÁΩÆÁªÉ‰π†</h2>
          <span class="modal-close" onclick="closeModal('resetModal')">√ó</span>
        </div>
        <div style="margin: 16px 0">
          <label style="display: block; margin-bottom: 10px">
            <input type="radio" name="resetType" value="answers" checked />
            Âè™Ê∏ÖÁ©∫Á≠îÊ°à
          </label>
          <label style="display: block">
            <input type="radio" name="resetType" value="all" />
            Ê∏ÖÁ©∫Á≠îÊ°àÂíåÊ†áËÆ∞
          </label>
        </div>
        <button
          class="btn-primary"
          style="width: 100%"
          onclick="confirmReset()"
        >
          Á°ÆÂÆö
        </button>
      </div>
    </div>

    <script>
      const PAPER_ID = "P2_SPIDER_SILK";

      let t = 0;
      const timerEl = document.getElementById("timer");
      setInterval(() => {
        t++;
        timerEl.textContent =
          String(Math.floor(t / 60)).padStart(2, "0") +
          ":" +
          String(t % 60).padStart(2, "0");
      }, 1000);

      const divider = document.getElementById("divider"),
        left = document.getElementById("left"),
        right = document.getElementById("right");
      let dragging = false;
      divider.onmousedown = () => {
        dragging = true;
        document.body.style.cursor = "ew-resize";
      };
      window.onmousemove = (e) => {
        if (!dragging) return;
        const c = document.querySelector(".shell").getBoundingClientRect();
        let x = e.clientX - c.left;
        x = Math.max(280, Math.min(c.width - 280, x));
        left.style.flex = "0 0 " + x + "px";
        right.style.flex = "1 1 auto";
      };
      window.onmouseup = () => {
        dragging = false;
        document.body.style.cursor = "";
      };

      const selbar = document.getElementById("selbar"),
        btnHL = document.getElementById("btnHL"),
        btnUH = document.getElementById("btnUH"),
        btnNote = document.getElementById("btnNote");
      let lastRange = null,
        currentHlNode = null;

      function posSelbar(r) {
        selbar.style.display = "flex";
        const t = window.scrollY + r.top - selbar.offsetHeight - 8;
        const l =
          window.scrollX + r.left + r.width / 2 - selbar.offsetWidth / 2;
        selbar.style.top = (t > 0 ? t : window.scrollY + r.bottom + 8) + "px";
        selbar.style.left = Math.max(8, l) + "px";
      }

      function updSel() {
        const s = window.getSelection();
        if (!s || s.rangeCount === 0 || s.isCollapsed) {
          if (!currentHlNode) selbar.style.display = "none";
          return;
        }
        const r = s.getRangeAt(0);
        lastRange = r.cloneRange();
        currentHlNode = null;
        btnNote.style.display = "block";
        btnHL.style.display = "block";
        btnUH.style.display = "none";
        posSelbar(r.getBoundingClientRect());
      }

      left.onmouseup = updSel;
      right.onmouseup = updSel;
      document.onselectionchange = () => {
        const s = window.getSelection();
        if ((!s || s.rangeCount === 0 || s.isCollapsed) && !currentHlNode)
          selbar.style.display = "none";
      };
      document.addEventListener(
        "click",
        (e) => {
          if (
            e.target.classList &&
            (e.target.classList.contains("hl") ||
              e.target.classList.contains("note"))
          ) {
            currentHlNode = e.target;
            lastRange = null;
            btnNote.style.display = "none";
            btnHL.style.display = "none";
            btnUH.style.display = "block";
            posSelbar(e.target.getBoundingClientRect());
            const s = window.getSelection();
            if (s) s.removeAllRanges();
          }
        },
        true
      );

      btnHL.onclick = () => {
        if (currentHlNode || !lastRange || lastRange.collapsed) return;
        const s = document.createElement("span");
        s.className = "hl";
        try {
          lastRange.surroundContents(s);
        } catch (e) {
          const w = document.createElement("span");
          w.className = "hl";
          w.appendChild(lastRange.cloneContents());
          lastRange.deleteContents();
          lastRange.insertNode(w);
        }
        selbar.style.display = "none";
        saveHighlights();
      };

      btnNote.onclick = () => {
        if (currentHlNode || !lastRange || lastRange.collapsed) return;
        const s = document.createElement("span");
        s.className = "note";
        try {
          lastRange.surroundContents(s);
        } catch (e) {
          const w = document.createElement("span");
          w.className = "note";
          w.appendChild(lastRange.cloneContents());
          lastRange.deleteContents();
          lastRange.insertNode(w);
        }
        selbar.style.display = "none";
        saveHighlights();
      };

      btnUH.onclick = () => {
        if (currentHlNode) {
          const p = currentHlNode.parentNode;
          while (currentHlNode.firstChild)
            p.insertBefore(currentHlNode.firstChild, currentHlNode);
          p.removeChild(currentHlNode);
          p.normalize();
          currentHlNode = null;
          selbar.style.display = "none";
          saveHighlights();
        } else if (lastRange) {
          const sR = lastRange.getBoundingClientRect();
          const w = document.createTreeWalker(
            document.body,
            NodeFilter.SHOW_ELEMENT
          );
          const tr = [];
          while (w.nextNode()) {
            const n = w.currentNode;
            if (
              n.classList &&
              (n.classList.contains("hl") || n.classList.contains("note"))
            ) {
              const r = n.getBoundingClientRect();
              if (
                !(
                  r.right < sR.left ||
                  r.left > sR.right ||
                  r.bottom < sR.top ||
                  r.top > sR.bottom
                )
              )
                tr.push(n);
            }
          }
          tr.forEach((el) => {
            const p = el.parentNode;
            while (el.firstChild) p.insertBefore(el.firstChild, el);
            p.removeChild(el);
            p.normalize();
          });
          selbar.style.display = "none";
          saveHighlights();
        }
      };

      document.querySelectorAll(".flag-btn").forEach((btn) => {
        btn.onclick = (e) => {
          e.stopPropagation();
          btn.classList.toggle("active");
          saveFlags();
        };
      });

      const answerKey = {
        q14: "vii",
        q15: "v",
        q16: "ix",
        q17: "i",
        q18: "iv",
        q19: "vi",
        q20: "B",
        q21: "A",
        q22: "C",
        q23: "A",
        q24: "bacteria",
        q25: "gland",
        q26: "force",
      };
      let lastResults = [];

      function saveAnswers() {
        const data = {};
        Object.keys(answerKey).forEach((q) => {
          const el = document.querySelector(`input[name="${q}"]`);
          if (!el) {
            const textInput = document.getElementById(q);
            if (textInput && textInput.value.trim())
              data[q] = textInput.value.trim();
          } else if (el.type === "radio") {
            const ch = document.querySelector(`input[name="${q}"]:checked`);
            if (ch) data[q] = ch.value;
          }
        });
        localStorage.setItem(`${PAPER_ID}_answers`, JSON.stringify(data));
      }

      function loadAnswers() {
        const data = JSON.parse(
          localStorage.getItem(`${PAPER_ID}_answers`) || "{}"
        );
        Object.keys(data).forEach((q) => {
          const radio = document.querySelector(
            `input[name="${q}"][value="${data[q]}"]`
          );
          if (radio) {
            radio.checked = true;
          } else {
            const textInput = document.getElementById(q);
            if (textInput) textInput.value = data[q];
          }
        });
      }

      function saveFlags() {
        const flags = [...document.querySelectorAll(".flag-btn.active")].map(
          (b) => b.dataset.q
        );
        localStorage.setItem(`${PAPER_ID}_flags`, JSON.stringify(flags));
      }

      function loadFlags() {
        const flags = JSON.parse(
          localStorage.getItem(`${PAPER_ID}_flags`) || "[]"
        );
        flags.forEach((q) =>
          document.querySelector(`[data-q="${q}"]`)?.classList.add("active")
        );
      }

      function saveHighlights() {
        const highlights = { left: [], right: [] };

        document
          .querySelectorAll("#left .hl, #left .note")
          .forEach((el, idx) => {
            highlights.left.push({
              type: el.classList.contains("hl") ? "hl" : "note",
              text: el.textContent,
              index: idx,
            });
          });

        document
          .querySelectorAll("#right .hl, #right .note")
          .forEach((el, idx) => {
            highlights.right.push({
              type: el.classList.contains("hl") ? "hl" : "note",
              text: el.textContent,
              index: idx,
            });
          });

        localStorage.setItem(
          `${PAPER_ID}_highlights`,
          JSON.stringify(highlights)
        );
      }

      function loadHighlights() {
        const data = JSON.parse(
          localStorage.getItem(`${PAPER_ID}_highlights`) ||
            '{"left":[],"right":[]}'
        );

        // Â∑¶ËæπÂÜÖÂÆπÊÅ¢Â§ç
        data.left.forEach((item) => restoreHighlight(left, item));

        // Âè≥ËæπÂÜÖÂÆπÊÅ¢Â§ç
        data.right.forEach((item) => restoreHighlight(right, item));
      }

      function restoreHighlight(container, item) {
        const walker = document.createTreeWalker(
          container,
          NodeFilter.SHOW_TEXT
        );
        let node;
        while ((node = walker.nextNode())) {
          if (node.textContent.includes(item.text)) {
            const span = document.createElement("span");
            span.className = item.type;

            const parent = node.parentNode;
            const text = node.textContent;
            const idx = text.indexOf(item.text);

            if (idx >= 0) {
              const before = text.substring(0, idx);
              const match = text.substring(idx, idx + item.text.length);
              const after = text.substring(idx + item.text.length);

              parent.insertBefore(document.createTextNode(before), node);
              span.textContent = match;
              parent.insertBefore(span, node);
              parent.insertBefore(document.createTextNode(after), node);
              parent.removeChild(node);
              break;
            }
          }
        }
      }

      document.querySelectorAll('input[type="radio"]').forEach((radio) => {
        radio.addEventListener("change", saveAnswers);
      });
      document.querySelectorAll('input[type="text"]').forEach((input) => {
        input.addEventListener("input", saveAnswers);
      });

      document.addEventListener("DOMContentLoaded", () => {
        loadAnswers();
        loadFlags();
        loadHighlights();
      });

      function submitAnswers() {
        const res = [];
        let cor = 0;
        Object.keys(answerKey).forEach((q) => {
          let uA = "";
          const radio = document.querySelector(`input[name="${q}"]:checked`);
          if (radio) {
            uA = radio.value;
          } else {
            const textInput = document.getElementById(q);
            if (textInput) uA = textInput.value.trim().toLowerCase();
          }
          const cA = answerKey[q];
          let u = uA.trim().toLowerCase();
          let c = cA.trim().toLowerCase();
          const iC = u === c;

          if (iC) cor++;
          res.push({
            id: q,
            userAns: uA || "(Êú™‰ΩúÁ≠î)",
            correctAns: cA,
            isCorrect: iC,
          });
        });
        lastResults = res;
        const tot = Object.keys(answerKey).length;
        const pct = ((cor / tot) * 100).toFixed(1);
        localStorage.setItem(`ielts_score_${PAPER_ID}`, `${cor}/${tot}`);
        document.getElementById(
          "resultContent"
        ).innerHTML = `<div class="result-summary"><div class="result-score">${cor} / ${tot}</div><div style="margin-top:8px;font-size:18px;">${pct}%</div></div>${res
          .map(
            (r) =>
              `<div class="result-item ${
                r.isCorrect ? "correct" : "incorrect"
              }"><div><strong>${r.id}</strong> ${
                r.isCorrect ? "‚úì" : "‚úó"
              }</div><div>‰Ω†ÁöÑÁ≠îÊ°à: ${r.userAns}</div>${
                !r.isCorrect ? `<div>Ê≠£Á°ÆÁ≠îÊ°à: ${r.correctAns}</div>` : ""
              }</div>`
          )
          .join("")}`;
        document.getElementById("resultModal").classList.add("active");
      }

      function resetForm() {
        document.getElementById("resetModal").classList.add("active");
      }

      function confirmReset() {
        const tp = document.querySelector(
          'input[name="resetType"]:checked'
        ).value;
        document
          .querySelectorAll('input[type="radio"]')
          .forEach((i) => (i.checked = false));
        document
          .querySelectorAll('input[type="text"]')
          .forEach((i) => (i.value = ""));
        localStorage.removeItem(`${PAPER_ID}_answers`);

        if (tp === "all") {
          document.querySelectorAll(".hl").forEach((el) => {
            const p = el.parentNode;
            while (el.firstChild) p.insertBefore(el.firstChild, el);
            p.removeChild(el);
            p.normalize();
          });
          document.querySelectorAll(".note").forEach((el) => {
            const p = el.parentNode;
            while (el.firstChild) p.insertBefore(el.firstChild, el);
            p.removeChild(el);
            p.normalize();
          });
          document
            .querySelectorAll(".flag-btn")
            .forEach((b) => b.classList.remove("active"));
          localStorage.removeItem(`${PAPER_ID}_highlights`);
          localStorage.removeItem(`${PAPER_ID}_flags`);
        }
        closeModal("resetModal");
      }

      function addWrongToBook() {
        const wb = JSON.parse(localStorage.getItem("ielts_wrong_book") || "[]");
        const wr = lastResults.filter((r) => !r.isCorrect);
        wr.forEach((r) => {
          const en = {
            paperId: PAPER_ID,
            title: "A Unique Golden Textile",
            questionId: r.id,
            correctAnswer: r.correctAns,
            myAnswer: r.userAns,
            date: new Date().toISOString().split("T")[0],
          };
          const ix = wb.findIndex(
            (i) => i.paperId === en.paperId && i.questionId === en.questionId
          );
          if (ix >= 0) wb[ix] = en;
          else wb.push(en);
        });
        localStorage.setItem("ielts_wrong_book", JSON.stringify(wb));
        alert(`Â∑≤Ê∑ªÂä† ${wr.length} ÈÅìÈîôÈ¢ò`);
        closeModal("resultModal");
      }

      function deleteWrongItem(pId, qId) {
        if (!confirm("Á°ÆÂÆöÂà†Èô§ËøôÈÅìÈîôÈ¢òÔºü")) return;
        let wb = JSON.parse(localStorage.getItem("ielts_wrong_book") || "[]");
        wb = wb.filter((i) => !(i.paperId === pId && i.questionId === qId));
        localStorage.setItem("ielts_wrong_book", JSON.stringify(wb));
        openWrongBook();
      }

      function clearCurrentWrongBook() {
        if (!confirm("Á°ÆÂÆöÊ∏ÖÁ©∫Êú¨ÁØáÊâÄÊúâÈîôÈ¢òÔºü")) return;
        let wb = JSON.parse(localStorage.getItem("ielts_wrong_book") || "[]");
        wb = wb.filter((i) => i.paperId !== PAPER_ID);
        localStorage.setItem("ielts_wrong_book", JSON.stringify(wb));
        openWrongBook();
      }

      function openWrongBook() {
        const wb = JSON.parse(localStorage.getItem("ielts_wrong_book") || "[]");
        const cu = wb.filter((i) => i.paperId === PAPER_ID);
        const ct = document.getElementById("wrongBookContent");
        if (cu.length === 0)
          ct.innerHTML =
            '<div style="text-align:center;padding:40px;color:#666;">ÊöÇÊó†ÈîôÈ¢ò</div>';
        else
          ct.innerHTML = `<div class="modal-actions"><button class="btn-danger" onclick="clearCurrentWrongBook()" style="width:100%;">üóëÔ∏è Ê∏ÖÁ©∫Êú¨ÁØáÈîôÈ¢ò</button></div>${cu
            .map(
              (i) =>
                `<div class="wrong-item"><div class="wrong-item-content"><div style="font-weight:600;margin-bottom:8px;">${i.questionId}</div><div style="font-size:13px;color:#666;"><div>‚úì Ê≠£Á°Æ: ${i.correctAnswer}</div><div style="color:#d32f2f;">‚úó ÊàëÁöÑ: ${i.myAnswer}</div></div></div><button class="btn-delete" onclick="deleteWrongItem('${i.paperId}','${i.questionId}')">Âà†Èô§</button></div>`
            )
            .join("")}`;
        document.getElementById("wrongBookModal").classList.add("active");
      }

      function closeModal(id) {
        document.getElementById(id).classList.remove("active");
      }
    </script>
  </body>
</html>
