<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>P1 ‚Äì The history of the guitar</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  * { box-sizing: border-box; margin:0; padding:0; }
  html,body { height:100%; }
  body { font-family: Arial, sans-serif; background:#f5f5f5; }
  
  #timer { position:fixed; top:12px; right:12px; background:#fff; border:1px solid #ddd; border-radius:6px; padding:8px 12px; font-size:16px; font-weight:600; color:#0066cc; z-index:1000; }
  
  .shell { display:flex; height:100vh; width:100%; }
  .pane { background:#fff; overflow:auto; padding:24px; }
  #left { flex: 0 0 50%; border-right:1px solid #ddd; }
  #right { flex: 1 1 auto; background:#fafafa; }
  #divider { flex: 0 0 5px; background:#ddd; cursor: ew-resize; }
  #divider:hover { background:#999; }
  
  h2,h3,h4 { margin:0 0 12px; color:#333; }
  h2 { font-size:20px; }
  h3 { font-size:18px; color:#0066cc; }
  h4 { font-size:15px; font-weight:600; margin-top:20px; }
  
  #left p { margin: 0 0 14px; line-height: 1.7; text-align:justify; }
  
  .group { background:#fff; border:1px solid #ddd; border-radius:6px; padding:16px; margin-bottom:16px; }
  .group h4 { margin-top:0; color:#0066cc; }
  .group p { margin:8px 0; font-size:14px; line-height:1.6; }
  
  table { border-collapse: collapse; width:100%; margin:12px 0; }
  th, td { border:1px solid #ddd; padding:6px; text-align:left; font-size:13px; position:relative; }
  th { background:#f5f5f5; font-weight:600; }
  
  .flag-btn { 
    position:absolute; 
    left:2px; 
    top:50%;
    transform:translateY(-50%);
    width:8px;
    height:8px;
    border-radius:50%;
    background:#ddd;
    cursor:pointer;
    z-index:10;
  }
  .flag-btn:hover { background:#999; }
  .flag-btn.active { background:#ff5722; }
  
  .question-item { padding:12px 0; border-top:1px dashed #ddd; position:relative; padding-left:20px; }
  .question-item:first-child { border-top:none; }
  
  input.blank { 
    border:none;
    border-bottom:1px solid #666;
    padding:4px 8px;
    margin:0 4px;
    min-width:120px;
    font-size:14px;
  }
  input.blank:focus { outline:none; border-bottom:2px solid #0066cc; }
  
  .answer-option { display:flex; gap:12px; margin-top:8px; flex-wrap:wrap; }
  .answer-option label { cursor:pointer; display:flex; align-items:center; gap:4px; }
  
  .bottom-bar { display:flex; gap:10px; margin-top:16px; }
  button { padding:10px 20px; border:1px solid #999; border-radius:6px; background:#fff; cursor:pointer; font-size:14px; }
  button:hover { background:#f0f0f0; }
  .btn-primary { background:#0066cc; color:#fff; border-color:#0066cc; }
  .btn-primary:hover { background:#0052a3; }
  .btn-danger { background:#dc3545; color:#fff; border-color:#dc3545; }
  .btn-danger:hover { background:#c82333; }
  
  .hl { background:#fff59d; cursor:pointer; }
  .hl:hover { background:#ffeb3b; }
  .note { background:#b3d9ff; cursor:pointer; }
  .note:hover { background:#99ccff; }
  
  #selbar { position:fixed; display:none; z-index:2000; background:#fff; border:1px solid #ddd; border-radius:8px; padding:8px; gap:0; box-shadow:0 2px 8px rgba(0,0,0,0.15); flex-direction:column; min-width:120px; }
  #selbar button { background:#fff; color:#666; border:none; padding:3px 0px; cursor:pointer; font-size:14px; text-align:center; border-radius:4px; }
  #selbar button:hover { background:#f5f5f5; color:#333; }
  
  .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:3000; align-items:center; justify-content:center; }
  .modal.active { display:flex; }
  .modal-content { background:#fff; border-radius:8px; padding:24px; max-width:600px; width:90%; max-height:80vh; overflow-y:auto; }
  
  .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
  .modal-header h2 { font-size: 28px; color: #333; margin: 0; }
  .modal-close { font-size: 32px; cursor: pointer; color: #999; line-height: 1; }
  .modal-close:hover { color: #333; }
  
  .result-summary { text-align:center; padding:20px; background:#f0f0f0; margin-bottom:16px; border-radius:6px; }
  .result-score { font-size:36px; font-weight:600; color:#0066cc; }
  .result-item { padding:10px; margin:8px 0; border-left:3px solid #ddd; background:#f9f9f9; font-size:13px; }
  .result-item.correct { border-left-color:#28a745; background:#e8f5e9; }
  .result-item.incorrect { border-left-color:#dc3545; background:#ffebee; }
  
  .wrong-item { background:#fff3e0; padding:16px; margin:8px 0; border-radius:8px; border-left:4px solid #ff9800; display:flex; justify-content:space-between; align-items:start; }
  .wrong-item-content { flex:1; }
  .btn-delete { background:#dc3545; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-size:13px; margin-left:12px; }
  .btn-delete:hover { background:#c82333; }
  .modal-actions { display:flex; gap:10px; margin-bottom:20px; }
</style>
</head>
<body>
<div id="timer">00:00</div>

<div class="shell">
  <section class="pane" id="left">
    
<h2>READING PASSAGE 1</h2>
<p>You should spend about 20 minutes on Questions 1‚Äì13, which are based on Reading Passage 1 below.</p>
<h3>The history of the guitar</h3>
<h4 style="font-style:italic; font-weight:normal; color:#666;">An overview of the origins of the modern guitar</h4>

<p>The earliest stringed instruments currently known to archaeologists are bowl harps. For millennia, people made bowl harps using, for example, tortoise shells as resonators, with a bent stick for a neck and one or more gut or silk strings. The world's museums contain many such harps from the ancient Sumerian, Babylonian, and Egyptian civilisations. Around 2500-2000 BC, more advanced harps, such as the beautifully carved 11-stringed instrument found in the tomb of Queen Shub-Ad in ancient Mesopotamia, now modern-day Iraq, started to appear.</p>

<p>The tanbur* probably developed from the bowl harp. It was different from the bowl harp in that its neck was straightened out to allow the strings to be pressed down to create more notes. Tomb paintings and stone carvings in Egypt indicate that harps and tanburs ‚Äì plus flutes and percussion instruments ‚Äì were being played together 3,500-4,000 years ago. Archaeologists have also found many similar relics amongst the ruins of the ancient Mesopotamian civilisation. Many of these instruments have survived into modern times in almost unchanged form, for example, folk instruments of the region such as the Turkish saz and Afghan panchtar.</p>

<p>At 3,500 years old, the tanbur which belonged to the Egyptian singer Har-Mose is the earliest known example of this instrument. Har-Mose's tanbur had three strings and a plectrum suspended from the neck by a cord. The soundbox, which increased the volume, was made of beautifully polished cedarwood and covered in rawhide. It can be seen today at the Archaeological Museum in Cairo.</p>

<p>In order to distinguish guitars from other stringed instruments, it is helpful to have a broad definition of the guitar. Music expert Dr Michael Kasha defines a guitar as having 'a long, fretted neck, flat wooden soundboard, ribs, and a flat back, most often with sides that curve inwards'. The oldest known visual representation of such an instrument is a stone carving at Alaca Huyuk in Turkey, which shows a 3,300-year-old instrument with a long neck and sides that clearly curve inwards.</p>

<p style="font-size:13px; color:#666; font-style:italic;">tanbur*: a long-necked stringed instrument with a small pear-shaped body</p>

<p>The name 'guitar' comes from the ancient Sanskrit word for 'string' ‚Äì 'tar'. Many popular stringed instruments used in Central Asia today have existed in an unchanged form for several thousand years, as shown by archaeological finds in the area. Many have names that end in 'tar', with a prefix indicating the number of strings, such as the doter, a two-stringed instrument found in Turkestan, and the Persian three-stringed setar and four-stringed chartar. The Indian sitar almost certainly took its name from the setar, but over the centuries it evolved radically, following the Indians' own aesthetic and cultural ideals.</p>

<p>Tanburs and harps spread around the ancient world with travellers, merchants and seamen. The earliest guitar-like instruments to arrive in Europe had, most often, four strings. Many such instruments, and variations with from three to five strings, can be seen in mediaeval illustrated manuscripts. They were also carved in stone in European churches and cathedrals, from the first century AD through until the 13th century.</p>

<p>When the four-stringed Persian chartar arrived in Spain, however, it changed in form and construction, acquiring pairs of strings tuned to the same note instead of single strings. It became known as the chitarra. By the middle of the 14th century, the chitarra had become dominant, at least in most of Europe. The earliest known music for the eight-stringed chitarra was written in 16th-century Spain. The ten-string version first appeared in Italy at the same time, and gradually replaced the eight-stringed instrument. A further two strings first appeared in the 17th century, an innovation which guitar makers all over Europe quickly took up. However, this twelve-string arrangement gradually gave way to six single strings across the continent. The six-stringed guitar can thus be said to be a development of the twelve-string, rather than vice versa, as was thought previously.</p>

<p>At the beginning of the 19th century, the present-day guitar began to take shape, although bodies were still fairly small and narrow-waisted. The modern classical guitar first appeared in its current form in the mid-19th century, when the Spanish guitar maker Antonio Torres increased the size of the body, altered its proportions, and introduced the revolutionary fan-braced top**. His design radically increased the volume and improved the tone of the instrument, and very soon became the norm. This design has remained essentially unchanged to this day.</p>

<p>At the time when Torres made his breakthrough, German immigrants to America ‚Äì among them Christian Friedrich Martin ‚Äì began making guitars with X-braced tops. Steel strings, which became widely available several decades later in the early 1900s, offered the promise of a much louder guitar, but the increased tension was too much for the fan-braced top. The stronger X-braced top proved equal to the job, and quickly became the industry standard.</p>

<p>At the end of the 19th century, guitar manufacturer Orville Gibson added steel strings to a body constructed like a cello, a combination which produced more volume. The electric guitar was born when pickups were fitted to Hawaiian and jazz guitars in the late 1920s, but met with little success until 1936, when Gibson introduced its famous ES150 model.</p>

<p style="font-size:13px; color:#666; font-style:italic;">fan-braced top**: a strengthening structure in the shape of a fan inserted into the soundbox</p>

  </section>

  <div id="divider" title="Drag to resize"></div>

  <section class="pane" id="right">
    <h3>Questions</h3>

    <div class="group">
      <h4>Questions 1‚Äì6</h4>
      <p>Do the following statements agree with the information given in Reading Passage 1?</p>
      <p>In boxes 1‚Äì6 on your answer sheet, write</p>

      <table style="margin:12px 0;">
        <tr>
          <th>TRUE</th>
          <td>if the statement agrees with the information</td>
        </tr>
        <tr>
          <th>FALSE</th>
          <td>if the statement contradicts the information</td>
        </tr>
        <tr>
          <th>NOT GIVEN</th>
          <td>if there is no information on this</td>
        </tr>
      </table>

      <div class="question-item">
        <span class="flag-btn" data-q="q1"></span>
        <p><strong>1.</strong> The instrument found in Queen Shub-Ad's tomb is the world's oldest known version of a harp.</p>
        <div class="answer-option">
          <label><input type="radio" name="q1" value="TRUE"> TRUE</label>
          <label><input type="radio" name="q1" value="FALSE"> FALSE</label>
          <label><input type="radio" name="q1" value="NOT GIVEN"> NOT GIVEN</label>
        </div>
      </div>

      <div class="question-item">
        <span class="flag-btn" data-q="q2"></span>
        <p><strong>2.</strong> Today's Afghan panchtar is very similar to an ancient Mesopotamian instrument.</p>
        <div class="answer-option">
          <label><input type="radio" name="q2" value="TRUE"> TRUE</label>
          <label><input type="radio" name="q2" value="FALSE"> FALSE</label>
          <label><input type="radio" name="q2" value="NOT GIVEN"> NOT GIVEN</label>
        </div>
      </div>

      <div class="question-item">
        <span class="flag-btn" data-q="q3"></span>
        <p><strong>3.</strong> The Egyptian singer Har-Mose was an excellent tanbur player.</p>
        <div class="answer-option">
          <label><input type="radio" name="q3" value="TRUE"> TRUE</label>
          <label><input type="radio" name="q3" value="FALSE"> FALSE</label>
          <label><input type="radio" name="q3" value="NOT GIVEN"> NOT GIVEN</label>
        </div>
      </div>

      <div class="question-item">
        <span class="flag-btn" data-q="q4"></span>
        <p><strong>4.</strong> The Cairo Archaeological Museum contains many historic musical instruments.</p>
        <div class="answer-option">
          <label><input type="radio" name="q4" value="TRUE"> TRUE</label>
          <label><input type="radio" name="q4" value="FALSE"> FALSE</label>
          <label><input type="radio" name="q4" value="NOT GIVEN"> NOT GIVEN</label>
        </div>
      </div>

      <div class="question-item">
        <span class="flag-btn" data-q="q5"></span>
        <p><strong>5.</strong> The instrument carved in stone at Alaca Huyuk is consistent with Dr Michael Kasha's definition of a guitar.</p>
        <div class="answer-option">
          <label><input type="radio" name="q5" value="TRUE"> TRUE</label>
          <label><input type="radio" name="q5" value="FALSE"> FALSE</label>
          <label><input type="radio" name="q5" value="NOT GIVEN"> NOT GIVEN</label>
        </div>
      </div>

      <div class="question-item">
        <span class="flag-btn" data-q="q6"></span>
        <p><strong>6.</strong> The different instruments that appeared in medieval literature had the same number of strings.</p>
        <div class="answer-option">
          <label><input type="radio" name="q6" value="TRUE"> TRUE</label>
          <label><input type="radio" name="q6" value="FALSE"> FALSE</label>
          <label><input type="radio" name="q6" value="NOT GIVEN"> NOT GIVEN</label>
        </div>
      </div>
    </div>

    <div class="group">
      <h4>Questions 7‚Äì13</h4>
      <p>Complete the table below.</p>
      <p>Choose <strong>ONE WORD ONLY</strong> from the passage for each answer.</p>
      <p>Write your answers in boxes 7‚Äì13 on your answer sheet.</p>

      <h4 style="margin-top:16px;">The development of the guitar</h4>

      <table style="margin-top:12px;">
        <tr>
          <th style="width:20%;">Date</th>
          <th style="width:20%;">Type of instrument</th>
          <th>Notes</th>
        </tr>
        <tr>
          <td>13th‚Äì19th century</td>
          <td><strong>Chitarra</strong></td>
          <td>
            ‚Ä¢ was a development of an earlier instrument called the <span class="flag-btn" data-q="q7" style="position:relative; display:inline-block; vertical-align:middle;"></span> 7. <input type="text" class="blank" id="q7" style="min-width:100px;"><br>
            ‚Ä¢ extra strings added in the 16th century in Italy
          </td>
        </tr>
        <tr>
          <td>from around the 1850s</td>
          <td><strong>Classical guitar</strong></td>
          <td>
            ‚Ä¢ its shape a result of modifications, including a larger <span class="flag-btn" data-q="q8" style="position:relative; display:inline-block; vertical-align:middle;"></span> 8. <input type="text" class="blank" id="q8" style="min-width:100px;"> introduced by Antonio Torres<br>
            ‚Ä¢ changes produced better tone and greater <span class="flag-btn" data-q="q9" style="position:relative; display:inline-block; vertical-align:middle;"></span> 9. <input type="text" class="blank" id="q9" style="min-width:100px;">
          </td>
        </tr>
        <tr>
          <td>‚Äî</td>
          <td><strong>X-braced top guitar</strong></td>
          <td>
            ‚Ä¢ first made in <span class="flag-btn" data-q="q10" style="position:relative; display:inline-block; vertical-align:middle;"></span> 10. <input type="text" class="blank" id="q10" style="min-width:100px;"> in the mid-19th century<br>
            ‚Ä¢ strings made of <span class="flag-btn" data-q="q11" style="position:relative; display:inline-block; vertical-align:middle;"></span> 11. <input type="text" class="blank" id="q11" style="min-width:100px;"> became available around 1900
          </td>
        </tr>
        <tr>
          <td>1920s onwards</td>
          <td><strong>Electric guitar</strong></td>
          <td>
            ‚Ä¢ in the 1920s, <span class="flag-btn" data-q="q12" style="position:relative; display:inline-block; vertical-align:middle;"></span> 12. <input type="text" class="blank" id="q12" style="min-width:100px;"> were added to guitars<br>
            ‚Ä¢ a well-known version was brought out by <span class="flag-btn" data-q="q13" style="position:relative; display:inline-block; vertical-align:middle;"></span> 13. <input type="text" class="blank" id="q13" style="min-width:100px;">
          </td>
        </tr>
      </table>
    </div>

    <div class="bottom-bar">
      <button class="btn-primary" onclick="submitAnswers()">Êèê‰∫§</button>
      <button onclick="resetForm()">ÈáçÁΩÆ</button>
      <button onclick="openWrongBook()">Êú¨ÁØáÈîôÈ¢ò</button>
    </div>
  </section>
</div>

<div id="selbar">
  <button id="btnNote">Note</button>
  <button id="btnHL">Highlight</button>
  <button id="btnUH" style="display:none;">Clear Highlight</button>
</div>

<div class="modal" id="resultModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ÊàêÁª©</h2>
      <span class="modal-close" onclick="closeModal('resultModal')">√ó</span>
    </div>
    <div id="resultContent"></div>
    <button class="btn-primary" style="width:100%; margin-top:16px;" onclick="addWrongToBook()">Âä†ÂÖ•ÈîôÈ¢òÊú¨</button>
  </div>
</div>

<div class="modal" id="wrongBookModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Êú¨ÁØáÈîôÈ¢ò</h2>
      <span class="modal-close" onclick="closeModal('wrongBookModal')">√ó</span>
    </div>
    <div id="wrongBookContent"></div>
  </div>
</div>

<div class="modal" id="resetModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ÈáçÁΩÆÁªÉ‰π†</h2>
      <span class="modal-close" onclick="closeModal('resetModal')">√ó</span>
    </div>
    <div style="margin:16px 0;">
      <label style="display:block; margin-bottom:10px;">
        <input type="radio" name="resetType" value="answers" checked>
        Âè™Ê∏ÖÁ©∫Á≠îÊ°à
      </label>
      <label style="display:block;">
        <input type="radio" name="resetType" value="all">
        Ê∏ÖÁ©∫Á≠îÊ°àÂíåÊ†áËÆ∞
      </label>
    </div>
    <button class="btn-primary" style="width:100%;" onclick="confirmReset()">Á°ÆÂÆö</button>
  </div>
</div>

<script>
const PAPER_ID='P1_GUITAR';

let t=0;
const timerEl=document.getElementById('timer');
setInterval(()=>{ t++; timerEl.textContent=String(Math.floor(t/60)).padStart(2,'0')+':'+String(t%60).padStart(2,'0'); }, 1000);

const divider=document.getElementById('divider'), left=document.getElementById('left'), right=document.getElementById('right');
let dragging=false;
divider.onmousedown=()=>{ dragging=true; document.body.style.cursor='ew-resize'; };
window.onmousemove=(e)=>{ if(!dragging)return; const c=document.querySelector('.shell').getBoundingClientRect(); let x=e.clientX-c.left; x=Math.max(280,Math.min(c.width-280,x)); left.style.flex='0 0 '+x+'px'; right.style.flex='1 1 auto'; };
window.onmouseup=()=>{ dragging=false; document.body.style.cursor=''; };

const selbar=document.getElementById('selbar'), btnHL=document.getElementById('btnHL'), btnUH=document.getElementById('btnUH'), btnNote=document.getElementById('btnNote');
let lastRange=null, currentHlNode=null;

function posSelbar(r){ selbar.style.display='flex'; const t=window.scrollY+r.top-selbar.offsetHeight-8; const l=window.scrollX+r.left+r.width/2-selbar.offsetWidth/2; selbar.style.top=((t>0)?t:(window.scrollY+r.bottom+8))+'px'; selbar.style.left=Math.max(8,l)+'px'; }

function updSel(){ const s=window.getSelection(); if(!s||s.rangeCount===0||s.isCollapsed){ if(!currentHlNode)selbar.style.display='none'; return; } const r=s.getRangeAt(0); lastRange=r.cloneRange(); currentHlNode=null; btnNote.style.display='block'; btnHL.style.display='block'; btnUH.style.display='none'; posSelbar(r.getBoundingClientRect()); }

left.onmouseup=updSel; right.onmouseup=updSel;
document.onselectionchange=()=>{ const s=window.getSelection(); if((!s||s.rangeCount===0||s.isCollapsed)&&!currentHlNode)selbar.style.display='none'; };
document.addEventListener('click',(e)=>{ if(e.target.classList&&(e.target.classList.contains('hl')||e.target.classList.contains('note'))){ currentHlNode=e.target; lastRange=null; btnNote.style.display='none'; btnHL.style.display='none'; btnUH.style.display='block'; posSelbar(e.target.getBoundingClientRect()); const s=window.getSelection(); if(s)s.removeAllRanges(); }}, true);

btnHL.onclick=()=>{ if(currentHlNode||!lastRange||lastRange.collapsed)return; const s=document.createElement('span'); s.className='hl'; try{ lastRange.surroundContents(s); }catch(e){ const w=document.createElement('span'); w.className='hl'; w.appendChild(lastRange.cloneContents()); lastRange.deleteContents(); lastRange.insertNode(w); } selbar.style.display='none'; saveHighlights(); };

btnNote.onclick=()=>{ if(currentHlNode||!lastRange||lastRange.collapsed)return; const s=document.createElement('span'); s.className='note'; try{ lastRange.surroundContents(s); }catch(e){ const w=document.createElement('span'); w.className='note'; w.appendChild(lastRange.cloneContents()); lastRange.deleteContents(); lastRange.insertNode(w); } selbar.style.display='none'; saveHighlights(); };

btnUH.onclick=()=>{ if(currentHlNode){ const p=currentHlNode.parentNode; while(currentHlNode.firstChild)p.insertBefore(currentHlNode.firstChild,currentHlNode); p.removeChild(currentHlNode); p.normalize(); currentHlNode=null; selbar.style.display='none'; saveHighlights(); }else if(lastRange){ const sR=lastRange.getBoundingClientRect(); const w=document.createTreeWalker(document.body,NodeFilter.SHOW_ELEMENT); const tr=[]; while(w.nextNode()){ const n=w.currentNode; if(n.classList&&(n.classList.contains('hl')||n.classList.contains('note'))){ const r=n.getBoundingClientRect(); if(!(r.right<sR.left||r.left>sR.right||r.bottom<sR.top||r.top>sR.bottom))tr.push(n); }} tr.forEach(el=>{ const p=el.parentNode; while(el.firstChild)p.insertBefore(el.firstChild,el); p.removeChild(el); p.normalize(); }); selbar.style.display='none'; saveHighlights(); }};

document.querySelectorAll('.flag-btn').forEach(btn => {
  btn.onclick = e => {
    e.stopPropagation();
    btn.classList.toggle('active');
    saveFlags();
  };
});

const answerKey={
  q1:"FALSE",q2:"TRUE",q3:"NOT GIVEN",q4:"NOT GIVEN",q5:"TRUE",q6:"FALSE",
  q7:"chartar",q8:"body",q9:"volume",q10:"America",q11:"steel",q12:"pickups",q13:"Gibson"
};
let lastResults=[];

function saveAnswers() {
  const data = {};
  for(let i=1; i<=6; i++) {
    const ch = document.querySelector(`input[name="q${i}"]:checked`);
    if(ch) data['q'+i] = ch.value;
  }
  for(let i=7; i<=13; i++) {
    const input = document.getElementById('q'+i);
    if(input && input.value.trim()) data['q'+i] = input.value.trim();
  }
  localStorage.setItem(`${PAPER_ID}_answers`, JSON.stringify(data));
}

function loadAnswers() {
  const data = JSON.parse(localStorage.getItem(`${PAPER_ID}_answers`) || '{}');
  Object.keys(data).forEach(q => {
    if(/^q[1-6]$/.test(q)) {
      const radio = document.querySelector(`input[name="${q}"][value="${data[q]}"]`);
      if(radio) radio.checked = true;
    } else {
      const input = document.getElementById(q);
      if(input) input.value = data[q];
    }
  });
}

function saveFlags() {
  const flags = [...document.querySelectorAll('.flag-btn.active')].map(b => b.dataset.q);
  localStorage.setItem(`${PAPER_ID}_flags`, JSON.stringify(flags));
}

function loadFlags() {
  const flags = JSON.parse(localStorage.getItem(`${PAPER_ID}_flags`) || '[]');
  flags.forEach(q => document.querySelector(`[data-q="${q}"]`)?.classList.add('active'));
}

function saveHighlights() {
  const highlights = [];
  document.querySelectorAll('#left .hl, #left .note').forEach((el, idx) => {
    highlights.push({
      type: el.classList.contains('hl') ? 'hl' : 'note',
      text: el.textContent,
      index: idx
    });
  });
  localStorage.setItem(`${PAPER_ID}_highlights`, JSON.stringify(highlights));
}

function loadHighlights() {
  const data = JSON.parse(localStorage.getItem(`${PAPER_ID}_highlights`) || '[]');
  if(data.length === 0) return;
  
  data.forEach(item => {
    const walker = document.createTreeWalker(left, NodeFilter.SHOW_TEXT);
    let node;
    while(node = walker.nextNode()) {
      if(node.textContent.includes(item.text)) {
        const span = document.createElement('span');
        span.className = item.type;
        const parent = node.parentNode;
        const text = node.textContent;
        const idx = text.indexOf(item.text);
        if(idx >= 0) {
          const before = text.substring(0, idx);
          const match = text.substring(idx, idx + item.text.length);
          const after = text.substring(idx + item.text.length);
          
          parent.insertBefore(document.createTextNode(before), node);
          span.textContent = match;
          parent.insertBefore(span, node);
          parent.insertBefore(document.createTextNode(after), node);
          parent.removeChild(node);
          break;
        }
      }
    }
  });
}

document.querySelectorAll('input[type="text"]').forEach(input => {
  input.addEventListener('input', saveAnswers);
});

document.querySelectorAll('input[type="radio"]').forEach(radio => {
  radio.addEventListener('change', saveAnswers);
});

document.addEventListener('DOMContentLoaded', () => {
  loadAnswers();
  loadFlags();
  loadHighlights();
});

function submitAnswers(){ 
  const res=[]; 
  let cor=0; 
  
  for(let i=1; i<=6; i++) {
    const ch = document.querySelector(`input[name="q${i}"]:checked`);
    const uA = ch ? ch.value : "";
    const cA = answerKey['q'+i];
    const iC = uA === cA;
    if(iC) cor++;
    res.push({id:'q'+i, userAns:uA||'(Êú™‰ΩúÁ≠î)', correctAns:cA, isCorrect:iC});
  }
  
  for(let i=7; i<=13; i++) {
    const input = document.getElementById('q'+i);
    const uA = input ? input.value.trim().toLowerCase() : "";
    const cA = answerKey['q'+i].toLowerCase();
    const iC = uA === cA;
    if(iC) cor++;
    res.push({id:'q'+i, userAns:uA||'(Êú™‰ΩúÁ≠î)', correctAns:answerKey['q'+i], isCorrect:iC});
  }
  
  lastResults=res; 
  const tot=13;
  const pct=((cor/tot)*100).toFixed(1); 
  localStorage.setItem(`ielts_score_${PAPER_ID}`, `${cor}/${tot}`);
  document.getElementById('resultContent').innerHTML=`<div class="result-summary"><div class="result-score">${cor} / ${tot}</div><div style="margin-top:8px;font-size:18px;">${pct}%</div></div>${res.map(r=>`<div class="result-item ${r.isCorrect?'correct':'incorrect'}"><div><strong>${r.id}</strong> ${r.isCorrect?'‚úì':'‚úó'}</div><div>‰Ω†ÁöÑÁ≠îÊ°à: ${r.userAns}</div>${!r.isCorrect?`<div>Ê≠£Á°ÆÁ≠îÊ°à: ${r.correctAns}</div>`:''}</div>`).join('')}`; 
  document.getElementById('resultModal').classList.add('active'); 
}

function resetForm(){ document.getElementById('resetModal').classList.add('active'); }

function confirmReset(){ 
  const tp=document.querySelector('input[name="resetType"]:checked').value; 
  
  for(let i=1; i<=6; i++) {
    document.querySelectorAll(`input[name="q${i}"]`).forEach(r=>r.checked=false);
  }
  for(let i=7; i<=13; i++) {
    const input = document.getElementById('q'+i);
    if(input) input.value = '';
  }
  localStorage.removeItem(`${PAPER_ID}_answers`);
  
  if(tp==='all'){ 
    document.querySelectorAll('.hl').forEach(el=>{ const p=el.parentNode; while(el.firstChild)p.insertBefore(el.firstChild,el); p.removeChild(el); p.normalize(); }); 
    document.querySelectorAll('.note').forEach(el=>{ const p=el.parentNode; while(el.firstChild)p.insertBefore(el.firstChild,el); p.removeChild(el); p.normalize(); }); 
    document.querySelectorAll('.flag-btn').forEach(b => b.classList.remove('active'));
    localStorage.removeItem(`${PAPER_ID}_highlights`);
    localStorage.removeItem(`${PAPER_ID}_flags`);
  } 
  closeModal('resetModal'); 
}

function addWrongToBook(){ 
  const wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); 
  const wr=lastResults.filter(r=>!r.isCorrect); 
  wr.forEach(r=>{ 
    const en={
      paperId:PAPER_ID,
      title:'The history of the guitar',
      questionId:r.id,
      correctAnswer:r.correctAns,
      myAnswer:r.userAns,
      date:new Date().toISOString().split('T')[0]
    }; 
    const ix=wb.findIndex(i=>i.paperId===en.paperId&&i.questionId===en.questionId); 
    if(ix>=0)wb[ix]=en; 
    else wb.push(en); 
  }); 
  localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); 
  alert(`Â∑≤Ê∑ªÂä† ${wr.length} ÈÅìÈîôÈ¢ò`); 
  closeModal('resultModal'); 
}

function deleteWrongItem(pId,qId){ 
  if(!confirm('Á°ÆÂÆöÂà†Èô§ËøôÈÅìÈîôÈ¢òÔºü'))return; 
  let wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); 
  wb=wb.filter(i=>!(i.paperId===pId&&i.questionId===qId)); 
  localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); 
  openWrongBook(); 
}

function clearCurrentWrongBook(){ 
  if(!confirm('Á°ÆÂÆöÊ∏ÖÁ©∫Êú¨ÁØáÊâÄÊúâÈîôÈ¢òÔºü'))return; 
  let wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); 
  wb=wb.filter(i=>i.paperId!==PAPER_ID); 
  localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); 
  openWrongBook(); 
}

function openWrongBook(){ 
  const wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); 
  const cu=wb.filter(i=>i.paperId===PAPER_ID); 
  const ct=document.getElementById('wrongBookContent'); 
  if(cu.length===0)ct.innerHTML='<div style="text-align:center;padding:40px;color:#666;">ÊöÇÊó†ÈîôÈ¢ò</div>'; 
  else ct.innerHTML=`<div class="modal-actions"><button class="btn-danger" onclick="clearCurrentWrongBook()" style="width:100%;">üóëÔ∏è Ê∏ÖÁ©∫Êú¨ÁØáÈîôÈ¢ò</button></div>${cu.map(i=>`<div class="wrong-item"><div class="wrong-item-content"><div style="font-weight:600;margin-bottom:8px;">${i.questionId}</div><div style="font-size:13px;color:#666;"><div>‚úì Ê≠£Á°Æ: ${i.correctAnswer}</div><div style="color:#d32f2f;">‚úó ÊàëÁöÑ: ${i.myAnswer}</div></div></div><button class="btn-delete" onclick="deleteWrongItem('${i.paperId}','${i.questionId}')">Âà†Èô§</button></div>`).join('')}`; 
  document.getElementById('wrongBookModal').classList.add('active'); 
}

function closeModal(id){ document.getElementById(id).classList.remove('active'); }
</script>
</body>
</html>