<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>P1 ‚Äì Think Small</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      html,
      body {
        height: 100%;
      }
      body {
        font-family: Arial, sans-serif;
        background: #f5f5f5;
      }
      #timer {
        position: fixed;
        top: 12px;
        right: 12px;
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 8px 12px;
        font-size: 16px;
        font-weight: 600;
        color: #0066cc;
        z-index: 1000;
      }
      .shell {
        display: flex;
        height: 100vh;
        width: 100%;
      }
      .pane {
        background: #fff;
        overflow: auto;
        padding: 24px;
      }
      #left {
        flex: 0 0 50%;
        border-right: 1px solid #ddd;
      }
      #right {
        flex: 1 1 auto;
        background: #fafafa;
      }
      #divider {
        flex: 0 0 5px;
        background: #ddd;
        cursor: ew-resize;
      }
      #divider:hover {
        background: #999;
      }
      h2,
      h3,
      h4 {
        margin: 0 0 12px;
        color: #333;
      }
      h2 {
        font-size: 20px;
      }
      h3 {
        font-size: 18px;
        color: #0066cc;
      }
      h4 {
        font-size: 15px;
        font-weight: 600;
        margin-top: 20px;
      }
      #left p {
        margin: 0 0 14px;
        line-height: 1.7;
        text-align: justify;
      }
      .group {
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 16px;
        margin-bottom: 16px;
      }
      .group h4 {
        margin-top: 0;
        color: #0066cc;
      }
      .group p {
        margin: 8px 0;
        font-size: 14px;
        line-height: 1.6;
      }
      .flag-btn {
        position: absolute;
        left: 2px;
        top: 50%;
        transform: translateY(-50%);
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #ddd;
        cursor: pointer;
        z-index: 10;
      }
      .flag-btn:hover {
        background: #999;
      }
      .flag-btn.active {
        background: #ff5722;
      }
      .group ol {
        margin-left: 20px;
      }
      .group ol li {
        margin: 12px 0;
        font-size: 14px;
        line-height: 1.6;
        position: relative;
      }
      .group ol li label {
        display: inline-block;
        margin-right: 8px;
      }
      input[type="text"] {
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 4px 8px;
        font-size: 14px;
        width: 160px;
        background: #fdfdfd;
      }
      input[type="text"]:focus {
        border-color: #0066cc;
        outline: none;
        background: #fff;
      }
      .bottom-bar {
        display: flex;
        gap: 10px;
        margin-top: 16px;
      }
      button {
        padding: 10px 20px;
        border: 1px solid #999;
        border-radius: 6px;
        background: #fff;
        cursor: pointer;
        font-size: 14px;
      }
      button:hover {
        background: #f0f0f0;
      }
      .btn-primary {
        background: #0066cc;
        color: #fff;
        border-color: #0066cc;
      }
      .btn-primary:hover {
        background: #0052a3;
      }
      .btn-danger {
        background: #dc3545;
        color: #fff;
        border-color: #dc3545;
      }
      .btn-danger:hover {
        background: #c82333;
      }
      .hl {
        background: #fff59d;
        cursor: pointer;
      }
      .hl:hover {
        background: #ffeb3b;
      }
      .note {
        background: #b3d9ff;
        cursor: pointer;
      }
      .note:hover {
        background: #99ccff;
      }
      #selbar {
        position: fixed;
        display: none;
        z-index: 2000;
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 8px;
        gap: 0;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        flex-direction: column;
        min-width: 120px;
      }
      #selbar button {
        background: #fff;
        color: #666;
        border: none;
        padding: 3px 0px;
        cursor: pointer;
        font-size: 14px;
        text-align: center;
        border-radius: 4px;
      }
      #selbar button:hover {
        background: #f5f5f5;
        color: #333;
      }
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 3000;
        align-items: center;
        justify-content: center;
      }
      .modal.active {
        display: flex;
      }
      .modal-content {
        background: #fff;
        border-radius: 8px;
        padding: 24px;
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
      }
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
      }
      .modal-header h2 {
        font-size: 28px;
        color: #333;
        margin: 0;
      }
      .modal-close {
        font-size: 32px;
        cursor: pointer;
        color: #999;
        line-height: 1;
      }
      .modal-close:hover {
        color: #333;
      }
      .result-summary {
        text-align: center;
        padding: 20px;
        background: #f0f0f0;
        margin-bottom: 16px;
        border-radius: 6px;
      }
      .result-score {
        font-size: 36px;
        font-weight: 600;
        color: #0066cc;
      }
      .result-item {
        padding: 10px;
        margin: 8px 0;
        border-left: 3px solid #ddd;
        background: #f9f9f9;
        font-size: 13px;
      }
      .result-item.correct {
        border-left-color: #28a745;
        background: #e8f5e9;
      }
      .result-item.incorrect {
        border-left-color: #dc3545;
        background: #ffebee;
      }
      .wrong-item {
        background: #fff3e0;
        padding: 16px;
        margin: 8px 0;
        border-radius: 8px;
        border-left: 4px solid #ff9800;
        display: flex;
        justify-content: space-between;
        align-items: start;
      }
      .wrong-item-content {
        flex: 1;
      }
      .btn-delete {
        background: #dc3545;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
        margin-left: 12px;
      }
      .btn-delete:hover {
        background: #c82333;
      }
      .modal-actions {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }
    </style>
  </head>
  <body>
    <div id="timer">00:00</div>
    <div class="shell">
      <section class="pane" id="left">
        <h2>READING PASSAGE 1</h2>
        <p>
          You should spend about 20 minutes on Questions 1‚Äì13, which are based
          on Reading Passage 1 below.
        </p>
        <h3>Think Small</h3>
        <p style="font-style: italic">
          Izon is a New Zealand company specialising in nanoscience ‚Äì the study
          of atoms, molecules and other very small pieces of matter.
        </p>
        <p>
          The new US headquarters of Izon are situated in Cambridge,
          Massachusetts, one of the most important global centres of scientific
          research and technology. Half the other offices in the building Izon
          shares have scientific names like Stemgent, or the word
          ‚Äòpharmaceutical‚Äô in the name. In the past three years, Izon has
          expanded to 17 times its previous size. It‚Äôs done so selling only one
          product that it‚Äôs been developing since 2004, the qNano. This is an
          adjustable tool for the measurement and analysis of tiny particles in
          scientific research, which comes with a $27,000 price tag. Izon‚Äôs
          success results from the fact that the qNano machine provides precise
          measurements, while similar machines of the same price only offer
          averaging techniques. In effect, researchers using the qNano are able
          to gather information about very small things, and it has many
          possible applications from drug delivery analysis through to
          environmental research.
        </p>
        <p>
          Kristoffer Bolen is Izon‚Äôs US head of sales. Alongside his full-time
          role with the company, he‚Äôs just finished the fifth semester of six
          for his High-Tech Master of Business Administration at Northeastern
          University, which will be his second master‚Äôs degree, alongside a
          Master of Science. These soon-to-be twin master‚Äôs degrees provide
          Bolen with the perfect combination of skills for his job, which
          depends on him being able to manage the sales process and also
          comprehend in depth a very complicated piece of technology. When a
          customer buys a qNano device, an Izon representative will fly anywhere
          in America to train them how to use the instrument. The representative
          then checks in with the client on an ongoing basis to be completely
          informed about how each qNano is being used, and then liaises with
          technicians back in New Zealand.
        </p>
        <p>
          The Izon story started 8 years ago in New Zealand. Hans van der Voorn
          was aimless, having sold his own company, and was looking for
          something more taxing to set his mind to. Van der Voorn was introduced
          to three scientists with an idea that involved simply a small plastic
          membrane with a tiny adjustable hole to measure a range of very small
          particles. Initially he put up an investment of $1.5 million to move
          the process forward to the development of a prototype, and this led to
          the founding of Izon and the production of the qNano. Van der Voorn
          believes that the worlds of science and business sometimes don‚Äôt
          understand each other very well. However, he thinks that engineering
          can be a bridge between the two, and his long experience in that field
          has been crucial to the company‚Äôs success. He soon realised that Izon
          was going to need people on the ground overseas if it was going to
          grow, so the US office was opened. For now Izon trades in the US as a
          foreign company, so avoids the high level of compliance that comes
          with being an American-registered company. But he sees that one day
          soon this will change, as Izon‚Äôs current position disallows it from
          entering into partnerships locally.
        </p>
        <p>
          Marketing the qNano is complicated. Izon needs scientists both to buy
          and advertise the product. The science world may seem like a big
          playing field, but it‚Äôs actually a small group. As a result, the
          critical part of the company‚Äôs marketing is articles that clients
          publish describing work they have performed with the qNano. So for
          Izon the sale isn‚Äôt enough in itself; it also has a stake in how
          customers are using the qNano. That‚Äôs where Yaniv Gaynor comes in. As
          development and training manager, he‚Äôs involved throughout the sales
          process and manages most of the customer‚Äôs post-sale experience. The
          sales process is new for Gaynor, who shifted cities and switched from
          a role as teacher at the University of Minnesota to his first private
          sector role with Izon. ‚ÄòIt‚Äôs tricky, it‚Äôs challenging, and it‚Äôs not in
          my comfort zone,‚Äô he concedes. But nine out of ten times, if there‚Äôs
          an unhappy customer, he‚Äôs able to turn their experience around. And
          there‚Äôs another part to this, because sitting with customers as they
          learn about the qNano, Gaynor gets to see how they are using the
          product. ‚ÄòPeople ask very good questions, and these are great triggers
          for future development,‚Äô he says.
        </p>
        <p>
          ‚ÄòOur business is selling research tools,‚Äô van der Voorn says. But he
          knows that the application range of this tool is wide. For instance,
          Izon is engaged in a project with Harvard University, looking for a
          particular type of particle of blood that is a symptom of the medical
          condition of thrombosis. If in the future they can identify this
          particle, they can design a simple test for it. This would make it
          easier for doctors to diagnose thrombosis. Another planned development
          is eventually to shift the US base to more spacious offices on the
          other side of town. With larger headquarters, the company will be able
          to bring clients into the Izon building for training with its product,
          rather than travelling to them, which will hopefully result in an even
          closer relationship between the company and its customers.
        </p>
      </section>
      <div id="divider"></div>
      <section class="pane" id="right">
        <h3>Questions</h3>
        <div class="group">
          <h4>Questions 1‚Äì7</h4>
          <p>
            Do the following statements agree with the information given in
            Reading Passage 1?
          </p>
          <div style="margin: 8px 0 16px 20px">
            <div>
              <strong>TRUE</strong> if the statement agrees with the information
            </div>
            <div>
              <strong>FALSE</strong> if the statement contradicts the
              information
            </div>
            <div>
              <strong>NOT GIVEN</strong> if there is no information on this
            </div>
          </div>
          <ol start="1">
            <li>
              <span class="flag-btn" data-q="q1" style="left: -20px"></span
              >Izon‚Äôs new US headquarters are located in an area popular with
              other science businesses.<br />
              <label><input type="radio" name="q1" value="TRUE" /> TRUE</label>
              <label
                ><input type="radio" name="q1" value="FALSE" /> FALSE</label
              >
              <label
                ><input type="radio" name="q1" value="NOT GIVEN" /> NOT
                GIVEN</label
              >
            </li>
            <li>
              <span class="flag-btn" data-q="q2" style="left: -20px"></span
              >Izon‚Äôs growth in the last three years has been faster than the
              company predicted.<br />
              <label><input type="radio" name="q2" value="TRUE" /> TRUE</label>
              <label
                ><input type="radio" name="q2" value="FALSE" /> FALSE</label
              >
              <label
                ><input type="radio" name="q2" value="NOT GIVEN" /> NOT
                GIVEN</label
              >
            </li>
            <li>
              <span class="flag-btn" data-q="q3" style="left: -20px"></span
              >Since 2004, Izon has developed a range of equipment for use in
              scientific research.<br />
              <label><input type="radio" name="q3" value="TRUE" /> TRUE</label>
              <label
                ><input type="radio" name="q3" value="FALSE" /> FALSE</label
              >
              <label
                ><input type="radio" name="q3" value="NOT GIVEN" /> NOT
                GIVEN</label
              >
            </li>
            <li>
              <span class="flag-btn" data-q="q4" style="left: -20px"></span>One
              advantage of the qNano is that it is cheaper than its
              competitors.<br />
              <label><input type="radio" name="q4" value="TRUE" /> TRUE</label>
              <label
                ><input type="radio" name="q4" value="FALSE" /> FALSE</label
              >
              <label
                ><input type="radio" name="q4" value="NOT GIVEN" /> NOT
                GIVEN</label
              >
            </li>
            <li>
              <span class="flag-btn" data-q="q5" style="left: -20px"></span>Drug
              delivery analysis will be the most profitable application of the
              qNano.<br />
              <label><input type="radio" name="q5" value="TRUE" /> TRUE</label>
              <label
                ><input type="radio" name="q5" value="FALSE" /> FALSE</label
              >
              <label
                ><input type="radio" name="q5" value="NOT GIVEN" /> NOT
                GIVEN</label
              >
            </li>
            <li>
              <span class="flag-btn" data-q="q6" style="left: -20px"></span
              >Kristoffer Bolen is still completing his studies.<br />
              <label><input type="radio" name="q6" value="TRUE" /> TRUE</label>
              <label
                ><input type="radio" name="q6" value="FALSE" /> FALSE</label
              >
              <label
                ><input type="radio" name="q6" value="NOT GIVEN" /> NOT
                GIVEN</label
              >
            </li>
            <li>
              <span class="flag-btn" data-q="q7" style="left: -20px"></span
              >Bolen‚Äôs job requires him to fully understand how the qNano
              works.<br />
              <label><input type="radio" name="q7" value="TRUE" /> TRUE</label>
              <label
                ><input type="radio" name="q7" value="FALSE" /> FALSE</label
              >
              <label
                ><input type="radio" name="q7" value="NOT GIVEN" /> NOT
                GIVEN</label
              >
            </li>
          </ol>
        </div>
        <div class="group">
          <h4>Questions 8‚Äì13</h4>
          <p>Complete the notes below.</p>
          <p>
            Choose <strong>ONE WORD ONLY</strong> from the passage for each
            answer.
          </p>
          <div style="margin-left: 10px; line-height: 1.8; font-size: 14px">
            <strong>The Izon Story</strong>
            <p>Hans van der Voorn</p>
            <ul>
              <li>
                He made the <b>8</b> <input type="text" name="q8" /> which
                enabled the prototype to be created.
                <span class="flag-btn" data-q="q8"></span>
              </li>
              <li>
                His background in <b>9</b> <input type="text" name="q9" /> as
                well as business gave him the skills to run Izon.
                <span class="flag-btn" data-q="q9"></span>
              </li>
            </ul>
            <p>Izon in the United States</p>
            <ul>
              <li>
                It is unable to form partnerships in the US because it‚Äôs not
                registered there.
              </li>
              <li>
                The company‚Äôs marketing relies on <b>10</b>
                <input type="text" name="q10" /> about its customers‚Äô research.
                <span class="flag-btn" data-q="q10"></span>
              </li>
              <li>
                Yaniv Gaynor was formerly a <b>11</b>
                <input type="text" name="q11" />, with no experience in sales.
                <span class="flag-btn" data-q="q11"></span>
              </li>
              <li>
                Development of the product is influenced by customers‚Äô
                questions.
              </li>
            </ul>
            <p>Plans for the future</p>
            <ul>
              <li>
                To diagnose thrombosis, a <b>12</b>
                <input type="text" name="q12" /> may be developed.
                <span class="flag-btn" data-q="q12"></span>
              </li>
              <li>
                <b>13</b> <input type="text" name="q13" /> will be done at
                Izon‚Äôs US headquarters.
                <span class="flag-btn" data-q="q13"></span>
              </li>
            </ul>
          </div>
        </div>
        <div class="bottom-bar">
          <button class="btn-primary" onclick="submitAnswers()">Êèê‰∫§</button>
          <button onclick="resetForm()">ÈáçÁΩÆ</button>
          <button onclick="openWrongBook()">Êú¨ÁØáÈîôÈ¢ò</button>
        </div>
      </section>
    </div>
    <div id="selbar">
      <button id="btnNote">Note</button>
      <button id="btnHL">Highlight</button>
      <button id="btnUH" style="display: none">Clear Highlight</button>
    </div>
    <div class="modal" id="resultModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>ÊàêÁª©</h2>
          <span class="modal-close" onclick="closeModal('resultModal')">√ó</span>
        </div>
        <div id="resultContent"></div>
        <button
          class="btn-primary"
          style="width: 100%; margin-top: 16px"
          onclick="addWrongToBook()"
        >
          Âä†ÂÖ•ÈîôÈ¢òÊú¨
        </button>
      </div>
    </div>
    <div class="modal" id="wrongBookModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Êú¨ÁØáÈîôÈ¢ò</h2>
          <span class="modal-close" onclick="closeModal('wrongBookModal')"
            >√ó</span
          >
        </div>
        <div id="wrongBookContent"></div>
      </div>
    </div>
    <div class="modal" id="resetModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>ÈáçÁΩÆÁªÉ‰π†</h2>
          <span class="modal-close" onclick="closeModal('resetModal')">√ó</span>
        </div>
        <div style="margin: 16px 0">
          <label style="display: block; margin-bottom: 10px"
            ><input type="radio" name="resetType" value="answers" checked />
            Âè™Ê∏ÖÁ©∫Á≠îÊ°à</label
          >
          <label style="display: block"
            ><input type="radio" name="resetType" value="all" />
            Ê∏ÖÁ©∫Á≠îÊ°àÂíåÊ†áËÆ∞</label
          >
        </div>
        <button
          class="btn-primary"
          style="width: 100%"
          onclick="confirmReset()"
        >
          Á°ÆÂÆö
        </button>
      </div>
    </div>
    <script>
      const PAPER_ID = "P1_THINK_SMALL";
      let t = 0;
      const timerEl = document.getElementById("timer");
      setInterval(() => {
        t++;
        timerEl.textContent =
          String(Math.floor(t / 60)).padStart(2, "0") +
          ":" +
          String(t % 60).padStart(2, "0");
      }, 1000);
      const divider = document.getElementById("divider"),
        left = document.getElementById("left"),
        right = document.getElementById("right");
      let dragging = false;
      divider.onmousedown = () => {
        dragging = true;
        document.body.style.cursor = "ew-resize";
      };
      window.onmousemove = (e) => {
        if (!dragging) return;
        const c = document.querySelector(".shell").getBoundingClientRect();
        let x = e.clientX - c.left;
        x = Math.max(280, Math.min(c.width - 280, x));
        left.style.flex = "0 0 " + x + "px";
        right.style.flex = "1 1 auto";
      };
      window.onmouseup = () => {
        dragging = false;
        document.body.style.cursor = "";
      };
      const selbar = document.getElementById("selbar"),
        btnHL = document.getElementById("btnHL"),
        btnUH = document.getElementById("btnUH"),
        btnNote = document.getElementById("btnNote");
      let lastRange = null,
        currentHlNode = null;
      function posSelbar(r) {
        selbar.style.display = "flex";
        const t = window.scrollY + r.top - selbar.offsetHeight - 8;
        const l =
          window.scrollX + r.left + r.width / 2 - selbar.offsetWidth / 2;
        selbar.style.top = (t > 0 ? t : window.scrollY + r.bottom + 8) + "px";
        selbar.style.left = Math.max(8, l) + "px";
      }
      function updSel() {
        const s = window.getSelection();
        if (!s || s.rangeCount === 0 || s.isCollapsed) {
          if (!currentHlNode) selbar.style.display = "none";
          return;
        }
        const r = s.getRangeAt(0);
        lastRange = r.cloneRange();
        currentHlNode = null;
        btnNote.style.display = "block";
        btnHL.style.display = "block";
        btnUH.style.display = "none";
        posSelbar(r.getBoundingClientRect());
      }
      left.onmouseup = updSel;
      right.onmouseup = updSel;
      document.onselectionchange = () => {
        const s = window.getSelection();
        if ((!s || s.rangeCount === 0 || s.isCollapsed) && !currentHlNode)
          selbar.style.display = "none";
      };
      document.addEventListener(
        "click",
        (e) => {
          if (
            e.target.classList &&
            (e.target.classList.contains("hl") ||
              e.target.classList.contains("note"))
          ) {
            currentHlNode = e.target;
            lastRange = null;
            btnNote.style.display = "none";
            btnHL.style.display = "none";
            btnUH.style.display = "block";
            posSelbar(e.target.getBoundingClientRect());
            const s = window.getSelection();
            if (s) s.removeAllRanges();
          }
        },
        true
      );
      btnHL.onclick = () => {
        if (currentHlNode || !lastRange || lastRange.collapsed) return;
        const s = document.createElement("span");
        s.className = "hl";
        try {
          lastRange.surroundContents(s);
        } catch (e) {
          const w = document.createElement("span");
          w.className = "hl";
          w.appendChild(lastRange.cloneContents());
          lastRange.deleteContents();
          lastRange.insertNode(w);
        }
        selbar.style.display = "none";
        saveHighlights();
      };
      btnNote.onclick = () => {
        if (currentHlNode || !lastRange || lastRange.collapsed) return;
        const s = document.createElement("span");
        s.className = "note";
        try {
          lastRange.surroundContents(s);
        } catch (e) {
          const w = document.createElement("span");
          w.className = "note";
          w.appendChild(lastRange.cloneContents());
          lastRange.deleteContents();
          lastRange.insertNode(w);
        }
        selbar.style.display = "none";
        saveHighlights();
      };
      btnUH.onclick = () => {
        if (currentHlNode) {
          const p = currentHlNode.parentNode;
          while (currentHlNode.firstChild)
            p.insertBefore(currentHlNode.firstChild, currentHlNode);
          p.removeChild(currentHlNode);
          p.normalize();
          currentHlNode = null;
          selbar.style.display = "none";
          saveHighlights();
        } else if (lastRange) {
          const sR = lastRange.getBoundingClientRect();
          const w = document.createTreeWalker(
            document.body,
            NodeFilter.SHOW_ELEMENT
          );
          const tr = [];
          while (w.nextNode()) {
            const n = w.currentNode;
            if (
              n.classList &&
              (n.classList.contains("hl") || n.classList.contains("note"))
            ) {
              const r = n.getBoundingClientRect();
              if (
                !(
                  r.right < sR.left ||
                  r.left > sR.right ||
                  r.bottom < sR.top ||
                  r.top > sR.bottom
                )
              )
                tr.push(n);
            }
          }
          tr.forEach((el) => {
            const p = el.parentNode;
            while (el.firstChild) p.insertBefore(el.firstChild, el);
            p.removeChild(el);
            p.normalize();
          });
          selbar.style.display = "none";
          saveHighlights();
        }
      };
      document.querySelectorAll(".flag-btn").forEach((btn) => {
        btn.onclick = (e) => {
          e.stopPropagation();
          btn.classList.toggle("active");
          saveFlags();
        };
      });
      const answerKey = {
        q1: "TRUE",
        q2: "NOT GIVEN",
        q3: "FALSE",
        q4: "FALSE",
        q5: "NOT GIVEN",
        q6: "TRUE",
        q7: "TRUE",
        q8: "investment",
        q9: "engineering",
        q10: "articles",
        q11: "teacher",
        q12: "test",
        q13: "training",
      };
      let lastResults = [];
      function saveAnswers() {
        const data = {};
        Object.keys(answerKey).forEach((q) => {
          const radio = document.querySelector(
            `input[name="${q}"][type="radio"]:checked`
          );
          const text = document.querySelector(
            `input[name="${q}"][type="text"]`
          );
          if (radio) data[q] = radio.value;
          else if (text) data[q] = text.value;
        });
        localStorage.setItem(`${PAPER_ID}_answers`, JSON.stringify(data));
      }
      function loadAnswers() {
        const data = JSON.parse(
          localStorage.getItem(`${PAPER_ID}_answers`) || "{}"
        );
        Object.keys(data).forEach((q) => {
          const radio = document.querySelector(
            `input[name="${q}"][value="${data[q]}"]`
          );
          const text = document.querySelector(
            `input[name="${q}"][type="text"]`
          );
          if (radio) radio.checked = true;
          else if (text) text.value = data[q];
        });
      }
      function saveFlags() {
        const flags = [...document.querySelectorAll(".flag-btn.active")].map(
          (b) => b.dataset.q
        );
        localStorage.setItem(`${PAPER_ID}_flags`, JSON.stringify(flags));
      }
      function loadFlags() {
        const flags = JSON.parse(
          localStorage.getItem(`${PAPER_ID}_flags`) || "[]"
        );
        flags.forEach((q) =>
          document.querySelector(`[data-q="${q}"]`)?.classList.add("active")
        );
      }
      function saveHighlights() {
        const highlights = { left: [], right: [] };
        document
          .querySelectorAll("#left .hl, #left .note")
          .forEach((el, idx) => {
            highlights.left.push({
              type: el.classList.contains("hl") ? "hl" : "note",
              text: el.textContent,
              index: idx,
            });
          });
        document
          .querySelectorAll("#right .hl, #right .note")
          .forEach((el, idx) => {
            highlights.right.push({
              type: el.classList.contains("hl") ? "hl" : "note",
              text: el.textContent,
              index: idx,
            });
          });
        localStorage.setItem(
          `${PAPER_ID}_highlights`,
          JSON.stringify(highlights)
        );
      }
      function loadHighlights() {
        const data = JSON.parse(
          localStorage.getItem(`${PAPER_ID}_highlights`) ||
            '{"left":[],"right":[]}'
        );
        const restore = (pane, items) => {
          if (!items || items.length === 0) return;
          items.forEach((item) => {
            const walker = document.createTreeWalker(
              pane,
              NodeFilter.SHOW_TEXT
            );
            let node;
            while ((node = walker.nextNode())) {
              if (node.textContent.includes(item.text)) {
                const span = document.createElement("span");
                span.className = item.type;
                const parent = node.parentNode;
                const text = node.textContent;
                const idx = text.indexOf(item.text);
                if (idx >= 0) {
                  const before = text.substring(0, idx);
                  const match = text.substring(idx, idx + item.text.length);
                  const after = text.substring(idx + item.text.length);
                  parent.insertBefore(document.createTextNode(before), node);
                  span.textContent = match;
                  parent.insertBefore(span, node);
                  parent.insertBefore(document.createTextNode(after), node);
                  parent.removeChild(node);
                  break;
                }
              }
            }
          });
        };
        restore(left, data.left);
        restore(right, data.right);
      }
      document.querySelectorAll("input").forEach((inp) => {
        inp.addEventListener("change", saveAnswers);
        if (inp.type === "text") inp.addEventListener("input", saveAnswers);
      });
      document.addEventListener("DOMContentLoaded", () => {
        loadAnswers();
        loadFlags();
        loadHighlights();
      });
      function submitAnswers() {
        const res = [];
        let cor = 0;
        Object.keys(answerKey).forEach((q) => {
          let uA = "";
          const radio = document.querySelector(
            `input[name="${q}"][type="radio"]:checked`
          );
          const text = document.querySelector(
            `input[name="${q}"][type="text"]`
          );
          if (radio) uA = radio.value;
          else if (text) uA = text.value.trim();
          const cA = answerKey[q];
          const iC = uA.toLowerCase() === cA.toLowerCase();
          if (iC) cor++;
          res.push({ id: q, userAns: uA, correctAns: cA, isCorrect: iC });
        });
        lastResults = res;
        const tot = Object.keys(answerKey).length;
        const pct = ((cor / tot) * 100).toFixed(1);
        localStorage.setItem(`ielts_score_${PAPER_ID}`, `${cor}/${tot}`);
        document.getElementById(
          "resultContent"
        ).innerHTML = `<div class="result-summary"><div class="result-score">${cor} / ${tot}</div><div style="margin-top:8px;font-size:18px;">${pct}%</div></div>${res
          .map(
            (r) =>
              `<div class="result-item ${
                r.isCorrect ? "correct" : "incorrect"
              }"><div><strong>${r.id}</strong> ${
                r.isCorrect ? "‚úì" : "‚úó"
              }</div><div>‰Ω†ÁöÑÁ≠îÊ°à: ${r.userAns || "(Êú™‰ΩúÁ≠î)"}</div>${
                !r.isCorrect ? `<div>Ê≠£Á°ÆÁ≠îÊ°à: ${r.correctAns}</div>` : ""
              }</div>`
          )
          .join("")}`;
        document.getElementById("resultModal").classList.add("active");
      }
      function resetForm() {
        document.getElementById("resetModal").classList.add("active");
      }
      function confirmReset() {
        const tp = document.querySelector(
          'input[name="resetType"]:checked'
        ).value;
        document.querySelectorAll("input").forEach((i) => {
          if (i.type === "radio") i.checked = false;
          if (i.type === "text") i.value = "";
        });
        localStorage.removeItem(`${PAPER_ID}_answers`);
        if (tp === "all") {
          document.querySelectorAll(".hl").forEach((el) => {
            const p = el.parentNode;
            while (el.firstChild) p.insertBefore(el.firstChild, el);
            p.removeChild(el);
            p.normalize();
          });
          document.querySelectorAll(".note").forEach((el) => {
            const p = el.parentNode;
            while (el.firstChild) p.insertBefore(el.firstChild, el);
            p.removeChild(el);
            p.normalize();
          });
          document
            .querySelectorAll(".flag-btn")
            .forEach((b) => b.classList.remove("active"));
          localStorage.removeItem(`${PAPER_ID}_highlights`);
          localStorage.removeItem(`${PAPER_ID}_flags`);
        }
        closeModal("resetModal");
      }
      function addWrongToBook() {
        const wb = JSON.parse(localStorage.getItem("ielts_wrong_book") || "[]");
        const wr = lastResults.filter((r) => !r.isCorrect);
        wr.forEach((r) => {
          const en = {
            paperId: PAPER_ID,
            title: "Think Small",
            questionId: r.id,
            correctAnswer: r.correctAns,
            myAnswer: r.userAns || "(Êú™‰ΩúÁ≠î)",
            date: new Date().toISOString().split("T")[0],
          };
          const ix = wb.findIndex(
            (i) => i.paperId === en.paperId && i.questionId === en.questionId
          );
          if (ix >= 0) wb[ix] = en;
          else wb.push(en);
        });
        localStorage.setItem("ielts_wrong_book", JSON.stringify(wb));
        alert(`Â∑≤Ê∑ªÂä† ${wr.length} ÈÅìÈîôÈ¢ò`);
        closeModal("resultModal");
      }
      function deleteWrongItem(pId, qId) {
        if (!confirm("Á°ÆÂÆöÂà†Èô§ËøôÈÅìÈîôÈ¢òÔºü")) return;
        let wb = JSON.parse(localStorage.getItem("ielts_wrong_book") || "[]");
        wb = wb.filter((i) => !(i.paperId === pId && i.questionId === qId));
        localStorage.setItem("ielts_wrong_book", JSON.stringify(wb));
        openWrongBook();
      }
      function clearCurrentWrongBook() {
        if (!confirm("Á°ÆÂÆöÊ∏ÖÁ©∫Êú¨ÁØáÊâÄÊúâÈîôÈ¢òÔºü")) return;
        let wb = JSON.parse(localStorage.getItem("ielts_wrong_book") || "[]");
        wb = wb.filter((i) => i.paperId !== PAPER_ID);
        localStorage.setItem("ielts_wrong_book", JSON.stringify(wb));
        openWrongBook();
      }
      function openWrongBook() {
        const wb = JSON.parse(localStorage.getItem("ielts_wrong_book") || "[]");
        const cu = wb.filter((i) => i.paperId === PAPER_ID);
        const ct = document.getElementById("wrongBookContent");
        if (cu.length === 0)
          ct.innerHTML =
            '<div style="text-align:center;padding:40px;color:#666;">ÊöÇÊó†ÈîôÈ¢ò</div>';
        else
          ct.innerHTML = `<div class="modal-actions"><button class="btn-danger" onclick="clearCurrentWrongBook()" stylewidth:100%;">üóëÔ∏è Ê∏ÖÁ©∫Êú¨ÁØáÈîôÈ¢ò</button></div>${cu
            .map(
              (i) =>
                `<div class="wrong-item"><div class="wrong-item-content"><div style="font-weight:600;margin-bottom:8px;">${i.questionId}</div><div style="font-size:13px;color:#666;"><div>‚úì Ê≠£Á°Æ: ${i.correctAnswer}</div><div style="color:#d32f2f;">‚úó ÊàëÁöÑ: ${i.myAnswer}</div></div></div><button class="btn-delete" onclick="deleteWrongItem('${i.paperId}','${i.questionId}')">Âà†Èô§</button></div>`
            )
            .join("")}`;
        document.getElementById("wrongBookModal").classList.add("active");
      }
      function closeModal(id) {
        document.getElementById(id).classList.remove("active");
      }
    </script>
  </body>
</html>
