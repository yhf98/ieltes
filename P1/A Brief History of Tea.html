<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>P1 ‚Äì A Brief History of Tea</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  * { box-sizing: border-box; margin:0; padding:0; }
  html,body { height:100%; }
  body { font-family: Arial, sans-serif; background:#f5f5f5; }
  
  #timer { position:fixed; top:12px; right:12px; background:#fff; border:1px solid #ddd; border-radius:6px; padding:8px 12px; font-size:16px; font-weight:600; color:#0066cc; z-index:1000; }
  
  .shell { display:flex; height:100vh; width:100%; }
  .pane { background:#fff; overflow:auto; padding:24px; }
  #left { flex: 0 0 50%; border-right:1px solid #ddd; }
  #right { flex: 1 1 auto; background:#fafafa; }
  #divider { flex: 0 0 5px; background:#ddd; cursor: ew-resize; }
  #divider:hover { background:#999; }
  
  h2,h3,h4 { margin:0 0 12px; color:#333; }
  h2 { font-size:20px; }
  h3 { font-size:18px; color:#0066cc; }
  h4 { font-size:15px; font-weight:600; margin-top:20px; }
  
  #left p { margin: 0 0 14px; line-height: 1.7; text-align:justify; }
  
  .group { background:#fff; border:1px solid #ddd; border-radius:6px; padding:16px; margin-bottom:16px; }
  .group h4 { margin-top:0; color:#0066cc; }
  .group p { margin:8px 0; font-size:14px; line-height:1.6; }
  
  .headings { background:#f9f9f9; padding:12px; margin:12px 0; border-radius:4px; }
  .headings ol { margin-left:20px; }
  .headings li { margin:4px 0; font-size:13px; }
  
  table { border-collapse: collapse; width:100%; margin:12px 0; }
  th, td { border:1px solid #ddd; padding:6px; text-align:center; font-size:13px; position:relative; }
  th { background:#f5f5f5; font-weight:600; }
  
  /* Flag Ê†∑Âºè */
  .flag-btn { 
    position:absolute; 
    left:2px; 
    top:50%;
    transform:translateY(-50%);
    width:8px;
    height:8px;
    border-radius:50%;
    background:#ddd;
    cursor:pointer;
    z-index:10;
  }
  .flag-btn:hover { background:#999; }
  .flag-btn.active { background:#ff5722; }
  
  tr td:first-child { padding-left:16px; }
  
  .group ol { margin-left:20px; }
  .group ol li { margin:12px 0; font-size:14px; line-height:1.6; position:relative; }
  .group ol li label { display:inline-block; margin-right:8px; }
  
  .bottom-bar { display:flex; gap:10px; margin-top:16px; }
  button { padding:10px 20px; border:1px solid #999; border-radius:6px; background:#fff; cursor:pointer; font-size:14px; }
  button:hover { background:#f0f0f0; }
  .btn-primary { background:#0066cc; color:#fff; border-color:#0066cc; }
  .btn-primary:hover { background:#0052a3; }
  .btn-danger { background:#dc3545; color:#fff; border-color:#dc3545; }
  .btn-danger:hover { background:#c82333; }
  
  .hl { background:#fff59d; cursor:pointer; }
  .hl:hover { background:#ffeb3b; }
  .note { background:#b3d9ff; cursor:pointer; }
  .note:hover { background:#99ccff; }
  
  #selbar { position:fixed; display:none; z-index:2000; background:#fff; border:1px solid #ddd; border-radius:8px; padding:8px; gap:0; box-shadow:0 2px 8px rgba(0,0,0,0.15); flex-direction:column; min-width:120px; }
  #selbar button { background:#fff; color:#666; border:none; padding:3px 0px; cursor:pointer; font-size:14px; text-align:center; border-radius:4px; }
  #selbar button:hover { background:#f5f5f5; color:#333; }
  
  .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:3000; align-items:center; justify-content:center; }
  .modal.active { display:flex; }
  .modal-content { background:#fff; border-radius:8px; padding:24px; max-width:600px; width:90%; max-height:80vh; overflow-y:auto; }
  
  .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
  .modal-header h2 { font-size: 28px; color: #333; margin: 0; }
  .modal-close { font-size: 32px; cursor: pointer; color: #999; line-height: 1; }
  .modal-close:hover { color: #333; }
  
  .result-summary { text-align:center; padding:20px; background:#f0f0f0; margin-bottom:16px; border-radius:6px; }
  .result-score { font-size:36px; font-weight:600; color:#0066cc; }
  .result-item { padding:10px; margin:8px 0; border-left:3px solid #ddd; background:#f9f9f9; font-size:13px; }
  .result-item.correct { border-left-color:#28a745; background:#e8f5e9; }
  .result-item.incorrect { border-left-color:#dc3545; background:#ffebee; }
  
  .wrong-item { background:#fff3e0; padding:16px; margin:8px 0; border-radius:8px; border-left:4px solid #ff9800; display:flex; justify-content:space-between; align-items:start; }
  .wrong-item-content { flex:1; }
  .btn-delete { background:#dc3545; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-size:13px; margin-left:12px; }
  .btn-delete:hover { background:#c82333; }
  .modal-actions { display:flex; gap:10px; margin-bottom:20px; }
</style>
</head>
<body>
<div id="timer">00:00</div>

<div class="shell">
  <section class="pane" id="left">
    
<h2>READING PASSAGE 1</h2>
<p>You should spend about 20 minutes on Questions 1‚Äì13, which are based on Reading Passage 1 below.</p>
<h3>A Brief History of Tea</h3>

<h4>Paragraph A</h4>
<p>The story of tea began in ancient China over 5,000 years ago. According to legend, the Emperor Shen Nung was a skilled ruler, creative scientist and patron of the arts. His far-sighted edicts required, among other things, that all drinking water be boiled as a hygienic precaution. One summer day, while visiting a distant region of his realm, he and the court stopped to rest. In accordance with his ruling, the servants began to boil water for the court to drink. Dried leaves from a nearby bush fell into the boiling water, and as the leaves infused the water turned brown. As a scientist, the Emperor was intrigued by the new liquid, drank some, and found it very refreshing. And so, according to legend, tea was created.</p>

<h4>Paragraph B</h4>
<p>Tea consumption spread throughout Chinese culture, reaching into every aspect of society. The first definitive book was written on tea ‚Äì a book clearly reflecting Zen Buddhist philosophy ‚Äì 1,200 years ago. The first tea seeds were brought to Japan by a returning Buddhist priest, who had seen the value of tea in enhancing meditation in China. As a result, he is known as the "Father of Tea" in Japan. Because of this early association, tea in Japan has always been linked with Zen Buddhism. Tea received the Japanese Emperor's support almost instantly and spread rapidly from the royal court and monasteries to other sections of society.</p>

<h4>Paragraph C</h4>
<p>Tea was elevated to an art form in the Japanese tea ceremony, in which supreme importance is given to making tea in the most perfect, most polite, most graceful, most charming manner possible. Such a purity of expression prompted the creation of a particular form of architecture for tea houses, duplicating the simplicity of a forest cottage. The cultural/artistic hostesses of Japan, the geishas, began to specialise in the presentation of the tea ceremony. However, as more and more people became involved in the excitement surrounding tea, the purity of the original concept was lost, and for a period the tea ceremony became corrupted, boisterous and highly embellished. Efforts were then made to return to the earlier simplicity, with the result that, in the 15th and 16th centuries, tea was viewed as the ultimate gift. Even warlords paused for tea before battles.</p>

<h4>Paragraph D</h4>
<p>While tea was at this high level of development in parts of Asia, information concerning the then-unknown beverage began to filter back to Europe. Earlier traders had mentioned it, but were unclear as to whether tea should be eaten or drunk. The first European to personally encounter tea and write about it was Portuguese ‚Äì Portugal, with her technologically advanced navy, had been successful in gaining the first right of trade with China.</p>

<h4>Paragraph E</h4>
<p>Tea finally arrived in Europe in the 16th century, brought to Holland by the country's navy, and became very fashionable in the Dutch capital, The Hague. This was due in part to tea being very expensive (over $100 per pound), which immediately made it the domain of the wealthy. Slowly, as the amount of tea imported increased, the price fell, and by 1675 it was available in common food shops throughout Holland.</p>

<h4>Paragraph F</h4>
<p>As the consumption of tea increased dramatically in Dutch society, doctors and university authorities in Holland argued as to its benefits or drawbacks. The public largely ignored the scholarly debate and continued to enjoy their new beverage, though the controversy lasted from 1635 to roughly 1657. Throughout this period, France and Holland led Europe in the use of tea.</p>

<h4>Paragraph G</h4>
<p>As the craze for all things oriental swept through Europe, tea became part of everyday life. Adding milk to the drink was first mentioned in 1680. Around that time, Dutch inns provided the first restaurant service of tea. Innkeepers would furnish guests with a portable tea set complete with a heating unit. The Dutchman would then prepare tea for himself and his friends outside in the inn garden. Tea remained popular in France for only about fifty years, being replaced by a preference for wine, chocolate and exotic coffees. Tea was introduced into England in 1660 by King Charles II and his Portuguese queen, who were both confirmed tea drinkers. Tea mania swept across England as it had earlier spread throughout France and Holland. By 1708, tea importation had risen to thirteen times the 1699 level. Tea was drunk by all levels of society.</p>

<h4>Paragraph H</h4>
<p>Russian interest in tea began as early as 1618, when the Chinese embassy in Moscow presented several chests of tea to the Emperor, Czar Alexis. Later in the century, a trade treaty between Russia and China allowed caravans to cross back and forth freely between the two countries. Still, the journey was not easy. The average caravan consisted of 200 to 300 camels, and the 18,000-kilometre trip took over 16 months to complete. Eventually, however, tea became ‚Äì as it still is ‚Äì one of the most popular drinks in the country.</p>

  </section>

  <div id="divider" title="Drag to resize"></div>

  <section class="pane" id="right">
    <h3>Questions</h3>

    <div class="group">
      <h4>Questions 1‚Äì8</h4>
      <p>Reading Passage 1 has eight paragraphs A‚ÄìH.</p>
      <p>Choose the correct heading for each paragraph from the list of headings below.</p>
      <p>Write the correct number, <strong>i‚Äìx</strong>, in boxes <strong>1‚Äì8</strong> on your answer sheet.</p>

      <div class="headings">
        <p><strong>List of Headings</strong></p>
        <ol type="i" style="line-height:2;">
          <li>Not enough tea to meet demand</li>
          <li>Religious objections</li>
          <li>In ‚Äì and sometimes out ‚Äì of fashion</li>
          <li>A connection between tea and religion</li>
          <li>A luxury item</li>
          <li>News of tea reaches another continent</li>
          <li>Is tea a good or a bad thing?</li>
          <li>A chance discovery</li>
          <li>Tea-making as a ritual</li>
          <li>Difficulties in importing tea</li>
        </ol>
      </div>

      <table>
        <tr>
          <th>Para</th>
          <th>i</th><th>ii</th><th>iii</th><th>iv</th><th>v</th><th>vi</th><th>vii</th><th>viii</th><th>ix</th><th>x</th>
        </tr>
        <tr><td><span class="flag-btn" data-q="q1"></span>A</td><td><input type="radio" name="q1" value="i"></td><td><input type="radio" name="q1" value="ii"></td><td><input type="radio" name="q1" value="iii"></td><td><input type="radio" name="q1" value="iv"></td><td><input type="radio" name="q1" value="v"></td><td><input type="radio" name="q1" value="vi"></td><td><input type="radio" name="q1" value="vii"></td><td><input type="radio" name="q1" value="viii"></td><td><input type="radio" name="q1" value="ix"></td><td><input type="radio" name="q1" value="x"></td></tr>
        <tr><td><span class="flag-btn" data-q="q2"></span>B</td><td><input type="radio" name="q2" value="i"></td><td><input type="radio" name="q2" value="ii"></td><td><input type="radio" name="q2" value="iii"></td><td><input type="radio" name="q2" value="iv"></td><td><input type="radio" name="q2" value="v"></td><td><input type="radio" name="q2" value="vi"></td><td><input type="radio" name="q2" value="vii"></td><td><input type="radio" name="q2" value="viii"></td><td><input type="radio" name="q2" value="ix"></td><td><input type="radio" name="q2" value="x"></td></tr>
        <tr><td><span class="flag-btn" data-q="q3"></span>C</td><td><input type="radio" name="q3" value="i"></td><td><input type="radio" name="q3" value="ii"></td><td><input type="radio" name="q3" value="iii"></td><td><input type="radio" name="q3" value="iv"></td><td><input type="radio" name="q3" value="v"></td><td><input type="radio" name="q3" value="vi"></td><td><input type="radio" name="q3" value="vii"></td><td><input type="radio" name="q3" value="viii"></td><td><input type="radio" name="q3" value="ix"></td><td><input type="radio" name="q3" value="x"></td></tr>
        <tr><td><span class="flag-btn" data-q="q4"></span>D</td><td><input type="radio" name="q4" value="i"></td><td><input type="radio" name="q4" value="ii"></td><td><input type="radio" name="q4" value="iii"></td><td><input type="radio" name="q4" value="iv"></td><td><input type="radio" name="q4" value="v"></td><td><input type="radio" name="q4" value="vi"></td><td><input type="radio" name="q4" value="vii"></td><td><input type="radio" name="q4" value="viii"></td><td><input type="radio" name="q4" value="ix"></td><td><input type="radio" name="q4" value="x"></td></tr>
        <tr><td><span class="flag-btn" data-q="q5"></span>E</td><td><input type="radio" name="q5" value="i"></td><td><input type="radio" name="q5" value="ii"></td><td><input type="radio" name="q5" value="iii"></td><td><input type="radio" name="q5" value="iv"></td><td><input type="radio" name="q5" value="v"></td><td><input type="radio" name="q5" value="vi"></td><td><input type="radio" name="q5" value="vii"></td><td><input type="radio" name="q5" value="viii"></td><td><input type="radio" name="q5" value="ix"></td><td><input type="radio" name="q5" value="x"></td></tr>
        <tr><td><span class="flag-btn" data-q="q6"></span>F</td><td><input type="radio" name="q6" value="i"></td><td><input type="radio" name="q6" value="ii"></td><td><input type="radio" name="q6" value="iii"></td><td><input type="radio" name="q6" value="iv"></td><td><input type="radio" name="q6" value="v"></td><td><input type="radio" name="q6" value="vi"></td><td><input type="radio" name="q6" value="vii"></td><td><input type="radio" name="q6" value="viii"></td><td><input type="radio" name="q6" value="ix"></td><td><input type="radio" name="q6" value="x"></td></tr>
        <tr><td><span class="flag-btn" data-q="q7"></span>G</td><td><input type="radio" name="q7" value="i"></td><td><input type="radio" name="q7" value="ii"></td><td><input type="radio" name="q7" value="iii"></td><td><input type="radio" name="q7" value="iv"></td><td><input type="radio" name="q7" value="v"></td><td><input type="radio" name="q7" value="vi"></td><td><input type="radio" name="q7" value="vii"></td><td><input type="radio" name="q7" value="viii"></td><td><input type="radio" name="q7" value="ix"></td><td><input type="radio" name="q7" value="x"></td></tr>
        <tr><td><span class="flag-btn" data-q="q8"></span>H</td><td><input type="radio" name="q8" value="i"></td><td><input type="radio" name="q8" value="ii"></td><td><input type="radio" name="q8" value="iii"></td><td><input type="radio" name="q8" value="iv"></td><td><input type="radio" name="q8" value="v"></td><td><input type="radio" name="q8" value="vi"></td><td><input type="radio" name="q8" value="vii"></td><td><input type="radio" name="q8" value="viii"></td><td><input type="radio" name="q8" value="ix"></td><td><input type="radio" name="q8" value="x"></td></tr>
      </table>
    </div>

    <div class="group">
      <h4>Questions 9‚Äì13</h4>
      <p>Look at the following statements (Questions 9‚Äì13) and the list of countries below.</p>
      <p>Match each statement with the correct country, <strong>A‚ÄìG</strong>.</p>
      
      <div class="headings">
        <p><strong>List of Countries</strong></p>
        <div style="line-height:2;">
          <div>A. China</div>
          <div>B. Japan</div>
          <div>C. Portugal</div>
          <div>D. Holland</div>
          <div>E. France</div>
          <div>F. England</div>
          <div>G. Russia</div>
        </div>
      </div>

      <ol start="9">
        <li><span class="flag-btn" data-q="q9" style="left:-20px;"></span>Claims that tea might be harmful failed to affect its popularity.<br>
          <label><input type="radio" name="q9" value="A"> A</label>
          <label><input type="radio" name="q9" value="B"> B</label>
          <label><input type="radio" name="q9" value="C"> C</label>
          <label><input type="radio" name="q9" value="D"> D</label>
          <label><input type="radio" name="q9" value="E"> E</label>
          <label><input type="radio" name="q9" value="F"> F</label>
          <label><input type="radio" name="q9" value="G"> G</label>
        </li>
        <li><span class="flag-btn" data-q="q10" style="left:-20px;"></span>Tea lost favour to other drinks.<br>
          <label><input type="radio" name="q10" value="A"> A</label>
          <label><input type="radio" name="q10" value="B"> B</label>
          <label><input type="radio" name="q10" value="C"> C</label>
          <label><input type="radio" name="q10" value="D"> D</label>
          <label><input type="radio" name="q10" value="E"> E</label>
          <label><input type="radio" name="q10" value="F"> F</label>
          <label><input type="radio" name="q10" value="G"> G</label>
        </li>
        <li><span class="flag-btn" data-q="q11" style="left:-20px;"></span>Special buildings were constructed in which to drink tea.<br>
          <label><input type="radio" name="q11" value="A"> A</label>
          <label><input type="radio" name="q11" value="B"> B</label>
          <label><input type="radio" name="q11" value="C"> C</label>
          <label><input type="radio" name="q11" value="D"> D</label>
          <label><input type="radio" name="q11" value="E"> E</label>
          <label><input type="radio" name="q11" value="F"> F</label>
          <label><input type="radio" name="q11" value="G"> G</label>
        </li>
        <li><span class="flag-btn" data-q="q12" style="left:-20px;"></span>Animals were involved in importing tea.<br>
          <label><input type="radio" name="q12" value="A"> A</label>
          <label><input type="radio" name="q12" value="B"> B</label>
          <label><input type="radio" name="q12" value="C"> C</label>
          <label><input type="radio" name="q12" value="D"> D</label>
          <label><input type="radio" name="q12" value="E"> E</label>
          <label><input type="radio" name="q12" value="F"> F</label>
          <label><input type="radio" name="q12" value="G"> G</label>
        </li>
        <li><span class="flag-btn" data-q="q13" style="left:-20px;"></span>A ruler's specialist knowledge led to an interest in tea.<br>
          <label><input type="radio" name="q13" value="A"> A</label>
          <label><input type="radio" name="q13" value="B"> B</label>
          <label><input type="radio" name="q13" value="C"> C</label>
          <label><input type="radio" name="q13" value="D"> D</label>
          <label><input type="radio" name="q13" value="E"> E</label>
          <label><input type="radio" name="q13" value="F"> F</label>
          <label><input type="radio" name="q13" value="G"> G</label>
        </li>
      </ol>
    </div>

    <div class="bottom-bar">
      <button class="btn-primary" onclick="submitAnswers()">Êèê‰∫§</button>
      <button onclick="resetForm()">ÈáçÁΩÆ</button>
      <button onclick="openWrongBook()">Êú¨ÁØáÈîôÈ¢ò</button>
    </div>
  </section>
</div>

<div id="selbar">
  <button id="btnNote">Note</button>
  <button id="btnHL">Highlight</button>
  <button id="btnUH" style="display:none;">Clear Highlight</button>
</div>

<div class="modal" id="resultModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ÊàêÁª©</h2>
      <span class="modal-close" onclick="closeModal('resultModal')">√ó</span>
    </div>
    <div id="resultContent"></div>
    <button class="btn-primary" style="width:100%; margin-top:16px;" onclick="addWrongToBook()">Âä†ÂÖ•ÈîôÈ¢òÊú¨</button>
  </div>
</div>

<div class="modal" id="wrongBookModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Êú¨ÁØáÈîôÈ¢ò</h2>
      <span class="modal-close" onclick="closeModal('wrongBookModal')">√ó</span>
    </div>
    <div id="wrongBookContent"></div>
  </div>
</div>

<div class="modal" id="resetModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ÈáçÁΩÆÁªÉ‰π†</h2>
      <span class="modal-close" onclick="closeModal('resetModal')">√ó</span>
    </div>
    <div style="margin:16px 0;">
      <label style="display:block; margin-bottom:10px;">
        <input type="radio" name="resetType" value="answers" checked>
        Âè™Ê∏ÖÁ©∫Á≠îÊ°à
      </label>
      <label style="display:block;">
        <input type="radio" name="resetType" value="all">
        Ê∏ÖÁ©∫Á≠îÊ°àÂíåÊ†áËÆ∞
      </label>
    </div>
    <button class="btn-primary" style="width:100%;" onclick="confirmReset()">Á°ÆÂÆö</button>
  </div>
</div>

<script>
const PAPER_ID='P1_TEA';

let t=0;
const timerEl=document.getElementById('timer');
setInterval(()=>{ t++; timerEl.textContent=String(Math.floor(t/60)).padStart(2,'0')+':'+String(t%60).padStart(2,'0'); }, 1000);

const divider=document.getElementById('divider'), left=document.getElementById('left'), right=document.getElementById('right');
let dragging=false;
divider.onmousedown=()=>{ dragging=true; document.body.style.cursor='ew-resize'; };
window.onmousemove=(e)=>{ if(!dragging)return; const c=document.querySelector('.shell').getBoundingClientRect(); let x=e.clientX-c.left; x=Math.max(280,Math.min(c.width-280,x)); left.style.flex='0 0 '+x+'px'; right.style.flex='1 1 auto'; };
window.onmouseup=()=>{ dragging=false; document.body.style.cursor=''; };

const selbar=document.getElementById('selbar'), btnHL=document.getElementById('btnHL'), btnUH=document.getElementById('btnUH'), btnNote=document.getElementById('btnNote');
let lastRange=null, currentHlNode=null;

function posSelbar(r){ selbar.style.display='flex'; const t=window.scrollY+r.top-selbar.offsetHeight-8; const l=window.scrollX+r.left+r.width/2-selbar.offsetWidth/2; selbar.style.top=((t>0)?t:(window.scrollY+r.bottom+8))+'px'; selbar.style.left=Math.max(8,l)+'px'; }

function updSel(){ const s=window.getSelection(); if(!s||s.rangeCount===0||s.isCollapsed){ if(!currentHlNode)selbar.style.display='none'; return; } const r=s.getRangeAt(0); lastRange=r.cloneRange(); currentHlNode=null; btnNote.style.display='block'; btnHL.style.display='block'; btnUH.style.display='none'; posSelbar(r.getBoundingClientRect()); }

left.onmouseup=updSel; right.onmouseup=updSel;
document.onselectionchange=()=>{ const s=window.getSelection(); if((!s||s.rangeCount===0||s.isCollapsed)&&!currentHlNode)selbar.style.display='none'; };
document.addEventListener('click',(e)=>{ if(e.target.classList&&(e.target.classList.contains('hl')||e.target.classList.contains('note'))){ currentHlNode=e.target; lastRange=null; btnNote.style.display='none'; btnHL.style.display='none'; btnUH.style.display='block'; posSelbar(e.target.getBoundingClientRect()); const s=window.getSelection(); if(s)s.removeAllRanges(); }}, true);

btnHL.onclick=()=>{ if(currentHlNode||!lastRange||lastRange.collapsed)return; const s=document.createElement('span'); s.className='hl'; try{ lastRange.surroundContents(s); }catch(e){ const w=document.createElement('span'); w.className='hl'; w.appendChild(lastRange.cloneContents()); lastRange.deleteContents(); lastRange.insertNode(w); } selbar.style.display='none'; saveHighlights(); };

btnNote.onclick=()=>{ if(currentHlNode||!lastRange||lastRange.collapsed)return; const s=document.createElement('span'); s.className='note'; try{ lastRange.surroundContents(s); }catch(e){ const w=document.createElement('span'); w.className='note'; w.appendChild(lastRange.cloneContents()); lastRange.deleteContents(); lastRange.insertNode(w); } selbar.style.display='none'; saveHighlights(); };

btnUH.onclick=()=>{ if(currentHlNode){ const p=currentHlNode.parentNode; while(currentHlNode.firstChild)p.insertBefore(currentHlNode.firstChild,currentHlNode); p.removeChild(currentHlNode); p.normalize(); currentHlNode=null; selbar.style.display='none'; saveHighlights(); }else if(lastRange){ const sR=lastRange.getBoundingClientRect(); const w=document.createTreeWalker(document.body,NodeFilter.SHOW_ELEMENT); const tr=[]; while(w.nextNode()){ const n=w.currentNode; if(n.classList&&(n.classList.contains('hl')||n.classList.contains('note'))){ const r=n.getBoundingClientRect(); if(!(r.right<sR.left||r.left>sR.right||r.bottom<sR.top||r.top>sR.bottom))tr.push(n); }} tr.forEach(el=>{ const p=el.parentNode; while(el.firstChild)p.insertBefore(el.firstChild,el); p.removeChild(el); p.normalize(); }); selbar.style.display='none'; saveHighlights(); }};

document.querySelectorAll('.flag-btn').forEach(btn => {
  btn.onclick = e => {
    e.stopPropagation();
    btn.classList.toggle('active');
    saveFlags();
  };
});

const answerKey={q1:"viii",q2:"iv",q3:"ix",q4:"vi",q5:"v",q6:"vii",q7:"iii",q8:"x",q9:"D",q10:"E",q11:"B",q12:"G",q13:"A"};
let lastResults=[];

function saveAnswers() {
  const data = {};
  Object.keys(answerKey).forEach(q => {
    const ch = document.querySelector(`input[name="${q}"]:checked`);
    if(ch) data[q] = ch.value;
  });
  localStorage.setItem(`${PAPER_ID}_answers`, JSON.stringify(data));
}

function loadAnswers() {
  const data = JSON.parse(localStorage.getItem(`${PAPER_ID}_answers`) || '{}');
  Object.keys(data).forEach(q => {
    const radio = document.querySelector(`input[name="${q}"][value="${data[q]}"]`);
    if(radio) radio.checked = true;
  });
}

function saveFlags() {
  const flags = [...document.querySelectorAll('.flag-btn.active')].map(b => b.dataset.q);
  localStorage.setItem(`${PAPER_ID}_flags`, JSON.stringify(flags));
}

function loadFlags() {
  const flags = JSON.parse(localStorage.getItem(`${PAPER_ID}_flags`) || '[]');
  flags.forEach(q => document.querySelector(`[data-q="${q}"]`)?.classList.add('active'));
}

function saveHighlights() {
  const highlights = [];
  document.querySelectorAll('#left .hl, #left .note').forEach((el, idx) => {
    highlights.push({
      type: el.classList.contains('hl') ? 'hl' : 'note',
      text: el.textContent,
      index: idx
    });
  });
  localStorage.setItem(`${PAPER_ID}_highlights`, JSON.stringify(highlights));
}

function loadHighlights() {
  const data = JSON.parse(localStorage.getItem(`${PAPER_ID}_highlights`) || '[]');
  if(data.length === 0) return;
  
  data.forEach(item => {
    const walker = document.createTreeWalker(left, NodeFilter.SHOW_TEXT);
    let node;
    while(node = walker.nextNode()) {
      if(node.textContent.includes(item.text)) {
        const span = document.createElement('span');
        span.className = item.type;
        const parent = node.parentNode;
        const text = node.textContent;
        const idx = text.indexOf(item.text);
        if(idx >= 0) {
          const before = text.substring(0, idx);
          const match = text.substring(idx, idx + item.text.length);
          const after = text.substring(idx + item.text.length);
          
          parent.insertBefore(document.createTextNode(before), node);
          span.textContent = match;
          parent.insertBefore(span, node);
          parent.insertBefore(document.createTextNode(after), node);
          parent.removeChild(node);
          break;
        }
      }
    }
  });
}

document.querySelectorAll('input[type="radio"]').forEach(radio => {
  radio.addEventListener('change', saveAnswers);
});

document.addEventListener('DOMContentLoaded', () => {
  loadAnswers();
  loadFlags();
  loadHighlights();
});

function submitAnswers(){ const res=[]; let cor=0; Object.keys(answerKey).forEach(q=>{ const ch=document.querySelector('input[name="'+q+'"]:checked'); const uA=ch?ch.value:""; const cA=answerKey[q]; const iC=uA===cA; if(iC)cor++; res.push({id:q,userAns:uA,correctAns:cA,isCorrect:iC}); }); lastResults=res; const tot=Object.keys(answerKey).length; const pct=((cor/tot)*100).toFixed(1); document.getElementById('resultContent').innerHTML=`<div class="result-summary"><div class="result-score">${cor} / ${tot}</div><div style="margin-top:8px;font-size:18px;">${pct}%</div></div>${res.map(r=>`<div class="result-item ${r.isCorrect?'correct':'incorrect'}"><div><strong>${r.id}</strong> ${r.isCorrect?'‚úì':'‚úó'}</div><div>‰Ω†ÁöÑÁ≠îÊ°à: ${r.userAns||'(Êú™‰ΩúÁ≠î)'}</div>${!r.isCorrect?`<div>Ê≠£Á°ÆÁ≠îÊ°à: ${r.correctAns}</div>`:''}</div>`).join('')}`; document.getElementById('resultModal').classList.add('active'); }

function resetForm(){ document.getElementById('resetModal').classList.add('active'); }

function confirmReset(){ 
  const tp=document.querySelector('input[name="resetType"]:checked').value; 
  document.querySelectorAll('input[type="radio"]').forEach(i=>i.checked=false); 
  localStorage.removeItem(`${PAPER_ID}_answers`);
  
  if(tp==='all'){ 
    document.querySelectorAll('.hl').forEach(el=>{ const p=el.parentNode; while(el.firstChild)p.insertBefore(el.firstChild,el); p.removeChild(el); p.normalize(); }); 
    document.querySelectorAll('.note').forEach(el=>{ const p=el.parentNode; while(el.firstChild)p.insertBefore(el.firstChild,el); p.removeChild(el); p.normalize(); }); 
    document.querySelectorAll('.flag-btn').forEach(b => b.classList.remove('active'));
    localStorage.removeItem(`${PAPER_ID}_highlights`);
    localStorage.removeItem(`${PAPER_ID}_flags`);
  } 
  closeModal('resetModal'); 
}

function addWrongToBook(){ const wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); const wr=lastResults.filter(r=>!r.isCorrect); wr.forEach(r=>{ const en={paperId:PAPER_ID,title:'A Brief History of Tea',questionId:r.id,correctAnswer:r.correctAns,myAnswer:r.userAns||'(Êú™‰ΩúÁ≠î)',date:new Date().toISOString().split('T')[0]}; const ix=wb.findIndex(i=>i.paperId===en.paperId&&i.questionId===en.questionId); if(ix>=0)wb[ix]=en; else wb.push(en); }); localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); alert(`Â∑≤Ê∑ªÂä† ${wr.length} ÈÅìÈîôÈ¢ò`); closeModal('resultModal'); }

function deleteWrongItem(pId,qId){ if(!confirm('Á°ÆÂÆöÂà†Èô§ËøôÈÅìÈîôÈ¢òÔºü'))return; let wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); wb=wb.filter(i=>!(i.paperId===pId&&i.questionId===qId)); localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); openWrongBook(); }

function clearCurrentWrongBook(){ if(!confirm('Á°ÆÂÆöÊ∏ÖÁ©∫Êú¨ÁØáÊâÄÊúâÈîôÈ¢òÔºü'))return; let wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); wb=wb.filter(i=>i.paperId!==PAPER_ID); localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); openWrongBook(); }

function openWrongBook(){ const wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); const cu=wb.filter(i=>i.paperId===PAPER_ID); const ct=document.getElementById('wrongBookContent'); if(cu.length===0)ct.innerHTML='<div style="text-align:center;padding:40px;color:#666;">ÊöÇÊó†ÈîôÈ¢ò</div>'; else ct.innerHTML=`<div class="modal-actions"><button class="btn-danger" onclick="clearCurrentWrongBook()" style="width:100%;">üóëÔ∏è Ê∏ÖÁ©∫Êú¨ÁØáÈîôÈ¢ò</button></div>${cu.map(i=>`<div class="wrong-item"><div class="wrong-item-content"><div style="font-weight:600;margin-bottom:8px;">${i.questionId}</div><div style="font-size:13px;color:#666;"><div>‚úì Ê≠£Á°Æ: ${i.correctAnswer}</div><div style="color:#d32f2f;">‚úó ÊàëÁöÑ: ${i.myAnswer}</div></div></div><button class="btn-delete" onclick="deleteWrongItem('${i.paperId}','${i.questionId}')">Âà†Èô§</button></div>`).join('')}`; document.getElementById('wrongBookModal').classList.add('active'); }

function closeModal(id){ document.getElementById(id).classList.remove('active'); }
</script>
</body>
</html>