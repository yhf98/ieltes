<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>P1 ‚Äì The history of the British wool industry</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      html,
      body {
        height: 100%;
      }
      body {
        font-family: Arial, sans-serif;
        background: #f5f5f5;
      }
      #timer {
        position: fixed;
        top: 12px;
        right: 12px;
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 8px 12px;
        font-size: 16px;
        font-weight: 600;
        color: #0066cc;
        z-index: 1000;
      }
      .shell {
        display: flex;
        height: 100vh;
        width: 100%;
      }
      .pane {
        background: #fff;
        overflow: auto;
        padding: 24px;
      }
      #left {
        flex: 0 0 50%;
        border-right: 1px solid #ddd;
      }
      #right {
        flex: 1 1 auto;
        background: #fafafa;
      }
      #divider {
        flex: 0 0 5px;
        background: #ddd;
        cursor: ew-resize;
      }
      #divider:hover {
        background: #999;
      }
      h2,
      h3,
      h4 {
        margin: 0 0 12px;
        color: #333;
      }
      h2 {
        font-size: 20px;
      }
      h3 {
        font-size: 18px;
        color: #0066cc;
      }
      h4 {
        font-size: 15px;
        font-weight: 600;
        margin-top: 20px;
      }
      #left p {
        margin: 0 0 14px;
        line-height: 1.7;
        text-align: justify;
      }
      .group {
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 16px;
        margin-bottom: 16px;
      }
      .group h4 {
        margin-top: 0;
        color: #0066cc;
      }
      .group p {
        margin: 8px 0;
        font-size: 14px;
        line-height: 1.6;
      }
      .flag-btn {
        position: absolute;
        left: 2px;
        top: 50%;
        transform: translateY(-50%);
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #ddd;
        cursor: pointer;
        z-index: 10;
      }
      .flag-btn:hover {
        background: #999;
      }
      .flag-btn.active {
        background: #ff5722;
      }
      .group ol {
        margin-left: 20px;
      }
      .group ol li {
        margin: 12px 0;
        font-size: 14px;
        line-height: 1.6;
        position: relative;
      }
      .group ol li label {
        display: inline-block;
        margin-right: 8px;
      }
      input[type="text"] {
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 4px 8px;
        font-size: 14px;
        width: 160px;
        background: #fdfdfd;
      }
      input[type="text"]:focus {
        border-color: #0066cc;
        outline: none;
        background: #fff;
      }
      .bottom-bar {
        display: flex;
        gap: 10px;
        margin-top: 16px;
      }
      button {
        padding: 10px 20px;
        border: 1px solid #999;
        border-radius: 6px;
        background: #fff;
        cursor: pointer;
        font-size: 14px;
      }
      button:hover {
        background: #f0f0f0;
      }
      .btn-primary {
        background: #0066cc;
        color: #fff;
        border-color: #0066cc;
      }
      .btn-primary:hover {
        background: #0052a3;
      }
      .btn-danger {
        background: #dc3545;
        color: #fff;
        border-color: #dc3545;
      }
      .btn-danger:hover {
        background: #c82333;
      }
      .hl {
        background: #fff59d;
        cursor: pointer;
      }
      .hl:hover {
        background: #ffeb3b;
      }
      .note {
        background: #b3d9ff;
        cursor: pointer;
      }
      .note:hover {
        background: #99ccff;
      }
      #selbar {
        position: fixed;
        display: none;
        z-index: 2000;
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 8px;
        gap: 0;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        flex-direction: column;
        min-width: 120px;
      }
      #selbar button {
        background: #fff;
        color: #666;
        border: none;
        padding: 3px 0px;
        cursor: pointer;
        font-size: 14px;
        text-align: center;
        border-radius: 4px;
      }
      #selbar button:hover {
        background: #f5f5f5;
        color: #333;
      }
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 3000;
        align-items: center;
        justify-content: center;
      }
      .modal.active {
        display: flex;
      }
      .modal-content {
        background: #fff;
        border-radius: 8px;
        padding: 24px;
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
      }
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
      }
      .modal-header h2 {
        font-size: 28px;
        color: #333;
        margin: 0;
      }
      .modal-close {
        font-size: 32px;
        cursor: pointer;
        color: #999;
        line-height: 1;
      }
      .modal-close:hover {
        color: #333;
      }
      .result-summary {
        text-align: center;
        padding: 20px;
        background: #f0f0f0;
        margin-bottom: 16px;
        border-radius: 6px;
      }
      .result-score {
        font-size: 36px;
        font-weight: 600;
        color: #0066cc;
      }
      .result-item {
        padding: 10px;
        margin: 8px 0;
        border-left: 3px solid #ddd;
        background: #f9f9f9;
        font-size: 13px;
      }
      .result-item.correct {
        border-left-color: #28a745;
        background: #e8f5e9;
      }
      .result-item.incorrect {
        border-left-color: #dc3545;
        background: #ffebee;
      }
      .wrong-item {
        background: #fff3e0;
        padding: 16px;
        margin: 8px 0;
        border-radius: 8px;
        border-left: 4px solid #ff9800;
        display: flex;
        justify-content: space-between;
        align-items: start;
      }
      .wrong-item-content {
        flex: 1;
      }
      .btn-delete {
        background: #dc3545;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
        margin-left: 12px;
      }
      .btn-delete:hover {
        background: #c82333;
      }
      .modal-actions {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }
    </style>
  </head>
  <body>
    <div id="timer">00:00</div>
    <div class="shell">
      <section class="pane" id="left">
        <h2>READING PASSAGE 1</h2>
        <p>
          You should spend about 20 minutes on Questions 1‚Äì13, which are based
          on Reading Passage 1 below.
        </p>
        <h3>The history of the British wool industry</h3>
        <p>
          Wool is part of Britain‚Äôs history and heritage, more so than any other
          commodity ever produced in that country. It was made into cloth there
          in the Bronze Age, which began about 1900 BC. By the time the Romans
          invaded in 55 BC the Britons had developed a wool industry, and this
          was encouraged by their new masters. Roman emperors appreciated the
          fineness of British woollen cloth. Although Saxon invasions in the
          fifth century nearly destroyed the industry, it is known that in the
          eighth century Britain was exporting woollen fabrics to continental
          Europe, and after the arrival of the Norman conquerors in 1066 the
          industry expanded. By the twelfth century, wool was becoming England‚Äôs
          greatest national asset. Cloth making was widespread, particularly in
          the large towns of southern and eastern England, nearest to France.
          But the greatest wealth came from exports of raw wool.
        </p>
        <p>
          Kings and their ministers welcomed the revenue that resulted from
          exports and export taxes ‚Äì and also the power it gave to the king, who
          could grant or withdraw permits for the wool towns and for the
          industry. Trade associations, known as ‚Äòguilds‚Äô, were founded to
          guarantee good work by experienced weavers (people who produce cloth
          from woollen threads), and were powerful for hundreds of years. The
          peak of cloth production was reached in the thirteenth century. Then
          the wool trade declined for a long period because of political
          conflict.
        </p>
        <p>
          In 1331, King Edward III encouraged master weavers from Flanders (an
          area of present-day Belgium) to settle in England. These Flemish
          weavers and their descendants were to play a part in the final
          development of English cloth. The export trade in raw wool recovered
          and the first half of the fourteenth century was a time of prosperity
          for English wool farmers. But it was overshadowed by a long war with
          France (export taxes on wool were one of the principal means of
          financing the war) and by bubonic plague (the Black Death), which in
          1349 caused devastation: in many villages as much as three-quarters of
          the population died. This led to an increase of the sheep flocks, for
          there were not enough people left to cultivate the land for arable
          crops.
        </p>
        <p>
          Despite setbacks, raw wool exporting expanded, and so also did
          manufacturing of wool fabrics. This was becoming both specialised and
          localised. The area of England known as the West Country had three
          advantages ‚Äì extensive sheep pastures, a supply of soft water for
          washing, scouring and dyeing wool, and water-power to drive machinery.
          Similarly, the hills of Yorkshire and Lancashire in the north of
          England had soft water and fast running streams. Water from the latter
          could be used to drive mills for ‚Äòfulling‚Äô, a shrinking process which
          makes the fabric firmer and its surface more compact.
        </p>
        <p>
          In East Anglia there was soft water, but no hills or fast-running
          streams to provide power for fulling mills. Instead, East Anglia used
          the long, fine wool from its native sheep breeds to produce a cloth
          which did not require the fulling process. This was the type of cloth
          which is now called ‚Äòworsted‚Äô, after the village of Worstead. For four
          hundred years East Anglia dominated the worsted trade, with skills
          inherited from the Flemish settlers of 1331.
        </p>
        <p>
          English cloth quickly achieved an international reputation. From being
          primarily a raw wool exporter, the country became in the fourteenth
          and fifteenth centuries a manufacturer and exporter of cloth. At the
          end of the fifteenth century, it was said that England was largely a
          nation of sheep farmers and cloth manufacturers. The next two
          centuries saw continued expansion of the industry despite conflicts at
          home and abroad. In the sixteenth century, French weavers, persecuted
          for their Protestant religion, sought refuge in England and took their
          skills with them. England began to surpass Flanders in woollen
          manufacture; by the end of the seventeenth century it comprised
          two-thirds of the value of its exports. Radical changes lay ahead, in
          the geographical location of the industry, in labour use and in
          manufacturing processes. By 1770, output of worsted from Yorkshire
          equalled that of East Anglia, and its cloth manufacturing district
          began to take shape with the expansion of major towns: Leeds,
          Bradford, Halifax, Huddersfield, and Wakefield.
        </p>
        <p>
          The Industrial Revolution of 1750‚Äì1850 also brought change. It led the
          way for new inventions stemming from the Lancashire cotton industry,
          to mechanize and speed dramatically the processes of spinning and
          weaving. Manufacturing methods, unchanged since the revival of the
          trade in the fourteenth century, were now superseded. Mechanization
          had been opposed in the past and it was again. The widespread unrest
          of 1812 led to the destruction of equipment by bands of rioters, who
          feared they would lose employment. But machinery won the day.
        </p>
        <p>
          Over the course of the nineteenth century, the older industries in
          areas such as East Anglia, where opposition had been most bitter,
          permanently declined. They were overtaken by Yorkshire, where
          machinery was more readily accepted. The younger industry jumped ahead
          and never lost its lead, supported by abundant supplies of inexpensive
          coal to generate steam and, later, electrical power. Other specialised
          types of manufacturing developed in Scotland, famed for its tweeds (a
          range of coloured woollen cloth with characteristic designs), and in
          the West Country, which focused on the production of high-quality,
          woven carpets.
        </p>
      </section>
      <div id="divider"></div>
      <section class="pane" id="right">
        <h3>Questions</h3>
        <div class="group">
          <h4>Questions 1‚Äì5</h4>
          <p>
            Do the following statements agree with the information given in
            Reading Passage 1?
          </p>
          <div style="margin: 8px 0 16px 20px">
            <div>
              <strong>TRUE</strong> if the statement agrees with the information
            </div>
            <div>
              <strong>FALSE</strong> if the statement contradicts the
              information
            </div>
            <div>
              <strong>NOT GIVEN</strong> if there is no information on this
            </div>
          </div>
          <ol start="1">
            <li>
              <span class="flag-btn" data-q="q1" style="left: -20px"></span>The
              process of making cloth from wool was introduced to Britain by the
              Romans.<br />
              <label><input type="radio" name="q1" value="TRUE" /> TRUE</label>
              <label
                ><input type="radio" name="q1" value="FALSE" /> FALSE</label
              >
              <label
                ><input type="radio" name="q1" value="NOT GIVEN" /> NOT
                GIVEN</label
              >
            </li>
            <li>
              <span class="flag-btn" data-q="q2" style="left: -20px"></span>In
              the twelfth century, exporting woollen cloth was less profitable
              than exporting raw wool.<br />
              <label><input type="radio" name="q2" value="TRUE" /> TRUE</label>
              <label
                ><input type="radio" name="q2" value="FALSE" /> FALSE</label
              >
              <label
                ><input type="radio" name="q2" value="NOT GIVEN" /> NOT
                GIVEN</label
              >
            </li>
            <li>
              <span class="flag-btn" data-q="q3" style="left: -20px"></span
              >Rulers had a financial interest in the success of the wool
              industry.<br />
              <label><input type="radio" name="q3" value="TRUE" /> TRUE</label>
              <label
                ><input type="radio" name="q3" value="FALSE" /> FALSE</label
              >
              <label
                ><input type="radio" name="q3" value="NOT GIVEN" /> NOT
                GIVEN</label
              >
            </li>
            <li>
              <span class="flag-btn" data-q="q4" style="left: -20px"></span>An
              outbreak of bubonic plague led to a sharp fall in sheep
              numbers.<br />
              <label><input type="radio" name="q4" value="TRUE" /> TRUE</label>
              <label
                ><input type="radio" name="q4" value="FALSE" /> FALSE</label
              >
              <label
                ><input type="radio" name="q4" value="NOT GIVEN" /> NOT
                GIVEN</label
              >
            </li>
            <li>
              <span class="flag-btn" data-q="q5" style="left: -20px"></span
              >Worsted cloth was cheaper to produce than other types of woollen
              fabric.<br />
              <label><input type="radio" name="q5" value="TRUE" /> TRUE</label>
              <label
                ><input type="radio" name="q5" value="FALSE" /> FALSE</label
              >
              <label
                ><input type="radio" name="q5" value="NOT GIVEN" /> NOT
                GIVEN</label
              >
            </li>
          </ol>
        </div>
        <div class="group">
          <h4>Questions 6‚Äì13</h4>
          <p>Complete the notes below.</p>
          <p>
            Choose <strong>ONE WORD ONLY</strong> from the passage for each
            answer.
          </p>
          <div style="margin-left: 10px; line-height: 1.8; font-size: 14px">
            <strong>Woollen cloth manufacture</strong>
            <p>Growing importance of the cloth industry:</p>
            <ul>
              <li>
                16th century: skilled <b>6</b>
                <input type="text" name="q6" /> emigrated to England
                <span class="flag-btn" data-q="q6"></span>
              </li>
              <li>
                end 17th century: majority of English <b>7</b>
                <input type="text" name="q7" /> were wool products
                <span class="flag-btn" data-q="q7"></span>
              </li>
              <li>
                18th century: production of worsted cloth increased in Yorkshire
                ‚Äì growth of five key manufacturing <b>8</b>
                <input type="text" name="q8" />
                <span class="flag-btn" data-q="q8"></span>
              </li>
              <li>
                1750‚Äì1850: new machinery was developed ‚Äì initially for the
                production of <b>9</b> <input type="text" name="q9" />
                <span class="flag-btn" data-q="q9"></span>
              </li>
              <li>
                1812: protests resulted in the <b>10</b>
                <input type="text" name="q10" /> of machinery
                <span class="flag-btn" data-q="q10"></span>
              </li>
              <li>
                19th century: in Yorkshire mechanisation increased, aided by the
                availability of cheap <b>11</b>
                <input type="text" name="q11" />
                <span class="flag-btn" data-q="q11"></span>
              </li>
            </ul>
            <p>Growth of specialisation:</p>
            <ul>
              <li>
                Scotland ‚Äì specialised in <b>12</b>
                <input type="text" name="q12" />
                <span class="flag-btn" data-q="q12"></span>
              </li>
              <li>
                West Country ‚Äì specialised in <b>13</b>
                <input type="text" name="q13" />
                <span class="flag-btn" data-q="q13"></span>
              </li>
            </ul>
          </div>
        </div>
        <div class="bottom-bar">
          <button class="btn-primary" onclick="submitAnswers()">Êèê‰∫§</button>
          <button onclick="resetForm()">ÈáçÁΩÆ</button>
          <button onclick="openWrongBook()">Êú¨ÁØáÈîôÈ¢ò</button>
        </div>
      </section>
    </div>
    <div id="selbar">
      <button id="btnNote">Note</button>
      <button id="btnHL">Highlight</button>
      <button id="btnUH" style="display: none">Clear Highlight</button>
    </div>
    <div class="modal" id="resultModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>ÊàêÁª©</h2>
          <span class="modal-close" onclick="closeModal('resultModal')">√ó</span>
        </div>
        <div id="resultContent"></div>
        <button
          class="btn-primary"
          style="width: 100%; margin-top: 16px"
          onclick="addWrongToBook()"
        >
          Âä†ÂÖ•ÈîôÈ¢òÊú¨
        </button>
      </div>
    </div>
    <div class="modal" id="wrongBookModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Êú¨ÁØáÈîôÈ¢ò</h2>
          <span class="modal-close" onclick="closeModal('wrongBookModal')"
            >√ó</span
          >
        </div>
        <div id="wrongBookContent"></div>
      </div>
    </div>
    <div class="modal" id="resetModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>ÈáçÁΩÆÁªÉ‰π†</h2>
          <span class="modal-close" onclick="closeModal('resetModal')">√ó</span>
        </div>
        <div style="margin: 16px 0">
          <label style="display: block; margin-bottom: 10px"
            ><input type="radio" name="resetType" value="answers" checked />
            Âè™Ê∏ÖÁ©∫Á≠îÊ°à</label
          >
          <label style="display: block"
            ><input type="radio" name="resetType" value="all" />
            Ê∏ÖÁ©∫Á≠îÊ°àÂíåÊ†áËÆ∞</label
          >
        </div>
        <button
          class="btn-primary"
          style="width: 100%"
          onclick="confirmReset()"
        >
          Á°ÆÂÆö
        </button>
      </div>
    </div>
    <script>
      const PAPER_ID = "P1_BRITISH_WOOL";
      let t = 0;
      const timerEl = document.getElementById("timer");
      setInterval(() => {
        t++;
        timerEl.textContent =
          String(Math.floor(t / 60)).padStart(2, "0") +
          ":" +
          String(t % 60).padStart(2, "0");
      }, 1000);
      const divider = document.getElementById("divider"),
        left = document.getElementById("left"),
        right = document.getElementById("right");
      let dragging = false;
      divider.onmousedown = () => {
        dragging = true;
        document.body.style.cursor = "ew-resize";
      };
      window.onmousemove = (e) => {
        if (!dragging) return;
        const c = document.querySelector(".shell").getBoundingClientRect();
        let x = e.clientX - c.left;
        x = Math.max(280, Math.min(c.width - 280, x));
        left.style.flex = "0 0 " + x + "px";
        right.style.flex = "1 1 auto";
      };
      window.onmouseup = () => {
        dragging = false;
        document.body.style.cursor = "";
      };
      const selbar = document.getElementById("selbar"),
        btnHL = document.getElementById("btnHL"),
        btnUH = document.getElementById("btnUH"),
        btnNote = document.getElementById("btnNote");
      let lastRange = null,
        currentHlNode = null;
      function posSelbar(r) {
        selbar.style.display = "flex";
        const t = window.scrollY + r.top - selbar.offsetHeight - 8;
        const l =
          window.scrollX + r.left + r.width / 2 - selbar.offsetWidth / 2;
        selbar.style.top = (t > 0 ? t : window.scrollY + r.bottom + 8) + "px";
        selbar.style.left = Math.max(8, l) + "px";
      }
      function updSel() {
        const s = window.getSelection();
        if (!s || s.rangeCount === 0 || s.isCollapsed) {
          if (!currentHlNode) selbar.style.display = "none";
          return;
        }
        const r = s.getRangeAt(0);
        lastRange = r.cloneRange();
        currentHlNode = null;
        btnNote.style.display = "block";
        btnHL.style.display = "block";
        btnUH.style.display = "none";
        posSelbar(r.getBoundingClientRect());
      }
      left.onmouseup = updSel;
      right.onmouseup = updSel;
      document.onselectionchange = () => {
        const s = window.getSelection();
        if ((!s || s.rangeCount === 0 || s.isCollapsed) && !currentHlNode)
          selbar.style.display = "none";
      };
      document.addEventListener(
        "click",
        (e) => {
          if (
            e.target.classList &&
            (e.target.classList.contains("hl") ||
              e.target.classList.contains("note"))
          ) {
            currentHlNode = e.target;
            lastRange = null;
            btnNote.style.display = "none";
            btnHL.style.display = "none";
            btnUH.style.display = "block";
            posSelbar(e.target.getBoundingClientRect());
            const s = window.getSelection();
            if (s) s.removeAllRanges();
          }
        },
        true
      );
      btnHL.onclick = () => {
        if (currentHlNode || !lastRange || lastRange.collapsed) return;
        const s = document.createElement("span");
        s.className = "hl";
        try {
          lastRange.surroundContents(s);
        } catch (e) {
          const w = document.createElement("span");
          w.className = "hl";
          w.appendChild(lastRange.cloneContents());
          lastRange.deleteContents();
          lastRange.insertNode(w);
        }
        selbar.style.display = "none";
        saveHighlights();
      };
      btnNote.onclick = () => {
        if (currentHlNode || !lastRange || lastRange.collapsed) return;
        const s = document.createElement("span");
        s.className = "note";
        try {
          lastRange.surroundContents(s);
        } catch (e) {
          const w = document.createElement("span");
          w.className = "note";
          w.appendChild(lastRange.cloneContents());
          lastRange.deleteContents();
          lastRange.insertNode(w);
        }
        selbar.style.display = "none";
        saveHighlights();
      };
      btnUH.onclick = () => {
        if (currentHlNode) {
          const p = currentHlNode.parentNode;
          while (currentHlNode.firstChild)
            p.insertBefore(currentHlNode.firstChild, currentHlNode);
          p.removeChild(currentHlNode);
          p.normalize();
          currentHlNode = null;
          selbar.style.display = "none";
          saveHighlights();
        } else if (lastRange) {
          const sR = lastRange.getBoundingClientRect();
          const w = document.createTreeWalker(
            document.body,
            NodeFilter.SHOW_ELEMENT
          );
          const tr = [];
          while (w.nextNode()) {
            const n = w.currentNode;
            if (
              n.classList &&
              (n.classList.contains("hl") || n.classList.contains("note"))
            ) {
              const r = n.getBoundingClientRect();
              if (
                !(
                  r.right < sR.left ||
                  r.left > sR.right ||
                  r.bottom < sR.top ||
                  r.top > sR.bottom
                )
              )
                tr.push(n);
            }
          }
          tr.forEach((el) => {
            const p = el.parentNode;
            while (el.firstChild) p.insertBefore(el.firstChild, el);
            p.removeChild(el);
            p.normalize();
          });
          selbar.style.display = "none";
          saveHighlights();
        }
      };
      document.querySelectorAll(".flag-btn").forEach((btn) => {
        btn.onclick = (e) => {
          e.stopPropagation();
          btn.classList.toggle("active");
          saveFlags();
        };
      });
      const answerKey = {
        q1: "FALSE",
        q2: "TRUE",
        q3: "TRUE",
        q4: "FALSE",
        q5: "NOT GIVEN",
        q6: "weavers",
        q7: "exports",
        q8: "towns",
        q9: "cotton",
        q10: "destruction",
        q11: "coal",
        q12: "tweeds",
        q13: "carpets",
      };
      let lastResults = [];
      function saveAnswers() {
        const data = {};
        Object.keys(answerKey).forEach((q) => {
          const radio = document.querySelector(
            `input[name="${q}"][type="radio"]:checked`
          );
          const text = document.querySelector(
            `input[name="${q}"][type="text"]`
          );
          if (radio) data[q] = radio.value;
          else if (text) data[q] = text.value;
        });
        localStorage.setItem(`${PAPER_ID}_answers`, JSON.stringify(data));
      }
      function loadAnswers() {
        const data = JSON.parse(
          localStorage.getItem(`${PAPER_ID}_answers`) || "{}"
        );
        Object.keys(data).forEach((q) => {
          const radio = document.querySelector(
            `input[name="${q}"][value="${data[q]}"]`
          );
          const text = document.querySelector(
            `input[name="${q}"][type="text"]`
          );
          if (radio) radio.checked = true;
          else if (text) text.value = data[q];
        });
      }
      function saveFlags() {
        const flags = [...document.querySelectorAll(".flag-btn.active")].map(
          (b) => b.dataset.q
        );
        localStorage.setItem(`${PAPER_ID}_flags`, JSON.stringify(flags));
      }
      function loadFlags() {
        const flags = JSON.parse(
          localStorage.getItem(`${PAPER_ID}_flags`) || "[]"
        );
        flags.forEach((q) =>
          document.querySelector(`[data-q="${q}"]`)?.classList.add("active")
        );
      }
      function saveHighlights() {
        const highlights = { left: [], right: [] };
        document
          .querySelectorAll("#left .hl, #left .note")
          .forEach((el, idx) => {
            highlights.left.push({
              type: el.classList.contains("hl") ? "hl" : "note",
              text: el.textContent,
              index: idx,
            });
          });
        document
          .querySelectorAll("#right .hl, #right .note")
          .forEach((el, idx) => {
            highlights.right.push({
              type: el.classList.contains("hl") ? "hl" : "note",
              text: el.textContent,
              index: idx,
            });
          });
        localStorage.setItem(
          `${PAPER_ID}_highlights`,
          JSON.stringify(highlights)
        );
      }
      function loadHighlights() {
        const data = JSON.parse(
          localStorage.getItem(`${PAPER_ID}_highlights`) ||
            '{"left":[],"right":[]}'
        );
        const restore = (pane, items) => {
          if (!items || items.length === 0) return;
          items.forEach((item) => {
            const walker = document.createTreeWalker(
              pane,
              NodeFilter.SHOW_TEXT
            );
            let node;
            while ((node = walker.nextNode())) {
              if (node.textContent.includes(item.text)) {
                const span = document.createElement("span");
                span.className = item.type;
                const parent = node.parentNode;
                const text = node.textContent;
                const idx = text.indexOf(item.text);
                if (idx >= 0) {
                  const before = text.substring(0, idx);
                  const match = text.substring(idx, idx + item.text.length);
                  const after = text.substring(idx + item.text.length);
                  parent.insertBefore(document.createTextNode(before), node);
                  span.textContent = match;
                  parent.insertBefore(span, node);
                  parent.insertBefore(document.createTextNode(after), node);
                  parent.removeChild(node);
                  break;
                }
              }
            }
          });
        };
        restore(left, data.left);
        restore(right, data.right);
      }
      document.querySelectorAll("input").forEach((inp) => {
        inp.addEventListener("change", saveAnswers);
        if (inp.type === "text") inp.addEventListener("input", saveAnswers);
      });
      document.addEventListener("DOMContentLoaded", () => {
        loadAnswers();
        loadFlags();
        loadHighlights();
      });
      function submitAnswers() {
        const res = [];
        let cor = 0;
        Object.keys(answerKey).forEach((q) => {
          let uA = "";
          const radio = document.querySelector(
            `input[name="${q}"][type="radio"]:checked`
          );
          const text = document.querySelector(
            `input[name="${q}"][type="text"]`
          );
          if (radio) uA = radio.value;
          else if (text) uA = text.value.trim();
          const cA = answerKey[q];
          const iC = uA.toLowerCase() === cA.toLowerCase();
          if (iC) cor++;
          res.push({ id: q, userAns: uA, correctAns: cA, isCorrect: iC });
        });
        lastResults = res;
        const tot = Object.keys(answerKey).length;
        const pct = ((cor / tot) * 100).toFixed(1);
        localStorage.setItem(`ielts_score_${PAPER_ID}`, `${cor}/${tot}`);
        document.getElementById(
          "resultContent"
        ).innerHTML = `<div class="result-summary"><div class="result-score">${cor} / ${tot}</div><div style="margin-top:8px;font-size:18px;">${pct}%</div></div>${res
          .map(
            (r) =>
              `<div class="result-item ${
                r.isCorrect ? "correct" : "incorrect"
              }"><div><strong>${r.id}</strong> ${
                r.isCorrect ? "‚úì" : "‚úó"
              }</div><div>‰Ω†ÁöÑÁ≠îÊ°à: ${r.userAns || "(Êú™‰ΩúÁ≠î)"}</div>${
                !r.isCorrect ? `<div>Ê≠£Á°ÆÁ≠îÊ°à: ${r.correctAns}</div>` : ""
              }</div>`
          )
          .join("")}`;
        document.getElementById("resultModal").classList.add("active");
      }
      function resetForm() {
        document.getElementById("resetModal").classList.add("active");
      }
      function confirmReset() {
        const tp = document.querySelector(
          'input[name="resetType"]:checked'
        ).value;
        document.querySelectorAll("input").forEach((i) => {
          if (i.type === "radio") i.checked = false;
          if (i.type === "text") i.value = "";
        });
        localStorage.removeItem(`${PAPER_ID}_answers`);
        if (tp === "all") {
          document.querySelectorAll(".hl").forEach((el) => {
            const p = el.parentNode;
            while (el.firstChild) p.insertBefore(el.firstChild, el);
            p.removeChild(el);
            p.normalize();
          });
          document.querySelectorAll(".note").forEach((el) => {
            const p = el.parentNode;
            while (el.firstChild) p.insertBefore(el.firstChild, el);
            p.removeChild(el);
            p.normalize();
          });
          document
            .querySelectorAll(".flag-btn")
            .forEach((b) => b.classList.remove("active"));
          localStorage.removeItem(`${PAPER_ID}_highlights`);
          localStorage.removeItem(`${PAPER_ID}_flags`);
        }
        closeModal("resetModal");
      }
      function addWrongToBook() {
        const wb = JSON.parse(localStorage.getItem("ielts_wrong_book") || "[]");
        const wr = lastResults.filter((r) => !r.isCorrect);
        wr.forEach((r) => {
          const en = {
            paperId: PAPER_ID,
            title: "The history of the British wool industry",
            questionId: r.id,
            correctAnswer: r.correctAns,
            myAnswer: r.userAns || "(Êú™‰ΩúÁ≠î)",
            date: new Date().toISOString().split("T")[0],
          };
          const ix = wb.findIndex(
            (i) => i.paperId === en.paperId && i.questionId === en.questionId
          );
          if (ix >= 0) wb[ix] = en;
          else wb.push(en);
        });
        localStorage.setItem("ielts_wrong_book", JSON.stringify(wb));
        alert(`Â∑≤Ê∑ªÂä† ${wr.length} ÈÅìÈîôÈ¢ò`);
        closeModal("resultModal");
      }
      function deleteWrongItem(pId, qId) {
        if (!confirm("Á°ÆÂÆöÂà†Èô§ËøôÈÅìÈîôÈ¢òÔºü")) return;
        let wb = JSON.parse(localStorage.getItem("ielts_wrong_book") || "[]");
        wb = wb.filter((i) => !(i.paperId === pId && i.questionId === qId));
        localStorage.setItem("ielts_wrong_book", JSON.stringify(wb));
        openWrongBook();
      }
      function clearCurrentWrongBook() {
        if (!confirm("Á°ÆÂÆöÊ∏ÖÁ©∫Êú¨ÁØáÊâÄÊúâÈîôÈ¢òÔºü")) return;
        let wb = JSON.parse(localStorage.getItem("ielts_wrong_book") || "[]");
        wb = wb.filter((i) => i.paperId !== PAPER_ID);
        localStorage.setItem("ielts_wrong_book", JSON.stringify(wb));
        openWrongBook();
      }
      function openWrongBook() {
        const wb = JSON.parse(localStorage.getItem("ielts_wrong_book") || "[]");
        const cu = wb.filter((i) => i.paperId === PAPER_ID);
        const ct = document.getElementById("wrongBookContent");
        if (cu.length === 0)
          ct.innerHTML =
            '<div style="text-align:center;padding:40px;color:#666;">ÊöÇÊó†ÈîôÈ¢ò</div>';
        else
          ct.innerHTML = `<div class="modal-actions"><button class="btn-danger" onclick="clearCurrentWrongBook()" stylewidth:100%;">üóëÔ∏è Ê∏ÖÁ©∫Êú¨ÁØáÈîôÈ¢ò</button></div>${cu
            .map(
              (i) =>
                `<div class="wrong-item"><div class="wrong-item-content"><div style="font-weight:600;margin-bottom:8px;">${i.questionId}</div><div style="font-size:13px;color:#666;"><div>‚úì Ê≠£Á°Æ: ${i.correctAnswer}</div><div style="color:#d32f2f;">‚úó ÊàëÁöÑ: ${i.myAnswer}</div></div></div><button class="btn-delete" onclick="deleteWrongItem('${i.paperId}','${i.questionId}')">Âà†Èô§</button></div>`
            )
            .join("")}`;
        document.getElementById("wrongBookModal").classList.add("active");
      }
      function closeModal(id) {
        document.getElementById(id).classList.remove("active");
      }
    </script>
  </body>
</html>

