<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>P1 ‚Äì Dyes and fabric dyeing</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  * { box-sizing: border-box; margin:0; padding:0; }
  html,body { height:100%; }
  body { font-family: Arial, sans-serif; background:#f5f5f5; }
  
  #timer { position:fixed; top:12px; right:12px; background:#fff; border:1px solid #ddd; border-radius:6px; padding:8px 12px; font-size:16px; font-weight:600; color:#0066cc; z-index:1000; }
  
  .shell { display:flex; height:100vh; width:100%; }
  .pane { background:#fff; overflow:auto; padding:24px; }
  #left { flex: 0 0 50%; border-right:1px solid #ddd; }
  #right { flex: 1 1 auto; background:#fafafa; }
  #divider { flex: 0 0 5px; background:#ddd; cursor: ew-resize; }
  #divider:hover { background:#999; }
  
  h2,h3,h4 { margin:0 0 12px; color:#333; }
  h2 { font-size:20px; }
  h3 { font-size:18px; color:#0066cc; }
  h4 { font-size:15px; font-weight:600; margin-top:20px; }
  
  #left p { margin: 0 0 14px; line-height: 1.7; text-align:justify; }
  
  .group { background:#fff; border:1px solid #ddd; border-radius:6px; padding:16px; margin-bottom:16px; }
  .group h4 { margin-top:0; color:#0066cc; }
  .group p { margin:8px 0; font-size:14px; line-height:1.6; }
  
  .flag-btn { 
    position:absolute; 
    left:2px; 
    top:50%;
    transform:translateY(-50%);
    width:8px;
    height:8px;
    border-radius:50%;
    background:#ddd;
    cursor:pointer;
    z-index:10;
  }
  .flag-btn:hover { background:#999; }
  .flag-btn.active { background:#ff5722; }
  
  .group ol { margin-left:20px; }
  .group ol li { margin:12px 0; font-size:14px; line-height:1.6; position:relative; }
  .group ol li label { display:inline-block; margin-right:8px; }
  
  input[type="text"] {
    border: 1px solid #ccc;
    border-radius: 4px;
    padding: 4px 8px;
    font-size: 14px;
    width: 160px;
    background: #fdfdfd;
  }
  input[type="text"]:focus {
    border-color: #0066cc;
    outline: none;
    background: #fff;
  }
  
  .bottom-bar { display:flex; gap:10px; margin-top:16px; }
  button { padding:10px 20px; border:1px solid #999; border-radius:6px; background:#fff; cursor:pointer; font-size:14px; }
  button:hover { background:#f0f0f0; }
  .btn-primary { background:#0066cc; color:#fff; border-color:#0066cc; }
  .btn-primary:hover { background:#0052a3; }
  .btn-danger { background:#dc3545; color:#fff; border-color:#dc3545; }
  .btn-danger:hover { background:#c82333; }
  
  .hl { background:#fff59d; cursor:pointer; }
  .hl:hover { background:#ffeb3b; }
  .note { background:#b3d9ff; cursor:pointer; }
  .note:hover { background:#99ccff; }
  
  #selbar { position:fixed; display:none; z-index:2000; background:#fff; border:1px solid #ddd; border-radius:8px; padding:8px; gap:0; box-shadow:0 2px 8px rgba(0,0,0,0.15); flex-direction:column; min-width:120px; }
  #selbar button { background:#fff; color:#666; border:none; padding:3px 0px; cursor:pointer; font-size:14px; text-align:center; border-radius:4px; }
  #selbar button:hover { background:#f5f5f5; color:#333; }
  
  .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:3000; align-items:center; justify-content:center; }
  .modal.active { display:flex; }
  .modal-content { background:#fff; border-radius:8px; padding:24px; max-width:600px; width:90%; max-height:80vh; overflow-y:auto; }
  
  .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
  .modal-header h2 { font-size: 28px; color: #333; margin: 0; }
  .modal-close { font-size: 32px; cursor: pointer; color: #999; line-height: 1; }
  .modal-close:hover { color: #333; }
  
  .result-summary { text-align:center; padding:20px; background:#f0f0f0; margin-bottom:16px; border-radius:6px; }
  .result-score { font-size:36px; font-weight:600; color:#0066cc; }
  .result-item { padding:10px; margin:8px 0; border-left:3px solid #ddd; background:#f9f9f9; font-size:13px; }
  .result-item.correct { border-left-color:#28a745; background:#e8f5e9; }
  .result-item.incorrect { border-left-color:#dc3545; background:#ffebee; }
  
  .wrong-item { background:#fff3e0; padding:16px; margin:8px 0; border-radius:8px; border-left:4px solid #ff9800; display:flex; justify-content:space-between; align-items:start; }
  .wrong-item-content { flex:1; }
  .btn-delete { background:#dc3545; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-size:13px; margin-left:12px; }
  .btn-delete:hover { background:#c82333; }
  .modal-actions { display:flex; gap:10px; margin-bottom:20px; }
</style>
</head>
<body>
<div id="timer">00:00</div>

<div class="shell">
  <section class="pane" id="left">
    
<h2>READING PASSAGE 1</h2>
<p>You should spend about 20 minutes on Questions 1‚Äì13, which are based on Reading Passage 1 below.</p>
<h3>Dyes and fabric dyeing</h3>

<p>When primitive people began using their hands to be creative, they began to add color to their lives. They used natural materials like ochre to stain animal hides, decorate shells and feathers, and paint on the walls of caves. Ochre is a naturally occurring brownish-yellow earth containing iron oxide. Scientists have been able to date the black, white, yellow and reddish pigments made from ochre, used in cave paintings, to over 15,000 BCE. With the development of fixed settlements and agriculture, around 7,000 to 2,000 BCE, people began to produce fabrics, and used natural substances such as ochre to color them.</p>

<p>Natural dyes, or dyes made from substances found in nature, can be broken down into two categories: substantive and adjective. Substantive, or direct dyes, become fixed to fibers without the aid of any other chemicals or additives. Adjective dyes require a mordant (usually a metal salt), which acts as a fixative and prevents the color from washing out or being bleached by sunlight. Most natural dyes are adjective dyes, and require the application of a mordant solution to the fibers at some point in the dyeing process.</p>

<p>Historically, three natural fibers were used in making fabrics: wool, silk and cotton. Wool fabric remains have been found in Europe dating back to 2,000 BCE. It was a common medieval fabric worn in both dyed and natural colors and was processed by both professional manufacturers and by people in their own homes. Silk was imported from China to Europe, and in the 14th to 16th centuries major silk manufacturing centers were set up in France, Spain and Italy. These silk production centers also became centers of dye technology, as most silk was dyed and required the highest quality dyes available. Cotton was considered a luxury fabric in Europe, as it was imported all the way from India and was dyed before it was shipped. Cotton was also valued because of the brightness and colorfastness of the dyes used to color it.</p>

<p>Dyes that gave fabrics a good bright color and were able to withstand washing and exposure to sunlight without losing their color were highly prized. The names of some of these valued and traded colors are still familiar today. The color known as Tyrian purple, for example, originated in the Mediterranean 2,000 years ago, and cochineal is the name given to the red dye from Latin America. Both of these colors came from animals; the mucus found in certain species of shellfish produced the deep, rich Tyrian purple and cochineal was extracted from insects. Two other natural sources of color were saffron and indigo. Saffron, the base of yellow dyes, comes from the flowers of a particular kind of crocus which is thought to have first been cultivated on Crete in the eastern Mediterranean. The leaves of a plant native to India were used to produce indigo, which was the main source of the color blue.</p>

<p>As societies developed over the centuries, the demand for dyes and dyed fabric grew, and by the 17th century a worldwide shipping and trading network was in place, allowing dyestuffs from all parts of the world to be brought to Europe. This meant that numerous dyestuffs could be blended to create a variety of colors for the rich and powerful. Fiber dyeing in the lower classes was a bit more restrictive. Without the money to buy exotic imported dyes, clothing in the countryside tended to be black, brown, grey and tan. Country people had some resources they could use to get a wider range of colors. They had always used local plants as food, and many of these plants were also used as medicines and in some cases as sources of dyes. Home dyers used any plants they could find that would give a good color. People who picked blackberries to make jam soon recognized this wild fruit as a source for a blue dye. Washing beehives in preparation for making mead (a popular drink containing honey) yielded a liquid that could be used as a yellow dye. The mosses which grow in many parts of Europe were used to produce green dye.</p>

<p>With the tremendous rise of interest in chemistry in the mid-19th century, several important innovations in dyeing came about. W. H. Perkin, a student of celebrated European scientist Wilhelm von Hofmann, accidentally discovered the first synthetic dye, later called mauve. The color was so popular that Perkin was able to open a factory of his own and went on to develop more synthetic dye colors. Synthetic dye production grew in Europe, and hardly a year passed until the end of the century without a new synthetic dye being patented.</p>

<p>Eventually, the old natural dyes lost popularity in favor of the newer synthetic ones, and now the use of natural dyes on a commercial scale only exists in a few remote areas where people have either little access to synthetic dyes or a vested interest in retaining their ancient dyeing customs.</p>

  </section>

  <div id="divider" title="Drag to resize"></div>

  <section class="pane" id="right">
    <h3>Questions</h3>

    <div class="group">
      <h4>Questions 1‚Äì8</h4>
      <p>Do the following statements agree with the information given in Reading Passage 1?</p>
      <p>In boxes <strong>1‚Äì8</strong> on your answer sheet, write</p>
      <div style="margin-left:20px; margin-top:8px;">
        <div><strong>TRUE</strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if the statement agrees with the information</div>
        <div><strong>FALSE</strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if the statement contradicts the information</div>
        <div><strong>NOT GIVEN</strong>&nbsp;&nbsp;if there is no information on this</div>
      </div>

      <ol start="1">
        <li><span class="flag-btn" data-q="q1" style="left:-20px;"></span>Ochre was used in paintings before it was used in fabric dyes.<br>
          <label><input type="radio" name="q1" value="TRUE"> TRUE</label>
          <label><input type="radio" name="q1" value="FALSE"> FALSE</label>
          <label><input type="radio" name="q1" value="NOT GIVEN"> NOT GIVEN</label>
        </li>
        <li><span class="flag-btn" data-q="q2" style="left:-20px;"></span>Natural dyes that need a mordant are rare.<br>
          <label><input type="radio" name="q2" value="TRUE"> TRUE</label>
          <label><input type="radio" name="q2" value="FALSE"> FALSE</label>
          <label><input type="radio" name="q2" value="NOT GIVEN"> NOT GIVEN</label>
        </li>
        <li><span class="flag-btn" data-q="q3" style="left:-20px;"></span>In medieval times people sometimes wore fabric made of undyed wool.<br>
          <label><input type="radio" name="q3" value="TRUE"> TRUE</label>
          <label><input type="radio" name="q3" value="FALSE"> FALSE</label>
          <label><input type="radio" name="q3" value="NOT GIVEN"> NOT GIVEN</label>
        </li>
        <li><span class="flag-btn" data-q="q4" style="left:-20px;"></span>Silk has always been more expensive than cotton and wool.<br>
          <label><input type="radio" name="q4" value="TRUE"> TRUE</label>
          <label><input type="radio" name="q4" value="FALSE"> FALSE</label>
          <label><input type="radio" name="q4" value="NOT GIVEN"> NOT GIVEN</label>
        </li>
        <li><span class="flag-btn" data-q="q5" style="left:-20px;"></span>Cotton imported from India was dyed upon arrival in Europe.<br>
          <label><input type="radio" name="q5" value="TRUE"> TRUE</label>
          <label><input type="radio" name="q5" value="FALSE"> FALSE</label>
          <label><input type="radio" name="q5" value="NOT GIVEN"> NOT GIVEN</label>
        </li>
        <li><span class="flag-btn" data-q="q6" style="left:-20px;"></span>Perkin became more famous than his teacher, von Hofmann.<br>
          <label><input type="radio" name="q6" value="TRUE"> TRUE</label>
          <label><input type="radio" name="q6" value="FALSE"> FALSE</label>
          <label><input type="radio" name="q6" value="NOT GIVEN"> NOT GIVEN</label>
        </li>
        <li><span class="flag-btn" data-q="q7" style="left:-20px;"></span>Very few synthetic dyes were produced in Europe in the second half of the 19th century.<br>
          <label><input type="radio" name="q7" value="TRUE"> TRUE</label>
          <label><input type="radio" name="q7" value="FALSE"> FALSE</label>
          <label><input type="radio" name="q7" value="NOT GIVEN"> NOT GIVEN</label>
        </li>
        <li><span class="flag-btn" data-q="q8" style="left:-20px;"></span>Today the commercial production of natural dyes is limited to a small number of isolated communities.<br>
          <label><input type="radio" name="q8" value="TRUE"> TRUE</label>
          <label><input type="radio" name="q8" value="FALSE"> FALSE</label>
          <label><input type="radio" name="q8" value="NOT GIVEN"> NOT GIVEN</label>
        </li>
      </ol>
    </div>

    <div class="group">
      <h4>Questions 9‚Äì13</h4>
      <p>Complete the notes below.</p>
      <p>Choose <strong>ONE WORD ONLY</strong> from the passage for each answer.</p>
      <p>Write your answers in boxes <strong>9‚Äì13</strong> on your answer sheet.</p>

      <div style="margin-left:10px; line-height:1.8; font-size:14px;">
        <h4 style="text-align:center;">The history of some dyes</h4>
        <strong>Highly valued dyes</strong>
        <ul>
            <li>Tyrian purple
                <ul>
                    <li>mucus from <b>9</b> <input type="text" name="q9"> found in the Mediterranean <span class="flag-btn" data-q="q9" style="left:inherit; position:relative; margin-right:5px; vertical-align:middle; width:8px; height:8px;"></span></li>
                </ul>
            </li>
            <li>cochineal (a red dye)
                <ul>
                    <li>made from <b>10</b> <input type="text" name="q10"> found in Latin America <span class="flag-btn" data-q="q10" style="left:inherit; position:relative; margin-right:5px; vertical-align:middle; width:8px; height:8px;"></span></li>
                </ul>
            </li>
            <li>saffron (a yellow dye)
                <ul>
                    <li>initially made from crocuses found on the island of Crete</li>
                </ul>
            </li>
            <li>indigo (a blue dye)
                <ul>
                    <li>made from plant leaves from India</li>
                </ul>
            </li>
        </ul>
        <br>
        <strong>17th-century Europe</strong>
        <p>dyes made by country people:</p>
        <ul>
            <li><b>11</b> <input type="text" name="q11"> had two uses <span class="flag-btn" data-q="q11" style="left:inherit; position:relative; margin-right:5px; vertical-align:middle; width:8px; height:8px;"></span>
                <ul>
                    <li>jam</li>
                    <li>blue dye</li>
                </ul>
            </li>
            <li>liquid from cleaning <b>12</b> <input type="text" name="q12"> had two uses <span class="flag-btn" data-q="q12" style="left:inherit; position:relative; margin-right:5px; vertical-align:middle; width:8px; height:8px;"></span>
                <ul>
                    <li>making mead</li>
                    <li>yellow dye</li>
                </ul>
            </li>
        </ul>
        <br>
        <strong>19th-century Europe</strong>
        <ul>
            <li>progress in study of <b>13</b> <input type="text" name="q13"> led to synthetic dyes <span class="flag-btn" data-q="q13" style="left:inherit; position:relative; margin-right:5px; vertical-align:middle; width:8px; height:8px;"></span></li>
        </ul>
      </div>
    </div>

    <div class="bottom-bar">
      <button class="btn-primary" onclick="submitAnswers()">Êèê‰∫§</button>
      <button onclick="resetForm()">ÈáçÁΩÆ</button>
      <button onclick="openWrongBook()">Êú¨ÁØáÈîôÈ¢ò</button>
    </div>
  </section>
</div>

<div id="selbar">
  <button id="btnNote">Note</button>
  <button id="btnHL">Highlight</button>
  <button id="btnUH" style="display:none;">Clear Highlight</button>
</div>

<div class="modal" id="resultModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ÊàêÁª©</h2>
      <span class="modal-close" onclick="closeModal('resultModal')">√ó</span>
    </div>
    <div id="resultContent"></div>
    <button class="btn-primary" style="width:100%; margin-top:16px;" onclick="addWrongToBook()">Âä†ÂÖ•ÈîôÈ¢òÊú¨</button>
  </div>
</div>

<div class="modal" id="wrongBookModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Êú¨ÁØáÈîôÈ¢ò</h2>
      <span class="modal-close" onclick="closeModal('wrongBookModal')">√ó</span>
    </div>
    <div id="wrongBookContent"></div>
  </div>
</div>

<div class="modal" id="resetModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ÈáçÁΩÆÁªÉ‰π†</h2>
      <span class="modal-close" onclick="closeModal('resetModal')">√ó</span>
    </div>
    <div style="margin:16px 0;">
      <label style="display:block; margin-bottom:10px;">
        <input type="radio" name="resetType" value="answers" checked>
        Âè™Ê∏ÖÁ©∫Á≠îÊ°à
      </label>
      <label style="display:block;">
        <input type="radio" name="resetType" value="all">
        Ê∏ÖÁ©∫Á≠îÊ°àÂíåÊ†áËÆ∞
      </label>
    </div>
    <button class="btn-primary" style="width:100%;" onclick="confirmReset()">Á°ÆÂÆö</button>
  </div>
</div>

<script>
const PAPER_ID='P1_DYES';

let t=0;
const timerEl=document.getElementById('timer');
setInterval(()=>{ t++; timerEl.textContent=String(Math.floor(t/60)).padStart(2,'0')+':'+String(t%60).padStart(2,'0'); }, 1000);

const divider=document.getElementById('divider'), left=document.getElementById('left'), right=document.getElementById('right');
let dragging=false;
divider.onmousedown=()=>{ dragging=true; document.body.style.cursor='ew-resize'; };
window.onmousemove=(e)=>{ if(!dragging)return; const c=document.querySelector('.shell').getBoundingClientRect(); let x=e.clientX-c.left; x=Math.max(280,Math.min(c.width-280,x)); left.style.flex='0 0 '+x+'px'; right.style.flex='1 1 auto'; };
window.onmouseup=()=>{ dragging=false; document.body.style.cursor=''; };

const selbar=document.getElementById('selbar'), btnHL=document.getElementById('btnHL'), btnUH=document.getElementById('btnUH'), btnNote=document.getElementById('btnNote');
let lastRange=null, currentHlNode=null;

function posSelbar(r){ selbar.style.display='flex'; const t=window.scrollY+r.top-selbar.offsetHeight-8; const l=window.scrollX+r.left+r.width/2-selbar.offsetWidth/2; selbar.style.top=((t>0)?t:(window.scrollY+r.bottom+8))+'px'; selbar.style.left=Math.max(8,l)+'px'; }

function updSel(){ const s=window.getSelection(); if(!s||s.rangeCount===0||s.isCollapsed){ if(!currentHlNode)selbar.style.display='none'; return; } const r=s.getRangeAt(0); lastRange=r.cloneRange(); currentHlNode=null; btnNote.style.display='block'; btnHL.style.display='block'; btnUH.style.display='none'; posSelbar(r.getBoundingClientRect()); }

left.onmouseup=updSel; right.onmouseup=updSel;
document.onselectionchange=()=>{ const s=window.getSelection(); if((!s||s.rangeCount===0||s.isCollapsed)&&!currentHlNode)selbar.style.display='none'; };
document.addEventListener('click',(e)=>{ if(e.target.classList&&(e.target.classList.contains('hl')||e.target.classList.contains('note'))){ currentHlNode=e.target; lastRange=null; btnNote.style.display='none'; btnHL.style.display='none'; btnUH.style.display='block'; posSelbar(e.target.getBoundingClientRect()); const s=window.getSelection(); if(s)s.removeAllRanges(); }}, true);

btnHL.onclick=()=>{ if(currentHlNode||!lastRange||lastRange.collapsed)return; const s=document.createElement('span'); s.className='hl'; try{ lastRange.surroundContents(s); }catch(e){ const w=document.createElement('span'); w.className='hl'; w.appendChild(lastRange.cloneContents()); lastRange.deleteContents(); lastRange.insertNode(w); } selbar.style.display='none'; saveHighlights(); };

btnNote.onclick=()=>{ if(currentHlNode||!lastRange||lastRange.collapsed)return; const s=document.createElement('span'); s.className='note'; try{ lastRange.surroundContents(s); }catch(e){ const w=document.createElement('span'); w.className='note'; w.appendChild(lastRange.cloneContents()); lastRange.deleteContents(); lastRange.insertNode(w); } selbar.style.display='none'; saveHighlights(); };

btnUH.onclick=()=>{ if(currentHlNode){ const p=currentHlNode.parentNode; while(currentHlNode.firstChild)p.insertBefore(currentHlNode.firstChild,currentHlNode); p.removeChild(currentHlNode); p.normalize(); currentHlNode=null; selbar.style.display='none'; saveHighlights(); }else if(lastRange){ const sR=lastRange.getBoundingClientRect(); const w=document.createTreeWalker(document.body,NodeFilter.SHOW_ELEMENT); const tr=[]; while(w.nextNode()){ const n=w.currentNode; if(n.classList&&(n.classList.contains('hl')||n.classList.contains('note'))){ const r=n.getBoundingClientRect(); if(!(r.right<sR.left||r.left>sR.right||r.bottom<sR.top||r.top>sR.bottom))tr.push(n); }} tr.forEach(el=>{ const p=el.parentNode; while(el.firstChild)p.insertBefore(el.firstChild,el); p.removeChild(el); p.normalize(); }); selbar.style.display='none'; saveHighlights(); }};

document.querySelectorAll('.flag-btn').forEach(btn => {
  btn.onclick = e => {
    e.stopPropagation();
    btn.classList.toggle('active');
    saveFlags();
  };
});

const answerKey = {
  q1: "TRUE",
  q2: "FALSE",
  q3: "TRUE",
  q4: "NOT GIVEN",
  q5: "FALSE",
  q6: "NOT GIVEN",
  q7: "FALSE",
  q8: "TRUE",
  q9: "shellfish",
  q10: "insects",
  q11: "blackberries",
  q12: "beehives",
  q13: "chemistry"
};

let lastResults=[];

function saveAnswers() {
  const data = {};
  Object.keys(answerKey).forEach(q => {
    const radio = document.querySelector(`input[name="${q}"][type="radio"]:checked`);
    const text = document.querySelector(`input[name="${q}"][type="text"]`);
    if(radio) data[q] = radio.value;
    else if(text) data[q] = text.value;
  });
  localStorage.setItem(`${PAPER_ID}_answers`, JSON.stringify(data));
}

function loadAnswers() {
  const data = JSON.parse(localStorage.getItem(`${PAPER_ID}_answers`) || '{}');
  Object.keys(data).forEach(q => {
    const radio = document.querySelector(`input[name="${q}"][value="${data[q]}"]`);
    const text = document.querySelector(`input[name="${q}"][type="text"]`);
    if(radio) radio.checked = true;
    else if(text) text.value = data[q];
  });
}

function saveFlags() {
  const flags = [...document.querySelectorAll('.flag-btn.active')].map(b => b.dataset.q);
  localStorage.setItem(`${PAPER_ID}_flags`, JSON.stringify(flags));
}

function loadFlags() {
  const flags = JSON.parse(localStorage.getItem(`${PAPER_ID}_flags`) || '[]');
  flags.forEach(q => document.querySelector(`[data-q="${q}"]`)?.classList.add('active'));
}

function saveHighlights() {
  const highlights = { left: [], right: [] };
  document.querySelectorAll('#left .hl, #left .note').forEach((el, idx) => {
    highlights.left.push({
      type: el.classList.contains('hl') ? 'hl' : 'note',
      text: el.textContent,
      index: idx
    });
  });
  document.querySelectorAll('#right .hl, #right .note').forEach((el, idx) => {
    highlights.right.push({
      type: el.classList.contains('hl') ? 'hl' : 'note',
      text: el.textContent,
      index: idx
    });
  });
  localStorage.setItem(`${PAPER_ID}_highlights`, JSON.stringify(highlights));
}

function loadHighlights() {
  const data = JSON.parse(localStorage.getItem(`${PAPER_ID}_highlights`) || '{"left":[],"right":[]}');
  
  const restore = (pane, items) => {
    if(!items || items.length === 0) return;
    items.forEach(item => {
      const walker = document.createTreeWalker(pane, NodeFilter.SHOW_TEXT);
      let node;
      while(node = walker.nextNode()) {
        if(node.textContent.includes(item.text)) {
          const span = document.createElement('span');
          span.className = item.type;
          const parent = node.parentNode;
          const text = node.textContent;
          const idx = text.indexOf(item.text);
          if(idx >= 0) {
            const before = text.substring(0, idx);
            const match = text.substring(idx, idx + item.text.length);
            const after = text.substring(idx + item.text.length);
            parent.insertBefore(document.createTextNode(before), node);
            span.textContent = match;
            parent.insertBefore(span, node);
            parent.insertBefore(document.createTextNode(after), node);
            parent.removeChild(node);
            break;
          }
        }
      }
    });
  };
  restore(left, data.left);
  restore(right, data.right);
}

document.querySelectorAll('input').forEach(inp => {
  inp.addEventListener('change', saveAnswers);
  if(inp.type==='text') inp.addEventListener('input', saveAnswers);
});

document.addEventListener('DOMContentLoaded', () => {
  loadAnswers();
  loadFlags();
  loadHighlights();
});

function submitAnswers(){ 
  const res=[]; let cor=0; 
  Object.keys(answerKey).forEach(q=>{ 
    let uA = "";
    const radio = document.querySelector(`input[name="${q}"][type="radio"]:checked`);
    const text = document.querySelector(`input[name="${q}"][type="text"]`);
    if(radio) uA = radio.value;
    else if(text) uA = text.value.trim();
    
    const cA=answerKey[q]; 
    const iC = uA.toLowerCase() === cA.toLowerCase(); 
    if(iC) cor++; 
    res.push({id:q,userAns:uA,correctAns:cA,isCorrect:iC}); 
  }); 
  lastResults=res; 
  const tot=Object.keys(answerKey).length; 
  const pct=((cor/tot)*100).toFixed(1); 
  localStorage.setItem(`ielts_score_${PAPER_ID}`, `${cor}/${tot}`);
  document.getElementById('resultContent').innerHTML=`<div class="result-summary"><div class="result-score">${cor} / ${tot}</div><div style="margin-top:8px;font-size:18px;">${pct}%</div></div>${res.map(r=>`<div class="result-item ${r.isCorrect?'correct':'incorrect'}"><div><strong>${r.id}</strong> ${r.isCorrect?'‚úì':'‚úó'}</div><div>‰Ω†ÁöÑÁ≠îÊ°à: ${r.userAns||'(Êú™‰ΩúÁ≠î)'}</div>${!r.isCorrect?`<div>Ê≠£Á°ÆÁ≠îÊ°à: ${r.correctAns}</div>`:''}</div>`).join('')}`; 
  document.getElementById('resultModal').classList.add('active'); 
}

function resetForm(){ document.getElementById('resetModal').classList.add('active'); }

function confirmReset(){ 
  const tp=document.querySelector('input[name="resetType"]:checked').value; 
  document.querySelectorAll('input').forEach(i=>{
    if(i.type==='radio') i.checked=false;
    if(i.type==='text') i.value='';
  }); 
  localStorage.removeItem(`${PAPER_ID}_answers`);
  
  if(tp==='all'){ 
    document.querySelectorAll('.hl').forEach(el=>{ const p=el.parentNode; while(el.firstChild)p.insertBefore(el.firstChild,el); p.removeChild(el); p.normalize(); }); 
    document.querySelectorAll('.note').forEach(el=>{ const p=el.parentNode; while(el.firstChild)p.insertBefore(el.firstChild,el); p.removeChild(el); p.normalize(); }); 
    document.querySelectorAll('.flag-btn').forEach(b => b.classList.remove('active'));
    localStorage.removeItem(`${PAPER_ID}_highlights`);
    localStorage.removeItem(`${PAPER_ID}_flags`);
  } 
  closeModal('resetModal'); 
}

function addWrongToBook(){ const wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); const wr=lastResults.filter(r=>!r.isCorrect); wr.forEach(r=>{ const en={paperId:PAPER_ID,title:'Dyes and fabric dyeing',questionId:r.id,correctAnswer:r.correctAns,myAnswer:r.userAns||'(Êú™‰ΩúÁ≠î)',date:new Date().toISOString().split('T')[0]}; const ix=wb.findIndex(i=>i.paperId===en.paperId&&i.questionId===en.questionId); if(ix>=0)wb[ix]=en; else wb.push(en); }); localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); alert(`Â∑≤Ê∑ªÂä† ${wr.length} ÈÅìÈîôÈ¢ò`); closeModal('resultModal'); }

function deleteWrongItem(pId,qId){ if(!confirm('Á°ÆÂÆöÂà†Èô§ËøôÈÅìÈîôÈ¢òÔºü'))return; let wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); wb=wb.filter(i=>!(i.paperId===pId&&i.questionId===qId)); localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); openWrongBook(); }

function clearCurrentWrongBook(){ if(!confirm('Á°ÆÂÆöÊ∏ÖÁ©∫Êú¨ÁØáÊâÄÊúâÈîôÈ¢òÔºü'))return; let wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); wb=wb.filter(i=>i.paperId!==PAPER_ID); localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); openWrongBook(); }

function openWrongBook(){ const wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); const cu=wb.filter(i=>i.paperId===PAPER_ID); const ct=document.getElementById('wrongBookContent'); if(cu.length===0)ct.innerHTML='<div style="text-align:center;padding:40px;color:#666;">ÊöÇÊó†ÈîôÈ¢ò</div>'; else ct.innerHTML=`<div class="modal-actions"><button class="btn-danger" onclick="clearCurrentWrongBook()" stylewidth:100%;">üóëÔ∏è Ê∏ÖÁ©∫Êú¨ÁØáÈîôÈ¢ò</button></div>${cu.map(i=>`<div class="wrong-item"><div class="wrong-item-content"><div style="font-weight:600;margin-bottom:8px;">${i.questionId}</div><div style="font-size:13px;color:#666;"><div>‚úì Ê≠£Á°Æ: ${i.correctAnswer}</div><div style="color:#d32f2f;">‚úó ÊàëÁöÑ: ${i.myAnswer}</div></div></div><button class="btn-delete" onclick="deleteWrongItem('${i.paperId}','${i.questionId}')">Âà†Èô§</button></div>`).join('')}`; document.getElementById('wrongBookModal').classList.add('active'); }

function closeModal(id){ document.getElementById(id).classList.remove('active'); }
</script>
</body>
</html>