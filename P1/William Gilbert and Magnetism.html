<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>P1 ‚Äì William Gilbert and Magnetism</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  * { box-sizing: border-box; margin:0; padding:0; }
  html,body { height:100%; }
  body { font-family: Arial, sans-serif; background:#f5f5f5; }
  
  #timer { position:fixed; top:12px; right:12px; background:#fff; border:1px solid #ddd; border-radius:6px; padding:8px 12px; font-size:16px; font-weight:600; color:#0066cc; z-index:1000; }
  
  .shell { display:flex; height:100vh; width:100%; }
  .pane { background:#fff; overflow:auto; padding:24px; }
  #left { flex: 0 0 50%; border-right:1px solid #ddd; }
  #right { flex: 1 1 auto; background:#fafafa; }
  #divider { flex: 0 0 5px; background:#ddd; cursor: ew-resize; }
  #divider:hover { background:#999; }
  
  h2,h3,h4 { margin:0 0 12px; color:#333; }
  h2 { font-size:20px; }
  h3 { font-size:18px; color:#0066cc; }
  h4 { font-size:15px; font-weight:600; margin-top:20px; }
  
  #left p { margin: 0 0 14px; line-height: 1.7; text-align:justify; }
  
  .group { background:#fff; border:1px solid #ddd; border-radius:6px; padding:16px; margin-bottom:16px; }
  .group h4 { margin-top:0; color:#0066cc; }
  .group p { margin:8px 0; font-size:14px; line-height:1.6; }
  
  .headings { background:#f9f9f9; padding:12px; margin:12px 0; border-radius:4px; }
  .headings ol { margin-left:20px; }
  .headings li { margin:4px 0; font-size:13px; }
  
  table { border-collapse: collapse; width:100%; margin:12px 0; }
  th, td { border:1px solid #ddd; padding:6px; text-align:center; font-size:13px; position:relative; }
  th { background:#f5f5f5; font-weight:600; }
  
  /* Flag Ê†∑Âºè */
  .flag-btn { 
    position:absolute; 
    left:2px; 
    top:50%;
    transform:translateY(-50%);
    width:8px;
    height:8px;
    border-radius:50%;
    background:#ddd;
    cursor:pointer;
    z-index:10;
  }
  .flag-btn:hover { background:#999; }
  .flag-btn.active { background:#ff5722; }
  
  tr td:first-child { padding-left:16px; }
  
  .group ol { margin-left:20px; }
  .group ol li { margin:12px 0; font-size:14px; line-height:1.6; }
  .group ol li label { display:inline-block; margin-right:8px; }
  
  .bottom-bar { display:flex; gap:10px; margin-top:16px; }
  button { padding:10px 20px; border:1px solid #999; border-radius:6px; background:#fff; cursor:pointer; font-size:14px; }
  button:hover { background:#f0f0f0; }
  .btn-primary { background:#0066cc; color:#fff; border-color:#0066cc; }
  .btn-primary:hover { background:#0052a3; }
  .btn-danger { background:#dc3545; color:#fff; border-color:#dc3545; }
  .btn-danger:hover { background:#c82333; }
  
  .hl { background:#fff59d; cursor:pointer; }
  .hl:hover { background:#ffeb3b; }
  .note { background:#b3d9ff; cursor:pointer; }
  .note:hover { background:#99ccff; }
  
  #selbar { position:fixed; display:none; z-index:2000; background:#fff; border:1px solid #ddd; border-radius:8px; padding:8px; gap:0; box-shadow:0 2px 8px rgba(0,0,0,0.15); flex-direction:column; min-width:120px; }
  #selbar button { background:#fff; color:#666; border:none; padding:3px 0px; cursor:pointer; font-size:14px; text-align:center; border-radius:4px; }
  #selbar button:hover { background:#f5f5f5; color:#333; }
  
  .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:3000; align-items:center; justify-content:center; }
  .modal.active { display:flex; }
  .modal-content { background:#fff; border-radius:8px; padding:24px; max-width:600px; width:90%; max-height:80vh; overflow-y:auto; }
  
  .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
  .modal-header h2 { font-size: 28px; color: #333; margin: 0; }
  .modal-close { font-size: 32px; cursor: pointer; color: #999; line-height: 1; }
  .modal-close:hover { color: #333; }
  
  .result-summary { text-align:center; padding:20px; background:#f0f0f0; margin-bottom:16px; border-radius:6px; }
  .result-score { font-size:36px; font-weight:600; color:#0066cc; }
  .result-item { padding:10px; margin:8px 0; border-left:3px solid #ddd; background:#f9f9f9; font-size:13px; }
  .result-item.correct { border-left-color:#28a745; background:#e8f5e9; }
  .result-item.incorrect { border-left-color:#dc3545; background:#ffebee; }
  
  .wrong-item { background:#fff3e0; padding:16px; margin:8px 0; border-radius:8px; border-left:4px solid #ff9800; display:flex; justify-content:space-between; align-items:start; }
  .wrong-item-content { flex:1; }
  .btn-delete { background:#dc3545; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-size:13px; margin-left:12px; }
  .btn-delete:hover { background:#c82333; }
  .modal-actions { display:flex; gap:10px; margin-bottom:20px; }
</style>
</head>
<body>
<div id="timer">00:00</div>

<div class="shell">
  <section class="pane" id="left">
    
<h2>READING PASSAGE 1</h2>
<p>You should spend about 20 minutes on Questions 1‚Äì13, which are based on Reading Passage 1 below.</p>
<h3>William Gilbert and Magnetism</h3>

<h4>Paragraph A</h4>
<p>The 16th and 17th centuries saw two great pioneers of modern science: Galileo and Gilbert. The impact of their findings is eminent. Gilbert was the first modern scientist, the accredited father of the science of electricity and magnetism, an Englishman of learning and a physician at the court of Elizabeth. Prior to him, all that was known of electricity and magnetism was what the ancients knew: nothing more than that the lodestone possessed magnetic properties and that amber and jet, when rubbed, would attract bits of paper or other substances of small specific gravity. However, he is less well known than he deserves.</p>

<h4>Paragraph B</h4>
<p>Gilbert's birth predated Galileo's. Born into an eminent local family in Colchester, Essex, on 24 May 1544, he went to grammar school and then studied medicine at St John's College, Cambridge, graduating in 1573. Later he travelled on the Continent and eventually settled in London.</p>

<h4>Paragraph C</h4>
<p>He was a very successful and eminent doctor. All this culminated in his election as president of the Royal Society. He was also appointed personal physician to Queen Elizabeth I and was later knighted by her. He faithfully served her until her death. However, he did not outlive the Queen for long and died on 30 November 1603, only a few months after his appointment as personal physician to King James.</p>

<h4>Paragraph D</h4>
<p>Gilbert was first interested in chemistry but later changed his focus because alchemy contained too great a portion of mysticism (such as the transmutation of metals). He gradually developed an interest in physics, inspired by the great minds of the ancients, particularly the knowledge the ancient Greeks had about lodestones-strange minerals with the power to attract iron. In the meantime, Britain became a major seafaring nation in 1588 when the Spanish Armada was defeated, opening the way to British settlement of America. British ships depended on the magnetic compass, yet no one understood why it worked. Did the Pole Star attract it, as Columbus once speculated; or was there a magnetic mountain at the pole, as described in the Odyssey, which ships would never approach because the sailors thought its pull would yank out all their iron nails and fittings? For nearly 20 years, William Gilbert conducted ingenious experiments to understand magnetism. His works include On the Magnet, Magnetic Bodies, and The Great Magnet of the Earth.</p>

<h4>Paragraph E</h4>
<p>Gilbert's discoveries were of great importance to modern physics. He investigated the nature of magnetism and electricity, and he even coined the word "electric". Early beliefs about magnetism were largely entangled with superstitions-for instance, sailors believed that rubbing garlic on a lodestone could neutralise its magnetism and that even the smell of garlic would interfere with the action of a compass, which is why helmsmen were forbidden to eat it near a ship's compass. Gilbert also found that metals can be magnetised by rubbing materials such as fur on them. He named the ends of a magnet the "north pole" and "south pole". The magnetic poles can attract or repel, depending on polarity; ordinary iron, however, is always attracted to a magnet. Though he began to study the relationship between magnetism and electricity, he did not complete this work. His research into static electricity using amber and jet only demonstrated that objects with electrical charges can attract small pieces of paper and the like. It was a French scientist named du Fay who later discovered that there are actually two electrical charges-positive and negative.</p>

<h4>Paragraph F</h4>
<p>He also questioned traditional astronomical beliefs. Though a Copernican, he did not state explicitly whether the Earth is at the centre of the universe or in orbit around the Sun. However, he believed that stars are not equidistant from the Earth but have their own Earth-like planets orbiting around them. The Earth itself is like a giant magnet, which is also why compasses always point north: they align with the planet's polarity. He likened the polarity of a magnet to the polarity of the Earth and built an entire magnetic philosophy on this analogy. In his explanation, magnetism is the soul of the Earth. Thus a perfectly spherical lodestone, when aligned with the Earth's poles, would wobble all by itself in 24 hours. Further, he believed that the Sun and other stars wobble just as the Earth does around a crystal core, and he speculated that the Moon might also be a magnet caused to orbit by its magnetic attraction to the Earth. This was perhaps the first proposal that a force might cause a heavenly orbit.</p>

<h4>Paragraph G</h4>
<p>His research method was revolutionary in that he used experiments rather than pure logic and reasoning, as the ancient Greek philosophers had done. This represented a new attitude towards scientific investigation; until then, systematic experiments were not in fashion. Because of this scientific attitude, together with his contribution to our knowledge of magnetism, a unit of magnetomotive force-also known as magnetic potential-was named the gilbert in his honour. His approach of careful observation and experimentation, rather than reliance on authoritative opinion or deductive philosophy, laid the very foundation for modern science.</p>

  </section>

  <div id="divider" title="Drag to resize"></div>

  <section class="pane" id="right">
    <h3>Questions</h3>

    <div class="group">
      <h4>Questions 1‚Äì7</h4>
      <p>Reading Passage 1 has seven paragraphs A‚ÄìG.</p>
      <p>Choose the correct heading for each paragraph from the list of headings below.</p>
      <p>Write the correct number, <strong>i‚Äìx</strong>, in boxes <strong>1‚Äì7</strong> on your answer sheet.</p>

      <div class="headings">
        <p><strong>List of Headings</strong></p>
        <ol type="i" style="line-height:2;">
          <li>Early years of Gilbert</li>
          <li>What was new about his scientific research method</li>
          <li>The development of chemistry</li>
          <li>Questioning traditional astronomy</li>
          <li>Pioneers of early science</li>
          <li>Professional and social recognition</li>
          <li>Becoming the president of the Royal Society</li>
          <li>The great works of Gilbert</li>
          <li>His discovery about magnetism</li>
          <li>His change of focus</li>
        </ol>
      </div>

      <table>
        <tr>
          <th>Para</th>
          <th>i</th><th>ii</th><th>iii</th><th>iv</th><th>v</th><th>vi</th><th>vii</th><th>viii</th><th>ix</th><th>x</th>
        </tr>
        <tr><td><span class="flag-btn" data-q="q1"></span>A (1)</td><td><input type="radio" name="q1" value="i"></td><td><input type="radio" name="q1" value="ii"></td><td><input type="radio" name="q1" value="iii"></td><td><input type="radio" name="q1" value="iv"></td><td><input type="radio" name="q1" value="v"></td><td><input type="radio" name="q1" value="vi"></td><td><input type="radio" name="q1" value="vii"></td><td><input type="radio" name="q1" value="viii"></td><td><input type="radio" name="q1" value="ix"></td><td><input type="radio" name="q1" value="x"></td></tr>
        <tr><td><span class="flag-btn" data-q="q2"></span>B (2)</td><td><input type="radio" name="q2" value="i"></td><td><input type="radio" name="q2" value="ii"></td><td><input type="radio" name="q2" value="iii"></td><td><input type="radio" name="q2" value="iv"></td><td><input type="radio" name="q2" value="v"></td><td><input type="radio" name="q2" value="vi"></td><td><input type="radio" name="q2" value="vii"></td><td><input type="radio" name="q2" value="viii"></td><td><input type="radio" name="q2" value="ix"></td><td><input type="radio" name="q2" value="x"></td></tr>
        <tr><td><span class="flag-btn" data-q="q3"></span>C (3)</td><td><input type="radio" name="q3" value="i"></td><td><input type="radio" name="q3" value="ii"></td><td><input type="radio" name="q3" value="iii"></td><td><input type="radio" name="q3" value="iv"></td><td><input type="radio" name="q3" value="v"></td><td><input type="radio" name="q3" value="vi"></td><td><input type="radio" name="q3" value="vii"></td><td><input type="radio" name="q3" value="viii"></td><td><input type="radio" name="q3" value="ix"></td><td><input type="radio" name="q3" value="x"></td></tr>
        <tr><td><span class="flag-btn" data-q="q4"></span>D (4)</td><td><input type="radio" name="q4" value="i"></td><td><input type="radio" name="q4" value="ii"></td><td><input type="radio" name="q4" value="iii"></td><td><input type="radio" name="q4" value="iv"></td><td><input type="radio" name="q4" value="v"></td><td><input type="radio" name="q4" value="vi"></td><td><input type="radio" name="q4" value="vii"></td><td><input type="radio" name="q4" value="viii"></td><td><input type="radio" name="q4" value="ix"></td><td><input type="radio" name="q4" value="x"></td></tr>
        <tr><td><span class="flag-btn" data-q="q5"></span>E (5)</td><td><input type="radio" name="q5" value="i"></td><td><input type="radio" name="q5" value="ii"></td><td><input type="radio" name="q5" value="iii"></td><td><input type="radio" name="q5" value="iv"></td><td><input type="radio" name="q5" value="v"></td><td><input type="radio" name="q5" value="vi"></td><td><input type="radio" name="q5" value="vii"></td><td><input type="radio" name="q5" value="viii"></td><td><input type="radio" name="q5" value="ix"></td><td><input type="radio" name="q5" value="x"></td></tr>
        <tr><td><span class="flag-btn" data-q="q6"></span>F (6)</td><td><input type="radio" name="q6" value="i"></td><td><input type="radio" name="q6" value="ii"></td><td><input type="radio" name="q6" value="iii"></td><td><input type="radio" name="q6" value="iv"></td><td><input type="radio" name="q6" value="v"></td><td><input type="radio" name="q6" value="vi"></td><td><input type="radio" name="q6" value="vii"></td><td><input type="radio" name="q6" value="viii"></td><td><input type="radio" name="q6" value="ix"></td><td><input type="radio" name="q6" value="x"></td></tr>
        <tr><td><span class="flag-btn" data-q="q7"></span>G (7)</td><td><input type="radio" name="q7" value="i"></td><td><input type="radio" name="q7" value="ii"></td><td><input type="radio" name="q7" value="iii"></td><td><input type="radio" name="q7" value="iv"></td><td><input type="radio" name="q7" value="v"></td><td><input type="radio" name="q7" value="vi"></td><td><input type="radio" name="q7" value="vii"></td><td><input type="radio" name="q7" value="viii"></td><td><input type="radio" name="q7" value="ix"></td><td><input type="radio" name="q7" value="x"></td></tr>
      </table>
    </div>

    <div class="group">
      <h4>Questions 8‚Äì10</h4>
      <p>Do the following statements agree with the information given in Reading Passage 1?</p>
      <p>In boxes 8‚Äì10 on your answer sheet, write</p>
      <ul style="margin-left:20px; line-height:1.8;">
        <li>TRUE if the statement agrees with the information</li>
        <li>FALSE if the statement contradicts the information</li>
        <li>NOT GIVEN if there is no information on this</li>
      </ul>
      
      <div style="padding:8px 0;border-top:1px dashed #ddd; margin-top:12px; position:relative;">
        <span class="flag-btn" data-q="q8" style="left:-20px; top:20px;"></span>
        <p><strong>8</strong> Gilbert is less famous than he should be.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:8px 0;">
          <label style="margin:0;"><input name="q8" type="radio" value="TRUE"> TRUE</label>
          <label style="margin:0;"><input name="q8" type="radio" value="FALSE"> FALSE</label>
          <label style="margin:0;"><input name="q8" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
        </div>
      </div>
      
      <div style="padding:8px 0;border-top:1px dashed #ddd; position:relative;">
        <span class="flag-btn" data-q="q9" style="left:-20px; top:20px;"></span>
        <p><strong>9</strong> Gilbert was famous as a doctor before he was employed by the Queen.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:8px 0;">
          <label style="margin:0;"><input name="q9" type="radio" value="TRUE"> TRUE</label>
          <label style="margin:0;"><input name="q9" type="radio" value="FALSE"> FALSE</label>
          <label style="margin:0;"><input name="q9" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
        </div>
      </div>
      
      <div style="padding:8px 0;border-top:1px dashed #ddd; position:relative;">
        <span class="flag-btn" data-q="q10" style="left:-20px; top:20px;"></span>
        <p><strong>10</strong> Gilbert lost faith in the medical theories of his time.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin:8px 0;">
          <label style="margin:0;"><input name="q10" type="radio" value="TRUE"> TRUE</label>
          <label style="margin:0;"><input name="q10" type="radio" value="FALSE"> FALSE</label>
          <label style="margin:0;"><input name="q10" type="radio" value="NOT GIVEN"> NOT GIVEN</label>
        </div>
      </div>
    </div>

    <div class="group">
      <h4>Questions 11‚Äì13</h4>
      <p>Choose THREE letters, A‚ÄìF.</p>
      <p>Write the correct letters in boxes 11‚Äì13 on your answer sheet.</p>
      <p><strong>Which THREE of the following are parts of Gilbert's discovery?</strong></p>
      
      <div style="padding:8px 0;border-top:1px dashed #ddd; margin-top:12px; position:relative;">
        <span class="flag-btn" data-q="q11" style="left:-20px; top:12px;"></span>
        <label style="display:block;margin:8px 0;"><input name="q11a" type="checkbox" value="A"/> <strong>A</strong> Metal can be transformed into another.</label>
        <label style="display:block;margin:8px 0;"><input name="q11b" type="checkbox" value="B"/> <strong>B</strong> Garlic can remove magnetism.</label>
        <label style="display:block;margin:8px 0;"><input name="q11c" type="checkbox" value="C"/> <strong>C</strong> Metals can be magnetised.</label>
        <label style="display:block;margin:8px 0;"><input name="q11d" type="checkbox" value="D"/> <strong>D</strong> Stars are at different distances from the Earth.</label>
        <label style="display:block;margin:8px 0;"><input name="q11e" type="checkbox" value="E"/> <strong>E</strong> The Earth wobbles on its axis.</label>
        <label style="display:block;margin:8px 0;"><input name="q11f" type="checkbox" value="F"/> <strong>F</strong> There are two charges of electricity.</label>
      </div>
    </div>

    <div class="bottom-bar">
      <button class="btn-primary" onclick="submitAnswers()">Êèê‰∫§</button>
      <button onclick="resetForm()">ÈáçÁΩÆ</button>
      <button onclick="openWrongBook()">Êú¨ÁØáÈîôÈ¢ò</button>
    </div>
  </section>
</div>

<div id="selbar">
  <button id="btnNote">Note</button>
  <button id="btnHL">Highlight</button>
  <button id="btnUH" style="display:none;">Clear Highlight</button>
</div>

<div class="modal" id="resultModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ÊàêÁª©</h2>
      <span class="modal-close" onclick="closeModal('resultModal')">√ó</span>
    </div>
    <div id="resultContent"></div>
    <button class="btn-primary" style="width:100%; margin-top:16px;" onclick="addWrongToBook()">Âä†ÂÖ•ÈîôÈ¢òÊú¨</button>
  </div>
</div>

<div class="modal" id="wrongBookModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Êú¨ÁØáÈîôÈ¢ò</h2>
      <span class="modal-close" onclick="closeModal('wrongBookModal')">√ó</span>
    </div>
    <div id="wrongBookContent"></div>
  </div>
</div>

<div class="modal" id="resetModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ÈáçÁΩÆÁªÉ‰π†</h2>
      <span class="modal-close" onclick="closeModal('resetModal')">√ó</span>
    </div>
    <div style="margin:16px 0;">
      <label style="display:block; margin-bottom:10px;">
        <input type="radio" name="resetType" value="answers" checked>
        Âè™Ê∏ÖÁ©∫Á≠îÊ°à
      </label>
      <label style="display:block;">
        <input type="radio" name="resetType" value="all">
        Ê∏ÖÁ©∫Á≠îÊ°àÂíåÊ†áËÆ∞
      </label>
    </div>
    <button class="btn-primary" style="width:100%;" onclick="confirmReset()">Á°ÆÂÆö</button>
  </div>
</div>

<script>
const PAPER_ID='P1_031';

let t=0;
const timerEl=document.getElementById('timer');
setInterval(()=>{ t++; timerEl.textContent=String(Math.floor(t/60)).padStart(2,'0')+':'+String(t%60).padStart(2,'0'); }, 1000);

const divider=document.getElementById('divider'), left=document.getElementById('left'), right=document.getElementById('right');
let dragging=false;
divider.onmousedown=()=>{ dragging=true; document.body.style.cursor='ew-resize'; };
window.onmousemove=(e)=>{ if(!dragging)return; const c=document.querySelector('.shell').getBoundingClientRect(); let x=e.clientX-c.left; x=Math.max(280,Math.min(c.width-280,x)); left.style.flex='0 0 '+x+'px'; right.style.flex='1 1 auto'; };
window.onmouseup=()=>{ dragging=false; document.body.style.cursor=''; };

const selbar=document.getElementById('selbar'), btnHL=document.getElementById('btnHL'), btnUH=document.getElementById('btnUH'), btnNote=document.getElementById('btnNote');
let lastRange=null, currentHlNode=null;

function posSelbar(r){ selbar.style.display='flex'; const t=window.scrollY+r.top-selbar.offsetHeight-8; const l=window.scrollX+r.left+r.width/2-selbar.offsetWidth/2; selbar.style.top=((t>0)?t:(window.scrollY+r.bottom+8))+'px'; selbar.style.left=Math.max(8,l)+'px'; }

function updSel(){ const s=window.getSelection(); if(!s||s.rangeCount===0||s.isCollapsed){ if(!currentHlNode)selbar.style.display='none'; return; } const r=s.getRangeAt(0); lastRange=r.cloneRange(); currentHlNode=null; btnNote.style.display='block'; btnHL.style.display='block'; btnUH.style.display='none'; posSelbar(r.getBoundingClientRect()); }

left.onmouseup=updSel; right.onmouseup=updSel;
document.onselectionchange=()=>{ const s=window.getSelection(); if((!s||s.rangeCount===0||s.isCollapsed)&&!currentHlNode)selbar.style.display='none'; };
document.addEventListener('click',(e)=>{ if(e.target.classList&&(e.target.classList.contains('hl')||e.target.classList.contains('note'))){ currentHlNode=e.target; lastRange=null; btnNote.style.display='none'; btnHL.style.display='none'; btnUH.style.display='block'; posSelbar(e.target.getBoundingClientRect()); const s=window.getSelection(); if(s)s.removeAllRanges(); }}, true);

btnHL.onclick=()=>{ if(currentHlNode||!lastRange||lastRange.collapsed)return; const s=document.createElement('span'); s.className='hl'; try{ lastRange.surroundContents(s); }catch(e){ const w=document.createElement('span'); w.className='hl'; w.appendChild(lastRange.cloneContents()); lastRange.deleteContents(); lastRange.insertNode(w); } selbar.style.display='none'; saveHighlights(); };

btnNote.onclick=()=>{ if(currentHlNode||!lastRange||lastRange.collapsed)return; const s=document.createElement('span'); s.className='note'; try{ lastRange.surroundContents(s); }catch(e){ const w=document.createElement('span'); w.className='note'; w.appendChild(lastRange.cloneContents()); lastRange.deleteContents(); lastRange.insertNode(w); } selbar.style.display='none'; saveHighlights(); };

btnUH.onclick=()=>{ if(currentHlNode){ const p=currentHlNode.parentNode; while(currentHlNode.firstChild)p.insertBefore(currentHlNode.firstChild,currentHlNode); p.removeChild(currentHlNode); p.normalize(); currentHlNode=null; selbar.style.display='none'; saveHighlights(); }else if(lastRange){ const sR=lastRange.getBoundingClientRect(); const w=document.createTreeWalker(document.body,NodeFilter.SHOW_ELEMENT); const tr=[]; while(w.nextNode()){ const n=w.currentNode; if(n.classList&&(n.classList.contains('hl')||n.classList.contains('note'))){ const r=n.getBoundingClientRect(); if(!(r.right<sR.left||r.left>sR.right||r.bottom<sR.top||r.top>sR.bottom))tr.push(n); }} tr.forEach(el=>{ const p=el.parentNode; while(el.firstChild)p.insertBefore(el.firstChild,el); p.removeChild(el); p.normalize(); }); selbar.style.display='none'; saveHighlights(); }};

document.querySelectorAll('.flag-btn').forEach(btn => {
  btn.onclick = e => {
    e.stopPropagation();
    btn.classList.toggle('active');
    saveFlags();
  };
});

const answerKey={q1:"v",q2:"i",q3:"vi",q4:"x",q5:"ix",q6:"iv",q7:"ii",q8:"TRUE",q9:"TRUE",q10:"NOT GIVEN",q11:['C','D','E']};
let lastResults=[];

function saveAnswers() {
  const data = {};
  for(let i=1; i<=10; i++) {
    const ch = document.querySelector(`input[name="q${i}"]:checked`);
    if(ch) data[`q${i}`] = ch.value;
  }
  const checked = [];
  ['a','b','c','d','e','f'].forEach(l => {
    const cb = document.querySelector(`input[name="q11${l}"]`);
    if(cb && cb.checked) checked.push(cb.value);
  });
  if(checked.length > 0) data.q11 = checked;
  localStorage.setItem(`${PAPER_ID}_answers`, JSON.stringify(data));
}

function loadAnswers() {
  const data = JSON.parse(localStorage.getItem(`${PAPER_ID}_answers`) || '{}');
  Object.keys(data).forEach(q => {
    if(q === 'q11') {
      data[q].forEach(v => {
        const cb = document.querySelector(`input[name="q11${v.toLowerCase()}"]`);
        if(cb) cb.checked = true;
      });
    } else {
      const radio = document.querySelector(`input[name="${q}"][value="${data[q]}"]`);
      if(radio) radio.checked = true;
    }
  });
}

function saveFlags() {
  const flags = [...document.querySelectorAll('.flag-btn.active')].map(b => b.dataset.q);
  localStorage.setItem(`${PAPER_ID}_flags`, JSON.stringify(flags));
}

function loadFlags() {
  const flags = JSON.parse(localStorage.getItem(`${PAPER_ID}_flags`) || '[]');
  flags.forEach(q => document.querySelector(`[data-q="${q}"]`)?.classList.add('active'));
}

function saveHighlights() {
  const highlights = [];
  document.querySelectorAll('#left .hl, #left .note').forEach((el, idx) => {
    highlights.push({
      type: el.classList.contains('hl') ? 'hl' : 'note',
      text: el.textContent,
      index: idx
    });
  });
  localStorage.setItem(`${PAPER_ID}_highlights`, JSON.stringify(highlights));
}

function loadHighlights() {
  const data = JSON.parse(localStorage.getItem(`${PAPER_ID}_highlights`) || '[]');
  if(data.length === 0) return;
  
  data.forEach(item => {
    const walker = document.createTreeWalker(left, NodeFilter.SHOW_TEXT);
    let node;
    while(node = walker.nextNode()) {
      if(node.textContent.includes(item.text)) {
        const span = document.createElement('span');
        span.className = item.type;
        const parent = node.parentNode;
        const text = node.textContent;
        const idx = text.indexOf(item.text);
        if(idx >= 0) {
          const before = text.substring(0, idx);
          const match = text.substring(idx, idx + item.text.length);
          const after = text.substring(idx + item.text.length);
          
          parent.insertBefore(document.createTextNode(before), node);
          span.textContent = match;
          parent.insertBefore(span, node);
          parent.insertBefore(document.createTextNode(after), node);
          parent.removeChild(node);
          break;
        }
      }
    }
  });
}

document.querySelectorAll('input[type="radio"], input[type="checkbox"]').forEach(input => {
  input.addEventListener('change', saveAnswers);
});

document.addEventListener('DOMContentLoaded', () => {
  loadAnswers();
  loadFlags();
  loadHighlights();
});

function submitAnswers(){ 
  const res=[]; 
  let cor=0; 
  
  for(let i=1; i<=10; i++) {
    const ch=document.querySelector(`input[name="q${i}"]:checked`);
    const uA=ch?ch.value:"";
    const cA=answerKey[`q${i}`];
    const iC=uA===cA;
    if(iC)cor++;
    res.push({id:`q${i}`,userAns:uA,correctAns:cA,isCorrect:iC});
  }
  
  const checked = [];
  ['a','b','c','d','e','f'].forEach(l => {
    const cb = document.querySelector(`input[name="q11${l}"]`);
    if(cb && cb.checked) checked.push(cb.value);
  });
  const correctSet = answerKey.q11.sort().join(',');
  const userSet = checked.sort().join(',');
  const iC = correctSet === userSet;
  if(iC) cor++;
  res.push({id:'q11',userAns:checked.join(',') || '(Êú™‰ΩúÁ≠î)',correctAns:answerKey.q11.join(','),isCorrect:iC});
  
  lastResults=res; 
  const tot=11; 
  const pct=((cor/tot)*100).toFixed(1); 
   localStorage.setItem(`ielts_score_${PAPER_ID}`, `${cor}/${tot}`);
  document.getElementById('resultContent').innerHTML=`<div class="result-summary"><div class="result-score">${cor} / ${tot}</div><div style="margin-top:8px;font-size:18px;">${pct}%</div></div>${res.map(r=>`<div class="result-item ${r.isCorrect?'correct':'incorrect'}"><div><strong>${r.id.toUpperCase()}</strong> ${r.isCorrect?'‚úì':'‚úó'}</div><div>‰Ω†ÁöÑÁ≠îÊ°à: ${r.userAns||'(Êú™‰ΩúÁ≠î)'}</div>${!r.isCorrect?`<div>Ê≠£Á°ÆÁ≠îÊ°à: ${r.correctAns}</div>`:''}</div>`).join('')}`; 
  document.getElementById('resultModal').classList.add('active'); 
}

function resetForm(){ document.getElementById('resetModal').classList.add('active'); }

function confirmReset(){ 
  const tp=document.querySelector('input[name="resetType"]:checked').value; 
  document.querySelectorAll('input[type="radio"], input[type="checkbox"]').forEach(i=>i.checked=false); 
  localStorage.removeItem(`${PAPER_ID}_answers`);
  
  if(tp==='all'){ 
    document.querySelectorAll('.hl').forEach(el=>{ const p=el.parentNode; while(el.firstChild)p.insertBefore(el.firstChild,el); p.removeChild(el); p.normalize(); }); 
    document.querySelectorAll('.note').forEach(el=>{ const p=el.parentNode; while(el.firstChild)p.insertBefore(el.firstChild,el); p.removeChild(el); p.normalize(); }); 
    document.querySelectorAll('.flag-btn').forEach(b => b.classList.remove('active'));
    localStorage.removeItem(`${PAPER_ID}_highlights`);
    localStorage.removeItem(`${PAPER_ID}_flags`);
  } 
  closeModal('resetModal'); 
}

function addWrongToBook(){ const wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); const wr=lastResults.filter(r=>!r.isCorrect); wr.forEach(r=>{ const en={paperId:PAPER_ID,title:'William Gilbert and Magnetism',questionId:r.id,correctAnswer:r.correctAns,myAnswer:r.userAns||'(Êú™‰ΩúÁ≠î)',date:new Date().toISOString().split('T')[0]}; const ix=wb.findIndex(i=>i.paperId===en.paperId&&i.questionId===en.questionId); if(ix>=0)wb[ix]=en; else wb.push(en); }); localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); alert(`Â∑≤Ê∑ªÂä† ${wr.length} ÈÅìÈîôÈ¢ò`); closeModal('resultModal'); }

function deleteWrongItem(pId,qId){ if(!confirm('Á°ÆÂÆöÂà†Èô§ËøôÈÅìÈîôÈ¢òÔºü'))return; let wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); wb=wb.filter(i=>!(i.paperId===pId&&i.questionId===qId)); localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); openWrongBook(); }

function clearCurrentWrongBook(){ if(!confirm('Á°ÆÂÆöÊ∏ÖÁ©∫Êú¨ÁØáÊâÄÊúâÈîôÈ¢òÔºü'))return; let wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); wb=wb.filter(i=>i.paperId!==PAPER_ID); localStorage.setItem('ielts_wrong_book',JSON.stringify(wb)); openWrongBook(); }

function openWrongBook(){ const wb=JSON.parse(localStorage.getItem('ielts_wrong_book')||'[]'); const cu=wb.filter(i=>i.paperId===PAPER_ID); const ct=document.getElementById('wrongBookContent'); if(cu.length===0)ct.innerHTML='<div style="text-align:center;padding:40px;color:#666;">ÊöÇÊó†ÈîôÈ¢ò</div>'; else ct.innerHTML=`<div class="modal-actions"><button class="btn-danger" onclick="clearCurrentWrongBook()" style="width:100%;">üóëÔ∏è Ê∏ÖÁ©∫Êú¨ÁØáÈîôÈ¢ò</button></div>${cu.map(i=>`<div class="wrong-item"><div class="wrong-item-content"><div style="font-weight:600;margin-bottom:8px;">${i.questionId.toUpperCase()}</div><div style="font-size:13px;color:#666;"><div>‚úì Ê≠£Á°Æ: ${i.correctAnswer}</div><div style="color:#d32f2f;">‚úó ÊàëÁöÑ: ${i.myAnswer}</div></div></div><button class="btn-delete" onclick="deleteWrongItem('${i.paperId}','${i.questionId}')">Âà†Èô§</button></div>`).join('')}`; document.getElementById('wrongBookModal').classList.add('active'); }

function closeModal(id){ document.getElementById(id).classList.remove('active'); }
</script>
</body>
</html>